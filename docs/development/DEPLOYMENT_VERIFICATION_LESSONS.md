# デプロイ検証の教訓 - なぜ正確な確認ができなかったか

> **最終更新**: 2025/01/30  
> **文書種別**: 教訓文書  
> **更新頻度**: 問題発生時

## 🚨 問題の概要

デプロイの成功/失敗を正確に判断できなかった原因と、その解決策をまとめます。

## 📋 確認手順で失敗した理由

### 1. WebFetchの限界
**問題**：
- WebFetchではGitHub ActionsのUIの詳細（✅や❌のアイコン）が取得できない
- 「エラーが見えない」≠「成功している」という誤った判断
- スクリーンショットの解析ができない

**例**：
```
WebFetch: "completing without visible errors"
→ これは成功を意味しない！単に詳細が見えないだけ
```

### 2. HTTPステータスコードの誤解
**問題**：
- `curl`で200が返っても、それは以前のデプロイ内容かもしれない
- 最新のデプロイが反映されているかは確認できない

**例**：
```bash
curl -s -o /dev/null -w "%{http_code}" https://example.com/
# 200 → 古いバージョンが表示されているだけかも
```

### 3. GitHub CLIが使えない環境
**問題**：
- `gh`コマンドが使えないため、APIレベルでの確認ができない
- ワークフローの詳細なステータスを取得できない

## ✅ 正しい確認手順

### 1. 具体的なワークフロー実行URLの取得
```
1. git log --oneline -1 でコミットハッシュを取得
2. GitHub Actionsページで該当コミットのワークフローを探す
3. 具体的な実行URLを取得
   例: https://github.com/owner/repo/actions/runs/12345678
```

### 2. ワークフロー実行の詳細確認
```
必須確認項目：
- ワークフローのステータスアイコン（✅ or ❌）
- 各ジョブのステータス
- 失敗したステップの詳細ログ
- アーティファクトの生成状況
```

### 3. デプロイ内容の検証
```
1. デプロイされたサイトのソースを確認
2. 最新のコミットハッシュがデプロイに含まれているか確認
3. ビルド日時やバージョン情報を確認
```

## 🛠️ 技術的な制約と回避策

### WebFetchの制約
- **制約**: UIの視覚的要素（アイコン、色）を取得できない
- **回避策**: 
  - テキストベースの情報（"failed", "success"）を探す
  - 具体的なエラーメッセージの有無を確認
  - ワークフロー実行時間が異常に短い場合は失敗の可能性

### GitHub API代替手段
- **制約**: `gh`コマンドが使えない
- **回避策**:
  - WebFetchでactions/runs/[ID]の詳細ページを確認
  - ワークフローのバッジURL（.github/workflows/deploy.yml/badge.svg）を確認
  - コミット履歴と実行履歴の対応を確認

### デプロイ検証の代替手段
- **制約**: デプロイ内容の新旧判定が困難
- **回避策**:
  - ビルド時にタイムスタンプやコミットハッシュを埋め込む
  - デプロイ後に`/version.json`などの確認用ファイルを生成
  - ソースマップやビルドハッシュを確認

## 📝 改善提案

### 1. デプロイ時のバージョン情報埋め込み
```javascript
// vite.config.tsに追加
define: {
  '__BUILD_TIME__': JSON.stringify(new Date().toISOString()),
  '__COMMIT_HASH__': JSON.stringify(process.env.GITHUB_SHA || 'local')
}
```

### 2. デプロイ確認用エンドポイント
```javascript
// public/deploy-info.json を自動生成
{
  "deployedAt": "2025-01-30T12:00:00Z",
  "commitHash": "abc123",
  "workflowRunId": "12345678"
}
```

### 3. ワークフロー内での確認強化
```yaml
- name: Verify deployment
  run: |
    # デプロイ後に実際のサイトを確認
    response=$(curl -s https://example.com/deploy-info.json)
    echo "Deployed version: $response"
    # コミットハッシュが一致するか確認
```

## 🎯 結論

**「推測」ではなく「確実な証拠」に基づいた判断が必要**

1. ✅ 具体的なステータスアイコンの確認
2. ✅ ワークフロー実行ログの詳細確認
3. ✅ デプロイされた内容の実際の検証

これらすべてが確認できて初めて「デプロイ成功」と判断すべきです。