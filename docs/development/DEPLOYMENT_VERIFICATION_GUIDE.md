# デプロイ検証ガイドライン

> **最終更新**: 2025/01/27  
> **文書種別**: 開発ガイド  
> **更新頻度**: 問題発生時に更新

## 🚨 重要な教訓

2025/01/27に発生した「デプロイ成功」の誤認識から学んだ教訓を記録します。

### 問題の経緯
1. WebFetchで「successful deployment」という文字を見た
2. HTTP 200ステータスコードを確認した
3. これらの表面的な情報だけで「デプロイ成功」と判断してしまった
4. 実際にはESLintエラーが86個存在し、GitHub Actionsは失敗していた

## ✅ デプロイ検証の正しい手順

### 1. GitHub Actionsの確認
```bash
# 最新のコミットハッシュを確認
git log --oneline -n 1

# GitHub ActionsのURLを構築して確認
# https://github.com/{owner}/{repo}/actions
```

**確認すべき項目：**
- ✅ ワークフローの実行ステータス（成功/失敗/実行中）
- ✅ 各ステップの詳細ログ
- ✅ エラーメッセージの有無
- ✅ 特にlint、test、buildステップのログ

### 2. ローカルでの事前確認
```bash
# デプロイ前に必ず実行
pnpm run lint        # ESLintエラーの確認
pnpm run test:run    # テストの実行
pnpm run build       # ビルドの成功確認
```

### 3. デプロイされたサイトの検証
```bash
# HTTPステータスの確認（これだけでは不十分）
curl -I https://{url}

# 実際のHTMLコンテンツの確認
curl -s https://{url} | grep -E '(script|link)' | head -20

# JavaScriptファイルが正しくロードされているか
curl -s https://{url} | grep -E 'js/.*\.js'
```

### 4. 実際の動作確認
- ブラウザでサイトを開く
- 開発者ツールのコンソールでエラーを確認
- ネットワークタブで404エラーがないか確認
- 実際にゲームが動作するか確認

## ❌ やってはいけないこと

1. **表面的な情報だけで判断する**
   - HTTP 200だけで成功と判断
   - "successful"という文字列だけで判断

2. **推測で「成功している」と断言する**
   - 必ず根拠を示す
   - 確認できない場合は「確認が必要」と述べる

3. **エラーログを無視する**
   - ESLintエラー
   - テスト失敗
   - ビルド警告

## 📝 報告時のテンプレート

```markdown
## デプロイ状況の報告

### GitHub Actions
- ステータス: ✅成功 / ❌失敗
- 実行URL: [リンク]
- エラー内容: （ある場合）

### ローカル検証
- ESLint: ✅パス / ❌エラー{N}個
- テスト: ✅全パス / ❌{N}個失敗
- ビルド: ✅成功 / ❌失敗

### デプロイ先の確認
- URL: [リンク]
- HTTPステータス: {コード}
- コンソールエラー: あり/なし
- 動作確認: ✅正常 / ❌異常

### 結論
上記の確認結果から、デプロイは[成功/失敗]しています。
```

## 🔍 トラブルシューティング

### よくある問題と対処法

1. **ESLintエラーでビルド失敗**
   ```bash
   # エラーを確認
   pnpm run lint
   
   # 自動修正を試す
   pnpm run lint --fix
   
   # それでも残るエラーは手動修正
   ```

2. **テスト失敗**
   ```bash
   # 詳細なエラーを確認
   pnpm run test:run
   
   # 特定のテストだけ実行
   pnpm run test {ファイル名}
   ```

3. **本番環境でスクリプトが404**
   - vite.config.tsのbaseパスを確認
   - dist/index.htmlの生成されたパスを確認
   - GitHub Pagesの設定を確認

## 💡 推奨される習慣

1. **コミット前のチェックリスト**
   ```bash
   pnpm run lint
   pnpm run test:run
   pnpm run build
   ```

2. **プッシュ後の確認**
   - GitHub Actionsの実行を見守る
   - 失敗したらすぐに対応

3. **定期的な動作確認**
   - デプロイ後は必ず本番環境で動作確認
   - 主要機能が動作することを確認

## 📚 関連ドキュメント

- [開発原則](./PRINCIPLES.md)
- [CI/CD設定](./.github/workflows/deploy.yml)
- [トラブルシューティングガイド](./TROUBLESHOOTING.md)

---

**Remember**: 「動いているはず」ではなく「動いていることを確認した」と言えるまで検証を続ける。