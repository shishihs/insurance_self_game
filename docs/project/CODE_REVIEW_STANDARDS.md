# コードレビュー基準とプロセス

> **最終更新**: 2025/08/01  
> **文書種別**: 正式仕様書  
> **更新頻度**: 定期的

## 概要

コードの品質と保守性を確保するためのレビュー基準とプロセスを定義します。

## 1. レビューの目的

### 品質保証
- **機能性**: 設計通りに動作するか
- **性能**: パフォーマンスに問題がないか
- **保守性**: 他の開発者が理解・拡張できるか
- **テスト性**: 適切にテストできるか

### 知識共有
- 実装パターンの共有
- ベストプラクティスの普及
- チーム全体のスキル向上

### リスク軽減
- バグの早期発見
- セキュリティ脆弱性の防止
- 仕様の齟齬の防止

## 2. レビュー対象

### 必須レビュー
- 新機能の実装
- 既存機能の大幅な変更
- アーキテクチャレベルの変更
- セキュリティ関連の変更
- パフォーマンスに影響する変更

### 任意レビュー
- 軽微なバグ修正
- ドキュメントの更新
- スタイル修正のみの変更
- テストコードの追加

## 3. レビュー基準

### 3.1 コード品質

#### 可読性
- [ ] **命名規則**: 変数、関数、クラス名が分かりやすい
- [ ] **コメント**: 複雑なロジックに適切なコメントがある
- [ ] **構造**: 適切にファイルとフォルダが分割されている
- [ ] **フォーマット**: 一貫したコードスタイルが守られている

```typescript
// ❌ 悪い例
function calc(x: number, y: number): number {
  return x * y + 100; // なぜ100を加算するのか不明
}

// ✅ 良い例
function calculateInsurancePremium(basePremium: number, riskFactor: number): number {
  const FIXED_ADMINISTRATIVE_FEE = 100;
  return basePremium * riskFactor + FIXED_ADMINISTRATIVE_FEE;
}
```

#### DRY原則
- [ ] **重複コード**: 同じロジックが複数箇所に書かれていない
- [ ] **共通化**: 共通処理が適切に抽出されている
- [ ] **再利用性**: 他の箇所でも使えるように設計されている

#### SOLID原則
- [ ] **単一責任**: 各クラス・関数が単一の責任を持つ
- [ ] **開放閉鎖**: 拡張に開かれ、変更に閉じている
- [ ] **リスコフ置換**: 基底クラスと派生クラスが置換可能
- [ ] **インターフェース分離**: 必要なメソッドのみを公開
- [ ] **依存性逆転**: 抽象に依存し、具象に依存しない

### 3.2 機能性

#### 仕様準拠
- [ ] **要件達成**: すべての要件が実装されている
- [ ] **エッジケース**: 境界値や異常系が考慮されている
- [ ] **エラーハンドリング**: 適切な例外処理がある
- [ ] **ユーザビリティ**: プレイヤーにとって使いやすい

#### テストカバレッジ
- [ ] **単体テスト**: 新機能に対するテストがある
- [ ] **統合テスト**: 他のコンポーネントとの連携テストがある
- [ ] **E2Eテスト**: ユーザーシナリオのテストがある
- [ ] **テストデータ**: 適切なテストケースが作成されている

```typescript
// ✅ 良いテスト例
describe('GameManager', () => {
  it('should start game with valid initial state', () => {
    const gameManager = new GameManager();
    gameManager.startGame();
    
    expect(gameManager.getGameState()).toBe(GameState.Playing);
    expect(gameManager.getCurrentPlayer()).toBeDefined();
    expect(gameManager.getRemainingTurns()).toBeGreaterThan(0);
  });

  it('should handle invalid moves gracefully', () => {
    const gameManager = new GameManager();
    gameManager.startGame();
    
    expect(() => gameManager.makeMove(-1, -1)).not.toThrow();
    expect(gameManager.getLastError()).toBeDefined();
  });
});
```

### 3.3 パフォーマンス

#### 実行速度
- [ ] **計算量**: O(n²)以上の処理がないか確認
- [ ] **非同期処理**: 適切にPromise/async-awaitを使用
- [ ] **メモ化**: 重い計算結果をキャッシュしている
- [ ] **遅延読み込み**: 必要な時にのみリソースを読み込み

#### メモリ使用量
- [ ] **メモリリーク**: 不要なオブジェクトが解放されている
- [ ] **循環参照**: WeakMapやWeakSetを適切に使用
- [ ] **イベントリスナー**: 適切にクリーンアップされている

#### バンドルサイズ
- [ ] **Tree Shaking**: 未使用コードが含まれていない
- [ ] **Code Splitting**: 必要に応じて分割されている
- [ ] **依存関係**: 不要なライブラリが追加されていない

### 3.4 セキュリティ

#### 入力検証
- [ ] **XSS対策**: ユーザー入力が適切にエスケープされている
- [ ] **CSRF対策**: トークンによる検証がある
- [ ] **SQL Injection**: パラメータ化クエリを使用

#### データ保護
- [ ] **個人情報**: 機密データが適切に処理されている
- [ ] **認証**: 適切な認証メカニズムがある
- [ ] **認可**: 権限チェックが実装されている

## 4. レビュープロセス

### 4.1 セルフレビュー（実装者）

#### 提出前チェック
1. **動作確認**
   ```bash
   # テスト実行
   npm run test:run
   
   # 型チェック
   npm run type-check
   
   # Lint実行
   npm run lint
   
   # ビルド確認
   npm run build
   ```

2. **コード確認**
   - 差分の再確認
   - 不要なコメントやログの削除
   - コミット内容の整理

3. **ドキュメント更新**
   - README.mdの更新
   - CHANGELOG.mdの更新
   - APIドキュメントの更新

### 4.2 ピアレビュー（レビュアー）

#### レビューの流れ
1. **概要理解**
   - プルリクエストの説明を読む
   - 関連するIssueやタスクを確認
   - 変更の背景と目的を理解

2. **コードレビュー**
   - 各ファイルの変更内容を確認
   - レビュー基準に従ってチェック
   - 改善点やコメントを記録

3. **テスト確認**
   - ローカル環境でのテスト実行
   - 新機能の動作確認
   - エッジケースのテスト

4. **フィードバック**
   - 建設的なコメント
   - 具体的な改善提案
   - 良い点の評価

### 4.3 レビューコメントの書き方

#### コメントの種類
- **Must Fix**: 必ず修正が必要
- **Should Fix**: できれば修正してほしい
- **Nitpick**: 軽微な指摘
- **Question**: 疑問や確認
- **Praise**: 良い点の評価

#### コメント例
```markdown
**Must Fix**: この関数は複数の責任を持っています。
GameLogicとUIの処理を分離することを提案します。

**Should Fix**: エラーメッセージをもう少し具体的にできませんか？
ユーザーが何をすべきかわかるように。

**Nitpick**: 変数名 `temp` より `temporaryResult` の方が分かりやすいかも。

**Question**: この実装だとパフォーマンスが心配ですが、
ベンチマークは取りましたか？

**Praise**: エラーハンドリングがとても丁寧で素晴らしいです！
```

## 5. レビューチェックリスト

### 実装者用チェックリスト

#### 提出前
- [ ] すべてのテストが成功している
- [ ] Lintエラーが解決している
- [ ] 型チェックエラーが解決している
- [ ] ビルドが成功している
- [ ] 不要なコメントやログを削除した
- [ ] コミットメッセージが規約に従っている
- [ ] 関連ドキュメントを更新した

#### セルフレビュー
- [ ] コードが読みやすい
- [ ] 適切にコメントされている
- [ ] DRY原則に従っている
- [ ] エラーハンドリングが適切
- [ ] パフォーマンスに問題がない
- [ ] セキュリティ上の問題がない

### レビュアー用チェックリスト

#### 機能性
- [ ] 要件を満たしている
- [ ] エッジケースが考慮されている
- [ ] エラーハンドリングが適切
- [ ] ユーザビリティが良い

#### コード品質
- [ ] 可読性が高い
- [ ] 保守しやすい
- [ ] テストが十分
- [ ] パフォーマンスが良い

#### セキュリティ
- [ ] 入力検証が適切
- [ ] 機密データが保護されている
- [ ] 権限チェックがある

## 6. レビュー文化の醸成

### ポジティブなレビュー文化
- **学習機会**: レビューを学びの場として活用
- **建設的批判**: 問題を指摘するだけでなく解決策も提案
- **相互尊重**: お互いのスキルレベルを理解し尊重
- **継続改善**: レビュープロセス自体も継続的に改善

### レビューの効率化
- **小さなPR**: 大きな変更は小さく分割
- **明確な説明**: PRの目的と変更内容を明確に記述
- **迅速な対応**: レビューコメントには24時間以内に返答
- **ツール活用**: 自動チェックツールで基本的な問題を事前に検出

## 7. レビューメトリクス

### 品質指標
- **レビューカバレッジ**: レビューされたPRの割合
- **発見不具合数**: レビューで発見されたバグの数
- **修正時間**: レビューコメントから修正完了までの時間
- **再レビュー率**: 1回のレビューで承認されたPRの割合

### プロセス指標
- **レビュー時間**: PRレビューにかかる平均時間
- **応答時間**: レビューリクエストから初回レビューまでの時間
- **承認時間**: レビュー開始から最終承認までの時間

## 関連ドキュメント

- [開発プロセス](./DEVELOPMENT_PROCESS.md)
- [リリース管理戦略](./RELEASE_MANAGEMENT.md)
- [品質保証戦略](./QUALITY_ASSURANCE.md)
- [セキュリティガイドライン](../security/SECURITY_GUIDELINES.md)