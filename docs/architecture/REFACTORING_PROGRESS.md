# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

> ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ `REFACTORING_STRATEGY.md` ã«åŸºã¥ãå®Ÿè£…é€²æ—ã‚’è¿½è·¡ã—ã¾ã™ã€‚

## ğŸ“Š å…¨ä½“é€²æ—

| Phase | åç§° | çŠ¶æ…‹ | å®Œäº†ç‡ |
|-------|------|------|--------|
| Phase 1 | ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã®æŠ½å‡º | ğŸ”„ é€²è¡Œä¸­ | 40% |
| Phase 2 | GameAggregate ã¸ã®çµ±ä¸€ | â¸ï¸ å¾…æ©Ÿ | 0% |
| Phase 3 | ãƒ†ã‚¹ãƒˆã®å¥å…¨åŒ– | â¸ï¸ å¾…æ©Ÿ | 0% |

---

## Phase 1: ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã®æŠ½å‡º (Component Extraction)

### 1.1 DeckSystem (CardInventory) ğŸ“¦

**è²¬å‹™**: å±±æœ­(Deck)ã€æ‰‹æœ­(Hand)ã€æ¨ã¦æœ­(Discard) ã®ç®¡ç†

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| åŸºæœ¬è¨­è¨ˆ | âœ… å®Œäº† | `CardManager.ts` ã¨ã—ã¦æ—¢å­˜ |
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾© | âœ… å®Œäº† | `ICardManager` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ |
| `draw()` å®Ÿè£… | âœ… å®Œäº† | `CardManager.drawCards()` |
| `discard()` å®Ÿè£… | âœ… å®Œäº† | `CardManager.discardSelectedCards()` |
| `shuffle()` å®Ÿè£… | âš ï¸ éƒ¨åˆ†çš„ | `Deck.shuffle()` ã«å­˜åœ¨ã€`CardManager` ã‹ã‚‰å§”è­² |
| `returnToDeck()` å®Ÿè£… | âŒ æœªç€æ‰‹ | æ–°è¦å®Ÿè£…ãŒå¿…è¦ |
| `Game.ts` ã‹ã‚‰ã®åˆ†é›¢ | ğŸ”„ é€²è¡Œä¸­ | `_hand`, `_deck` æ“ä½œã®å§”è­² |
| ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œå¯¾å¿œ | âŒ æœªç€æ‰‹ | `CardsDrawnEvent` ãªã©ã®è¿½åŠ  |

**ç¾çŠ¶ã®èª²é¡Œ**:
- `Game.ts` å†…ã« `CardManager` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹ãŒã€ä¸€éƒ¨ã®ã‚«ãƒ¼ãƒ‰æ“ä½œãŒ `Game.ts` ã«ç›´æ¥æ®‹ã£ã¦ã„ã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•åŒ–ã•ã‚Œã¦ã„ãªã„

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. `CardManager` ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
2. `Game.ts` ã®ç›´æ¥çš„ãªã‚«ãƒ¼ãƒ‰æ“ä½œã‚’ `CardManager` ã¸ã®å§”è­²ã«ç½®ãæ›ãˆ

---

### 1.2 InsurancePortfolio ğŸ›¡ï¸

**è²¬å‹™**: åŠ å…¥ä¸­ã®ä¿é™ºä¸€è¦§ã®ç®¡ç†ã€é©ç”¨åˆ¤å®šã€æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| åŸºæœ¬è¨­è¨ˆ | âœ… å®Œäº† | `Insurance` é›†ç´„ã¨ã—ã¦å­˜åœ¨ |
| `addPolicy()` å®Ÿè£… | âœ… å®Œäº† | `Insurance.create()` |
| `evaluateCoverage()` å®Ÿè£… | âœ… å®Œäº† | `Insurance.use()` |
| `tickTurns()` å®Ÿè£… | âœ… å®Œäº† | `Insurance.decrementTurn()` |
| ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œå¯¾å¿œ | âœ… å®Œäº† | `InsuranceActivatedEvent`, `InsuranceUsedEvent`, `InsuranceExpiredEvent` |
| `InsuranceExpirationManager` ã¨ã®çµ±åˆ | ğŸ”„ é€²è¡Œä¸­ | é‡è¤‡ãƒ­ã‚¸ãƒƒã‚¯ã‚ã‚Š |

**ç¾çŠ¶ã®èª²é¡Œ**:
- `Game.ts` ã® `activeInsurances` ã¨ `Insurance` é›†ç´„ã®é–“ã«é‡è¤‡ãŒã‚ã‚‹
- `GameApplicationService` ã¨ `InsuranceExpirationManager` ã§ä¿é™ºç®¡ç†ãŒåˆ†æ•£

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. `InsurancePortfolio` ã‚¯ãƒ©ã‚¹ã‚’æ–°è¦ä½œæˆã—ã€ä¿é™ºã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ä¸€å…ƒåŒ–
2. `Game.ts` ã‹ã‚‰ä¿é™ºç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ã«åˆ†é›¢

---

### 1.3 TurnManager (PhaseSystem) ğŸ”„

**è²¬å‹™**: ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã®ãƒ«ãƒ¼ãƒ«ç®¡ç†ï¼ˆDraw -> Action -> Endï¼‰

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| åŸºæœ¬è¨­è¨ˆ | âœ… å®Œäº† | `GameTurnManager.ts` ã¨ã—ã¦å­˜åœ¨ |
| `nextTurn()` å®Ÿè£… | âœ… å®Œäº† | `GameTurnManager.nextTurn()` |
| ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãƒ­ã‚¸ãƒƒã‚¯ | âš ï¸ éƒ¨åˆ†çš„ | `Game.ts` ã«æ®‹å­˜ã‚ã‚Š |
| ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œ | âœ… å®Œäº† | `GameStageManager` ã«å§”è­²æ¸ˆã¿ |
| å‹åˆ©æ¡ä»¶åˆ¤å®š | âœ… å®Œäº† | `checkVictoryCondition()` |
| ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œå¯¾å¿œ | âŒ æœªç€æ‰‹ | `TurnAdvancedEvent` ãªã©ã®è¿½åŠ  |

**ç¾çŠ¶ã®èª²é¡Œ**:
- `Game.ts` ã® `nextTurn()` ã¨ `GameTurnManager.nextTurn()` ãŒä¸¦å­˜
- ã‚¿ãƒ¼ãƒ³é€²è¡Œã‚¤ãƒ™ãƒ³ãƒˆãŒæœªæ•´å‚™

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. `Game.nextTurn()` ã‚’ `GameTurnManager` ã¸ã®ç´”ç²‹ãªå§”è­²ã«å¤‰æ›´
2. ã‚¿ãƒ¼ãƒ³é€²è¡Œã‚¤ãƒ™ãƒ³ãƒˆ (`TurnAdvancedEvent`) ã‚’è¿½åŠ 

---

## Phase 2: GameAggregate ã¸ã®çµ±ä¸€ (Unification)

â¸ï¸ **Phase 1 å®Œäº†å¾Œã«ç€æ‰‹**

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| `GameAggregate.ts` è¨­è¨ˆ | â¸ï¸ å¾…æ©Ÿ | æ—¢å­˜ã® `aggregates/` æ§‹é€ ã‚’å‚ç…§ |
| `Game.ts` ã‹ã‚‰ã®ç§»è¡Œ | â¸ï¸ å¾…æ©Ÿ | - |
| `GameApplicationService` å¯¾å¿œ | â¸ï¸ å¾…æ©Ÿ | `GameAggregate` ã®ã¿ã‚’ä½¿ç”¨ |
| UIå±¤ã®å¯¾å¿œ | â¸ï¸ å¾…æ©Ÿ | `useGameState` ã®ä¿®æ­£ |

---

## Phase 3: ãƒ†ã‚¹ãƒˆã®å¥å…¨åŒ– (Test Sanitization)

### `drawCardsSync` æ’²æ»…ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ğŸ¯

**ç™ºè¦‹ã•ã‚ŒãŸä½¿ç”¨ç®‡æ‰€**:

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œç•ªå· | çŠ¶æ…‹ |
|----------|--------|------|
| `Game.ts` (å®šç¾©) | 498 | âŒ å‰Šé™¤äºˆå®š |
| `Game.paranoid-state.test.ts` | 37, 61, 76, 358, 436 | âŒ éåŒæœŸåŒ–å¾…ã¡ |
| `EventSystem.paranoid-observer.test.ts` | 556 | âŒ éåŒæœŸåŒ–å¾…ã¡ |
| `Game.test.ts` | 683, 738, 743, 771 | âŒ éåŒæœŸåŒ–å¾…ã¡ |
| `GameScene.test.ts` | 334 | âŒ éåŒæœŸåŒ–å¾…ã¡ |

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. å„ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ `drawCardsSync` ã‚’ `await game.drawCards()` ã«ç½®ãæ›ãˆ
2. ãƒ†ã‚¹ãƒˆé–¢æ•°ã‚’ `async` ã«å¤‰æ›´
3. å…¨ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. `Game.ts` ã‹ã‚‰ `drawCardsSync` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‰Šé™¤

---

## ğŸ”§ æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒãƒƒãƒ—

### ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
src/domain/
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ Game.ts              # 1388è¡Œ - God Object (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡)
â”œâ”€â”€ aggregates/
â”‚   â”œâ”€â”€ challenge/
â”‚   â”‚   â”œâ”€â”€ Challenge.ts     # âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°å¯¾å¿œ
â”‚   â”‚   â””â”€â”€ events.ts        # âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
â”‚   â””â”€â”€ insurance/
â”‚       â”œâ”€â”€ Insurance.ts     # âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°å¯¾å¿œ
â”‚       â””â”€â”€ events.ts        # âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ CardManager.ts       # âœ… DeckSystem ã®åŸºç›¤
â”‚   â”œâ”€â”€ GameTurnManager.ts   # âœ… TurnManager ã®åŸºç›¤
â”‚   â”œâ”€â”€ GameStageManager.ts  # âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†
â”‚   â””â”€â”€ InsuranceExpirationManager.ts  # âš ï¸ é‡è¤‡ã‚ã‚Š
â””â”€â”€ events/
    â””â”€â”€ GameEvents.ts        # âš ï¸ å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
```

### ç›®æ¨™ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
src/domain/
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ Game.ts              # ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ï¼ˆè–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
â”œâ”€â”€ aggregates/
â”‚   â”œâ”€â”€ challenge/           # âœ… å®Œæˆ
â”‚   â”œâ”€â”€ insurance/           # âœ… å®Œæˆ
â”‚   â””â”€â”€ game/                # ğŸ†• æ–°è¦ä½œæˆ
â”‚       â”œâ”€â”€ GameAggregate.ts
â”‚       â””â”€â”€ events.ts
â”œâ”€â”€ components/              # ğŸ†• æ–°è¦ä½œæˆ
â”‚   â”œâ”€â”€ DeckSystem.ts        # ã‚«ãƒ¼ãƒ‰ç®¡ç†
â”‚   â”œâ”€â”€ InsurancePortfolio.ts # ä¿é™ºç®¡ç†
â”‚   â””â”€â”€ TurnManager.ts       # ã‚¿ãƒ¼ãƒ³ç®¡ç†
â””â”€â”€ events/
    â””â”€â”€ DomainEvents.ts      # çµ±ä¸€ã‚¤ãƒ™ãƒ³ãƒˆåŸºç›¤
```

---

## ğŸ“ æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | æ›´æ–°å†…å®¹ |
|------|----------|
| 2025-12-07 | åˆç‰ˆä½œæˆã€‚ç¾çŠ¶åˆ†æã¨ Phase 1 ã®è©³ç´°åŒ– |

