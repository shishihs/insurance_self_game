# 不具合修正と安定化計画

## 現状の問題
ユーザーより「チャレンジ実行後にアプリケーションがフリーズする」という報告あり。
予備調査により以下の致命的な問題が判明している。

1. **API不整合**: `Card.createInsuranceCard` の定義と呼び出し元で引数の不一致が発生している。
    - 定義: `(name, power, cost, ...effects)`
    - 呼び出し: `(name, power, ...effects)` または `(name, power, effect)`
    - これにより、`cost` にオブジェクトが入り込んだり、`effects` が正しく設定されなかったりして、実行時エラー (`TypeError` 等) や予期せぬ挙動を引き起こしている。
2. **テストの大量失敗**: 上記に起因し、単体テストの約24%が失敗。
3. **Lintエラー**: 多数の型定義違反、未使用変数が存在。

## 修正アプローチ

### Phase 1: クリティカルパスの修復 (最優先)
アプリケーションがフリーズする直接的な原因を取り除く。

1. **`createInsuranceCard` のシグネチャ不整合の解消**
    - 全呼び出し箇所を特定し、新しいシグネチャ `(name, power, cost, ...effects)` に合わせて修正する。
    - 必要であれば、後方互換性のために一時的にオーバーロードを追加する検討も行うが、基本は呼び出し側の修正を優先（型安全確保のため）。
2. **`GameActionProcessor` の修正**
    - チャレンジ実行処理 (`processChallenge`) におけるエラーハンドリングの強化。
    - 不正なカードデータが渡ってきた場合でもクラッシュしないようにガード節を追加。

### Phase 2: テストの正常化
修正したコードに合わせてテストを修正し、リグレッションを防ぐ。

1. `Card.factory.test.ts` の修正。
2. `GameActionProcessor.test.ts` の修正。
3. その他影響を受けたテストの修正。

### Phase 3: 安定性向上
1. 未処理の例外をキャッチし、適切にユーザーにフィードバックする仕組みの確認（Global Error Handler）。
2. Lintエラーの主要なもの（特に `any` 型の乱用による型安全性欠如）を修正。

## 実行タスク
- [x] `createInsuranceCard` の呼び出し箇所を全検索・修正
- [x] `Card.factory.test.ts` の修正
- [x] `GameActionProcessor` のエラーハンドリング確認・修正（テスト、サービスの両方対応済）
- [x] アプリケーション起動・動作確認（保険選択画面のフリーズ修正）
- [ ] 残りのテスト失敗箇所の調査・修正
