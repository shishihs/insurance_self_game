name: PR Status Comment

on:
  workflow_run:
    workflows: ["PR Automated Review"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Download PR number
        uses: actions/github-script@v7
        id: pr-number
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.payload.workflow_run.workflow_id,
              run_id: context.payload.workflow_run.id
            });
            
            if (runs.data.workflow_runs.length > 0) {
              const run = runs.data.workflow_runs[0];
              if (run.pull_requests && run.pull_requests.length > 0) {
                return run.pull_requests[0].number;
              }
            }
            return null;
      
      - name: Create or update comment
        if: steps.pr-number.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr-number.outputs.result }};
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.workflow_run.head_sha
            });
            
            let comment = '## ğŸ¤– è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n';
            comment += `**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: [#${context.payload.workflow_run.id}](${context.payload.workflow_run.html_url})\n`;
            comment += `**å®Ÿè¡Œæ™‚åˆ»**: ${new Date(context.payload.workflow_run.created_at).toLocaleString('ja-JP')}\n\n`;
            
            comment += '| ãƒã‚§ãƒƒã‚¯é …ç›® | çŠ¶æ…‹ | è©³ç´° |\n';
            comment += '|---|---|---|\n';
            
            const checkRuns = checks.check_runs.filter(check => 
              check.app.slug === 'github-actions'
            );
            
            checkRuns.forEach(check => {
              let status = 'â³';
              let detail = check.status;
              
              if (check.conclusion === 'success') {
                status = 'âœ…';
                detail = 'æˆåŠŸ';
              } else if (check.conclusion === 'failure') {
                status = 'âŒ';
                detail = 'å¤±æ•—';
              } else if (check.conclusion === 'cancelled') {
                status = 'âšª';
                detail = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
              } else if (check.status === 'in_progress') {
                status = 'ğŸ”„';
                detail = 'å®Ÿè¡Œä¸­';
              }
              
              comment += `| ${check.name} | ${status} | ${detail} |\n`;
            });
            
            // å…¨ä½“ã®çµæœã‚µãƒãƒªãƒ¼
            const success = checkRuns.every(check => check.conclusion === 'success');
            const hasFailure = checkRuns.some(check => check.conclusion === 'failure');
            const inProgress = checkRuns.some(check => check.status === 'in_progress');
            
            comment += '\n### ğŸ“Š ç·åˆçµæœ\n';
            if (inProgress) {
              comment += 'ğŸ”„ **å®Ÿè¡Œä¸­**: ãƒã‚§ãƒƒã‚¯ãŒé€²è¡Œä¸­ã§ã™...\n';
            } else if (success) {
              comment += 'âœ… **ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸï¼** ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚\n';
            } else if (hasFailure) {
              comment += 'âŒ **ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚** ä¸Šè¨˜ã®å¤±æ•—é …ç›®ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n';
            }
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## ğŸ¤– è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: comment
              });
            }