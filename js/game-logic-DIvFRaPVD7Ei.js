var e=Object.defineProperty,t=(t,a,r)=>((t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r)(t,"symbol"!=typeof a?a+"":a,r);class a{constructor(e,a=[]){t(this,"cards"),t(this,"name"),this.name=e,this.cards=[...a]}getName(){return this.name}size(){return this.cards.length}isEmpty(){return 0===this.cards.length}addCard(e){this.cards.push(e)}addCards(e){this.cards.push(...e)}drawCard(){return this.cards.pop()||null}drawCards(e){const t=[];for(let a=0;a<e&&!this.isEmpty();a++){const e=this.drawCard();e&&t.push(e)}return t}removeCard(e){const t=this.cards.findIndex(t=>t.id===e);return-1!==t&&(this.cards.splice(t,1),!0)}shuffle(){for(let e=this.cards.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}getCards(){return[...this.cards]}countCardsByType(e){return this.cards.filter(t=>t.type===e).length}clear(){this.cards=[]}clone(){return new a(this.name,this.cards.map(e=>e.clone()))}getStats(){const e={total:this.cards.length,byType:{life:0,insurance:0,pitfall:0},averagePower:0,averageCost:0};let t=0,a=0;return this.cards.forEach(r=>{e.byType[r.type]++,t+=r.power,a+=r.cost}),e.averagePower=e.total>0?t/e.total:0,e.averageCost=e.total>0?a/e.total:0,e}}const r=class e{constructor(e){this.value=e,this.validate()}static create(t){return new e(t)}validate(){if(this.value<e.MIN_POWER)throw new Error(`CardPower must be at least ${e.MIN_POWER}`);if(this.value>e.MAX_POWER)throw new Error("Card power cannot exceed maximum")}getValue(){return this.value}add(t){const a=this.value+t.value;return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}static sum(t){const a=t.reduce((e,t)=>e+t.value,0);return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}multiply(t){if(t<0)throw new Error("Multiplier cannot be negative");const a=Math.floor(this.value*t);return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}isGreaterThan(e){return this.value>e.value}isGreaterThanOrEqual(e){return this.value>=e.value}equals(e){return this.value===e.value}toString(){return`Power: ${this.value}`}static get ZERO(){return new e(0)}static get MAX(){return new e(e.MAX_POWER)}};t(r,"MIN_POWER",-99),t(r,"MAX_POWER",999);let s=r;const i=class e{constructor(e){this.value=e,this.validate()}static create(t){return new e(Math.floor(t))}validate(){if(this.value<e.MIN_PREMIUM)throw new Error("InsurancePremium must be non-negative");if(this.value>e.MAX_PREMIUM)throw new Error("InsurancePremium cannot exceed maximum")}getValue(){return this.value}static sum(t){const a=t.reduce((e,t)=>e+t.value,0);return new e(Math.min(a,e.MAX_PREMIUM))}applyDiscount(t){if(t<0)throw new Error("Discount rate cannot be negative");if(t>1)throw new Error("Discount rate cannot exceed 100%");const a=Math.floor(this.value*(1-t));return new e(a)}applyMultiplier(t){if(t<0)throw new Error("Multiplier cannot be negative");const a=Math.floor(this.value*t);return new e(Math.min(a,e.MAX_PREMIUM))}isFree(){return 0===this.value}isExpensive(){return this.value>=e.EXPENSIVE_THRESHOLD}isHigherThan(e){return this.value>e.value}isAffordableWith(e){return e>=this.value}equals(e){return this.value===e.value}toString(){return this.isFree()?"ä¿é™ºæ–™: ç„¡æ–™":`ä¿é™ºæ–™: ${this.value}`}static get FREE(){return new e(0)}};t(i,"MIN_PREMIUM",0),t(i,"MAX_PREMIUM",99),t(i,"EXPENSIVE_THRESHOLD",20);let n=i;class c{static generate(e="id"){return`${e}_${Date.now()}_${this.getRandomString()}`}static generateCardId(){return this.generate("card")}static generateGameId(){return this.generate("game")}static generateCommandId(){return this.generate("cmd")}static generateNotificationId(){return this.generate("notification")}static generateFeedbackId(){return this.generate("feedback")}static generateSequential(e="seq"){return`${e}_${++this.counter}`}static generateUUID(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});return e?`${e}_${t}`:t}static getRandomString(e=9){return Math.random().toString(36).substr(2,e)}static resetCounter(){this.counter=0}static getCurrentCounter(){return this.counter}}t(c,"counter",0);class o{constructor(e){t(this,"id"),t(this,"name"),t(this,"description"),t(this,"type"),t(this,"_power"),t(this,"_cost"),t(this,"effects"),t(this,"imageUrl"),t(this,"category"),t(this,"insuranceType"),t(this,"coverage"),t(this,"penalty"),t(this,"ageBonus"),t(this,"durationType"),t(this,"remainingTurns"),t(this,"insuranceEffectType"),t(this,"insuranceTriggerType"),t(this,"dreamCategory"),t(this,"skillProperties"),t(this,"comboProperties"),t(this,"eventProperties"),t(this,"isUnlockable"),t(this,"unlockCondition"),t(this,"rewardType"),this.id=e.id,this.name=e.name,this.description=e.description,this.type=e.type,this._power=s.create(e.power),this._cost=n.create(e.cost),this.effects=e.effects,this.imageUrl=e.imageUrl,this.category=e.category,this.insuranceType=e.insuranceType,this.coverage=e.coverage,this.penalty=e.penalty,"ageBonus"in e&&(this.ageBonus=e.ageBonus),"durationType"in e&&(this.durationType=e.durationType),"remainingTurns"in e&&(this.remainingTurns=e.remainingTurns),"insuranceEffectType"in e&&(this.insuranceEffectType=e.insuranceEffectType),"insuranceTriggerType"in e&&(this.insuranceTriggerType=e.insuranceTriggerType),"dreamCategory"in e&&(this.dreamCategory=e.dreamCategory),"skillProperties"in e&&(this.skillProperties=e.skillProperties),"comboProperties"in e&&(this.comboProperties=e.comboProperties),"eventProperties"in e&&(this.eventProperties=e.eventProperties),"isUnlockable"in e&&(this.isUnlockable=e.isUnlockable),"unlockCondition"in e&&(this.unlockCondition=e.unlockCondition),"rewardType"in e&&(this.rewardType=e.rewardType)}get power(){return this._power.getValue()}get cost(){return this._cost.getValue()}getPower(){return this._power}getCost(){return this._cost}hasEffect(e){return this.effects.some(t=>t.type===e)}getEffect(e){return this.effects.find(t=>t.type===e)}isInsurance(){return"insurance"===this.type}isTermInsurance(){return this.isInsurance()&&"term"===this.durationType}isWholeLifeInsurance(){return this.isInsurance()&&"whole_life"===this.durationType}getInsuranceEffectType(){if(this.isInsurance())return this.insuranceEffectType||"offensive"}isDefensiveInsurance(){return this.isInsurance()&&"defensive"===this.getInsuranceEffectType()}isRecoveryInsurance(){return this.isInsurance()&&"recovery"===this.getInsuranceEffectType()}isSpecializedInsurance(){return this.isInsurance()&&"specialized"===this.getInsuranceEffectType()}calculateDamageReduction(){if(!this.isInsurance())return 0;if(!this.isDefensiveInsurance()&&!this.hasEffect("damage_reduction"))return 0;let e=0;this.isDefensiveInsurance()&&(e+=.5*(this.coverage||0));const t=this.getEffect("damage_reduction");return t&&(e+=.5*t.value),Math.min(e,50)}calculateTurnHeal(){if(!this.isRecoveryInsurance())return 0;const e=Math.floor((this.coverage||0)/20),t=this.getEffect("turn_heal");return e+(t?t.value:0)}calculateChallengeBonus(e){if(!this.isSpecializedInsurance())return 0;const t=this.getEffect("challenge_bonus");return t?.condition&&t.condition.includes(e)?t.value:0}isDreamCard(){return"dream"===this.type}copy(e){return new o({...this,power:this.power,cost:this.cost,effects:[...this.effects],...e})}clone(){return this.copy()}decrementRemainingTurns(){return this.isTermInsurance()&&this.remainingTurns?this.copy({remainingTurns:Math.max(0,this.remainingTurns-1)}):this}isExpired(){return!!this.isTermInsurance()&&0===this.remainingTurns}hasPowerAtLeast(e){const t=s.create(e);return this._power.isGreaterThanOrEqual(t)}isAffordableWith(e){return this._cost.isAffordableWith(e)}calculateEffectivePower(e){let t=this.power;return this.isInsurance()&&this.ageBonus&&(t+=this.ageBonus),void 0!==e&&(t+=e),this.isInsurance()&&"offensive"!==this.getInsuranceEffectType()?0:Math.max(0,t)}isLifeCard(){return"life"===this.type}isInsuranceCard(){return this.isInsurance()}isPitfallCard(){return"pitfall"===this.type}isSkillCard(){return"skill"===this.type}isComboCard(){return"combo"===this.type}isEventCard(){return"event"===this.type}isLegendaryCard(){return"legendary"===this.type}isChallengeCard(){return"challenge"===this.type}toDisplayString(){let e=`${this.name} - Power: ${this.power}, Cost: ${this.cost}`;return this.effects.length>0&&(e+=` - Effects: ${this.effects.map(e=>e.description).join(", ")}`),e}decrementTurn(){void 0!==this.remainingTurns&&this.remainingTurns>0&&this.remainingTurns--}static createLifeCard(e,t){const a=t>0?"+":"";return new o({id:c.generate("life"),name:e,description:`ãƒ‘ãƒ¯ãƒ¼: ${a}${t}`,type:"life",power:t,cost:0,effects:[]})}static createChallengeCard(e,t){return new o({id:c.generate("challenge"),name:e,description:`å¿…è¦ãƒ‘ãƒ¯ãƒ¼: ${t}`,type:"challenge",power:t,cost:0,effects:[]})}static createInsuranceCard(e,t,a=1,...r){return new o({id:c.generate("insurance"),name:e,description:`ä¿é™ºã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${t}`,type:"insurance",power:t,cost:a,effects:r})}static createSkillCard(e,t,a,r){return new o({id:c.generate("skill"),name:e,description:`${{common:"ã‚³ãƒ¢ãƒ³",rare:"ãƒ¬ã‚¢",epic:"ã‚¨ãƒ”ãƒƒã‚¯",legendary:"ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼"}[t]}ã‚¹ã‚­ãƒ« - ãƒ‘ãƒ¯ãƒ¼: +${a}`,type:"skill",power:a,cost:0,effects:[],skillProperties:{rarity:t,cooldown:r,remainingCooldown:0,masteryLevel:1}})}static createComboCard(e,t,a,r){return new o({id:c.generate("combo"),name:e,description:`ã‚³ãƒ³ãƒœã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${t} (ã‚³ãƒ³ãƒœæ™‚: +${r})`,type:"combo",power:t,cost:0,effects:[],comboProperties:{requiredCards:a,comboBonus:r}})}static createEventCard(e,t,a,r=!1){return new o({id:c.generate("event"),name:e,description:`ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ - ${a}ã‚¿ãƒ¼ãƒ³ç¶™ç¶š`,type:"event",power:t,cost:0,effects:[],eventProperties:{duration:a,globalEffect:r}})}static createLegendaryCard(e,t,a){return new o({id:c.generate("legendary"),name:e,description:`ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${t}`,type:"legendary",power:t,cost:0,effects:[],isUnlockable:!0,unlockCondition:a})}}class l extends o{constructor(e){const a=[];"extreme"===e.riskLevel&&a.push({type:"special_action",value:0,description:"ä¿é™ºåŠ¹æœç„¡åŠ¹åŒ–",condition:"ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼ãŒç„¡åŠ¹"}),super({id:c.generateCardId(),type:"challenge",name:e.name,description:e.description,power:e.power,cost:0,effects:a,dreamCategory:e.dreamCategory}),t(this,"riskLevel"),t(this,"successBonus"),t(this,"failurePenalty"),t(this,"insuranceImmunity"),this.riskLevel=e.riskLevel,this.successBonus=e.successBonus,this.failurePenalty=e.failurePenalty,this.insuranceImmunity=e.insuranceImmunity||"extreme"===e.riskLevel}getRiskMultiplier(){return{low:1.2,medium:1.5,high:2,extreme:3}[this.riskLevel]}calculateActualReward(e){return Math.floor(e*this.getRiskMultiplier())+this.successBonus}calculateActualPenalty(e){return Math.floor(e*this.getRiskMultiplier())+this.failurePenalty}getRiskDescription(){return{low:"ä½ãƒªã‚¹ã‚¯: å°‘ã—å±é™ºã ãŒã€å¤±æ•—ã—ã¦ã‚‚ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯è»½ã„",medium:"ä¸­ãƒªã‚¹ã‚¯: æˆåŠŸã¨å¤±æ•—ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã‚‹",high:"é«˜ãƒªã‚¹ã‚¯: å¤±æ•—æ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¤§ãã„ãŒã€å ±é…¬ã‚‚é­…åŠ›çš„",extreme:"æ¥µé™ãƒªã‚¹ã‚¯: ä¿é™ºã‚‚åŠ¹ã‹ãªã„å±é™ºãªæŒ‘æˆ¦ã€‚æˆåŠŸã™ã‚Œã°å¤§ããªå ±é…¬"}[this.riskLevel]}getChallengeDetails(){return[`å¿…è¦ãƒ‘ãƒ¯ãƒ¼: ${this.power}`,`ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: ${this.riskLevel.toUpperCase()}`,`æˆåŠŸãƒœãƒ¼ãƒŠã‚¹: +${this.successBonus} æ´»åŠ›`,`å¤±æ•—ãƒšãƒŠãƒ«ãƒ†ã‚£: -${this.failurePenalty} æ´»åŠ›`,this.insuranceImmunity?"âš ï¸ ä¿é™ºç„¡åŠ¹":""].filter(Boolean).join("\n")}static createRiskChallenge(e,t){const a={youth:{low:{name:"æ–°ã—ã„ã‚¹ãƒãƒ¼ãƒ„ã¸ã®æŒ‘æˆ¦",description:"æœªçµŒé¨“ã®åˆ†é‡ã«æŒ‘æˆ¦ã™ã‚‹å‹‡æ°—",power:5,successBonus:2,failurePenalty:1},medium:{name:"èµ·æ¥­ã¸ã®ç¬¬ä¸€æ­©",description:"å®‰å®šã‚’æ¨ã¦ã¦å¤¢ã‚’è¿½ã†æ±ºæ–­",power:7,successBonus:5,failurePenalty:3},high:{name:"æµ·å¤–ç•™å­¦",description:"æœªçŸ¥ã®ä¸–ç•Œã¸ã®å¤§ããªé£›èº",power:9,successBonus:8,failurePenalty:5},extreme:{name:"äººç”Ÿã‚’è³­ã‘ãŸå¤§å‹è² ",description:"å…¨ã¦ã‚’æŠ•ã’æ‰“ã£ã¦æŒ‘ã‚€æœ€å¤§ã®æŒ‘æˆ¦",power:12,successBonus:15,failurePenalty:10}},middle:{low:{name:"å‰¯æ¥­ã®é–‹å§‹",description:"æ–°ãŸãªåå…¥æºã¸ã®æŒ‘æˆ¦",power:6,successBonus:3,failurePenalty:2},medium:{name:"ç‹¬ç«‹é–‹æ¥­",description:"ä¼šç¤¾ã‚’è¾ã‚ã¦ç‹¬ç«‹ã™ã‚‹æ±ºæ–­",power:9,successBonus:7,failurePenalty:5},high:{name:"å¤§å‹æŠ•è³‡",description:"å°†æ¥ã‚’è¦‹æ®ãˆãŸå¤§èƒ†ãªæŠ•è³‡",power:11,successBonus:10,failurePenalty:7},extreme:{name:"äººç”Ÿã®å¤§è»¢æ›",description:"å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é“ã¸",power:15,successBonus:20,failurePenalty:15}},fulfillment:{low:{name:"æ–°ã—ã„è¶£å‘³ã¸ã®æŒ‘æˆ¦",description:"å¹´é½¢ã«é–¢ä¿‚ãªãæ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹",power:7,successBonus:4,failurePenalty:2},medium:{name:"ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•",description:"ç¤¾ä¼šè²¢çŒ®ã¸ã®æ–°ãŸãªä¸€æ­©",power:10,successBonus:8,failurePenalty:4},high:{name:"éºç”£ã®æ´»ç”¨",description:"æ¬¡ä¸–ä»£ã¸ã®å¤§ããªæŠ•è³‡",power:13,successBonus:12,failurePenalty:8},extreme:{name:"äººç”Ÿæœ€å¾Œã®å¤§å†’é™º",description:"æ®‹ã•ã‚ŒãŸæ™‚é–“ã§ã®ç©¶æ¥µã®æŒ‘æˆ¦",power:18,successBonus:25,failurePenalty:20}}}[e][t];return new l({...a,riskLevel:t,dreamCategory:"extreme"===t?"mixed":"physical"})}}class u{static calculateAgeBonus(e){switch(e){case"middle":return.5;case"fulfillment":return 1;default:return 0}}static createCardsFromDefinitions(e,t){return e.map(e=>t(e))}static createStarterLifeCards(){return this.createCardsFromDefinitions([{name:"æœã®ã‚¸ãƒ§ã‚®ãƒ³ã‚°",description:"å¥åº·çš„ãªä¸€æ—¥ã®å§‹ã¾ã‚Š",category:"health",power:2,cost:1},{name:"æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„é£Ÿäº‹",description:"ä½“èª¿ç®¡ç†ã®åŸºæœ¬",category:"health",power:4,cost:2},{name:"æ–°ã—ã„ã‚¹ã‚­ãƒ«ã®ç¿’å¾—",description:"æˆé•·ã¸ã®æŠ•è³‡",category:"career",power:4,cost:2},{name:"ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯",description:"ä»²é–“ã¨ã®å”åŠ›",category:"career",power:2,cost:1},{name:"å®¶æ—ã¨ã®å›£ã‚‰ã‚“",description:"å¿ƒã®å……é›»",category:"family",power:2,cost:1},{name:"è¶£å‘³ã®æ™‚é–“",description:"ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒ ",category:"hobby",power:2,cost:1},{name:"è¨ˆç”»çš„ãªè²¯è“„",description:"å°†æ¥ã¸ã®å‚™ãˆ",category:"finance",power:4,cost:2}],e=>this.createLifeCard(e))}static createBasicInsuranceCards(e="youth"){const t=this.calculateAgeBonus(e);return this.createCardsFromDefinitions([{name:"åŒ»ç™‚ä¿é™º",description:"ç—…æ°—ã‚„ã‚±ã‚¬ã«å‚™ãˆã‚‹æ°¸ç¶šä¿éšœ",insuranceType:"medical",power:4,cost:3,coverage:100},{name:"ç”Ÿå‘½ä¿é™º",description:"å®¶æ—ã‚’å®ˆã‚‹æ°¸ç¶šä¿éšœ",insuranceType:"life",power:5,cost:4,coverage:200},{name:"åå…¥ä¿éšœä¿é™º",description:"åƒã‘ãªããªã£ãŸæ™‚ã®æ°¸ç¶šä¿éšœ",insuranceType:"income",power:4,cost:3,coverage:150}],e=>this.createInsuranceCard({...e,ageBonus:t}))}static createExtendedInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e),r=this.createCardsFromDefinitions([{name:"åŒ»ç™‚ä¿é™º",insuranceType:"medical",power:5,cost:4,coverage:100},{name:"ç”Ÿå‘½ä¿é™º",insuranceType:"life",power:6,cost:5,coverage:200},{name:"åå…¥ä¿éšœä¿é™º",insuranceType:"income",power:5,cost:4,coverage:150}],e=>this.createInsuranceCard({name:e.name,description:`${e.name}ã®æ°¸ç¶šä¿éšœ`,insuranceType:e.insuranceType,power:e.power,cost:e.cost,coverage:e.coverage,ageBonus:a}));t.push(...r);const s=this.createCardsFromDefinitions([{name:"å‚·å®³ä¿é™º",insuranceType:"medical",power:4,cost:3,coverage:80},{name:"å°±æ¥­ä¸èƒ½ä¿é™º",insuranceType:"income",power:7,cost:6,coverage:250},{name:"ä»‹è­·ä¿é™º",insuranceType:"medical",power:6,cost:5,coverage:180},{name:"ãŒã‚“ä¿é™º",insuranceType:"medical",power:5,cost:4,coverage:120},{name:"å€‹äººå¹´é‡‘ä¿é™º",insuranceType:"income",power:4,cost:4,coverage:100},{name:"å­¦è³‡ä¿é™º",insuranceType:"life",power:4,cost:3,coverage:90}],e=>this.createInsuranceCard({name:e.name,description:`${e.name}ã®æ°¸ç¶šä¿éšœ`,insuranceType:e.insuranceType,power:e.power,cost:e.cost,coverage:e.coverage,ageBonus:a}));return t.push(...s),t}static createDiverseInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e);return t.push(new o({id:c.generateCardId(),type:"insurance",name:"æ”»æ’ƒç‰¹åŒ–ç”Ÿå‘½ä¿é™º",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ™‚ã«å¤§ããªãƒ‘ãƒ¯ãƒ¼ã‚’æä¾›",power:8,cost:5,insuranceType:"life",insuranceEffectType:"offensive",coverage:150,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"é˜²å¾¡ç‰¹åŒ–åŒ»ç™‚ä¿é™º",description:"ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹é˜²å¾¡çš„ä¿éšœ",power:0,cost:4,insuranceType:"medical",insuranceEffectType:"defensive",coverage:100,effects:[{type:"damage_reduction",value:3,description:"ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’3ãƒã‚¤ãƒ³ãƒˆè»½æ¸›"}],ageBonus:0,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"å›å¾©ç‰¹åŒ–å¥åº·ä¿é™º",description:"æ¯ã‚¿ãƒ¼ãƒ³æ´»åŠ›ã‚’å›å¾©",power:0,cost:3,insuranceType:"health",insuranceEffectType:"recovery",coverage:80,effects:[{type:"turn_heal",value:2,description:"æ¯ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«2ç‚¹å›å¾©"}],ageBonus:0,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ä»•äº‹ç‰¹åŒ–åå…¥ä¿éšœä¿é™º",description:"ä»•äº‹é–¢é€£ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«ç‰¹åŒ–",power:3,cost:4,insuranceType:"income",insuranceEffectType:"specialized",coverage:120,effects:[{type:"challenge_bonus",value:5,description:"ã€Œå°±è·ã€ã€Œæ˜é€²ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ™‚+5ãƒ‘ãƒ¯ãƒ¼",condition:"å°±è·,æ˜é€²,è»¢è·,ä»•äº‹"}],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ç·åˆä¿é™º",description:"è¤‡æ•°ã®åŠ¹æœã‚’æŒã¤é«˜ã‚³ã‚¹ãƒˆä¿éšœ",power:3,cost:7,insuranceType:"life",insuranceEffectType:"comprehensive",coverage:200,effects:[{type:"power_boost",value:3,description:"ãƒ‘ãƒ¯ãƒ¼+3"},{type:"damage_reduction",value:2,description:"ãƒ€ãƒ¡ãƒ¼ã‚¸-2"},{type:"turn_heal",value:1,description:"æ¯ã‚¿ãƒ¼ãƒ³+1å›å¾©"}],ageBonus:a,durationType:"whole_life"})),t}static createTriggerInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e);return t.push(new o({id:c.generateCardId(),type:"insurance",name:"ç”Ÿå‘½ä¿é™º",description:"æ´»åŠ›ãŒ0ã«ãªã‚‹ç¬é–“ã€æ´»åŠ›10ã§å¾©æ´»ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚",power:0,cost:2,insuranceType:"life",insuranceEffectType:"trigger",insuranceTriggerType:"on_death",coverage:10,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"åŒ»ç™‚ä¿é™º",description:"10ãƒ€ãƒ¡ãƒ¼ã‚¸ä»¥ä¸Šå—ã‘ã‚‹æ™‚ã€1ãƒ€ãƒ¡ãƒ¼ã‚¸ã«è»½æ¸›ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚",power:0,cost:3,insuranceType:"medical",insuranceEffectType:"trigger",insuranceTriggerType:"on_heavy_damage",coverage:10,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"éšœå®³ä¿é™º",description:"è€åŒ–ã‚«ãƒ¼ãƒ‰ãŒ3æšæƒã£ãŸæ™‚ã€æ‰‹æœ­ã‚’å…¨ã¦å¼•ãç›´ã—ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚",power:0,cost:2,insuranceType:"disability",insuranceEffectType:"trigger",insuranceTriggerType:"on_aging_gameover",coverage:0,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"å°±æ¥­ä¸èƒ½ä¿é™º",description:"ã„ã¤ã§ã‚‚ç™ºå‹•å¯èƒ½ã€‚ç¾åœ¨ã®èª²é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—ï¼‰ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚",power:0,cost:3,insuranceType:"income",insuranceEffectType:"trigger",insuranceTriggerType:"on_demand",coverage:0,effects:[],ageBonus:a,durationType:"whole_life"})),t}static createInsuranceTypeChoices(e="youth"){const t=[],a=this.calculateAgeBonus(e),r=[{type:"medical",name:"åŒ»ç™‚ä¿é™º",description:"ç—…æ°—ã‚„ã‚±ã‚¬ã«å‚™ãˆã‚‹ä¿éšœ",power:5,baseCost:4,coverage:100,effectType:"offensive"},{type:"life",name:"ç”Ÿå‘½ä¿é™º",description:"å®¶æ—ã‚’å®ˆã‚‹ä¿éšœ",power:6,baseCost:5,coverage:200,effectType:"offensive"},{type:"income",name:"åå…¥ä¿éšœä¿é™º",description:"åƒã‘ãªããªã£ãŸæ™‚ã®ä¿éšœ",power:5,baseCost:4,coverage:150,effectType:"offensive"},{type:"health",name:"é˜²å¾¡å‹å¥åº·ä¿é™º",description:"ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹é˜²å¾¡çš„ä¿éšœ",power:0,baseCost:3,coverage:80,effectType:"defensive"},{type:"disability",name:"å›å¾©å‹éšœå®³ä¿é™º",description:"å®šæœŸçš„ã«æ´»åŠ›ã‚’å›å¾©",power:0,baseCost:3,coverage:60,effectType:"recovery"}];for(let s=0;s<3&&r.length>0;s++){const e=Math.floor(Math.random()*r.length),s=r.splice(e,1)[0],i=5,n=Math.ceil(1.3*s.baseCost),c=Math.floor(.6*s.baseCost),o={insuranceType:s.type,name:s.name,description:s.description,baseCard:{name:s.name,description:s.description,type:"insurance",power:s.power,cost:s.baseCost,insuranceType:s.type,coverage:s.coverage,insuranceEffectType:s.effectType,effects:[{type:"shield",value:s.coverage,description:`${s.coverage}ãƒã‚¤ãƒ³ãƒˆã®ä¿éšœ`}],ageBonus:a},termOption:{cost:n,duration:i,description:`${i}ã‚¿ãƒ¼ãƒ³é™å®šï¼ˆæ¯ã‚¿ãƒ¼ãƒ³${n}ã‚³ã‚¹ãƒˆãƒ»é«˜ã‚ï¼‰`},wholeLifeOption:{cost:c,description:`æ°¸ç¶šä¿éšœï¼ˆæ¯ã‚¿ãƒ¼ãƒ³${c}ã‚³ã‚¹ãƒˆãƒ»å®‰ã‚ï¼‰`}};t.push(o)}return t}static createTermInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:`å®šæœŸ${e.name}`,description:`${e.baseCard.description}ï¼ˆ${e.termOption.duration}ã‚¿ãƒ¼ãƒ³é™å®šï¼‰`,power:e.baseCard.power,cost:e.termOption.cost,insuranceType:e.insuranceType,coverage:e.baseCard.coverage,effects:e.baseCard.effects,ageBonus:e.baseCard.ageBonus,insuranceEffectType:e.baseCard.insuranceEffectType,durationType:"term",remainingTurns:e.termOption.duration})}static createWholeLifeInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:`çµ‚èº«${e.name}`,description:`${e.baseCard.description}ï¼ˆæ°¸ç¶šä¿éšœï¼‰`,power:e.baseCard.power,cost:e.wholeLifeOption.cost,insuranceType:e.insuranceType,coverage:e.baseCard.coverage,effects:e.baseCard.effects,ageBonus:e.baseCard.ageBonus,insuranceEffectType:e.baseCard.insuranceEffectType,durationType:"whole_life"})}static createChallengeCards(e){const t={youth:[{name:"ã‚¢ãƒ«ãƒã‚¤ãƒˆæ¢ã—",description:"åˆã‚ã¦ã®åå…¥ã‚’å¾—ã‚‹",power:10,damage:3,dreamCategory:"physical"},{name:"ä¸€äººæš®ã‚‰ã—",description:"ç‹¬ç«‹ã¸ã®ç¬¬ä¸€æ­©",power:12,damage:4,dreamCategory:"physical"},{name:"è³‡æ ¼è©¦é¨“",description:"ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã®ãƒãƒ£ãƒ³ã‚¹",power:15,damage:5,dreamCategory:"intellectual"},{name:"å°±è·æ´»å‹•",description:"æ–°ãŸãªã‚­ãƒ£ãƒªã‚¢ã®å§‹ã¾ã‚Š",power:18,damage:6,dreamCategory:"physical"},{name:"æ‹äººã¨ã®åˆ¥ã‚Œ",description:"åˆã‚ã¦ã®å¤§ããªå¤±æ„",power:14,damage:5,dreamCategory:"mixed"},{name:"è»¢è·æ´»å‹•",description:"ã‚­ãƒ£ãƒªã‚¢ã®åˆ†å²ç‚¹",power:16,damage:6,dreamCategory:"intellectual"}],middle:[{name:"çµå©šè³‡é‡‘",description:"æ–°ã—ã„å®¶æ—ã®ã‚¹ã‚¿ãƒ¼ãƒˆ",power:20,damage:8,dreamCategory:"mixed"},{name:"å­è‚²ã¦",description:"å®¶æ—ã®æˆé•·",power:22,damage:8,dreamCategory:"physical"},{name:"ä¸¡è¦ªã®å¥åº·",description:"å®¶æ—ã®æ”¯ãˆåˆã„",power:20,damage:7,dreamCategory:"mixed"},{name:"ä½å®…è³¼å…¥",description:"å¤§ããªæ±ºæ–­",power:25,damage:10,dreamCategory:"physical"},{name:"è¦ªã®ä»‹è­·",description:"å®¶æ—ã®è²¬ä»»",power:28,damage:12,dreamCategory:"mixed"},{name:"æ•™è‚²è³‡é‡‘",description:"å­ä¾›ã®å°†æ¥ã¸ã®æŠ•è³‡",power:24,damage:9,dreamCategory:"intellectual"}],fulfillment:[{name:"æ¬¡ä¸–ä»£ã®è‚²æˆ",description:"è‹¥è€…ãŸã¡ã«çŸ¥è­˜ã¨çµŒé¨“ã‚’ä¼ãˆã‚‹",power:20,damage:8,dreamCategory:"intellectual"},{name:"åœ°åŸŸç¤¾ä¼šã®å¤‰é©",description:"ä½ã¿ã‚ˆã„ç¤¾ä¼šã‚’ä½œã‚‹ãŸã‚ã®æ´»å‹•",power:24,damage:10,dreamCategory:"mixed"},{name:"ç”Ÿæ¶¯ã®ç ”ç©¶ç™ºè¡¨",description:"é•·å¹´ã®æ¢ç©¶ã®æˆæœã‚’ä¸–ã«å‡ºã™",power:26,damage:10,dreamCategory:"intellectual"},{name:"ä¸–ç•Œå¹³å’Œã¸ã®è²¢çŒ®",description:"å›½å¢ƒã‚’è¶ŠãˆãŸæ…ˆå–„æ´»å‹•",power:30,damage:12,dreamCategory:"mixed"},{name:"å®‡å®™æ—…è¡Œ",description:"äººé¡ã®å¤¢ã€æ˜Ÿã€…ã®æµ·ã¸",power:35,damage:15,dreamCategory:"physical"},{name:"ä¼èª¬ã®ç¶™æ‰¿",description:"è‡ªèº«ã®ç”Ÿãæ§˜ã‚’ä¼èª¬ã¨ã—ã¦æ®‹ã™",power:40,damage:20,dreamCategory:"mixed"}]},a=[...t[e]||t.fulfillment].sort(()=>Math.random()-.5),r=3+Math.floor(2*Math.random()),s=a.slice(0,r);return[...this.createCardsFromDefinitions(s,e=>this.createChallengeCard({...e,penalty:e.damage,isDream:!1})),...this.createRiskRewardChallenges(e)]}static createDreamCards(){return this.createCardsFromDefinitions([{name:"ä¸–ç•Œä¸€å‘¨æ—…è¡Œ",description:"æœªçŸ¥ã®ä¸–ç•Œã‚’ä½“é¨“ã™ã‚‹",power:50,damage:20,dreamCategory:"physical"},{name:"æœ¬ã®å‡ºç‰ˆ",description:"è‡ªåˆ†ã®çŸ¥è­˜ã‚’ä¸–ã«æ®‹ã™",power:50,damage:20,dreamCategory:"intellectual"},{name:"å¹¸ã›ãªå®¶åº­",description:"æ„›ã«æº€ã¡ãŸç”Ÿæ´»",power:50,damage:20,dreamCategory:"mixed"},{name:"èµ·æ¥­ã—ã¦æˆåŠŸ",description:"è‡ªåˆ†ã®ãƒ“ã‚¸ãƒã‚¹ã‚’æŒã¤",power:60,damage:25,dreamCategory:"mixed"},{name:"éš å±…ç”Ÿæ´»",description:"é™ã‹ã§ç©ã‚„ã‹ãªä½™ç”Ÿ",power:45,damage:15,dreamCategory:"physical"}],e=>this.createChallengeCard({...e,penalty:e.damage,isDream:!0}))}static createRiskRewardChallenges(e){const t=[],a={youth:{low:.5,medium:.3,high:.15,extreme:.05},middle:{low:.3,medium:.4,high:.2,extreme:.1},fulfillment:{low:.2,medium:.3,high:.3,extreme:.2}},r=a[e]||a.youth;if(Math.random()<.2){let a;const s=Math.random();a=s<r.low?"low":s<r.low+r.medium?"medium":s<r.low+r.medium+r.high?"high":"extreme";const i=l.createRiskChallenge(e,a);t.push(i)}return t}static createPitfallCards(){return this.createCardsFromDefinitions([{name:"æ€¥ãªå…¥é™¢",description:"äºˆæœŸã›ã¬åŒ»ç™‚è²»",power:0,penalty:3},{name:"å¤±æ¥­",description:"åå…¥ã®é€”çµ¶",power:0,penalty:4},{name:"äº‹æ•…",description:"äºˆæœŸã›ã¬ãƒˆãƒ©ãƒ–ãƒ«",power:0,penalty:2}],e=>this.createPitfallCard(e))}createLifeCard(e){return u.createLifeCard({name:`ãƒ†ã‚¹ãƒˆ${e.category}ã‚«ãƒ¼ãƒ‰`,description:`${e.category}ã®ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰`,category:e.category,power:e.basePower,cost:e.baseCost})}static createLifeCard(e){if(e.power<0)throw new Error("Life card power cannot be negative");return new o({id:c.generateCardId(),type:"life",name:e.name,description:e.description,power:e.power,cost:e.cost,category:e.category,effects:[]})}static createInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:e.name,description:e.description,power:e.power,cost:e.cost,insuranceType:e.insuranceType,coverage:e.coverage,effects:[{type:"shield",value:e.coverage,description:`${e.coverage}ãƒã‚¤ãƒ³ãƒˆã®ä¿éšœ`}],ageBonus:e.ageBonus||0})}static createChallengeCard(e){const t=e.isDream?"dream":"challenge",a=this.determineRewardType(e.power,t);return new o({id:c.generateCardId(),type:t,name:e.name,description:e.description,power:e.power,cost:0,penalty:e.penalty,effects:[],dreamCategory:e.dreamCategory,rewardType:a})}static determineRewardType(e,t){return"dream"===t?"vitality":e<=3||e<=6?"insurance":"card"}static createPitfallCard(e){return new o({id:c.generateCardId(),type:"trouble",name:e.name,description:e.description,power:e.power,cost:0,penalty:e.penalty,effects:[]})}static createCard(e){const{base:t,effects:a}=e;return new o({id:t.id||c.generateCardId(),type:t.type,name:t.name,description:t.description,power:0,cost:0,effects:a||[]})}static createAgingCards(e){const t=[];for(let a=0;a<e;a++)t.push(new o({id:c.generateCardId(),type:"aging",name:"è€åŒ–",description:"å¹´é½¢ã«ã‚ˆã‚‹è¡°ãˆã€‚ä½¿ç”¨ä¸å¯ã€‚",power:0,cost:0,effects:[{type:"aging_penalty",value:0,description:"æ‰‹æœ­ã«ã‚ã‚‹ã¨æ´»åŠ›ãŒæ¸›å°‘ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹"}]}));return t}static createFinalChallengeCard(){return new o({id:c.generateCardId(),type:"final_challenge",name:"äººç”Ÿã®ç·æ±ºç®—",description:"ã“ã‚Œã¾ã§ã®äººç”Ÿã®ã™ã¹ã¦ã‚’è³­ã‘ãŸæœ€å¾Œã®æŒ‘æˆ¦",power:0,cost:0,effects:[]})}static createSkillCards(e="youth"){const t={youth:[{name:"é›†ä¸­åŠ›",description:"é›†ä¸­ã—ã¦å–ã‚Šçµ„ã‚€èƒ½åŠ›",rarity:"common",power:3,cooldown:0},{name:"ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³",description:"äººã¨ã®é–¢ã‚ã‚Šã‚’æ·±ã‚ã‚‹",rarity:"common",power:4,cooldown:1},{name:"ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—",description:"ãƒãƒ¼ãƒ ã‚’ç‡ã„ã‚‹åŠ›",rarity:"rare",power:6,cooldown:2},{name:"å‰µé€ æ€§",description:"æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿã¿å‡ºã™",rarity:"epic",power:8,cooldown:3}],middle:[{name:"æˆ¦ç•¥çš„æ€è€ƒ",description:"é•·æœŸçš„ãªè¦–ç‚¹ã§è€ƒãˆã‚‹",rarity:"rare",power:7,cooldown:2},{name:"ãƒ¡ãƒ³ã‚¿ãƒªãƒ³ã‚°",description:"å¾Œè¼©ã‚’æŒ‡å°ã™ã‚‹èƒ½åŠ›",rarity:"rare",power:6,cooldown:1},{name:"å±æ©Ÿç®¡ç†",description:"ãƒªã‚¹ã‚¯ã‚’äºˆæ¸¬ã—å¯¾å‡¦ã™ã‚‹",rarity:"epic",power:9,cooldown:3},{name:"ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³",description:"é©æ–°çš„ãªå¤‰åŒ–ã‚’èµ·ã“ã™",rarity:"legendary",power:12,cooldown:4}],fulfillment:[{name:"äººç”Ÿã®çŸ¥æµ",description:"çµŒé¨“ã‹ã‚‰å¾—ãŸæ·±ã„æ´å¯Ÿ",rarity:"epic",power:10,cooldown:2},{name:"ãƒ¬ã‚¬ã‚·ãƒ¼æ§‹ç¯‰",description:"æ¬¡ä¸–ä»£ã¸ã®ä¾¡å€¤ã‚ã‚‹éºç”£",rarity:"legendary",power:15,cooldown:5},{name:"ç²¾ç¥çš„å¹³å’Œ",description:"å†…ãªã‚‹èª¿å’Œã¨å®‰å®š",rarity:"legendary",power:13,cooldown:3}]},a=t[e]||t.youth;return this.createCardsFromDefinitions(a,e=>o.createSkillCard(e.name,e.rarity,e.power,e.cooldown))}static createComboCards(){return this.createCardsFromDefinitions([{name:"ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹",power:2,requiredCards:["career","family"],comboBonus:4,description:"ã‚­ãƒ£ãƒªã‚¢ã¨å®¶æ—ã®èª¿å’Œ"},{name:"å¥åº·çš„ãªæˆåŠŸ",power:3,requiredCards:["health","finance"],comboBonus:5,description:"å¥åº·ã¨çµŒæ¸ˆçš„å®‰å®šã®ä¸¡ç«‹"},{name:"å……å®Ÿã—ãŸäººç”Ÿ",power:4,requiredCards:["hobby","family","career"],comboBonus:8,description:"è¶£å‘³ãƒ»å®¶æ—ãƒ»ã‚­ãƒ£ãƒªã‚¢ã®ä¸‰ä½ä¸€ä½“"}],e=>o.createComboCard(e.name,e.power,e.requiredCards,e.comboBonus))}static createEventCards(e="youth"){const t={youth:[{name:"æ–°å¹´ã®æŠ±è² ",description:"æ–°ã—ã„å¹´ã¸ã®æ±ºæ„",power:5,duration:3,globalEffect:!1},{name:"å°±è·ãƒ–ãƒ¼ãƒ ",description:"é›‡ç”¨æ©Ÿä¼šã®å¢—åŠ ",power:4,duration:2,globalEffect:!0},{name:"å¥åº·ãƒ–ãƒ¼ãƒ ",description:"å¥åº·ã¸ã®æ„è­˜å‘ä¸Š",power:3,duration:4,globalEffect:!0}],middle:[{name:"çµŒæ¸ˆæˆé•·æœŸ",description:"ç¤¾ä¼šå…¨ä½“ã®æ´»æ³",power:6,duration:3,globalEffect:!0},{name:"å®¶æ—ã®çµ†",description:"å®¶æ—é–¢ä¿‚ã®æ·±åŒ–",power:7,duration:2,globalEffect:!1},{name:"æŠ€è¡“é©æ–°",description:"ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®é€²æ­©",power:8,duration:4,globalEffect:!0}],fulfillment:[{name:"äººç”Ÿã®ç·æ±ºç®—",description:"çµŒé¨“ã®çµ±åˆã¨æˆç†Ÿ",power:10,duration:2,globalEffect:!1},{name:"ä¸–ä»£äº¤ä»£",description:"æ¬¡ä¸–ä»£ã¸ã®ç¶™æ‰¿",power:9,duration:3,globalEffect:!0}]},a=t[e]||t.youth;return this.createCardsFromDefinitions(a,e=>o.createEventCard(e.name,e.power,e.duration,e.globalEffect))}static createLegendaryCards(){return this.createCardsFromDefinitions([{name:"äººç”Ÿã®é”äºº",power:20,unlockCondition:"å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã§50å›ä»¥ä¸ŠæˆåŠŸ",description:"äººç”ŸçµŒé¨“ã®é›†å¤§æˆ"},{name:"é‹å‘½ã‚’å¤‰ãˆã‚‹æ±ºæ–­",power:25,unlockCondition:"é€£ç¶š10å›ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸ",description:"äººç”Ÿã‚’åŠ‡çš„ã«å¤‰ãˆã‚‹ç¬é–“"},{name:"å®Œç’§ãªèª¿å’Œ",power:30,unlockCondition:"å…¨ã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’50æšä»¥ä¸Šç²å¾—",description:"ã™ã¹ã¦ã®å´é¢ãŒå®Œç’§ã«ãƒãƒ©ãƒ³ã‚¹ã—ãŸçŠ¶æ…‹"}],e=>o.createLegendaryCard(e.name,e.power,e.unlockCondition))}static createRewardCards(e,t){return[...this.createSkillCards(e)].sort(()=>Math.random()-.5).slice(0,t)}}const h=class e{constructor(){t(this,"hand",[]),t(this,"discardPile",[]),t(this,"playerDeck",new a("Player Deck")),t(this,"challengeDeck",new a("Challenge Deck")),t(this,"selectedCards",[]),t(this,"cardChoices"),t(this,"config"),t(this,"agingDeck",new a("Aging Deck")),t(this,"insuranceMarket",[]),t(this,"activeInsurances",[]),t(this,"selectedIdsSet",new Set),t(this,"_cachedState"),t(this,"_stateVersion",0)}initialize(e,t,r){this.playerDeck=e,this.challengeDeck=t,this.hand=[],this.discardPile=[],this.selectedCards=[],this.selectedIdsSet.clear(),this.cardChoices=void 0,this.config=r,this.agingDeck=new a("Aging Deck"),this.insuranceMarket=[],this.activeInsurances=[]}getState(){if(this._cachedState&&this._stateVersion>0)return this._cachedState;console.log("[CardManager] getState rebuilding cache. Hand size:",this.hand.length);const e={hand:[...this.hand],discardPile:[...this.discardPile],playerDeck:this.playerDeck.clone(),challengeDeck:this.challengeDeck.clone(),selectedCards:[...this.selectedCards],cardChoices:this.cardChoices?[...this.cardChoices]:void 0,agingDeck:this.agingDeck.clone(),insuranceMarket:[...this.insuranceMarket],activeInsurances:[...this.activeInsurances]};return this._cachedState=e,this._stateVersion++,e}setState(e){this.hand=[...e.hand],this.discardPile=[...e.discardPile],this.playerDeck=e.playerDeck.clone(),this.challengeDeck=e.challengeDeck.clone(),this.selectedCards=[...e.selectedCards],this.cardChoices=e.cardChoices?[...e.cardChoices]:void 0,this.agingDeck=e.agingDeck.clone(),this.insuranceMarket=[...e.insuranceMarket],this.activeInsurances=[...e.activeInsurances],this.invalidateCache(),this.selectedIdsSet.clear(),this.selectedCards.forEach(e=>this.selectedIdsSet.add(e.id))}invalidateCache(){this._cachedState=void 0,this._stateVersion=0}drawCards(t){if(!this.config)throw new Error("CardManager not initialized");let a=e.CARD_POOLS.drawResults.pop();a?(a.drawnCards.length=0,a.discardedCards.length=0,a.troubleCards.length=0):a={drawnCards:[],discardedCards:[],troubleCards:[]};for(let e=0;e<t;e++){this.playerDeck.isEmpty()&&this.discardPile.length>0&&this.reshuffleDeck();const e=this.playerDeck.drawCard();e?"trouble"===e.type?(a.troubleCards.push(e),this.discardPile.push(e),console.log("[CardManager] Drawn Trouble card:",e.name)):(a.drawnCards.push(e),this.hand.push(e),console.log("[CardManager] Added card to hand. Hand size:",this.hand.length,"Card:",e.name)):console.warn("[CardManager] Failed to draw card (deck empty?)")}const r=this.enforceHandLimit();return a.discardedCards.push(...r),console.log("[CardManager] drawCards finished. Final hand size:",this.hand.length),this.invalidateCache(),a}toggleCardSelection(e){const t=e.id;if(this.selectedIdsSet.has(t)){this.selectedIdsSet.delete(t);const e=this.selectedCards.findIndex(e=>e.id===t);return-1!==e&&this.selectedCards.splice(e,1),this.invalidateCache(),!1}return this.selectedIdsSet.add(t),this.selectedCards.push(e),this.invalidateCache(),!0}clearSelection(){this.selectedCards.length=0,this.selectedIdsSet.clear(),this.invalidateCache()}discardSelectedCards(){const e=[];return this.selectedCards.forEach(t=>{const a=this.hand.findIndex(e=>e.id===t.id);if(-1!==a){const t=this.hand.splice(a,1)[0];t&&(this.discardPile.push(t),e.push(t))}}),this.selectedCards=[],e}addToHand(e){this.hand.push(e),this.invalidateCache()}addToDiscardPile(e){this.discardPile.push(e),this.invalidateCache()}addToPlayerDeck(e){this.playerDeck.addCard(e),this.invalidateCache()}enforceHandLimit(){if(!this.config)return[];const e=[];for(;this.hand.length>this.config.maxHandSize;){const t=this.hand.shift();t&&(this.discardPile.push(t),e.push(t))}return e}setCardChoices(e){this.cardChoices=[...e],this.invalidateCache()}clearCardChoices(){this.cardChoices=void 0,this.invalidateCache()}getCardChoiceById(e){return this.cardChoices?.find(t=>t.id===e)}reshuffleDeck(){this.playerDeck.addCards(this.discardPile),this.playerDeck.shuffle(),this.discardPile=[],this.addAgingCardToDiscard()}buyInsurance(e){const t=this.insuranceMarket.findIndex(t=>t.id===e.id);-1!==t&&(this.insuranceMarket.splice(t,1),this.activeInsurances.push(e),this.invalidateCache())}removeCardFromGame(e){let t=this.hand.findIndex(t=>t.id===e.id);return-1!==t?(this.hand.splice(t,1),void this.invalidateCache()):(t=this.discardPile.findIndex(t=>t.id===e.id),-1!==t?(this.discardPile.splice(t,1),void this.invalidateCache()):void(this.playerDeck.removeCard(e.id)&&this.invalidateCache()))}addAgingCardToDiscard(){const e=this.agingDeck.drawCard();e?(this.discardPile.push(e),console.log("[CardManager] Aging card added to discard pile due to reshuffle")):console.warn("[CardManager] No aging cards left! (Game Over Condition usually)")}getInsuranceMarket(){return this.insuranceMarket}getActiveInsurances(){return this.activeInsurances}drawChallengeCard(){const e=this.challengeDeck.drawCard();return e&&this.invalidateCache(),e}refillChallengeDeck(e){this.challengeDeck.clear(),this.challengeDeck.addCards(e),this.challengeDeck.shuffle(),this.invalidateCache()}getChallengeDeckSize(){return this.challengeDeck.getCards().length}discardHand(){const e=[...this.hand];return this.discardPile.push(...e),this.hand=[],this.invalidateCache(),e}};t(h,"CARD_POOLS",{drawResults:[]});let d=h;class g{constructor(e,t){this.value=e,this.factorType=t}static create(e,t){if(e<0||e>1)throw new Error(`Risk factor value must be between 0 and 1, got ${e}`);return new g(e,t)}getValue(){return this.value}getType(){return this.factorType}getRiskLevel(){return this.value<=.3?"low":this.value<=.7?"medium":"high"}getPremiumMultiplier(){const e={age:.5,health:.3,claims:.4,lifestyle:.2}[this.factorType]||.3;return 1+this.value*e}adjust(e){const t=Math.max(0,Math.min(1,this.value+e));return new g(t,this.factorType)}combine(e,t=.5){if(this.factorType!==e.factorType)throw new Error("Cannot combine different risk factor types");const a=this.value*(1-t)+e.value*t;return new g(a,this.factorType)}equals(e){return this.value===e.value&&this.factorType===e.factorType}toString(){return`RiskFactor(${this.factorType}: ${this.value.toFixed(2)} - ${this.getRiskLevel()})`}}class p{constructor(e){this.factors=e}static empty(){return new p(new Map)}static default(){const e=new Map;return e.set("age",g.create(.3,"age")),e.set("health",g.create(.2,"health")),e.set("claims",g.create(0,"claims")),e.set("lifestyle",g.create(.3,"lifestyle")),new p(e)}withFactor(e){const t=new Map(this.factors);return t.set(e.getType(),e),new p(t)}getFactor(e){return this.factors.get(e)}getOverallRiskScore(){if(0===this.factors.size)return 0;let e=0;return this.factors.forEach(t=>{e+=t.getValue()}),e/this.factors.size}getTotalPremiumMultiplier(){if(0===this.factors.size)return 1;let e=1;return this.factors.forEach(t=>{e*=t.getPremiumMultiplier()}),e}getSummary(){const e=this.getOverallRiskScore();return`${e<=.3?"ä½ãƒªã‚¹ã‚¯":e<=.7?"ä¸­ãƒªã‚¹ã‚¯":"é«˜ãƒªã‚¹ã‚¯"} (ã‚¹ã‚³ã‚¢: ${e.toFixed(2)})`}}const m=class e{calculateAgeAdjustedPremium(t,a){const r=e.AGE_MULTIPLIERS[a]||1;return t.applyMultiplier(r)}calculateComprehensivePremium(e,t,a){if("insurance"!==e.type)throw new Error("Card must be an insurance card");const r=e.getCost(),s=this.calculateAgeAdjustedPremium(r,t),i=this.applyInsuranceTypeAdjustment(s,e.insuranceType),n=this.applyCoverageAdjustment(i,e.coverage);if(a){const t=this.calculateRiskAdjustment(a,e.insuranceType);return n.applyMultiplier(t)}return n}calculateTotalInsuranceBurden(e,t,a){const r=e.filter(e=>e&&"insurance"===e.type).map(e=>this.calculateComprehensivePremium(e,t,a)),s=n.sum(r),i=this.calculateMultiInsurancePenalty(e.length);return s.applyMultiplier(i)}calculateRenewalPremium(e,t,a){const r=this.calculateComprehensivePremium(e,t),s=this.calculateContinuityDiscount(a),i=r.applyDiscount(s),n=this.calculateRiskMultiplier(a);return i.applyMultiplier(n)}calculateOptimalInsuranceBudget(e,t,a="balanced"){const r={conservative:.15,balanced:.25,aggressive:.35}[a],s=Math.floor(e*r);return n.create(s)}applyInsuranceTypeAdjustment(t,a){if(!a)return t;const r=e.INSURANCE_TYPE_RATES[a]||1;return t.applyMultiplier(r)}applyCoverageAdjustment(e,t){if(!t||t<=0)return e.applyMultiplier(.5);const a=.5+t/400;return e.applyMultiplier(a)}calculateMultiInsurancePenalty(e){const t=Math.floor(e/5);return 1+Math.min(.1*t,.3)}calculateContinuityDiscount(e){return 0===e?.1:e<=2?.05:0}calculateRiskMultiplier(e){return e>=5?1.3:e>=3?1.1:1}calculateRiskAdjustment(e,t){let a=e.getTotalPremiumMultiplier();if(t){const r={health:"health",life:"age",disability:"health",accident:"lifestyle",cancer:"health"}[t];if(r){const t=e.getFactor(r);t&&(a=.8*a+.2*t.getPremiumMultiplier())}}return a}generateRiskProfile(e,t){let a=p.default();const r=this.calculateAgeRisk(t);a=a.withFactor(g.create(r,"age"));const s=this.calculateHealthRisk(e);a=a.withFactor(g.create(s,"health"));const i=this.calculateClaimsRisk(e);a=a.withFactor(g.create(i,"claims"));const n=this.calculateLifestyleRisk(e);return a=a.withFactor(g.create(n,"lifestyle")),a}calculateRiskAdjustedPremium(e,t,a){const r=this.calculateComprehensivePremium(e,t);if(!a)return r;const s=this.calculateRiskAdjustment(a,e.insuranceType);return r.applyMultiplier(s)}calculateAgeRisk(e){return{youth:.2,middle:.5,fulfillment:.6}[e]||.5}calculateHealthRisk(e){const t=(e.totalDamageTaken||0)/(e.turnsPlayed||1);return t>=3?.8:t>=2?.6:t>=1?.4:.2}calculateClaimsRisk(e){const t=(e.insuranceClaimCount||0)/(e.totalInsurancePurchased||1);return t>=.5?.9:t>=.3?.6:t>=.1?.3:.1}calculateLifestyleRisk(e){const t=(e.riskyChoiceCount||0)/(e.totalChoiceCount||1);return t>=.6?.8:t>=.4?.5:t>=.2?.3:.1}};t(m,"AGE_MULTIPLIERS",{youth:1,middle:1.2,fulfillment:1.3}),t(m,"INSURANCE_TYPE_RATES",{health:1,medical:1,life:1.2,income:1,asset:.5,disability:.8,accident:.6,cancer:1.5,dental:.4,travel:.3});let y=m;const f={STAGE_PARAMETERS:{youth:{label:"é’å¹´æœŸ",maxVitality:60,startTurn:0,endTurn:6,insuranceMultiplier:1,challengeDifficultyModifier:1},middle:{label:"ä¸­å¹´æœŸ",maxVitality:60,startTurn:7,endTurn:13,insuranceMultiplier:1.2,challengeDifficultyModifier:1.5},fulfillment:{label:"å……å®ŸæœŸ",maxVitality:50,startTurn:14,endTurn:1/0,insuranceMultiplier:1.5,challengeDifficultyModifier:2}}},C={AGE_ADJUSTMENTS:{physical:-2,intellectual:1,mixed:-1}},w={TYPE_RATES:{medical:1,life:1.2,income:1,asset:.5,disability:.8,accident:.6,cancer:1.5,dental:.4,travel:.3}},v={CARD_LIMITS:{maxHandSize:10,startingHandSize:5,defaultDrawCount:1,maxDeckSize:100},CHALLENGE_SETTINGS:{minDifficulty:1,maxDifficulty:20,successBonusBase:6,failurePenaltyRatio:1,enableDynamicDifficulty:!0},VITALITY_SETTINGS:{defaultStarting:80,minimumValue:0,maximumValue:150,healingCap:.85},PROGRESSION_SETTINGS:{maxTurns:20,stageTransitionTurns:{youthToMiddle:7,middleToFulfillment:14},victoryConditions:{minTurns:15,minVitality:50}}},S={CACHE_SETTINGS:{stateSnapshotTTL:50,calculationCacheTTL:100,maxCacheEntries:100},OBJECT_POOL_LIMITS:{maxPoolSize:10,initialPoolSize:3},PROCESSING_LIMITS:{maxCardsPerSelection:20,maxInsuranceCards:30,maxHistoryEntries:1e3}};class T{static setOverrides(e){this.overrides=e}static clearOverrides(){this.overrides=void 0}static getStageParameters(e){const t=f.STAGE_PARAMETERS[e]||f.STAGE_PARAMETERS.youth;return this.overrides?.stageParameters?.[e]?{...t,...this.overrides.stageParameters[e]}:t}static getDreamAgeAdjustment(e){return C.AGE_ADJUSTMENTS[e]??0}static getInsuranceTypeRate(e){return w.TYPE_RATES[e]??1}static getBalanceSettings(){const e=v;return this.overrides?{...e,CARD_LIMITS:{...e.CARD_LIMITS,...this.overrides.cardLimits},CHALLENGE_SETTINGS:{...e.CHALLENGE_SETTINGS,...this.overrides.challengeSettings},VITALITY_SETTINGS:{...e.VITALITY_SETTINGS,...this.overrides.vitalitySettings},PROGRESSION_SETTINGS:{...e.PROGRESSION_SETTINGS,...this.overrides.progressionSettings}}:e}static getPerformanceSettings(){return S}}t(T,"overrides");class I{checkStageProgression(e,t){const a=e;let r=e;const s=T.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;t>=s.youthToMiddle&&"youth"===e?r="middle":t>=s.middleToFulfillment&&"middle"===e&&(r="fulfillment");const i=a!==r,n=i?`ğŸ¯ ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰åŒ–ã—ã¾ã—ãŸ: ${a} â†’ ${r} (ã‚¿ãƒ¼ãƒ³${t})`:void 0,c=this.getUpcomingTransitionMessage(e,t),o={newStage:r,hasChanged:i};return n&&(o.transitionMessage=n),c&&(o.upcomingTransition=c),o}getUpcomingTransitionMessage(e,t){const a=T.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;if("youth"===e){const e=a.youthToMiddle-t;if(e<=2&&e>0)return`â° ä¸­å¹´æœŸã¾ã§ã‚ã¨${e}ã‚¿ãƒ¼ãƒ³ (ä½“åŠ›ä¸Šé™ãŒ${this.getStageVitalityLimit("middle")}ã«æ¸›å°‘)`}else if("middle"===e){const e=a.middleToFulfillment-t;if(e<=2&&e>0)return`â° å……å®ŸæœŸã¾ã§ã‚ã¨${e}ã‚¿ãƒ¼ãƒ³ (ä½“åŠ›ä¸Šé™ãŒ${this.getStageVitalityLimit("fulfillment")}ã«æ¸›å°‘)`}}getStageVitalityLimit(e){const t=T.getStageParameters(e);return t?t.maxVitality:60}static getStageTransitionInfo(){const e=T.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;return{youthToMiddle:e.youthToMiddle,middleToFulfillment:e.middleToFulfillment,description:`é’å¹´æœŸâ†’ä¸­å¹´æœŸ: ã‚¿ãƒ¼ãƒ³${e.youthToMiddle}, ä¸­å¹´æœŸâ†’å……å®ŸæœŸ: ã‚¿ãƒ¼ãƒ³${e.middleToFulfillment}`}}static getStageDetails(e,t){const a={youth:{stageName:"é’å¹´æœŸ",description:"ä½“åŠ›ã¯å……å®Ÿã—ã¦ã„ã‚‹ãŒçµŒé¨“ä¸è¶³",vitalityLimit:35,characteristics:["é«˜ã„ä½“åŠ›ä¸Šé™","çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–ãªã—","åŸºæœ¬çš„ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå¤šã„"]},middle:{stageName:"ä¸­å¹´æœŸ",description:"ä½“åŠ›ã¯è½ã¡ã‚‹ãŒçµŒé¨“è±Šå¯Œ",vitalityLimit:30,characteristics:["ä¸­ç¨‹åº¦ã®ä½“åŠ›ä¸Šé™","çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–é–‹å§‹","è¤‡é›‘ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸å¢—åŠ "]},fulfillment:{stageName:"å……å®ŸæœŸ",description:"ä½“åŠ›ã¯é™ã‚‰ã‚Œã‚‹ãŒçŸ¥æµã¨ä½™è£•",vitalityLimit:27,characteristics:["ä½ã„ä½“åŠ›ä¸Šé™","é«˜ã„çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–","çŸ¥è­˜ç³»ãƒãƒ£ãƒ¬ãƒ³ã‚¸æœ‰åˆ©"]}}[e],r=T.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;let s;if("youth"===e){const e=r.youthToMiddle-t;e>0&&(s={targetStage:"ä¸­å¹´æœŸ",atTurn:r.youthToMiddle,turnsRemaining:e})}else if("middle"===e){const e=r.middleToFulfillment-t;e>0&&(s={targetStage:"å……å®ŸæœŸ",atTurn:r.middleToFulfillment,turnsRemaining:e})}const i={...a};return s&&(i.nextTransition=s),i}advanceStage(e){switch(e){case"youth":return{newStage:"middle",isCompleted:!1};case"middle":return{newStage:"fulfillment",isCompleted:!1};default:return{newStage:null,isCompleted:!0}}}isFinalStage(e){return"fulfillment"===e}}const E=class e{updateInsuranceExpirations(e,t,a){const r=[];if(e.forEach(e=>{e.isTermInsurance()&&(e.decrementTurn(),e.isExpired()&&r.push(e))}),r.length>0)return r.forEach(t=>{const a=e.findIndex(e=>e.id===t.id);-1!==a&&e.splice(a,1)}),t.push(...r),this.createExpirationNotice(r,a)}getExpiringSoonInsurances(t){return t.filter(t=>t.isTermInsurance()&&void 0!==t.remainingTurns&&t.remainingTurns<=e.EXPIRING_SOON_THRESHOLD&&t.remainingTurns>0)}getExpirationWarnings(e){return this.getExpiringSoonInsurances(e).map(e=>`âš ï¸ ã€Œ${e.name}ã€ã®æœŸé™ã¾ã§ã‚ã¨${e.remainingTurns}ã‚¿ãƒ¼ãƒ³ã§ã™`)}createExpirationNotice(e,t){const a=e.map(e=>e.name).join("ã€");return{expiredCards:e,message:1===e.length?`å®šæœŸä¿é™ºã€Œ${a}ã€ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚`:`å®šæœŸä¿é™º${e.length}ä»¶ï¼ˆ${a}ï¼‰ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚`,showRenewalOption:!0,turnNumber:t}}};t(E,"EXPIRING_SOON_THRESHOLD",2);let M=E;const _=[{id:"solid",name:"å …å®Ÿå®¶",description:"å®ˆã‚Šé‡è¦–ã€‚åˆæœŸæ´»åŠ›ãŒé«˜ãã€ä¿é™ºã®åŠ¹æœãŒé«˜ã„ã€‚",initialVitalityModifier:20,specialAbility:"insurance_bonus"},{id:"adventurer",name:"å†’é™ºå®¶",description:"ãƒªã‚¹ã‚¯å¿—å‘ã€‚åˆæœŸæ´»åŠ›ã¯ä½ã„ãŒã€ãƒãƒ£ãƒ³ã‚¹ã«å¼·ã„ã€‚",initialVitalityModifier:-5,specialAbility:"risk_taker"},{id:"minimalist",name:"ãƒŸãƒ‹ãƒãƒªã‚¹ãƒˆ",description:"åŠ¹ç‡é‡è¦–ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç”Ÿæ´»ã‚¹ã‚¿ã‚¤ãƒ«ã€‚",initialVitalityModifier:10,specialAbility:"efficiency"}],P={youth:{maxVitality:100,label:"é’å¹´æœŸ",ageMultiplier:0},middle:{maxVitality:80,label:"ä¸­å¹´æœŸ",ageMultiplier:.5},middle_age:{maxVitality:80,label:"ä¸­å¹´æœŸ",ageMultiplier:.5},fulfillment:{maxVitality:60,label:"å……å®ŸæœŸ",ageMultiplier:1}},b={physical:3,intellectual:-2,mixed:0};class x{resolveChallenge(e,t,a,r,s,i){const n=e instanceof l,c=n&&e.insuranceImmunity,o=i&&!c?this.calculateInsuranceBonus(i,e):0,u=this.calculateTotalPower(t,s,o),h=u.total,d=this.getDreamRequiredPower(e,r),g=h>=d;let p=0;if(g){const t=h-d,a=T.getBalanceSettings().CHALLENGE_SETTINGS.successBonusBase+Math.floor(t/2);p=n?e.calculateActualReward(a):a}else{const t=e.penalty??Math.ceil(.3*d),a=i&&!c?this.calculateDamageReduction(i):0,r=Math.max(1,t-a);p=n?-e.calculateActualPenalty(r):-r,isFinite(p)||(console.error("Invalid vitalityChange:",{vitalityChange:p,baseDamage:t,damageReduction:a,actualDamage:r,challengePower:d,playerPower:h}),p=-r)}a.discardSelectedCards();const m=g?"success":"damage_taken",y=g?void 0:Math.abs(p);let f;f=g?`ğŸ‰ ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ +${p} æ´»åŠ›`:`ğŸ’¥ ${y} ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ`;const C={challenge:e,success:g,resultType:m,playerPower:h,challengePower:d,vitalityChange:p,message:f,powerBreakdown:u};return g||void 0===y||(C.damageAmount=y),C}calculateTotalPower(e,t,a=0){let r=0,s=0;e.forEach(e=>{"insurance"===e.type?s+=e.calculateEffectivePower():r+=e.calculateEffectivePower()}),s+=a;const i=r+s-t;return{base:r,insurance:s,burden:-t,total:Math.max(0,i)}}getDreamRequiredPower(e,t){if(!e.isDreamCard()||!e.dreamCategory)return e.power;if("youth"===t)return e.power;const a="middle"===t?.5:1,r=Math.round(e.power+a);return Math.max(1,r)}calculateInsuranceBonus(e,t){let a=0;const r=e.getActiveInsurances(),s=e.stage,i=P[s]||P.youth,n=i?.ageMultiplier??0;return r.forEach(e=>{let r=0;if(e.isSpecializedInsurance()){const a=t.name;r=e.calculateChallengeBonus(a)}e.isWholeLifeInsurance()&&n>0&&(r+=n),a+=r}),a}calculateDamageReduction(e){let t=0;return e.getActiveInsurances().forEach(e=>{t+=e.calculateDamageReduction()}),Math.min(t,100)}}class k{constructor(e,t){this.stageManager=e,this.expirationManager=t}nextTurn(e){if(this.validateGameState(e),e.cardManager.discardHand(),e.turn++,e.stats.turnsPlayed++,e.phase="draw",this.checkStageProgression(e),this.checkVictoryCondition(e),"victory"===e.status)return{newExpiredCount:0,remainingInsuranceCount:e.getActiveInsurances().length};const t=this.updateInsuranceExpirations(e),a=e.insuranceBurden;if(a>0)if(e.vitality>a)try{e.applyDamage(a),console.log(`ğŸ’¸ ä¿é™ºæ–™æ”¯æ‰•ã„: -${a} æ´»åŠ›`)}catch(s){console.error("ä¿é™ºæ–™æ”¯æ‰•ã„ã«å¤±æ•—ã—ã¾ã—ãŸ",s)}else console.warn(`âš ï¸ ä¿é™ºæ–™(${a})ã‚’æ”¯æ‰•ã†æ´»åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å…¨ã¦ã®ä¿é™ºãŒå¤±åŠ¹ã—ã¾ã™ã€‚`),e.expireAllInsurances();if("game_over"===e.status)return{newExpiredCount:t?.expiredCards.length||0,remainingInsuranceCount:e.getActiveInsurances().length};const r=e.config.startingHandSize||5;return e.drawCards(r),this.applyRecoveryInsuranceEffects(e),{...t?{insuranceExpirations:t}:{},newExpiredCount:t?.expiredCards.length||0,remainingInsuranceCount:e.getActiveInsurances().length}}checkVictoryCondition(e){const t=e.config.balanceConfig?.progressionSettings||{maxTurns:20,victoryConditions:{minVitality:50}},a=t.maxTurns??50,r=t.victoryConditions?.minVitality??50;e.turn>=a&&e.vitality>=r?(e.status="victory",e.completedAt=new Date,console.log(`ğŸ‰ å‹åˆ©ï¼ ã‚¿ãƒ¼ãƒ³${e.turn}ã§æ´»åŠ›${e.vitality}ã‚’ç¶­æŒã—ã¦ã‚¯ãƒªã‚¢ï¼`)):"fulfillment"===e.stage&&e.turn>=40&&e.vitality>=r&&(e.status="victory",e.completedAt=new Date,console.log(`ğŸ‰ å……å®ŸæœŸã‚¯ãƒªã‚¢ï¼ ã‚¿ãƒ¼ãƒ³${e.turn}ã§æ´»åŠ›${e.vitality}ã‚’ç¶­æŒï¼`))}validateGameState(e){if("in_progress"!==e.status)throw new Error("Game is not in progress")}checkStageProgression(e){const t=this.stageManager.checkStageProgression(e.stage,e.turn);t.hasChanged&&(e.setStage(t.newStage),t.transitionMessage&&console.log(t.transitionMessage))}updateInsuranceExpirations(e){const t=this.expirationManager.updateInsuranceExpirations(e.activeInsurances,e.expiredInsurances,e.turn);return t&&e.updateInsuranceBurden(),t}applyRecoveryInsuranceEffects(e){const t=e.getActiveInsurances();let a=0;t.forEach(e=>{e.isRecoveryInsurance()&&(a+=e.calculateTurnHeal())}),a>0&&(e.heal(a),console.log(`ğŸ’š å›å¾©å‹ä¿é™ºåŠ¹æœ: +${a} æ´»åŠ›`))}}class D{constructor(e){this.resolutionService=e}startChallenge(e,t){if(this.validatePhase(e,"draw"),e.currentChallenge=t,e.cardManager.clearSelection(),e.phase="challenge",e.getLearningHistory(t.name)>=2){const a=Math.max(1,t.power-1),r=t.copy({power:a});e.currentChallenge=r}}resolveChallenge(e){try{this.validateChallenge(e);const t=this.resolutionService.resolveChallenge(e.currentChallenge,e.selectedCards,e.cardManager,e.stage,e.insuranceBurden,e);if(this.updateStatistics(e,t.success),this.updateVitality(e,t.vitalityChange),!t.success&&e.currentChallenge){const t=e.currentChallenge.name,a=e.getLearningHistory(t);e.updateLearningHistory(t,a+1)}if(t.success){const a=u.createInsuranceTypeChoices(e.stage);if(e.insuranceTypeChoices=a,console.log("[GameChallengeService] Generated insurance choices:",e.insuranceTypeChoices?.length),e.insuranceTypeChoices&&0!==e.insuranceTypeChoices.length||console.warn("[GameChallengeService] WARNING: No insurance choices generated!"),t.insuranceTypeChoices=a,"card"===e.currentChallenge?.rewardType){const a=u.createRewardCards(e.stage,3);t.cardChoices=a,console.log("[GameChallengeService] Generated reward card choices:",t.cardChoices.length)}}return this.updateGameStateAfterChallenge(e,t),t}catch(t){return console.error("[GameChallengeService] Fatal error resolving challenge:",t),{challenge:e.currentChallenge||u.createCard({base:{name:"Error",type:"life",description:"System Error"},variant:"default"}),success:!1,playerPower:0,challengePower:0,vitalityChange:0,message:`ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${t instanceof Error?t.message:String(t)}`,resultType:"error"}}}calculateTotalPower(e,t){let a=0,r=0;for(const i of t)"insurance"===i.type?r+=i.calculateEffectivePower():a+=i.calculateEffectivePower();const s=e.insuranceBurden;return{base:a,insurance:r,burden:s,total:Math.max(0,a+r+s)}}validatePhase(e,t){if(("challenge_choice"!==e.phase||"draw"!==t)&&e.phase!==t){if("draw"===t)throw new Error(`Can only start challenge during draw or challenge_choice phase (Current: ${e.phase})`);throw new Error(`Can only perform this action during ${t} phase (Current: ${e.phase})`)}}validateChallenge(e){if(!e.currentChallenge||"challenge"!==e.phase)throw new Error("No active challenge to resolve")}updateStatistics(e,t){e.stats.totalChallenges++,t?(e.stats.successfulChallenges++,e.stats.challengesCompleted||(e.stats.challengesCompleted=0),e.stats.challengesCompleted++):(e.stats.failedChallenges++,e.stats.challengesFailed||(e.stats.challengesFailed=0),e.stats.challengesFailed++)}updateVitality(e,t){if(t>=0)e.heal(t);else{const a=-t;if(a>=10){const t=e.activeInsurances.find(e=>"on_heavy_damage"===e.insuranceTriggerType);if(t&&(e.triggerInsuranceClaim(t,"on_heavy_damage"),e.pendingInsuranceClaim))return void(e.pendingInsuranceClaim.context={damage:a})}e.applyDamage(a)}}updateGameStateAfterChallenge(e,t){e.cardManager.discardSelectedCards(),e.phase=t.success?"insurance_type_selection":"resolution",e.currentChallenge=void 0,e.cardManager.clearSelection()}}class A{constructor(e){this.premiumService=e}addInsurance(e,t){if(!t.isInsurance())throw new Error("Only insurance cards can be added");e.activeInsurances.push(t),this.updateInsuranceBurden(e)}removeInsurance(e,t){const a=e.activeInsurances.findIndex(e=>e.id===t.id);-1!==a&&e.activeInsurances.splice(a,1),e.cardManager.removeCardFromGame(t),this.updateInsuranceBurden(e)}selectInsuranceType(e,t,a){this.validateInsuranceSelection(e);const r=this.findInsuranceChoice(e,t);if(!r)return{success:!1,message:"Invalid insurance type selection"};const s=this.createInsuranceCard(r,a);return this.addInsuranceCard(e,s),this.updatePlayerHistory(e,t),this.updateRiskProfile(e),this.completeInsuranceSelection(e),this.createSelectionResult(s,r,a)}calculateInsuranceBurden(e){if(0===e.activeInsurances.length)return 0;try{return-this.premiumService.calculateTotalInsuranceBurden(e.activeInsurances,e.stage,e.getRiskProfile()).getValue()}catch(t){return console.warn("ä¿é™ºæ–™è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:",t),this.fallbackBurdenCalculation(e)}}updateInsuranceBurden(e){const t=this.calculateInsuranceBurden(e),a=Math.abs(t);e._insuranceBurden=n.create(a),e._dirtyFlags&&(e._dirtyFlags.insurance=!0,e._dirtyFlags.burden=!0)}getRecommendedInsuranceBudget(e,t,a="balanced"){return this.premiumService.calculateOptimalInsuranceBudget(e,t,a)}getExpiringSoonInsurances(e){return e.filter(e=>!(!e.isTermInsurance()||!e.remainingTurns)&&e.remainingTurns<=2)}validateInsuranceSelection(e){if("insurance_type_selection"!==e.phase)throw new Error("Not in insurance type selection phase");if(!e.insuranceTypeChoices)throw new Error("No insurance type choices available")}findInsuranceChoice(e,t){return e.insuranceTypeChoices?.find(e=>e.insuranceType===t)}createInsuranceCard(e,t){return"term"===t?u.createTermInsuranceCard(e):u.createWholeLifeInsuranceCard(e)}addInsuranceCard(e,t){e.cardManager.addToPlayerDeck(t),e.stats.cardsAcquired++,e.activeInsurances.push(t),this.updateInsuranceBurden(e)}completeInsuranceSelection(e){e.insuranceTypeChoices=void 0,e.phase="resolution"}createSelectionResult(e,t,a){const r="term"===a?`å®šæœŸä¿é™ºï¼ˆ${t.termOption.duration}ã‚¿ãƒ¼ãƒ³ï¼‰`:"çµ‚èº«ä¿é™º";return{success:!0,selectedCard:e,message:`${t.name}ï¼ˆ${r}ï¼‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚ã‚³ã‚¹ãƒˆ: ${e.cost}`}}fallbackBurdenCalculation(e){const t=e.activeInsurances.length,a=Math.floor(t/3);return 0===a?0:-a}updatePlayerHistory(e,t){const a=e.getPlayerHistory();a.totalInsurancePurchased++,"life"!==t&&"cancer"!==t||a.riskyChoiceCount++,a.totalChoiceCount++,e._playerHistory=a}updateRiskProfile(e){const t=this.premiumService.generateRiskProfile(e.getPlayerHistory(),e.stage);e._riskProfile=t}}class R{getName(){return"ä¿å®ˆçš„æˆ¦ç•¥"}getType(){return"conservative"}selectChallenge(e,t){const a=[...e].sort((e,t)=>e.power-t.power)[0],r=this.estimateCurrentPower(t);return{challenge:a,reason:"æœ€ã‚‚å®‰å…¨ã§æˆåŠŸç¢ºç‡ã®é«˜ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ",successProbability:Math.min(1,r/a.power)}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=t.filter(e=>"insurance"===e.type).sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower()),c=t.filter(e=>"insurance"!==e.type).sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower());for(const o of n){if(i>=1.2*r)break;s.push(o),i+=o.calculateEffectivePower()}for(const o of c){if(i>=1.2*r)break;s.push(o),i+=o.calculateEffectivePower()}return{cards:s,reason:"ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã€ååˆ†ãªä½™è£•ã‚’æŒã£ãŸå®‰å…¨ãªé¸æŠã‚’è¡Œã„ã¾ã—ãŸ",expectedPower:i}}evaluateFitness(e){return 1-e.vitality/e.maxVitality}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}}class ${getName(){return"æ”»æ’ƒçš„æˆ¦ç•¥"}getType(){return"aggressive"}selectChallenge(e,t){const a=this.estimateCurrentPower(t),r=e.filter(e=>a>=.5*e.power).sort((e,t)=>t.power-e.power)[0]||e[0];return{challenge:r,reason:"é«˜ã„å ±é…¬ã‚’ç‹™ã£ã¦ã€å¯èƒ½ãªé™ã‚Šå›°é›£ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ",successProbability:Math.min(1,a/r.power)}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=[...t].sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower());for(const c of n){if(i>=r)break;s.push(c),i+=c.calculateEffectivePower()}return{cards:s,reason:"æœ€é«˜ãƒ‘ãƒ¯ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’å„ªå…ˆã—ã€å¿…è¦æœ€å°é™ã®ã‚³ã‚¹ãƒˆã§å‹åˆ©ã‚’ç‹™ã„ã¾ã—ãŸ",expectedPower:i}}evaluateFitness(e){return(e.vitality/e.maxVitality+this.estimateHandStrength(e))/2}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}estimateHandStrength(e){const t=e.cardManager.playerDeck.getCards();if(0===t.length)return 0;const a=t.reduce((e,t)=>e+t.calculateEffectivePower(),0)/t.length;return Math.min(1,a/3)}}class V{getName(){return"ãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥"}getType(){return"balanced"}selectChallenge(e,t){const a=this.estimateCurrentPower(t),r=e.map(e=>{const t=Math.min(1,a/e.power);return{challenge:e,successProbability:t,score:this.calculateRiskRewardScore(e,t)}}).sort((e,t)=>t.score-e.score)[0];return{challenge:r.challenge,reason:"ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã¦æœ€é©ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ",successProbability:r.successProbability}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=t.map(e=>({card:e,efficiency:this.calculateCardEfficiency(e,a)})).sort((e,t)=>t.efficiency-e.efficiency);for(const{card:c}of n){if(i>=1.1*r)break;s.push(c),i+=c.calculateEffectivePower()}return{cards:s,reason:"ã‚«ãƒ¼ãƒ‰åŠ¹ç‡ã¨ãƒªã‚¹ã‚¯ç®¡ç†ã‚’ä¸¡ç«‹ã—ãŸæœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’é¸æŠã—ã¾ã—ãŸ",expectedPower:i}}evaluateFitness(e){return.6}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}calculateRiskRewardScore(e,t){return t*(.5*e.power)-(1-t)*(.3*e.power)}calculateCardEfficiency(e,t){const a=e.calculateEffectivePower(),r=this.estimateCardCost(e);return a/Math.max(1,r)}estimateCardCost(e){return"insurance"===e.type?e.calculateEffectivePower()+1:1}}class B{constructor(){t(this,"strategies"),this.strategies=[new R,new $,new V]}getName(){return"é©å¿œæˆ¦ç•¥"}getType(){return"adaptive"}selectChallenge(e,t){const a=this.selectBestStrategy(t),r=a.selectChallenge(e,t);return{...r,reason:`ç¾åœ¨ã®çŠ¶æ³ã‚’åˆ†æã—ã€${a.getName()}ã‚’æ¡ç”¨: ${r.reason}`}}selectCards(e,t,a){const r=this.selectBestStrategy(a),s=r.selectCards(e,t,a);return{...s,reason:`${r.getName()}ã«ã‚ˆã‚‹åˆ¤æ–­: ${s.reason}`}}evaluateFitness(e){return Math.max(...this.strategies.map(t=>t.evaluateFitness(e)))}selectBestStrategy(e){return this.strategies.map(t=>({strategy:t,fitness:t.evaluateFitness(e)})).sort((e,t)=>t.fitness-e.fitness)[0].strategy}}class G{static createStrategy(e){const t=this.strategies.get(e);if(!t)throw new Error(`Unknown strategy type: ${e}`);return t()}static getAvailableTypes(){return Array.from(this.strategies.keys())}static getStrategyDescription(e){switch(e){case"conservative":return"ãƒªã‚¹ã‚¯ã‚’é¿ã‘ã€å®‰å…¨ãªé¸æŠã‚’å„ªå…ˆã™ã‚‹æˆ¦ç•¥ã€‚æ´»åŠ›ãŒä½ã„æ™‚ã«é©ã—ã¦ã„ã‚‹ã€‚";case"aggressive":return"é«˜ãƒªã‚¹ã‚¯é«˜ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†æˆ¦ç•¥ã€‚æ´»åŠ›ã¨æ‰‹æœ­ãŒå……å®Ÿã—ã¦ã„ã‚‹æ™‚ã«åŠ¹æœçš„ã€‚";case"balanced":return"ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã™ã‚‹ä¸‡èƒ½æˆ¦ç•¥ã€‚å®‰å®šã—ãŸåˆ¤æ–­ã‚’è¡Œã†ã€‚";case"adaptive":return"çŠ¶æ³ã«å¿œã˜ã¦æœ€é©ãªæˆ¦ç•¥ã‚’è‡ªå‹•é¸æŠã™ã‚‹é«˜åº¦ãªæˆ¦ç•¥ã€‚çµŒé¨“è±Šå¯Œãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‘ã‘ã€‚";default:return"ä¸æ˜ãªæˆ¦ç•¥ã‚¿ã‚¤ãƒ—ã§ã™ã€‚"}}}t(G,"strategies",new Map([["conservative",()=>new R],["aggressive",()=>new $],["balanced",()=>new V],["adaptive",()=>new B]]));class O{constructor(e="balanced"){t(this,"currentStrategy"),t(this,"statisticsEnabled",!0),t(this,"decisionHistory",[]),this.currentStrategy=G.createStrategy(e)}getCurrentStrategy(){return this.currentStrategy}setStrategy(e){this.currentStrategy=G.createStrategy(e)}autoSelectChallenge(e,t){const a=this.currentStrategy.selectChallenge(e,t);return this.statisticsEnabled&&(console.log(`AIæˆ¦ç•¥ (${this.currentStrategy.getName()}): ${a.reason}`),console.log(`é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${a.challenge.name} (æˆåŠŸç¢ºç‡: ${(100*a.successProbability).toFixed(1)}%)`)),a}autoSelectCards(e,t,a){const r=this.currentStrategy.selectCards(e,t,a);return this.statisticsEnabled&&(console.log(`AIæˆ¦ç•¥ (${this.currentStrategy.getName()}): ${r.reason}`),console.log(`é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰: ${r.cards.map(e=>e.name).join(", ")} (æœŸå¾…ãƒ‘ãƒ¯ãƒ¼: ${r.expectedPower})`)),r}recordDecision(e,t,a,r){this.statisticsEnabled&&(this.decisionHistory.push({turn:e,strategy:this.currentStrategy.getName(),challengeChoice:t,cardChoice:a,result:r?"success":"failure"}),this.decisionHistory.length>100&&(this.decisionHistory=this.decisionHistory.slice(-100)))}getStatistics(){const e=this.decisionHistory.length;if(0===e)return{totalDecisions:0,successRate:0,strategyUsage:new Map};const t=this.decisionHistory.filter(e=>"success"===e.result).length,a=new Map;return this.decisionHistory.forEach(e=>{const t=a.get(e.strategy)||0;a.set(e.strategy,t+1)}),{totalDecisions:e,successRate:t/e,strategyUsage:a}}setStatisticsEnabled(e){this.statisticsEnabled=e}clearHistory(){this.decisionHistory=[]}}class L{constructor(){t(this,"listeners",new Map),t(this,"history",{events:[],maxEvents:50})}addEventListener(e,t){const a=this.listeners.get(e)||[];return a.push(t),this.listeners.set(e,a),()=>{const a=this.listeners.get(e)||[],r=a.indexOf(t);r>-1&&a.splice(r,1)}}notifyStateChange(e,t,a){const r={type:e,previousValue:t,newValue:a,timestamp:Date.now()};this.addToHistory(r),(this.listeners.get(e)||[]).forEach(e=>{try{e(r)}catch(t){console.error("GameStateManager: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",t)}})}notifyPhaseChange(e,t){this.notifyStateChange("phase_change",e,t)}notifyStatusChange(e,t){this.notifyStateChange("status_change",e,t)}notifyStageChange(e,t){this.notifyStateChange("stage_change",e,t)}notifyTurnChange(e,t){this.notifyStateChange("turn_change",e,t)}getHistory(){return{...this.history}}getHistoryByType(e){return this.history.events.filter(t=>t.type===e)}clearHistory(){this.history.events=[]}addToHistory(e){this.history.events.push(e),this.history.events.length>this.history.maxEvents&&this.history.events.shift()}removeAllListeners(){this.listeners.clear()}removeListenersForType(e){this.listeners.delete(e)}}class F{async execute(e,t){try{const a=await this.validate(e,t);if(!a.success)return a;const r=await this.process(e,t);return await this.postProcess(e,r),r}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}async validate(e,t){return{success:!0}}async postProcess(e,t){}}class N extends F{async validate(e,t){return t<=0?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼æšæ•°ã¯1ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"}:t>10?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼æšæ•°ã¯10æšä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"}:{success:!0}}async process(e,t){const a=e.cardManager.drawCards(t),r=[{type:"card_draw",description:`${a.drawnCards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼ã—ã¾ã—ãŸ`,cards:a.drawnCards}];if(a.troubleCards&&a.troubleCards.length>0)for(const i of a.troubleCards){const t=i.penalty||0;if(t>0)try{e.applyDamage(t),r.push({type:"vitality_change",description:`ãƒˆãƒ©ãƒ–ãƒ«ã€Œ${i.name}ã€ç™ºå‹•ï¼ ${t}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸`,value:-t,cards:[i]})}catch(s){console.error("Failed to apply trouble penalty",s)}else r.push({type:"vitality_change",description:`ãƒˆãƒ©ãƒ–ãƒ«ã€Œ${i.name}ã€ç™ºå‹•ï¼`,cards:[i]})}return{success:!0,data:a.drawnCards,effects:r}}}class H extends F{async validate(e,t){return"draw"!==e.phase?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹ã§ãã¾ã™"}:"challenge"!==t.type?{success:!1,error:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ä»¥å¤–ã¯é¸æŠã§ãã¾ã›ã‚“"}:{success:!0}}async process(e,t){return e.startChallenge(t),{success:!0,effects:[{type:"stage_advance",description:`ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€Œ${t.name}ã€ã‚’é–‹å§‹ã—ã¾ã—ãŸ`}]}}}class U extends F{async validate(e,t){return"draw"!==e.phase?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã‚’é–‹å§‹ã§ãã¾ã™"}:{success:!0}}async process(e,t){return e.startChallengePhase(),{success:!0,effects:[{type:"stage_advance",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã‚’é–‹å§‹ã—ã¾ã—ãŸ"}]}}}class z extends F{async validate(e,t){return e.currentChallenge?0===e.selectedCards.length?{success:!1,error:"ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"}:{success:!0}:{success:!1,error:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“"}}async process(e,t){const a=e.resolveChallenge(),r=[];return a.success?r.push({type:"vitality_change",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æˆåŠŸã—ã¾ã—ãŸ",value:a.vitalityChange}):r.push({type:"vitality_change",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸ",value:a.vitalityChange}),{success:!0,data:a,effects:r}}}class W extends F{async validate(e,t){return t.insuranceType?["term","whole_life"].includes(t.durationType)?{success:!0}:{success:!1,error:"ç„¡åŠ¹ãªä¿é™ºæœŸé–“ã‚¿ã‚¤ãƒ—ã§ã™"}:{success:!1,error:"ä¿é™ºç¨®é¡ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"}}async process(e,t){return{success:!0,data:e.selectInsuranceType(t.insuranceType,t.durationType),effects:[{type:"insurance_add",description:`${"term"===t.durationType?"å®šæœŸ":"çµ‚èº«"}${t.insuranceType}ä¿é™ºã‚’è¿½åŠ ã—ã¾ã—ãŸ`}]}}}class j extends F{async validate(e,t){return{success:!0}}async process(e,t){if(e.cardManager.buyInsurance(t),t.cost>0)try{e.applyDamage(t.cost)}catch(a){return{success:!1,error:"Cost payment failed"}}return{success:!0,effects:[{type:"insurance_add",description:`ä¿é™ºã€Œ${t.name}ã€ã‚’è³¼å…¥ã—ã¾ã—ãŸ`,cards:[t]}]}}}class q extends F{async validate(e,t){return{success:!0}}async process(e,t){return e.cardManager.removeCardFromGame(t),{success:!0,effects:[{type:"card_draw",description:`ã‚«ãƒ¼ãƒ‰ã€Œ${t.name}ã€ã‚’é™¤å¤–ã—ã¾ã—ãŸ`,cards:[t]}]}}}class X extends F{async validate(e,t){return"dream_selection"!==e.phase?{success:!1,error:"å¤¢é¸æŠãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã‚ã‚Šã¾ã›ã‚“"}:{success:!0}}async process(e,t){try{return e.selectDream(t),{success:!0,effects:[{type:"stage_advance",description:`å¤¢ã€Œ${t.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`}]}}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}}class J{constructor(){t(this,"processors",new Map),this.registerProcessor("draw_cards",new N),this.registerProcessor("start_challenge",new H),this.registerProcessor("resolve_challenge",new z),this.registerProcessor("select_insurance",new W),this.registerProcessor("start_challenge_phase",new U),this.registerProcessor("buy_insurance",new j),this.registerProcessor("remove_card",new q),this.registerProcessor("select_dream",new X)}registerProcessor(e,t){this.processors.set(e,t)}async executeAction(e,t,a){console.log("[GameActionProcessor] executeAction called",e);const r=this.processors.get(e);if(!r)return console.error("[GameActionProcessor] Unknown action type:",e),{success:!1,error:`æœªçŸ¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—: ${e}`};const s=await r.execute(t,a);return console.log("[GameActionProcessor] execution result:",s),s}getAvailableActions(){return Array.from(this.processors.keys())}unregisterProcessor(e){return this.processors.delete(e)}}const Y=class e{constructor(t,a=e.DEFAULT_MAX_VITALITY){this.value=t,this.maxVitality=a,this.validate()}static create(t,a=e.DEFAULT_MAX_VITALITY){return new e(t,a)}validate(){if(!isFinite(this.value))throw new Error("Vitality value must be a finite number");if(!isFinite(this.maxVitality))throw new Error("Maximum vitality must be a finite number");if(this.maxVitality<=0)throw new Error("Maximum vitality must be positive");if(this.value<0)throw new Error("Vitality value cannot be negative");if(this.value>this.maxVitality)throw new Error(`Vitality value cannot exceed maximum (${this.maxVitality})`)}getValue(){return this.value}getMax(){return this.maxVitality}decrease(t){if("number"!=typeof t||!isFinite(t))throw new Error("Decrease amount must be a finite number");if(t<0)throw new Error("Decrease amount must be non-negative");return new e(Math.max(0,this.value-t),this.maxVitality)}increase(t){if("number"!=typeof t||!isFinite(t))throw new Error("Increase amount must be a finite number");if(t<0)throw new Error("Increase amount must be non-negative");return new e(Math.min(this.maxVitality,this.value+t),this.maxVitality)}getPercentage(){return Math.floor(this.value/this.maxVitality*100)}isDepleted(){return 0===this.value}isFull(){return this.value===this.maxVitality}withMaxVitality(t){if("number"!=typeof t||!isFinite(t))throw new Error("Maximum vitality must be a finite number");const a=Math.min(this.value,t);return new e(a,t)}equals(e){return this.value===e.value&&this.maxVitality===e.maxVitality}toString(){return`${this.value}/${this.maxVitality} (${this.getPercentage()}%)`}};t(Y,"DEFAULT_MAX_VITALITY",100);let Z=Y;const K=class e{constructor(e){t(this,"id"),t(this,"status"),t(this,"phase"),t(this,"stage"),t(this,"turn"),t(this,"_vitality"),t(this,"cardManager"),t(this,"premiumCalculationService"),t(this,"stageManager"),t(this,"expirationManager"),t(this,"challengeResolutionService"),t(this,"turnManager"),t(this,"challengeService"),t(this,"insuranceService"),t(this,"aiStrategyService"),t(this,"stateManager"),t(this,"actionProcessor"),t(this,"currentChallenge"),t(this,"stats"),t(this,"config"),t(this,"_riskProfile"),t(this,"_playerHistory"),t(this,"activeInsurances",[]),t(this,"expiredInsurances",[]),t(this,"_insuranceBurden"),t(this,"agingDeck"),t(this,"score",0),t(this,"insuranceMarket",[]),t(this,"selectedDream"),t(this,"insuranceTypeChoices"),t(this,"pendingInsuranceClaim"),t(this,"_learningHistory",new Map),t(this,"_aiEnabled",!1),t(this,"_currentAIStrategy","balanced"),t(this,"_dirtyFlags",{vitality:!1,insurance:!1,burden:!1,stats:!1,gameState:!1}),t(this,"_cachedValues",{insuranceBurden:0,availableVitality:0,totalInsuranceCount:0,lastUpdateTime:0}),t(this,"startedAt"),t(this,"completedAt"),this.id=this.generateId(),this.status="not_started",this.phase="setup",this.stage="youth",this.turn=0;const r={difficulty:"normal",startingVitality:100,startingHandSize:5,maxHandSize:10,dreamCardCount:3,...e};this.config=r,this.config.balanceConfig&&T.setOverrides(this.config.balanceConfig);const s=r.characterId||"solid",i=_.find(e=>e.id===s)||_[0];if(!i)throw new Error("No available characters found");const c=(r.startingVitality??100)+i.initialVitalityModifier,o=T.getStageParameters(this.stage);if(!o)throw new Error(`Invalid stage parameters for ${this.stage}`);const l=o.maxVitality+i.initialVitalityModifier,h=c>l&&c>200?c:Math.min(c,l),g=Math.max(h,l);this._vitality=Z.create(h,g),this.cardManager=new d,this.premiumCalculationService=new y,this.stageManager=new I,this.expirationManager=new M,this.challengeResolutionService=new x,this.turnManager=new k(this.stageManager,this.expirationManager),this.challengeService=new D(this.challengeResolutionService),this.insuranceService=new A(this.premiumCalculationService),this.aiStrategyService=new O(this._currentAIStrategy),this.stateManager=new L,this.actionProcessor=new J,this.config.balanceConfig?T.setOverrides(this.config.balanceConfig):T.clearOverrides(),this.setupStateListeners();const m=new a("Player Deck"),f=new a("Challenge Deck");u.createStarterLifeCards().forEach(e=>{m.addCard(e)}),u.createChallengeCards(this.stage).forEach(e=>{f.addCard(e)}),this.cardManager.initialize(m,f,this.config),this.stats={totalChallenges:0,successfulChallenges:0,failedChallenges:0,cardsAcquired:0,highestVitality:h,turnsPlayed:0},this._riskProfile=p.default(),this._playerHistory={turnsPlayed:0,totalDamageTaken:0,insuranceClaimCount:0,totalInsurancePurchased:0,riskyChoiceCount:0,totalChoiceCount:0},this.activeInsurances=[],this.expiredInsurances=[],this.insuranceMarket=[],this.agingDeck=new a("Aging Deck");const C=u.createAgingCards(20);this.cardManager.getState().agingDeck.addCards(C),this.cardManager.getState().agingDeck.shuffle(),this.score=0,this._insuranceBurden=n.create(0)}getLearningHistory(e){return this._learningHistory.get(e)||0}updateLearningHistory(e,t){this._learningHistory.set(e,t)}get vitality(){return this._vitality.getValue()}get maxVitality(){return this._vitality.getMax()}get insuranceBurden(){return this._insuranceBurden.getValue()}get challengesCompleted(){return this.stats.challengesCompleted||0}getVitality(){return this._vitality}getInsuranceBurden(){return this._insuranceBurden}applyDamage(e){if(null==e)throw new Error("Change amount must not be null or undefined");if("number"!=typeof e)throw new Error("Change amount must be a number");if(!isFinite(e))throw new Error("Change amount must be a finite number");this.updateVitality(-e)}heal(e){if("game_over"!==this.status){if(null==e)throw new Error("Change amount must not be null or undefined");if("number"!=typeof e)throw new Error("Change amount must be a number");if(!isFinite(e))throw new Error("Change amount must be a finite number");this.updateVitality(e)}else console.warn("[Game] Cannot heal: Game is over")}getRiskProfile(){return this._riskProfile}getPlayerHistory(){return{...this._playerHistory}}getAvailableVitality(){const e=Date.now();if(!this._dirtyFlags.vitality&&!this._dirtyFlags.burden&&e-this._cachedValues.lastUpdateTime<50)return this._cachedValues.availableVitality;const t=this.vitality-this.insuranceBurden;return this._cachedValues.availableVitality=t,this._cachedValues.lastUpdateTime=e,this._dirtyFlags.vitality=!1,this._dirtyFlags.burden=!1,t}getFreedomScore(){const e=this.insuranceBurden,t=.2*this.maxVitality;if(0===e)return 1;const a=1-e/t;return Math.max(0,Math.min(1,a))}isGameOver(){return"game_over"===this.status||this._vitality.isDepleted()||this.hasAgingCardGameOver()}hasAgingCardGameOver(){return this.hand.filter(e=>"aging"===e.type).length>=3}checkAgingCardGameOverCondition(){if(this.hasAgingCardGameOver()){console.log("[Game] Aging Card Game Over Condition Met!");const e=this.activeInsurances.find(e=>"on_aging_gameover"===e.insuranceTriggerType);return e?(console.log("[Game] Disability Insurance found! Triggering claim."),this.triggerInsuranceClaim(e,"on_aging_gameover"),!0):(console.log("[Game] No insurance found. Game Over."),this.changeStatus("game_over"),!0)}return!1}getAgingCardCount(){return this.hand.filter(e=>"aging"===e.type).length}addInsurance(e){this.insuranceService.addInsurance(this,e)}expireAllInsurances(){0!==this.activeInsurances.length&&(this.activeInsurances.forEach(e=>this.expiredInsurances.push(e)),this.activeInsurances=[],this.updateInsuranceBurden(),console.log("[Game] All insurances expired due to insufficient vitality"))}generateId(){return c.generateGameId()}start(){if("not_started"!==this.status)throw new Error("Game has already started");this.changeStatus("in_progress"),this.startedAt=new Date,this.changePhase("character_selection"),console.info("[Game Phase] Character Selection Started")}selectCharacter(e){if("character_selection"!==this.phase)throw new Error("Not in character selection phase");const t=_.find(t=>t.id===e);if(!t)throw new Error("Invalid character selection");this.config.characterId=e;const a=T.getStageParameters(this.stage),r=this.config.startingVitality+t.initialVitalityModifier,s=a.maxVitality+t.initialVitalityModifier,i=Math.max(r,s);this._vitality=Z.create(Math.min(r,i),i),console.log(`[Game] Character switched to ${t.name}. Vitality: ${this.vitality}/${this.maxVitality}`),this.startDreamSelectionPhase()}startDreamSelectionPhase(){const e=u.createDreamCards().sort(()=>Math.random()-.5).slice(0,3);this.cardManager.setCardChoices(e),this.changePhase("dream_selection"),console.info("[Game Phase] Dream Selection Started")}async selectDream(e){if("dream_selection"!==this.phase)throw new Error("Not in dream selection phase");const t=this.cardManager.getState().cardChoices;if(!t?.some(t=>t.id===e.id))throw new Error("Invalid dream selection");this.selectedDream=e,console.info(`[Game Event] Selected Dream: ${e.name}`),this.cardManager.clearCardChoices(),this.changePhase("draw"),this.changeTurn(1);const a=T.getBalanceSettings().CARD_LIMITS.startingHandSize;await this.drawCards(a)}async drawCards(e){console.debug("[Game] drawCards called",e);const t=await this.actionProcessor.executeAction("draw_cards",this,e);if(console.debug("[Game] actionProcessor result:",t),!t.success)throw console.error("[Game] drawCards failed:",t.error),new Error(t.error||"ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");return this.checkAgingCardGameOverCondition(),t.data||[]}startChallengePhase(){if("draw"!==this.phase)throw new Error("Can only start challenge phase from draw phase");const e=[];let t=this.cardManager.drawChallengeCard();t||(this.refillChallengeDeck(),t=this.cardManager.drawChallengeCard()),t&&e.push(t);let a=this.cardManager.drawChallengeCard();if(a||(0===this.challengeDeck.getCards().length&&this.refillChallengeDeck(),a=this.cardManager.drawChallengeCard()),a&&e.push(a),0===e.length)throw new Error("No challenge cards available");this.cardManager.setCardChoices(e),this.changePhase("challenge_choice"),console.debug(`[Game] Challenge choices set: ${e.map(e=>e.name).join(", ")}`)}startChallenge(e){if("challenge_choice"===this.phase){const t=this.cardManager.getState().cardChoices;if(!t||!t.some(t=>t.id===e.id))throw new Error("Selected card is not in current choices");t.forEach(t=>{t.id!==e.id&&this.cardManager.addToDiscardPile(t)}),this.cardManager.clearCardChoices()}this.challengeService.startChallenge(this,e)}drawChallengeCard(){return this.cardManager.drawChallengeCard()}toggleCardSelection(e){return this.cardManager.toggleCardSelection(e)}resolveChallenge(){return this.challengeService.resolveChallenge(this)}recordChallengeResult(e){this.stats.totalChallenges++,e?(this.stats.successfulChallenges++,this.stats.challengesCompleted||(this.stats.challengesCompleted=0),this.stats.challengesCompleted++):(this.stats.failedChallenges++,this.stats.challengesFailed||(this.stats.challengesFailed=0),this.stats.challengesFailed++)}selectCard(e){if("card_selection"!==this.phase)throw new Error("Not in card selection phase");const t=this.cardManager.getCardChoiceById(e);if(!t)throw new Error("Invalid card selection");return this.cardManager.addToPlayerDeck(t),this.stats.cardsAcquired++,"insurance"===t.type&&(this.activeInsurances.push(t),this.updateInsuranceBurden()),this.cardManager.clearCardChoices(),this.changePhase("resolution"),!0}selectInsuranceType(e,t){return this.insuranceService.selectInsuranceType(this,e,t)}skipInsuranceSelection(){console.log("[Game] Skipping insurance selection - proceeding without insurance"),this.insuranceTypeChoices=void 0,this.changePhase("resolution")}triggerInsuranceClaim(e,t){console.log(`[Game] Insurance Triggered: ${e.name} (${t})`),this.pendingInsuranceClaim={insurance:e,triggerType:t}}async resolveInsuranceClaim(){if(!this.pendingInsuranceClaim)return;const{insurance:e,triggerType:t}=this.pendingInsuranceClaim;console.log(`[Game] Resolving Insurance Claim: ${e.name}`),this.removeInsurance(e),this.expiredInsurances=this.expiredInsurances||[],this.expiredInsurances.push(e),await this.applyInsuranceEffect(t),this.pendingInsuranceClaim=void 0}async applyInsuranceEffect(e){switch(e){case"on_aging_gameover":console.log("[Game] Applying Disability Insurance Effect: Reset Hand"),this.cardManager.discardHand(),await this.drawCards(this.config.startingHandSize);break;case"on_death":console.log("[Game] Applying Life Insurance Effect: Revive"),this.heal(10);break;case"on_heavy_damage":console.log("[Game] Applying Medical Insurance Effect: Damage Reduction"),this.applyDamage(1);break;case"on_demand":console.log("[Game] Applying Income Protection Effect: Skip Challenge"),this.currentChallenge=void 0,this.cardManager.clearSelection(),this.changePhase("resolution")}}declineInsuranceClaim(){console.log("[Game] Insurance Claim Declined");const e=this.pendingInsuranceClaim?.triggerType,t=this.pendingInsuranceClaim?.context;"on_heavy_damage"===e&&t?.damage&&(console.log("[Game] Applying original damage after decline"),this.applyDamage(t.damage)),this.pendingInsuranceClaim=void 0,"on_death"===e?this._vitality.isDepleted()&&(console.log("[Game] Life Insurance declined. Game Over confirmed."),this.changeStatus("game_over")):"on_aging_gameover"===e&&this.hasAgingCardGameOver()&&(console.log("[Game] Disability Insurance declined. Game Over confirmed."),this.changeStatus("game_over"))}removeInsurance(e){this.insuranceService.removeInsurance(this,e)}updateVitality(e){if("number"!=typeof e||!isFinite(e))throw new Error("Change amount must be a finite number");if(0===e)return;if(e<0&&Math.abs(e)>=10){const t=this.activeInsurances.find(e=>"on_heavy_damage"===e.insuranceTriggerType);if(t&&(this.triggerInsuranceClaim(t,"on_heavy_damage"),this.pendingInsuranceClaim))return void(this.pendingInsuranceClaim.context={damage:Math.abs(e)})}this._vitality=e>=0?this._vitality.increase(e):this._vitality.decrease(-e);const t=this.vitality;if((t<0||t>this.maxVitality)&&(console.warn(`Vitality invariant violation: ${t} not in [0, ${this.maxVitality}]`),t>this.maxVitality?this._vitality=this._vitality.withMaxVitality(this.maxVitality):t<0&&(this._vitality=Z.create(0,this.maxVitality))),this._dirtyFlags.vitality=!0,this._dirtyFlags.stats=!0,t>this.stats.highestVitality&&(this.stats.highestVitality=t),e<0&&(this._playerHistory.totalDamageTaken+=Math.abs(e)),this._vitality.isDepleted()){console.error("[DEBUG] Vitality Depleted!"),console.error(`[DEBUG] Active Insurances: ${this.activeInsurances.length}`),this.activeInsurances.forEach((e,t)=>console.error(`[DEBUG] Ins[${t}]: id=${e.id}, trigger=${e.insuranceTriggerType}`));const e=this.activeInsurances.find(e=>"on_death"===e.insuranceTriggerType);if(e)return console.error(`[DEBUG] FOUND Life Insurance: ${e.id}`),void this.triggerInsuranceClaim(e,"on_death");console.error("[DEBUG] NOT FOUND Life Insurance"),this.changeStatus("game_over")}if("game_over"===this.status&&!this._vitality.isDepleted())throw new Error("Game over state inconsistency: vitality not depleted")}updateMaxVitalityForAge(){const e=T.getStageParameters(this.stage);if(!e)return void console.warn(`Unknown stage parameters for: ${this.stage}`);const t=e.maxVitality,a=this._vitality.getValue();a>t?(console.info(`[Stage] ${e.label}: Max Vitality adjusted to ${t}`),this._vitality=this._vitality.withMaxVitality(t)):this._vitality=Z.create(a,t),this._dirtyFlags.vitality=!0}nextTurn(){return this.updateScore(),this.turnManager.nextTurn(this)}advanceStage(){const e=this.stageManager.advanceStage(this.stage);e.isCompleted?this.changeStatus("victory"):e.newStage&&this.changeStage(e.newStage)}refillChallengeDeck(){const e=u.createChallengeCards(this.stage);this.cardManager.refillChallengeDeck(e),console.debug(`[Game] Challenge deck refilled for stage ${this.stage}: ${e.length} cards`)}get hand(){return this.cardManager.getState().hand}get availableOnDemandInsurances(){return this.activeInsurances.filter(e=>"on_demand"===e.insuranceTriggerType)}get discardPile(){return this.cardManager.getState().discardPile}get playerDeck(){return this.cardManager.getState().playerDeck}get challengeDeck(){return this.cardManager.getState().challengeDeck}get selectedCards(){return this.cardManager.getState().selectedCards}get cardChoices(){return this.cardManager.getState().cardChoices}get currentInsuranceTypeChoices(){return this.insuranceTypeChoices}isInProgress(){return"in_progress"===this.status}isCompleted(){return"game_over"===this.status||"victory"===this.status}getDreamRequiredPower(e){if(!e.isDreamCard()||!e.dreamCategory)return e.power;if("youth"===this.stage)return e.power;const t=b[e.dreamCategory],a=e.power+t;return Math.max(1,a)}getExpiredInsurances(){return[...this.expiredInsurances]}clearExpiredInsurances(){this.expiredInsurances=[]}getExpiringsSoonInsurances(){return this.expirationManager.getExpiringSoonInsurances(this.activeInsurances)}getExpirationWarnings(){return this.expirationManager.getExpirationWarnings(this.activeInsurances)}setStage(e){this.changeStage(e)}getActiveInsurances(){return[...this.activeInsurances]}updateScore(){let e=0;this.activeInsurances.forEach(t=>{t.coverage&&(e+=Math.floor(t.coverage/10))}),this.score=this.vitality+e}getRecommendedInsuranceBudget(e="balanced"){return this.premiumCalculationService.calculateOptimalInsuranceBudget(this.vitality,this.stage,e)}calculateCardPremium(e){if("insurance"!==e.type)throw new Error("Card must be an insurance card");return this.premiumCalculationService.calculateComprehensivePremium(e,this.stage,this._riskProfile)}calculateInsuranceBurden(){const e=Date.now();if(!this._dirtyFlags.insurance&&e-this._cachedValues.lastUpdateTime<100&&this._cachedValues.totalInsuranceCount===this.activeInsurances.length)return this._cachedValues.insuranceBurden;const t=this.insuranceService.calculateInsuranceBurden(this);return this._cachedValues.insuranceBurden=t,this._cachedValues.totalInsuranceCount=this.activeInsurances.length,this._cachedValues.lastUpdateTime=e,this._dirtyFlags.insurance=!1,t}updateInsuranceBurden(){this.insuranceService.updateInsuranceBurden(this)}calculateTotalPower(e){return this.challengeService.calculateTotalPower(this,e)}addCardToHand(e){this.cardManager.addToHand(e)}addCardToDiscardPile(e){this.cardManager.addToDiscardPile(e)}addCardToPlayerDeck(e){this.cardManager.addToPlayerDeck(e)}clearHand(){const e=this.cardManager.getState();e.hand=[],this.cardManager.setState(e)}setHand(e){const t=this.cardManager.getState();t.hand=[...e],this.cardManager.setState(t)}setCardChoices(e){this.cardManager.setCardChoices(e)}setPhase(e){this.changePhase(e)}getSnapshot(){const t=this.cardManager.getState();let a=e.OBJECT_POOLS.gameStates.pop();return a||(a={}),Object.assign(a,{id:this.id,status:this.status,phase:this.phase,stage:this.stage,turn:this.turn,vitality:this.vitality,maxVitality:this.maxVitality,playerDeck:this.playerDeck,hand:[...this.hand],discardPile:[...this.discardPile],challengeDeck:this.challengeDeck,currentChallenge:this.currentChallenge,selectedCards:[...t.selectedCards],cardChoices:t.cardChoices?[...t.cardChoices]:void 0,insuranceTypeChoices:this.insuranceTypeChoices,activeInsurances:[...this.activeInsurances],expiredInsurances:[...this.expiredInsurances],insuranceBurden:this.insuranceBurden,stats:{...this.stats},config:{...this.config},startedAt:this.startedAt,completedAt:this.completedAt}),a}setupStateListeners(){this.stateManager.addEventListener("phase_change",e=>{console.info(`[Phase] ${e.previousValue} -> ${e.newValue}`),this.handlePhaseChange(e.previousValue,e.newValue)}),this.stateManager.addEventListener("stage_change",e=>{console.info(`[Stage] ${e.previousValue} -> ${e.newValue}`),this.updateMaxVitalityForAge()}),this.stateManager.addEventListener("turn_change",e=>{console.info(`[Turn] ${e.previousValue} -> ${e.newValue}`),this.stats.turnsPlayed=e.newValue}),this.stateManager.addEventListener("status_change",e=>{console.info(`[Status] ${e.previousValue} -> ${e.newValue}`),"game_over"!==e.newValue&&"victory"!==e.newValue||(this.completedAt=new Date)})}handlePhaseChange(e,t){}changePhase(e){const t=this.phase;this.phase=e,this.stateManager.notifyPhaseChange(t,e)}changeStatus(e){const t=this.status;this.status=e,this.stateManager.notifyStatusChange(t,e)}changeStage(e){const t=this.stage;this.stage=e,this.stateManager.notifyStageChange(t,e)}changeTurn(e){const t=this.turn;this.turn=e,this.stateManager.notifyTurnChange(t,e)}getStateManager(){return this.stateManager}getActionProcessor(){return this.actionProcessor}static releaseSnapshot(t){e.OBJECT_POOLS.gameStates.length<10&&(Object.keys(t).forEach(e=>{delete t[e]}),e.OBJECT_POOLS.gameStates.push(t))}getPerformanceStats(){return{poolStats:{gameStates:e.OBJECT_POOLS.gameStates.length,cards:e.OBJECT_POOLS.cards.length,challengeResults:e.OBJECT_POOLS.challengeResults.length},cacheHitRate:this._cachedValues.lastUpdateTime>0?.85:0,dirtyFlags:{...this._dirtyFlags}}}setAIEnabled(e){this._aiEnabled=e,e?console.info(`[AI] System Enabled (Strategy: ${this._currentAIStrategy})`):console.info("[AI] System Disabled")}isAIEnabled(){return this._aiEnabled}setAIStrategy(e){this._currentAIStrategy=e,this.aiStrategyService.setStrategy(e),console.info(`[AI] Strategy Changed: ${e}`)}getCurrentAIStrategy(){return this._currentAIStrategy}getAIStatistics(){return this.aiStrategyService.getStatistics()}aiSelectChallenge(){if(!this._aiEnabled)throw new Error("AI is not enabled");const e=this.cardManager.getState().challengeDeck.getCards();if(0===e.length)return null;const t=this.aiStrategyService.autoSelectChallenge(e,this);return console.debug(`[AI] Auto-selected challenge: ${t.challenge.name} (Success Rate: ${(100*t.successProbability).toFixed(1)}%)`),console.debug(`[AI] Reason: ${t.reason}`),t.challenge}aiSelectCards(e){if(!this._aiEnabled)throw new Error("AI is not enabled");const t=this.cardManager.getState().playerDeck.getCards(),a=this.aiStrategyService.autoSelectCards(e,t,this);return console.debug(`[AI] Auto-selected cards: ${a.cards.map(e=>e.name).join(", ")}`),console.debug(`[AI] Reason: ${a.reason}`),console.debug(`[AI] Expected Power: ${a.expectedPower}`),a.cards}aiAutoPlay(){if(!this._aiEnabled)throw new Error("AI is not enabled");if("draw"!==this.phase)throw new Error("Auto play can only be used during draw phase");const e=this.aiSelectChallenge();if(!e)return console.warn("[AI] No challenges available"),null;this.challengeService.startChallenge(this,e);const t=this.aiSelectCards(e);t.forEach(e=>{this.cardManager.toggleCardSelection(e)});const a=this.challengeService.resolveChallenge(this),r=this.aiStrategyService.autoSelectChallenge([e],this),s=this.aiStrategyService.autoSelectCards(e,t,this);return this.aiStrategyService.recordDecision(this.turn,r,s,a.success),a}resetAISettings(){this._aiEnabled=!1,this._currentAIStrategy="balanced",this.aiStrategyService.setStrategy("balanced"),this.aiStrategyService.clearHistory(),console.info("[AI] Settings Reset")}};t(K,"OBJECT_POOLS",{cards:[],gameStates:[],challengeResults:[]});let Q=K;export{_ as A,Q as G,Z as V};
//# sourceMappingURL=game-logic-DIvFRaPVD7Ei.js.map
