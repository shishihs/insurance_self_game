var G=Object.defineProperty;var F=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable;var N=(u,s,t)=>s in u?G(u,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[s]=t,x=(u,s)=>{for(var t in s||(s={}))H.call(s,t)&&N(u,t,s[t]);if(F)for(var t of F(s))z.call(s,t)&&N(u,t,s[t]);return u};var d=(u,s,t)=>N(u,typeof s!="symbol"?s+"":s,t);var D=(u,s,t)=>new Promise((e,i)=>{var a=r=>{try{o(t.next(r))}catch(l){i(l)}},n=r=>{try{o(t.throw(r))}catch(l){i(l)}},o=r=>r.done?e(r.value):Promise.resolve(r.value).then(a,n);o((t=t.apply(u,s)).next())});import{P as A,p as U}from"./phaser-vendor-khE3opRO.js";import{T as O,G as L,C as v,A as V}from"./game-logic-DNW83sYz.js";const Z={type:A.AUTO,parent:"game-container",backgroundColor:"#f5f5f5",scale:{mode:A.Scale.FIT,autoCenter:A.Scale.CENTER_BOTH,width:1280,height:720,min:{width:640,height:360},max:{width:1920,height:1080}},physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},scene:[]},h={CARD_WIDTH:120,CARD_HEIGHT:180,CARD_HOVER_SCALE:1.1,CARD_SPACING:20,CARD_MOVE_DURATION:200,HAND_Y_POSITION:550,CHALLENGE_Y_POSITION:200,DECK_X_POSITION:100,DECK_Y_POSITION:550,DISCARD_X_POSITION:1180,DISCARD_Y_POSITION:550,INITIAL_DRAW:5,STAGE_TURNS:{youth:10,middle:15,fulfillment:20},VICTORY_VITALITY:30,DRAG_DROP:{SNAP_DISTANCE:100,DRAG_ALPHA:.8,DRAG_SCALE:1.15,DROP_ZONE_SCALE:1.2,SNAP_DURATION:200,BOUNCE_DURATION:400,VIBRATION_DURATION:150,GLOW_PULSE_DURATION:1e3},COLORS:{DROP_ZONE_VALID:5361510,DROP_ZONE_INVALID:16739179,DRAG_SHADOW:0,MAGNETIC_GLOW:65535}};class _ extends U.Scene{constructor(){super(...arguments);d(this,"centerX");d(this,"centerY");d(this,"gameWidth");d(this,"gameHeight")}create(){this.gameWidth=this.cameras.main.width,this.gameHeight=this.cameras.main.height,this.centerX=this.gameWidth/2,this.centerY=this.gameHeight/2,this.initialize()}fadeIn(t=500){this.cameras.main.fadeIn(t,0,0,0)}fadeOut(t=500,e){this.cameras.main.fadeOut(t,0,0,0),e&&this.cameras.main.once("camerafadeoutcomplete",e)}getTextStyle(t=24){return{fontFamily:"Noto Sans JP",fontSize:`${t}px`,color:"#333333"}}createButton(t,e,i,a,n){const o=this.add.text(t,e,i,n||this.getTextStyle()).setOrigin(.5).setInteractive({useHandCursor:!0}).setPadding(20,10).setBackgroundColor("#4C6EF5").setColor("#ffffff");return o.on("pointerover",()=>{o.setBackgroundColor("#364FC7"),o.setScale(1.05)}),o.on("pointerout",()=>{o.setBackgroundColor("#4C6EF5"),o.setScale(1)}),o.on("pointerdown",()=>{o.setScale(.95)}),o.on("pointerup",()=>{o.setScale(1.05),a()}),o}}class $ extends _{constructor(){super({key:"PreloadScene"})}preload(){const s=this.add.graphics(),t=this.add.graphics();t.fillStyle(2236962,.8),t.fillRect(240,270,320,50);const e=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-50,"Loading...",{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"}).setOrigin(.5),i=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-5,"0%",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"}).setOrigin(.5);this.load.on("progress",a=>{i.setText(`${Math.round(a*100)}%`),s.clear(),s.fillStyle(16777215,1),s.fillRect(250,280,300*a,30)}),this.load.on("complete",()=>{s.destroy(),t.destroy(),e.destroy(),i.destroy()}),this.loadAssets()}loadAssets(){this.createCardBack(),this.createCardFaces(),this.createUIAssets()}createCardBack(){const s=this.add.graphics();s.fillStyle(2899536,1),s.fillRoundedRect(0,0,120,180,8),s.lineStyle(2,3426654);for(let t=10;t<110;t+=20)for(let e=10;e<170;e+=20)s.strokeCircle(t,e,8);s.generateTexture("card-back",120,180),s.destroy()}createCardFaces(){this.createCardFace("life-card-template",5009141),this.createCardFace("insurance-card-template",5361510),this.createCardFace("pitfall-card-template",16739179)}createCardFace(s,t){const e=this.add.graphics();e.fillStyle(t,1),e.fillRoundedRect(0,0,120,180,8),e.fillStyle(16777215,1),e.fillRoundedRect(5,5,110,170,6),e.fillStyle(t,1),e.fillRect(5,5,110,30),e.generateTexture(s,120,180),e.destroy()}createUIAssets(){const s=this.add.graphics();s.fillStyle(5009141,1),s.fillRoundedRect(0,0,200,50,25),s.generateTexture("button-bg",200,50),s.destroy();const t=this.add.graphics();t.lineStyle(4,16766011,1),t.strokeRoundedRect(0,0,130,190,8),t.generateTexture("card-highlight",130,190),t.destroy()}initialize(){this.scene.start("MainMenuScene")}}class W extends _{constructor(){super({key:"MainMenuScene"})}initialize(){this.fadeIn(),this.add.text(this.centerX,100,"人生充実ゲーム",{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#333333",fontStyle:"bold"}).setOrigin(.5),this.add.text(this.centerX,160,"Life Fulfillment - 生命保険を「人生の味方」として描く",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#666666"}).setOrigin(.5),this.createMenuButtons(),this.add.text(10,this.gameHeight-30,"v0.0.1 - Phase 1 Development",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#999999"})}createMenuButtons(){this.createButton(this.centerX,300,"ゲームを始める",()=>this.startGame(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"}),this.createButton(this.centerX,380,"チュートリアル",()=>this.startTutorial(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"}),this.createButton(this.centerX,300+80*2,"設定",()=>this.openSettings(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"}),this.createButton(this.centerX,300+80*3,"クレジット",()=>this.showCredits(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"})}startGame(){this.fadeOut(500,()=>{this.scene.start("GameScene")})}startTutorial(){this.fadeOut(500,()=>{this.scene.start("GameScene",{startTutorial:!0})})}openSettings(){this.showNotification("設定機能は開発中です","info")}showCredits(){const s=this.add.graphics();s.fillStyle(0,.8),s.fillRect(0,0,this.gameWidth,this.gameHeight);const t=this.add.container(this.centerX,this.centerY),e=this.add.text(0,-100,`人生充実ゲーム

開発: Claude Code & You

Phase 1 - プロトタイプ開発中

ご期待ください！`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5),i=this.createButton(0,100,"閉じる",()=>{t.destroy(),s.destroy()},{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"});t.add([e,i]),t.setAlpha(0),this.tweens.add({targets:t,alpha:1,duration:300})}}class J extends Phaser.Events.EventEmitter{constructor(t,e={}){super();d(this,"currentConfig",null);d(this,"progress",null);d(this,"state","idle");d(this,"options");d(this,"scene");d(this,"highlightGraphics",null);d(this,"overlayGraphics",null);d(this,"tutorialUI",null);d(this,"stepChangeTimeout",null);d(this,"highlightTween",null);this.scene=t,this.options=x({autoSaveProgress:!0,debugMode:!1,stepChangeDelay:300,defaultHighlightOptions:{color:"#FFD700",opacity:.3,borderWidth:3,borderColor:"#FFA500",glowEffect:!0,animationType:"pulse",duration:1e3},defaultOverlayOptions:{backgroundColor:"#000000",opacity:.7,blurBackground:!1,allowClickThrough:!1}},e),this.setupEventListeners()}setupEventListeners(){this.scene.events.once("destroy",()=>{this.cleanup()}),this.scene.scale.on("resize",()=>{this.state==="running"&&this.updateUILayout()})}startTutorial(t){return D(this,null,function*(){if(this.state==="running"){this.log("Tutorial is already running");return}try{this.currentConfig=t,this.progress=this.loadProgress(t.id)||this.createInitialProgress(),this.state="running",this.log(`Starting tutorial: ${t.name}`),this.emitEvent("tutorial:started",{tutorialId:t.id,progress:this.progress}),this.createOverlay(),yield this.goToStep(this.progress.currentStepIndex)}catch(e){this.handleError("Failed to start tutorial",e)}})}nextStep(){return D(this,null,function*(){if(!(this.state!=="running"||!this.currentConfig||!this.progress||!this.getCurrentStep()))try{yield this.completeCurrentStep(),this.progress.currentStepIndex<this.currentConfig.steps.length-1?yield this.goToStep(this.progress.currentStepIndex+1):yield this.completeTutorial()}catch(e){this.handleError("Failed to go to next step",e)}})}previousStep(){return D(this,null,function*(){this.state!=="running"||!this.progress||this.progress.currentStepIndex>0&&(yield this.goToStep(this.progress.currentStepIndex-1))})}goToStep(t){return D(this,null,function*(){if(!(!this.currentConfig||!this.progress||t<0||t>=this.currentConfig.steps.length))try{this.progress.currentStepIndex!==t&&(yield this.exitCurrentStep()),this.progress.currentStepIndex=t;const e=this.currentConfig.steps[t];if(this.log(`Going to step ${t}: ${e.title}`),e.skipCondition&&e.skipCondition()){yield this.skipCurrentStep();return}yield this.enterStep(e),this.options.autoSaveProgress&&this.saveProgress()}catch(e){this.handleError(`Failed to go to step ${t}`,e)}})}skipTutorial(){return D(this,null,function*(){if(!(this.state!=="running"||!this.currentConfig))try{this.log("Skipping tutorial"),this.state="skipped",this.emitEvent("tutorial:skipped",{tutorialId:this.currentConfig.id,progress:this.progress}),yield this.cleanup()}catch(t){this.handleError("Failed to skip tutorial",t)}})}skipCurrentStep(){return D(this,null,function*(){if(this.state!=="running"||!this.currentConfig||!this.progress)return;const t=this.getCurrentStep();if(t)try{this.log(`Skipping step: ${t.title}`),this.progress.skippedSteps.push(t.id),this.emitEvent("tutorial:step:skipped",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex}),yield this.nextStep()}catch(e){this.handleError("Failed to skip current step",e)}})}highlightElement(t,e={}){try{this.clearHighlight();const i=this.scene.children.getByName(t);if(!i){this.log(`Element not found: ${t}`);return}const a=x(x({},this.options.defaultHighlightOptions),e);this.createHighlight(i,a)}catch(i){this.handleError("Failed to highlight element",i)}}clearHighlight(){this.highlightGraphics&&(this.highlightGraphics.destroy(),this.highlightGraphics=null),this.highlightTween&&(this.highlightTween.destroy(),this.highlightTween=null)}saveProgress(){if(!(!this.currentConfig||!this.progress))try{const t=`${O.PROGRESS}_${this.currentConfig.id}`;localStorage.setItem(t,JSON.stringify(this.progress)),this.log("Progress saved")}catch(t){this.handleError("Failed to save progress",t)}}loadProgress(t){try{const e=`${O.PROGRESS}_${t}`,i=localStorage.getItem(e);if(i){const a=JSON.parse(i);return this.log("Progress loaded"),a}}catch(e){this.handleError("Failed to load progress",e)}return null}clearProgress(t){try{const e=`${O.PROGRESS}_${t}`;localStorage.removeItem(e),this.log("Progress cleared")}catch(e){this.handleError("Failed to clear progress",e)}}isCompleted(t){try{return this.getCompletedTutorials().includes(t)}catch(e){return this.handleError("Failed to check completion status",e),!1}}getState(){return this.state}getCurrentStep(){return!this.currentConfig||!this.progress?null:this.currentConfig.steps[this.progress.currentStepIndex]||null}getProgress(){return this.progress}enterStep(t){return D(this,null,function*(){try{this.log(`Entering step: ${t.title}`),t.onEnter&&t.onEnter(),this.emitEvent("tutorial:step:enter",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex,totalSteps:this.currentConfig.steps.length}),this.updateTutorialUI(t),t.targetElement&&this.highlightElement(t.targetElement,t.highlightOptions),t.action==="auto"&&t.waitTime&&(this.stepChangeTimeout=setTimeout(()=>{this.nextStep()},t.waitTime)),t.action==="wait_for_game_action"&&t.gameAction&&this.startGameActionValidation(t)}catch(e){this.handleError("Failed to enter step",e)}})}exitCurrentStep(){return D(this,null,function*(){const t=this.getCurrentStep();if(t)try{this.log(`Exiting step: ${t.title}`),this.stepChangeTimeout&&(clearTimeout(this.stepChangeTimeout),this.stepChangeTimeout=null);const e=this.scene.data.get("_tutorialValidationInterval"),i=this.scene.data.get("_tutorialValidationTimeout");e&&(clearInterval(e),this.scene.data.remove("_tutorialValidationInterval")),i&&(clearTimeout(i),this.scene.data.remove("_tutorialValidationTimeout")),this.clearHighlight(),t.onExit&&t.onExit(),this.emitEvent("tutorial:step:exit",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex})}catch(e){this.handleError("Failed to exit current step",e)}})}completeCurrentStep(){return D(this,null,function*(){const t=this.getCurrentStep();if(!(!t||!this.progress))try{this.log(`Completing step: ${t.title}`),this.progress.completedSteps.includes(t.id)||this.progress.completedSteps.push(t.id),this.emitEvent("tutorial:step:completed",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex})}catch(e){this.handleError("Failed to complete current step",e)}})}startGameActionValidation(t){if(!t.gameAction)return;const{type:e,validation:i,timeout:a=3e4}=t.gameAction;this.log(`Starting game action validation: ${e}`);const n=setInterval(()=>{try{const r=window.__gameState||this.scene.data.get("gameState");if(!r){this.logDebug("Game state not available yet");return}i(r)&&(this.log(`Game action validated: ${e}`),clearInterval(n),clearTimeout(o),this.scene.data.remove("_tutorialValidationInterval"),this.scene.data.remove("_tutorialValidationTimeout"),this.nextStep())}catch(r){this.handleError("Error during game action validation",r)}},250),o=setTimeout(()=>{clearInterval(n),this.log(`Game action validation timeout: ${e}`),this.scene.data.remove("_tutorialValidationInterval"),this.scene.data.remove("_tutorialValidationTimeout"),this.emit("tutorial:action:timeout",{step:t,actionType:e})},a);this.scene.data.set("_tutorialValidationInterval",n),this.scene.data.set("_tutorialValidationTimeout",o)}completeTutorial(){return D(this,null,function*(){if(!(!this.currentConfig||!this.progress))try{this.log("Completing tutorial"),this.progress.isCompleted=!0,this.progress.completedAt=new Date,this.state="completed",this.markAsCompleted(this.currentConfig.id),this.emitEvent("tutorial:completed",{tutorialId:this.currentConfig.id,progress:this.progress}),this.options.autoSaveProgress&&this.saveProgress(),yield this.cleanup()}catch(t){this.handleError("Failed to complete tutorial",t)}})}createOverlay(){if(!this.currentConfig)return;const t=x(x({},this.options.defaultOverlayOptions),this.currentConfig.overlayOptions);this.overlayGraphics=this.scene.add.graphics(),this.overlayGraphics.setDepth(1e3),this.overlayGraphics.fillStyle(Phaser.Display.Color.HexStringToColor(t.backgroundColor).color,t.opacity),this.overlayGraphics.fillRect(0,0,this.scene.cameras.main.width,this.scene.cameras.main.height),t.allowClickThrough||this.overlayGraphics.setInteractive(new Phaser.Geom.Rectangle(0,0,this.scene.cameras.main.width,this.scene.cameras.main.height),Phaser.Geom.Rectangle.Contains)}createHighlight(t,e){if(!t.getBounds)return;const i=t.getBounds();this.highlightGraphics=this.scene.add.graphics(),this.highlightGraphics.setDepth(1001),e.color&&(this.highlightGraphics.fillStyle(Phaser.Display.Color.HexStringToColor(e.color).color,e.opacity||.3),this.highlightGraphics.fillRect(i.x,i.y,i.width,i.height)),e.borderColor&&e.borderWidth&&(this.highlightGraphics.lineStyle(e.borderWidth,Phaser.Display.Color.HexStringToColor(e.borderColor).color),this.highlightGraphics.strokeRect(i.x,i.y,i.width,i.height)),e.animationType&&e.animationType!=="none"&&this.createHighlightAnimation(e)}createHighlightAnimation(t){if(!this.highlightGraphics)return;const e=t.duration||1e3;switch(t.animationType){case"pulse":this.highlightTween=this.scene.tweens.add({targets:this.highlightGraphics,alpha:{from:1,to:.3},duration:e/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});break;case"glow":this.highlightTween=this.scene.tweens.add({targets:this.highlightGraphics,scaleX:{from:1,to:1.1},scaleY:{from:1,to:1.1},alpha:{from:1,to:.7},duration:e/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});break}}updateTutorialUI(t){this.log(`UI Update: ${t.title} - ${t.description}`)}updateUILayout(){}createInitialProgress(){var t;return{currentStepIndex:0,completedSteps:[],skippedSteps:[],isCompleted:!1,startedAt:new Date,lastPlayedVersion:(t=this.currentConfig)==null?void 0:t.version}}getCompletedTutorials(){try{const t=localStorage.getItem(O.COMPLETED_TUTORIALS);return t?JSON.parse(t):[]}catch(t){return this.handleError("Failed to get completed tutorials",t),[]}}markAsCompleted(t){try{const e=this.getCompletedTutorials();e.includes(t)||(e.push(t),localStorage.setItem(O.COMPLETED_TUTORIALS,JSON.stringify(e)))}catch(e){this.handleError("Failed to mark as completed",e)}}emitEvent(t,e){this.emit(t,e),this.options.debugMode}handleError(t,e){var i;this.log(`Error: ${t} - ${e.message}`),this.state="error",this.emitEvent("tutorial:error",{tutorialId:((i=this.currentConfig)==null?void 0:i.id)||"unknown",error:e.message})}log(t){this.options.debugMode}cleanup(){return D(this,null,function*(){try{this.stepChangeTimeout&&(clearTimeout(this.stepChangeTimeout),this.stepChangeTimeout=null),this.clearHighlight(),this.overlayGraphics&&(this.overlayGraphics.destroy(),this.overlayGraphics=null),this.tutorialUI&&(this.tutorialUI.destroy(),this.tutorialUI=null),this.state="idle"}catch(t){this.handleError("Failed to cleanup",t)}})}destroy(){this.cleanup(),this.removeAllListeners()}}class X{constructor(s){d(this,"scene");d(this,"container");d(this,"overlayGraphics");d(this,"spotlightMask");d(this,"speechBubble",null);d(this,"progressBar",null);d(this,"controlButtons",null);d(this,"highlightElements",new Map);d(this,"arrows",[]);d(this,"pulseAnimations",[]);d(this,"OVERLAY_ALPHA",.7);d(this,"SPOTLIGHT_RADIUS",80);d(this,"SPEECH_BUBBLE_PADDING",20);d(this,"ANIMATION_DURATION",800);d(this,"BUTTON_HEIGHT",48);d(this,"BUTTON_WIDTH",120);this.scene=s,this.container=s.add.container(0,0),this.container.setDepth(2e3),this.overlayGraphics=s.add.graphics(),this.spotlightMask=s.add.graphics(),this.container.add([this.overlayGraphics,this.spotlightMask]),this.createBaseOverlay()}createBaseOverlay(){const s=this.scene.cameras.main;this.overlayGraphics.clear(),this.overlayGraphics.fillStyle(0,this.OVERLAY_ALPHA),this.overlayGraphics.fillRect(0,0,s.width,s.height),this.overlayGraphics.setInteractive(new Phaser.Geom.Rectangle(0,0,s.width,s.height),Phaser.Geom.Rectangle.Contains)}createSpotlight(s){if(!s.getBounds)return;const t=s.getBounds(),e=this.scene.cameras.main;this.spotlightMask.clear(),this.spotlightMask.fillStyle(0,this.OVERLAY_ALPHA),this.spotlightMask.fillRect(0,0,e.width,e.height);const i=t.centerX,a=t.centerY,n=Math.max(t.width,t.height)/2+this.SPOTLIGHT_RADIUS;this.spotlightMask.fillStyle(0,0),this.spotlightMask.fillCircle(i,a,n),this.overlayGraphics.setMask(new Phaser.Display.Masks.GeometryMask(this.scene,this.spotlightMask))}createSpeechBubble(s,t){this.speechBubble&&this.speechBubble.destroy();const e=this.scene.cameras.main,i=Math.min(400,e.width-40);this.speechBubble=this.scene.add.container(0,0);const a=this.scene.add.graphics();a.fillStyle(16777215,.95),a.lineStyle(2,3355443,1);const n=this.scene.add.text(0,0,s.title,{fontSize:"18px",fontFamily:"Arial, sans-serif",color:"#333333",fontStyle:"bold",wordWrap:{width:i-this.SPEECH_BUBBLE_PADDING*2}}),o=this.scene.add.text(0,0,s.description,{fontSize:"14px",fontFamily:"Arial, sans-serif",color:"#666666",wordWrap:{width:i-this.SPEECH_BUBBLE_PADDING*2}}),r=n.height,l=o.height,c=r+l+this.SPEECH_BUBBLE_PADDING*3,g=i,f=12;a.fillRoundedRect(-g/2,-c/2,g,c,f),a.strokeRoundedRect(-g/2,-c/2,g,c,f),n.setPosition(-g/2+this.SPEECH_BUBBLE_PADDING,-c/2+this.SPEECH_BUBBLE_PADDING),o.setPosition(-g/2+this.SPEECH_BUBBLE_PADDING,n.y+r+this.SPEECH_BUBBLE_PADDING/2),this.speechBubble.add([a,n,o]),this.positionSpeechBubble(s.position||"bottom",t),this.speechBubble.setAlpha(0),this.speechBubble.setScale(.8),this.scene.tweens.add({targets:this.speechBubble,alpha:1,scaleX:1,scaleY:1,duration:this.ANIMATION_DURATION/2,ease:"Back.easeOut"}),this.container.add(this.speechBubble)}positionSpeechBubble(s,t){if(!this.speechBubble)return;const e=this.scene.cameras.main,i=this.speechBubble.getBounds(),a=20;let n=e.centerX,o=e.centerY;if(t)switch(s){case"top":n=t.centerX,o=t.top-i.height/2-a;break;case"bottom":n=t.centerX,o=t.bottom+i.height/2+a;break;case"left":n=t.left-i.width/2-a,o=t.centerY;break;case"right":n=t.right+i.width/2+a,o=t.centerY;break;case"center":n=e.centerX,o=e.centerY;break}n=Phaser.Math.Clamp(n,i.width/2+a,e.width-i.width/2-a),o=Phaser.Math.Clamp(o,i.height/2+a,e.height-i.height/2-a),this.speechBubble.setPosition(n,o)}createProgressBar(s,t){this.progressBar&&this.progressBar.destroy();const e=this.scene.cameras.main;this.progressBar=this.scene.add.container(e.centerX,50);const i=300,a=8,n=s.currentStepIndex+1,o=this.scene.add.graphics();o.fillStyle(3355443,.3),o.fillRoundedRect(-i/2,-a/2,i,a,4);const r=n/t*i,l=this.scene.add.graphics();l.fillStyle(5025616,1),l.fillRoundedRect(-i/2,-a/2,r,a,4);const c=this.scene.add.text(0,-30,`ステップ ${n} / ${t}`,{fontSize:"14px",fontFamily:"Arial, sans-serif",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5);this.progressBar.add([o,l,c]),this.container.add(this.progressBar)}createControlButtons(s,t,e,i,a){this.controlButtons&&this.controlButtons.destroy();const n=this.scene.cameras.main;this.controlButtons=this.scene.add.container(n.centerX,n.height-80);const o=[];let r=0;if(s&&i){const g=this.createButton("戻る","#6c757d",i);o.push(g),r+=this.BUTTON_WIDTH+10}const l=this.createButton("次へ","#007bff",e);if(o.push(l),r+=this.BUTTON_WIDTH+10,t&&a){const g=this.createButton("スキップ","#dc3545",a);o.push(g),r+=this.BUTTON_WIDTH+10}let c=-r/2;o.forEach(g=>{g.setPosition(c+this.BUTTON_WIDTH/2,0),c+=this.BUTTON_WIDTH+10,this.controlButtons.add(g)}),this.container.add(this.controlButtons)}createButton(s,t,e){const i=this.scene.add.container(0,0),a=this.scene.add.graphics(),n=parseInt(t.substring(1),16);a.fillStyle(n,1),a.fillRoundedRect(-this.BUTTON_WIDTH/2,-this.BUTTON_HEIGHT/2,this.BUTTON_WIDTH,this.BUTTON_HEIGHT,8);const o=this.scene.add.graphics();o.fillStyle(n,.8),o.fillRoundedRect(-this.BUTTON_WIDTH/2,-this.BUTTON_HEIGHT/2,this.BUTTON_WIDTH,this.BUTTON_HEIGHT,8),o.setVisible(!1);const r=this.scene.add.text(0,0,s,{fontSize:"16px",fontFamily:"Arial, sans-serif",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);return i.add([a,o,r]),i.setSize(this.BUTTON_WIDTH,this.BUTTON_HEIGHT),i.setInteractive(),i.on("pointerover",()=>{a.setVisible(!1),o.setVisible(!0),this.scene.tweens.add({targets:i,scaleX:1.05,scaleY:1.05,duration:150,ease:"Power2"})}),i.on("pointerout",()=>{a.setVisible(!0),o.setVisible(!1),this.scene.tweens.add({targets:i,scaleX:1,scaleY:1,duration:150,ease:"Power2"})}),i.on("pointerdown",()=>{this.scene.tweens.add({targets:i,scaleX:.95,scaleY:.95,duration:100,yoyo:!0,ease:"Power2",onComplete:e})}),i}highlightElement(s,t={}){var r;const e=this.scene.children.getByName(s);if(!e||!e.getBounds)return;const i=e.getBounds(),a=this.scene.add.graphics();a.setDepth(1999);const o=x(x({},{color:"#FFD700",opacity:.4,borderWidth:3,borderColor:"#FFA500",glowEffect:!0,animationType:"pulse",duration:1e3}),t);if(o.color){const l=parseInt(o.color.substring(1),16);a.fillStyle(l,o.opacity||.4),a.fillRect(i.x,i.y,i.width,i.height)}if(o.borderColor&&o.borderWidth){const l=parseInt(o.borderColor.substring(1),16);a.lineStyle(o.borderWidth,l),a.strokeRect(i.x,i.y,i.width,i.height)}if(o.glowEffect){const l=this.scene.add.graphics();l.setDepth(1998);const c=parseInt(((r=o.borderColor)==null?void 0:r.substring(1))||"FFA500",16);l.lineStyle(8,c,.3),l.strokeRect(i.x-4,i.y-4,i.width+8,i.height+8),this.highlightElements.set(s+"_glow",l)}if(o.animationType!=="none"){const l=this.createHighlightAnimation(a,o);l&&this.pulseAnimations.push(l)}this.highlightElements.set(s,a)}createHighlightAnimation(s,t){const e=t.duration||1e3;switch(t.animationType){case"pulse":return this.scene.tweens.add({targets:s,alpha:{from:1,to:.3},duration:e/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});case"glow":return this.scene.tweens.add({targets:s,scaleX:{from:1,to:1.1},scaleY:{from:1,to:1.1},alpha:{from:1,to:.7},duration:e/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});case"border":return this.scene.tweens.add({targets:s,rotation:{from:0,to:Math.PI*2},duration:e,repeat:-1,ease:"Linear"});default:return null}}createArrow(s,t,e,i,a="#FFD700"){const n=Phaser.Math.Angle.Between(s,t,e,i),o=Phaser.Math.Distance.Between(s,t,e,i),r=s+Math.cos(n)*(o*.7),l=t+Math.sin(n)*(o*.7),c=this.scene.add.graphics();c.setDepth(2001);const g=parseInt(a.substring(1),16);c.fillStyle(g,1),c.beginPath(),c.moveTo(0,-10),c.lineTo(20,0),c.lineTo(0,10),c.closePath(),c.fillPath(),c.setPosition(r,l),c.setRotation(n),this.scene.tweens.add({targets:c,scaleX:{from:1,to:1.2},scaleY:{from:1,to:1.2},alpha:{from:1,to:.7},duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.arrows.push(c)}clearHighlights(){this.highlightElements.forEach(s=>s.destroy()),this.highlightElements.clear(),this.pulseAnimations.forEach(s=>s.destroy()),this.pulseAnimations=[],this.arrows.forEach(s=>s.destroy()),this.arrows=[]}onResize(){if(this.createBaseOverlay(),this.updateResponsiveLayout(),this.spotlightMask&&this.highlightElements.size>0){const s=this.highlightElements.values().next().value;if(s&&s.getBounds){const t=s.getBounds(),e={getBounds:()=>t};this.createSpotlight(e)}}}enableKeyboardControls(s,t,e){var a,n,o,r,l,c,g;const i=(a=this.scene.input.keyboard)==null?void 0:a.createCursorKeys();if(i){(n=this.scene.input.keyboard)==null||n.on("keydown-SPACE",s),(o=this.scene.input.keyboard)==null||o.on("keydown-ENTER",s),t&&((r=this.scene.input.keyboard)==null||r.on("keydown-BACKSPACE",t),i.left.on("down",t)),e&&((l=this.scene.input.keyboard)==null||l.on("keydown-ESC",e)),i.right.on("down",s),(c=this.scene.input.keyboard)==null||c.on("keydown-TAB",f=>{f.preventDefault(),this.cycleButtonFocus()});for(let f=1;f<=9;f++)(g=this.scene.input.keyboard)==null||g.on(`keydown-${f}`,()=>{this.jumpToStep(f-1)})}}cycleButtonFocus(){if(this.controlButtons){const s=this.controlButtons.list;if(s.length>0){const t=s[0];this.scene.tweens.add({targets:t,scaleX:1.1,scaleY:1.1,duration:200,yoyo:!0,ease:"Power2"})}}}jumpToStep(s){}updateResponsiveLayout(){const s=this.scene.cameras.main,t=s.width<768;s.width<480?this.applyMobileLayout():t?this.applyTabletLayout():this.applyDesktopLayout()}applyMobileLayout(){const s=this.scene.cameras.main,t=56,e=Math.min(150,s.width/3-10);if(this.progressBar&&this.progressBar.setPosition(s.centerX,30),this.speechBubble){const i=s.width-20;this.repositionSpeechBubbleForMobile(i)}this.controlButtons&&(this.controlButtons.setPosition(s.centerX,s.height-40),this.adjustButtonSizesForMobile(e,t))}applyTabletLayout(){const s=this.scene.cameras.main,t=52,e=140;this.progressBar&&this.progressBar.setPosition(s.centerX,40),this.controlButtons&&(this.controlButtons.setPosition(s.centerX,s.height-60),this.adjustButtonSizes(e,t))}applyDesktopLayout(){const s=this.scene.cameras.main;this.progressBar&&this.progressBar.setPosition(s.centerX,50),this.controlButtons&&this.controlButtons.setPosition(s.centerX,s.height-80)}repositionSpeechBubbleForMobile(s){if(!this.speechBubble)return;const t=this.scene.cameras.main;this.speechBubble.setPosition(t.centerX,t.height*.3),this.speechBubble.list.filter(i=>i instanceof Phaser.GameObjects.Text).forEach(i=>{i.setWordWrapWidth(s-this.SPEECH_BUBBLE_PADDING*2)})}adjustButtonSizesForMobile(s,t){if(!this.controlButtons)return;this.controlButtons.list.forEach((i,a)=>{const n=i.list[0];n&&(n.clear(),n.fillStyle(31743,1),n.fillRoundedRect(-s/2,-t/2,s,t,8));const o=i.list.find(r=>r instanceof Phaser.GameObjects.Text);o&&o.setFontSize("18px"),i.setPosition((a-1)*(s+15),0)})}adjustButtonSizes(s,t){if(!this.controlButtons)return;this.controlButtons.list.forEach(i=>{const a=i.list[0];a&&(a.clear(),a.fillStyle(31743,1),a.fillRoundedRect(-s/2,-t/2,s,t,8))})}announceForScreenReader(s){const t=this.scene.add.text(-1e3,-1e3,s,{fontSize:"1px",color:"#000000"}),e=this.scene.game.canvas;e&&(e.setAttribute("aria-label",s),this.scene.time.delayedCall(1e3,()=>{t.destroy(),e.removeAttribute("aria-label")}))}enableHighContrastMode(){this.overlayGraphics.clear(),this.overlayGraphics.fillStyle(0,.9);const s=this.scene.cameras.main;this.overlayGraphics.fillRect(0,0,s.width,s.height),this.highlightElements.forEach(t=>{t.clear(),t.fillStyle(16776960,.7),t.lineStyle(4,16711680,1)})}enableReducedMotion(){this.pulseAnimations.forEach(s=>{s.stop()}),this.pulseAnimations=[],this.highlightElements.forEach(s=>{s.setAlpha(.6)})}setVisible(s){this.container.setVisible(s)}destroy(){var s;this.clearHighlights(),(s=this.scene.input.keyboard)==null||s.removeAllListeners(),this.container.destroy()}}const Y={id:"interactive_game_tutorial",name:"人生充実ゲーム入門",description:"実際にゲームをプレイしながら基本的な操作を学びます",version:"2.0.0",autoStart:!1,canSkip:!0,showProgress:!0,overlayOptions:{backgroundColor:"#000000",opacity:.6,blurBackground:!1,allowClickThrough:!0},steps:[{id:"welcome",title:"ようこそ、人生充実ゲームへ！",description:`このゲームでは、保険を活用しながら人生の様々な挑戦を乗り越え、夢を実現することを目指します。

実際にゲームをプレイしながら、基本的な操作を学んでいきましょう！`,position:"center",action:"click",highlightOptions:{animationType:"none"}},{id:"vitality_explanation",title:"活力（バイタリティ）について",description:`この緑のバーがあなたの活力です。

活力は人生の挑戦に立ち向かうエネルギーを表し、0になるとゲームオーバーです。

現在の活力: 20/35`,targetElement:"vitality-bar",position:"bottom",action:"click",highlightOptions:{color:"#00FF00",opacity:.4,borderWidth:3,borderColor:"#00AA00",glowEffect:!0,animationType:"pulse",duration:1e3}},{id:"hand_cards_explanation",title:"手札について",description:`ここがあなたの手札です。

人生カード（青）と保険カード（緑）があり、これらを使って様々な挑戦に立ち向かいます。`,targetElement:"hand-area",position:"top",action:"click",highlightOptions:{color:"#FFD700",opacity:.3,borderWidth:4,borderColor:"#FFA500",glowEffect:!0,animationType:"glow"}},{id:"draw_card_instruction",title:"最初のカードを引いてみましょう",description:`「カードを引く」ボタンをクリックして、新しいカードを1枚引いてください。

カードを引くことで、新たな選択肢が増えます。`,targetElement:"draw-button",position:"left",action:"wait_for_game_action",gameAction:{type:"draw_card",validation:u=>{const s=u.hand,t=u.config;return s.length>t.startingHandSize}},highlightOptions:{color:"#4CAF50",opacity:.5,borderWidth:4,borderColor:"#2E7D32",glowEffect:!0,animationType:"pulse",duration:800}},{id:"draw_success",title:"よくできました！",description:`新しいカードを引きました。

手札が増えると、より多くの戦略を立てることができます。`,position:"center",action:"auto",waitTime:3e3,highlightOptions:{animationType:"none"}},{id:"challenge_explanation",title:"チャレンジカードが現れました",description:`これが「チャレンジカード」です。

人生には様々な挑戦があります。手札のカードを使って、これらの挑戦を乗り越えましょう。`,targetElement:"challenge-area",position:"bottom",action:"click",highlightOptions:{color:"#FF6B6B",opacity:.4,borderWidth:4,borderColor:"#FF4444",glowEffect:!0,animationType:"pulse"}},{id:"select_cards_instruction",title:"カードを選択してチャレンジに挑戦",description:`チャレンジに必要なパワー以上になるよう、手札からカードを選択してください。

複数のカードを組み合わせることもできます。

カードをクリックして選択しましょう！`,targetElement:"hand-area",position:"top",action:"wait_for_game_action",gameAction:{type:"select_cards",validation:u=>u.selectedCards.length>0},highlightOptions:{color:"#FFD700",opacity:.4,borderWidth:3,borderColor:"#FFA500",animationType:"glow"}},{id:"resolve_challenge_instruction",title:"チャレンジに挑戦！",description:`カードを選択したら、「チャレンジに挑む」ボタンをクリックして結果を確認しましょう。

選択したカードの合計パワーがチャレンジに必要なパワー以上なら成功です！`,targetElement:"resolve-button",position:"left",action:"wait_for_game_action",gameAction:{type:"resolve_challenge",validation:u=>u.phase==="resolution"||u.phase==="card_selection"},highlightOptions:{color:"#2196F3",opacity:.5,borderWidth:4,borderColor:"#1976D2",glowEffect:!0,animationType:"pulse"}},{id:"insurance_selection",title:"保険を選択しましょう",description:`チャレンジ成功！報酬として保険カードを1枚選べます。

保険は将来の挑戦に備える重要な要素です。

3枚の中から1枚を選んでください。`,targetElement:"card-selection-ui",position:"center",action:"wait_for_game_action",gameAction:{type:"select_reward_card",validation:u=>u.phase==="resolution"},skipCondition:()=>{var s;const u=window.__gameState;return((s=u==null?void 0:u.lastChallengeResult)==null?void 0:s.success)===!1},highlightOptions:{color:"#4CAF50",opacity:.3,animationType:"glow"}},{id:"end_turn_instruction",title:"ターンを終了しましょう",description:`チャレンジが終わったら、「ターン終了」ボタンをクリックして次のターンに進みます。

新しいチャレンジが現れ、ゲームが進行します。`,targetElement:"end-turn-button",position:"left",action:"wait_for_game_action",gameAction:{type:"end_turn",validation:u=>u.turn>1},highlightOptions:{color:"#9C27B0",opacity:.5,borderWidth:4,borderColor:"#7B1FA2",glowEffect:!0,animationType:"pulse"}},{id:"insurance_effects",title:"保険の効果について",description:`保険カードはチャレンジ時にボーナスパワーを提供します。

年齢が上がるほど保険の効果も高まりますが、保険が多すぎると負担（-パワー）も発生します。

バランスが重要です！`,targetElement:"insurance-list",position:"left",action:"click",highlightOptions:{color:"#00BCD4",opacity:.4,borderWidth:3,borderColor:"#0097A7",animationType:"pulse"}},{id:"basic_strategy",title:"基本的な戦略",description:`成功のコツ：

1. 活力を管理しながら挑戦する
2. 保険を適切に選択・活用する
3. カードの組み合わせを工夫する
4. 年齢に応じた戦略を立てる`,position:"center",action:"click",highlightOptions:{animationType:"none"}},{id:"tutorial_complete",title:"チュートリアル完了！",description:`おめでとうございます！基本的な操作を習得しました。

これから本格的なゲームが始まります。

3つのライフステージを乗り越え、最後に夢を実現しましょう！

頑張ってください！`,position:"center",action:"click",highlightOptions:{color:"#4CAF50",opacity:.3,animationType:"glow",duration:2e3},onExit:()=>{localStorage.setItem("tutorial_completed","true")}}]};class j{constructor(s){d(this,"zones",new Map);d(this,"scene");d(this,"dragState",{isDragging:!1,validZones:[]});d(this,"lastFrameTime",0);d(this,"FRAME_INTERVAL",16);this.scene=s}addZone(s){this.zones.set(s.id,s)}removeZone(s){this.zones.delete(s)}startDrag(s,t,e){this.dragState={isDragging:!0,card:s,startPosition:x({},e),currentPosition:x({},e),validZones:this.getValidZones(s,t),hoveredZone:void 0},this.highlightValidZones()}updateDrag(s,t){if(!this.dragState.isDragging||!this.dragState.card)return;const e=Date.now();if(e-this.lastFrameTime<this.FRAME_INTERVAL)return;this.lastFrameTime=e,this.dragState.currentPosition=x({},s);const i=this.getZoneAtPosition(s.x,s.y);i!==this.dragState.hoveredZone&&this.updateHoverState(i,t)}endDrag(s,t){if(!this.dragState.isDragging||!this.dragState.card)return{success:!1,error:"No active drag operation"};const e=this.getZoneAtPosition(s.x,s.y);let i;if(e&&this.isValidDrop(this.dragState.card,e,t))try{e.onDrop(this.dragState.card,t),i={success:!0,zone:e}}catch(a){i={success:!1,error:`Drop action failed: ${a instanceof Error?a.message:"Unknown error"}`}}else i={success:!1,error:e?"Invalid drop target":"No drop zone found"};return this.clearHighlights(),this.dragState={isDragging:!1,validZones:[]},i}getZoneAtPosition(s,t){return Array.from(this.zones.values()).filter(i=>i.bounds.contains(s,t)).sort((i,a)=>a.priority-i.priority)[0]}getValidZones(s,t){return Array.from(this.zones.values()).filter(e=>{try{return e.isValid(s,t)}catch(i){return console.warn(`Validation error for zone ${e.id}:`,i),!1}})}isValidDrop(s,t,e){try{return this.dragState.validZones.includes(t)&&t.isValid(s,e)}catch(i){return console.warn(`Validation error for zone ${t.id}:`,i),!1}}highlightValidZones(){this.dragState.validZones.forEach(s=>{var e,i;const t=this.scene.add.graphics();t.fillStyle(((e=s.visualStyle)==null?void 0:e.validColor)||65280,.3),t.fillRectShape(s.bounds),t.lineStyle(2,((i=s.visualStyle)==null?void 0:i.validColor)||65280,.8),t.strokeRectShape(s.bounds),t.setName(`highlight-${s.id}`),this.scene.tweens.add({targets:t,alpha:.5,duration:1e3,yoyo:!0,repeat:-1,ease:"Power2"})})}updateHoverState(s,t){var e,i;if(this.dragState.hoveredZone){const a=this.scene.children.getByName(`hover-${this.dragState.hoveredZone.id}`);a&&a.destroy()}if(this.dragState.hoveredZone=s,s&&this.dragState.card){const n=this.isValidDrop(this.dragState.card,s,t)?((e=s.visualStyle)==null?void 0:e.hoverColor)||65416:((i=s.visualStyle)==null?void 0:i.invalidColor)||16711680,o=this.scene.add.graphics();o.fillStyle(n,.5),o.fillRectShape(s.bounds),o.lineStyle(3,n,1),o.strokeRectShape(s.bounds),o.setName(`hover-${s.id}`),o.setScale(.9),this.scene.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:200,ease:"Back.out"})}}clearHighlights(){this.zones.forEach(s=>{const t=this.scene.children.getByName(`highlight-${s.id}`),e=this.scene.children.getByName(`hover-${s.id}`);t&&this.scene.tweens.add({targets:t,alpha:0,duration:200,onComplete:()=>t.destroy()}),e&&e.destroy()})}getMagneticSnapTarget(s){if(!this.dragState.card)return null;for(const t of this.dragState.validZones){const e=t.magneticDistance||100,i=t.bounds.x+t.bounds.width/2,a=t.bounds.y+t.bounds.height/2,n=s.x-i,o=s.y-a;if(Math.sqrt(n*n+o*o)<=e)return{zone:t,snapPosition:{x:i,y:a}}}return null}getDragState(){return x({},this.dragState)}destroy(){this.clearHighlights(),this.zones.clear(),this.dragState={isDragging:!1,validZones:[]}}}class I{static cardTypeOnly(s){return t=>s.includes(t.type)}static phaseOnly(s){return(t,e)=>{var a;const i=((a=e.getCurrentPhase)==null?void 0:a.call(e))||"unknown";return s.includes(i)}}static minimumPower(s){return t=>t.power>=s}static maximumPower(s){return t=>t.power<=s}static costLimit(s){return t=>t.cost<=s}static vitalityCheck(s){return(t,e)=>e.vitality>=s}static notInChallenge(){return(s,t)=>!t.currentChallenge}static inChallenge(){return(s,t)=>!!t.currentChallenge}static handSpaceAvailable(){return(s,t)=>{if(!t.playerHand)return!1;const e=t.playerHand.size(),i=t.maxHandSize||7;return e<i}}static cardInHand(){return(s,t)=>{var e;return((e=t.playerHand)==null?void 0:e.contains(s.id))||!1}}static stageOnly(s){return(t,e)=>s.includes(e.stage)}static ageRange(s,t){return(e,i)=>{var n;const a=((n=i.getPlayerAge)==null?void 0:n.call(i))||20;return a>=s&&a<=t}}static custom(s){return s}static combine(...s){return(t,e)=>s.every(i=>i(t,e))}static either(...s){return(t,e)=>s.some(i=>i(t,e))}static not(s){return(t,e)=>!s(t,e)}static conditional(s,t,e){return(i,a)=>s(i,a)?t(i,a):e?e(i,a):!0}static always(){return()=>!0}static never(){return()=>!1}}class w{static startChallenge(){return(s,t)=>{t.currentChallenge||t.startChallenge(s)}}static discardCard(){return(s,t)=>{var e,i;if(!s||!t){console.warn("[DropZoneActions] discardCard: card or game is null");return}(e=t.playerHand)==null||e.removeCard(s.id),(i=t.discardPile)==null||i.addCard(s)}}static returnToDeck(s=!1){return(t,e)=>{var i,a,n;if(!t||!e){console.warn("[DropZoneActions] returnToDeck: card or game is null");return}(i=e.playerHand)==null||i.removeCard(t.id),(a=e.playerDeck)==null||a.addCard(t),s&&((n=e.playerDeck)==null||n.shuffle())}}static consumeVitality(s){return(t,e)=>{e.vitality=Math.max(0,e.vitality-s)}}static restoreVitality(s){return(t,e)=>{const i=e.maxVitality||20;e.vitality=Math.min(i,e.vitality+s)}}static playCard(){return(s,t)=>{var e,i;if(!s||!t){console.warn("[DropZoneActions] playCard: card or game is null");return}s.type==="life"&&s.power>0&&(t.vitality=Math.min(t.maxVitality||20,t.vitality+s.power)),(e=t.playerHand)==null||e.removeCard(s.id),(i=t.playedCards)==null||i.addCard(s)}}static triggerSpecialEffect(s){return(t,e)=>{t.type}}static log(s){return(t,e)=>{}}static sequence(...s){return(t,e)=>{s.forEach(i=>i(t,e))}}static conditional(s,t,e){return(i,a)=>{s(i,a)?t(i,a):e&&e(i,a)}}static custom(s){return s}static noop(){return()=>{}}static throwError(s){return()=>{throw new Error(s)}}}class R{static challengeZone(){return{validator:I.combine(I.cardTypeOnly(["life"]),I.notInChallenge(),I.cardInHand()),action:w.sequence(w.log("Starting challenge"),w.startChallenge())}}static discardZone(){return{validator:I.combine(I.cardInHand(),I.not(I.inChallenge())),action:w.sequence(w.log("Discarding card"),w.discardCard())}}static insurancePlayZone(){return{validator:I.combine(I.cardTypeOnly(["insurance"]),I.cardInHand(),I.vitalityCheck(1)),action:w.sequence(w.log("Playing insurance card"),w.playCard(),w.consumeVitality(1))}}static specialAbilityZone(s,t){return{validator:I.combine(I.cardTypeOnly([s]),I.vitalityCheck(t),I.cardInHand()),action:w.sequence(w.log(`Using special ability (cost: ${t})`),w.consumeVitality(t),w.triggerSpecialEffect("special-ability"),w.discardCard())}}}class K{constructor(s,t){d(this,"dropZoneManager");d(this,"scene");d(this,"game");d(this,"deviceInfo");d(this,"dragConfig");d(this,"draggedCard");d(this,"dragStartPosition",{x:0,y:0});d(this,"isSnapping",!1);this.scene=s,this.game=t,this.dropZoneManager=new j(s),this.deviceInfo=this.detectDevice(),this.dragConfig=this.createDragConfig(),this.initializeDefaultZones()}detectDevice(){const s=this.scene.sys.game.device.os.android||this.scene.sys.game.device.os.iOS,t=s&&Math.min(window.innerWidth,window.innerHeight)>=768,e=this.scene.sys.game.device.input.touch,i=window.innerWidth>window.innerHeight?"landscape":"portrait";return{isMobile:s,isTablet:t,hasTouch:e,orientation:i}}createDragConfig(){return{snapDistance:this.deviceInfo.isMobile?120:100,touchOffset:this.deviceInfo.isMobile?{x:0,y:-60}:{x:0,y:0},animationDuration:this.deviceInfo.isMobile?400:300,throttleInterval:this.deviceInfo.isMobile?20:16}}initializeDefaultZones(){const s=R.challengeZone(),t={id:"challenge",type:"challenge",bounds:new Phaser.Geom.Rectangle(this.scene.cameras.main.centerX-h.CARD_WIDTH/2,h.CHALLENGE_Y_POSITION-h.CARD_HEIGHT/2,h.CARD_WIDTH,h.CARD_HEIGHT),isValid:s.validator,onDrop:(a,n)=>{this.handleChallengeDrop(a),s.action(a,n)},priority:10,magneticDistance:this.dragConfig.snapDistance,visualStyle:{validColor:1096065,invalidColor:15680580,hoverColor:366185}},e=R.discardZone(),i={id:"discard",type:"discard",bounds:new Phaser.Geom.Rectangle(h.DISCARD_X_POSITION-h.CARD_WIDTH/2,h.DISCARD_Y_POSITION-h.CARD_HEIGHT/2,h.CARD_WIDTH,h.CARD_HEIGHT),isValid:e.validator,onDrop:(a,n)=>{this.handleDiscardDrop(a),e.action(a,n)},priority:5,magneticDistance:this.dragConfig.snapDistance,visualStyle:{validColor:7041664,invalidColor:15680580,hoverColor:4937059}};this.dropZoneManager.addZone(t),this.dropZoneManager.addZone(i)}setupCardDragAndDrop(s){const t=s.getData("card");s.on("dragstart",e=>{this.startDrag(s,e,t)}),s.on("drag",(e,i,a)=>{this.updateDrag(s,e,i,a)}),s.on("dragend",e=>{this.endDrag(s,e,t)})}startDrag(s,t,e){if(!t||!s||!e){console.warn("[DropZoneIntegration] startDrag: invalid parameters");return}this.draggedCard=s,this.dragStartPosition={x:s.x,y:s.y};const i={x:t.x+this.dragConfig.touchOffset.x,y:t.y+this.dragConfig.touchOffset.y};this.dropZoneManager.startDrag(e,this.game,i),s.setDepth(1e3),s.setAlpha(.8),s.setScale(1.15),this.createDragTrail(s),this.deviceInfo.hasTouch&&navigator.vibrate&&navigator.vibrate(50)}updateDrag(s,t,e,i){if(!s||e===void 0||i===void 0){console.warn("[DropZoneIntegration] updateDrag: invalid parameters");return}const a={x:e+this.dragConfig.touchOffset.x,y:i+this.dragConfig.touchOffset.y};if(s.x=a.x,s.y=a.y,this.dropZoneManager.updateDrag(a,this.game),!this.isSnapping){const n=this.dropZoneManager.getMagneticSnapTarget(a);n&&this.performMagneticSnap(s,n.snapPosition)}this.updateDragTrail(s)}endDrag(s,t,e){if(!s){console.warn("[DropZoneIntegration] endDrag: invalid cardContainer");return}const i={x:s.x,y:s.y},a=this.dropZoneManager.endDrag(i,this.game);a.success?this.handleSuccessfulDrop(s,a):this.handleFailedDrop(s,a),this.cleanupDrag(s),this.draggedCard=void 0}performMagneticSnap(s,t){this.isSnapping=!0,this.scene.tweens.add({targets:s,x:t.x,y:t.y,duration:200,ease:"Back.out",onComplete:()=>{this.isSnapping=!1,this.showSnapFeedback(s)}})}handleSuccessfulDrop(s,t){this.scene.tweens.add({targets:s,scaleX:1.2,scaleY:1.2,duration:150,ease:"Back.out",yoyo:!0,onComplete:()=>{this.createSuccessParticles(s.x,s.y),this.scene.tweens.add({targets:s,alpha:0,scale:.8,duration:this.dragConfig.animationDuration,ease:"Power2",onComplete:()=>{}})}}),this.deviceInfo.hasTouch&&navigator.vibrate&&navigator.vibrate([100,50,100])}handleFailedDrop(s,t){this.scene.tweens.add({targets:s,x:this.dragStartPosition.x,y:this.dragStartPosition.y,duration:this.dragConfig.animationDuration,ease:"Elastic.out"}),this.showFailureFeedback(s),t.error&&console.warn(`Drop failed: ${t.error}`),this.deviceInfo.hasTouch&&navigator.vibrate&&navigator.vibrate(200)}createDragTrail(s){const t=this.scene.add.graphics();t.fillStyle(6717162,.3),t.fillCircle(0,0,15),t.setDepth(999),t.setName("drag-trail"),s.add(t)}updateDragTrail(s){const t=s.getByName("drag-trail");t&&(t.setAlpha(t.alpha*.95),t.alpha<.1&&t.destroy())}showSnapFeedback(s){const t=this.scene.add.graphics();t.lineStyle(3,1096065,.8),t.strokeCircle(s.x,s.y,80),t.setDepth(1001),this.scene.tweens.add({targets:t,alpha:0,duration:500,ease:"Power2",onComplete:()=>t.destroy()})}showFailureFeedback(s){const t=s.x;this.scene.tweens.add({targets:s,x:t-10,duration:50,yoyo:!0,repeat:3,ease:"Power2"});const e=this.scene.add.graphics();e.lineStyle(4,15680580,.8),e.lineBetween(-20,-20,20,20),e.lineBetween(-20,20,20,-20),e.setPosition(s.x,s.y),e.setDepth(1001),this.scene.tweens.add({targets:e,alpha:0,scale:2,duration:1e3,ease:"Power2",onComplete:()=>e.destroy()})}createSuccessParticles(s,t){for(let e=0;e<8;e++){const i=this.scene.add.graphics();i.fillStyle(1096065,.8),i.fillCircle(0,0,4),i.setPosition(s,t),i.setDepth(1002);const a=e/8*Math.PI*2,n=100;this.scene.tweens.add({targets:i,x:s+Math.cos(a)*n,y:t+Math.sin(a)*n,alpha:0,scale:2,duration:800,ease:"Power2",onComplete:()=>i.destroy()})}}cleanupDrag(s){s.setDepth(0),s.setAlpha(1),s.setScale(1);const t=s.getByName("drag-trail");t&&t.destroy()}handleChallengeDrop(s){}handleDiscardDrop(s){}addCustomZone(s){this.dropZoneManager.addZone(s)}removeZone(s){this.dropZoneManager.removeZone(s)}destroy(){this.dropZoneManager.destroy()}}class q extends _{constructor(){super({key:"GameScene"});d(this,"gameInstance");d(this,"handCards",[]);d(this,"selectedCards",new Set);d(this,"cardSelectionUI");d(this,"insuranceTypeSelectionUI");d(this,"selectedInsuranceType");d(this,"vitalityBarContainer");d(this,"vitalityBar");d(this,"vitalityBarMaxWidth",300);d(this,"insuranceListContainer");d(this,"burdenIndicatorContainer");d(this,"insuranceRenewalDialogUI");d(this,"dropZoneIntegration");d(this,"dropZones",new Map);d(this,"dropZoneHighlights",new Map);d(this,"isDragInProgress",!1);d(this,"dragTrail");d(this,"magneticEffect");d(this,"tutorialManager");d(this,"tutorialOverlay");d(this,"isTutorialMode",!1);d(this,"tutorialStepElements",new Map);d(this,"shouldStartTutorial",!1)}init(t){this.shouldStartTutorial=t.startTutorial||!1}initialize(){this.initializeGame(),this.createUI(),this.createCardAreas(),this.initializeTutorial(),this.startGame()}initializeGame(){this.gameInstance=new L({difficulty:"normal",startingVitality:20,startingHandSize:5,maxHandSize:7,dreamCardCount:2});const t=v.createStarterLifeCards();this.gameInstance.playerDeck.addCards(t),this.gameInstance.playerDeck.shuffle();const e=v.createChallengeCards(this.gameInstance.stage);this.gameInstance.challengeDeck.addCards(e),this.gameInstance.challengeDeck.shuffle()}createUI(){this.add.rectangle(0,0,this.gameWidth,this.gameHeight,2042167).setOrigin(0,0),this.add.rectangle(0,0,this.gameWidth,80,4988309).setOrigin(0,0).setAlpha(.9);const e=this.add.text(20,40,this.getStageDisplayText(),{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#F9FAFB",fontStyle:"bold"});e.setOrigin(0,.5),e.setName("stage-text"),this.createLifeStageIndicator(),this.createVitalityBar();const i=this.getStageDisplayText(),a=this.add.text(this.centerX,40,`活力: ${this.gameInstance.vitality} / ${this.gameInstance.maxVitality} (${i})`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#F9FAFB",fontStyle:"bold"});a.setOrigin(.5),a.setShadow(2,2,"#000000",.5,!0,!0),a.setName("vitality-text");const n=this.add.text(this.gameWidth-20,40,`ターン: ${this.gameInstance.turn}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#E5E7EB"});n.setOrigin(1,.5),n.setName("turn-text"),this.createActionButtons(),this.createBurdenIndicator(),this.createInsuranceListDisplay()}createBurdenIndicator(){this.burdenIndicatorContainer=this.add.container(this.gameWidth-200,120),this.burdenIndicatorContainer.setName("burden-indicator");const t=this.add.rectangle(0,0,180,50,1120295,.8);t.setStrokeStyle(1,8490232,.5);const e=this.add.text(-80,0,"保険料負担:",{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#E5E7EB"}).setOrigin(0,.5),i=this.gameInstance.insuranceBurden,a=this.add.text(40,0,i===0?"負担なし":`${i}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:i===0?"#10B981":"#EF4444",fontStyle:"bold"}).setOrigin(.5);a.setShadow(1,1,"#000000",.3,!0,!0),a.setName("burden-value"),this.burdenIndicatorContainer.add([t,e,a])}createInsuranceListDisplay(){this.insuranceListContainer=this.add.container(this.gameWidth-150,250),this.insuranceListContainer.setName("insurance-list");const t=this.add.text(0,0,"有効な保険",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#F9FAFB",fontStyle:"bold"}).setOrigin(.5);t.setShadow(1,1,"#000000",.3,!0,!0),this.insuranceListContainer.add(t),this.updateInsuranceList()}createLifeStageIndicator(){const t=this.add.container(20,70);t.setName("life-stage-indicator");const e=["youth","middle","fulfillment"],i=["青年期","中年期","充実期"],a=[1096065,16096779,10980346],n=e.indexOf(this.gameInstance.stage);e.forEach((o,r)=>{const l=r<=n,c=r===n,g=this.add.circle(r*50,0,c?8:6,l?a[r]:4937059,l?1:.5),f=this.add.text(r*50,15,i[r],{fontFamily:"Noto Sans JP",fontSize:"10px",color:l?"#F9FAFB":"#6B7280",fontStyle:c?"bold":"normal"}).setOrigin(.5),p=r===0?35:r===1?30:27,S=this.add.text(r*50,25,`最大${p}`,{fontFamily:"Noto Sans JP",fontSize:"8px",color:l?"#9CA3AF":"#4B5563"}).setOrigin(.5);if(t.add([g,f,S]),c&&this.tweens.add({targets:g,scale:1.2,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),r<e.length-1){const m=this.add.rectangle(r*50+25,0,20,2,l&&r<n?a[r]:4937059,l&&r<n?1:.3);t.add(m)}})}updateLifeStageIndicator(){const t=this.children.getByName("life-stage-indicator");t&&(t.destroy(),this.createLifeStageIndicator())}createVitalityBar(){this.vitalityBarContainer=this.add.container(this.centerX,65),this.vitalityBarContainer.setName("vitality-bar-container");const t=this.add.rectangle(0,0,this.vitalityBarMaxWidth+4,24,1120295);t.setStrokeStyle(2,8490232),t.setAlpha(.8);const e=this.gameInstance.vitality/this.gameInstance.maxVitality,i=Math.max(0,this.vitalityBarMaxWidth*e);this.vitalityBar=this.add.rectangle(-this.vitalityBarMaxWidth/2,0,i,20,this.getVitalityBarColor(e)),this.vitalityBar.setOrigin(0,.5);const a=this.add.rectangle(-this.vitalityBarMaxWidth/2+this.vitalityBarMaxWidth,0,2,24,8490232);a.setOrigin(.5),this.vitalityBarContainer.add([t,this.vitalityBar,a])}getVitalityBarColor(t){return t>.6?1096065:t>.3?16096779:15680580}createCardAreas(){const t=this.add.container(h.DECK_X_POSITION,h.DECK_Y_POSITION),e=this.add.image(0,0,"card-back"),i=this.add.text(0,70,`${this.gameInstance.playerDeck.size()}`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#333333"});i.setOrigin(.5),i.setName("deck-count"),t.add([e,i]),t.setName("deck-area");const a=this.add.container(h.DISCARD_X_POSITION,h.DISCARD_Y_POSITION),n=this.add.rectangle(0,0,h.CARD_WIDTH,h.CARD_HEIGHT,13421772,.3);n.setStrokeStyle(2,10066329);const o=this.add.text(0,70,"捨て札",{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#666666"}).setOrigin(.5);a.add([n,o]),a.setName("discard-area");const r=this.add.container(this.centerX,h.CHALLENGE_Y_POSITION),l=this.add.rectangle(0,0,h.CARD_WIDTH,h.CARD_HEIGHT,16766011,.3);l.setStrokeStyle(2,16429061);const c=this.add.text(0,-100,"チャレンジ",{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#333333"}).setOrigin(.5);r.add([l,c]),r.setName("challenge-area"),this.initializeDropZones(),this.initializeNewDropZoneSystem()}initializeDropZones(){const t=this.children.getByName("challenge-area");t&&(this.dropZones.set("challenge",t),this.createDropZoneHighlight("challenge",t.x,t.y,h.CARD_WIDTH+20,h.CARD_HEIGHT+20));const e=this.children.getByName("discard-area");e&&(this.dropZones.set("discard",e),this.createDropZoneHighlight("discard",e.x,e.y,h.CARD_WIDTH+20,h.CARD_HEIGHT+20)),this.dragTrail=this.add.graphics(),this.dragTrail.setDepth(900),this.magneticEffect=this.add.graphics(),this.magneticEffect.setDepth(950)}initializeNewDropZoneSystem(){this.dropZoneIntegration=new K(this,this.gameInstance),this.data.events.on("cardSelected",t=>{this.toggleCardSelection(t)})}createDropZoneHighlight(t,e,i,a,n){const o=this.add.graphics();o.setPosition(e,i),o.setAlpha(0),o.setDepth(100),this.dropZoneHighlights.set(t,o)}showDropZoneHighlights(t){this.dropZoneHighlights.forEach((e,i)=>{const a=this.isValidDropZone(i,t),n=a?h.COLORS.DROP_ZONE_VALID:h.COLORS.DROP_ZONE_INVALID,o=a?.3:.15;e.clear();const r=(h.CARD_WIDTH+40)/2;e.fillStyle(n,o),e.fillCircle(0,0,r),e.lineStyle(3,n,.8),e.strokeCircle(0,0,r),this.tweens.add({targets:e,alpha:o*1.5,scaleX:1.1,scaleY:1.1,duration:h.DRAG_DROP.GLOW_PULSE_DURATION/2,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}),this.tweens.add({targets:e,alpha:o,duration:200,ease:"Power2"})})}hideDropZoneHighlights(){this.dropZoneHighlights.forEach(t=>{this.tweens.killTweensOf(t),this.tweens.add({targets:t,alpha:0,scaleX:1,scaleY:1,duration:200,ease:"Power2",onComplete:()=>{t.clear()}})})}isValidDropZone(t,e){if(!e)return!0;switch(t){case"challenge":return this.gameInstance.currentChallenge!==null&&!this.gameInstance.currentChallenge.isCardPlaced;case"discard":return!0;default:return!1}}updateMagneticEffect(t,e){let i=null,a=h.DRAG_DROP.SNAP_DISTANCE;if(this.magneticEffect&&this.magneticEffect.clear(),this.dropZones.forEach((n,o)=>{const r=Phaser.Math.Distance.Between(t,e,n.x,n.y);r<h.DRAG_DROP.SNAP_DISTANCE&&r<a&&(a=r,i=o)}),i&&this.magneticEffect){const n=this.dropZones.get(i);n&&this.isValidDropZone(i)&&(this.magneticEffect.clear(),this.magneticEffect.fillStyle(h.COLORS.MAGNETIC_GLOW,.4),this.magneticEffect.fillCircle(n.x,n.y,(h.CARD_WIDTH+60)/2),this.magneticEffect.lineStyle(3,h.COLORS.MAGNETIC_GLOW,.6),this.magneticEffect.beginPath(),this.magneticEffect.moveTo(t,e),this.magneticEffect.lineTo(n.x,n.y),this.magneticEffect.strokePath())}return i}updateDragTrail(t,e){this.dragTrail&&(this.dragTrail.fillStyle(h.COLORS.DRAG_SHADOW,.2),this.dragTrail.fillCircle(t-5,e+5,30))}createActionButtons(){const t=this.add.container(this.gameWidth-150,150);t.setName("action-buttons");const e=this.createContainerButton(0,0,"カードを引く",()=>this.drawCards(1),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});e.setName("draw-button");const i=this.createContainerButton(0,60,"チャレンジ",()=>this.startChallenge(),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});i.setName("challenge-button");const a=this.createContainerButton(0,120,"ターン終了",()=>this.endTurn(),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});a.setName("end-turn-button"),t.add([e,i,a]),this.updateActionButtons()}startGame(){this.gameInstance.start(),this.drawCards(h.INITIAL_DRAW),this.time.delayedCall(100,()=>{this.updateActionButtons()}),this.updateGameStateForTutorial(),this.shouldStartTutorial&&this.time.delayedCall(500,()=>{this.autoStartTutorial()})}drawCards(t){this.gameInstance.drawCards(t).forEach((i,a)=>{this.time.delayedCall(a*100,()=>{this.createHandCard(i)})}),this.time.delayedCall(t*100+100,()=>{this.arrangeHand(),this.updateGameStateForTutorial()})}createHandCard(t){const e=this.add.container(h.DECK_X_POSITION,h.DECK_Y_POSITION),i=this.add.graphics(),a=this.getCardColor(t.type);i.fillGradientStyle(a.top,a.top,a.bottom,a.bottom,1),i.fillRoundedRect(-60,-80,120,160,12);const n=this.add.rectangle(0,0,116,156,16777215,.1);n.setStrokeStyle(1,16777215,.3);const o=new Phaser.Geom.Rectangle(-60,-80,120,160);e.setInteractive(o,Phaser.Geom.Rectangle.Contains);const r=this.add.text(0,-60,t.name,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#F9FAFB",fontStyle:"bold",wordWrap:{width:100}}).setOrigin(.5);r.setShadow(1,1,"#000000",.5,!0,!0);const l=this.add.circle(-40,60,20,1120295,.8),c=this.add.text(-40,60,`${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#10B981",fontStyle:"bold"}).setOrigin(.5),g=this.add.circle(40,60,18,1120295,.8),f=this.add.text(40,60,`${t.cost}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#F59E0B",fontStyle:"bold"}).setOrigin(.5);let p=null;if(t.type==="insurance"&&t.ageBonus!==void 0&&t.ageBonus>0){const y=this.gameInstance.stage;let T=0;if(y==="middle"?T=.5:y==="fulfillment"&&(T=1),T>0){const B=this.add.circle(0,-60,12,6514417,.9),C=this.add.text(0,-60,`+${T}`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#FFFFFF",fontStyle:"bold"}).setOrigin(.5);p=this.add.container(0,0,[B,C]),p.setAlpha(.8),this.tweens.add({targets:p,alpha:1,scale:1.1,duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}let S=t.power;if(t.type==="insurance"&&t.ageBonus!==void 0){const y=this.gameInstance.stage;let T=1;y==="middle"?T=1.5:y==="fulfillment"&&(T=2),S=Math.floor(t.power*T)}if(S!==t.power){c.setText(`${S}`),c.setColor("#A78BFA");const y=this.add.text(-40,45,`(${t.power})`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#9CA3AF",fontStyle:"normal"}).setOrigin(.5),T=[i,n,r,l,c,y,g,f];p&&T.push(p),e.add(T)}else{const y=[i,n,r,l,c,g,f];p&&y.push(p),e.add(y)}e.setData("card",t),e.setData("selected",!1);const m=this.add.rectangle(0,0,130,170,8490232,0);m.setAlpha(0),e.add(m),e.sendToBack(m),e.setData("glow",m),this.setupCardInteraction(e),this.dropZoneIntegration&&this.dropZoneIntegration.setupCardDragAndDrop(e),this.handCards.push(e)}getCardTemplate(t){switch(t){case"life":return"life-card-template";case"insurance":return"insurance-card-template";case"pitfall":return"pitfall-card-template";default:return"life-card-template"}}getCardColor(t){switch(t){case"life":return{top:6717162,bottom:7752610};case"insurance":return{top:1096065,bottom:366185};case"pitfall":return{top:15680580,bottom:14427686};case"dream":return{top:16569165,bottom:16096779};default:return{top:7041664,bottom:4937059}}}setupCardInteraction(t){t.setData("originalX",t.x),t.setData("originalY",t.y),t.setData("isDragging",!1);const e=t.getData("glow");this.input.setDraggable(t),t.on("pointerover",()=>{!t.getData("selected")&&!t.getData("isDragging")&&(this.tweens.add({targets:t,scaleX:h.CARD_HOVER_SCALE,scaleY:h.CARD_HOVER_SCALE,duration:200,ease:"Power2"}),e&&this.tweens.add({targets:e,alpha:.3,duration:200,ease:"Power2"}))}),t.on("pointerout",()=>{!t.getData("selected")&&!t.getData("isDragging")&&(this.tweens.add({targets:t,scaleX:1,scaleY:1,duration:200,ease:"Power2"}),e&&this.tweens.add({targets:e,alpha:0,duration:200,ease:"Power2"}))}),t.on("pointerdown",i=>{i.rightButtonDown()||(t.setData("dragStartTime",this.time.now),t.setDepth(1e3))}),t.on("pointerup",()=>{const i=t.getData("dragStartTime");!t.getData("isDragging")&&i&&this.time.now-i<200&&this.toggleCardSelection(t),t.setData("isDragging",!1)}),t.on("dragstart",()=>{t.setData("isDragging",!0),this.isDragInProgress=!0,t.setScale(h.DRAG_DROP.DRAG_SCALE),t.setAlpha(h.DRAG_DROP.DRAG_ALPHA),this.showDropZoneHighlights(t),this.dragTrail&&this.dragTrail.clear(),t.getData("selected")&&this.toggleCardSelection(t)}),t.on("drag",(i,a,n)=>{const r=this.scale.orientation===Phaser.Scale.LANDSCAPE||this.scale.orientation===Phaser.Scale.PORTRAIT?-60:0;t.x=a,t.y=n+r,this.updateDragTrail(t.x,t.y);const l=this.updateMagneticEffect(t.x,t.y);if(l&&this.isValidDropZone(l,t)){const c=this.dropZones.get(l);c&&Phaser.Math.Distance.Between(t.x,t.y,c.x,c.y)<h.DRAG_DROP.SNAP_DISTANCE&&this.tweens.add({targets:t,x:c.x,y:c.y,duration:h.DRAG_DROP.SNAP_DURATION,ease:"Power2.out"})}}),t.on("dragend",()=>{this.isDragInProgress=!1,t.setScale(1),t.setAlpha(1),this.hideDropZoneHighlights(),this.magneticEffect&&this.magneticEffect.clear(),this.dragTrail&&this.dragTrail.clear();const i=this.getDropZoneV2(t.x,t.y);i&&this.isValidDropZone(i,t)?this.handleValidDrop(i,t):this.handleInvalidDrop(t),t.setDepth(0)})}toggleCardSelection(t){const e=t.getData("card");if(t.getData("selected")){this.selectedCards.delete(e.id),t.setData("selected",!1),t.setScale(1);const a=t.getByName("highlight");a&&a.destroy()}else{this.selectedCards.add(e.id),t.setData("selected",!0);const a=this.add.image(0,0,"card-highlight");a.setName("highlight"),t.addAt(a,0)}this.gameInstance.currentChallenge&&this.updatePowerDisplay()}arrangeHand(){const e=(this.handCards.length-1)*(h.CARD_WIDTH+h.CARD_SPACING),i=this.centerX-e/2;this.handCards.forEach((a,n)=>{const o=i+n*(h.CARD_WIDTH+h.CARD_SPACING);a.setData("originalX",o),a.setData("originalY",h.HAND_Y_POSITION),this.tweens.add({targets:a,x:o,y:h.HAND_Y_POSITION,duration:h.CARD_MOVE_DURATION,ease:"Power2"})})}startChallenge(){if(this.gameInstance.currentChallenge)return;const t=this.gameInstance.challengeDeck.drawCard();t&&(this.gameInstance.startChallenge(t),this.displayChallengeCard(t),this.updateChallengeUI(),this.updateActionButtons())}endTurn(){this.gameInstance.isInProgress()&&(this.gameInstance.phase==="resolution"||this.gameInstance.phase==="draw")&&(this.checkStageProgress(),this.gameInstance.nextTurn(),this.updateUI(),this.updateActionButtons(),this.updateGameStateForTutorial(),this.checkGameEnd())}updateInsuranceList(){if(!this.insuranceListContainer)return;this.insuranceListContainer.list.filter((i,a)=>a>0).forEach(i=>i.destroy());const e=this.gameInstance.getActiveInsurances();if(e.length===0){const i=this.add.text(0,30,"なし",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#999999"}).setOrigin(.5);this.insuranceListContainer.add(i);return}if(e.forEach((i,a)=>{const n=30+a*35,o=this.add.container(0,n),r=i.durationType==="term"&&i.remainingTurns!==void 0&&i.remainingTurns<=2,l=r&&i.remainingTurns===2,c=r&&i.remainingTurns===1;let g=i.durationType==="whole_life"?16766720:12632256,f=g;l?(g=16753920,f=16753920):c&&(g=16729156,f=16729156);const p=this.add.rectangle(0,0,240,30,g,.2);if(p.setStrokeStyle(2,f),r){const C=c?300:500;this.tweens.add({targets:p,alpha:.3,duration:C,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),p.setFillStyle(g,.3)}let S=i.durationType==="whole_life"?16766720:12632256,m=i.durationType==="whole_life"?"#000000":"#ffffff";l?(S=16753920,m="#000000"):c&&(S=16729156,m="#ffffff");const y=this.add.rectangle(-100,0,40,20,S);y.setStrokeStyle(1,16777215);const T=this.add.text(-100,0,i.durationType==="whole_life"?"終身":"定期",{fontFamily:"Noto Sans JP",fontSize:"10px",color:m,fontStyle:"bold"}).setOrigin(.5),B=this.add.text(-50,0,i.name.length>8?i.name.substring(0,8)+"...":i.name,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#ffffff"}).setOrigin(0,.5);if(i.durationType==="whole_life"){const C=this.gameInstance.stage;let P=0;if(C==="middle"?P=.5:C==="fulfillment"&&(P=1),P>0){const E=this.add.text(50,0,`+${P}`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#4ade80",fontStyle:"bold"}).setOrigin(.5);o.add(E)}}if(i.durationType==="term"&&i.remainingTurns!==void 0){let C="#ffffff";i.remainingTurns===2?C="#FFA500":i.remainingTurns===1&&(C="#FF4444");const P=this.add.text(100,0,`残り${i.remainingTurns}T`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:C,fontStyle:i.remainingTurns<=2?"bold":"normal"}).setOrigin(1,.5);if(i.remainingTurns<=2){const E=i.remainingTurns===1?"#FF4444":"#FFA500",M=this.add.text(115,0,i.remainingTurns===1?"🚨":"⚠",{fontFamily:"Noto Sans JP",fontSize:"14px",color:E}).setOrigin(.5);o.add(M)}o.add(P)}if(o.add([p,y,T,B]),this.insuranceListContainer.add(o),(a+1)%3===0&&a<e.length-1){const C=this.add.rectangle(0,n+20,200,2,16729156,.5);this.insuranceListContainer.add(C)}}),e.length>=3){const i=this.add.text(0,30+e.length*35+10,`⚠ ${Math.floor(e.length/3)}ポイント負担中`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ff4444",fontStyle:"bold"}).setOrigin(.5);this.insuranceListContainer.add(i)}}updateBurdenIndicator(){if(!this.burdenIndicatorContainer)return;const t=this.burdenIndicatorContainer.getByName("burden-value");if(!t)return;const e=this.gameInstance.insuranceBurden,i=parseInt(t.text==="負担なし"?"0":t.text);t.setText(e===0?"負担なし":`${e}`),t.setColor(e===0?"#00ff00":"#ff4444"),e<i&&this.tweens.add({targets:this.burdenIndicatorContainer,scaleX:1.2,scaleY:1.2,duration:200,yoyo:!0,ease:"Power2",onComplete:()=>{var n;const a=(n=this.burdenIndicatorContainer)==null?void 0:n.list[0];a&&(a.setFillStyle(16711680,.8),this.time.delayedCall(300,()=>{a.setFillStyle(0,.7)}))}})}updateUI(){const t=this.children.getByName("vitality-text");if(t){const n=this.getStageDisplayText();t.setText(`活力: ${this.gameInstance.vitality} / ${this.gameInstance.maxVitality} (${n})`)}this.updateVitalityBar();const e=this.children.getByName("turn-text");e&&e.setText(`ターン: ${this.gameInstance.turn}`);const i=this.children.getByName("deck-count");i&&i.setText(`${this.gameInstance.playerDeck.size()}`);const a=this.children.getByName("stage-text");a&&a.setText(this.getStageDisplayText()),this.updateInsuranceList(),this.updateBurdenIndicator()}updateVitalityBar(){if(!this.vitalityBar||!this.vitalityBarContainer)return;const t=this.vitalityBar.getData("currentVitality")||this.gameInstance.vitality,e=this.gameInstance.vitality,i=e/this.gameInstance.maxVitality,a=Math.max(0,this.vitalityBarMaxWidth*i),n=this.getVitalityBarColor(i),o={value:t};if(this.tweens.add({targets:o,value:e,duration:800,ease:"Cubic.out",onUpdate:()=>{const r=this.children.getByName("vitality-text");if(r){const l=this.getStageDisplayText();r.setText(`活力: ${Math.floor(o.value)} / ${this.gameInstance.maxVitality} (${l})`)}}}),this.tweens.add({targets:this.vitalityBar,width:a,duration:800,ease:"Cubic.out",onUpdate:()=>{var c;const r=this.vitalityBar.width/this.vitalityBarMaxWidth,l=this.getVitalityBarColor(r);(c=this.vitalityBar)==null||c.setFillStyle(l)},onComplete:()=>{var r;(r=this.vitalityBar)==null||r.setFillStyle(n)}}),e<t&&this.tweens.add({targets:this.vitalityBarContainer,scaleX:1.05,scaleY:1.05,duration:150,ease:"Power2",yoyo:!0,repeat:1}),e>t){const r=this.add.rectangle(0,0,this.vitalityBarMaxWidth+20,30,1096065,.5);r.setAlpha(0),this.vitalityBarContainer.add(r),this.tweens.add({targets:r,alpha:.6,duration:200,ease:"Power2",yoyo:!0,repeat:1,onComplete:()=>r.destroy()})}this.vitalityBar.setData("currentVitality",e)}updatePowerDisplay(){const t=this.children.getByName("power-display");if(!t)return;const e=this.handCards.filter(l=>this.selectedCards.has(l.getData("card").id)).map(l=>l.getData("card")),i=this.gameInstance.calculateTotalPower(e);t.list.filter(l=>l instanceof Phaser.GameObjects.Text&&l.name!=="power-text"&&l.name!=="count-text").forEach(l=>l.destroy());const n=t.getByName("power-text"),o=t.getByName("count-text");n&&(n.setText(`合計パワー: ${i.total}`),n.setColor(i.total>0?"#00ff00":"#ff4444")),o&&o.setText(`選択カード: ${this.selectedCards.size}枚`);let r=40;if(i.base>0){const l=this.add.text(0,r,`基本: +${i.base}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffffff"}).setOrigin(.5);t.add(l),r+=20}if(i.insurance>0){const l=this.add.text(0,r,`保険: +${i.insurance}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#4ade80"}).setOrigin(.5);t.add(l),r+=20}if(i.burden<0){const l=this.add.text(0,r,`負担: ${i.burden}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ff4444",fontStyle:"bold"}).setOrigin(.5);t.add(l)}}getDropZone(t,e){const i=this.centerX,a=h.CHALLENGE_Y_POSITION;return Phaser.Math.Distance.Between(t,e,i,a)<100?"challenge":null}getDropZoneV2(t,e){let i=null,a=h.DRAG_DROP.SNAP_DISTANCE;return this.dropZones.forEach((n,o)=>{const r=Phaser.Math.Distance.Between(t,e,n.x,n.y);r<a&&(a=r,i=o)}),i}handleValidDrop(t,e){const i=this.dropZones.get(t);if(i)switch(this.tweens.add({targets:e,x:i.x,y:i.y,scaleX:h.DRAG_DROP.DROP_ZONE_SCALE,scaleY:h.DRAG_DROP.DROP_ZONE_SCALE,duration:h.DRAG_DROP.BOUNCE_DURATION/2,ease:"Back.out",onComplete:()=>{this.tweens.add({targets:e,scaleX:1,scaleY:1,duration:h.DRAG_DROP.BOUNCE_DURATION/2,ease:"Elastic.out"})}}),this.showDropSuccessEffect(i.x,i.y),t){case"challenge":this.handleCardDropToChallenge(e);break;case"discard":this.handleCardDropToDiscard(e);break;default:console.warn(`Unknown drop zone: ${t}`)}}handleInvalidDrop(t){const e=t.getData("originalX"),i=t.getData("originalY");this.tweens.add({targets:t,x:t.x+10,duration:h.DRAG_DROP.VIBRATION_DURATION/6,ease:"Power2",yoyo:!0,repeat:5,onComplete:()=>{this.tweens.add({targets:t,x:e,y:i,duration:h.CARD_MOVE_DURATION,ease:"Back.out"})}}),this.showDropFailureEffect(t.x,t.y)}showDropSuccessEffect(t,e){const i=this.add.graphics();i.setPosition(t,e),i.setDepth(1100),i.fillStyle(h.COLORS.DROP_ZONE_VALID,.8),i.fillCircle(0,0,20),this.tweens.add({targets:i,scaleX:3,scaleY:3,alpha:0,duration:500,ease:"Power2.out",onComplete:()=>{i.destroy()}});for(let a=0;a<6;a++){const n=this.add.graphics();n.setPosition(t,e),n.setDepth(1100),n.fillStyle(h.COLORS.DROP_ZONE_VALID,.6),n.fillCircle(0,0,5);const o=a/6*Math.PI*2,r=50;this.tweens.add({targets:n,x:t+Math.cos(o)*r,y:e+Math.sin(o)*r,alpha:0,duration:600,ease:"Power2.out",onComplete:()=>{n.destroy()}})}}showDropFailureEffect(t,e){const i=this.add.graphics();i.setPosition(t,e),i.setDepth(1100),i.lineStyle(4,h.COLORS.DROP_ZONE_INVALID,.8),i.beginPath(),i.moveTo(-15,-15),i.lineTo(15,15),i.moveTo(15,-15),i.lineTo(-15,15),i.strokePath(),this.tweens.add({targets:i,x:t+5,duration:100,ease:"Power2",yoyo:!0,repeat:3}),this.tweens.add({targets:i,alpha:0,duration:800,ease:"Power2.out",onComplete:()=>{i.destroy()}})}handleCardDropToDiscard(t){const e=t.getData("card");this.gameInstance.discardCard(e.id);const i=this.handCards.indexOf(t);i>-1&&(this.handCards.splice(i,1),t.destroy()),this.arrangeHand(),this.updateUI()}handleCardDropToChallenge(t){const e=t.getData("card");if(this.gameInstance.currentChallenge){this.tweens.add({targets:t,x:t.getData("originalX"),y:t.getData("originalY"),duration:h.CARD_MOVE_DURATION,ease:"Power2"});return}this.tweens.add({targets:t,x:this.centerX,y:h.CHALLENGE_Y_POSITION,duration:h.CARD_MOVE_DURATION,ease:"Power2",onComplete:()=>{const i=this.handCards.indexOf(t);i!==-1&&this.handCards.splice(i,1),this.gameInstance.startChallenge(e),this.arrangeHand(),this.showChallengeUI(e)}})}showChallengeUI(t){const e=this.add.container(this.centerX,h.CHALLENGE_Y_POSITION-150),i=this.add.rectangle(0,0,300,60,0,.8),a=this.add.text(0,0,`チャレンジ: ${t.name}
パワー: ${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",align:"center"}).setOrigin(.5);e.add([i,a]),e.setName("challenge-info"),e.setAlpha(0),this.tweens.add({targets:e,alpha:1,duration:300})}displayChallengeCard(t){const e=this.add.container(this.centerX,h.CHALLENGE_Y_POSITION),i=this.add.image(0,0,this.getCardTemplate("life"));i.setTint(16766011);const a=this.add.text(0,-60,t.name,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#333333",fontStyle:"bold",wordWrap:{width:100}}).setOrigin(.5),n=this.add.text(0,20,`${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"36px",color:"#FF0000",fontStyle:"bold"}).setOrigin(.5),o=this.add.text(0,60,t.description,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#666666",wordWrap:{width:100}}).setOrigin(.5);e.add([i,a,n,o]),e.setName("challenge-card"),e.setScale(0),this.tweens.add({targets:e,scale:1.2,duration:500,ease:"Back.easeOut"})}updateChallengeUI(){const t=this.children.getByName("resolve-challenge-button");t&&t.destroy();const e=this.add.container(this.gameWidth-150,300);e.setName("power-display");const i=this.add.rectangle(0,0,200,140,0,.8),a=this.calculateSelectedPower(),n=this.add.text(0,-50,`選択パワー: ${a}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00FF00"});n.setOrigin(.5),n.setName("power-text");const o=this.add.text(0,-20,`選択カード: ${this.selectedCards.size}枚`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffffff"});o.setOrigin(.5),o.setName("count-text"),e.add([i,n,o]),this.updatePowerDisplay(),this.createButton(this.gameWidth-150,400,"チャレンジに挑む",()=>this.resolveChallenge(),{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"}).setName("resolve-challenge-button")}calculateSelectedPower(){let t=0;return this.handCards.forEach(e=>{const i=e.getData("card");this.selectedCards.has(i.id)&&(t+=i.power)}),t}resolveChallenge(){if(!this.gameInstance.currentChallenge)return;this.gameInstance.selectedCards=[],this.handCards.forEach(a=>{const n=a.getData("card");this.selectedCards.has(n.id)&&this.gameInstance.selectedCards.push(n)});const t=this.gameInstance.resolveChallenge(),e=window.__gameState||{};e.lastChallengeResult=t,this.updateGameStateForTutorial(),this.showChallengeResult(t),t.success&&t.cardChoices?this.time.delayedCall(2e3,()=>{this.showInsuranceTypeSelection()}):this.time.delayedCall(2e3,()=>{this.cleanupChallengeUI(),this.updateActionButtons()}),this.handCards=this.handCards.filter(a=>{const n=a.getData("card");return this.selectedCards.has(n.id)?(a.destroy(),!1):!0}),this.selectedCards.clear();const i=this.children.getByName("challenge-card");i&&this.tweens.add({targets:i,scale:0,duration:300,onComplete:()=>i.destroy()}),this.updateUI(),this.arrangeHand()}showChallengeResult(t){const e=this.add.container(this.centerX,this.centerY),i=this.add.rectangle(0,0,500,300,0,.9),a=this.add.text(0,-100,t.success?"チャレンジ成功！":"チャレンジ失敗...",{fontFamily:"Noto Sans JP",fontSize:"28px",color:t.success?"#00FF00":"#FF0000",fontStyle:"bold"}).setOrigin(.5);let n=`チャレンジパワー: ${t.challengePower}

`;t.powerBreakdown?(n+=`あなたのパワー内訳:
`,t.powerBreakdown.base>0&&(n+=`  基本パワー: +${t.powerBreakdown.base}
`),t.powerBreakdown.insurance>0&&(n+=`  保険ボーナス: +${t.powerBreakdown.insurance}
`),t.powerBreakdown.burden<0&&(n+=`  保険料負担: ${t.powerBreakdown.burden}
`),n+=`  合計: ${t.powerBreakdown.total}

`):n+=`あなたのパワー: ${t.playerPower}

`,n+=`活力変化: ${t.vitalityChange>0?"+":""}${t.vitalityChange}`;const o=this.add.text(0,-20,n,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff",align:"center",lineSpacing:5}).setOrigin(.5);if(!t.success&&t.powerBreakdown&&t.powerBreakdown.burden<0&&t.powerBreakdown.base+t.powerBreakdown.insurance>=t.challengePower){const c=this.add.text(0,90,"⚠ 保険料負担により敗北しました",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ff9999",fontStyle:"bold"}).setOrigin(.5);e.add(c)}const r=this.createButton(0,120,"閉じる",()=>{this.tweens.add({targets:e,scale:0,duration:300,onComplete:()=>e.destroy()})},{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff"});e.add([i,a,o,r]),e.setScale(0),this.tweens.add({targets:e,scale:1,duration:500,ease:"Back.easeOut"})}getStageDisplayText(){const t=this.gameInstance.stage,e=V[t].label,i=this.getTurnsInCurrentStage(),a=h.STAGE_TURNS[t];return`${e} (${i}/${a})`}getTurnsInCurrentStage(){const t=this.gameInstance.turn;return this.gameInstance.stage==="youth"?t:this.gameInstance.stage==="middle"?t-h.STAGE_TURNS.youth:t-h.STAGE_TURNS.youth-h.STAGE_TURNS.middle}checkStageProgress(){const t=this.gameInstance.turn,e=this.gameInstance.stage;if(e==="youth"&&t>=h.STAGE_TURNS.youth){const i=this.gameInstance.maxVitality;this.gameInstance.advanceStage(),this.showStageTransition("中年期",i,this.gameInstance.maxVitality),this.updateChallengeDeck()}else if(e==="middle"&&t>=h.STAGE_TURNS.youth+h.STAGE_TURNS.middle){const i=this.gameInstance.maxVitality;this.gameInstance.advanceStage(),this.showStageTransition("充実期",i,this.gameInstance.maxVitality),this.updateChallengeDeck()}}updateChallengeDeck(){this.gameInstance.challengeDeck.clear();const t=v.createChallengeCards(this.gameInstance.stage);this.gameInstance.challengeDeck.addCards(t),this.gameInstance.challengeDeck.shuffle()}showStageTransition(t,e,i){const a=this.add.container(this.centerX,this.centerY),n=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.8),o=this.add.text(0,-80,`${t}へ突入！`,{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),r=this.add.text(0,-20,`体力が衰えました (最大値: ${e} → ${i})`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ff9999"}).setOrigin(.5),l=this.getInsuranceReviewRecommendation(t),c=this.add.text(0,40,l,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00ff00",align:"center"}).setOrigin(.5),g=this.createButton(0,100,"保険を見直す",()=>{this.showInsuranceReviewDialog(),a.destroy()},{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"}),f=this.createButton(0,150,"あとで見直す",()=>{this.tweens.add({targets:a,alpha:0,duration:500,onComplete:()=>a.destroy()})},{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#cccccc"});a.add([n,o,r,c,g,f]),a.setAlpha(0),this.tweens.add({targets:a,alpha:1,duration:500}),o.setScale(0),this.tweens.add({targets:o,scale:1,duration:800,delay:200,ease:"Back.easeOut"}),r.setAlpha(0),this.tweens.add({targets:r,alpha:1,duration:600,delay:500});for(let S=0;S<20;S++){const m=this.add.circle(Phaser.Math.Between(-200,200),Phaser.Math.Between(-150,150),Phaser.Math.Between(2,6),16766720,.8);a.add(m),this.tweens.add({targets:m,alpha:0,scale:1.5,duration:2e3,delay:Phaser.Math.Between(0,1e3),ease:"Power2"})}const p=this.children.getByName("stage-text");p&&p.setText(this.getStageDisplayText()),this.updateLifeStageIndicator(),this.animateMaxVitalityChange()}getInsuranceReviewRecommendation(t){return t==="中年期"?`📌 保険見直しの機会
定期保険から終身保険への変更を検討しましょう`:t==="充実期"?`📌 総合的な保険見直し
終身保険の価値が大幅に上昇します！`:""}showInsuranceReviewDialog(){this.showNotification("保険見直し機能は開発中です","info")}checkExpiringInsurances(){}showExpiringInsuranceWarning(t){const e=this.add.container(this.centerX,300);e.setDepth(2e3);const i=this.add.rectangle(0,0,400,120,16729156,.95);i.setStrokeStyle(3,16777215);const a=this.add.text(-170,0,"⚠",{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),n=this.add.text(20,-20,`${t.name}が
あと${t.remainingTurns}ターンで期限切れです！`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),o=this.add.text(20,20,"更新または終身保険への切り替えを検討しましょう",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffcccc"}).setOrigin(.5);e.add([i,a,n,o]),e.setScale(0),e.setAlpha(0),this.tweens.add({targets:e,scale:1.1,alpha:1,duration:300,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:e,scale:1,duration:800,yoyo:!0,repeat:2,ease:"Sine.easeInOut"}),this.time.delayedCall(5e3,()=>{this.tweens.add({targets:e,scale:.8,alpha:0,duration:500,ease:"Power2",onComplete:()=>e.destroy()})})}})}showInsuranceExpirationWarning(t){const e=t.remainingTurns,i=t.cardName;let a=16753920,n="⚠",o="";e===1?(a=16729156,n="🚨",o="緊急！"):e===2&&(a=16753920,n="⚠",o="警告：");const r=this.add.container(this.centerX,350);r.setDepth(2e3);const l=this.add.rectangle(0,0,450,130,a,.95);l.setStrokeStyle(3,16777215);const c=this.add.text(-190,0,n,{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),g=this.add.text(20,-25,`${o} ${i}が
残り${e}ターンで期限切れです`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",fontStyle:"bold",align:"center"}).setOrigin(.5),f=this.add.text(20,25,"更新手続きまたは終身保険への切り替えをご検討ください",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffcccc"}).setOrigin(.5);r.add([l,c,g,f]),r.setScale(0),r.setAlpha(0);const p=e===1?200:300;this.tweens.add({targets:r,scale:1.1,alpha:1,duration:p,ease:"Back.easeOut",onComplete:()=>{const S=e===1?4:2;this.tweens.add({targets:r,scale:1,duration:e===1?400:600,yoyo:!0,repeat:S,ease:"Sine.easeInOut"});const m=e===1?7e3:5e3;this.time.delayedCall(m,()=>{this.tweens.add({targets:r,scale:.8,alpha:0,duration:500,ease:"Power2",onComplete:()=>r.destroy()})})}})}animateMaxVitalityChange(){if(!this.vitalityBarContainer)return;const t=this.vitalityBarContainer.list[2];t&&this.tweens.add({targets:t,alpha:.3,duration:300,yoyo:!0,repeat:3,ease:"Power2"}),this.tweens.add({targets:this.vitalityBarContainer,y:this.vitalityBarContainer.y-5,duration:100,yoyo:!0,repeat:2,ease:"Power2"}),this.updateUI()}checkGameEnd(){this.gameInstance.isCompleted()?this.gameInstance.status==="victory"?this.showGameEnd(!0):this.gameInstance.status==="game_over"&&this.showGameEnd(!1):this.gameInstance.stage==="fulfillment"&&this.gameInstance.vitality>=h.VICTORY_VITALITY&&(this.gameInstance.status="victory",this.showGameEnd(!0))}showInsuranceTypeSelection(){this.insuranceTypeSelectionUI&&this.insuranceTypeSelectionUI.destroy(),this.insuranceTypeSelectionUI=this.add.container(this.centerX,this.centerY),this.insuranceTypeSelectionUI.setDepth(2e3);const t=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.8);t.setOrigin(.5);const e=this.add.text(0,-200,"保険種別を選択してください",{fontFamily:"Noto Sans JP",fontSize:"36px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),i=this.getInsuranceRecommendation(),a=this.add.text(0,-140,i,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00ff00"}).setOrigin(.5);this.insuranceTypeSelectionUI.add([t,e,a]),this.createInsuranceTypeButton(-180,0,"終身保険",`一生涯の保障
高コスト・高効果`,16766720,"whole_life"),this.createInsuranceTypeButton(180,0,"定期保険",`10ターンの保障
低コスト・標準効果`,12632256,"term");const n=this.insuranceTypeSelectionUI.list.filter(o=>o instanceof Phaser.GameObjects.Container&&o!==t);n.forEach(o=>{o instanceof Phaser.GameObjects.Container&&(o.setScale(0),o.setAlpha(0))}),this.insuranceTypeSelectionUI.setAlpha(0),this.tweens.add({targets:this.insuranceTypeSelectionUI,alpha:1,duration:500,ease:"Power2",onComplete:()=>{n.forEach((o,r)=>{o instanceof Phaser.GameObjects.Container&&this.time.delayedCall(r*200,()=>{this.tweens.add({targets:o,scale:1,alpha:1,duration:500,ease:"Back.easeOut"})})})}})}createInsuranceTypeButton(t,e,i,a,n,o){if(!this.insuranceTypeSelectionUI)return;const r=this.add.container(t,e),l=this.add.rectangle(0,0,300,400,2899536);if(l.setStrokeStyle(4,n),l.setInteractive(),o==="whole_life"){const T=this.add.rectangle(0,0,310,410,n,.2);T.setAlpha(.5),r.addAt(T,0),this.tweens.add({targets:T,alpha:.2,scale:1.05,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}const c=this.add.rectangle(0,-150,280,60,n),g=this.add.text(0,-150,i,{fontFamily:"Noto Sans JP",fontSize:"28px",color:"#000000",fontStyle:"bold"}).setOrigin(.5),f=this.add.text(0,-50,a,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5);(o==="whole_life"?["永続的な保障","パワー +2","コスト +2"]:["期間限定保障","標準パワー","標準コスト"]).forEach((T,B)=>{const C=this.add.text(0,50+B*30,`• ${T}`,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#cccccc"}).setOrigin(.5);r.add(C)});const S=this.add.rectangle(0,280,280,80,0,.5);S.setStrokeStyle(1,6710886);const m=this.add.text(0,280,this.getDetailedInsuranceRecommendation(o),{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#aaaaaa",align:"center",lineSpacing:5,wordWrap:{width:260}}).setOrigin(.5);r.add([S,m]);const y=this.createButton(0,160,"選択する",()=>this.onInsuranceTypeSelected(o),{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"});l.on("pointerover",()=>{r.setScale(1.05),l.setFillStyle(3426654),this.tweens.add({targets:r,y:e-10,duration:200,ease:"Power2"})}),l.on("pointerout",()=>{r.setScale(1),l.setFillStyle(2899536),this.tweens.add({targets:r,y:e,duration:200,ease:"Power2"})}),l.on("pointerdown",()=>{this.onInsuranceTypeSelected(o)}),r.add([l,c,g,f,y]),this.insuranceTypeSelectionUI.add(r)}getInsuranceRecommendation(){switch(this.gameInstance.stage){case"youth":return"💡 青年期は定期保険がおすすめ - コストを抑えて活力に投資";case"middle":return"💡 中年期は終身保険も検討 - 将来への備えを強化";case"fulfillment":return"💡 充実期は終身保険が有利 - 年齢ボーナスで効果最大化";default:return"保険種別を選んでください"}}getDetailedInsuranceRecommendation(t){const e=this.gameInstance.stage;if(t==="whole_life")switch(e){case"youth":return`終身保険は高コストですが、結婚や学資など
人生の基盤となる保障には適しています。
長期的な視点で選択しましょう。`;case"middle":return`中年期の終身保険は+0.5ボーナス付き。
残りの人生を考えると、今が終身保険への
切り替えを検討する良いタイミングです。`;case"fulfillment":return`充実期の終身保険は+1.0ボーナス！
年齢による価値上昇を最大限活用できます。
安定した老後の基盤作りに最適です。`;default:return"永続的な保障を提供します。"}else switch(e){case"youth":return`定期保険は低コストで効率的な選択です。
若い時期は変化も多いため、柔軟に
見直せる定期保険が有利です。`;case"middle":return`定期保険は期限があるため要注意。
10ターン後の更新時にはコストが上がります。
長期的な保障は終身への切り替えも検討を。`;case"fulfillment":return`充実期では終身保険のボーナスが大きいため、
定期保険の相対的価値は下がります。
一時的な保障のみに使用を推奨します。`;default:return"10ターンの期間限定保障です。"}}getAgeAdjustmentDisplay(t){if(!t.challengeCategory)return null;const e=this.gameInstance.stage;let i=0,a=16777215,n="";if(t.challengeCategory==="physical"?e==="middle"?(i=3,a=16751001,n="↑"):e==="fulfillment"&&(i=6,a=16729156,n="↑↑"):t.challengeCategory==="knowledge"&&(e==="middle"?(i=-2,a=10092441,n="↓"):e==="fulfillment"&&(i=-4,a=4521796,n="↓↓")),i===0)return null;const o=this.add.container(60,20),r=this.add.rectangle(0,0,40,25,a,.3);r.setStrokeStyle(1,a);const l=this.add.text(0,0,`${n}${Math.abs(i)}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:`#${a.toString(16).padStart(6,"0")}`,fontStyle:"bold"}).setOrigin(.5);return o.add([r,l]),o}addDifficultyTooltip(t,e){const i=t.list[0];if(!i)return;let a="";const n=this.gameInstance.stage;if(e.challengeCategory==="physical"?(a=`体力系チャレンジ
`,n==="middle"?a+=`中年期: 必要パワー+3
体力の衰えにより難易度上昇`:n==="fulfillment"?a+=`充実期: 必要パワー+6
大幅な体力低下により高難度`:a+=`青年期: 標準難易度
体力が充実している時期`):e.challengeCategory==="knowledge"?(a=`知識系チャレンジ
`,n==="middle"?a+=`中年期: 必要パワー-2
経験の蓄積により容易化`:n==="fulfillment"?a+=`充実期: 必要パワー-4
豊富な知識で大幅に容易化`:a+=`青年期: 標準難易度
経験はまだ浅い時期`):e.challengeCategory==="balanced"&&(a=`複合系チャレンジ
年齢による難易度変化なし
体力と知識のバランスが重要`),!a)return;const o=this.add.container(0,-120);o.setVisible(!1),o.setDepth(1e3);const r=this.add.rectangle(0,0,250,80,0,.9);r.setStrokeStyle(2,16777215);const l=this.add.text(0,0,a,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#ffffff",align:"center",lineSpacing:5}).setOrigin(.5);o.add([r,l]),t.add(o),i.setInteractive(),i.on("pointerover",()=>{o.setVisible(!0),this.tweens.add({targets:o,alpha:1,duration:200})}),i.on("pointerout",()=>{this.tweens.add({targets:o,alpha:0,duration:200,onComplete:()=>o.setVisible(!1)})})}onInsuranceTypeSelected(t){if(!this.insuranceTypeSelectionUI)return;this.selectedInsuranceType=t;const e=t==="whole_life"?"終身保険":"定期保険",i=this.add.text(0,250,`${e}を選択しました`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5);i.setAlpha(0),this.insuranceTypeSelectionUI.add(i),this.tweens.add({targets:i,alpha:1,scale:1.2,duration:300,yoyo:!0,ease:"Power2"}),this.time.delayedCall(1e3,()=>{this.hideInsuranceTypeSelection(()=>{const a=this.generateInsuranceCards(t);this.showCardSelection(a)})})}hideInsuranceTypeSelection(t){this.insuranceTypeSelectionUI&&this.tweens.add({targets:this.insuranceTypeSelectionUI,alpha:0,scale:.8,duration:500,ease:"Power2",onComplete:()=>{var e;(e=this.insuranceTypeSelectionUI)==null||e.destroy(),this.insuranceTypeSelectionUI=void 0,t&&t()}})}generateInsuranceCards(t){return[...v.createExtendedInsuranceCards(this.gameInstance.stage).filter(n=>n.durationType===t)].sort(()=>Math.random()-.5).slice(0,3)}showCardSelection(t){this.cardSelectionUI&&this.cardSelectionUI.destroy(),this.cardSelectionUI=this.add.container(this.centerX,this.centerY),this.cardSelectionUI.setDepth(2e3);const e=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.8);e.setOrigin(.5);const i=this.add.text(0,-200,"保険カードを選択してください",{fontFamily:"Noto Sans JP",fontSize:"32px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),a=this.add.text(0,-150,"1枚選んでデッキに追加されます",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#cccccc"}).setOrigin(.5);this.cardSelectionUI.add([e,i,a]),t.forEach((n,o)=>{this.createSelectableCard(n,o)}),this.cardSelectionUI.setAlpha(0),this.tweens.add({targets:this.cardSelectionUI,alpha:1,duration:500,ease:"Power2"}),this.updateActionButtons()}createSelectableCard(t,e){if(!this.cardSelectionUI)return;const i=220,n=-2*i/2+e*i,o=this.add.container(n,0);o.setScale(1.2);const r=this.add.image(0,0,this.getCardTemplate(t.type));r.setInteractive();const l=this.add.text(0,-80,t.name,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff",fontStyle:"bold",wordWrap:{width:120}}).setOrigin(.5),c=this.add.text(0,-40,t.description,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#cccccc",wordWrap:{width:120},align:"center"}).setOrigin(.5),g=this.add.text(-40,50,`${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#333333",fontStyle:"bold"}).setOrigin(.5);let f;t.coverage&&(f=this.add.text(40,50,`保障:${t.coverage}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#0066cc",fontStyle:"bold"}).setOrigin(.5));let p;if(t.durationType){const y=t.durationType==="whole_life"?"終身":"10ターン";p=this.add.text(0,80,y,{fontFamily:"Noto Sans JP",fontSize:"16px",color:t.durationType==="whole_life"?"#FFD700":"#C0C0C0",fontStyle:"bold"}).setOrigin(.5)}if(t.durationType==="whole_life"){const y=this.add.rectangle(0,0,h.CARD_WIDTH+10,h.CARD_HEIGHT+10,16766720,.3);y.setAlpha(.6),o.addAt(y,0),this.tweens.add({targets:y,alpha:.2,scale:1.1,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}else t.durationType==="term"&&r.setStrokeStyle(3,12632256);const S=this.createButton(0,120,"選択",()=>this.onCardSelected(t),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});r.on("pointerover",()=>{o.setScale(1.3),this.tweens.add({targets:o,y:-20,duration:200,ease:"Power2"})}),r.on("pointerout",()=>{o.setScale(1.2),this.tweens.add({targets:o,y:0,duration:200,ease:"Power2"})}),r.on("pointerdown",()=>{this.onCardSelected(t)});const m=[r,l,c,g,S];f&&m.push(f),p&&m.push(p),o.add(m),this.cardSelectionUI.add(o)}onCardSelected(t){if(!this.cardSelectionUI)return;const a=this.gameInstance.getActiveInsurances().length+1;a%3===0&&this.showInsuranceBurdenWarning(a);const n=this.cardSelectionUI.list.find(o=>o instanceof Phaser.GameObjects.Container&&o.list.some(r=>{var l;return r instanceof Phaser.GameObjects.Image&&((l=r.input)==null?void 0:l.enabled)}));n&&this.tweens.add({targets:n,scaleX:1.1,scaleY:1.1,duration:150,yoyo:!0,ease:"Power2"}),this.gameInstance.selectCard(t.id),this.showCardAcquisitionAnimation(t,()=>{this.hideCardSelection()})}showInsuranceBurdenWarning(t){const e=Math.floor(t/3),i=this.add.container(this.centerX,200);i.setDepth(3500);const a=this.add.rectangle(0,0,450,150,16729156,.95);a.setStrokeStyle(3,16777215);const n=this.add.text(-180,0,"🚨",{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),o=this.add.text(20,-30,"保険料負担が発生します！",{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),r=this.add.text(20,10,`保険${t}枚目で負担が${e}ポイントに増加します`,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffcccc"}).setOrigin(.5),l=this.add.text(20,40,"本当に必要な保険か、もう一度考えましょう",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffffff"}).setOrigin(.5);i.add([a,n,o,r,l]),i.setScale(0),i.setAlpha(0),this.tweens.add({targets:i,scale:1.2,alpha:1,duration:300,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:i,angle:-5,duration:100,yoyo:!0,repeat:3,ease:"Sine.easeInOut",onComplete:()=>{this.time.delayedCall(3e3,()=>{this.tweens.add({targets:i,scale:.8,alpha:0,duration:500,ease:"Power2",onComplete:()=>i.destroy()})})}})}});const c=this.add.rectangle(this.centerX,this.centerY,this.gameWidth,this.gameHeight,16711680,.3);c.setDepth(3e3),this.tweens.add({targets:c,alpha:0,duration:200,onComplete:()=>c.destroy()})}showCardAcquisitionAnimation(t,e){const i=this.add.container(this.centerX,this.centerY);i.setDepth(3e3);const a=this.add.image(0,0,this.getCardTemplate(t.type));a.setScale(2);const n=this.add.text(0,-100,t.name,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),o=this.add.text(0,120,"デッキに追加されました！",{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5);i.add([a,n,o]),this.tweens.add({targets:i,scale:1.1,duration:300,yoyo:!0,repeat:1,ease:"Power2",onComplete:()=>{this.tweens.add({targets:i,alpha:0,scale:.5,duration:800,ease:"Power2",onComplete:()=>{i.destroy(),e()}})}})}hideCardSelection(){this.cardSelectionUI&&this.tweens.add({targets:this.cardSelectionUI,alpha:0,scale:.8,duration:500,ease:"Power2",onComplete:()=>{var t;(t=this.cardSelectionUI)==null||t.destroy(),this.cardSelectionUI=void 0,this.cleanupChallengeUI(),this.updateUI(),this.updateActionButtons()}})}updateGameStateForTutorial(){const t={hand:this.gameInstance.hand,selectedCards:this.gameInstance.selectedCards,phase:this.gameInstance.phase,turn:this.gameInstance.turn,vitality:this.gameInstance.vitality,maxVitality:this.gameInstance.maxVitality,insuranceCards:this.gameInstance.insuranceCards,config:this.gameInstance.config,lastChallengeResult:null};window.__gameState=t,this.data.set("gameState",t)}updateActionButtons(){const t=this.children.getByName("action-buttons");if(!t)return;const e=t.getByName("draw-button"),i=t.getByName("challenge-button"),a=t.getByName("end-turn-button"),n=this.gameInstance.phase,o=this.gameInstance.isInProgress();e&&this.setButtonEnabled(e,o&&n==="draw"),i&&this.setButtonEnabled(i,o&&n==="draw"&&!this.gameInstance.currentChallenge),a&&this.setButtonEnabled(a,o&&(n==="draw"||n==="resolution"))}createContainerButton(t,e,i,a,n){const o=this.add.container(t,e),r=this.add.rectangle(0,0,150,40,3447003);r.setInteractive({useHandCursor:!0});const l=this.add.text(0,0,i,n||{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});return l.setOrigin(.5),o.add([r,l]),r.on("pointerdown",a),r.on("pointerover",()=>{r.setFillStyle(2719929),o.setScale(1.05)}),r.on("pointerout",()=>{r.setFillStyle(3447003),o.setScale(1)}),o}setButtonEnabled(t,e){if(!t||!t.list||t.list.length<2){console.warn("Invalid button structure");return}const i=t.list[0],a=t.list[1];if(!i||!a){console.warn("Button components not found");return}e?(i.setFillStyle(3447003),a.setColor("#ffffff"),i.setInteractive()):(i.setFillStyle(9807270),a.setColor("#cccccc"),i.disableInteractive())}cleanupChallengeUI(){const t=this.children.getByName("power-display");t&&t.destroy();const e=this.children.getByName("resolve-challenge-button");e&&e.destroy();const i=this.children.getByName("challenge-info");i&&i.destroy()}showGameEnd(t){const e=this.add.container(this.centerX,this.centerY),i=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.9),a=this.add.text(0,-100,t?"人生充実！":"ゲームオーバー",{fontFamily:"Noto Sans JP",fontSize:"48px",color:t?"#FFD43B":"#FF6B6B",fontStyle:"bold"}).setOrigin(.5),n=this.gameInstance.stats,o=this.add.text(0,0,`最終活力: ${this.gameInstance.vitality}
総ターン数: ${n.turnsPlayed}
チャレンジ成功数: ${n.successfulChallenges}/${n.totalChallenges}
最高活力: ${n.highestVitality}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5),r=this.createButton(-100,100,"もう一度",()=>{this.scene.restart()},{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"}),l=this.createButton(100,100,"メニューへ",()=>{this.scene.start("MainMenuScene")},{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"});e.add([i,a,o,r,l]),e.setDepth(1e3),e.setAlpha(0),this.tweens.add({targets:e,alpha:1,duration:1e3})}showNotification(t,e="info"){const i=this.add.container(this.centerX,200);i.setDepth(2500);const a={info:3447003,warning:15965202,success:3066993},n=this.add.rectangle(0,0,400,60,a[e],.9);n.setStrokeStyle(2,16777215);const o=this.add.text(0,0,t,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);i.add([n,o]),i.setScale(0),i.setAlpha(0),this.tweens.add({targets:i,scale:1,alpha:1,duration:300,ease:"Back.easeOut",onComplete:()=>{this.time.delayedCall(3e3,()=>{this.tweens.add({targets:i,scale:.8,alpha:0,duration:300,ease:"Power2",onComplete:()=>i.destroy()})})}})}showInsuranceRenewalDialog(t){console.warn("showInsuranceRenewalDialog: 保険更新システムが削除されました")}createRenewalButton(t,e,i,a,n,o,r){if(!this.insuranceRenewalDialogUI)return;const l=this.add.container(t,e),c=this.add.rectangle(0,0,250,100,n);c.setStrokeStyle(3,r?16777215:6710886),r&&c.setInteractive();const g=this.add.text(0,-15,i,{fontFamily:"Noto Sans JP",fontSize:"20px",color:r?"#ffffff":"#666666",fontStyle:"bold"}).setOrigin(.5),f=this.add.text(0,15,a,{fontFamily:"Noto Sans JP",fontSize:"14px",color:r?"#ffffff":"#666666"}).setOrigin(.5);r&&(c.on("pointerover",()=>{l.setScale(1.05),c.setFillStyle(Phaser.Display.Color.ValueToColor(n).brighten(20).color)}),c.on("pointerout",()=>{l.setScale(1),c.setFillStyle(n)}),c.on("pointerdown",()=>{l.setScale(.95),this.time.delayedCall(100,()=>{l.setScale(1),o()})})),l.add([c,g,f]),this.insuranceRenewalDialogUI.add(l)}onRenewalSelected(t,e){this.insuranceRenewalDialogUI&&this.tweens.add({targets:this.insuranceRenewalDialogUI,alpha:0,scale:.8,duration:300,ease:"Power2",onComplete:()=>{var i;(i=this.insuranceRenewalDialogUI)==null||i.destroy(),this.insuranceRenewalDialogUI=void 0}});try{let i;e?i=this.gameInstance.renewInsurance(t.cardId):i=this.gameInstance.expireInsurance(t.cardId);const a=i.action==="renewed"?"success":"warning";this.showNotification(i.message,a),this.time.delayedCall(500,()=>{this.updateInsuranceDisplay(),this.updateVitalityDisplay(),this.checkForAdditionalRenewals()})}catch(i){console.error("Insurance renewal error:",i),this.showNotification("保険処理でエラーが発生しました","error")}}getAgeIncreaseReason(){switch(this.gameInstance.stage){case"youth":return"青年期のため基本コストで更新可能";case"middle":return"中年期のため更新コストが増加 (+2)";case"fulfillment":return"充実期のため更新コストが大幅増加 (+4)";default:return"年齢に応じてコストが調整されます"}}checkForAdditionalRenewals(){}initializeTutorial(){try{this.tutorialManager=new J(this,{debugMode:!1,autoSaveProgress:!0,stepChangeDelay:500,defaultHighlightOptions:{color:"#FFD700",opacity:.4,borderWidth:3,borderColor:"#FFA500",glowEffect:!0,animationType:"pulse",duration:1200}}),this.tutorialOverlay=new X(this),this.tutorialOverlay.setVisible(!1),this.registerTutorialElements(),this.setupTutorialEventListeners()}catch(t){console.error("Tutorial initialization failed:",t)}}registerTutorialElements(){this.handCards.length>0&&this.tutorialStepElements.set("hand-area",this.handCards[0].parentContainer||this.handCards[0]),this.vitalityBarContainer&&this.tutorialStepElements.set("vitality-bar",this.vitalityBarContainer),this.insuranceListContainer&&this.tutorialStepElements.set("insurance-list",this.insuranceListContainer),this.burdenIndicatorContainer&&this.tutorialStepElements.set("burden-indicator",this.burdenIndicatorContainer)}setupTutorialEventListeners(){this.tutorialManager&&(this.tutorialManager.on("tutorial:started",t=>{var e;this.isTutorialMode=!0,(e=this.tutorialOverlay)==null||e.setVisible(!0)}),this.tutorialManager.on("tutorial:step:enter",t=>{this.handleTutorialStepEnter(t)}),this.tutorialManager.on("tutorial:step:exit",()=>{var t;(t=this.tutorialOverlay)==null||t.clearHighlights()}),this.tutorialManager.on("tutorial:completed",()=>{this.endTutorialMode()}),this.tutorialManager.on("tutorial:skipped",()=>{this.endTutorialMode()}),this.tutorialManager.on("tutorial:error",t=>{console.error("Tutorial error:",t.error),this.endTutorialMode()}),this.scale.on("resize",()=>{var t;(t=this.tutorialOverlay)==null||t.onResize()}))}handleTutorialStepEnter(t){var l;if(!this.tutorialOverlay||!this.tutorialManager)return;const e=this.tutorialManager.getCurrentStep();if(!e)return;const i=this.tutorialManager.getProgress();if(!i)return;const a=this.tutorialManager.getCurrentStep()&&((l=this.tutorialManager.currentConfig)==null?void 0:l.steps.length)||0;this.tutorialOverlay.createProgressBar(i,a);let n;if(e.targetElement){const c=this.tutorialStepElements.get(e.targetElement)||this.children.getByName(e.targetElement);c&&c.getBounds&&(n=c.getBounds(),this.tutorialOverlay.createSpotlight(c),this.tutorialOverlay.highlightElement(e.targetElement,e.highlightOptions))}this.tutorialOverlay.createSpeechBubble(e,n);const o=i.currentStepIndex>0;this.tutorialOverlay.createControlButtons(o,!0,()=>{var c;return(c=this.tutorialManager)==null?void 0:c.nextStep()},o?()=>{var c;return(c=this.tutorialManager)==null?void 0:c.previousStep()}:void 0,()=>{var c;return(c=this.tutorialManager)==null?void 0:c.skipTutorial()}),this.tutorialOverlay.enableKeyboardControls(()=>{var c;return(c=this.tutorialManager)==null?void 0:c.nextStep()},o?()=>{var c;return(c=this.tutorialManager)==null?void 0:c.previousStep()}:void 0,()=>{var c;return(c=this.tutorialManager)==null?void 0:c.skipTutorial()}),e.action==="wait"&&e.waitTime&&this.time.delayedCall(e.waitTime,()=>{var c;(c=this.tutorialManager)==null||c.nextStep()})}endTutorialMode(){this.isTutorialMode=!1,this.tutorialOverlay&&(this.tutorialOverlay.setVisible(!1),this.tutorialOverlay.clearHighlights()),this.enableAllGameUI()}autoStartTutorial(){this.startTutorial(Y).then(()=>{}).catch(t=>{console.error("Failed to start tutorial:",t)})}startTutorial(t){return this.tutorialManager?this.tutorialManager.isCompleted(t.id)?Promise.resolve():(this.applyTutorialModeRestrictions(),this.tutorialManager.startTutorial(t)):Promise.reject(new Error("Tutorial manager not initialized"))}applyTutorialModeRestrictions(){this.isDragInProgress=!1,this.disableNonTutorialUI()}disableNonTutorialUI(){}enableAllGameUI(){}registerTutorialElement(t,e){this.tutorialStepElements.set(t,e)}isTutorialActive(){return this.isTutorialMode}getCurrentTutorialStep(){var t;return((t=this.tutorialManager)==null?void 0:t.getCurrentStep())||null}stopTutorial(){this.tutorialManager&&this.tutorialManager.skipTutorial()}destroy(){this.dropZoneIntegration&&(this.dropZoneIntegration.destroy(),this.dropZoneIntegration=void 0),this.data.events.off("cardSelected"),super.destroy()}}const b=class b{constructor(){d(this,"game",null)}static getInstance(){return b.instance||(b.instance=new b),b.instance}initialize(s){if(!this.game)try{const t=x({},Z);t.parent=s,t.scene=[$,W,q],this.game=new A.Game(t)}catch(t){throw console.error("❌ GameManager: ゲーム初期化エラー:",t),t}}destroy(){this.game&&(this.game.destroy(!0,!1),this.game=null)}isInitialized(){return this.game!==null}getCurrentScene(){if(!this.game)return null;const s=this.game.scene.getScenes(!0);return s.length>0?s[0].scene.key:null}switchScene(s,t){if(!this.game)return;const e=this.game.scene.getScenes(!0)[0];e&&e.scene.start(s,t)}reset(){this.game&&(this.game.scene.getScenes(!0).forEach(s=>{s.scene.stop()}),this.game.scene.start("PreloadScene"))}};d(b,"instance",null);let k=b;export{k as GameManager};
//# sourceMappingURL=game-engine-CjfMJf0y.js.map
