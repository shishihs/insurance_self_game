{"version":3,"file":"game-logic-CwgPnIiMkXiN.js","sources":["../../src/domain/entities/Deck.ts","../../src/domain/valueObjects/CardPower.ts","../../src/domain/valueObjects/InsurancePremium.ts","../../src/common/IdGenerator.ts","../../src/domain/entities/Card.ts","../../src/domain/constants/insurance.constants.ts","../../src/domain/entities/RiskRewardChallenge.ts","../../src/domain/services/CardFactory.ts","../../src/domain/services/CardManager.ts","../../src/domain/valueObjects/RiskFactor.ts","../../src/domain/valueObjects/RiskProfile.ts","../../src/domain/services/InsurancePremiumCalculationService.ts","../../src/domain/constants/GameConstants.ts","../../src/domain/services/GameStageManager.ts","../../src/domain/services/InsuranceExpirationManager.ts","../../src/domain/types/game.types.ts","../../src/domain/services/ChallengeResolutionService.ts","../../src/domain/services/GameTurnManager.ts","../../src/domain/services/GameChallengeService.ts","../../src/domain/services/GameInsuranceService.ts","../../src/domain/services/AIStrategyService.ts","../../src/domain/services/GameStateManager.ts","../../src/domain/services/GameActionProcessor.ts","../../src/domain/valueObjects/Vitality.ts","../../src/domain/entities/Game.ts"],"sourcesContent":["import type { Card } from './Card'\nimport type { CardType } from '../types/card.types'\n\n/**\n * ãƒ‡ãƒƒã‚­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£\n */\nexport class Deck {\n  private cards: Card[]\n  private readonly name: string\n\n  constructor(name: string, cards: Card[] = []) {\n    this.name = name\n    this.cards = [...cards]\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­åã‚’å–å¾—\n   */\n  getName(): string {\n    return this.name\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰æšæ•°ã‚’å–å¾—\n   */\n  size(): number {\n    return this.cards.length\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­ãŒç©ºã‹ã©ã†ã‹\n   */\n  isEmpty(): boolean {\n    return this.cards.length === 0\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n   */\n  addCard(card: Card): void {\n    // V3.3 Debug: Trace Dream Card Leak\n    if (this.name === 'Player Deck' && (card.type === 'dream' || card.power >= 25)) {\n      console.warn(`[Deck: ${this.name}] ğŸš¨ SUSPICIOUS ADDITION DETECTED ğŸš¨: ${card.name} (Type: ${card.type}, Power: ${card.power})`)\n      // console.trace() // Trace stack to find the culprit\n    }\n    this.cards.push(card)\n  }\n\n  /**\n   * è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n   */\n  addCards(cards: Card[]): void {\n    // V3.3 Debug: Trace Dream Card Leak\n    if (this.name === 'Player Deck') {\n      const suspicious = cards.filter(c => c.type === 'dream' || c.power >= 25)\n      if (suspicious.length > 0) {\n        console.warn(`[Deck: ${this.name}] ğŸš¨ SUSPICIOUS BATCH ADDITION ğŸš¨:`, suspicious.map(c => `${c.name} (${c.type})`))\n        // console.trace()\n      }\n    }\n    this.cards.push(...cards)\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’ä¸Šã‹ã‚‰å¼•ã\n   */\n  drawCard(): Card | null {\n    return this.cards.pop() || null\n  }\n\n  /**\n   * è¤‡æ•°æšã®ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã\n   */\n  drawCards(count: number): Card[] {\n    const drawn: Card[] = []\n    for (let i = 0; i < count && !this.isEmpty(); i++) {\n      const card = this.drawCard()\n      if (card) drawn.push(card)\n    }\n    return drawn\n  }\n\n  /**\n   * ç‰¹å®šã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤\n   */\n  removeCard(cardId: string): boolean {\n    const index = this.cards.findIndex(card => card.id === cardId)\n    if (index !== -1) {\n      this.cards.splice(index, 1)\n      return true\n    }\n    return false\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yatesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰\n   */\n  shuffle(): void {\n    for (let i = this.cards.length - 1; i > 0; i--) {\n      const j = Math.floor(Math.random() * (i + 1));\n      [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]]\n    }\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­ã®ä¸­èº«ã‚’ç¢ºèªï¼ˆã‚³ãƒ”ãƒ¼ã‚’è¿”ã™ï¼‰\n   */\n  getCards(): Card[] {\n    return [...this.cards]\n  }\n\n  /**\n   * ç‰¹å®šã®ã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ãƒ‰æšæ•°ã‚’å–å¾—\n   */\n  countCardsByType(type: CardType): number {\n    return this.cards.filter(card => card.type === type).length\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­ã‚’ã‚¯ãƒªã‚¢\n   */\n  clear(): void {\n    this.cards = []\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ\n   */\n  clone(): Deck {\n    return new Deck(\n      this.name,\n      this.cards.map(card => card.clone())\n    )\n  }\n\n  /**\n   * ãƒ‡ãƒƒã‚­ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—\n   */\n  getStats(): {\n    total: number\n    byType: Record<CardType, number>\n    averagePower: number\n    averageCost: number\n  } {\n    const stats = {\n      total: this.cards.length,\n      byType: {\n        life: 0,\n        insurance: 0,\n        pitfall: 0\n      } as Record<CardType, number>,\n      averagePower: 0,\n      averageCost: 0\n    }\n\n    let totalPower = 0\n    let totalCost = 0\n\n    this.cards.forEach(card => {\n      stats.byType[card.type]++\n      totalPower += card.power\n      totalCost += card.cost\n    })\n\n    stats.averagePower = stats.total > 0 ? totalPower / stats.total : 0\n    stats.averageCost = stats.total > 0 ? totalCost / stats.total : 0\n\n    return stats\n  }\n}","/**\n * ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼ã‚’è¡¨ã™å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n * \n * ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ã‚ã‚Šã€ã™ã¹ã¦ã®æ“ä½œã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚\n * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼š\n * - ãƒ‘ãƒ¯ãƒ¼ã¯-99ä»¥ä¸Šã€999ä»¥ä¸‹ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ãªäººç”Ÿã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼‰\n * - æ¼”ç®—çµæœãŒç¯„å›²ã‚’è¶…ãˆã‚‹å ´åˆã¯ç¯„å›²å†…ã«åˆ¶é™ã•ã‚Œã‚‹\n */\nexport class CardPower {\n  private static readonly MIN_POWER = -99\n  private static readonly MAX_POWER = 999\n\n  private constructor(private readonly value: number) {\n    this.validate()\n  }\n\n  /**\n   * CardPower ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹\n   * @param value ãƒ‘ãƒ¯ãƒ¼å€¤\n   * @throws {Error} ä¸æ­£ãªå€¤ã®å ´åˆ\n   */\n  static create(value: number): CardPower {\n    return new CardPower(value)\n  }\n\n  /**\n   * å€¤ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼ã™ã‚‹\n   * @private\n   */\n  private validate(): void {\n    if (this.value < CardPower.MIN_POWER) {\n      throw new Error(`CardPower must be at least ${CardPower.MIN_POWER}`)\n    }\n    if (this.value > CardPower.MAX_POWER) {\n      throw new Error('Card power cannot exceed maximum')\n    }\n  }\n\n  /**\n   * ãƒ‘ãƒ¯ãƒ¼å€¤ã‚’å–å¾—\n   */\n  getValue(): number {\n    return this.value\n  }\n\n  /**\n   * ä»–ã®CardPowerã¨åŠ ç®—\n   * @param other åŠ ç®—ã™ã‚‹CardPower\n   * @returns æ–°ã—ã„CardPowerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   */\n  add(other: CardPower): CardPower {\n    const sum = this.value + other.value\n    return new CardPower(Math.max(CardPower.MIN_POWER, Math.min(sum, CardPower.MAX_POWER)))\n  }\n\n  /**\n   * è¤‡æ•°ã®CardPowerã‚’åˆè¨ˆ\n   * @param powers CardPowerã®é…åˆ—\n   * @returns åˆè¨ˆã®CardPower\n   */\n  static sum(powers: CardPower[]): CardPower {\n    const total = powers.reduce((sum, power) => sum + power.value, 0)\n    return new CardPower(Math.max(CardPower.MIN_POWER, Math.min(total, CardPower.MAX_POWER)))\n  }\n\n  /**\n   * å€ç‡ã‚’é©ç”¨\n   * @param multiplier å€ç‡ï¼ˆ0ä»¥ä¸Šï¼‰\n   * @returns æ–°ã—ã„CardPowerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @throws {Error} å€ç‡ãŒè² ã®å ´åˆ\n   */\n  multiply(multiplier: number): CardPower {\n    if (multiplier < 0) {\n      throw new Error('Multiplier cannot be negative')\n    }\n    const result = Math.floor(this.value * multiplier)\n    return new CardPower(Math.max(CardPower.MIN_POWER, Math.min(result, CardPower.MAX_POWER)))\n  }\n\n  /**\n   * ä»–ã®CardPowerã‚ˆã‚Šå¤§ãã„ã‹åˆ¤å®š\n   */\n  isGreaterThan(other: CardPower): boolean {\n    return this.value > other.value\n  }\n\n  /**\n   * ä»–ã®CardPowerä»¥ä¸Šã‹åˆ¤å®š\n   */\n  isGreaterThanOrEqual(other: CardPower): boolean {\n    return this.value >= other.value\n  }\n\n  /**\n   * ä»–ã®CardPowerã¨ç­‰ä¾¡ã‹åˆ¤å®š\n   */\n  equals(other: CardPower): boolean {\n    return this.value === other.value\n  }\n\n  /**\n   * æ–‡å­—åˆ—è¡¨ç¾ã‚’å–å¾—\n   */\n  toString(): string {\n    return `Power: ${this.value}`\n  }\n\n  /**\n   * ã‚¼ãƒ­ãƒ‘ãƒ¯ãƒ¼ã®å®šæ•°\n   */\n  static get ZERO(): CardPower {\n    return new CardPower(0)\n  }\n\n  /**\n   * æœ€å¤§ãƒ‘ãƒ¯ãƒ¼ã®å®šæ•°\n   */\n  static get MAX(): CardPower {\n    return new CardPower(CardPower.MAX_POWER)\n  }\n}","/**\n * ä¿é™ºæ–™ã‚’è¡¨ã™å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n * \n * ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ã‚ã‚Šã€ã™ã¹ã¦ã®æ“ä½œã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚\n * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼š\n * - ä¿é™ºæ–™ã¯0ä»¥ä¸Šã€99ä»¥ä¸‹ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„\n * - 0ã¯ç„¡æ–™ä¿é™ºã‚’è¡¨ã™\n * - 20ä»¥ä¸Šã¯é«˜é¡ä¿é™ºæ–™ã¨ã¿ãªã•ã‚Œã‚‹\n */\nexport class InsurancePremium {\n  private static readonly MIN_PREMIUM = 0\n  private static readonly MAX_PREMIUM = 99\n  private static readonly EXPENSIVE_THRESHOLD = 20\n\n  private constructor(private readonly value: number) {\n    this.validate()\n  }\n\n  /**\n   * InsurancePremium ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹\n   * @param value ä¿é™ºæ–™å€¤\n   * @throws {Error} ä¸æ­£ãªå€¤ã®å ´åˆ\n   */\n  static create(value: number): InsurancePremium {\n    return new InsurancePremium(Math.floor(value))\n  }\n\n  /**\n   * å€¤ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼ã™ã‚‹\n   * @private\n   */\n  private validate(): void {\n    if (this.value < InsurancePremium.MIN_PREMIUM) {\n      throw new Error('InsurancePremium must be non-negative')\n    }\n    if (this.value > InsurancePremium.MAX_PREMIUM) {\n      throw new Error('InsurancePremium cannot exceed maximum')\n    }\n  }\n\n  /**\n   * ä¿é™ºæ–™å€¤ã‚’å–å¾—\n   */\n  getValue(): number {\n    return this.value\n  }\n\n  /**\n   * è¤‡æ•°ã®ä¿é™ºæ–™ã‚’åˆè¨ˆ\n   * @param premiums InsurancePremiumã®é…åˆ—\n   * @returns åˆè¨ˆã®ä¿é™ºæ–™\n   */\n  static sum(premiums: InsurancePremium[]): InsurancePremium {\n    const total = premiums.reduce((sum, premium) => sum + premium.value, 0)\n    return new InsurancePremium(Math.min(total, InsurancePremium.MAX_PREMIUM))\n  }\n\n  /**\n   * å‰²å¼•ç‡ã‚’é©ç”¨\n   * @param discountRate å‰²å¼•ç‡ï¼ˆ0.0ã€œ1.0ï¼‰\n   * @returns æ–°ã—ã„InsurancePremiumã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @throws {Error} å‰²å¼•ç‡ãŒä¸æ­£ãªå ´åˆ\n   */\n  applyDiscount(discountRate: number): InsurancePremium {\n    if (discountRate < 0) {\n      throw new Error('Discount rate cannot be negative')\n    }\n    if (discountRate > 1) {\n      throw new Error('Discount rate cannot exceed 100%')\n    }\n    \n    const discountedValue = Math.floor(this.value * (1 - discountRate))\n    return new InsurancePremium(discountedValue)\n  }\n\n  /**\n   * å€ç‡ã‚’é©ç”¨\n   * @param multiplier å€ç‡ï¼ˆ0ä»¥ä¸Šï¼‰\n   * @returns æ–°ã—ã„InsurancePremiumã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @throws {Error} å€ç‡ãŒè² ã®å ´åˆ\n   */\n  applyMultiplier(multiplier: number): InsurancePremium {\n    if (multiplier < 0) {\n      throw new Error('Multiplier cannot be negative')\n    }\n    \n    const multipliedValue = Math.floor(this.value * multiplier)\n    return new InsurancePremium(Math.min(multipliedValue, InsurancePremium.MAX_PREMIUM))\n  }\n\n  /**\n   * ç„¡æ–™ä¿é™ºã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isFree(): boolean {\n    return this.value === 0\n  }\n\n  /**\n   * é«˜é¡ä¿é™ºæ–™ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isExpensive(): boolean {\n    return this.value >= InsurancePremium.EXPENSIVE_THRESHOLD\n  }\n\n  /**\n   * ä»–ã®ä¿é™ºæ–™ã‚ˆã‚Šé«˜ã„ã‹åˆ¤å®š\n   */\n  isHigherThan(other: InsurancePremium): boolean {\n    return this.value > other.value\n  }\n\n  /**\n   * æŒ‡å®šã•ã‚ŒãŸæ´»åŠ›ã§è² æ‹…å¯èƒ½ã‹åˆ¤å®š\n   * @param availableVitality åˆ©ç”¨å¯èƒ½ãªæ´»åŠ›\n   */\n  isAffordableWith(availableVitality: number): boolean {\n    return availableVitality >= this.value\n  }\n\n  /**\n   * ä»–ã®InsurancePremiumã¨ç­‰ä¾¡ã‹åˆ¤å®š\n   */\n  equals(other: InsurancePremium): boolean {\n    return this.value === other.value\n  }\n\n  /**\n   * æ–‡å­—åˆ—è¡¨ç¾ã‚’å–å¾—\n   */\n  toString(): string {\n    if (this.isFree()) {\n      return 'ä¿é™ºæ–™: ç„¡æ–™'\n    }\n    return `ä¿é™ºæ–™: ${this.value}`\n  }\n\n  /**\n   * ç„¡æ–™ä¿é™ºã®å®šæ•°\n   */\n  static get FREE(): InsurancePremium {\n    return new InsurancePremium(0)\n  }\n}","/**\n * çµ±ä¸€ã•ã‚ŒãŸIDç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£\n * \n * ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ä¸€è²«ã—ãŸIDç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã—ã€\n * é‡è¤‡ã‚³ãƒ¼ãƒ‰ã‚’æ’é™¤ã—ã¾ã™ã€‚\n */\nexport class IdGenerator {\n  private static counter = 0\n  \n  /**\n   * æ±ç”¨çš„ãªãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ\n   * @param prefix ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆä¾‹: 'card', 'game', 'cmd'ï¼‰\n   * @returns ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDæ–‡å­—åˆ—\n   */\n  static generate(prefix: string = 'id'): string {\n    return `${prefix}_${Date.now()}_${this.getRandomString()}`\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ç”¨IDã‚’ç”Ÿæˆ\n   */\n  static generateCardId(): string {\n    return this.generate('card')\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ ç”¨IDã‚’ç”Ÿæˆ\n   */\n  static generateGameId(): string {\n    return this.generate('game')\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ç”¨IDã‚’ç”Ÿæˆ\n   */\n  static generateCommandId(): string {\n    return this.generate('cmd')\n  }\n\n  /**\n   * é€šçŸ¥ç”¨IDã‚’ç”Ÿæˆ\n   */\n  static generateNotificationId(): string {\n    return this.generate('notification')\n  }\n\n  /**\n   * ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨IDã‚’ç”Ÿæˆ\n   */\n  static generateFeedbackId(): string {\n    return this.generate('feedback')\n  }\n\n  /**\n   * é€£ç•ªä»˜ãIDã‚’ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆæ™‚ã®äºˆæ¸¬å¯èƒ½æ€§ã®ãŸã‚ï¼‰\n   */\n  static generateSequential(prefix: string = 'seq'): string {\n    return `${prefix}_${++this.counter}`\n  }\n\n  /**\n   * UUIDãƒ©ã‚¤ã‚¯ãªIDã‚’ç”Ÿæˆï¼ˆã‚ˆã‚Šå¼·å›ºãªä¸€æ„æ€§ãŒå¿…è¦ãªå ´åˆï¼‰\n   */\n  static generateUUID(prefix?: string): string {\n    const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n      const r = Math.random() * 16 | 0\n      const v = c === 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n    return prefix ? `${prefix}_${uuid}` : uuid\n  }\n\n  /**\n   * ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã‚’ç”Ÿæˆï¼ˆå†…éƒ¨ç”¨ï¼‰\n   */\n  private static getRandomString(length: number = 9): string {\n    return Math.random().toString(36).substr(2, length)\n  }\n\n  /**\n   * ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰\n   */\n  static resetCounter(): void {\n    this.counter = 0\n  }\n\n  /**\n   * ç¾åœ¨ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å€¤ã‚’å–å¾—ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰\n   */\n  static getCurrentCounter(): number {\n    return this.counter\n  }\n}\n\n/**\n * IDã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£\n */\nexport class IdValidator {\n  /**\n   * IDãŒæœ‰åŠ¹ãªå½¢å¼ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  static isValid(id: string): boolean {\n    if (!id || typeof id !== 'string') return false\n    \n    // åŸºæœ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯: prefix_timestamp_randomstring\n    const basicPattern = /^[a-zA-Z_]+_\\d+_[a-zA-Z0-9]+$/\n    if (basicPattern.test(id)) return true\n    \n    // UUIDãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    const uuidPattern = /^[a-zA-Z_]*_?[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i\n    return uuidPattern.test(id)\n  }\n\n  /**\n   * IDã‹ã‚‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŠ½å‡º\n   */\n  static extractPrefix(id: string): string | null {\n    if (!this.isValid(id)) return null\n    \n    const parts = id.split('_')\n    return parts.length > 0 ? parts[0] : null\n  }\n\n  /**\n   * IDãŒSpecificãªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  static hasPrefix(id: string, expectedPrefix: string): boolean {\n    const prefix = this.extractPrefix(id)\n    return prefix === expectedPrefix\n  }\n}","import type {\n  CardEffect,\n  CardEffectType,\n  CardType,\n  ComboCardProperties,\n  DreamCategory,\n  EventCardProperties,\n  IAdvancedCard,\n  ICard,\n  InsuranceDurationType,\n  InsuranceEffectType,\n  InsuranceType,\n  LifeCardCategory,\n  RewardType,\n  SkillCardProperties,\n  SkillRarity,\n  InsuranceTriggerType // è¿½åŠ \n} from '../types/card.types'\nimport { CardPower } from '../valueObjects/CardPower'\nimport { InsurancePremium } from '../valueObjects/InsurancePremium'\nimport { IdGenerator } from '../../common/IdGenerator'\nimport { MAX_DAMAGE_REDUCTION_PER_INSURANCE, INSURANCE_EFFECTIVENESS_RATE } from '../constants/insurance.constants'\n\n/**\n * ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - ã‚²ãƒ¼ãƒ å†…ã®ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã®åŸºåº•ã‚¯ãƒ©ã‚¹\n * \n * ã“ã®ã‚¯ãƒ©ã‚¹ã¯å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’è¡¨ç¾ã—ã¾ã™ï¼š\n * - power: CardPowerå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ã®åŠ¹æœå€¤ï¼‰\n * - cost: InsurancePremiumå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä¿é™ºã‚«ãƒ¼ãƒ‰ã®å ´åˆï¼‰\n * \n * @implements {IAdvancedCard} æ‹¡å¼µã‚«ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\n * \n * @example\n * // äººç”Ÿã‚«ãƒ¼ãƒ‰ã®ä½œæˆ\n * const lifeCard = Card.createLifeCard('ã‚¢ãƒ«ãƒã‚¤ãƒˆåå…¥', 1);\n * \n * // ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ä½œæˆ\n * const insuranceCard = Card.createInsuranceCard('å¥åº·ä¿é™º', 2);\n * \n * // ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã®ä½œæˆ\n * const skillCard = Card.createSkillCard('ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«', 'rare', 3);\n */\nexport class Card implements IAdvancedCard {\n  readonly id: string\n  readonly name: string\n  readonly description: string\n  readonly type: CardType\n  private readonly _power: CardPower\n  private readonly _cost: InsurancePremium\n  readonly effects: CardEffect[]\n  readonly imageUrl?: string\n  readonly category?: LifeCardCategory\n  readonly insuranceType?: InsuranceType\n  readonly coverage?: number\n  readonly penalty?: number\n  // ä¿é™ºã‚«ãƒ¼ãƒ‰ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n  readonly ageBonus?: number\n  readonly durationType?: InsuranceDurationType\n  remainingTurns?: number // å¯å¤‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆã‚¿ãƒ¼ãƒ³ã”ã¨ã«æ¸›å°‘ï¼‰\n  readonly insuranceEffectType?: InsuranceEffectType\n  readonly insuranceTriggerType?: InsuranceTriggerType // ãƒˆãƒªã‚¬ãƒ¼å‹ä¿é™ºã®ç™ºå‹•æ¡ä»¶\n  // Phase 4 å¤¢ã‚«ãƒ¼ãƒ‰ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n  readonly dreamCategory?: DreamCategory\n\n  // æ‹¡å¼µã‚«ãƒ¼ãƒ‰ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n  readonly skillProperties?: SkillCardProperties\n  readonly comboProperties?: ComboCardProperties\n  readonly eventProperties?: EventCardProperties\n  readonly isUnlockable?: boolean\n  readonly unlockCondition?: string\n  readonly rewardType?: RewardType\n\n  /**\n   * Cardã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ\n   * @param {IAdvancedCard} params - ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\n   */\n  constructor(params: IAdvancedCard) {\n    this.id = params.id\n    this.name = params.name\n    this.description = params.description\n    this.type = params.type\n\n    // å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ©ãƒƒãƒ—\n    this._power = CardPower.create(params.power)\n    this._cost = InsurancePremium.create(params.cost)\n\n    this.effects = params.effects\n    this.imageUrl = params.imageUrl\n    this.category = params.category\n    this.insuranceType = params.insuranceType\n    this.coverage = params.coverage\n    this.penalty = params.penalty\n\n    // å¹´é½¢ãƒœãƒ¼ãƒŠã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n    if ('ageBonus' in params) {\n      this.ageBonus = params.ageBonus\n    }\n\n    // ä¿é™ºæœŸé–“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n    if ('durationType' in params) {\n      this.durationType = params.durationType\n    }\n    if ('remainingTurns' in params) {\n      this.remainingTurns = params.remainingTurns\n    }\n    if ('insuranceEffectType' in params) {\n      this.insuranceEffectType = params.insuranceEffectType\n    }\n    if ('insuranceTriggerType' in params) {\n      this.insuranceTriggerType = params.insuranceTriggerType\n    }\n\n    // Phase 4 å¤¢ã‚«ãƒ¼ãƒ‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n    if ('dreamCategory' in params) {\n      this.dreamCategory = params.dreamCategory\n    }\n\n    // æ‹¡å¼µã‚«ãƒ¼ãƒ‰ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n    if ('skillProperties' in params) {\n      this.skillProperties = params.skillProperties\n    }\n    if ('comboProperties' in params) {\n      this.comboProperties = params.comboProperties\n    }\n    if ('eventProperties' in params) {\n      this.eventProperties = params.eventProperties\n    }\n    if ('isUnlockable' in params) {\n      this.isUnlockable = params.isUnlockable\n    }\n    if ('unlockCondition' in params) {\n      this.unlockCondition = params.unlockCondition\n    }\n    if ('rewardType' in params) {\n      this.rewardType = params.rewardType\n    }\n  }\n\n  /**\n   * å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®getter - ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼å€¤ã‚’å–å¾—\n   * @returns {number} ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼å€¤\n   */\n  get power(): number {\n    return this._power.getValue()\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆã‚’å–å¾—\n   * @returns {number} ã‚«ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆ\n   */\n  get cost(): number {\n    return this._cost.getValue()\n  }\n\n  /**\n   * å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã®powerå–å¾—\n   * @returns {CardPower} ã‚«ãƒ¼ãƒ‰ãƒ‘ãƒ¯ãƒ¼å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n   */\n  getPower(): CardPower {\n    return this._power\n  }\n\n  /**\n   * å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã®costå–å¾—\n   * @returns {InsurancePremium} ä¿é™ºæ–™å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n   */\n  getCost(): InsurancePremium {\n    return this._cost\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ãŒç‰¹å®šã®åŠ¹æœã‚’æŒã£ã¦ã„ã‚‹ã‹åˆ¤å®š\n   * @param {CardEffectType} effectType - ç¢ºèªã™ã‚‹åŠ¹æœã‚¿ã‚¤ãƒ—\n   * @returns {boolean} åŠ¹æœã‚’æŒã£ã¦ã„ã‚‹å ´åˆtrue\n   */\n  hasEffect(effectType: CardEffectType): boolean {\n    return this.effects.some(effect => effect.type === effectType)\n  }\n\n  /**\n   * ç‰¹å®šã®åŠ¹æœã‚’å–å¾—\n   * @param {CardEffectType} effectType - å–å¾—ã™ã‚‹åŠ¹æœã‚¿ã‚¤ãƒ—\n   * @returns {CardEffect | undefined} åŠ¹æœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯undefined\n   */\n  getEffect(effectType: CardEffectType): CardEffect | undefined {\n    return this.effects.find(effect => effect.type === effectType)\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} ä¿é™ºã‚«ãƒ¼ãƒ‰ã®å ´åˆtrue\n   */\n  isInsurance(): boolean {\n    return this.type === 'insurance'\n  }\n\n  /**\n   * å®šæœŸä¿é™ºã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} å®šæœŸä¿é™ºã®å ´åˆtrue\n   */\n  isTermInsurance(): boolean {\n    return this.isInsurance() && this.durationType === 'term'\n  }\n\n  /**\n   * çµ‚èº«ä¿é™ºã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} çµ‚èº«ä¿é™ºã®å ´åˆtrue\n   */\n  isWholeLifeInsurance(): boolean {\n    return this.isInsurance() && this.durationType === 'whole_life'\n  }\n\n  /**\n   * ä¿é™ºåŠ¹æœã‚¿ã‚¤ãƒ—ã‚’å–å¾—\n   * @returns {InsuranceEffectType | undefined} ä¿é™ºåŠ¹æœã‚¿ã‚¤ãƒ—\n   */\n  getInsuranceEffectType(): InsuranceEffectType | undefined {\n    if (!this.isInsurance()) return undefined\n    return this.insuranceEffectType || 'offensive' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ”»æ’ƒå‹\n  }\n\n  /**\n   * é˜²å¾¡å‹ä¿é™ºã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} é˜²å¾¡å‹ä¿é™ºã®å ´åˆtrue\n   */\n  isDefensiveInsurance(): boolean {\n    return this.isInsurance() && this.getInsuranceEffectType() === 'defensive'\n  }\n\n  /**\n   * å›å¾©å‹ä¿é™ºã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} å›å¾©å‹ä¿é™ºã®å ´åˆtrue\n   */\n  isRecoveryInsurance(): boolean {\n    return this.isInsurance() && this.getInsuranceEffectType() === 'recovery'\n  }\n\n  /**\n   * ç‰¹åŒ–å‹ä¿é™ºã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} ç‰¹åŒ–å‹ä¿é™ºã®å ´åˆtrue\n   */\n  isSpecializedInsurance(): boolean {\n    return this.isInsurance() && this.getInsuranceEffectType() === 'specialized'\n  }\n\n  /**\n   * ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›é‡ã‚’è¨ˆç®—ï¼ˆé˜²å¾¡å‹ä¿é™ºç”¨ï¼‰\n   * Issue #24: ä¿é™ºåŠ¹æœã®ä¸Šé™ã‚’è¨­å®šã—ã¦éåº¦ãªè»½æ¸›ã‚’é˜²ã\n   * @returns {number} ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›é‡\n   */\n  calculateDamageReduction(): number {\n    // ä¿é™ºã‚«ãƒ¼ãƒ‰ã§ãªã„å ´åˆã¯0\n    if (!this.isInsurance()) return 0\n\n    // ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›åŠ¹æœã‚’æŒã¤ã‹ãƒã‚§ãƒƒã‚¯\n    const hasDefensiveEffect = this.isDefensiveInsurance() || this.hasEffect('damage_reduction')\n    if (!hasDefensiveEffect) return 0\n\n    let totalReduction = 0\n\n    // é˜²å¾¡å‹ä¿é™ºã®å ´åˆã€ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®è»½æ¸›\n    if (this.isDefensiveInsurance()) {\n      totalReduction += (this.coverage || 0) * INSURANCE_EFFECTIVENESS_RATE\n    }\n\n    // damage_reductionåŠ¹æœãŒã‚ã‚‹å ´åˆã¯ãã®å€¤ã‚’åŠ ç®—ï¼ˆåŠ¹æœç‡é©ç”¨ï¼‰\n    const reductionEffect = this.getEffect('damage_reduction')\n    if (reductionEffect) {\n      totalReduction += reductionEffect.value * INSURANCE_EFFECTIVENESS_RATE\n    }\n\n    // 1æšã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚ãŸã‚Šã®ä¸Šé™ã‚’é©ç”¨\n    return Math.min(totalReduction, MAX_DAMAGE_REDUCTION_PER_INSURANCE)\n  }\n\n  /**\n   * ã‚¿ãƒ¼ãƒ³å›å¾©é‡ã‚’è¨ˆç®—ï¼ˆå›å¾©å‹ä¿é™ºç”¨ï¼‰\n   * @returns {number} ã‚¿ãƒ¼ãƒ³å›å¾©é‡\n   */\n  calculateTurnHeal(): number {\n    if (!this.isRecoveryInsurance()) return 0\n\n    // ã‚«ãƒãƒ¬ãƒƒã‚¸ã«åŸºã¥ã„ã¦å›å¾©é‡ã‚’è¨ˆç®—\n    const baseHeal = Math.floor((this.coverage || 0) / 20)\n\n    // ã‚¿ãƒ¼ãƒ³å›å¾©åŠ¹æœãŒã‚ã‚‹å ´åˆã¯ãã®å€¤ã‚’åŠ ç®—\n    const healEffect = this.getEffect('turn_heal')\n    const effectHeal = healEffect ? healEffect.value : 0\n\n    return baseHeal + effectHeal\n  }\n\n  /**\n   * ç‰¹å®šãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¸ã®ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—ï¼ˆç‰¹åŒ–å‹ä¿é™ºç”¨ï¼‰\n   * @param {string} challengeType ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¿ã‚¤ãƒ—\n   * @returns {number} ãƒœãƒ¼ãƒŠã‚¹ãƒ‘ãƒ¯ãƒ¼\n   */\n  calculateChallengeBonus(challengeType: string): number {\n    if (!this.isSpecializedInsurance()) return 0\n\n    // ç‰¹å®šãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœãƒ¼ãƒŠã‚¹åŠ¹æœã‚’ç¢ºèª\n    const bonusEffect = this.getEffect('challenge_bonus')\n    if (!bonusEffect?.condition) return 0\n\n    // æ¡ä»¶ãŒä¸€è‡´ã™ã‚‹å ´åˆã®ã¿ãƒœãƒ¼ãƒŠã‚¹ã‚’è¿”ã™\n    if (bonusEffect.condition.includes(challengeType)) {\n      return bonusEffect.value\n    }\n\n    return 0\n  }\n\n  /**\n   * Phase 4: å¤¢ã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} å¤¢ã‚«ãƒ¼ãƒ‰ã®å ´åˆtrue\n   */\n  isDreamCard(): boolean {\n    return this.type === 'dream'\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼ˆä¸€éƒ¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°å¯èƒ½ï¼‰\n   * @param {Partial<IAdvancedCard>} [updates] - æ›´æ–°ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£\n   * @returns {Card} æ–°ã—ã„Cardã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   */\n  copy(updates?: Partial<IAdvancedCard>): Card {\n    return new Card({\n      ...this,\n      power: this.power, // getterçµŒç”±ã§å–å¾—\n      cost: this.cost,   // getterçµŒç”±ã§å–å¾—\n      effects: [...this.effects], // é…åˆ—ã®æ·±ã„ã‚³ãƒ”ãƒ¼\n      ...updates\n    })\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰\n   * @returns {Card} ã‚«ãƒ¼ãƒ‰ã®å®Œå…¨ãªã‚³ãƒ”ãƒ¼\n   * @deprecated copy()ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½¿ç”¨ã‚’æ¨å¥¨\n   */\n  clone(): Card {\n    return this.copy()\n  }\n\n  /**\n   * æ®‹ã‚Šã‚¿ãƒ¼ãƒ³æ•°ã‚’æ¸›å°‘ã•ã›ã‚‹ï¼ˆå®šæœŸä¿é™ºç”¨ï¼‰\n   * @returns {Card} ã‚¿ãƒ¼ãƒ³æ•°ã‚’æ¸›ã‚‰ã—ãŸæ–°ã—ã„Cardã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   */\n  decrementRemainingTurns(): Card {\n    if (!this.isTermInsurance() || !this.remainingTurns) {\n      return this\n    }\n\n    return this.copy({\n      remainingTurns: Math.max(0, this.remainingTurns - 1)\n    })\n  }\n\n  /**\n   * ä¿é™ºãŒæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã‹ã©ã†ã‹åˆ¤å®š\n   * @returns {boolean} æœŸé™åˆ‡ã‚Œã®å ´åˆtrue\n   */\n  isExpired(): boolean {\n    if (!this.isTermInsurance()) {\n      return false\n    }\n    return this.remainingTurns === 0\n  }\n\n  /**\n   * ãƒ‘ãƒ¯ãƒ¼ãŒæŒ‡å®šå€¤ä»¥ä¸Šã‹åˆ¤å®šï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ï¼‰\n   * @param {number} threshold - é—¾å€¤\n   * @returns {boolean} ãƒ‘ãƒ¯ãƒ¼ãŒé—¾å€¤ä»¥ä¸Šã®å ´åˆtrue\n   */\n  hasPowerAtLeast(requiredPower: number): boolean {\n    const required = CardPower.create(requiredPower)\n    return this._power.isGreaterThanOrEqual(required)\n  }\n\n  /**\n   * ã‚³ã‚¹ãƒˆãŒæ”¯æ‰•ã„å¯èƒ½ã‹åˆ¤å®šï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ï¼‰\n   */\n  isAffordableWith(availableVitality: number): boolean {\n    return this._cost.isAffordableWith(availableVitality)\n  }\n\n  /**\n   * åŠ¹æœçš„ãªãƒ‘ãƒ¯ãƒ¼ã‚’è¨ˆç®—ï¼ˆå¹´é½¢ãƒœãƒ¼ãƒŠã‚¹ç­‰ã‚’å«ã‚€ï¼‰\n   * @param {number} [bonus] - è¿½åŠ ãƒœãƒ¼ãƒŠã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n   */\n  calculateEffectivePower(bonus?: number): number {\n    let effectivePower = this.power\n\n    // ä¿é™ºã‚«ãƒ¼ãƒ‰ã®å¹´é½¢ãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨\n    if (this.isInsurance() && this.ageBonus) {\n      effectivePower += this.ageBonus\n    }\n\n    // å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸãƒœãƒ¼ãƒŠã‚¹ã‚’åŠ ç®—\n    if (bonus !== undefined) {\n      effectivePower += bonus\n    }\n\n    // æ”»æ’ƒå‹ä¿é™ºä»¥å¤–ã¯ãƒ‘ãƒ¯ãƒ¼ã‚’æä¾›ã—ãªã„\n    if (this.isInsurance() && this.getInsuranceEffectType() !== 'offensive') {\n      return 0\n    }\n\n    return Math.max(0, effectivePower)\n  }\n\n  /**\n   * ãƒ©ã‚¤ãƒ•ã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isLifeCard(): boolean {\n    return this.type === 'life'\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®šï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰\n   */\n  isInsuranceCard(): boolean {\n    return this.isInsurance()\n  }\n\n  /**\n   * è½ã¨ã—ç©´ã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isPitfallCard(): boolean {\n    return this.type === 'pitfall'\n  }\n\n  /**\n   * ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isSkillCard(): boolean {\n    return this.type === 'skill'\n  }\n\n  /**\n   * ã‚³ãƒ³ãƒœã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isComboCard(): boolean {\n    return this.type === 'combo'\n  }\n\n  /**\n   * ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isEventCard(): boolean {\n    return this.type === 'event'\n  }\n\n  /**\n   * ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isLegendaryCard(): boolean {\n    return this.type === 'legendary'\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isChallengeCard(): boolean {\n    return this.type === 'challenge'\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºç”¨æ–‡å­—åˆ—ã‚’ç”Ÿæˆ\n   */\n  toDisplayString(): string {\n    let display = `${this.name} - Power: ${this.power}, Cost: ${this.cost}`\n\n    if (this.effects.length > 0) {\n      const effectDescriptions = this.effects.map(effect => effect.description).join(', ')\n      display += ` - Effects: ${effectDescriptions}`\n    }\n\n    return display\n  }\n\n  /**\n   * ã‚¿ãƒ¼ãƒ³æ•°ã‚’æ¸›å°‘ã•ã›ã‚‹ï¼ˆmutableãªæ“ä½œï¼‰\n   */\n  decrementTurn(): void {\n    if (this.remainingTurns !== undefined && this.remainingTurns > 0) {\n      this.remainingTurns--\n    }\n  }\n\n  // === é™çš„ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆTDD: Green Phaseï¼‰ ===\n\n  /**\n   * ãƒ©ã‚¤ãƒ•ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createLifeCard(name: string, power: number): Card {\n    const powerSign = power > 0 ? '+' : ''\n    return new Card({\n      id: IdGenerator.generate('life'),\n      name,\n      description: `ãƒ‘ãƒ¯ãƒ¼: ${powerSign}${power}`,\n      type: 'life',\n      power,\n      cost: 0,\n      effects: []\n    })\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createChallengeCard(name: string, power: number): Card {\n    const card = new Card({\n      id: IdGenerator.generate('challenge'),\n      name,\n      description: `å¿…è¦ãƒ‘ãƒ¯ãƒ¼: ${power}`,\n      type: 'challenge',\n      power,\n      cost: 0,\n      effects: []\n    })\n\n    return card\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createInsuranceCard(name: string, power: number, cost: number = 1, ...effects: CardEffect[]): Card {\n    return new Card({\n      id: IdGenerator.generate('insurance'),\n      name,\n      description: `ä¿é™ºã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${power}`,\n      type: 'insurance',\n      power,\n      cost,\n      effects\n    })\n  }\n\n  /**\n   * ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createSkillCard(name: string, rarity: SkillRarity, power: number, cooldown?: number): Card {\n    const rarityDescriptions = {\n      common: 'ã‚³ãƒ¢ãƒ³',\n      rare: 'ãƒ¬ã‚¢',\n      epic: 'ã‚¨ãƒ”ãƒƒã‚¯',\n      legendary: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼'\n    }\n\n    return new Card({\n      id: IdGenerator.generate('skill'),\n      name,\n      description: `${rarityDescriptions[rarity]}ã‚¹ã‚­ãƒ« - ãƒ‘ãƒ¯ãƒ¼: +${power}`,\n      type: 'skill',\n      power,\n      cost: 0,\n      effects: [],\n      skillProperties: {\n        rarity,\n        cooldown,\n        remainingCooldown: 0,\n        masteryLevel: 1\n      }\n    })\n  }\n\n  /**\n   * ã‚³ãƒ³ãƒœã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createComboCard(name: string, power: number, requiredCards: string[], comboBonus: number): Card {\n    return new Card({\n      id: IdGenerator.generate('combo'),\n      name,\n      description: `ã‚³ãƒ³ãƒœã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${power} (ã‚³ãƒ³ãƒœæ™‚: +${comboBonus})`,\n      type: 'combo',\n      power,\n      cost: 0,\n      effects: [],\n      comboProperties: {\n        requiredCards,\n        comboBonus\n      }\n    })\n  }\n\n  /**\n   * ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createEventCard(name: string, power: number, duration: number, globalEffect = false): Card {\n    return new Card({\n      id: IdGenerator.generate('event'),\n      name,\n      description: `ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ - ${duration}ã‚¿ãƒ¼ãƒ³ç¶™ç¶š`,\n      type: 'event',\n      power,\n      cost: 0,\n      effects: [],\n      eventProperties: {\n        duration,\n        globalEffect\n      }\n    })\n  }\n\n  /**\n   * ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createLegendaryCard(name: string, power: number, unlockCondition: string): Card {\n    return new Card({\n      id: IdGenerator.generate('legendary'),\n      name,\n      description: `ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${power}`,\n      type: 'legendary',\n      power,\n      cost: 0,\n      effects: [],\n      isUnlockable: true,\n      unlockCondition\n    })\n  }\n}","/**\n * ä¿é™ºã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ç”¨å®šæ•°\n * Issue #24: ä¿é™ºåŠ¹æœã®éåº¦ãªå¼·åŠ›ã•ã‚’ç·©å’Œã™ã‚‹ãŸã‚ã®è¨­å®š\n */\n\n/**\n * ä¿é™ºã«ã‚ˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ã®ä¸Šé™å€¤\n * 1æšã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã§è»½æ¸›ã§ãã‚‹æœ€å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸é‡\n */\nexport const MAX_DAMAGE_REDUCTION_PER_INSURANCE = 50\n\n/**\n * ä¿é™ºã«ã‚ˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ã®åˆè¨ˆä¸Šé™å€¤\n * è¤‡æ•°ã®ä¿é™ºã‚’æŒã£ã¦ã„ã¦ã‚‚ã€ã“ã‚Œä»¥ä¸Šã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã§ããªã„\n */\nexport const MAX_TOTAL_DAMAGE_REDUCTION = 100\n\n/**\n * ä¿é™ºåŠ¹æœã®æ®µéšçš„ãªé©ç”¨ãƒ¬ãƒ¼ãƒˆ\n * ã‚«ãƒãƒ¬ãƒƒã‚¸å€¤ã«å¯¾ã™ã‚‹å®Ÿéš›ã®è»½æ¸›ç‡\n */\nexport const INSURANCE_EFFECTIVENESS_RATE = 0.5 // 50%ã®åŠ¹æœ\n\n/**\n * ä¿é™ºã®æœ€å°ãƒ€ãƒ¡ãƒ¼ã‚¸ä¿è¨¼\n * ã©ã‚“ãªã«ä¿é™ºãŒã‚ã£ã¦ã‚‚ã€æœ€ä½é™ã“ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯å—ã‘ã‚‹\n */\nexport const MINIMUM_DAMAGE_AFTER_INSURANCE = 1","import { Card } from './Card'\nimport type { CardEffect, DreamCategory } from '../types/card.types'\nimport { IdGenerator } from '../../common/IdGenerator'\n\n/**\n * ãƒªã‚¹ã‚¯ãƒ»ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰\n * \n * é«˜ãƒªã‚¹ã‚¯ãƒ»é«˜ãƒªãƒ¯ãƒ¼ãƒ‰ã®æ„æ€æ±ºå®šã‚’ä¿ƒã™ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã€‚\n * å¤±æ•—æ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒå¤§ãã„ãŒã€æˆåŠŸæ™‚ã®å ±é…¬ã‚‚å¤§ãã„ã€‚\n */\nexport class RiskRewardChallenge extends Card {\n  readonly riskLevel: 'low' | 'medium' | 'high' | 'extreme'\n  readonly successBonus: number\n  readonly failurePenalty: number\n  readonly insuranceImmunity: boolean // ä¿é™ºãŒåŠ¹ã‹ãªã„ã‹ã©ã†ã‹\n\n  constructor(params: {\n    name: string\n    description: string\n    power: number\n    riskLevel: 'low' | 'medium' | 'high' | 'extreme'\n    successBonus: number\n    failurePenalty: number\n    insuranceImmunity?: boolean\n    dreamCategory?: DreamCategory\n  }) {\n    const effects: CardEffect[] = []\n    \n    // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸç‰¹æ®ŠåŠ¹æœ\n    if (params.riskLevel === 'extreme') {\n      effects.push({\n        type: 'special_action',\n        value: 0,\n        description: 'ä¿é™ºåŠ¹æœç„¡åŠ¹åŒ–',\n        condition: 'ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼ãŒç„¡åŠ¹'\n      })\n    }\n\n    super({\n      id: IdGenerator.generateCardId(),\n      type: 'challenge',\n      name: params.name,\n      description: params.description,\n      power: params.power,\n      cost: 0,\n      effects,\n      dreamCategory: params.dreamCategory\n    })\n\n    this.riskLevel = params.riskLevel\n    this.successBonus = params.successBonus\n    this.failurePenalty = params.failurePenalty\n    this.insuranceImmunity = params.insuranceImmunity || params.riskLevel === 'extreme'\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯å€ç‡ã‚’å–å¾—\n   */\n  getRiskMultiplier(): number {\n    const multipliers = {\n      low: 1.2,\n      medium: 1.5,\n      high: 2.0,\n      extreme: 3.0\n    }\n    return multipliers[this.riskLevel]\n  }\n\n  /**\n   * æˆåŠŸæ™‚ã®å®Ÿéš›ã®å ±é…¬ã‚’è¨ˆç®—\n   */\n  calculateActualReward(baseReward: number): number {\n    return Math.floor(baseReward * this.getRiskMultiplier()) + this.successBonus\n  }\n\n  /**\n   * å¤±æ•—æ™‚ã®å®Ÿéš›ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è¨ˆç®—\n   */\n  calculateActualPenalty(basePenalty: number): number {\n    return Math.floor(basePenalty * this.getRiskMultiplier()) + this.failurePenalty\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®èª¬æ˜ã‚’å–å¾—\n   */\n  getRiskDescription(): string {\n    const descriptions = {\n      low: 'ä½ãƒªã‚¹ã‚¯: å°‘ã—å±é™ºã ãŒã€å¤±æ•—ã—ã¦ã‚‚ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯è»½ã„',\n      medium: 'ä¸­ãƒªã‚¹ã‚¯: æˆåŠŸã¨å¤±æ•—ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã‚‹',\n      high: 'é«˜ãƒªã‚¹ã‚¯: å¤±æ•—æ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¤§ãã„ãŒã€å ±é…¬ã‚‚é­…åŠ›çš„',\n      extreme: 'æ¥µé™ãƒªã‚¹ã‚¯: ä¿é™ºã‚‚åŠ¹ã‹ãªã„å±é™ºãªæŒ‘æˆ¦ã€‚æˆåŠŸã™ã‚Œã°å¤§ããªå ±é…¬'\n    }\n    return descriptions[this.riskLevel]\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®è©³ç´°æƒ…å ±ã‚’å–å¾—\n   */\n  getChallengeDetails(): string {\n    const details = [\n      `å¿…è¦ãƒ‘ãƒ¯ãƒ¼: ${this.power}`,\n      `ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: ${this.riskLevel.toUpperCase()}`,\n      `æˆåŠŸãƒœãƒ¼ãƒŠã‚¹: +${this.successBonus} æ´»åŠ›`,\n      `å¤±æ•—ãƒšãƒŠãƒ«ãƒ†ã‚£: -${this.failurePenalty} æ´»åŠ›`,\n      this.insuranceImmunity ? 'âš ï¸ ä¿é™ºç„¡åŠ¹' : ''\n    ].filter(Boolean)\n\n    return details.join('\\n')\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰: ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œæˆ\n   */\n  static createRiskChallenge(\n    stage: 'youth' | 'middle' | 'fulfillment',\n    riskLevel: 'low' | 'medium' | 'high' | 'extreme'\n  ): RiskRewardChallenge {\n    const challengeTemplates = {\n      youth: {\n        low: {\n          name: 'æ–°ã—ã„ã‚¹ãƒãƒ¼ãƒ„ã¸ã®æŒ‘æˆ¦',\n          description: 'æœªçµŒé¨“ã®åˆ†é‡ã«æŒ‘æˆ¦ã™ã‚‹å‹‡æ°—',\n          power: 5,\n          successBonus: 2,\n          failurePenalty: 1\n        },\n        medium: {\n          name: 'èµ·æ¥­ã¸ã®ç¬¬ä¸€æ­©',\n          description: 'å®‰å®šã‚’æ¨ã¦ã¦å¤¢ã‚’è¿½ã†æ±ºæ–­',\n          power: 7,\n          successBonus: 5,\n          failurePenalty: 3\n        },\n        high: {\n          name: 'æµ·å¤–ç•™å­¦',\n          description: 'æœªçŸ¥ã®ä¸–ç•Œã¸ã®å¤§ããªé£›èº',\n          power: 9,\n          successBonus: 8,\n          failurePenalty: 5\n        },\n        extreme: {\n          name: 'äººç”Ÿã‚’è³­ã‘ãŸå¤§å‹è² ',\n          description: 'å…¨ã¦ã‚’æŠ•ã’æ‰“ã£ã¦æŒ‘ã‚€æœ€å¤§ã®æŒ‘æˆ¦',\n          power: 12,\n          successBonus: 15,\n          failurePenalty: 10\n        }\n      },\n      middle: {\n        low: {\n          name: 'å‰¯æ¥­ã®é–‹å§‹',\n          description: 'æ–°ãŸãªåå…¥æºã¸ã®æŒ‘æˆ¦',\n          power: 6,\n          successBonus: 3,\n          failurePenalty: 2\n        },\n        medium: {\n          name: 'ç‹¬ç«‹é–‹æ¥­',\n          description: 'ä¼šç¤¾ã‚’è¾ã‚ã¦ç‹¬ç«‹ã™ã‚‹æ±ºæ–­',\n          power: 9,\n          successBonus: 7,\n          failurePenalty: 5\n        },\n        high: {\n          name: 'å¤§å‹æŠ•è³‡',\n          description: 'å°†æ¥ã‚’è¦‹æ®ãˆãŸå¤§èƒ†ãªæŠ•è³‡',\n          power: 11,\n          successBonus: 10,\n          failurePenalty: 7\n        },\n        extreme: {\n          name: 'äººç”Ÿã®å¤§è»¢æ›',\n          description: 'å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é“ã¸',\n          power: 15,\n          successBonus: 20,\n          failurePenalty: 15\n        }\n      },\n      fulfillment: {\n        low: {\n          name: 'æ–°ã—ã„è¶£å‘³ã¸ã®æŒ‘æˆ¦',\n          description: 'å¹´é½¢ã«é–¢ä¿‚ãªãæ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹',\n          power: 7,\n          successBonus: 4,\n          failurePenalty: 2\n        },\n        medium: {\n          name: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•',\n          description: 'ç¤¾ä¼šè²¢çŒ®ã¸ã®æ–°ãŸãªä¸€æ­©',\n          power: 10,\n          successBonus: 8,\n          failurePenalty: 4\n        },\n        high: {\n          name: 'éºç”£ã®æ´»ç”¨',\n          description: 'æ¬¡ä¸–ä»£ã¸ã®å¤§ããªæŠ•è³‡',\n          power: 13,\n          successBonus: 12,\n          failurePenalty: 8\n        },\n        extreme: {\n          name: 'äººç”Ÿæœ€å¾Œã®å¤§å†’é™º',\n          description: 'æ®‹ã•ã‚ŒãŸæ™‚é–“ã§ã®ç©¶æ¥µã®æŒ‘æˆ¦',\n          power: 18,\n          successBonus: 25,\n          failurePenalty: 20\n        }\n      }\n    }\n\n    const template = challengeTemplates[stage][riskLevel]\n    \n    return new RiskRewardChallenge({\n      ...template,\n      riskLevel,\n      dreamCategory: riskLevel === 'extreme' ? 'mixed' : 'physical'\n    })\n  }\n}","import { Card } from '../entities/Card'\nimport type {\n  DreamCategory,\n  GameStage,\n  InsuranceType,\n  LifeCardCategory,\n  RewardType,\n  SkillRarity,\n  InsuranceEffectType,\n  InsuranceTriggerType\n} from '../types/card.types'\nimport type { InsuranceTypeChoice } from '../types/game.types'\nimport { IdGenerator } from '../../common/IdGenerator'\nimport { RiskRewardChallenge } from '../entities/RiskRewardChallenge'\n\n/**\n * ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼\n * ã‚²ãƒ¼ãƒ ç”¨ã®ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹\n */\nexport class CardFactory {\n\n  /**\n   * å¹´é½¢ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—\n   */\n  private static calculateAgeBonus(stage: GameStage): number {\n    switch (stage) {\n      case 'middle': return 0.5\n      case 'fulfillment': return 1.0\n      default: return 0\n    }\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é…åˆ—ã‹ã‚‰å®Ÿéš›ã®ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  private static createCardsFromDefinitions<T extends { name: string }>(definitions: T[], createFn: (def: T) => Card): Card[] {\n    return definitions.map(def => createFn(def))\n  }\n\n  /**\n   * åˆæœŸãƒ‡ãƒƒã‚­ç”¨ã®äººç”Ÿã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createStarterLifeCards(): Card[] {\n    const starterCardDefinitions = [\n      // å¥åº·ã‚«ãƒ¼ãƒ‰\n      { name: 'æœã®ã‚¸ãƒ§ã‚®ãƒ³ã‚°', description: 'å¥åº·çš„ãªä¸€æ—¥ã®å§‹ã¾ã‚Š', category: 'health' as LifeCardCategory, power: 3, cost: 1 },\n      { name: 'æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„é£Ÿäº‹', description: 'ä½“èª¿ç®¡ç†ã®åŸºæœ¬', category: 'health' as LifeCardCategory, power: 5, cost: 2 },\n      // ã‚­ãƒ£ãƒªã‚¢ã‚«ãƒ¼ãƒ‰\n      { name: 'æ–°ã—ã„ã‚¹ã‚­ãƒ«ã®ç¿’å¾—', description: 'æˆé•·ã¸ã®æŠ•è³‡', category: 'career' as LifeCardCategory, power: 5, cost: 2 },\n      { name: 'ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯', description: 'ä»²é–“ã¨ã®å”åŠ›', category: 'career' as LifeCardCategory, power: 3, cost: 1 },\n      // å®¶æ—ã‚«ãƒ¼ãƒ‰\n      { name: 'å®¶æ—ã¨ã®å›£ã‚‰ã‚“', description: 'å¿ƒã®å……é›»', category: 'family' as LifeCardCategory, power: 3, cost: 1 },\n      // è¶£å‘³ã‚«ãƒ¼ãƒ‰\n      { name: 'è¶£å‘³ã®æ™‚é–“', description: 'ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒ ', category: 'hobby' as LifeCardCategory, power: 3, cost: 1 },\n      // é‡‘èã‚«ãƒ¼ãƒ‰\n      { name: 'è¨ˆç”»çš„ãªè²¯è“„', description: 'å°†æ¥ã¸ã®å‚™ãˆ', category: 'finance' as LifeCardCategory, power: 5, cost: 2 }\n    ]\n\n    return this.createCardsFromDefinitions(starterCardDefinitions, def => this.createLifeCard(def))\n  }\n\n  /**\n   * åŸºæœ¬çš„ãªä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆç°¡ç´ åŒ–ç‰ˆï¼šã™ã¹ã¦çµ‚èº«ä¿é™ºã€æ°¸ç¶šåŠ¹æœï¼‰\n   */\n  static createBasicInsuranceCards(stage: GameStage = 'youth'): Card[] {\n    const ageBonus = this.calculateAgeBonus(stage)\n\n    const basicInsuranceDefinitions = [\n      { name: 'åŒ»ç™‚ä¿é™º', description: 'ç—…æ°—ã‚„ã‚±ã‚¬ã«å‚™ãˆã‚‹æ°¸ç¶šä¿éšœ', insuranceType: 'medical' as InsuranceType, power: 4, cost: 3, coverage: 100 },\n      { name: 'ç”Ÿå‘½ä¿é™º', description: 'å®¶æ—ã‚’å®ˆã‚‹æ°¸ç¶šä¿éšœ', insuranceType: 'life' as InsuranceType, power: 5, cost: 4, coverage: 200 },\n      { name: 'åå…¥ä¿éšœä¿é™º', description: 'åƒã‘ãªããªã£ãŸæ™‚ã®æ°¸ç¶šä¿éšœ', insuranceType: 'income' as InsuranceType, power: 4, cost: 3, coverage: 150 }\n    ]\n\n    return this.createCardsFromDefinitions(basicInsuranceDefinitions, def =>\n      this.createInsuranceCard({ ...def, ageBonus })\n    )\n  }\n\n  /**\n   * æ‹¡å¼µä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆç°¡ç´ åŒ–ç‰ˆï¼šã™ã¹ã¦æ°¸ç¶šåŠ¹æœï¼‰\n   */\n  static createExtendedInsuranceCards(stage: GameStage = 'youth'): Card[] {\n    const extendedCards: Card[] = []\n\n    // å¹´é½¢ãƒœãƒ¼ãƒŠã‚¹ã®è¨­å®š\n    const ageBonus = this.calculateAgeBonus(stage)\n\n    // åŸºæœ¬ä¿é™ºã‚«ãƒ¼ãƒ‰\n    const baseInsurances = [\n      { name: 'åŒ»ç™‚ä¿é™º', insuranceType: 'medical' as InsuranceType, power: 5, cost: 4, coverage: 100 },\n      { name: 'ç”Ÿå‘½ä¿é™º', insuranceType: 'life' as InsuranceType, power: 6, cost: 5, coverage: 200 },\n      { name: 'åå…¥ä¿éšœä¿é™º', insuranceType: 'income' as InsuranceType, power: 5, cost: 4, coverage: 150 }\n    ]\n\n    // åŸºæœ¬ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n    const baseCards = this.createCardsFromDefinitions(baseInsurances, insurance =>\n      this.createInsuranceCard({\n        name: insurance.name,\n        description: `${insurance.name}ã®æ°¸ç¶šä¿éšœ`,\n        insuranceType: insurance.insuranceType,\n        power: insurance.power,\n        cost: insurance.cost,\n        coverage: insurance.coverage,\n        ageBonus\n      })\n    )\n    extendedCards.push(...baseCards)\n\n    // è¿½åŠ ã®ç‰¹æ®Šä¿é™ºã‚«ãƒ¼ãƒ‰\n    const additionalInsurances = [\n      { name: 'å‚·å®³ä¿é™º', insuranceType: 'medical' as InsuranceType, power: 4, cost: 3, coverage: 80 },\n      { name: 'å°±æ¥­ä¸èƒ½ä¿é™º', insuranceType: 'income' as InsuranceType, power: 7, cost: 6, coverage: 250 },\n      { name: 'ä»‹è­·ä¿é™º', insuranceType: 'medical' as InsuranceType, power: 6, cost: 5, coverage: 180 },\n      { name: 'ãŒã‚“ä¿é™º', insuranceType: 'medical' as InsuranceType, power: 5, cost: 4, coverage: 120 },\n      { name: 'å€‹äººå¹´é‡‘ä¿é™º', insuranceType: 'income' as InsuranceType, power: 4, cost: 4, coverage: 100 },\n      { name: 'å­¦è³‡ä¿é™º', insuranceType: 'life' as InsuranceType, power: 4, cost: 3, coverage: 90 }\n    ]\n\n    // è¿½åŠ ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n    const additionalCards = this.createCardsFromDefinitions(additionalInsurances, insurance =>\n      this.createInsuranceCard({\n        name: insurance.name,\n        description: `${insurance.name}ã®æ°¸ç¶šä¿éšœ`,\n        insuranceType: insurance.insuranceType,\n        power: insurance.power,\n        cost: insurance.cost,\n        coverage: insurance.coverage,\n        ageBonus\n      })\n    )\n    extendedCards.push(...additionalCards)\n\n    return extendedCards\n  }\n\n  /**\n   * å¤šæ§˜ãªåŠ¹æœã‚¿ã‚¤ãƒ—ã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createDiverseInsuranceCards(stage: GameStage = 'youth'): Card[] {\n    const cards: Card[] = []\n    const ageBonus = this.calculateAgeBonus(stage)\n\n    // æ”»æ’ƒå‹ä¿é™º\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'æ”»æ’ƒç‰¹åŒ–ç”Ÿå‘½ä¿é™º',\n      description: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ™‚ã«å¤§ããªãƒ‘ãƒ¯ãƒ¼ã‚’æä¾›',\n      power: 8,\n      cost: 5,\n      insuranceType: 'life',\n      insuranceEffectType: 'offensive',\n      coverage: 150,\n      effects: [],\n      ageBonus,\n      durationType: 'whole_life'\n    }))\n\n    // é˜²å¾¡å‹ä¿é™º\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'é˜²å¾¡ç‰¹åŒ–åŒ»ç™‚ä¿é™º',\n      description: 'ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹é˜²å¾¡çš„ä¿éšœ',\n      power: 0,\n      cost: 4,\n      insuranceType: 'medical',\n      insuranceEffectType: 'defensive',\n      coverage: 100,\n      effects: [{\n        type: 'damage_reduction',\n        value: 3,\n        description: 'ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’3ãƒã‚¤ãƒ³ãƒˆè»½æ¸›'\n      }],\n      ageBonus: 0,\n      durationType: 'whole_life'\n    }))\n\n    // å›å¾©å‹ä¿é™º\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'å›å¾©ç‰¹åŒ–å¥åº·ä¿é™º',\n      description: 'æ¯ã‚¿ãƒ¼ãƒ³æ´»åŠ›ã‚’å›å¾©',\n      power: 0,\n      cost: 3,\n      insuranceType: 'health',\n      insuranceEffectType: 'recovery',\n      coverage: 80,\n      effects: [{\n        type: 'turn_heal',\n        value: 2,\n        description: 'æ¯ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«2ç‚¹å›å¾©'\n      }],\n      ageBonus: 0,\n      durationType: 'whole_life'\n    }))\n\n    // ç‰¹åŒ–å‹ä¿é™º\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'ä»•äº‹ç‰¹åŒ–åå…¥ä¿éšœä¿é™º',\n      description: 'ä»•äº‹é–¢é€£ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«ç‰¹åŒ–',\n      power: 3,\n      cost: 4,\n      insuranceType: 'income',\n      insuranceEffectType: 'specialized',\n      coverage: 120,\n      effects: [{\n        type: 'challenge_bonus',\n        value: 5,\n        description: 'ã€Œå°±è·ã€ã€Œæ˜é€²ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ™‚+5ãƒ‘ãƒ¯ãƒ¼',\n        condition: 'å°±è·,æ˜é€²,è»¢è·,ä»•äº‹'\n      }],\n      ageBonus,\n      durationType: 'whole_life'\n    }))\n\n    // åŒ…æ‹¬å‹ä¿é™º\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ç·åˆä¿é™º',\n      description: 'è¤‡æ•°ã®åŠ¹æœã‚’æŒã¤é«˜ã‚³ã‚¹ãƒˆä¿éšœ',\n      power: 3,\n      cost: 7,\n      insuranceType: 'life',\n      insuranceEffectType: 'comprehensive',\n      coverage: 200,\n      effects: [\n        {\n          type: 'power_boost',\n          value: 3,\n          description: 'ãƒ‘ãƒ¯ãƒ¼+3'\n        },\n        {\n          type: 'damage_reduction',\n          value: 2,\n          description: 'ãƒ€ãƒ¡ãƒ¼ã‚¸-2'\n        },\n        {\n          type: 'turn_heal',\n          value: 1,\n          description: 'æ¯ã‚¿ãƒ¼ãƒ³+1å›å¾©'\n        }\n      ],\n      ageBonus,\n      durationType: 'whole_life'\n    }))\n\n    return cards\n  }\n\n  /**\n   * ãƒˆãƒªã‚¬ãƒ¼å‹ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   * ç‰¹å®šã®æ¡ä»¶ã§ä¸€å›é™ã‚Šç™ºå‹•ã—ã€å¥‘ç´„çµ‚äº†ã¨ãªã‚‹ä¿é™º\n   */\n  static createTriggerInsuranceCards(stage: GameStage = 'youth'): Card[] {\n    const cards: Card[] = []\n    const ageBonus = this.calculateAgeBonus(stage)\n\n    // ç”Ÿå‘½ä¿é™ºï¼ˆæ´»åŠ›0ã§å¾©æ´»ï¼‰\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'ç”Ÿå‘½ä¿é™º',\n      description: 'æ´»åŠ›ãŒ0ã«ãªã‚‹ç¬é–“ã€æ´»åŠ›10ã§å¾©æ´»ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚',\n      power: 0,\n      cost: 2,\n      insuranceType: 'life',\n      insuranceEffectType: 'trigger',\n      insuranceTriggerType: 'on_death',\n      coverage: 10, // å¾©æ´»æ™‚ã®æ´»åŠ›\n      effects: [],\n      ageBonus,\n      durationType: 'whole_life'\n    } as any))\n\n    // åŒ»ç™‚ä¿é™ºï¼ˆ10ãƒ€ãƒ¡ãƒ¼ã‚¸ä»¥ä¸Šã‚’1ã«è»½æ¸›ï¼‰\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'åŒ»ç™‚ä¿é™º',\n      description: '10ãƒ€ãƒ¡ãƒ¼ã‚¸ä»¥ä¸Šå—ã‘ã‚‹æ™‚ã€1ãƒ€ãƒ¡ãƒ¼ã‚¸ã«è»½æ¸›ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚',\n      power: 0,\n      cost: 3,\n      insuranceType: 'medical',\n      insuranceEffectType: 'trigger',\n      insuranceTriggerType: 'on_heavy_damage',\n      coverage: 10, // ç™ºå‹•é–¾å€¤ï¼ˆ10ãƒ€ãƒ¡ãƒ¼ã‚¸ä»¥ä¸Šï¼‰\n      effects: [],\n      ageBonus,\n      durationType: 'whole_life'\n    } as any))\n\n    // éšœå®³ä¿é™ºï¼ˆè€åŒ–ã‚«ãƒ¼ãƒ‰3æšã§æ‰‹æœ­ãƒªã‚»ãƒƒãƒˆï¼‰\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'éšœå®³ä¿é™º',\n      description: 'è€åŒ–ã‚«ãƒ¼ãƒ‰ãŒ3æšæƒã£ãŸæ™‚ã€æ‰‹æœ­ã‚’å…¨ã¦å¼•ãç›´ã—ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚',\n      power: 0,\n      cost: 2,\n      insuranceType: 'disability',\n      insuranceEffectType: 'trigger',\n      insuranceTriggerType: 'on_aging_gameover',\n      coverage: 0,\n      effects: [],\n      ageBonus,\n      durationType: 'whole_life'\n    } as any))\n\n    // å°±æ¥­ä¸èƒ½ä¿é™ºï¼ˆèª²é¡Œã‚¹ã‚­ãƒƒãƒ—ï¼‰\n    cards.push(new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: 'å°±æ¥­ä¸èƒ½ä¿é™º',\n      description: 'ã„ã¤ã§ã‚‚ç™ºå‹•å¯èƒ½ã€‚ç¾åœ¨ã®èª²é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—ï¼‰ã€‚è«‹æ±‚å¾Œã¯å¥‘ç´„çµ‚äº†ã€‚',\n      power: 0,\n      cost: 3,\n      insuranceType: 'income',\n      insuranceEffectType: 'trigger',\n      insuranceTriggerType: 'on_demand',\n      coverage: 0,\n      effects: [],\n      ageBonus,\n      durationType: 'whole_life'\n    } as any))\n\n    return cards\n  }\n\n  /**\n   * ä¿é™ºç¨®é¡é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆV3: 1ã¤ã®ä¿é™ºã‚¿ã‚¤ãƒ—ã‚’æç¤ºã—ã€ãƒ—ãƒ©ãƒ³A/Bã‚’é¸ã°ã›ã‚‹ï¼‰\n   */\n  static createInsuranceTypeChoices(stage: GameStage = 'youth'): InsuranceTypeChoice[] {\n    const ageBonus = this.calculateAgeBonus(stage)\n\n    // æ–°ãƒ»ä¿é™ºãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ï¼ˆå…¨3ç¨®ï¼‰\n    const insuranceDefinitions = [\n      {\n        type: 'medical' as InsuranceType,\n        name: 'ã˜ã¶ã‚“ã¸ã®ä¿é™º',\n        description: 'å¤±æ•—æ™‚ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹åŒ»ç™‚ä¿é™º',\n        power: 0,\n        // Plan A: ãŠå®ˆã‚Š (è»½æ¸›3)\n        planA: { cost: 1, duration: 10, cut: 3, desc: 'å®šé¡æ”¯æ‰•ãƒ—ãƒ©ãƒ³ï¼ˆå¤±æ•—ãƒ€ãƒ¡ãƒ¼ã‚¸-3ãƒ»ã‚³ã‚¹ãƒˆ1ï¼‰' },\n        // Plan B: é‰„å£ (è»½æ¸›8)\n        planB: { cost: 2, cut: 8, desc: 'å……å®Ÿä¿éšœãƒ—ãƒ©ãƒ³ï¼ˆå¤±æ•—ãƒ€ãƒ¡ãƒ¼ã‚¸-8ãƒ»ã‚³ã‚¹ãƒˆ2ï¼‰' },\n        effectType: 'defensive' as InsuranceEffectType,\n        triggerType: 'on_heavy_damage' as InsuranceTriggerType\n      },\n      {\n        type: 'cancer' as InsuranceType, // ãŒã‚“ä¿é™º\n        name: 'ãŒã‚“ä¿é™º',\n        description: 'äºˆæœŸã›ã¬å¤§ç—…ï¼ˆå¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰ã«å‚™ãˆã‚‹',\n        power: 0,\n        // Plan A: ä¸€æ™‚é‡‘ (1å›ä½¿ã„åˆ‡ã‚Š)\n        planA: { cost: 1, duration: 5, limit: 1, desc: 'è¨ºæ–­çµ¦ä»˜é‡‘ãƒ—ãƒ©ãƒ³ï¼ˆ20ä»¥ä¸Šã®æå®³ã‚’1å›ç„¡åŠ¹åŒ–ãƒ»ã‚³ã‚¹ãƒˆ1ï¼‰' },\n        // Plan B: ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  (ä½•åº¦ã§ã‚‚)\n        planB: { cost: 3, limit: -1, desc: 'é€šé™¢æ²»ç™‚ãƒ—ãƒ©ãƒ³ï¼ˆ20ä»¥ä¸Šã®æå®³ã‚’ä½•åº¦ã§ã‚‚ç„¡åŠ¹åŒ–ãƒ»ã‚³ã‚¹ãƒˆ3ï¼‰' },\n        effectType: 'defensive' as InsuranceEffectType,\n        triggerType: 'on_heavy_damage' as InsuranceTriggerType // 20ä»¥ä¸Šã®åˆ¤å®šã¯åˆ¥é€”\n      },\n      {\n        type: 'income' as InsuranceType,\n        name: 'ã¯ãŸã‚‰ãäººã¸ã®ä¿é™º',\n        description: 'æ‰‹æœ­äº‹æ•…ï¼ˆå°±æ¥­ä¸èƒ½ï¼‰æ™‚ã®ãƒªã‚»ãƒƒãƒˆä¿éšœ',\n        power: 0,\n        // Plan A: ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ (2ã‚¿ãƒ¼ãƒ³ã«1å›)\n        planA: { cost: 1, duration: 10, cooldown: 2, desc: 'æ¨™æº–æœˆé¡ãƒ—ãƒ©ãƒ³ï¼ˆ2ã‚¿ãƒ¼ãƒ³ã«1å›ãƒãƒªã‚¬ãƒ³å¯èƒ½ãƒ»ã‚³ã‚¹ãƒˆ1ï¼‰' },\n        // Plan B: ãƒ¯ã‚¤ãƒ‰ (æ¯ã‚¿ãƒ¼ãƒ³)\n        planB: { cost: 2, cooldown: 1, desc: 'ã‚ã‚“ã—ã‚“æ‰‹å½“ãƒ—ãƒ©ãƒ³ï¼ˆæ¯ã‚¿ãƒ¼ãƒ³ãƒãƒªã‚¬ãƒ³å¯èƒ½ãƒ»ã‚³ã‚¹ãƒˆ2ï¼‰' },\n        effectType: 'specialized' as InsuranceEffectType, // Special action\n        triggerType: 'on_demand' as InsuranceTriggerType\n      }\n    ]\n\n    // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ\n    const selectedDef = insuranceDefinitions[Math.floor(Math.random() * insuranceDefinitions.length)]!\n\n    const choice: InsuranceTypeChoice = {\n      insuranceType: selectedDef.type,\n      name: selectedDef.name,\n      description: selectedDef.description,\n      baseCard: {\n        name: selectedDef.name,\n        description: selectedDef.description,\n        type: 'insurance',\n        power: selectedDef.power,\n        cost: 1, // Placeholder\n        insuranceType: selectedDef.type,\n        coverage: 0, // Placeholder\n        insuranceEffectType: selectedDef.effectType,\n        insuranceTriggerType: selectedDef.triggerType,\n        effects: [],\n        ageBonus\n      },\n      // Plan A (mapped to termOption)\n      termOption: {\n        cost: selectedDef.planA.cost,\n        duration: selectedDef.planA.duration,\n        description: selectedDef.planA.desc\n      },\n      // Plan B (mapped to wholeLifeOption)\n      wholeLifeOption: {\n        cost: selectedDef.planB.cost,\n        description: selectedDef.planB.desc\n      }\n    }\n\n    // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã«ã“ã‚Œã‚‰ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å¼•ãç¶™ããŸã‚ã€\n    // ã‚²ãƒ¼ãƒ å´ã§é¸æŠæ™‚ã« metadata ã‚’ä»˜ä¸ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã ãŒã€\n    // ç¾çŠ¶ã¯ createTermInsuranceCard / createWholeLifeInsuranceCard ã§ç”Ÿæˆã•ã‚Œã‚‹ã€‚\n    // ãã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€Plan A/B ã®å…·ä½“çš„ãªæ•°å€¤ï¼ˆcut, cooldownï¼‰ã‚’åæ˜ ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚\n    // ã„ã£ãŸã‚“ã“ã“ã§ã¯Choiceã®ã‚¬ãƒ¯ã‚’ä½œã‚‹ã€‚\n\n    return [choice]\n  }\n\n  /**\n   * å®šæœŸä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createTermInsuranceCard(choice: InsuranceTypeChoice): Card {\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: `å®šæœŸ${choice.name}`,\n      description: `${choice.baseCard.description}ï¼ˆ${choice.termOption.duration}ã‚¿ãƒ¼ãƒ³é™å®šï¼‰`,\n      power: choice.baseCard.power,\n      cost: choice.termOption.cost,\n      insuranceType: choice.insuranceType,\n      coverage: choice.baseCard.coverage,\n      effects: choice.baseCard.effects,\n      ageBonus: choice.baseCard.ageBonus,\n      insuranceEffectType: choice.baseCard.insuranceEffectType,\n      insuranceTriggerType: choice.baseCard.insuranceTriggerType, // ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ \n      durationType: 'term',\n      remainingTurns: choice.termOption.duration\n    } as any)\n  }\n\n  /**\n   * çµ‚èº«ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createWholeLifeInsuranceCard(choice: InsuranceTypeChoice): Card {\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: `çµ‚èº«${choice.name}`,\n      description: `${choice.baseCard.description}ï¼ˆæ°¸ç¶šä¿éšœï¼‰`,\n      power: choice.baseCard.power,\n      cost: choice.wholeLifeOption.cost,\n      insuranceType: choice.insuranceType,\n      coverage: choice.baseCard.coverage,\n      effects: choice.baseCard.effects,\n      ageBonus: choice.baseCard.ageBonus,\n      insuranceEffectType: choice.baseCard.insuranceEffectType,\n      insuranceTriggerType: choice.baseCard.insuranceTriggerType, // ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ \n      durationType: 'whole_life'\n    } as any)\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createChallengeCards(stage: GameStage): Card[] {\n    const challengeDefinitionsByStage = {\n      youth: [\n        // åŸºæœ¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆé›£æ˜“åº¦: ä½ã€œä¸­ï¼‰- Hand Size 5ã«åˆã‚ã›ã¦èª¿æ•´ (Power ~10-15 needed to challenge typical hand)\n        // Starter Deck Avg Power ~1.4 * 5 = 7.0 (Nerfed).\n        // Challenge Power should be 8-12.\n        // V3.2 Balance: Hardcore. Power 10-16. 2 fails = death.\n        { name: 'ã‚¢ãƒ«ãƒã‚¤ãƒˆæ¢ã—', description: 'åˆã‚ã¦ã®åå…¥ã‚’å¾—ã‚‹', power: 10, damage: 10, dreamCategory: 'physical' as DreamCategory },\n        { name: 'ä¸€äººæš®ã‚‰ã—', description: 'ç‹¬ç«‹ã¸ã®ç¬¬ä¸€æ­©', power: 12, damage: 12, dreamCategory: 'physical' as DreamCategory },\n        { name: 'è³‡æ ¼è©¦é¨“', description: 'ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã®ãƒãƒ£ãƒ³ã‚¹', power: 14, damage: 14, dreamCategory: 'intellectual' as DreamCategory },\n        { name: 'å°±è·æ´»å‹•', description: 'æ–°ãŸãªã‚­ãƒ£ãƒªã‚¢ã®å§‹ã¾ã‚Š', power: 16, damage: 16, dreamCategory: 'physical' as DreamCategory },\n        // ä¸­ç´šãƒãƒ£ãƒ¬ãƒ³ã‚¸\n        { name: 'æ‹äººã¨ã®åˆ¥ã‚Œ', description: 'åˆã‚ã¦ã®å¤§ããªå¤±æ„', power: 13, damage: 13, dreamCategory: 'mixed' as DreamCategory },\n        { name: 'è»¢è·æ´»å‹•', description: 'ã‚­ãƒ£ãƒªã‚¢ã®åˆ†å²ç‚¹', power: 15, damage: 15, dreamCategory: 'intellectual' as DreamCategory }\n      ],\n      middle: [\n        // åŸºæœ¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆé›£æ˜“åº¦: ä¸­ï¼‰\n        // V3.1 Balance: Late game too easy (100% win rate). Buffing significantly.\n        { name: 'çµå©šè³‡é‡‘', description: 'æ–°ã—ã„å®¶æ—ã®ã‚¹ã‚¿ãƒ¼ãƒˆ', power: 22, damage: 8, dreamCategory: 'mixed' as DreamCategory },\n        { name: 'å­è‚²ã¦', description: 'å®¶æ—ã®æˆé•·', power: 24, damage: 8, dreamCategory: 'physical' as DreamCategory },\n        { name: 'ä¸¡è¦ªã®å¥åº·', description: 'å®¶æ—ã®æ”¯ãˆåˆã„', power: 22, damage: 7, dreamCategory: 'mixed' as DreamCategory },\n        { name: 'ä½å®…è³¼å…¥', description: 'å¤§ããªæ±ºæ–­', power: 28, damage: 10, dreamCategory: 'physical' as DreamCategory },\n        // é«˜é›£åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸\n        { name: 'è¦ªã®ä»‹è­·', description: 'å®¶æ—ã®è²¬ä»»', power: 32, damage: 12, dreamCategory: 'mixed' as DreamCategory },\n        { name: 'æ•™è‚²è³‡é‡‘', description: 'å­ä¾›ã®å°†æ¥ã¸ã®æŠ•è³‡', power: 26, damage: 9, dreamCategory: 'intellectual' as DreamCategory }\n      ],\n      fulfillment: [\n        // å……å®ŸæœŸï¼ˆé›£æ˜“åº¦: é«˜ - äººç”Ÿã®é›†å¤§æˆã€ã‚ˆã‚Šå£®å¤§ãªç›®æ¨™ã¸ï¼‰\n        // V3.1 Balance: Advanced players must face lethal threats.\n        { name: 'æ¬¡ä¸–ä»£ã®è‚²æˆ', description: 'è‹¥è€…ãŸã¡ã«çŸ¥è­˜ã¨çµŒé¨“ã‚’ä¼ãˆã‚‹', power: 25, damage: 8, dreamCategory: 'intellectual' as DreamCategory },\n        { name: 'åœ°åŸŸç¤¾ä¼šã®å¤‰é©', description: 'ä½ã¿ã‚ˆã„ç¤¾ä¼šã‚’ä½œã‚‹ãŸã‚ã®æ´»å‹•', power: 28, damage: 10, dreamCategory: 'mixed' as DreamCategory },\n        { name: 'ç”Ÿæ¶¯ã®ç ”ç©¶ç™ºè¡¨', description: 'é•·å¹´ã®æ¢ç©¶ã®æˆæœã‚’ä¸–ã«å‡ºã™', power: 30, damage: 10, dreamCategory: 'intellectual' as DreamCategory },\n        { name: 'ä¸–ç•Œå¹³å’Œã¸ã®è²¢çŒ®', description: 'å›½å¢ƒã‚’è¶ŠãˆãŸæ…ˆå–„æ´»å‹•', power: 35, damage: 12, dreamCategory: 'mixed' as DreamCategory },\n        // æœ€é«˜é›£åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸\n        { name: 'å®‡å®™æ—…è¡Œ', description: 'äººé¡ã®å¤¢ã€æ˜Ÿã€…ã®æµ·ã¸', power: 45, damage: 15, dreamCategory: 'physical' as DreamCategory, isDream: true },\n        { name: 'ä¼èª¬ã®ç¶™æ‰¿', description: 'è‡ªèº«ã®ç”Ÿãæ§˜ã‚’ä¼èª¬ã¨ã—ã¦æ®‹ã™', power: 50, damage: 20, dreamCategory: 'mixed' as DreamCategory, isDream: true }\n      ]\n    }\n\n    const definitions = challengeDefinitionsByStage[stage] || challengeDefinitionsByStage.fulfillment\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«é©åˆ‡ãªé›£æ˜“åº¦ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠ\n    // ãƒ©ãƒ³ãƒ€ãƒ ã«3-4æšé¸ã¶ãŒã€é›£æ˜“åº¦ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®\n    const shuffled = [...definitions].sort(() => Math.random() - 0.5)\n    const selectedCount = 3 + Math.floor(Math.random() * 2) // 3-4æš\n    const selected = shuffled.slice(0, selectedCount)\n\n    const normalChallenges = this.createCardsFromDefinitions(selected, def => this.createChallengeCard({ ...def, penalty: def.damage, isDream: (def as any).isDream || false }))\n\n    // ãƒªã‚¹ã‚¯ãƒ»ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¿½åŠ ï¼ˆ20%ã®ç¢ºç‡ï¼‰\n    const riskChallenges = this.createRiskRewardChallenges(stage)\n\n    // fulfillmentã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯å¤¢ã‚«ãƒ¼ãƒ‰ã‚’å¤§é‡ã«è¿½åŠ ï¼ˆå¤¢é”æˆã§å‹åˆ©ã§ãã‚‹ï¼‰\n    const challenges = [...normalChallenges, ...riskChallenges]\n\n    // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§å¤¢ã‚«ãƒ¼ãƒ‰ãŒå‡ºç¾ã™ã‚‹ãƒãƒ£ãƒ³ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰\n    // V3.2 Hardcore: Youthã‚¹ãƒ†ãƒ¼ã‚¸ã§ã‚‚å¤¢ï¼ˆç†ä¸å°½ãªæ­»ï¼‰ãŒå‡ºç¾ã™ã‚‹\n    const dreamCards = this.createDreamCards()\n    const dreamCount = Math.floor(Math.random() * 2) + 1 // 1-2æš\n    for (let i = 0; i < dreamCount; i++) {\n      const randomDream = dreamCards[Math.floor(Math.random() * dreamCards.length)]\n      if (randomDream) {\n        challenges.push(randomDream)\n      }\n    }\n\n    return challenges\n  }\n\n  /**\n   * å¤¢ã‚«ãƒ¼ãƒ‰ï¼ˆæœ€çµ‚ç›®æ¨™ï¼‰ã‚’ç”Ÿæˆ\n   */\n  static createDreamCards(): Card[] {\n    const dreamDefinitions = [\n      // å¤¢ã‚«ãƒ¼ãƒ‰: è¶…é«˜é›£æ˜“åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆå¤±æ•—ãƒ»å›é¿ã§é›£æ˜“åº¦ä¸Šæ˜‡ï¼‰\n      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›: é›£æ˜“åº¦80\n      { name: 'ä¸–ç•Œä¸€å‘¨æ—…è¡Œ', description: 'æœªçŸ¥ã®ä¸–ç•Œã‚’ä½“é¨“ã™ã‚‹å¤§å†’é™º', power: 80, damage: 40, dreamCategory: 'physical' as DreamCategory },\n      { name: 'æœ¬ã®å‡ºç‰ˆ', description: 'è‡ªåˆ†ã®çŸ¥è­˜ã‚’ä¸–ã«æ®‹ã™æŒ‘æˆ¦', power: 80, damage: 40, dreamCategory: 'intellectual' as DreamCategory },\n      { name: 'å¹¸ã›ãªå®¶åº­', description: 'æ„›ã«æº€ã¡ãŸç”Ÿæ´»ã‚’ç¯‰ã', power: 75, damage: 35, dreamCategory: 'mixed' as DreamCategory },\n      { name: 'èµ·æ¥­ã—ã¦æˆåŠŸ', description: 'è‡ªåˆ†ã®ãƒ“ã‚¸ãƒã‚¹ã§æˆåŠŸã‚’æ´ã‚€', power: 85, damage: 50, dreamCategory: 'mixed' as DreamCategory },\n      { name: 'éš å±…ç”Ÿæ´»', description: 'é™ã‹ã§ç©ã‚„ã‹ãªä½™ç”Ÿã‚’é€ã‚‹', power: 70, damage: 30, dreamCategory: 'physical' as DreamCategory }\n    ]\n\n    return this.createCardsFromDefinitions(dreamDefinitions, def => this.createChallengeCard({ ...def, penalty: def.damage, isDream: true }))\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ»ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç”Ÿæˆ\n   */\n  static createRiskRewardChallenges(stage: GameStage): Card[] {\n    const challenges: Card[] = []\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ãŸãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®åˆ†å¸ƒ\n    const riskDistribution = {\n      youth: { low: 0.5, medium: 0.3, high: 0.15, extreme: 0.05 },\n      middle: { low: 0.3, medium: 0.4, high: 0.2, extreme: 0.1 },\n      fulfillment: { low: 0.2, medium: 0.3, high: 0.3, extreme: 0.2 }\n    }\n\n    const distribution = riskDistribution[stage as 'youth' | 'middle' | 'fulfillment'] || riskDistribution.youth\n\n    // å„ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç”Ÿæˆï¼ˆç¢ºç‡ã«åŸºã¥ãï¼‰\n    const random = Math.random()\n\n    if (random < 0.2) { // 20%ã®ç¢ºç‡ã§ãƒªã‚¹ã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¿½åŠ \n      let riskLevel: 'low' | 'medium' | 'high' | 'extreme'\n      const levelRandom = Math.random()\n\n      if (levelRandom < distribution.low) {\n        riskLevel = 'low'\n      } else if (levelRandom < distribution.low + distribution.medium) {\n        riskLevel = 'medium'\n      } else if (levelRandom < distribution.low + distribution.medium + distribution.high) {\n        riskLevel = 'high'\n      } else {\n        riskLevel = 'extreme'\n      }\n\n      const riskChallenge = RiskRewardChallenge.createRiskChallenge(\n        stage as 'youth' | 'middle' | 'fulfillment',\n        riskLevel\n      )\n\n      challenges.push(riskChallenge)\n    }\n\n    return challenges\n  }\n\n  /**\n   * è½ã¨ã—ç©´ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createPitfallCards(): Card[] {\n    const pitfallDefinitions = [\n      { name: 'æ€¥ãªå…¥é™¢', description: 'äºˆæœŸã›ã¬åŒ»ç™‚è²»', power: 0, penalty: 3 },\n      { name: 'å¤±æ¥­', description: 'åå…¥ã®é€”çµ¶', power: 0, penalty: 4 },\n      { name: 'äº‹æ•…', description: 'äºˆæœŸã›ã¬ãƒˆãƒ©ãƒ–ãƒ«', power: 0, penalty: 2 }\n    ]\n\n    return this.createCardsFromDefinitions(pitfallDefinitions, def => this.createPitfallCard(def))\n  }\n\n  /**\n   * äººç”Ÿã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ã«publicã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚è¿½åŠ ï¼‰\n   */\n  createLifeCard(params: {\n    category: LifeCardCategory\n    basePower: number\n    baseCost: number\n  }): Card {\n    return CardFactory.createLifeCard({\n      name: `ãƒ†ã‚¹ãƒˆ${params.category}ã‚«ãƒ¼ãƒ‰`,\n      description: `${params.category}ã®ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰`,\n      category: params.category,\n      power: params.basePower,\n      cost: params.baseCost\n    })\n  }\n\n  /**\n   * äººç”Ÿã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆé™çš„ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰\n   */\n  private static createLifeCard(params: {\n    name: string\n    description: string\n    category: LifeCardCategory\n    power: number\n    cost: number\n  }): Card {\n    if (params.power < 0) throw new Error('Life card power cannot be negative')\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'life',\n      name: params.name,\n      description: params.description,\n      power: params.power,\n      cost: params.cost,\n      category: params.category,\n      effects: []\n    })\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆPhase 2å¯¾å¿œï¼‰\n   */\n  private static createInsuranceCard(params: {\n    name: string\n    description: string\n    insuranceType: InsuranceType\n    power: number\n    cost: number\n    coverage: number\n    ageBonus?: number\n  }): Card {\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'insurance',\n      name: params.name,\n      description: params.description,\n      power: params.power,\n      cost: params.cost,\n      insuranceType: params.insuranceType,\n      coverage: params.coverage,\n      effects: [{\n        type: 'shield',\n        value: params.coverage,\n        description: `${params.coverage}ãƒã‚¤ãƒ³ãƒˆã®ä¿éšœ`\n      }],\n      ageBonus: params.ageBonus || 0\n    })\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  private static createChallengeCard(params: {\n    name: string\n    description: string\n    power: number\n    penalty: number\n    dreamCategory?: DreamCategory\n    isDream?: boolean\n  }): Card {\n    const type = params.isDream ? 'dream' : 'challenge'\n    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®é›£æ˜“åº¦ã«åŸºã¥ã„ã¦å ±é…¬ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š\n    const rewardType = this.determineRewardType(params.power, type)\n\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type,\n      name: params.name,\n      description: params.description,\n      power: params.power,\n      cost: 0,\n      penalty: params.penalty,\n      effects: [],\n      dreamCategory: params.dreamCategory,\n      rewardType // å ±é…¬ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ \n    } as any)\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®é›£æ˜“åº¦ã¨ç¨®é¡ã«åŸºã¥ã„ã¦å ±é…¬ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š\n   */\n  private static determineRewardType(power: number, type: string): RewardType {\n    // å¤¢ã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯æ´»åŠ›å›å¾©\n    if (type === 'dream') {\n      return 'vitality'\n    }\n\n    // ãƒ‘ãƒ¯ãƒ¼ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦å ±é…¬ã‚’æ±ºå®š\n    if (power <= 3) {\n      return 'insurance' // ä½é›£æ˜“åº¦ï¼šä¿é™ºç²å¾—\n    } if (power <= 6) {\n      return 'insurance' // ä¸­é›£æ˜“åº¦ï¼šä¿é™ºç²å¾—ï¼ˆåŸºæœ¬ï¼‰\n    }\n    return 'card' // é«˜é›£æ˜“åº¦ï¼šè¿½åŠ ã‚«ãƒ¼ãƒ‰ç²å¾—\n  }\n\n  /**\n   * è½ã¨ã—ç©´ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  private static createPitfallCard(params: {\n    name: string\n    description: string\n    power: number\n    penalty: number\n  }): Card {\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'trouble',\n      name: params.name,\n      description: params.description,\n      power: params.power,\n      cost: 0,\n      penalty: params.penalty,\n      effects: []\n    })\n  }\n\n\n\n  /**\n   * æ±ç”¨ã‚«ãƒ¼ãƒ‰ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰\n   */\n  static createCard(params: {\n    base: { name: string, type: string, description: string, id?: string },\n    variant: string,\n    effects?: any[]\n  }): Card {\n    const { base, effects } = params\n    return new Card({\n      id: base.id || IdGenerator.generateCardId(),\n      type: base.type as any,\n      name: base.name,\n      description: base.description,\n      power: 0,\n      cost: 0,\n      effects: effects || []\n    } as any)\n  }\n\n  /**\n   * è€åŒ–ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createAgingCards(count: number): Card[] {\n    const cards: Card[] = []\n    for (let i = 0; i < count; i++) {\n      cards.push(new Card({\n        id: IdGenerator.generateCardId(),\n        type: 'aging',\n        name: 'è€åŒ–',\n        description: 'å¹´é½¢ã«ã‚ˆã‚‹è¡°ãˆã€‚ä½¿ç”¨ä¸å¯ã€‚',\n        power: 0,\n        cost: 0,\n        effects: [{\n          type: 'aging_penalty',\n          value: 0,\n          description: 'æ‰‹æœ­ã«ã‚ã‚‹ã¨æ´»åŠ›ãŒæ¸›å°‘ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹'\n        }]\n      }))\n    }\n    return cards\n  }\n\n  /**\n   * æœ€çµ‚è©¦ç·´ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   */\n  static createFinalChallengeCard(): Card {\n    return new Card({\n      id: IdGenerator.generateCardId(),\n      type: 'final_challenge',\n      name: 'äººç”Ÿã®ç·æ±ºç®—',\n      description: 'ã“ã‚Œã¾ã§ã®äººç”Ÿã®ã™ã¹ã¦ã‚’è³­ã‘ãŸæœ€å¾Œã®æŒ‘æˆ¦',\n      power: 0, // Dynamic power based on calculation\n      cost: 0,\n      effects: []\n    })\n  }\n\n  /**\n   * ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createSkillCards(stage: GameStage = 'youth'): Card[] {\n    const skillDefinitionsByStage = {\n      youth: [\n        { name: 'é›†ä¸­åŠ›', description: 'é›†ä¸­ã—ã¦å–ã‚Šçµ„ã‚€èƒ½åŠ›', rarity: 'common' as SkillRarity, power: 3, cooldown: 0 },\n        { name: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', description: 'äººã¨ã®é–¢ã‚ã‚Šã‚’æ·±ã‚ã‚‹', rarity: 'common' as SkillRarity, power: 4, cooldown: 1 },\n        { name: 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', description: 'ãƒãƒ¼ãƒ ã‚’ç‡ã„ã‚‹åŠ›', rarity: 'rare' as SkillRarity, power: 6, cooldown: 2 },\n        { name: 'å‰µé€ æ€§', description: 'æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿã¿å‡ºã™', rarity: 'epic' as SkillRarity, power: 8, cooldown: 3 }\n      ],\n      middle: [\n        { name: 'æˆ¦ç•¥çš„æ€è€ƒ', description: 'é•·æœŸçš„ãªè¦–ç‚¹ã§è€ƒãˆã‚‹', rarity: 'rare' as SkillRarity, power: 7, cooldown: 2 },\n        { name: 'ãƒ¡ãƒ³ã‚¿ãƒªãƒ³ã‚°', description: 'å¾Œè¼©ã‚’æŒ‡å°ã™ã‚‹èƒ½åŠ›', rarity: 'rare' as SkillRarity, power: 6, cooldown: 1 },\n        { name: 'å±æ©Ÿç®¡ç†', description: 'ãƒªã‚¹ã‚¯ã‚’äºˆæ¸¬ã—å¯¾å‡¦ã™ã‚‹', rarity: 'epic' as SkillRarity, power: 9, cooldown: 3 },\n        { name: 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', description: 'é©æ–°çš„ãªå¤‰åŒ–ã‚’èµ·ã“ã™', rarity: 'legendary' as SkillRarity, power: 12, cooldown: 4 }\n      ],\n      fulfillment: [\n        { name: 'äººç”Ÿã®çŸ¥æµ', description: 'çµŒé¨“ã‹ã‚‰å¾—ãŸæ·±ã„æ´å¯Ÿ', rarity: 'epic' as SkillRarity, power: 10, cooldown: 2 },\n        { name: 'ãƒ¬ã‚¬ã‚·ãƒ¼æ§‹ç¯‰', description: 'æ¬¡ä¸–ä»£ã¸ã®ä¾¡å€¤ã‚ã‚‹éºç”£', rarity: 'legendary' as SkillRarity, power: 15, cooldown: 5 },\n        { name: 'ç²¾ç¥çš„å¹³å’Œ', description: 'å†…ãªã‚‹èª¿å’Œã¨å®‰å®š', rarity: 'legendary' as SkillRarity, power: 13, cooldown: 3 }\n      ]\n    }\n\n    const definitions = skillDefinitionsByStage[stage] || skillDefinitionsByStage.youth\n    return this.createCardsFromDefinitions(definitions, def =>\n      Card.createSkillCard(def.name, def.rarity, def.power, def.cooldown)\n    )\n  }\n\n  /**\n   * ã‚³ãƒ³ãƒœã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createComboCards(): Card[] {\n    const comboDefinitions = [\n      {\n        name: 'ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹',\n        power: 2,\n        requiredCards: ['career', 'family'],\n        comboBonus: 4,\n        description: 'ã‚­ãƒ£ãƒªã‚¢ã¨å®¶æ—ã®èª¿å’Œ'\n      },\n      {\n        name: 'å¥åº·çš„ãªæˆåŠŸ',\n        power: 3,\n        requiredCards: ['health', 'finance'],\n        comboBonus: 5,\n        description: 'å¥åº·ã¨çµŒæ¸ˆçš„å®‰å®šã®ä¸¡ç«‹'\n      },\n      {\n        name: 'å……å®Ÿã—ãŸäººç”Ÿ',\n        power: 4,\n        requiredCards: ['hobby', 'family', 'career'],\n        comboBonus: 8,\n        description: 'è¶£å‘³ãƒ»å®¶æ—ãƒ»ã‚­ãƒ£ãƒªã‚¢ã®ä¸‰ä½ä¸€ä½“'\n      }\n    ]\n\n    return this.createCardsFromDefinitions(comboDefinitions, def =>\n      Card.createComboCard(def.name, def.power, def.requiredCards, def.comboBonus)\n    )\n  }\n\n  /**\n   * ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createEventCards(stage: GameStage = 'youth'): Card[] {\n    const eventDefinitionsByStage = {\n      youth: [\n        { name: 'æ–°å¹´ã®æŠ±è² ', description: 'æ–°ã—ã„å¹´ã¸ã®æ±ºæ„', power: 5, duration: 3, globalEffect: false },\n        { name: 'å°±è·ãƒ–ãƒ¼ãƒ ', description: 'é›‡ç”¨æ©Ÿä¼šã®å¢—åŠ ', power: 4, duration: 2, globalEffect: true },\n        { name: 'å¥åº·ãƒ–ãƒ¼ãƒ ', description: 'å¥åº·ã¸ã®æ„è­˜å‘ä¸Š', power: 3, duration: 4, globalEffect: true }\n      ],\n      middle: [\n        { name: 'çµŒæ¸ˆæˆé•·æœŸ', description: 'ç¤¾ä¼šå…¨ä½“ã®æ´»æ³', power: 6, duration: 3, globalEffect: true },\n        { name: 'å®¶æ—ã®çµ†', description: 'å®¶æ—é–¢ä¿‚ã®æ·±åŒ–', power: 7, duration: 2, globalEffect: false },\n        { name: 'æŠ€è¡“é©æ–°', description: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®é€²æ­©', power: 8, duration: 4, globalEffect: true }\n      ],\n      fulfillment: [\n        { name: 'äººç”Ÿã®ç·æ±ºç®—', description: 'çµŒé¨“ã®çµ±åˆã¨æˆç†Ÿ', power: 10, duration: 2, globalEffect: false },\n        { name: 'ä¸–ä»£äº¤ä»£', description: 'æ¬¡ä¸–ä»£ã¸ã®ç¶™æ‰¿', power: 9, duration: 3, globalEffect: true }\n      ]\n    }\n\n    const definitions = eventDefinitionsByStage[stage] || eventDefinitionsByStage.youth\n    return this.createCardsFromDefinitions(definitions, def =>\n      Card.createEventCard(def.name, def.power, def.duration, def.globalEffect)\n    )\n  }\n\n  /**\n   * ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¶ï¼‰\n   */\n  static createLegendaryCards(): Card[] {\n    const legendaryDefinitions = [\n      {\n        name: 'äººç”Ÿã®é”äºº',\n        power: 20,\n        unlockCondition: 'å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã§50å›ä»¥ä¸ŠæˆåŠŸ',\n        description: 'äººç”ŸçµŒé¨“ã®é›†å¤§æˆ'\n      },\n      {\n        name: 'é‹å‘½ã‚’å¤‰ãˆã‚‹æ±ºæ–­',\n        power: 25,\n        unlockCondition: 'é€£ç¶š10å›ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸ',\n        description: 'äººç”Ÿã‚’åŠ‡çš„ã«å¤‰ãˆã‚‹ç¬é–“'\n      },\n      {\n        name: 'å®Œç’§ãªèª¿å’Œ',\n        power: 30,\n        unlockCondition: 'å…¨ã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’50æšä»¥ä¸Šç²å¾—',\n        description: 'ã™ã¹ã¦ã®å´é¢ãŒå®Œç’§ã«ãƒãƒ©ãƒ³ã‚¹ã—ãŸçŠ¶æ…‹'\n      }\n    ]\n\n    return this.createCardsFromDefinitions(legendaryDefinitions, def =>\n      Card.createLegendaryCard(def.name, def.power, def.unlockCondition)\n    )\n  }\n  /**\n   * å ±é…¬ç”¨ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n   */\n  static createRewardCards(stage: GameStage, count: number): Card[] {\n    // ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’å ±é…¬ã®åŸºæœ¬ã¨ã™ã‚‹\n    const candidates = this.createSkillCards(stage)\n\n    // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ\n    const shuffled = [...candidates].sort(() => Math.random() - 0.5)\n    return shuffled.slice(0, count)\n  }\n}","import type { Card } from '../entities/Card'\nimport { Deck } from '../entities/Deck'\nimport type { GameConfig } from '../types/game.types'\n\n/**\n * ã‚«ãƒ¼ãƒ‰ç®¡ç†ã®çŠ¶æ…‹\n */\nexport interface CardManagerState {\n  hand: Card[]\n  discardPile: Card[]\n  playerDeck: Deck\n  challengeDeck: Deck\n  selectedCards: Card[]\n  cardChoices: Card[] | undefined\n  // v2 new fields\n  agingDeck: Deck\n  insuranceMarket: Card[]\n  activeInsurances: Card[]\n}\n\n/**\n * ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼çµæœ\n */\nexport interface DrawResult {\n  drawnCards: Card[]\n  discardedCards: Card[] // æ‰‹æœ­ä¸Šé™ã«ã‚ˆã‚Šæ¨ã¦ã‚‰ã‚ŒãŸã‚«ãƒ¼ãƒ‰\n  troubleCards: Card[] // å³æ™‚ç™ºå‹•ã™ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰\n}\n\n/**\n * CardManagerã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\n */\nexport interface ICardManager {\n  /**\n   * ã‚«ãƒ¼ãƒ‰ç®¡ç†çŠ¶æ…‹ã‚’åˆæœŸåŒ–\n   */\n  initialize(playerDeck: Deck, challengeDeck: Deck, config: GameConfig): void\n\n  /**\n   * ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—\n   */\n  getState(): CardManagerState\n\n  /**\n   * çŠ¶æ…‹ã‚’å¾©å…ƒ\n   */\n  setState(state: CardManagerState): void\n\n  /**\n   * æŒ‡å®šã—ãŸæšæ•°ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼\n   */\n  drawCards(count: number): DrawResult\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ/é¸æŠè§£é™¤\n   */\n  toggleCardSelection(card: Card): boolean\n\n  /**\n   * é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearSelection(): void\n\n  /**\n   * é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã‹ã‚‰æ¨ã¦æœ­ã«ç§»å‹•\n   */\n  discardSelectedCards(): Card[]\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«è¿½åŠ \n   */\n  addToHand(card: Card): void\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«è¿½åŠ \n   */\n  addToDiscardPile(card: Card): void\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒƒã‚­ã«è¿½åŠ \n   */\n  addToPlayerDeck(card: Card): void\n\n  /**\n   * æ‰‹æœ­ä¸Šé™ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´\n   */\n  enforceHandLimit(): Card[]\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’è¨­å®š\n   */\n  setCardChoices(choices: Card[]): void\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearCardChoices(): void\n\n  /**\n   * æŒ‡å®šIDã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠè‚¢ã‹ã‚‰å–å¾—\n   */\n  /**\n   * æŒ‡å®šIDã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠè‚¢ã‹ã‚‰å–å¾—\n   */\n  getCardChoiceById(cardId: string): Card | undefined\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã\n   */\n  drawChallengeCard(): Card | null\n\n  // v2 methods\n  buyInsurance(card: Card): void\n  removeCardFromGame(card: Card): void\n  addAgingCardToDiscard(): void\n  getInsuranceMarket(): Card[]\n  getActiveInsurances(): Card[]\n  refillChallengeDeck(cards: Card[]): void\n  getChallengeDeckSize(): number\n  discardHand(): Card[]\n}\n\n/**\n * ã‚«ãƒ¼ãƒ‰ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n */\nexport class CardManager implements ICardManager {\n  private hand: Card[] = []\n  private discardPile: Card[] = []\n  private playerDeck: Deck = new Deck('Player Deck')\n  private challengeDeck: Deck = new Deck('Challenge Deck')\n  private selectedCards: Card[] = []\n  private cardChoices: Card[] | undefined\n  private config?: GameConfig\n  // v2 fields\n  private agingDeck: Deck = new Deck('Aging Deck')\n  private insuranceMarket: Card[] = []\n  private activeInsurances: Card[] = []\n\n  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«\n  private static readonly CARD_POOLS = {\n    drawResults: [] as DrawResult[]\n  }\n\n  // IDãƒ™ãƒ¼ã‚¹ã®é¸æŠçŠ¶æ…‹ç®¡ç†ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã”ã¨ï¼‰\n  private selectedIdsSet = new Set<string>()\n\n  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥\n  private _cachedState: CardManagerState | undefined\n  private _stateVersion = 0\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ç®¡ç†çŠ¶æ…‹ã‚’åˆæœŸåŒ–\n   */\n  initialize(playerDeck: Deck, challengeDeck: Deck, config: GameConfig): void {\n    this.playerDeck = playerDeck\n    this.challengeDeck = challengeDeck\n    this.hand = []\n    this.discardPile = []\n    this.selectedCards = []\n    this.selectedIdsSet.clear()\n    this.cardChoices = undefined\n    this.config = config\n    // v2 init\n    this.agingDeck = new Deck('Aging Deck') // Should be populated from outside or config in real app\n    this.insuranceMarket = []\n    this.activeInsurances = []\n  }\n\n  /**\n   * ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–ç‰ˆï¼‰\n   */\n  getState(): CardManagerState {\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªå ´åˆã¯ãã‚Œã‚’è¿”ã™\n    if (this._cachedState && this._stateVersion > 0) {\n      return this._cachedState\n    }\n\n    console.log('[CardManager] getState rebuilding cache. Hand size:', this.hand.length)\n\n    // æ–°ã—ã„çŠ¶æ…‹ã‚’ä½œæˆ\n    const state: CardManagerState = {\n      hand: [...this.hand],\n      discardPile: [...this.discardPile],\n      playerDeck: this.playerDeck.clone(),\n      challengeDeck: this.challengeDeck.clone(),\n      selectedCards: [...this.selectedCards],\n      cardChoices: this.cardChoices ? [...this.cardChoices] : undefined,\n      agingDeck: this.agingDeck.clone(),\n      insuranceMarket: [...this.insuranceMarket],\n      activeInsurances: [...this.activeInsurances]\n    }\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜\n    this._cachedState = state\n    this._stateVersion++\n\n    return state\n  }\n\n  /**\n   * çŠ¶æ…‹ã‚’å¾©å…ƒ\n   */\n  setState(state: CardManagerState): void {\n    this.hand = [...state.hand]\n    this.discardPile = [...state.discardPile]\n    this.playerDeck = state.playerDeck.clone()\n    this.challengeDeck = state.challengeDeck.clone()\n    this.selectedCards = [...state.selectedCards]\n    this.cardChoices = state.cardChoices ? [...state.cardChoices] : undefined\n    this.agingDeck = state.agingDeck.clone()\n    this.insuranceMarket = [...state.insuranceMarket]\n    this.activeInsurances = [...state.activeInsurances]\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–\n    this.invalidateCache()\n\n    // selectedIdsSetã‚’å†æ§‹ç¯‰\n    this.selectedIdsSet.clear()\n    this.selectedCards.forEach(c => this.selectedIdsSet.add(c.id))\n  }\n\n  /**\n   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–\n   */\n  private invalidateCache(): void {\n    this._cachedState = undefined\n    this._stateVersion = 0\n  }\n\n  /**\n   * æŒ‡å®šã—ãŸæšæ•°ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n   */\n  drawCards(count: number): DrawResult {\n    if (!this.config) {\n      throw new Error('CardManager not initialized')\n    }\n\n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‹ã‚‰DrawResultã‚’å–å¾—\n    let result = CardManager.CARD_POOLS.drawResults.pop()\n    if (!result) {\n      result = { drawnCards: [], discardedCards: [], troubleCards: [] }\n    } else {\n      // é…åˆ—ã‚’ã‚¯ãƒªã‚¢\n      result.drawnCards.length = 0\n      result.discardedCards.length = 0\n      result.troubleCards.length = 0\n    }\n\n    for (let i = 0; i < count; i++) {\n      // ãƒ‡ãƒƒã‚­ãŒç©ºã®å ´åˆã€æ¨ã¦æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å±±æœ­ã«æˆ»ã™\n      if (this.playerDeck.isEmpty() && this.discardPile.length > 0) {\n        this.reshuffleDeck()\n      }\n\n      const card = this.playerDeck.drawCard()\n      if (card) {\n        if (card.type === 'trouble') {\n          // ãƒˆãƒ©ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã¯æ‰‹æœ­ã«å…¥ã‚‰ãšå³æ™‚ç™ºå‹•ç”¨ã«åˆ†é›¢\n          result.troubleCards.push(card)\n          this.discardPile.push(card) // å³åº§ã«æ¨ã¦æœ­ã¸ (åŠ¹æœã¯åˆ¥é€”å‡¦ç†)\n          console.log('[CardManager] Drawn Trouble card:', card.name)\n        } else {\n          result.drawnCards.push(card)\n          this.hand.push(card)\n          console.log('[CardManager] Added card to hand. Hand size:', this.hand.length, 'Card:', card.name)\n        }\n      } else {\n        console.warn('[CardManager] Failed to draw card (deck empty?)')\n      }\n    }\n\n    // æ‰‹æœ­ä¸Šé™ãƒã‚§ãƒƒã‚¯\n    const discardedCards = this.enforceHandLimit()\n    result.discardedCards.push(...discardedCards)\n\n    console.log('[CardManager] drawCards finished. Final hand size:', this.hand.length)\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–\n    this.invalidateCache()\n\n    return result\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ/é¸æŠè§£é™¤ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n   */\n  toggleCardSelection(card: Card): boolean {\n    const cardId = card.id\n\n    // Setãƒ™ãƒ¼ã‚¹ã®IDãƒã‚§ãƒƒã‚¯ã§é«˜é€ŸåŒ–\n    if (this.selectedIdsSet.has(cardId)) {\n      // é¸æŠè§£é™¤\n      this.selectedIdsSet.delete(cardId)\n      const index = this.selectedCards.findIndex(c => c.id === cardId)\n      if (index !== -1) {\n        this.selectedCards.splice(index, 1)\n      }\n      this.invalidateCache()\n      return false // é¸æŠè§£é™¤\n    }\n    // é¸æŠ\n    this.selectedIdsSet.add(cardId)\n    this.selectedCards.push(card)\n    this.invalidateCache()\n    return true // é¸æŠ\n\n  }\n\n  /**\n   * é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n   */\n  clearSelection(): void {\n    this.selectedCards.length = 0\n    this.selectedIdsSet.clear()\n    this.invalidateCache()\n  }\n\n  /**\n   * é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã‹ã‚‰æ¨ã¦æœ­ã«ç§»å‹•\n   */\n  discardSelectedCards(): Card[] {\n    const discardedCards: Card[] = []\n\n    this.selectedCards.forEach(card => {\n      const index = this.hand.findIndex(c => c.id === card.id)\n      if (index !== -1) {\n        const removedCard = this.hand.splice(index, 1)[0]\n        if (removedCard) {\n          this.discardPile.push(removedCard)\n          discardedCards.push(removedCard)\n        }\n      }\n    })\n\n    this.selectedCards = []\n    return discardedCards\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«è¿½åŠ \n   */\n  addToHand(card: Card): void {\n    this.hand.push(card)\n    this.invalidateCache()\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«è¿½åŠ \n   */\n  addToDiscardPile(card: Card): void {\n    this.discardPile.push(card)\n    this.invalidateCache()\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒƒã‚­ã«è¿½åŠ \n   */\n  addToPlayerDeck(card: Card): void {\n    this.playerDeck.addCard(card)\n    this.invalidateCache()\n  }\n\n  /**\n   * æ‰‹æœ­ä¸Šé™ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´\n   */\n  enforceHandLimit(): Card[] {\n    if (!this.config) {\n      return []\n    }\n\n    const discardedCards: Card[] = []\n\n    // æ‰‹æœ­ä¸Šé™ãƒã‚§ãƒƒã‚¯ - å¤ã„ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«\n    while (this.hand.length > this.config.maxHandSize) {\n      const discarded = this.hand.shift()\n      if (discarded) {\n        this.discardPile.push(discarded)\n        discardedCards.push(discarded)\n      }\n    }\n\n    return discardedCards\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’è¨­å®š\n   */\n  setCardChoices(choices: Card[]): void {\n    this.cardChoices = [...choices]\n    this.invalidateCache()\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearCardChoices(): void {\n    this.cardChoices = undefined\n    this.invalidateCache()\n  }\n\n  /**\n   * æŒ‡å®šIDã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠè‚¢ã‹ã‚‰å–å¾—\n   */\n  getCardChoiceById(cardId: string): Card | undefined {\n    return this.cardChoices?.find(card => card.id === cardId)\n  }\n\n  /**\n   * æ¨ã¦æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å±±æœ­ã«æˆ»ã™\n   */\n  private reshuffleDeck(): void {\n    this.playerDeck.addCards(this.discardPile)\n    this.playerDeck.shuffle()\n    this.discardPile = []\n\n    // v2: Reshuffle Penalty (Aging Card)\n    this.addAgingCardToDiscard()\n  }\n\n  // v2 Methods\n\n  /**\n   * ä¿é™ºã‚’è³¼å…¥\n   */\n  buyInsurance(card: Card): void {\n    // Remove from market\n    const index = this.insuranceMarket.findIndex(c => c.id === card.id)\n    if (index !== -1) {\n      this.insuranceMarket.splice(index, 1)\n      this.activeInsurances.push(card)\n      this.invalidateCache()\n    }\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’ã‚²ãƒ¼ãƒ ã‹ã‚‰é™¤å¤– (Deck Compression)\n   */\n  removeCardFromGame(card: Card): void {\n    // Check hand\n    let index = this.hand.findIndex(c => c.id === card.id)\n    if (index !== -1) {\n      this.hand.splice(index, 1)\n      this.invalidateCache()\n      return\n    }\n    // Check discard\n    index = this.discardPile.findIndex(c => c.id === card.id)\n    if (index !== -1) {\n      this.discardPile.splice(index, 1)\n      this.invalidateCache()\n      return\n    }\n    // Check deck (expensive but needed)\n    if (this.playerDeck.removeCard(card.id)) {\n      this.invalidateCache()\n      return\n    }\n  }\n\n  /**\n   * è€åŒ–ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«è¿½åŠ \n   */\n  addAgingCardToDiscard(): void {\n    const agingCard = this.agingDeck.drawCard()\n    if (agingCard) {\n      this.discardPile.push(agingCard)\n      console.log('[CardManager] Aging card added to discard pile due to reshuffle')\n    } else {\n      console.warn('[CardManager] No aging cards left! (Game Over Condition usually)')\n    }\n  }\n\n  getInsuranceMarket(): Card[] {\n    return this.insuranceMarket\n  }\n\n  getActiveInsurances(): Card[] {\n    return this.activeInsurances\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã\n   */\n  drawChallengeCard(): Card | null {\n    const card = this.challengeDeck.drawCard()\n    if (card) {\n      this.invalidateCache()\n    }\n    return card\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‡ãƒƒã‚­ã‚’è£œå……ã™ã‚‹\n   */\n  refillChallengeDeck(cards: Card[]): void {\n    this.challengeDeck.clear()\n    this.challengeDeck.addCards(cards)\n    this.challengeDeck.shuffle()\n    this.invalidateCache()\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‡ãƒƒã‚­ã®ã‚«ãƒ¼ãƒ‰æ•°ã‚’å–å¾—\n   */\n  getChallengeDeckSize(): number {\n    return this.challengeDeck.getCards().length\n  }\n\n  /**\n   * æ‰‹æœ­ã‚’ã™ã¹ã¦æ¨ã¦æœ­ã«ç§»å‹•\n   */\n  discardHand(): Card[] {\n    const discarded = [...this.hand]\n    this.discardPile.push(...discarded)\n    this.hand = []\n    this.invalidateCache()\n    return discarded\n  }\n}","/**\n * ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n * \n * ä¿é™ºæ–™è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒªã‚¹ã‚¯è¦å› ã‚’è¡¨ç¾ã™ã‚‹å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚\n * å„è¦å› ã¯0.0ã€œ1.0ã®ç¯„å›²ã§è¡¨ç¾ã•ã‚Œã€é«˜ã„ã»ã©ãƒªã‚¹ã‚¯ãŒé«˜ã„ã“ã¨ã‚’ç¤ºã™ã€‚\n */\nexport class RiskFactor {\n  private constructor(\n    private readonly value: number,\n    private readonly factorType: RiskFactorType\n  ) { }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’ä½œæˆ\n   * @param value ãƒªã‚¹ã‚¯å€¤ï¼ˆ0.0-1.0ï¼‰\n   * @param factorType ãƒªã‚¹ã‚¯ã®ç¨®é¡\n   * @returns RiskFactorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @throws {Error} å€¤ãŒç¯„å›²å¤–ã®å ´åˆ\n   */\n  static create(value: number, factorType: RiskFactorType): RiskFactor {\n    if (value < 0 || value > 1) {\n      throw new Error(`Risk factor value must be between 0 and 1, got ${value}`)\n    }\n    return new RiskFactor(value, factorType)\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯å€¤ã‚’å–å¾—\n   */\n  getValue(): number {\n    return this.value\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã‚’å–å¾—\n   */\n  getType(): RiskFactorType {\n    return this.factorType\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆä½ãƒ»ä¸­ãƒ»é«˜ï¼‰\n   */\n  getRiskLevel(): RiskLevel {\n    if (this.value <= 0.3) return 'low'\n    if (this.value <= 0.7) return 'medium'\n    return 'high'\n  }\n\n  /**\n   * ä¿é™ºæ–™ã¸ã®å½±éŸ¿å€ç‡ã‚’è¨ˆç®—\n   * @returns ä¿é™ºæ–™å€ç‡ï¼ˆ1.0ãŒåŸºæº–ï¼‰\n   */\n  getPremiumMultiplier(): number {\n    // ãƒªã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã”ã¨ã«ç•°ãªã‚‹å½±éŸ¿åº¦\n    const impactFactors: Record<RiskFactorType, number> = {\n      age: 0.5,         // å¹´é½¢ã¯50%ã®å½±éŸ¿\n      health: 0.3,      // å¥åº·çŠ¶æ…‹ã¯30%ã®å½±éŸ¿\n      claims: 0.4,      // è«‹æ±‚å±¥æ­´ã¯40%ã®å½±éŸ¿\n      lifestyle: 0.2    // ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã¯20%ã®å½±éŸ¿\n    }\n\n    const impact = impactFactors[this.factorType] || 0.3\n    // åŸºæº–1.0ã«å¯¾ã—ã¦ã€ãƒªã‚¹ã‚¯å€¤ã«å¿œã˜ã¦å€ç‡ã‚’èª¿æ•´\n    return 1.0 + (this.value * impact)\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ã‚’èª¿æ•´ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã‚‹å¤‰å‹•ï¼‰\n   * @param adjustment èª¿æ•´å€¤ï¼ˆ-1.0ã€œ1.0ï¼‰\n   * @returns æ–°ã—ã„RiskFactorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   */\n  adjust(adjustment: number): RiskFactor {\n    const newValue = Math.max(0, Math.min(1, this.value + adjustment))\n    return new RiskFactor(newValue, this.factorType)\n  }\n\n  /**\n   * ä»–ã®ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã¨çµåˆ\n   * @param other ä»–ã®ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼\n   * @param weight çµåˆæ™‚ã®é‡ã¿ï¼ˆ0.0-1.0ï¼‰\n   * @returns æ–°ã—ã„RiskFactorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   */\n  combine(other: RiskFactor, weight: number = 0.5): RiskFactor {\n    if (this.factorType !== other.factorType) {\n      throw new Error('Cannot combine different risk factor types')\n    }\n\n    const combinedValue = this.value * (1 - weight) + other.value * weight\n    return new RiskFactor(combinedValue, this.factorType)\n  }\n\n  /**\n   * ç­‰ä¾¡æ€§ã®ç¢ºèª\n   */\n  equals(other: RiskFactor): boolean {\n    return this.value === other.value && this.factorType === other.factorType\n  }\n\n  /**\n   * æ–‡å­—åˆ—è¡¨ç¾\n   */\n  toString(): string {\n    return `RiskFactor(${this.factorType}: ${this.value.toFixed(2)} - ${this.getRiskLevel()})`\n  }\n}\n\n/**\n * ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®ç¨®é¡\n */\nexport type RiskFactorType = 'age' | 'health' | 'claims' | 'lifestyle'\n\n/**\n * ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«\n */\nexport type RiskLevel = 'low' | 'medium' | 'high'\n","import { RiskFactor, type RiskFactorType } from './RiskFactor'\n\n/**\n * ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« - è¤‡æ•°ã®ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®é›†åˆ\n */\nexport class RiskProfile {\n  private constructor(\n    private readonly factors: Map<RiskFactorType, RiskFactor>\n  ) { }\n\n  /**\n   * ç©ºã®ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ\n   */\n  static empty(): RiskProfile {\n    return new RiskProfile(new Map())\n  }\n\n  /**\n   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ\n   */\n  static default(): RiskProfile {\n    const factors = new Map<RiskFactorType, RiskFactor>()\n    factors.set('age', RiskFactor.create(0.3, 'age'))\n    factors.set('health', RiskFactor.create(0.2, 'health'))\n    factors.set('claims', RiskFactor.create(0.0, 'claims'))\n    factors.set('lifestyle', RiskFactor.create(0.3, 'lifestyle'))\n    return new RiskProfile(factors)\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ /æ›´æ–°\n   */\n  withFactor(factor: RiskFactor): RiskProfile {\n    const newFactors = new Map(this.factors)\n    newFactors.set(factor.getType(), factor)\n    return new RiskProfile(newFactors)\n  }\n\n  /**\n   * ç‰¹å®šã®ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—\n   */\n  getFactor(type: RiskFactorType): RiskFactor | undefined {\n    return this.factors.get(type)\n  }\n\n  /**\n   * å…¨ä½“ã®ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆ0.0-1.0ï¼‰\n   */\n  getOverallRiskScore(): number {\n    if (this.factors.size === 0) return 0\n\n    let totalScore = 0\n    this.factors.forEach(factor => {\n      totalScore += factor.getValue()\n    })\n\n    return totalScore / this.factors.size\n  }\n\n  /**\n   * ä¿é™ºæ–™ã¸ã®ç·åˆçš„ãªå½±éŸ¿å€ç‡ã‚’è¨ˆç®—\n   */\n  getTotalPremiumMultiplier(): number {\n    if (this.factors.size === 0) return 1.0\n\n    let multiplier = 1.0\n    this.factors.forEach(factor => {\n      // å„ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®å€ç‡ã‚’ä¹—ç®—çš„ã«é©ç”¨\n      multiplier *= factor.getPremiumMultiplier()\n    })\n\n    return multiplier\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¦ç´„ã‚’å–å¾—\n   */\n  getSummary(): string {\n    const overallScore = this.getOverallRiskScore()\n    const level = overallScore <= 0.3 ? 'ä½ãƒªã‚¹ã‚¯' :\n      overallScore <= 0.7 ? 'ä¸­ãƒªã‚¹ã‚¯' : 'é«˜ãƒªã‚¹ã‚¯'\n\n    return `${level} (ã‚¹ã‚³ã‚¢: ${overallScore.toFixed(2)})`\n  }\n}","import { InsurancePremium } from '../valueObjects/InsurancePremium'\nimport type { Card } from '../entities/Card'\nimport type { GameStage } from '../types/card.types'\nimport type { InsuranceType } from '../types/card.types'\nimport { RiskFactor, type RiskFactorType } from '../valueObjects/RiskFactor'\nimport { RiskProfile } from '../valueObjects/RiskProfile'\n\n/**\n * ä¿é™ºæ–™è¨ˆç®—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹\n * \n * ä¿é™ºæ–™ã«é–¢ã™ã‚‹è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’é›†ç´„ã—ã€\n * å¹´é½¢èª¿æ•´ã€ä¿é™ºç¨®åˆ¥èª¿æ•´ã€ãƒªã‚¹ã‚¯èª¿æ•´ç­‰ã‚’çµ±ä¸€çš„ã«ç®¡ç†ã—ã¾ã™ã€‚\n * \n * ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯çŠ¶æ…‹ã‚’æŒãŸãšã€ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ã‚’æä¾›ã—ã¾ã™ã€‚\n */\nexport class InsurancePremiumCalculationService {\n  /**\n   * å¹´é½¢ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã‚ˆã‚‹ä¿é™ºæ–™å€ç‡\n   */\n  private static readonly AGE_MULTIPLIERS: Record<GameStage, number> = {\n    'youth': 1.0,          // é’å¹´æœŸ: åŸºæº–å€ç‡\n    'middle': 1.2,         // ä¸­å¹´æœŸ: 20%å¢—ã—\n    'fulfillment': 1.3     // å……å®ŸæœŸ: 30%å¢—ã—\n  }\n\n  /**\n   * ä¿é™ºç¨®åˆ¥ã«ã‚ˆã‚‹åŸºæœ¬æ–™ç‡\n   */\n  private static readonly INSURANCE_TYPE_RATES: Record<InsuranceType, number> = {\n    'health': 1.0,         // å¥åº·ä¿é™º(deprecated? -> medical in v2)\n    'medical': 1.0,        // åŒ»ç™‚ä¿é™º: åŸºæº–æ–™ç‡\n    'life': 1.2,           // ç”Ÿå‘½ä¿é™º: 20%é«˜\n    'income': 1.0,         // åå…¥ä¿éšœ: åŸºæº–æ–™ç‡\n    'asset': 0.5,          // è³‡ç”£å½¢æˆä¿é™º: 50%å®‰ (é•·æœŸæŠ•è³‡å‰æ)\n    'disability': 0.8,     // éšœå®³ä¿é™º: 20%å®‰\n    'accident': 0.6,       // äº‹æ•…ä¿é™º: 40%å®‰\n    'cancer': 1.5,         // ãŒã‚“ä¿é™º: 50%é«˜\n    'dental': 0.4,         // æ­¯ç§‘ä¿é™º: 60%å®‰\n    'travel': 0.3          // æ—…è¡Œä¿é™º: 70%å®‰\n  }\n\n  /**\n   * å¹´é½¢èª¿æ•´æ¸ˆã¿ä¿é™ºæ–™ã‚’è¨ˆç®—\n   * \n   * @param basePremium åŸºæœ¬ä¿é™ºæ–™\n   * @param stage ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @returns å¹´é½¢èª¿æ•´æ¸ˆã¿ä¿é™ºæ–™\n   */\n  calculateAgeAdjustedPremium(basePremium: InsurancePremium, stage: GameStage): InsurancePremium {\n    const multiplier = InsurancePremiumCalculationService.AGE_MULTIPLIERS[stage] || 1.0\n    return basePremium.applyMultiplier(multiplier)\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ç·åˆä¿é™ºæ–™ã‚’è¨ˆç®—\n   * \n   * åŸºæœ¬æ–™é‡‘ + å¹´é½¢èª¿æ•´ + ä¿é™ºç¨®åˆ¥èª¿æ•´ + ã‚«ãƒãƒ¬ãƒƒã‚¸èª¿æ•´ + ãƒªã‚¹ã‚¯èª¿æ•´ã‚’ç·åˆçš„ã«è¨ˆç®—\n   * \n   * @param card ä¿é™ºã‚«ãƒ¼ãƒ‰\n   * @param stage ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @param riskProfile ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n   * @returns ç·åˆä¿é™ºæ–™\n   */\n  calculateComprehensivePremium(\n    card: Card,\n    stage: GameStage,\n    riskProfile?: RiskProfile\n  ): InsurancePremium {\n    if (card.type !== 'insurance') {\n      throw new Error('Card must be an insurance card')\n    }\n\n    // åŸºæœ¬ä¿é™ºæ–™å–å¾—\n    const basePremium = card.getCost()\n\n    // å¹´é½¢èª¿æ•´\n    const ageAdjustedPremium = this.calculateAgeAdjustedPremium(basePremium, stage)\n\n    // ä¿é™ºç¨®åˆ¥èª¿æ•´\n    const typeAdjustedPremium = this.applyInsuranceTypeAdjustment(ageAdjustedPremium, card.insuranceType)\n\n    // ã‚«ãƒãƒ¬ãƒƒã‚¸èª¿æ•´\n    const coverageAdjustedPremium = this.applyCoverageAdjustment(typeAdjustedPremium, card.coverage)\n\n    // ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«èª¿æ•´\n    if (riskProfile) {\n      const riskMultiplier = this.calculateRiskAdjustment(riskProfile, card.insuranceType)\n      return coverageAdjustedPremium.applyMultiplier(riskMultiplier)\n    }\n\n    return coverageAdjustedPremium\n  }\n\n  /**\n   * ä¿é™ºæ–™è² æ‹…ã®ç·è¨ˆç®—\n   * \n   * è¤‡æ•°ã®ä¿é™ºã‚’æŒã¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç·ä¿é™ºæ–™è² æ‹…ã‚’è¨ˆç®—\n   * 3æšã”ã¨ã®è² æ‹…å¢—åŠ ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨\n   * \n   * @param insuranceCards ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¿é™ºã‚«ãƒ¼ãƒ‰é…åˆ—\n   * @param stage ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @param riskProfile ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n   * @returns ç·ä¿é™ºæ–™è² æ‹…\n   */\n  calculateTotalInsuranceBurden(\n    insuranceCards: Card[],\n    stage: GameStage,\n    riskProfile?: RiskProfile\n  ): InsurancePremium {\n    // å„ä¿é™ºã®å€‹åˆ¥æ–™é‡‘è¨ˆç®—\n    const individualPremiums = insuranceCards\n      .filter(card => card && card.type === 'insurance')\n      .map(card =>\n        this.calculateComprehensivePremium(card, stage, riskProfile)\n      )\n\n    // åŸºæœ¬åˆè¨ˆ\n    const baseTotalPremium = InsurancePremium.sum(individualPremiums)\n\n    // 3æšã”ã¨ã®è² æ‹…å¢—åŠ ãƒ«ãƒ¼ãƒ«\n    const penaltyMultiplier = this.calculateMultiInsurancePenalty(insuranceCards.length)\n\n    return baseTotalPremium.applyMultiplier(penaltyMultiplier)\n  }\n\n  /**\n   * ä¿é™ºæ›´æ–°æ™‚ã®æ–™é‡‘è¨ˆç®—\n   * \n   * æ—¢å­˜ä¿é™ºã®æ›´æ–°æ™‚ã«ãŠã‘ã‚‹æ–™é‡‘èª¿æ•´\n   * ç¶™ç¶šå‰²å¼•ã€çµŒé¨“èª¿æ•´ã€å¹´é½¢å¤‰åŒ–ã‚’è€ƒæ…®\n   * \n   * @param card æ›´æ–°å¯¾è±¡ã®ä¿é™ºã‚«ãƒ¼ãƒ‰\n   * @param currentStage ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @param usageHistory ä½¿ç”¨å±¥æ­´ï¼ˆä½¿ç”¨å›æ•°ï¼‰\n   * @returns æ›´æ–°æ™‚ä¿é™ºæ–™\n   */\n  calculateRenewalPremium(card: Card, currentStage: GameStage, usageHistory: number): InsurancePremium {\n    // åŸºæœ¬æ›´æ–°æ–™é‡‘\n    const basePremium = this.calculateComprehensivePremium(card, currentStage)\n\n    // ç¶™ç¶šå‰²å¼•é©ç”¨ï¼ˆé•·æœŸç¶™ç¶šè€…å„ªé‡ï¼‰\n    const continuityDiscount = this.calculateContinuityDiscount(usageHistory)\n    const discountedPremium = basePremium.applyDiscount(continuityDiscount)\n\n    // ä½¿ç”¨å®Ÿç¸¾ã«ã‚ˆã‚‹èª¿æ•´ï¼ˆãƒªã‚¹ã‚¯è©•ä¾¡ï¼‰\n    const riskMultiplier = this.calculateRiskMultiplier(usageHistory)\n\n    return discountedPremium.applyMultiplier(riskMultiplier)\n  }\n\n  /**\n   * æœ€é©ä¿é™ºãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ææ¡ˆ\n   * \n   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ³ã«å¿œã˜ãŸæœ€é©ãªä¿é™ºçµ„ã¿åˆã‚ã›ã‚’è¨ˆç®—\n   * \n   * @param availableBudget åˆ©ç”¨å¯èƒ½äºˆç®—ï¼ˆæ´»åŠ›ï¼‰\n   * @param _stage ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ (æœªä½¿ç”¨)\n   * @param riskProfile ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«\n   * @returns æ¨å¥¨ä¿é™ºæ–™ä¸Šé™\n   */\n  calculateOptimalInsuranceBudget(\n    availableBudget: number,\n    _stage: GameStage,\n    riskProfile: 'conservative' | 'balanced' | 'aggressive' = 'balanced'\n  ): InsurancePremium {\n    const budgetRatios = {\n      'conservative': 0.15,  // äºˆç®—ã®15%\n      'balanced': 0.25,      // äºˆç®—ã®25%\n      'aggressive': 0.35     // äºˆç®—ã®35%\n    }\n\n    const ratio = budgetRatios[riskProfile]\n    const recommendedBudget = Math.floor(availableBudget * ratio)\n\n    return InsurancePremium.create(recommendedBudget)\n  }\n\n  /**\n   * ä¿é™ºç¨®åˆ¥èª¿æ•´ã‚’é©ç”¨\n   * @private\n   */\n  private applyInsuranceTypeAdjustment(\n    premium: InsurancePremium,\n    insuranceType?: InsuranceType\n  ): InsurancePremium {\n    if (!insuranceType) {\n      return premium\n    }\n\n    const typeRate = InsurancePremiumCalculationService.INSURANCE_TYPE_RATES[insuranceType] || 1.0\n    return premium.applyMultiplier(typeRate)\n  }\n\n  /**\n   * ã‚«ãƒãƒ¬ãƒƒã‚¸èª¿æ•´ã‚’é©ç”¨\n   * @private\n   */\n  private applyCoverageAdjustment(premium: InsurancePremium, coverage?: number): InsurancePremium {\n    if (!coverage || coverage <= 0) {\n      // ã‚«ãƒãƒ¬ãƒƒã‚¸0ã®å ´åˆã¯åŸºæœ¬æ–™é‡‘ã®50%å‰²å¼•\n      return premium.applyMultiplier(0.5)\n    }\n\n    // ã‚«ãƒãƒ¬ãƒƒã‚¸èª¿æ•´\n    // ã‚«ãƒãƒ¬ãƒƒã‚¸200ã‚’åŸºæº–ï¼ˆ1.0å€ï¼‰ã¨ã—ã¦ã€ç·©ã‚„ã‹ã«å¤‰å‹•ã•ã›ã‚‹\n    // ä»¥å‰ã®è¨ˆç®—å¼ (coverage / 50) ã¯éåº¦ãªè² æ‹…ã‚’ç”Ÿã‚“ã§ã„ãŸãŸã‚ä¿®æ­£\n    const coverageMultiplier = 0.5 + (coverage / 400)\n\n    return premium.applyMultiplier(coverageMultiplier)\n  }\n\n  /**\n   * è¤‡æ•°ä¿é™ºãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateMultiInsurancePenalty(insuranceCount: number): number {\n    // æ”¹å–„ç‰ˆ: 5æšã”ã¨ã«10%ãšã¤è² æ‹…å¢—åŠ ã€ä¸Šé™30%\n    const penaltySteps = Math.floor(insuranceCount / 5)\n    const penaltyRate = Math.min(penaltySteps * 0.1, 0.3)  // æœ€å¤§30%å¢—\n    return 1.0 + penaltyRate\n  }\n\n  /**\n   * ç¶™ç¶šå‰²å¼•ç‡ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateContinuityDiscount(usageHistory: number): number {\n    // ä½¿ç”¨å±¥æ­´ãŒå°‘ãªã„ã»ã©ç¶™ç¶šå‰²å¼•ç‡ãŒé«˜ã„ï¼ˆå„ªè‰¯é¡§å®¢ï¼‰\n    if (usageHistory === 0) return 0.1      // 10%å‰²å¼•\n    if (usageHistory <= 2) return 0.05      // 5%å‰²å¼•\n    return 0                                 // å‰²å¼•ãªã—\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯å€ç‡ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateRiskMultiplier(usageHistory: number): number {\n    // ä½¿ç”¨å±¥æ­´ãŒå¤šã„ã»ã©ãƒªã‚¹ã‚¯ãŒé«˜ã„ã¨ã¿ãªã—ã¦æ–™é‡‘å¢—åŠ \n    if (usageHistory >= 5) return 1.3       // 30%å¢—ã—\n    if (usageHistory >= 3) return 1.1       // 10%å¢—ã—\n    return 1.0                               // åŸºæº–æ–™é‡‘\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ãä¿é™ºæ–™èª¿æ•´ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateRiskAdjustment(riskProfile: RiskProfile, insuranceType?: InsuranceType): number {\n    // åŸºæœ¬çš„ãªãƒªã‚¹ã‚¯å€ç‡\n    let baseMultiplier = riskProfile.getTotalPremiumMultiplier()\n\n    // ä¿é™ºç¨®é¡ã”ã¨ã«ç‰¹å®šã®ãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®å½±éŸ¿ã‚’å¼·åŒ–\n    if (insuranceType) {\n      const typeSpecificAdjustments: Partial<Record<InsuranceType, RiskFactorType>> = {\n        'health': 'health',      // å¥åº·ä¿é™ºã¯å¥åº·ãƒªã‚¹ã‚¯ã®å½±éŸ¿å¤§\n        'life': 'age',          // ç”Ÿå‘½ä¿é™ºã¯å¹´é½¢ãƒªã‚¹ã‚¯ã®å½±éŸ¿å¤§\n        'disability': 'health',  // éšœå®³ä¿é™ºã¯å¥åº·ãƒªã‚¹ã‚¯ã®å½±éŸ¿å¤§\n        'accident': 'lifestyle', // äº‹æ•…ä¿é™ºã¯ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã®å½±éŸ¿å¤§\n        'cancer': 'health',      // ãŒã‚“ä¿é™ºã¯å¥åº·ãƒªã‚¹ã‚¯ã®å½±éŸ¿å¤§\n      }\n\n      const relevantFactorType = typeSpecificAdjustments[insuranceType]\n      if (relevantFactorType) {\n        const specificFactor = riskProfile.getFactor(relevantFactorType)\n        if (specificFactor) {\n          // ç‰¹å®šãƒªã‚¹ã‚¯ã®å½±éŸ¿ã‚’20%å¼·åŒ–\n          const specificMultiplier = specificFactor.getPremiumMultiplier()\n          baseMultiplier = baseMultiplier * 0.8 + specificMultiplier * 0.2\n        }\n      }\n    }\n\n    return baseMultiplier\n  }\n\n  /**\n   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•å±¥æ­´ã‹ã‚‰ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ\n   * \n   * @param playerHistory ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•å±¥æ­´\n   * @param currentStage ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @returns è¨ˆç®—ã•ã‚ŒãŸãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«\n   */\n  generateRiskProfile(playerHistory: PlayerHistory, currentStage: GameStage): RiskProfile {\n    let profile = RiskProfile.default()\n\n    // å¹´é½¢ãƒªã‚¹ã‚¯ã®è¨ˆç®—\n    const ageRiskValue = this.calculateAgeRisk(currentStage)\n    profile = profile.withFactor(RiskFactor.create(ageRiskValue, 'age'))\n\n    // å¥åº·ãƒªã‚¹ã‚¯ã®è¨ˆç®—ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸å±¥æ­´ã‹ã‚‰ï¼‰\n    const healthRiskValue = this.calculateHealthRisk(playerHistory)\n    profile = profile.withFactor(RiskFactor.create(healthRiskValue, 'health'))\n\n    // è«‹æ±‚å±¥æ­´ãƒªã‚¹ã‚¯ã®è¨ˆç®—\n    const claimsRiskValue = this.calculateClaimsRisk(playerHistory)\n    profile = profile.withFactor(RiskFactor.create(claimsRiskValue, 'claims'))\n\n    // ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚¹ã‚¯ã®è¨ˆç®—ï¼ˆãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«ã‹ã‚‰ï¼‰\n    const lifestyleRiskValue = this.calculateLifestyleRisk(playerHistory)\n    profile = profile.withFactor(RiskFactor.create(lifestyleRiskValue, 'lifestyle'))\n\n    return profile\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è€ƒæ…®ã—ãŸä¿é™ºæ–™ã‚’è¨ˆç®—\n   * \n   * @param card ä¿é™ºã‚«ãƒ¼ãƒ‰\n   * @param stage ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @param riskProfile ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n   * @returns ãƒªã‚¹ã‚¯èª¿æ•´æ¸ˆã¿ä¿é™ºæ–™\n   */\n  calculateRiskAdjustedPremium(\n    card: Card,\n    stage: GameStage,\n    riskProfile?: RiskProfile\n  ): InsurancePremium {\n    // åŸºæœ¬çš„ãªç·åˆä¿é™ºæ–™ã‚’è¨ˆç®—\n    const basePremium = this.calculateComprehensivePremium(card, stage)\n\n    // ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯åŸºæœ¬ä¿é™ºæ–™ã‚’ãã®ã¾ã¾è¿”ã™\n    if (!riskProfile) {\n      return basePremium\n    }\n\n    // ãƒªã‚¹ã‚¯èª¿æ•´å€ç‡ã‚’è¨ˆç®—\n    const riskMultiplier = this.calculateRiskAdjustment(riskProfile, card.insuranceType)\n\n    // ãƒªã‚¹ã‚¯èª¿æ•´ã‚’é©ç”¨\n    return basePremium.applyMultiplier(riskMultiplier)\n  }\n\n  /**\n   * å¹´é½¢ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯å€¤ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateAgeRisk(stage: GameStage): number {\n    const ageRiskMap: Record<GameStage, number> = {\n      'youth': 0.2,\n      'middle': 0.5,\n      'fulfillment': 0.6\n    }\n    return ageRiskMap[stage] || 0.5\n  }\n\n  /**\n   * å¥åº·å±¥æ­´ã‹ã‚‰ãƒªã‚¹ã‚¯å€¤ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateHealthRisk(history: PlayerHistory): number {\n    const totalDamageTaken = history.totalDamageTaken || 0\n    const turnsPlayed = history.turnsPlayed || 1\n    const averageDamagePerTurn = totalDamageTaken / turnsPlayed\n\n    // å¹³å‡ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¤šã„ã»ã©ãƒªã‚¹ã‚¯ãŒé«˜ã„\n    if (averageDamagePerTurn >= 3) return 0.8\n    if (averageDamagePerTurn >= 2) return 0.6\n    if (averageDamagePerTurn >= 1) return 0.4\n    return 0.2\n  }\n\n  /**\n   * ä¿é™ºè«‹æ±‚å±¥æ­´ã‹ã‚‰ãƒªã‚¹ã‚¯å€¤ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateClaimsRisk(history: PlayerHistory): number {\n    const claimCount = history.insuranceClaimCount || 0\n    const totalInsurances = history.totalInsurancePurchased || 1\n    const claimRate = claimCount / totalInsurances\n\n    // è«‹æ±‚ç‡ãŒé«˜ã„ã»ã©ãƒªã‚¹ã‚¯ãŒé«˜ã„\n    if (claimRate >= 0.5) return 0.9\n    if (claimRate >= 0.3) return 0.6\n    if (claimRate >= 0.1) return 0.3\n    return 0.1\n  }\n\n  /**\n   * ãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«ã‹ã‚‰ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚¹ã‚¯ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateLifestyleRisk(history: PlayerHistory): number {\n    const riskyChoices = history.riskyChoiceCount || 0\n    const totalChoices = history.totalChoiceCount || 1\n    const riskRate = riskyChoices / totalChoices\n\n    // ãƒªã‚¹ã‚­ãƒ¼ãªé¸æŠãŒå¤šã„ã»ã©ãƒªã‚¹ã‚¯ãŒé«˜ã„\n    if (riskRate >= 0.6) return 0.8\n    if (riskRate >= 0.4) return 0.5\n    if (riskRate >= 0.2) return 0.3\n    return 0.1\n  }\n}\n\n/**\n * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\n */\nexport interface PlayerHistory {\n  turnsPlayed: number\n  totalDamageTaken: number\n  insuranceClaimCount: number\n  totalInsurancePurchased: number\n  riskyChoiceCount: number\n  totalChoiceCount: number\n}","import type { GameStage } from '../types/card.types'\nimport type { DreamCategory } from '../types/card.types'\n\n/**\n * ã‚²ãƒ¼ãƒ å®šæ•°ç®¡ç†\n * \n * ã‚²ãƒ¼ãƒ å…¨ä½“ã§ä½¿ç”¨ã•ã‚Œã‚‹å®šæ•°ã‚’ä¸€å…ƒç®¡ç†ã—ã€\n * ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã‚’æ’é™¤ã—ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚\n */\n\n/**\n * å¹´é½¢ã‚¹ãƒ†ãƒ¼ã‚¸é–¢é€£ã®å®šæ•°\n */\nexport const AGE_CONSTANTS = {\n  /**\n   * å„ã‚¹ãƒ†ãƒ¼ã‚¸ã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\n   */\n  STAGE_PARAMETERS: {\n    youth: {\n      label: 'é’å¹´æœŸ',\n      maxVitality: 60, // Reduced from 80\n      startTurn: 0,\n      endTurn: 6,\n      insuranceMultiplier: 1.0,\n      challengeDifficultyModifier: 1.0 // Reduced from 1.5 to help Advanced\n    },\n    middle: {\n      label: 'ä¸­å¹´æœŸ',\n      maxVitality: 60, // Reduced from 80\n      startTurn: 7,\n      endTurn: 13,\n      insuranceMultiplier: 1.2,\n      challengeDifficultyModifier: 1.5 // Reduced from 2.0\n    },\n    fulfillment: {\n      label: 'å……å®ŸæœŸ',\n      maxVitality: 50, // Reduced from 60\n      startTurn: 14,\n      endTurn: Infinity,\n      insuranceMultiplier: 1.5, // Increased from 1.3\n      challengeDifficultyModifier: 2.0 // Reduced from 2.5\n    }\n  } as const,\n\n  /**\n   * å¹´é½¢ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—å¼\n   */\n  AGE_BONUS: {\n    youth: 0,\n    middle: 0.5,\n    fulfillment: 1.0\n  } as const,\n\n  /**\n   * æ´»åŠ›ä¸Šé™èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\n   */\n  VITALITY_LIMITS: {\n    youth: 100,\n    middle: 80,\n    fulfillment: 60\n  } as const\n} as const\n\n/**\n * å¤¢ã‚«ãƒ¼ãƒ‰é–¢é€£ã®å®šæ•°\n */\nexport const DREAM_CONSTANTS = {\n  /**\n   * å¤¢ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®å¹´é½¢èª¿æ•´å€¤\n   */\n  AGE_ADJUSTMENTS: {\n    physical: -2,    // èº«ä½“ç³»ã¯å¹´é½¢ã¨ã¨ã‚‚ã«é›£ã—ããªã‚‹\n    intellectual: 1, // çŸ¥çš„ç³»ã¯çµŒé¨“ã§æ˜“ã—ããªã‚‹\n    mixed: -1       // æ··åˆç³»ã¯å°‘ã—é›£ã—ããªã‚‹\n  } as const satisfies Record<DreamCategory, number>,\n\n  /**\n   * å¤¢ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬è¨­å®š\n   */\n  BASE_SETTINGS: {\n    minPower: 1,        // æœ€å°ãƒ‘ãƒ¯ãƒ¼\n    maxPower: 15,       // æœ€å¤§ãƒ‘ãƒ¯ãƒ¼\n    defaultPower: 5     // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ¯ãƒ¼\n  } as const\n} as const\n\n/**\n * ä¿é™ºé–¢é€£ã®å®šæ•°\n */\nexport const INSURANCE_CONSTANTS = {\n  /**\n   * ä¿é™ºæ–™è¨ˆç®—ã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\n   */\n  PREMIUM_CALCULATION: {\n    baseCostMultiplier: 0.4,      // åŸºæœ¬ã‚³ã‚¹ãƒˆå€ç‡ (Increased to 0.4 to pinch finances)\n    ageMultiplierStart: 1.0,      // å¹´é½¢å€ç‡é–‹å§‹å€¤\n    ageMultiplierIncrement: 0.15,  // å¹´é½¢å€ç‡å¢—åˆ†\n    coverageRateBase: 50,         // ã‚«ãƒãƒ¬ãƒƒã‚¸åŸºæº–å€¤\n    multiInsurancePenalty: 0.1    // è¤‡æ•°ä¿é™ºãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆ3æšã”ã¨ï¼‰\n  } as const,\n\n  /**\n   * ä¿é™ºç¨®é¡åˆ¥ã®æ–™ç‡\n   */\n  TYPE_RATES: {\n    medical: 1.0,     // åŒ»ç™‚ä¿é™º: åŸºæº–æ–™ç‡\n    life: 1.2,        // ç”Ÿå‘½ä¿é™º: 20%é«˜\n    income: 1.0,      // åå…¥ä¿éšœ: åŸºæº–æ–™ç‡\n    asset: 0.5,       // è³‡ç”£å½¢æˆä¿é™º: 50%å®‰\n    disability: 0.8,  // éšœå®³ä¿é™º: 20%å®‰\n    accident: 0.6,    // äº‹æ•…ä¿é™º: 40%å®‰\n    cancer: 1.5,      // ãŒã‚“ä¿é™º: 50%é«˜\n    dental: 0.4,      // æ­¯ç§‘ä¿é™º: 60%å®‰\n    travel: 0.3       // æ—…è¡Œä¿é™º: 70%å®‰\n  } as const,\n\n  /**\n   * ä¿é™ºæœŸé–“è¨­å®š\n   */\n  DURATION_SETTINGS: {\n    termInsurance: {\n      defaultDuration: 5,  // å®šæœŸä¿é™ºã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“\n      costDiscount: 0.1     // å®šæœŸä¿é™ºã®ã‚³ã‚¹ãƒˆå‰²å¼•ç‡ (Discounted to 0.1 - huge advantage for Term)\n    },\n    wholeLifeInsurance: {\n      costMultiplier: 1.0   // çµ‚èº«ä¿é™ºã®ã‚³ã‚¹ãƒˆå€ç‡\n    }\n  } as const,\n\n  /**\n   * ä¿é™ºä½¿ç”¨å®Ÿç¸¾ã«ã‚ˆã‚‹èª¿æ•´\n   */\n  USAGE_ADJUSTMENTS: {\n    continuityDiscount: {\n      noUsage: 0.1,      // æœªä½¿ç”¨: 10%å‰²å¼•\n      lowUsage: 0.05,    // ä½ä½¿ç”¨(1-2å›): 5%å‰²å¼•\n      normalUsage: 0     // é€šå¸¸ä½¿ç”¨: å‰²å¼•ãªã—\n    },\n    riskMultiplier: {\n      highUsage: 1.3,    // é«˜ä½¿ç”¨(5å›ä»¥ä¸Š): 30%å¢—ã—\n      moderateUsage: 1.1, // ä¸­ç¨‹åº¦ä½¿ç”¨(3-4å›): 10%å¢—ã—\n      lowUsage: 1.0      // ä½ä½¿ç”¨: åŸºæº–æ–™é‡‘\n    }\n  } as const\n} as const\n\n/**\n * ã‚²ãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹é–¢é€£ã®å®šæ•°\n */\nexport const BALANCE_CONSTANTS = {\n  /**\n   * ã‚«ãƒ¼ãƒ‰é–¢é€£\n   */\n  CARD_LIMITS: {\n    maxHandSize: 10,           // æœ€å¤§æ‰‹æœ­æ•°\n    startingHandSize: 5,       // åˆæœŸæ‰‹æœ­æ•°\n    defaultDrawCount: 1,       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‰ãƒ­ãƒ¼æ•°\n    maxDeckSize: 100          // æœ€å¤§ãƒ‡ãƒƒã‚­ã‚µã‚¤ã‚º\n  } as const,\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–¢é€£\n   */\n  CHALLENGE_SETTINGS: {\n    minDifficulty: 1,          // æœ€å°é›£æ˜“åº¦\n    maxDifficulty: 20,         // æœ€å¤§é›£æ˜“åº¦\n    successBonusBase: 8,       // æˆåŠŸæ™‚ãƒœãƒ¼ãƒŠã‚¹åŸºæº–å€¤ (Increased to reward skilled play)\n    failurePenaltyRatio: 1.5,  // å¤±æ•—æ™‚ãƒšãƒŠãƒ«ãƒ†ã‚£æ¯”ç‡ (Increased to punish reckless play)\n    enableDynamicDifficulty: true // å‹•çš„é›£æ˜“åº¦èª¿æ•´ã®æœ‰åŠ¹åŒ–\n  } as const,\n\n  /**\n   * æ´»åŠ›é–¢é€£\n   */\n  VITALITY_SETTINGS: {\n    defaultStarting: 40,       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆæœŸæ´»åŠ› (Decreased to 40 for harder start)\n    minimumValue: 0,           // æœ€å°æ´»åŠ›å€¤\n    maximumValue: 150,         // æœ€å¤§æ´»åŠ›å€¤\n    healingCap: 0.85           // å›å¾©ä¸Šé™ï¼ˆæœ€å¤§æ´»åŠ›ã®85%ï¼‰\n  } as const,\n\n  /**\n   * ã‚²ãƒ¼ãƒ é€²è¡Œé–¢é€£\n   */\n  PROGRESSION_SETTINGS: {\n    maxTurns: 20,              // æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•° (50 -> 20)\n    stageTransitionTurns: {    // ã‚¹ãƒ†ãƒ¼ã‚¸è»¢æ›ã‚¿ãƒ¼ãƒ³\n      youthToMiddle: 7,        // é’å¹´æœŸ: 0-6 (7ã‚¿ãƒ¼ãƒ³)\n      middleToFulfillment: 14  // ä¸­å¹´æœŸ: 7-13 (7ã‚¿ãƒ¼ãƒ³), å……å®ŸæœŸ: 14-20\n    },\n    victoryConditions: {\n      minTurns: 15,            // å‹åˆ©æ¡ä»¶æœ€å°ã‚¿ãƒ¼ãƒ³\n      minVitality: 50          // å‹åˆ©æ¡ä»¶æœ€å°æ´»åŠ›\n    }\n  } as const\n} as const\n\n/**\n * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é–¢é€£ã®å®šæ•°\n */\nexport const PERFORMANCE_CONSTANTS = {\n  /**\n   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š\n   */\n  CACHE_SETTINGS: {\n    stateSnapshotTTL: 50,      // çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆTTL (ms)\n    calculationCacheTTL: 100,  // è¨ˆç®—ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTL (ms)\n    maxCacheEntries: 100       // æœ€å¤§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªæ•°\n  } as const,\n\n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«è¨­å®š\n   */\n  OBJECT_POOL_LIMITS: {\n    maxPoolSize: 10,           // æœ€å¤§ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º\n    initialPoolSize: 3         // åˆæœŸãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º\n  } as const,\n\n  /**\n   * å‡¦ç†åˆ¶é™\n   */\n  PROCESSING_LIMITS: {\n    maxCardsPerSelection: 20,  // é¸æŠå¯èƒ½æœ€å¤§ã‚«ãƒ¼ãƒ‰æ•°\n    maxInsuranceCards: 30,     // æœ€å¤§ä¿é™ºã‚«ãƒ¼ãƒ‰æ•°\n    maxHistoryEntries: 1000    // æœ€å¤§å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªæ•°\n  } as const\n} as const\n\n/**\n * UIé–¢é€£ã®å®šæ•°\n */\nexport const UI_CONSTANTS = {\n  /**\n   * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š\n   */\n  ANIMATION_DURATIONS: {\n    cardFlip: 300,           // ã‚«ãƒ¼ãƒ‰ãƒ•ãƒªãƒƒãƒ— (ms)\n    cardDraw: 500,           // ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼ (ms)\n    phaseTransition: 800,    // ãƒ•ã‚§ãƒ¼ã‚ºè»¢æ› (ms)\n    messageDisplay: 2000     // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º (ms)\n  } as const,\n\n  /**\n   * è¡¨ç¤ºè¨­å®š\n   */\n  DISPLAY_SETTINGS: {\n    maxVisibleCards: 12,     // æœ€å¤§è¡¨ç¤ºã‚«ãƒ¼ãƒ‰æ•°\n    cardSpacing: 10,         // ã‚«ãƒ¼ãƒ‰é–“éš” (px)\n    messageMaxLength: 200    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ€å¤§é•·\n  } as const\n} as const\n\n/**\n * ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆé–¢é€£ã®å®šæ•°\n */\nexport const DEBUG_CONSTANTS = {\n  /**\n   * ãƒ­ã‚°è¨­å®š\n   */\n  LOGGING: {\n    maxLogEntries: 500,      // æœ€å¤§ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªæ•°\n    logRetentionDays: 7      // ãƒ­ã‚°ä¿æŒæ—¥æ•°\n  } as const,\n\n  /**\n   * ãƒ†ã‚¹ãƒˆè¨­å®š\n   */\n  TESTING: {\n    fastMode: false,         // é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰\n    skipAnimations: false,   // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—\n    debugVitality: false     // æ´»åŠ›ãƒ‡ãƒãƒƒã‚°\n  } as const\n} as const\n\n/**\n * å®šæ•°ã®å‹å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚µ\n */\nimport type { BalanceConfig } from '../types/game.types'\n\n/**\n * å®šæ•°ã®å‹å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚µ\n */\nexport class GameConstantsAccessor {\n  private static overrides: BalanceConfig | undefined\n\n  /**\n   * ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è¨­å®šã‚’é©ç”¨\n   */\n  static setOverrides(config?: BalanceConfig) {\n    this.overrides = config\n  }\n\n  /**\n   * ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ã‚¯ãƒªã‚¢\n   */\n  static clearOverrides() {\n    this.overrides = undefined\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å–å¾—\n   */\n  static getStageParameters(stage: GameStage) {\n    const base = AGE_CONSTANTS.STAGE_PARAMETERS[stage] || AGE_CONSTANTS.STAGE_PARAMETERS.youth\n    if (this.overrides?.stageParameters?.[stage]) {\n      return { ...base, ...this.overrides.stageParameters[stage] }\n    }\n    return base\n  }\n\n  /**\n   * å¤¢ã‚«ãƒ¼ãƒ‰å¹´é½¢èª¿æ•´å€¤ã‚’å®‰å…¨ã«å–å¾—\n   */\n  static getDreamAgeAdjustment(category: DreamCategory): number {\n    return DREAM_CONSTANTS.AGE_ADJUSTMENTS[category] ?? 0\n  }\n\n  /**\n   * ä¿é™ºç¨®é¡åˆ¥æ–™ç‡ã‚’å®‰å…¨ã«å–å¾—\n   */\n  static getInsuranceTypeRate(type: keyof typeof INSURANCE_CONSTANTS.TYPE_RATES): number {\n    return INSURANCE_CONSTANTS.TYPE_RATES[type] ?? 1.0\n  }\n\n  /**\n   * ãƒãƒ©ãƒ³ã‚¹è¨­å®šã‚’å–å¾—\n   */\n  static getBalanceSettings() {\n    const base = BALANCE_CONSTANTS\n    if (this.overrides) {\n      return {\n        ...base,\n        CARD_LIMITS: { ...base.CARD_LIMITS, ...this.overrides.cardLimits },\n        CHALLENGE_SETTINGS: { ...base.CHALLENGE_SETTINGS, ...this.overrides.challengeSettings },\n        VITALITY_SETTINGS: { ...base.VITALITY_SETTINGS, ...this.overrides.vitalitySettings },\n        PROGRESSION_SETTINGS: { ...base.PROGRESSION_SETTINGS, ...this.overrides.progressionSettings }\n      }\n    }\n    return base\n  }\n\n  /**\n   * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®šã‚’å–å¾—\n   */\n  static getPerformanceSettings() {\n    return PERFORMANCE_CONSTANTS\n  }\n}\n\n/**\n * å®šæ•°ã®æ¤œè¨¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£\n */\nexport class ConstantsValidator {\n  /**\n   * æ´»åŠ›å€¤ãŒæœ‰åŠ¹ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  static isValidVitality(value: number): boolean {\n    return value >= BALANCE_CONSTANTS.VITALITY_SETTINGS.minimumValue &&\n      value <= BALANCE_CONSTANTS.VITALITY_SETTINGS.maximumValue\n  }\n\n  /**\n   * ã‚¿ãƒ¼ãƒ³æ•°ãŒæœ‰åŠ¹ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  static isValidTurn(turn: number): boolean {\n    return turn >= 0 && turn <= BALANCE_CONSTANTS.PROGRESSION_SETTINGS.maxTurns\n  }\n\n  /**\n   * æ‰‹æœ­ã‚µã‚¤ã‚ºãŒæœ‰åŠ¹ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  static isValidHandSize(size: number): boolean {\n    return size >= 0 && size <= BALANCE_CONSTANTS.CARD_LIMITS.maxHandSize\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸é›£æ˜“åº¦ãŒæœ‰åŠ¹ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  static isValidDifficulty(difficulty: number): boolean {\n    return difficulty >= BALANCE_CONSTANTS.CHALLENGE_SETTINGS.minDifficulty &&\n      difficulty <= BALANCE_CONSTANTS.CHALLENGE_SETTINGS.maxDifficulty\n  }\n}","import type { GameStage } from '../types/card.types'\nimport { GameConstantsAccessor } from '../constants/GameConstants'\n\n/**\n * ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹\n * \n * ã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†ã™ã‚‹å˜ä¸€è²¬ä»»ã‚¯ãƒ©ã‚¹\n */\nexport class GameStageManager {\n  /**\n   * ã‚¿ãƒ¼ãƒ³æ•°ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ã«å¿œã˜ã¦æ›´æ–°\n   * @param currentStage ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @param turn ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³æ•°\n   * @returns æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆå¤‰æ›´ãŒãªã„å ´åˆã¯å…ƒã®ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰\n   */\n  checkStageProgression(currentStage: GameStage, turn: number): {\n    newStage: GameStage\n    hasChanged: boolean\n    transitionMessage?: string\n    upcomingTransition?: string\n  } {\n    const oldStage = currentStage\n    let newStage = currentStage\n\n    const settings = GameConstantsAccessor.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns\n\n    if (turn >= settings.youthToMiddle && currentStage === 'youth') {\n      newStage = 'middle'\n    } else if (turn >= settings.middleToFulfillment && currentStage === 'middle') {\n      newStage = 'fulfillment'\n    }\n\n    const hasChanged = oldStage !== newStage\n    const transitionMessage = hasChanged\n      ? `ğŸ¯ ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰åŒ–ã—ã¾ã—ãŸ: ${oldStage} â†’ ${newStage} (ã‚¿ãƒ¼ãƒ³${turn})`\n      : undefined\n\n    // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ç§»è¡Œäºˆå‘Š\n    const upcomingTransition = this.getUpcomingTransitionMessage(currentStage, turn)\n\n    const result: {\n      newStage: GameStage\n      hasChanged: boolean\n      transitionMessage?: string\n      upcomingTransition?: string\n    } = {\n      newStage,\n      hasChanged\n    }\n\n    if (transitionMessage) {\n      result.transitionMessage = transitionMessage\n    }\n\n    if (upcomingTransition) {\n      result.upcomingTransition = upcomingTransition\n    }\n\n    return result\n  }\n\n  /**\n   * æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ç§»è¡Œäºˆå‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ\n   */\n  private getUpcomingTransitionMessage(currentStage: GameStage, turn: number): string | undefined {\n    const settings = GameConstantsAccessor.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns\n\n    if (currentStage === 'youth') {\n      const turnsUntilMiddle = settings.youthToMiddle - turn\n      if (turnsUntilMiddle <= 2 && turnsUntilMiddle > 0) {\n        return `â° ä¸­å¹´æœŸã¾ã§ã‚ã¨${turnsUntilMiddle}ã‚¿ãƒ¼ãƒ³ (ä½“åŠ›ä¸Šé™ãŒ${this.getStageVitalityLimit('middle')}ã«æ¸›å°‘)`\n      }\n    } else if (currentStage === 'middle') {\n      const turnsUntilFulfillment = settings.middleToFulfillment - turn\n      if (turnsUntilFulfillment <= 2 && turnsUntilFulfillment > 0) {\n        return `â° å……å®ŸæœŸã¾ã§ã‚ã¨${turnsUntilFulfillment}ã‚¿ãƒ¼ãƒ³ (ä½“åŠ›ä¸Šé™ãŒ${this.getStageVitalityLimit('fulfillment')}ã«æ¸›å°‘)`\n      }\n    }\n    return undefined\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã®ä½“åŠ›ä¸Šé™ã‚’å–å¾—\n   */\n  private getStageVitalityLimit(stage: GameStage): number {\n    const params = GameConstantsAccessor.getStageParameters(stage)\n    // Fallback if something is wrong, though accessor usually handles defaults\n    return params ? params.maxVitality : 60\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œæ¡ä»¶ã‚’å–å¾—ï¼ˆé€æ˜åŒ–ï¼‰\n   */\n  static getStageTransitionInfo(): {\n    youthToMiddle: number\n    middleToFulfillment: number\n    description: string\n  } {\n    const settings = GameConstantsAccessor.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns\n    return {\n      youthToMiddle: settings.youthToMiddle,\n      middleToFulfillment: settings.middleToFulfillment,\n      description: `é’å¹´æœŸâ†’ä¸­å¹´æœŸ: ã‚¿ãƒ¼ãƒ³${settings.youthToMiddle}, ä¸­å¹´æœŸâ†’å……å®ŸæœŸ: ã‚¿ãƒ¼ãƒ³${settings.middleToFulfillment}`\n    }\n  }\n\n  /**\n   * ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã‚’è©³ç´°ã«å–å¾—\n   */\n  static getStageDetails(stage: GameStage, turn: number): {\n    stageName: string\n    description: string\n    vitalityLimit: number\n    characteristics: string[]\n    nextTransition?: { targetStage: string, atTurn: number, turnsRemaining: number }\n  } {\n    const stageInfo = {\n      youth: {\n        stageName: 'é’å¹´æœŸ',\n        description: 'ä½“åŠ›ã¯å……å®Ÿã—ã¦ã„ã‚‹ãŒçµŒé¨“ä¸è¶³',\n        vitalityLimit: 35,\n        characteristics: ['é«˜ã„ä½“åŠ›ä¸Šé™', 'çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–ãªã—', 'åŸºæœ¬çš„ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå¤šã„']\n      },\n      middle: {\n        stageName: 'ä¸­å¹´æœŸ',\n        description: 'ä½“åŠ›ã¯è½ã¡ã‚‹ãŒçµŒé¨“è±Šå¯Œ',\n        vitalityLimit: 30,\n        characteristics: ['ä¸­ç¨‹åº¦ã®ä½“åŠ›ä¸Šé™', 'çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–é–‹å§‹', 'è¤‡é›‘ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸å¢—åŠ ']\n      },\n      fulfillment: {\n        stageName: 'å……å®ŸæœŸ',\n        description: 'ä½“åŠ›ã¯é™ã‚‰ã‚Œã‚‹ãŒçŸ¥æµã¨ä½™è£•',\n        vitalityLimit: 27,\n        characteristics: ['ä½ã„ä½“åŠ›ä¸Šé™', 'é«˜ã„çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–', 'çŸ¥è­˜ç³»ãƒãƒ£ãƒ¬ãƒ³ã‚¸æœ‰åˆ©']\n      }\n    }\n\n    const info = stageInfo[stage]\n    const settings = GameConstantsAccessor.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns\n\n    let nextTransition\n    if (stage === 'youth') {\n      const turnsRemaining = settings.youthToMiddle - turn\n      if (turnsRemaining > 0) {\n        nextTransition = {\n          targetStage: 'ä¸­å¹´æœŸ',\n          atTurn: settings.youthToMiddle,\n          turnsRemaining\n        }\n      }\n    } else if (stage === 'middle') {\n      const turnsRemaining = settings.middleToFulfillment - turn\n      if (turnsRemaining > 0) {\n        nextTransition = {\n          targetStage: 'å……å®ŸæœŸ',\n          atTurn: settings.middleToFulfillment,\n          turnsRemaining\n        }\n      }\n    }\n\n    const result: {\n      stageName: string\n      description: string\n      vitalityLimit: number\n      characteristics: string[]\n      nextTransition?: { targetStage: string, atTurn: number, turnsRemaining: number }\n    } = {\n      ...info\n    }\n\n    if (nextTransition) {\n      result.nextTransition = nextTransition\n    }\n\n    return result\n  }\n\n  /**\n   * æ‰‹å‹•ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é€²ã‚ã‚‹\n   * @param currentStage ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @returns æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¨å®Œäº†çŠ¶æ…‹\n   */\n  advanceStage(currentStage: GameStage): {\n    newStage: GameStage | null\n    isCompleted: boolean\n  } {\n    switch (currentStage) {\n      case 'youth':\n        return { newStage: 'middle', isCompleted: false }\n      case 'middle':\n        return { newStage: 'fulfillment', isCompleted: false }\n      case 'fulfillment':\n        return { newStage: null, isCompleted: true }\n      default:\n        return { newStage: null, isCompleted: true }\n    }\n  }\n\n  /**\n   * æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¸ãŒæœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã©ã†ã‹åˆ¤å®š\n   */\n  isFinalStage(stage: GameStage): boolean {\n    return stage === 'fulfillment'\n  }\n}","import type { Card } from '../entities/Card'\nimport type { InsuranceExpirationNotice } from '../types/game.types'\n\n/**\n * ä¿é™ºæœŸé™ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹\n * \n * ä¿é™ºã‚«ãƒ¼ãƒ‰ã®æœŸé™åˆ‡ã‚Œå‡¦ç†ã‚’å°‚é–€ã«æ‰±ã†å˜ä¸€è²¬ä»»ã‚¯ãƒ©ã‚¹\n */\nexport class InsuranceExpirationManager {\n  private static readonly EXPIRING_SOON_THRESHOLD = 2\n\n  /**\n   * å®šæœŸä¿é™ºã®æœŸé™ã‚’æ›´æ–°ã—ã€æœŸé™åˆ‡ã‚Œã‚’ãƒã‚§ãƒƒã‚¯\n   * @param insuranceCards ç¾åœ¨æœ‰åŠ¹ãªä¿é™ºã‚«ãƒ¼ãƒ‰é…åˆ—ï¼ˆå¤‰æ›´ã•ã‚Œã‚‹ï¼‰\n   * @param expiredInsurances æœŸé™åˆ‡ã‚Œä¿é™ºã‚«ãƒ¼ãƒ‰é…åˆ—ï¼ˆå¤‰æ›´ã•ã‚Œã‚‹ï¼‰\n   * @param currentTurn ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³æ•°\n   * @returns æœŸé™åˆ‡ã‚Œé€šçŸ¥ï¼ˆæœŸé™åˆ‡ã‚ŒãŒãªã„å ´åˆã¯undefinedï¼‰\n   */\n  updateInsuranceExpirations(\n    insuranceCards: Card[], \n    expiredInsurances: Card[], \n    currentTurn: number\n  ): InsuranceExpirationNotice | undefined {\n    // æœŸé™åˆ‡ã‚Œã«ãªã£ãŸä¿é™ºã‚’ä¸€æ™‚çš„ã«ä¿å­˜\n    const nowExpired: Card[] = []\n    \n    // å…¨ã¦ã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã®æœŸé™ã‚’æ›´æ–°\n    insuranceCards.forEach(card => {\n      if (card.isTermInsurance()) {\n        card.decrementTurn()\n        \n        // æœŸé™åˆ‡ã‚Œã«ãªã£ãŸã‚‚ã®ã‚’è¨˜éŒ²\n        if (card.isExpired()) {\n          nowExpired.push(card)\n        }\n      }\n    })\n    \n    // æœŸé™åˆ‡ã‚Œã®ä¿é™ºã‚’ active ã‹ã‚‰ expired ã«ç§»å‹•\n    if (nowExpired.length > 0) {\n      // æœŸé™åˆ‡ã‚Œã‚«ãƒ¼ãƒ‰ã‚’ä¿é™ºã‚«ãƒ¼ãƒ‰é…åˆ—ã‹ã‚‰å‰Šé™¤\n      nowExpired.forEach(expiredCard => {\n        const index = insuranceCards.findIndex(card => card.id === expiredCard.id)\n        if (index !== -1) {\n          insuranceCards.splice(index, 1)\n        }\n      })\n      \n      // æœŸé™åˆ‡ã‚Œé…åˆ—ã«è¿½åŠ \n      expiredInsurances.push(...nowExpired)\n      \n      // æœŸé™åˆ‡ã‚Œé€šçŸ¥ã‚’ä½œæˆ\n      return this.createExpirationNotice(nowExpired, currentTurn)\n    }\n    \n    return undefined\n  }\n\n  /**\n   * æœŸé™ãŒè¿‘ã„ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆæ®‹ã‚ŠæŒ‡å®šã‚¿ãƒ¼ãƒ³ä»¥ä¸‹ï¼‰\n   */\n  getExpiringSoonInsurances(insuranceCards: Card[]): Card[] {\n    return insuranceCards.filter(card => \n      card.isTermInsurance() && \n      card.remainingTurns !== undefined && \n      card.remainingTurns <= InsuranceExpirationManager.EXPIRING_SOON_THRESHOLD && \n      card.remainingTurns > 0\n    )\n  }\n\n  /**\n   * ä¿é™ºæœŸé™åˆ‡ã‚Œã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—\n   */\n  getExpirationWarnings(insuranceCards: Card[]): string[] {\n    const expiringSoon = this.getExpiringSoonInsurances(insuranceCards)\n    return expiringSoon.map(card => \n      `âš ï¸ ã€Œ${card.name}ã€ã®æœŸé™ã¾ã§ã‚ã¨${card.remainingTurns}ã‚¿ãƒ¼ãƒ³ã§ã™`\n    )\n  }\n\n  /**\n   * æœŸé™åˆ‡ã‚Œé€šçŸ¥ã‚’ä½œæˆ\n   * @private\n   */\n  private createExpirationNotice(expiredCards: Card[], turnNumber: number): InsuranceExpirationNotice {\n    const expiredNames = expiredCards.map(card => card.name).join('ã€')\n    const message = expiredCards.length === 1 \n      ? `å®šæœŸä¿é™ºã€Œ${expiredNames}ã€ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚`\n      : `å®šæœŸä¿é™º${expiredCards.length}ä»¶ï¼ˆ${expiredNames}ï¼‰ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚`\n    \n    return {\n      expiredCards,\n      message,\n      showRenewalOption: true, // å°†æ¥çš„ã«æ›´æ–°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚\n      turnNumber\n    }\n  }\n}","import type { Difficulty, GameStage, InsuranceType, ICard, InsuranceTriggerType } from './card.types'\nexport type { ICard }\nimport type { Card } from '../entities/Card'\nimport type { Deck } from '../entities/Deck'\n\n/**\n * ã‚²ãƒ¼ãƒ çŠ¶æ…‹\n */\nexport type GameStatus =\n  | 'not_started'\n  | 'in_progress'\n  | 'stage_clear'\n  | 'game_over'\n  | 'victory'\n\n/**\n * ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚º\n */\nexport type GamePhase =\n  | 'setup'                    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n  | 'character_selection'      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ (v2)\n  | 'dream_selection'          // å¤¢é¸æŠ (v2)\n  | 'draw'                     // ãƒ‰ãƒ­ãƒ¼\n  | 'challenge_choice'         // ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠ (v2)\n  | 'challenge'                // ãƒãƒ£ãƒ¬ãƒ³ã‚¸\n  | 'resolution'               // çµæœå‡¦ç†\n  | 'card_selection'           // ã‚«ãƒ¼ãƒ‰é¸æŠï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸæ™‚ï¼‰\n  | 'insurance_type_selection' // ä¿é™ºç¨®é¡é¸æŠï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸæ™‚ï¼‰\n  | 'upgrade'                  // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ™‚ï¼‰\n  | 'end'                     // çµ‚äº†\n\n/**\n * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆ\n */\nexport interface PlayerStats {\n  totalChallenges: number\n  successfulChallenges: number\n  failedChallenges: number\n  cardsAcquired: number\n  highestVitality: number\n  turnsPlayed: number\n  // åˆ†æãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®è¿½åŠ çµ±è¨ˆ\n  totalTurns?: number\n  score?: number\n  challengesCompleted?: number\n  challengesFailed?: number\n  finalVitality?: number\n  finalInsuranceBurden?: number\n}\n\n/**\n * ã‚²ãƒ¼ãƒ è¨­å®š\n */\nexport interface GameConfig {\n  difficulty: Difficulty\n  startingVitality: number\n  startingHandSize: number\n  maxHandSize: number\n  dreamCardCount: number // æœ€çµ‚è©¦ç·´ã§é¸ã¶å¤¢ã‚«ãƒ¼ãƒ‰ã®æ•°\n  // ãƒ†ã‚¹ãƒˆãƒ»åˆ†æç”¨ã®è¿½åŠ è¨­å®š\n  maxTurns?: number\n  // ãƒãƒ©ãƒ³ã‚¹èª¿æ•´è¨­å®š\n  balanceConfig?: BalanceConfig\n  characterId?: string // é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID\n}\n\n/**\n * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®šç¾©\n */\nexport interface Character {\n  id: string\n  name: string\n  description: string\n  initialVitalityModifier: number\n  initialSavings?: number\n  specialAbility: string\n}\n\n/**\n * åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ\n */\nexport const AVAILABLE_CHARACTERS: Character[] = [\n  {\n    id: 'solid',\n    name: 'å …å®Ÿå®¶',\n    description: 'å®ˆã‚Šé‡è¦–ã€‚åˆæœŸæ´»åŠ›ãŒé«˜ãã€ä¿é™ºã®åŠ¹æœãŒé«˜ã„ã€‚',\n    initialVitalityModifier: 20,  // è²¯è“„ãƒœãƒ¼ãƒŠã‚¹ã®ä»£ã‚ã‚Šã«æ´»åŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚’å¢—åŠ \n    specialAbility: 'insurance_bonus'  // è²¯è“„ãƒœãƒ¼ãƒŠã‚¹ã‹ã‚‰ä¿é™ºãƒœãƒ¼ãƒŠã‚¹ã«å¤‰æ›´\n  },\n  {\n    id: 'adventurer',\n    name: 'å†’é™ºå®¶',\n    description: 'ãƒªã‚¹ã‚¯å¿—å‘ã€‚åˆæœŸæ´»åŠ›ã¯ä½ã„ãŒã€ãƒãƒ£ãƒ³ã‚¹ã«å¼·ã„ã€‚',\n    initialVitalityModifier: -5,\n    specialAbility: 'risk_taker'\n  },\n  {\n    id: 'minimalist',\n    name: 'ãƒŸãƒ‹ãƒãƒªã‚¹ãƒˆ',\n    description: 'åŠ¹ç‡é‡è¦–ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç”Ÿæ´»ã‚¹ã‚¿ã‚¤ãƒ«ã€‚',\n    initialVitalityModifier: 10,\n    specialAbility: 'efficiency'\n  }\n]\n\n/**\n * ãƒãƒ©ãƒ³ã‚¹èª¿æ•´è¨­å®š\n * GameConstantsã®å€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ãŸã‚ã®è¨­å®š\n */\nexport interface BalanceConfig {\n  stageParameters?: {\n    youth?: Partial<AgeParameters & { startTurn: number, endTurn: number, insuranceMultiplier: number, challengeDifficultyModifier: number }>\n    middle?: Partial<AgeParameters & { startTurn: number, endTurn: number, insuranceMultiplier: number, challengeDifficultyModifier: number }>\n    fulfillment?: Partial<AgeParameters & { startTurn: number, endTurn: number, insuranceMultiplier: number, challengeDifficultyModifier: number }>\n  }\n  vitalitySettings?: {\n    defaultStarting?: number\n    minimumValue?: number\n    maximumValue?: number\n    healingCap?: number\n  }\n  cardLimits?: {\n    maxHandSize?: number\n    startingHandSize?: number\n    defaultDrawCount?: number\n    maxDeckSize?: number\n  }\n  challengeSettings?: {\n    minDifficulty?: number\n    maxDifficulty?: number\n    successBonusBase?: number\n    failurePenaltyRatio?: number\n    enableDynamicDifficulty?: boolean\n  }\n  progressionSettings?: {\n    maxTurns?: number\n    stageTransitionTurns?: {\n      youthToMiddle: number\n      middleToFulfillment: number\n    }\n    victoryConditions?: {\n      minTurns?: number\n      minVitality?: number\n    }\n  }\n}\n\n/**\n * ä¿é™ºç¨®é¡é¸æŠè‚¢\n */\nexport interface InsuranceTypeChoice {\n  insuranceType: InsuranceType\n  name: string\n  description: string\n  baseCard: Omit<ICard, 'id' | 'durationType' | 'remainingTurns'>\n  termOption: {\n    cost: number\n    duration: number // ã‚¿ãƒ¼ãƒ³æ•°\n    description: string\n  }\n  wholeLifeOption: {\n    cost: number\n    description: string\n  }\n}\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµæœã‚¿ã‚¤ãƒ—\n * - success: ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ˆå ±é…¬ç²å¾—ï¼‰\n * - damage_taken: ãƒ‘ãƒ¯ãƒ¼ä¸è¶³ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ\n */\nexport type ChallengeResultType = 'success' | 'damage_taken' | 'error'\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµæœ\n */\nexport interface ChallengeResult {\n  challenge: Card\n  success: boolean\n  resultType: ChallengeResultType  // æˆåŠŸ or ãƒ€ãƒ¡ãƒ¼ã‚¸å—å®¹\n  playerPower: number\n  challengePower: number\n  rewards?: Card[]\n  cardChoices?: Card[]  // ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ï¼ˆ3æšï¼‰\n  insuranceTypeChoices?: InsuranceTypeChoice[]  // ä¿é™ºç¨®é¡é¸æŠè‚¢ï¼ˆ3ç¨®é¡ï¼‰\n  vitalityChange: number\n  damageAmount?: number  // ãƒ€ãƒ¡ãƒ¼ã‚¸é‡ï¼ˆdamage_takenæ™‚ã®ã¿ï¼‰\n  message: string\n  // Phase 3: ãƒ‘ãƒ¯ãƒ¼è¨ˆç®—ã®è©³ç´°\n  powerBreakdown?: {\n    base: number\n    insurance: number\n    burden: number\n    total: number\n  }\n}\n\n/**\n * ä¿é™ºæœŸé™åˆ‡ã‚Œé€šçŸ¥\n */\nexport interface InsuranceExpirationNotice {\n  expiredCards: Card[]\n  message: string\n  showRenewalOption: boolean\n  turnNumber: number\n}\n\n/**\n * ã‚¿ãƒ¼ãƒ³çµæœï¼ˆæœŸé™åˆ‡ã‚Œé€šçŸ¥ã‚’å«ã‚€ï¼‰\n */\nexport interface TurnResult {\n  insuranceExpirations?: InsuranceExpirationNotice\n  newExpiredCount: number\n  remainingInsuranceCount: number\n}\n\n/**\n * ä¿é™ºç¨®é¡é¸æŠçµæœ\n */\nexport interface InsuranceTypeSelectionResult {\n  success: boolean\n  selectedCard?: Card\n  message: string\n}\n\n/**\n * ã‚²ãƒ¼ãƒ çŠ¶æ…‹\n */\n/**\n * å¹´é½¢åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\n */\nexport interface AgeParameters {\n  maxVitality: number\n  label: string\n  ageMultiplier: number  // ä¿é™ºåŠ¹æœã®å¹´é½¢å€ç‡\n}\n\n/**\n * å¹´é½¢åˆ¥è¨­å®š\n */\nexport const AGE_PARAMETERS: Record<string, AgeParameters> = {\n  youth: {\n    maxVitality: 25,\n    label: 'é’å¹´æœŸ',\n    ageMultiplier: 0\n  },\n  middle: {\n    maxVitality: 20,\n    label: 'ä¸­å¹´æœŸ',\n    ageMultiplier: 0.5\n  },\n  middle_age: {\n    maxVitality: 20,\n    label: 'ä¸­å¹´æœŸ',\n    ageMultiplier: 0.5\n  },\n  fulfillment: {\n    maxVitality: 15,\n    label: 'å……å®ŸæœŸ',\n    ageMultiplier: 1.0\n  }\n}\n\n/**\n * å¤¢ã‚«ãƒ¼ãƒ‰ã®å¹´é½¢èª¿æ•´å€¤\n */\nexport const DREAM_AGE_ADJUSTMENTS = {\n  physical: 3,      // ä½“åŠ›ç³»ï¼šå¹´é½¢ã§+3ãƒ‘ãƒ¯ãƒ¼å¿…è¦\n  intellectual: -2, // çŸ¥è­˜ç³»ï¼šå¹´é½¢ã§-2ãƒ‘ãƒ¯ãƒ¼\n  mixed: 0         // è¤‡åˆç³»ï¼šå¤‰åŒ–ãªã—\n}\n\n\n\n\n/**\n * ä¿ç•™ä¸­ã®ä¿é™ºè«‹æ±‚æƒ…å ±\n */\nexport interface PendingInsuranceClaim {\n  insurance: Card\n  triggerType: InsuranceTriggerType\n  context?: any\n}\n\nexport interface IGameState {\n  id: string\n  status: GameStatus\n  phase: GamePhase\n  stage: GameStage\n  turn: number\n  vitality: number\n  maxVitality: number\n\n  // ãƒ‡ãƒƒã‚­é–¢é€£\n  playerDeck: Deck\n  hand: Card[]\n  discardPile: Card[]\n  challengeDeck: Deck\n\n  // ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–¢é€£\n  currentChallenge: Card | undefined\n  selectedCards: Card[]\n  cardChoices: Card[] | undefined  // ç¾åœ¨ã®é¸æŠè‚¢ã‚«ãƒ¼ãƒ‰\n  insuranceTypeChoices: InsuranceTypeChoice[] | undefined  // ç¾åœ¨ã®ä¿é™ºç¨®é¡é¸æŠè‚¢\n  pendingInsuranceClaim: PendingInsuranceClaim | undefined // ä¿ç•™ä¸­ã®ä¿é™ºè«‹æ±‚\n\n  // Phase 2-4: ä¿é™ºã‚«ãƒ¼ãƒ‰ç®¡ç†\n  activeInsurances: Card[]  // ç¾åœ¨æœ‰åŠ¹ãªä¿é™ºã‚«ãƒ¼ãƒ‰ (renamed from insuranceCards)\n  expiredInsurances: Card[] | undefined  // æœŸé™åˆ‡ã‚Œã«ãªã£ãŸä¿é™ºã‚«ãƒ¼ãƒ‰\n  insuranceMarket: Card[]     // ä¿é™ºå¸‚å ´ï¼ˆè²©å£²ä¸­ã®ä¿é™ºï¼‰\n\n  // Phase 3: ä¿é™ºæ–™è² æ‹…\n  insuranceBurden?: number  // ä¿é™ºæ–™ã«ã‚ˆã‚‹è² æ‹…ï¼ˆè² ã®å€¤ï¼‰\n\n  // v2: æ–°è¦ç´ \n  agingDeck: Deck\n  score: number             // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢\n  selectedDream: Card | undefined      // é¸æŠã—ãŸå¤¢ã‚«ãƒ¼ãƒ‰ (DreamCard)\n\n  // çµ±è¨ˆ\n  stats: PlayerStats\n\n  // è¨­å®š\n  config: GameConfig\n\n  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—\n  startedAt?: Date\n  completedAt?: Date\n}\n","import type { Card } from '../entities/Card'\nimport type { GameStage } from '../types/card.types'\nimport type { ChallengeResult } from '../types/game.types'\nimport type { ICardManager } from './CardManager'\nimport type { Game } from '../entities/Game'\nimport { RiskRewardChallenge } from '../entities/RiskRewardChallenge'\nimport { AGE_PARAMETERS, DREAM_AGE_ADJUSTMENTS } from '../types/game.types'\nimport { MAX_TOTAL_DAMAGE_REDUCTION, MINIMUM_DAMAGE_AFTER_INSURANCE } from '../constants/insurance.constants'\nimport { GameConstantsAccessor } from '../constants/GameConstants'\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸è§£æ±ºã‚µãƒ¼ãƒ“ã‚¹\n * \n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å°‚é–€ã«æ‰±ã†å˜ä¸€è²¬ä»»ã‚¯ãƒ©ã‚¹\n */\nexport class ChallengeResolutionService {\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è§£æ±ºã—ã€çµæœã‚’è¨ˆç®—\n   * @param challenge ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰\n   * @param selectedCards é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰\n   * @param cardManager ã‚«ãƒ¼ãƒ‰ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹\n   * @param stage ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸\n   * @param insuranceBurden ä¿é™ºæ–™è² æ‹…\n   * @param game ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆä¿é™ºæƒ…å ±å–å¾—ç”¨ï¼‰\n   * @returns ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµæœ\n   */\n  resolveChallenge(\n    challenge: Card,\n    selectedCards: Card[],\n    cardManager: ICardManager,\n    stage: GameStage,\n    insuranceBurden: number,\n    game?: Game\n  ): ChallengeResult {\n    // ãƒªã‚¹ã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ç‰¹æ®Šãƒ«ãƒ¼ãƒ«ç¢ºèª\n    const isRiskChallenge = challenge instanceof RiskRewardChallenge\n    const insuranceImmunity = isRiskChallenge && challenge.insuranceImmunity\n\n    // ä¿é™ºåŠ¹æœï¼ˆç‰¹åŒ–å‹ãƒœãƒ¼ãƒŠã‚¹ï¼‰\n    const insuranceBonus = (game && !insuranceImmunity) ? this.calculateInsuranceBonus(game, challenge) : 0\n\n    // ãƒ‘ãƒ¯ãƒ¼è¨ˆç®—\n    const powerBreakdown = this.calculateTotalPower(selectedCards, insuranceBurden, insuranceBonus)\n    const playerPower = powerBreakdown.total\n\n    // å¤¢ã‚«ãƒ¼ãƒ‰ã®å¹´é½¢èª¿æ•´\n    const challengePower = this.getDreamRequiredPower(challenge, stage)\n\n    // æˆåŠŸåˆ¤å®š\n    const success = playerPower >= challengePower\n\n    let vitalityChange = 0\n    let message = ''\n    let damageAmount: number | undefined\n\n    if (success) {\n      // æˆåŠŸæ™‚: åŸºæœ¬å ±é…¬ + éåŠ´ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—\n      const bonusBase = GameConstantsAccessor.getBalanceSettings().CHALLENGE_SETTINGS.successBonusBase\n      const powerDiff = playerPower - challengePower\n\n      // V3å¤‰æ›´: ã€Œæƒœã—ã„ã€åˆ¤å®šå»ƒæ­¢ã®ãŸã‚ã€éå‰°ãƒ‘ãƒ¯ãƒ¼ã¯ã€ŒéåŠ´ã€ã¨ã—ã¦ãƒšãƒŠãƒ«ãƒ†ã‚£\n      // å ±é…¬ã¯å›ºå®šï¼ˆ+5ï¼‰ãªã©ã«ã™ã‚‹ã‹ã€å·®åˆ†ãƒœãƒ¼ãƒŠã‚¹ã‚’æ®‹ã™ã‹ï¼Ÿ\n      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã€Œé”æˆã§ãã¦ã‚‚è¶…éã—ã¦ã„ã‚Œã°è¶…éåˆ†/5ã®åˆ‡ã‚Šæ¨ã¦ã‚’å—ã‘ã‚‹ã€\n      // å ±é…¬è¨ˆç®—ã¯å¾“æ¥ã®ã€ŒåŸºæœ¬+å·®åˆ†/2ã€ã ã¨éåŠ´ã¨ç›¸æ®ºã—ã¦ãƒ—ãƒ©ã‚¹ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚\n      // ã“ã“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ŒåŸºæœ¬å ±é…¬ã®ã¿ã€ã«ã—ã¦ã€éåŠ´ã‚’å¼•ãå½¢ãŒç¾ã—ã„ã‹ï¼Ÿ\n      // ã„ã£ãŸã‚“ã€ŒåŸºæœ¬å ±é…¬ã€ã®ã¿ã«ã—ã¾ã™ã€‚\n      const baseReward = bonusBase // å·®åˆ†ãƒœãƒ¼ãƒŠã‚¹æ’¤å»ƒ\n\n      // éåŠ´ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—\n      // V3.1 Balance: Increase overwork penalty to punish inefficient play (Beginner).\n      // Overflow / 2 (was 5).\n      const overworkDamage = Math.floor(powerDiff / 2)\n\n      // éåŠ´ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚‚ä¿é™ºã§è»½æ¸›å¯èƒ½ï¼ˆåŒ»ç™‚ä¿é™ºãªã©ï¼‰\n      const damageReduction = (game && !insuranceImmunity) ? this.calculateDamageReduction(game) : 0\n      const finalOverworkDamage = Math.max(0, overworkDamage - damageReduction)\n\n      vitalityChange = baseReward - finalOverworkDamage\n\n      message = `ğŸ‰ ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ (+${baseReward})`\n      if (finalOverworkDamage > 0) {\n        message += ` ã—ã‹ã—é ‘å¼µã‚Šã™ãã¦ç–²ã‚ŒãŸ... (-${finalOverworkDamage})`\n      } else if (overworkDamage > 0 && finalOverworkDamage === 0) {\n        message += ` (ä¿é™ºãŒéåŠ´ã‚’é˜²ã„ã ï¼)`\n      }\n    } else {\n      // å¤±æ•—æ™‚: V3ãƒ«ãƒ¼ãƒ«ã€Œä¸è¶³åˆ†é–¢ä¿‚ãªãã€å³ä¸Šã®å€¤ã‚’ä¸¸ã”ã¨å—ã‘ã‚‹ã€\n      // å›ºå®šãƒ€ãƒ¡ãƒ¼ã‚¸ = ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‘ãƒ¯ãƒ¼\n      const baseDamage = challengePower\n\n      // ä¿é™ºè»½æ¸›\n      const damageReduction = (game && !insuranceImmunity) ? this.calculateDamageReduction(game) : 0\n\n      // æœ€å°ãƒ€ãƒ¡ãƒ¼ã‚¸ä¿è¨¼ï¼ˆã©ã‚“ãªã«è»½æ¸›ã—ã¦ã‚‚1ã¯é£Ÿã‚‰ã†ã€ãŸã ã—å®Œå…¨ç„¡åŠ¹åŒ–ã‚¹ã‚­ãƒ«ãŒã‚ã‚Œã°åˆ¥ã ãŒç¾çŠ¶ã¯1ï¼‰\n      const finalDamage = Math.max(MINIMUM_DAMAGE_AFTER_INSURANCE, baseDamage - damageReduction)\n\n      // å¤¢ï¼ˆå¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰ã«å¯¾ã™ã‚‹ç‰¹æ®Šé˜²å¾¡ï¼ˆãŒã‚“ä¿é™ºãªã©ï¼‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯\n      // calculateDamageReductionã«å«ã‚ã‚‹ã‹ã€ã“ã“ã§åˆ¥é€”åˆ¤å®šã™ã‚‹ã‹ï¼Ÿ\n      // ç¾çŠ¶ã®Cardãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ã€Œè»½æ¸›é‡ã€ã‚’è¿”ã™ã®ã§ã€\n      // 20ä»¥ä¸Šã®ã¨ãã«è»½æ¸›é‡ã‚’20ã«ã™ã‚‹ã€ãªã©ã®å®Ÿè£…ãŒCardå´ã§å¿…è¦ã€‚\n      // ã„ã£ãŸã‚“ãã®ã¾ã¾è¨ˆç®—ã€‚\n\n      vitalityChange = -finalDamage\n      damageAmount = finalDamage\n      message = `ğŸ’¥ å¤±æ•—... ${finalDamage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸ`\n    }\n\n    // ã‚«ãƒ¼ãƒ‰ç ´æ£„\n    cardManager.discardSelectedCards()\n\n    // ãƒªã‚¹ã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å ´åˆã®è£œæ­£ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰\n    if (isRiskChallenge) {\n      // ãƒªã‚¹ã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å„ªå…ˆã™ã‚‹å ´åˆã“ã“ã«æˆ»ã™å¿…è¦ã‚ã‚Š\n      // ç¾çŠ¶ã¯V3ãƒ«ãƒ¼ãƒ«å„ªå…ˆ\n    }\n\n    // çµæœä½œæˆ\n    const result: ChallengeResult = {\n      challenge,\n      success,\n      resultType: success ? 'success' : 'damage_taken',\n      playerPower,\n      challengePower,\n      vitalityChange,\n      message,\n      powerBreakdown\n    }\n\n    // ãƒ€ãƒ¡ãƒ¼ã‚¸é‡ã¯ damage_taken æ™‚ã®ã¿è¨­å®š\n    if (!success && damageAmount !== undefined) {\n      result.damageAmount = damageAmount\n    }\n\n    return result\n  }\n\n  /**\n   * ç·åˆãƒ‘ãƒ¯ãƒ¼ã‚’è©³ç´°ã«è¨ˆç®—\n   * @param cards ä½¿ç”¨ã™ã‚‹ã‚«ãƒ¼ãƒ‰\n   * @param insuranceBurden ä¿é™ºæ–™è² æ‹…\n   * @param insuranceBonus ä¿é™ºãƒœãƒ¼ãƒŠã‚¹\n   * @returns ãƒ‘ãƒ¯ãƒ¼ã®è©³ç´°ãªå†…è¨³\n   */\n  private calculateTotalPower(cards: Card[], insuranceBurden: number, insuranceBonus: number = 0): {\n    base: number\n    insurance: number\n    burden: number\n    total: number\n  } {\n    // åŸºæœ¬ãƒ‘ãƒ¯ãƒ¼ï¼ˆä¿é™ºä»¥å¤–ã®ã‚«ãƒ¼ãƒ‰ï¼‰\n    let basePower = 0\n    let insurancePower = 0\n\n    cards.forEach(card => {\n      if (card.type === 'insurance') {\n        // ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼ï¼ˆå¹´é½¢ãƒœãƒ¼ãƒŠã‚¹è¾¼ã¿ï¼‰\n        insurancePower += card.calculateEffectivePower()\n      } else {\n        // ãã®ä»–ã®ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬ãƒ‘ãƒ¯ãƒ¼\n        basePower += card.calculateEffectivePower()\n      }\n    })\n\n    // ä¿é™ºãƒœãƒ¼ãƒŠã‚¹ã‚’ä¿é™ºãƒ‘ãƒ¯ãƒ¼ã«åŠ ç®—\n    insurancePower += insuranceBonus\n\n    // ç·åˆãƒ‘ãƒ¯ãƒ¼\n    const total = basePower + insurancePower - insuranceBurden\n\n    return {\n      base: basePower,\n      insurance: insurancePower,\n      burden: -insuranceBurden, // è² ã®å€¤ã¨ã—ã¦è¡¨ç¤º\n      total: Math.max(0, total) // ç·åˆãƒ‘ãƒ¯ãƒ¼ã¯0ä»¥ä¸‹ã«ãªã‚‰ãªã„\n    }\n  }\n\n  /**\n   * å¤¢ã‚«ãƒ¼ãƒ‰ã®å¿…è¦ãƒ‘ãƒ¯ãƒ¼ã‚’å¹´é½¢èª¿æ•´è¾¼ã¿ã§è¨ˆç®—\n   */\n  private getDreamRequiredPower(challenge: Card, stage: GameStage): number {\n    // å¤¢ã‚«ãƒ¼ãƒ‰ã§ãªã„å ´åˆã¯åŸºæœ¬ãƒ‘ãƒ¯ãƒ¼ã‚’ãã®ã¾ã¾è¿”ã™\n    // NOTE: é€šå¸¸ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã‚‚dreamCategoryï¼ˆèº«ä½“çš„/çŸ¥è­˜çš„ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°å¹´é½¢èª¿æ•´ã‚’é©ç”¨ã™ã‚‹\n    if (!challenge.dreamCategory) {\n      return challenge.power\n    }\n\n    // é’å¹´æœŸã¯èª¿æ•´ãªã—\n    if (stage === 'youth') {\n      return challenge.power\n    }\n\n    // ä¸­å¹´æœŸãƒ»å……å®ŸæœŸã®å¹´é½¢èª¿æ•´ã‚’é©ç”¨ï¼ˆGAME_DESIGN.mdæº–æ‹ ï¼‰\n    // Physical: +3, Intellectual: -2, Mixed: 0\n    // @ts-ignore\n    const adjustment = DREAM_AGE_ADJUSTMENTS[challenge.dreamCategory] || 0\n    const adjustedPower = challenge.power + adjustment\n\n    // æœ€å°å€¤ã¯1\n    return Math.max(1, adjustedPower)\n  }\n\n  /**\n   * ä¿é™ºã«ã‚ˆã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—\n   * @private\n   */\n  private calculateInsuranceBonus(game: Game, challenge: Card): number {\n    let totalBonus = 0\n    const insuranceCards = game.getActiveInsurances()\n    const currentStage = game.stage\n    const ageParams = AGE_PARAMETERS[currentStage] || AGE_PARAMETERS['youth']\n    const ageMultiplier = ageParams?.ageMultiplier ?? 0\n\n    insuranceCards.forEach(insurance => {\n      // çµ‚èº«ä¿é™ºã®å¹´é½¢ä¾¡å€¤ä¸Šæ˜‡ã‚’é©ç”¨\n      let bonus = 0\n\n      if (insurance.isSpecializedInsurance()) {\n        const challengeType = challenge.name\n        bonus = insurance.calculateChallengeBonus(challengeType)\n      }\n\n      // çµ‚èº«ä¿é™ºã®å ´åˆã€å¹´é½¢å€ç‡ã‚’é©ç”¨\n      if (insurance.isWholeLifeInsurance() && ageMultiplier > 0) {\n        bonus += ageMultiplier  // ä¸­å¹´æœŸ+0.5ã€å……å®ŸæœŸ+1.0\n      }\n\n      totalBonus += bonus\n    })\n\n    return totalBonus\n  }\n\n  /**\n   * é˜²å¾¡å‹ä¿é™ºã«ã‚ˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ã‚’è¨ˆç®—\n   * Issue #24: è¤‡æ•°ä¿é™ºã®åˆè¨ˆè»½æ¸›é‡ã«ã‚‚ä¸Šé™ã‚’è¨­å®š\n   * @private\n   */\n  private calculateDamageReduction(game: Game): number {\n    let totalReduction = 0\n    const insuranceCards = game.getActiveInsurances()\n\n    insuranceCards.forEach(insurance => {\n      // calculateDamageReductionå†…ã§é˜²å¾¡åŠ¹æœã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ãŸã‚ã€\n      // å…¨ã¦ã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã§è¨ˆç®—ã‚’å®Ÿè¡Œ\n      totalReduction += insurance.calculateDamageReduction()\n    })\n\n    // åˆè¨ˆè»½æ¸›é‡ã®ä¸Šé™ã‚’é©ç”¨\n    return Math.min(totalReduction, MAX_TOTAL_DAMAGE_REDUCTION)\n  }\n}","/**\n * ã‚²ãƒ¼ãƒ ã‚¿ãƒ¼ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹\n * \n * Game.tsã‹ã‚‰åˆ†é›¢ã•ã‚ŒãŸã‚¿ãƒ¼ãƒ³ç®¡ç†ã®è²¬ä»»ã‚’æŒã¤\n * \n * @class GameTurnManager\n * @description\n * ã‚²ãƒ¼ãƒ ã®ã‚¿ãƒ¼ãƒ³é€²è¡Œã«é–¢ã™ã‚‹ã™ã¹ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†ã—ã¾ã™ã€‚\n * ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã€ä¿é™ºæœŸé™ç®¡ç†ã€ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ãƒ‰ãƒ­ãƒ¼ãªã©ã‚’æ‹…å½“ã—ã¾ã™ã€‚\n * \n * @example\n * ```typescript\n * const turnManager = new GameTurnManager(stageManager, expirationManager);\n * const result = turnManager.nextTurn(game);\n * console.log(`Turn ${game.turn} - Expired insurances: ${result.newExpiredCount}`);\n * ```\n */\n\nimport type { Game } from '../entities/Game'\nimport type { TurnResult } from '../types/game.types'\nimport type { GameStageManager } from './GameStageManager'\nimport type { InsuranceExpirationManager } from './InsuranceExpirationManager'\n\nexport class GameTurnManager {\n  constructor(\n    private readonly stageManager: GameStageManager,\n    private readonly expirationManager: InsuranceExpirationManager\n  ) { }\n\n  /**\n   * æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚ã‚‹\n   * \n   * @method nextTurn\n   * @param {Game} game - ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @returns {TurnResult} ã‚¿ãƒ¼ãƒ³çµæœï¼ˆæœŸé™åˆ‡ã‚Œä¿é™ºæƒ…å ±ã‚’å«ã‚€ï¼‰\n   * @throws {Error} ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã§ãªã„å ´åˆ\n   * \n   * @description\n   * 1. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ¤œè¨¼\n   * 2. ã‚¿ãƒ¼ãƒ³æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ\n   * 3. ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã‚’ãƒã‚§ãƒƒã‚¯\n   * 4. ä¿é™ºæœŸé™ã‚’æ›´æ–°\n   * 5. ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼\n   */\n  nextTurn(game: Game): TurnResult {\n    this.validateGameState(game)\n\n    // æ‰‹æœ­ã‚’ã™ã¹ã¦æ¨ã¦æœ­ã«ç§»å‹• (ãƒ‡ãƒƒã‚­æ§‹ç¯‰ã‚²ãƒ¼ãƒ ã®åŸºæœ¬ãƒ«ãƒ¼ãƒ«)\n    game.cardManager.discardHand()\n\n    game.turn++\n    game.stats.turnsPlayed++\n    game.phase = 'draw'\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã®åˆ¤å®š\n    this.checkStageProgression(game)\n\n    // å‹åˆ©æ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯\n    this.checkVictoryCondition(game)\n    if (game.status === 'victory') {\n      return {\n        newExpiredCount: 0,\n        remainingInsuranceCount: game.getActiveInsurances().length\n      }\n    }\n\n    // ä¿é™ºæœŸé™ã®æ›´æ–°\n    const expirationResult = this.updateInsuranceExpirations(game)\n\n    // ä¿é™ºæ–™ã®æ”¯æ‰•ã„ logic (GameTurnManager or Game entity responsibility)\n    const insuranceCost = game.insuranceBurden\n    if (insuranceCost > 0) {\n      // æ´»åŠ›ãŒè¶³ã‚Šã‚‹å ´åˆã®ã¿æ”¯æ‰•ã†\n      if (game.vitality > insuranceCost) {\n        try {\n          game.applyDamage(insuranceCost)\n          console.log(`ğŸ’¸ ä¿é™ºæ–™æ”¯æ‰•ã„: -${insuranceCost} æ´»åŠ›`)\n        } catch (e) {\n          console.error('ä¿é™ºæ–™æ”¯æ‰•ã„ã«å¤±æ•—ã—ã¾ã—ãŸ', e)\n        }\n      } else {\n        // æ‰•ãˆãªã„å ´åˆã¯ä¿é™ºå¤±åŠ¹ï¼ˆå³æ­»ã¯ã•ã›ãªã„ï¼‰\n        console.warn(`âš ï¸ ä¿é™ºæ–™(${insuranceCost})ã‚’æ”¯æ‰•ã†æ´»åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å…¨ã¦ã®ä¿é™ºãŒå¤±åŠ¹ã—ã¾ã™ã€‚`)\n\n        // å…¨ã¦ã®æœ‰åŠ¹ãªä¿é™ºã‚’å¤±åŠ¹ã•ã›ã‚‹\n        game.expireAllInsurances()\n\n        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãŠçŸ¥ã‚‰ã›ï¼ˆGameã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«é€šçŸ¥æ©Ÿèƒ½ãŒã‚ã‚Œã°å‘¼ã¶ãŒã€ã“ã“ã§ã¯ãƒ­ã‚°ã®ã¿ï¼‰\n      }\n    }\n\n    // Check if game ended due to insurance cost\n    if (game.status === 'game_over') {\n      return {\n        newExpiredCount: expirationResult?.expiredCards.length || 0,\n        remainingInsuranceCount: game.getActiveInsurances().length\n      }\n    }\n\n    // ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ãƒ‰ãƒ­ãƒ¼ã¯è¡Œã‚ãªã„\n    // v2: èª²é¡Œé¸æŠå¾Œã«ãƒ‰ãƒ­ãƒ¼ã™ã‚‹ä»•æ§˜ï¼ˆãƒ‰ã‚­ãƒ‰ã‚­æ„Ÿã®ãŸã‚ï¼‰\n    // GameController / gameStore ã§ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠå¾Œã« drawCards(7) ã‚’å‘¼ã¶\n\n    // å›å¾©å‹ä¿é™ºã®åŠ¹æœã‚’é©ç”¨\n    this.applyRecoveryInsuranceEffects(game)\n\n    return {\n      ...(expirationResult ? { insuranceExpirations: expirationResult } : {}),\n      newExpiredCount: expirationResult?.expiredCards.length || 0,\n      remainingInsuranceCount: game.getActiveInsurances().length\n    }\n  }\n\n  /**\n   * å‹åˆ©æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯\n   * å‹åˆ©æ¡ä»¶: å¤¢ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®ã¿ï¼ˆGame.tsã®resolveChallengeã§åˆ¤å®šï¼‰\n   * æ•—åŒ—æ¡ä»¶: æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•°ã«é”ã—ã¦ã‚‚å¤¢ã‚’é”æˆã§ããªã‹ã£ãŸå ´åˆ\n   * @private\n   */\n  private checkVictoryCondition(game: Game): void {\n    // æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•°ï¼ˆå¤¢ã‚’é”æˆã§ããªã‘ã‚Œã°ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰\n    // å¤¢é”æˆã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€å°‘ã—é•·ã‚ã«è¨­å®š\n    const maxTurns = 100\n\n    if (game.turn >= maxTurns && game.status !== 'victory') {\n      game.status = 'game_over'\n      game.completedAt = new Date()\n      console.log(`ğŸ’” ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼: ${maxTurns}ã‚¿ãƒ¼ãƒ³çµŒéã—ã¦ã‚‚å¤¢ã‚’é”æˆã§ãã¾ã›ã‚“ã§ã—ãŸ`)\n    }\n\n    // Note: å¤¢é”æˆã¯Game.tsã®resolveChallengeå†…ã§åˆ¤å®š\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®æ¤œè¨¼\n   * @private\n   */\n  private validateGameState(game: Game): void {\n    if (game.status !== 'in_progress') {\n      throw new Error('Game is not in progress')\n    }\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œã‚’ãƒã‚§ãƒƒã‚¯\n   * @private\n   */\n  private checkStageProgression(game: Game): void {\n    const progressionResult = this.stageManager.checkStageProgression(\n      game.stage,\n      game.turn\n    )\n\n    if (progressionResult.hasChanged) {\n      game.setStage(progressionResult.newStage)\n\n      if (progressionResult.transitionMessage) {\n        console.log(progressionResult.transitionMessage)\n      }\n    }\n  }\n\n  /**\n   * ä¿é™ºæœŸé™ã‚’æ›´æ–°\n   * @private\n   */\n  private updateInsuranceExpirations(game: Game) {\n    const expirationResult = this.expirationManager.updateInsuranceExpirations(\n      game.activeInsurances,\n      game.expiredInsurances,\n      game.turn\n    )\n\n    // æœŸé™åˆ‡ã‚ŒãŒã‚ã£ãŸå ´åˆã¯ä¿é™ºæ–™è² æ‹…ã‚’å†è¨ˆç®—\n    if (expirationResult) {\n      // Gameã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦æ›´æ–°\n      // ã“ã‚Œã«ã‚ˆã‚Šã€Gameã‚¯ãƒ©ã‚¹ã®å†…éƒ¨çŠ¶æ…‹ã®ä¸€è²«æ€§ã‚’ä¿ã¤\n      (game as any).updateInsuranceBurden()\n    }\n\n    return expirationResult\n  }\n\n  /**\n   * å›å¾©å‹ä¿é™ºã®åŠ¹æœã‚’é©ç”¨\n   * @private\n   */\n  private applyRecoveryInsuranceEffects(game: Game): void {\n    const activeInsurances = game.getActiveInsurances()\n    let totalHeal = 0\n\n    activeInsurances.forEach(insurance => {\n      if (insurance.isRecoveryInsurance()) {\n        totalHeal += insurance.calculateTurnHeal()\n      }\n    })\n\n    if (totalHeal > 0) {\n      game.heal(totalHeal)\n      console.log(`ğŸ’š å›å¾©å‹ä¿é™ºåŠ¹æœ: +${totalHeal} æ´»åŠ›`)\n    }\n  }\n}","/**\n * ã‚²ãƒ¼ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸å‡¦ç†ã‚µãƒ¼ãƒ“ã‚¹\n * \n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®è§£æ±ºã«é–¢ã™ã‚‹è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†\n * \n * @class GameChallengeService\n * @description\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®é–‹å§‹ã‹ã‚‰è§£æ±ºã¾ã§ã®ä¸€é€£ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç®¡ç†ã—ã¾ã™ã€‚\n * ãƒ‘ãƒ¯ãƒ¼è¨ˆç®—ã€æˆåŠŸåˆ¤å®šã€æ´»åŠ›å¤‰æ›´ã€çµ±è¨ˆæ›´æ–°ãªã©ã‚’æ‹…å½“ã—ã¾ã™ã€‚\n * \n * @example\n * ```typescript\n * const challengeService = new GameChallengeService(resolutionService);\n * \n * // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹\n * challengeService.startChallenge(game, challengeCard);\n * \n * // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è§£æ±º\n * const result = challengeService.resolveChallenge(game);\n * if (result.success) {\n *   console.log('ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼');\n * }\n * ```\n */\n\nimport type { Card } from '../entities/Card'\nimport type { Game } from '../entities/Game'\nimport type { ChallengeResult, InsuranceTypeChoice } from '../types/game.types'\nimport { CardFactory } from './CardFactory'\nimport type { ChallengeResolutionService } from './ChallengeResolutionService'\n\n/**\n * ãƒ‘ãƒ¯ãƒ¼è¨ˆç®—ã®å†…è¨³\n * \n * @interface PowerBreakdown\n * @property {number} base - åŸºæœ¬ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼åˆè¨ˆ\n * @property {number} insurance - ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼åˆè¨ˆ\n * @property {number} burden - ä¿é™ºæ–™è² æ‹…ï¼ˆè² ã®å€¤ï¼‰\n * @property {number} total - ç·åˆãƒ‘ãƒ¯ãƒ¼ï¼ˆæœ€å°å€¤ã¯0ï¼‰\n */\nexport interface PowerBreakdown {\n  base: number\n  insurance: number\n  burden: number\n  total: number\n}\n\nexport class GameChallengeService {\n  constructor(\n    private readonly resolutionService: ChallengeResolutionService\n  ) { }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹\n   */\n  startChallenge(game: Game, challengeCard: Card): void {\n    this.validatePhase(game, 'draw')\n\n    game.currentChallenge = challengeCard\n    game.cardManager.clearSelection()\n    game.phase = 'challenge'\n\n    // çµŒé¨“å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ : åŒã˜ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å¤±æ•—å›æ•°ã‚’å–å¾—\n    const failureCount = game.getLearningHistory(challengeCard.name)\n    if (failureCount >= 2) {\n      // 2å›ç›®ä»¥é™ã®å¤±æ•—ã§å¿…è¦ãƒ‘ãƒ¯ãƒ¼-1ï¼ˆçµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–ï¼‰\n      // Card is immutable, so we create a copy with updated power\n      const newPower = Math.max(1, challengeCard.power - 1)\n      const updatedCard = challengeCard.copy({ power: newPower })\n      game.currentChallenge = updatedCard\n    }\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è§£æ±º\n   */\n  resolveChallenge(game: Game): ChallengeResult {\n    try {\n      this.validateChallenge(game)\n\n      // æ–°ã—ã„ChallengeResolutionServiceã‚’ä½¿ç”¨\n      const result = this.resolutionService.resolveChallenge(\n        game.currentChallenge!,\n        game.selectedCards,\n        game.cardManager,\n        game.stage,\n        game.insuranceBurden,\n        game\n      )\n\n      // çµ±è¨ˆæ›´æ–°\n      this.updateStatistics(game, result.success)\n\n      // æ´»åŠ›æ›´æ–°\n      this.updateVitality(game, result.vitalityChange)\n\n      // çµŒé¨“å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ : å¤±æ•—æ™‚ã«å­¦ç¿’å±¥æ­´ã‚’æ›´æ–°\n      if (!result.success && game.currentChallenge) {\n        const challengeName = game.currentChallenge.name\n        const currentFailures = game.getLearningHistory(challengeName)\n        game.updateLearningHistory(challengeName, currentFailures + 1)\n\n        // å¤¢ã‚«ãƒ¼ãƒ‰ã«æ•—åŒ—ã—ãŸå ´åˆã®ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆé›£æ˜“åº¦ä¸Šæ˜‡ï¼‰\n        if (game.currentChallenge.isDreamCard()) {\n          console.log(`[Game] Defeated by dream: ${challengeName}. Increasing difficulty.`)\n          game.challengeDifficultyModifier += 2\n          console.log(`[Game] Difficulty modifier increased to ${game.challengeDifficultyModifier}`)\n        }\n      }\n\n      // æˆåŠŸæ™‚: ä¿é™ºé¸æŠè‚¢ã‚’æç¤º\n      if (result.success) {\n        // å¤¢ã‚«ãƒ¼ãƒ‰é”æˆãƒã‚§ãƒƒã‚¯\n        if (game.currentChallenge?.type === 'dream' || (game.currentChallenge as any).isDream) {\n          console.log('[GameChallengeService] Dream fulfilled! Victory!');\n          game.finishGame(true);\n          // å‹åˆ©æ™‚ã¯ä¿é™ºé¸æŠã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å³ãƒªã‚¿ãƒ¼ãƒ³\n          this.updateGameStateAfterChallenge(game, result);\n          return result;\n        }\n\n        const choices = CardFactory.createInsuranceTypeChoices(game.stage)\n        game.insuranceTypeChoices = choices\n        console.log('[GameChallengeService] Generated insurance choices:', game.insuranceTypeChoices?.length)\n\n        if (!game.insuranceTypeChoices || game.insuranceTypeChoices.length === 0) {\n          console.warn('[GameChallengeService] WARNING: No insurance choices generated!')\n        }\n\n        // Phase transition is handled by calling context or Game logic\n        result.insuranceTypeChoices = choices\n\n        // User Request: Omit Reward Cards explicitly.\n        // Reward generation logic has been removed to prevent deck bloat (\"ãƒ‘ãƒ¯ã‚«\" issue)\n      }\n\n      this.updateGameStateAfterChallenge(game, result)\n\n      return result\n    } catch (error) {\n      console.error('[GameChallengeService] Fatal error resolving challenge:', error)\n      // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã‚’è¿”ã™\n      return {\n        challenge: game.currentChallenge || CardFactory.createCard({\n          base: { name: 'Error', type: 'life', description: 'System Error' },\n          variant: 'default'\n        }),\n        success: false,\n        playerPower: 0,\n        challengePower: 0,\n        vitalityChange: 0,\n        message: `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : String(error)}`,\n        resultType: 'error' // ã‚¨ãƒ©ãƒ¼æ‰±ã„\n      }\n    }\n  }\n\n  /**\n   * ç·åˆãƒ‘ãƒ¯ãƒ¼ã‚’è¨ˆç®—\n   * \n   * @method calculateTotalPower\n   * @param {Game} game - ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @param {Card[]} cards - è¨ˆç®—å¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰é…åˆ—\n   * @returns {PowerBreakdown} ãƒ‘ãƒ¯ãƒ¼ã®è©³ç´°ãªå†…è¨³\n   * \n   * @description\n   * é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼ã‚’è¨ˆç®—ã—ã€ä¿é™ºæ–™è² æ‹…ã‚’è€ƒæ…®ã—ãŸ\n   * ç·åˆãƒ‘ãƒ¯ãƒ¼ã‚’ç®—å‡ºã—ã¾ã™ã€‚çµæœã¯å¸¸ã«0ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚\n   */\n  calculateTotalPower(game: Game, cards: Card[]): PowerBreakdown {\n    let basePower = 0\n    let insurancePower = 0\n\n    for (const card of cards) {\n      if (card.type === 'insurance') {\n        insurancePower += card.calculateEffectivePower()\n      } else {\n        basePower += card.calculateEffectivePower()\n      }\n    }\n\n    const burden = game.insuranceBurden\n    const total = Math.max(0, basePower + insurancePower + burden)\n\n    return { base: basePower, insurance: insurancePower, burden, total }\n  }\n\n  /**\n   * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ•ã‚§ãƒ¼ã‚ºãƒã‚§ãƒƒã‚¯\n   * @private\n   */\n  private validatePhase(game: Game, expectedPhase: string): void {\n    // v2: allow challenge_choice phase\n    if (game.phase === 'challenge_choice' && expectedPhase === 'draw') {\n      return\n    }\n\n    if (game.phase !== expectedPhase) {\n      if (expectedPhase === 'draw') {\n        throw new Error(`Can only start challenge during draw or challenge_choice phase (Current: ${game.phase})`)\n      }\n      throw new Error(`Can only perform this action during ${expectedPhase} phase (Current: ${game.phase})`)\n    }\n  }\n\n  /**\n   * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒãƒ£ãƒ¬ãƒ³ã‚¸å­˜åœ¨ãƒã‚§ãƒƒã‚¯\n   * @private\n   */\n  private validateChallenge(game: Game): void {\n    if (!game.currentChallenge || game.phase !== 'challenge') {\n      throw new Error('No active challenge to resolve')\n    }\n  }\n\n  /**\n   * çµ±è¨ˆã‚’æ›´æ–°\n   * @private\n   */\n  private updateStatistics(game: Game, success: boolean): void {\n    game.stats.totalChallenges++\n    if (success) {\n      game.stats.successfulChallenges++\n      // challengesCompletedã‚‚æ›´æ–°ï¼ˆãƒ†ã‚¹ãƒˆã§ã®æœŸå¾…å€¤å¯¾å¿œï¼‰\n      if (!game.stats.challengesCompleted) {\n        game.stats.challengesCompleted = 0\n      }\n      game.stats.challengesCompleted++\n    } else {\n      game.stats.failedChallenges++\n      // challengesFailedã‚‚æ›´æ–°ï¼ˆçµ±è¨ˆã®æ•´åˆæ€§ç¢ºä¿ï¼‰\n      if (!game.stats.challengesFailed) {\n        game.stats.challengesFailed = 0\n      }\n      game.stats.challengesFailed++\n    }\n  }\n\n  /**\n   * æ´»åŠ›ã‚’æ›´æ–°\n   * @private\n   */\n  private updateVitality(game: Game, change: number): void {\n    if (change >= 0) {\n      game.heal(change)\n    } else {\n      const damage = -change\n\n      // åŒ»ç™‚ä¿é™ºãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯ (ãƒ€ãƒ¡ãƒ¼ã‚¸10ä»¥ä¸Š)\n      if (damage >= 10) {\n        const insurance = game.activeInsurances.find(c => c.insuranceTriggerType === 'on_heavy_damage')\n        if (insurance) {\n          game.triggerInsuranceClaim(insurance, 'on_heavy_damage')\n          if (game.pendingInsuranceClaim) {\n            game.pendingInsuranceClaim.context = { damage }\n            return // ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ã‚’ä¿ç•™\n          }\n        }\n      }\n\n      game.applyDamage(damage)\n    }\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¾Œã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°\n   * @private\n   */\n  private updateGameStateAfterChallenge(\n    game: Game,\n    result: ChallengeResult\n  ): void {\n    // ä½¿ç”¨ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«\n    game.cardManager.discardSelectedCards()\n\n    // ãƒ•ã‚§ãƒ¼ã‚ºæ›´æ–°\n    game.phase = result.success\n      ? 'insurance_type_selection'\n      : 'resolution'\n\n    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ã‚¯ãƒªã‚¢\n    game.currentChallenge = undefined\n    game.cardManager.clearSelection()\n  }\n}","/**\n * ä¿é™ºç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹\n * \n * ä¿é™ºé–¢é€£ã®å‡¦ç†ã‚’é›†ç´„\n */\n\nimport type { Card } from '../entities/Card'\nimport type { Game } from '../entities/Game'\nimport type { InsuranceTypeSelectionResult } from '../types/game.types'\nimport { CardFactory } from './CardFactory'\nimport { InsurancePremium } from '../valueObjects/InsurancePremium'\nimport type { InsurancePremiumCalculationService } from './InsurancePremiumCalculationService'\n\nexport class GameInsuranceService {\n  constructor(\n    private readonly premiumService: InsurancePremiumCalculationService\n  ) { }\n\n  /**\n   * ä¿é™ºã‚’è¿½åŠ \n   */\n  addInsurance(game: Game, card: Card): void {\n    if (!card.isInsurance()) {\n      throw new Error('Only insurance cards can be added')\n    }\n\n    game.activeInsurances.push(card)\n    this.updateInsuranceBurden(game)\n  }\n\n  /**\n   * ä¿é™ºã‚’è§£ç´„ãƒ»å‰Šé™¤\n   */\n  removeInsurance(game: Game, card: Card): void {\n    // Gameã®activeInsurancesã‹ã‚‰å‰Šé™¤\n    const index = game.activeInsurances.findIndex(c => c.id === card.id)\n    if (index !== -1) {\n      game.activeInsurances.splice(index, 1)\n    }\n\n    // ãƒ‡ãƒƒã‚­/æ‰‹æœ­/æ¨ã¦æœ­ã‹ã‚‰å‰Šé™¤\n    game.cardManager.removeCardFromGame(card)\n\n    // ä¿é™ºæ–™å†è¨ˆç®—\n    this.updateInsuranceBurden(game)\n  }\n\n  /**\n   * ä¿é™ºç¨®é¡ã‚’é¸æŠ\n   */\n  selectInsuranceType(\n    game: Game,\n    insuranceType: string,\n    durationType: 'term' | 'whole_life'\n  ): InsuranceTypeSelectionResult {\n    this.validateInsuranceSelection(game)\n\n    const choice = this.findInsuranceChoice(game, insuranceType)\n    if (!choice) {\n      return {\n        success: false,\n        message: 'Invalid insurance type selection'\n      }\n    }\n\n    const selectedCard = this.createInsuranceCard(choice, durationType)\n\n    this.addInsuranceCard(game, selectedCard)\n    this.updatePlayerHistory(game, insuranceType)\n    this.updateRiskProfile(game)\n    this.completeInsuranceSelection(game)\n\n    return this.createSelectionResult(selectedCard, choice, durationType)\n  }\n\n  /**\n   * ä¿é™ºæ–™è² æ‹…ã‚’è¨ˆç®—\n   */\n  calculateInsuranceBurden(game: Game): number {\n    if (game.activeInsurances.length === 0) {\n      return 0\n    }\n\n\n\n    try {\n      const totalBurden = this.premiumService.calculateTotalInsuranceBurden(\n        game.activeInsurances,\n        game.stage,\n        game.getRiskProfile()\n      )\n\n      // è² ã®å€¤ã¨ã—ã¦è¿”ã™ï¼ˆæ´»åŠ›ã‹ã‚‰å·®ã—å¼•ã‹ã‚Œã‚‹ãŸã‚ï¼‰\n      return -totalBurden.getValue()\n    } catch (error) {\n      // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯æœŸå¾…ã•ã‚Œã‚‹æŒ™å‹•ãªã®ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æŠ‘åˆ¶\n      if (process.env['NODE_ENV'] !== 'test') {\n        console.warn('ä¿é™ºæ–™è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error)\n      }\n      return this.fallbackBurdenCalculation(game)\n    }\n  }\n\n  /**\n   * ä¿é™ºæ–™è² æ‹…ã‚’æ›´æ–°\n   */\n  updateInsuranceBurden(game: Game): void {\n    const burden = this.calculateInsuranceBurden(game)\n    // Gameã‚¯ãƒ©ã‚¹ã®å†…éƒ¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°\n    // ä¿é™ºæ–™è² æ‹…ã¯è² ã®å€¤ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚ã€ç¬¦å·ã‚’åè»¢ã•ã›ã¦ä¿å­˜\n    const burdenValue = Math.abs(burden)\n      ; (game as any)._insuranceBurden = InsurancePremium.create(burdenValue)\n\n    // ãƒ€ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°\n    if ((game as any)._dirtyFlags) {\n      (game as any)._dirtyFlags.insurance = true\n        ; (game as any)._dirtyFlags.burden = true\n    }\n  }\n\n  /**\n   * æ¨å¥¨ä¿é™ºäºˆç®—ã‚’å–å¾—\n   */\n  getRecommendedInsuranceBudget(\n    vitality: number,\n    stage: string,\n    riskProfile: 'conservative' | 'balanced' | 'aggressive' = 'balanced'\n  ): InsurancePremium {\n    return this.premiumService.calculateOptimalInsuranceBudget(\n      vitality,\n      stage as any,\n      riskProfile\n    )\n  }\n\n  /**\n   * æœŸé™ãŒè¿‘ã„ä¿é™ºã‚’å–å¾—\n   */\n  getExpiringSoonInsurances(insuranceCards: Card[]): Card[] {\n    return insuranceCards.filter(card => {\n      if (!card.isTermInsurance() || !card.remainingTurns) {\n        return false\n      }\n      return card.remainingTurns <= 2\n    })\n  }\n\n  /**\n   * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³\n   * @private\n   */\n  private validateInsuranceSelection(game: Game): void {\n    if (game.phase !== 'insurance_type_selection') {\n      throw new Error('Not in insurance type selection phase')\n    }\n\n    if (!game.insuranceTypeChoices) {\n      throw new Error('No insurance type choices available')\n    }\n  }\n\n  /**\n   * ä¿é™ºé¸æŠè‚¢ã‚’æ¤œç´¢\n   * @private\n   */\n  private findInsuranceChoice(game: Game, insuranceType: string) {\n    return game.insuranceTypeChoices?.find(\n      choice => choice.insuranceType === insuranceType\n    )\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ\n   * @private\n   */\n  private createInsuranceCard(choice: any, durationType: 'term' | 'whole_life'): Card {\n    if (durationType === 'term') {\n      return CardFactory.createTermInsuranceCard(choice)\n    }\n    return CardFactory.createWholeLifeInsuranceCard(choice)\n\n  }\n\n  /**\n   * ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n   * @private\n   */\n  private addInsuranceCard(game: Game, card: Card): void {\n    game.cardManager.addToPlayerDeck(card)\n    game.stats.cardsAcquired++\n    game.activeInsurances.push(card)\n    this.updateInsuranceBurden(game)\n  }\n\n  /**\n   * ä¿é™ºé¸æŠã‚’å®Œäº†\n   * @private\n   */\n  private completeInsuranceSelection(game: Game): void {\n    game.insuranceTypeChoices = undefined\n    game.phase = 'resolution'\n  }\n\n  /**\n   * é¸æŠçµæœã‚’ä½œæˆ\n   * @private\n   */\n  private createSelectionResult(\n    card: Card,\n    choice: any,\n    durationType: 'term' | 'whole_life'\n  ): InsuranceTypeSelectionResult {\n    const durationText = durationType === 'term'\n      ? `å®šæœŸä¿é™ºï¼ˆ${choice.termOption.duration}ã‚¿ãƒ¼ãƒ³ï¼‰`\n      : 'çµ‚èº«ä¿é™º'\n\n    return {\n      success: true,\n      selectedCard: card,\n      message: `${choice.name}ï¼ˆ${durationText}ï¼‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚ã‚³ã‚¹ãƒˆ: ${card.cost}`\n    }\n  }\n\n  /**\n   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç®—\n   * @private\n   */\n  private fallbackBurdenCalculation(game: Game): number {\n    const activeInsuranceCount = game.activeInsurances.length\n    const burden = Math.floor(activeInsuranceCount / 3)\n    return burden === 0 ? 0 : -burden\n  }\n\n  /**\n   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´ã‚’æ›´æ–°\n   * @private\n   */\n  private updatePlayerHistory(game: Game, insuranceType: string): void {\n    const history = game.getPlayerHistory()\n    history.totalInsurancePurchased++\n\n    // ãƒªã‚¹ã‚¯ã®é«˜ã„ä¿é™ºç¨®é¡ã‚’é¸ã‚“ã å ´åˆ\n    if (insuranceType === 'life' || insuranceType === 'cancer') {\n      history.riskyChoiceCount++\n    }\n    history.totalChoiceCount++\n\n      // Gameã®å†…éƒ¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°\n      ; (game as any)._playerHistory = history\n  }\n\n  /**\n   * ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°\n   * @private\n   */\n  private updateRiskProfile(game: Game): void {\n    const newProfile = this.premiumService.generateRiskProfile(\n      game.getPlayerHistory(),\n      game.stage\n    )\n      ; (game as any)._riskProfile = newProfile\n  }\n}","/**\n * AIæˆ¦ç•¥ã‚µãƒ¼ãƒ“ã‚¹\n * \n * ç•°ãªã‚‹AIæˆ¦ç•¥ï¼ˆConservative, Aggressive, Balanced, Adaptiveï¼‰ã‚’å®Ÿè£…ã—ã€\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã¨ã‚«ãƒ¼ãƒ‰é¸æŠã®æ„æ€æ±ºå®šã‚’è¡Œã„ã¾ã™ã€‚\n */\n\nimport type { Card } from '../entities/Card'\nimport type { Game } from '../entities/Game'\nimport type { GameStage } from '../types/game.types'\n\n/**\n * AIæˆ¦ç•¥ã‚¿ã‚¤ãƒ—\n */\nexport type AIStrategyType = 'conservative' | 'aggressive' | 'balanced' | 'adaptive'\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠçµæœ\n */\nexport interface ChallengeChoice {\n  /** é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ */\n  challenge: Card\n  /** é¸æŠç†ç”± */\n  reason: string\n  /** æˆåŠŸç¢ºç‡äºˆæ¸¬ */\n  successProbability: number\n}\n\n/**\n * ã‚«ãƒ¼ãƒ‰é¸æŠçµæœ\n */\nexport interface CardChoice {\n  /** é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰é…åˆ— */\n  cards: Card[]\n  /** é¸æŠç†ç”± */\n  reason: string\n  /** æœŸå¾…ãƒ‘ãƒ¯ãƒ¼å€¤ */\n  expectedPower: number\n}\n\n/**\n * AIæˆ¦ç•¥ã®åŸºåº•ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\n */\nexport interface AIStrategy {\n  /**\n   * æˆ¦ç•¥åã‚’å–å¾—\n   */\n  getName(): string\n\n  /**\n   * æˆ¦ç•¥ã‚¿ã‚¤ãƒ—ã‚’å–å¾—\n   */\n  getType(): AIStrategyType\n\n  /**\n   * åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‹ã‚‰æœ€é©ãªã‚‚ã®ã‚’é¸æŠ\n   */\n  selectChallenge(\n    availableChallenges: Card[],\n    game: Game\n  ): ChallengeChoice\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«å¯¾ã—ã¦æœ€é©ãªã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ\n   */\n  selectCards(\n    challenge: Card,\n    availableCards: Card[],\n    game: Game\n  ): CardChoice\n\n  /**\n   * ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ³ã«å¯¾ã™ã‚‹æˆ¦ç•¥ã®é©ç”¨åº¦ã‚’è©•ä¾¡ï¼ˆ0-1ï¼‰\n   */\n  evaluateFitness(game: Game): number\n}\n\n/**\n * ä¿å®ˆçš„æˆ¦ç•¥ - ãƒªã‚¹ã‚¯ã‚’é¿ã‘å®‰å…¨ãªé¸æŠã‚’å„ªå…ˆ\n */\nexport class ConservativeStrategy implements AIStrategy {\n  getName(): string {\n    return 'ä¿å®ˆçš„æˆ¦ç•¥'\n  }\n\n  getType(): AIStrategyType {\n    return 'conservative'\n  }\n\n  selectChallenge(availableChallenges: Card[], game: Game): ChallengeChoice {\n    // æœ€ã‚‚æ˜“ã—ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠ\n    const sortedChallenges = [...availableChallenges].sort((a, b) => a.power - b.power)\n    const easiestChallenge = sortedChallenges[0]\n    \n    const currentPower = this.estimateCurrentPower(game)\n    const successProbability = Math.min(1, currentPower / easiestChallenge.power)\n\n    return {\n      challenge: easiestChallenge,\n      reason: 'æœ€ã‚‚å®‰å…¨ã§æˆåŠŸç¢ºç‡ã®é«˜ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ',\n      successProbability\n    }\n  }\n\n  selectCards(challenge: Card, availableCards: Card[], game: Game): CardChoice {\n    const targetPower = challenge.power\n    const selectedCards: Card[] = []\n    let currentPower = 0\n\n    // ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ï¼ˆãƒªã‚¹ã‚¯è»½æ¸›ï¼‰\n    const insuranceCards = availableCards\n      .filter(card => card.type === 'insurance')\n      .sort((a, b) => b.calculateEffectivePower() - a.calculateEffectivePower())\n\n    const otherCards = availableCards\n      .filter(card => card.type !== 'insurance')\n      .sort((a, b) => b.calculateEffectivePower() - a.calculateEffectivePower())\n\n    // ã¾ãšä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ\n    for (const card of insuranceCards) {\n      if (currentPower >= targetPower * 1.2) break // ä½™è£•ã‚’æŒã£ã¦åœæ­¢\n      selectedCards.push(card)\n      currentPower += card.calculateEffectivePower()\n    }\n\n    // å¿…è¦ã«å¿œã˜ã¦ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n    for (const card of otherCards) {\n      if (currentPower >= targetPower * 1.2) break\n      selectedCards.push(card)\n      currentPower += card.calculateEffectivePower()\n    }\n\n    return {\n      cards: selectedCards,\n      reason: 'ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã€ååˆ†ãªä½™è£•ã‚’æŒã£ãŸå®‰å…¨ãªé¸æŠã‚’è¡Œã„ã¾ã—ãŸ',\n      expectedPower: currentPower\n    }\n  }\n\n  evaluateFitness(game: Game): number {\n    // æ´»åŠ›ãŒä½ã„ã»ã©ä¿å®ˆçš„æˆ¦ç•¥ãŒé©ã—ã¦ã„ã‚‹\n    const vitalityRatio = game.vitality / game.maxVitality\n    return 1 - vitalityRatio\n  }\n\n  private estimateCurrentPower(game: Game): number {\n    return game.cardManager.playerDeck.getCards()\n      .reduce((total, card) => total + card.calculateEffectivePower(), 0)\n  }\n}\n\n/**\n * æ”»æ’ƒçš„æˆ¦ç•¥ - é«˜ãƒªã‚¹ã‚¯é«˜ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†\n */\nexport class AggressiveStrategy implements AIStrategy {\n  getName(): string {\n    return 'æ”»æ’ƒçš„æˆ¦ç•¥'\n  }\n\n  getType(): AIStrategyType {\n    return 'aggressive'\n  }\n\n  selectChallenge(availableChallenges: Card[], game: Game): ChallengeChoice {\n    // æœ€ã‚‚é›£ã—ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠï¼ˆãŸã ã—å‹ç‡50%ä»¥ä¸Šã®ã‚‚ã®ï¼‰\n    const currentPower = this.estimateCurrentPower(game)\n    \n    const viableChallenges = availableChallenges\n      .filter(challenge => currentPower >= challenge.power * 0.5) // æœ€ä½50%ã®å‹ç‡\n      .sort((a, b) => b.power - a.power) // é›£ã—ã„é †\n\n    const selectedChallenge = viableChallenges[0] || availableChallenges[0]\n    const successProbability = Math.min(1, currentPower / selectedChallenge.power)\n\n    return {\n      challenge: selectedChallenge,\n      reason: 'é«˜ã„å ±é…¬ã‚’ç‹™ã£ã¦ã€å¯èƒ½ãªé™ã‚Šå›°é›£ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ',\n      successProbability\n    }\n  }\n\n  selectCards(challenge: Card, availableCards: Card[], game: Game): CardChoice {\n    const targetPower = challenge.power\n    const selectedCards: Card[] = []\n    let currentPower = 0\n\n    // æœ€ã‚‚ãƒ‘ãƒ¯ãƒ¼ã®é«˜ã„ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸æŠï¼ˆåŠ¹ç‡é‡è¦–ï¼‰\n    const sortedCards = [...availableCards]\n      .sort((a, b) => b.calculateEffectivePower() - a.calculateEffectivePower())\n\n    for (const card of sortedCards) {\n      if (currentPower >= targetPower) break // å¿…è¦æœ€å°é™ã§åœæ­¢\n      selectedCards.push(card)\n      currentPower += card.calculateEffectivePower()\n    }\n\n    return {\n      cards: selectedCards,\n      reason: 'æœ€é«˜ãƒ‘ãƒ¯ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’å„ªå…ˆã—ã€å¿…è¦æœ€å°é™ã®ã‚³ã‚¹ãƒˆã§å‹åˆ©ã‚’ç‹™ã„ã¾ã—ãŸ',\n      expectedPower: currentPower\n    }\n  }\n\n  evaluateFitness(game: Game): number {\n    // æ´»åŠ›ãŒé«˜ãã€æ‰‹æœ­ãŒå¼·ã„ã»ã©æ”»æ’ƒçš„æˆ¦ç•¥ãŒé©ã—ã¦ã„ã‚‹\n    const vitalityRatio = game.vitality / game.maxVitality\n    const handStrength = this.estimateHandStrength(game)\n    return (vitalityRatio + handStrength) / 2\n  }\n\n  private estimateCurrentPower(game: Game): number {\n    return game.cardManager.playerDeck.getCards()\n      .reduce((total, card) => total + card.calculateEffectivePower(), 0)\n  }\n\n  private estimateHandStrength(game: Game): number {\n    const handCards = game.cardManager.playerDeck.getCards()\n    if (handCards.length === 0) return 0\n    \n    const averagePower = handCards\n      .reduce((total, card) => total + card.calculateEffectivePower(), 0) / handCards.length\n    \n    // å¹³å‡ãƒ‘ãƒ¯ãƒ¼3ã‚’åŸºæº–ã¨ã—ãŸæ­£è¦åŒ–ï¼ˆ0-1ï¼‰\n    return Math.min(1, averagePower / 3)\n  }\n}\n\n/**\n * ãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥ - ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–\n */\nexport class BalancedStrategy implements AIStrategy {\n  getName(): string {\n    return 'ãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥'\n  }\n\n  getType(): AIStrategyType {\n    return 'balanced'\n  }\n\n  selectChallenge(availableChallenges: Card[], game: Game): ChallengeChoice {\n    const currentPower = this.estimateCurrentPower(game)\n    \n    // æˆåŠŸç¢ºç‡70-90%ã®ç¯„å›²ã§ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠ\n    const scoredChallenges = availableChallenges.map(challenge => {\n      const successProbability = Math.min(1, currentPower / challenge.power)\n      const riskRewardScore = this.calculateRiskRewardScore(challenge, successProbability)\n      \n      return { challenge, successProbability, score: riskRewardScore }\n    })\n\n    const bestChoice = scoredChallenges\n      .sort((a, b) => b.score - a.score)[0]\n\n    return {\n      challenge: bestChoice.challenge,\n      reason: 'ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã¦æœ€é©ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ',\n      successProbability: bestChoice.successProbability\n    }\n  }\n\n  selectCards(challenge: Card, availableCards: Card[], game: Game): CardChoice {\n    const targetPower = challenge.power\n    const selectedCards: Card[] = []\n    let currentPower = 0\n\n    // ã‚«ãƒ¼ãƒ‰åŠ¹ç‡ï¼ˆãƒ‘ãƒ¯ãƒ¼/ã‚³ã‚¹ãƒˆæ¯”ï¼‰ã§å„ªå…ˆé †ä½ã‚’æ±ºå®š\n    const scoredCards = availableCards.map(card => {\n      const efficiency = this.calculateCardEfficiency(card, game)\n      return { card, efficiency }\n    }).sort((a, b) => b.efficiency - a.efficiency)\n\n    for (const { card } of scoredCards) {\n      if (currentPower >= targetPower * 1.1) break // 10%ã®ä½™è£•\n      selectedCards.push(card)\n      currentPower += card.calculateEffectivePower()\n    }\n\n    return {\n      cards: selectedCards,\n      reason: 'ã‚«ãƒ¼ãƒ‰åŠ¹ç‡ã¨ãƒªã‚¹ã‚¯ç®¡ç†ã‚’ä¸¡ç«‹ã—ãŸæœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’é¸æŠã—ã¾ã—ãŸ',\n      expectedPower: currentPower\n    }\n  }\n\n  evaluateFitness(game: Game): number {\n    // å¸¸ã«ä¸­ç¨‹åº¦ã®é©ç”¨åº¦ï¼ˆä»–ã®æˆ¦ç•¥ãŒãƒ•ã‚£ãƒƒãƒˆã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰\n    return 0.6\n  }\n\n  private estimateCurrentPower(game: Game): number {\n    return game.cardManager.playerDeck.getCards()\n      .reduce((total, card) => total + card.calculateEffectivePower(), 0)\n  }\n\n  private calculateRiskRewardScore(challenge: Card, successProbability: number): number {\n    // ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”ã‚’è¨ˆç®—ï¼ˆæˆåŠŸç¢ºç‡ * å ±é…¬ - å¤±æ•—ç¢ºç‡ * ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰\n    const reward = challenge.power * 0.5 // æˆåŠŸæ™‚ã®å ±é…¬æƒ³å®š\n    const penalty = challenge.power * 0.3 // å¤±æ•—æ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£æƒ³å®š\n    \n    return successProbability * reward - (1 - successProbability) * penalty\n  }\n\n  private calculateCardEfficiency(card: Card, game: Game): number {\n    const power = card.calculateEffectivePower()\n    const cost = this.estimateCardCost(card)\n    return power / Math.max(1, cost)\n  }\n\n  private estimateCardCost(card: Card): number {\n    // ã‚«ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆæ¨å®šï¼ˆä¿é™ºã‚«ãƒ¼ãƒ‰ã¯è² æ‹…ãŒã‚ã‚‹ãŸã‚é«˜ã‚³ã‚¹ãƒˆï¼‰\n    if (card.type === 'insurance') {\n      return card.calculateEffectivePower() + 1 // ä¿é™ºæ–™è² æ‹…ã‚’è€ƒæ…®\n    }\n    return 1 // åŸºæœ¬ã‚«ãƒ¼ãƒ‰ã¯æ¨™æº–ã‚³ã‚¹ãƒˆ\n  }\n}\n\n/**\n * é©å¿œæˆ¦ç•¥ - ã‚²ãƒ¼ãƒ çŠ¶æ³ã«å¿œã˜ã¦ä»–ã®æˆ¦ç•¥ã‚’å‹•çš„ã«é¸æŠ\n */\nexport class AdaptiveStrategy implements AIStrategy {\n  private strategies: AIStrategy[]\n\n  constructor() {\n    this.strategies = [\n      new ConservativeStrategy(),\n      new AggressiveStrategy(),\n      new BalancedStrategy()\n    ]\n  }\n\n  getName(): string {\n    return 'é©å¿œæˆ¦ç•¥'\n  }\n\n  getType(): AIStrategyType {\n    return 'adaptive'\n  }\n\n  selectChallenge(availableChallenges: Card[], game: Game): ChallengeChoice {\n    const bestStrategy = this.selectBestStrategy(game)\n    const choice = bestStrategy.selectChallenge(availableChallenges, game)\n    \n    return {\n      ...choice,\n      reason: `ç¾åœ¨ã®çŠ¶æ³ã‚’åˆ†æã—ã€${bestStrategy.getName()}ã‚’æ¡ç”¨: ${choice.reason}`\n    }\n  }\n\n  selectCards(challenge: Card, availableCards: Card[], game: Game): CardChoice {\n    const bestStrategy = this.selectBestStrategy(game)\n    const choice = bestStrategy.selectCards(challenge, availableCards, game)\n    \n    return {\n      ...choice,\n      reason: `${bestStrategy.getName()}ã«ã‚ˆã‚‹åˆ¤æ–­: ${choice.reason}`\n    }\n  }\n\n  evaluateFitness(game: Game): number {\n    // ä»–ã®æˆ¦ç•¥ã®ä¸­ã§æœ€ã‚‚é©ç”¨åº¦ã®é«˜ã„ã‚‚ã®ã‚’æ¡ç”¨\n    return Math.max(...this.strategies.map(strategy => strategy.evaluateFitness(game)))\n  }\n\n  private selectBestStrategy(game: Game): AIStrategy {\n    // å„æˆ¦ç•¥ã®é©ç”¨åº¦ã‚’è©•ä¾¡ã—ã€æœ€ã‚‚é©ã—ãŸã‚‚ã®ã‚’é¸æŠ\n    const strategyScores = this.strategies.map(strategy => ({\n      strategy,\n      fitness: strategy.evaluateFitness(game)\n    }))\n\n    return strategyScores\n      .sort((a, b) => b.fitness - a.fitness)[0]\n      .strategy\n  }\n}\n\n/**\n * AIæˆ¦ç•¥ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼\n */\nexport class AIStrategyFactory {\n  private static readonly strategies = new Map<AIStrategyType, () => AIStrategy>([\n    ['conservative', () => new ConservativeStrategy()],\n    ['aggressive', () => new AggressiveStrategy()],\n    ['balanced', () => new BalancedStrategy()],\n    ['adaptive', () => new AdaptiveStrategy()]\n  ])\n\n  /**\n   * æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã®æˆ¦ç•¥ã‚’ä½œæˆ\n   */\n  static createStrategy(type: AIStrategyType): AIStrategy {\n    const factory = this.strategies.get(type)\n    if (!factory) {\n      throw new Error(`Unknown strategy type: ${type}`)\n    }\n    return factory()\n  }\n\n  /**\n   * åˆ©ç”¨å¯èƒ½ãªæˆ¦ç•¥ã‚¿ã‚¤ãƒ—ã‚’å–å¾—\n   */\n  static getAvailableTypes(): AIStrategyType[] {\n    return Array.from(this.strategies.keys())\n  }\n\n  /**\n   * æˆ¦ç•¥ã®èª¬æ˜ã‚’å–å¾—\n   */\n  static getStrategyDescription(type: AIStrategyType): string {\n    switch (type) {\n      case 'conservative':\n        return 'ãƒªã‚¹ã‚¯ã‚’é¿ã‘ã€å®‰å…¨ãªé¸æŠã‚’å„ªå…ˆã™ã‚‹æˆ¦ç•¥ã€‚æ´»åŠ›ãŒä½ã„æ™‚ã«é©ã—ã¦ã„ã‚‹ã€‚'\n      case 'aggressive':\n        return 'é«˜ãƒªã‚¹ã‚¯é«˜ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†æˆ¦ç•¥ã€‚æ´»åŠ›ã¨æ‰‹æœ­ãŒå……å®Ÿã—ã¦ã„ã‚‹æ™‚ã«åŠ¹æœçš„ã€‚'\n      case 'balanced':\n        return 'ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã™ã‚‹ä¸‡èƒ½æˆ¦ç•¥ã€‚å®‰å®šã—ãŸåˆ¤æ–­ã‚’è¡Œã†ã€‚'\n      case 'adaptive':\n        return 'çŠ¶æ³ã«å¿œã˜ã¦æœ€é©ãªæˆ¦ç•¥ã‚’è‡ªå‹•é¸æŠã™ã‚‹é«˜åº¦ãªæˆ¦ç•¥ã€‚çµŒé¨“è±Šå¯Œãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‘ã‘ã€‚'\n      default:\n        return 'ä¸æ˜ãªæˆ¦ç•¥ã‚¿ã‚¤ãƒ—ã§ã™ã€‚'\n    }\n  }\n}\n\n/**\n * AIæˆ¦ç•¥ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹\n */\nexport class AIStrategyService {\n  private currentStrategy: AIStrategy\n  private statisticsEnabled: boolean = true\n  private decisionHistory: Array<{\n    turn: number\n    strategy: string\n    challengeChoice: ChallengeChoice\n    cardChoice: CardChoice\n    result: 'success' | 'failure'\n  }> = []\n\n  constructor(strategyType: AIStrategyType = 'balanced') {\n    this.currentStrategy = AIStrategyFactory.createStrategy(strategyType)\n  }\n\n  /**\n   * ç¾åœ¨ã®æˆ¦ç•¥ã‚’å–å¾—\n   */\n  getCurrentStrategy(): AIStrategy {\n    return this.currentStrategy\n  }\n\n  /**\n   * æˆ¦ç•¥ã‚’å¤‰æ›´\n   */\n  setStrategy(strategyType: AIStrategyType): void {\n    this.currentStrategy = AIStrategyFactory.createStrategy(strategyType)\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è‡ªå‹•é¸æŠ\n   */\n  autoSelectChallenge(availableChallenges: Card[], game: Game): ChallengeChoice {\n    const choice = this.currentStrategy.selectChallenge(availableChallenges, game)\n    \n    if (this.statisticsEnabled) {\n      console.log(`AIæˆ¦ç•¥ (${this.currentStrategy.getName()}): ${choice.reason}`)\n      console.log(`é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${choice.challenge.name} (æˆåŠŸç¢ºç‡: ${(choice.successProbability * 100).toFixed(1)}%)`)\n    }\n\n    return choice\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•é¸æŠ\n   */\n  autoSelectCards(challenge: Card, availableCards: Card[], game: Game): CardChoice {\n    const choice = this.currentStrategy.selectCards(challenge, availableCards, game)\n    \n    if (this.statisticsEnabled) {\n      console.log(`AIæˆ¦ç•¥ (${this.currentStrategy.getName()}): ${choice.reason}`)\n      console.log(`é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰: ${choice.cards.map(c => c.name).join(', ')} (æœŸå¾…ãƒ‘ãƒ¯ãƒ¼: ${choice.expectedPower})`)\n    }\n\n    return choice\n  }\n\n  /**\n   * æ„æ€æ±ºå®šå±¥æ­´ã‚’è¨˜éŒ²\n   */\n  recordDecision(\n    turn: number,\n    challengeChoice: ChallengeChoice,\n    cardChoice: CardChoice,\n    success: boolean\n  ): void {\n    if (!this.statisticsEnabled) return\n\n    this.decisionHistory.push({\n      turn,\n      strategy: this.currentStrategy.getName(),\n      challengeChoice,\n      cardChoice,\n      result: success ? 'success' : 'failure'\n    })\n\n    // å±¥æ­´ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™\n    if (this.decisionHistory.length > 100) {\n      this.decisionHistory = this.decisionHistory.slice(-100)\n    }\n  }\n\n  /**\n   * çµ±è¨ˆæƒ…å ±ã‚’å–å¾—\n   */\n  getStatistics() {\n    const total = this.decisionHistory.length\n    if (total === 0) {\n      return {\n        totalDecisions: 0,\n        successRate: 0,\n        strategyUsage: new Map<string, number>()\n      }\n    }\n\n    const successes = this.decisionHistory.filter(d => d.result === 'success').length\n    const strategyUsage = new Map<string, number>()\n\n    this.decisionHistory.forEach(decision => {\n      const count = strategyUsage.get(decision.strategy) || 0\n      strategyUsage.set(decision.strategy, count + 1)\n    })\n\n    return {\n      totalDecisions: total,\n      successRate: successes / total,\n      strategyUsage\n    }\n  }\n\n  /**\n   * çµ±è¨ˆåé›†ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ\n   */\n  setStatisticsEnabled(enabled: boolean): void {\n    this.statisticsEnabled = enabled\n  }\n\n  /**\n   * æ„æ€æ±ºå®šå±¥æ­´ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearHistory(): void {\n    this.decisionHistory = []\n  }\n}","import type { GamePhase, GameStage, GameStatus } from '../types/game.types'\nimport type { Card } from '../entities/Card'\n\n/**\n * ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ\n */\nexport interface GameStateChangeEvent {\n  type: 'phase_change' | 'status_change' | 'stage_change' | 'turn_change'\n  previousValue: any\n  newValue: any\n  timestamp: number\n}\n\n/**\n * ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ›´ã®å±¥æ­´ç®¡ç†\n */\nexport interface GameStateHistory {\n  events: GameStateChangeEvent[]\n  maxEvents: number\n}\n\n/**\n * ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ã®å°‚é–€ã‚µãƒ¼ãƒ“ã‚¹\n * \n * Single Responsibility: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç®¡ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã«ç‰¹åŒ–\n * Open/Closed: æ–°ã—ã„çŠ¶æ…‹ã‚¿ã‚¤ãƒ—ã¯æ‹¡å¼µã§å¯¾å¿œ\n */\nexport class GameStateManager {\n  private readonly listeners: Map<string, Array<(event: GameStateChangeEvent) => void>> = new Map()\n  private readonly history: GameStateHistory = {\n    events: [],\n    maxEvents: 50 // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®ã§åˆ¶é™\n  }\n\n  /**\n   * çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²\n   * \n   * @param eventType ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—\n   * @param listener ãƒªã‚¹ãƒŠãƒ¼é–¢æ•°\n   * @returns ãƒªã‚¹ãƒŠãƒ¼è§£é™¤é–¢æ•°\n   */\n  addEventListener(\n    eventType: GameStateChangeEvent['type'],\n    listener: (event: GameStateChangeEvent) => void\n  ): () => void {\n    const existingListeners = this.listeners.get(eventType) || []\n    existingListeners.push(listener)\n    this.listeners.set(eventType, existingListeners)\n\n    // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤é–¢æ•°ã‚’è¿”ã™\n    return () => {\n      const current = this.listeners.get(eventType) || []\n      const index = current.indexOf(listener)\n      if (index > -1) {\n        current.splice(index, 1)\n      }\n    }\n  }\n\n  /**\n   * çŠ¶æ…‹å¤‰æ›´ã‚’é€šçŸ¥ã—ã€å±¥æ­´ã«è¨˜éŒ²\n   * \n   * @param type å¤‰æ›´ã‚¿ã‚¤ãƒ—\n   * @param previousValue ä»¥å‰ã®å€¤\n   * @param newValue æ–°ã—ã„å€¤\n   */\n  notifyStateChange(\n    type: GameStateChangeEvent['type'],\n    previousValue: any,\n    newValue: any\n  ): void {\n    const event: GameStateChangeEvent = {\n      type,\n      previousValue,\n      newValue,\n      timestamp: Date.now()\n    }\n\n    // å±¥æ­´ã«è¿½åŠ \n    this.addToHistory(event)\n\n    // ãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥\n    const listeners = this.listeners.get(type) || []\n    listeners.forEach(listener => {\n      try {\n        listener(event)\n      } catch (error) {\n        // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯æœŸå¾…ã•ã‚Œã‚‹æŒ™å‹•ãªã®ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æŠ‘åˆ¶\n        if (process.env.NODE_ENV !== 'test') {\n          console.error(`GameStateManager: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, error)\n        }\n      }\n    })\n  }\n\n  /**\n   * ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã‚’é€šçŸ¥\n   */\n  notifyPhaseChange(previousPhase: GamePhase, newPhase: GamePhase): void {\n    this.notifyStateChange('phase_change', previousPhase, newPhase)\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚’é€šçŸ¥\n   */\n  notifyStatusChange(previousStatus: GameStatus, newStatus: GameStatus): void {\n    this.notifyStateChange('status_change', previousStatus, newStatus)\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã‚’é€šçŸ¥\n   */\n  notifyStageChange(previousStage: GameStage, newStage: GameStage): void {\n    this.notifyStateChange('stage_change', previousStage, newStage)\n  }\n\n  /**\n   * ã‚¿ãƒ¼ãƒ³å¤‰æ›´ã‚’é€šçŸ¥\n   */\n  notifyTurnChange(previousTurn: number, newTurn: number): void {\n    this.notifyStateChange('turn_change', previousTurn, newTurn)\n  }\n\n  /**\n   * çŠ¶æ…‹å¤‰æ›´å±¥æ­´ã‚’å–å¾—\n   */\n  getHistory(): GameStateHistory {\n    return { ...this.history }\n  }\n\n  /**\n   * ç‰¹å®šã‚¿ã‚¤ãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã®ã¿ã‚’å–å¾—\n   */\n  getHistoryByType(type: GameStateChangeEvent['type']): GameStateChangeEvent[] {\n    return this.history.events.filter(event => event.type === type)\n  }\n\n  /**\n   * å±¥æ­´ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearHistory(): void {\n    this.history.events = []\n  }\n\n  /**\n   * å±¥æ­´ã«è¿½åŠ ï¼ˆä¸Šé™ç®¡ç†ä»˜ãï¼‰\n   */\n  private addToHistory(event: GameStateChangeEvent): void {\n    this.history.events.push(event)\n    \n    // ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã¯å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤\n    if (this.history.events.length > this.history.maxEvents) {\n      this.history.events.shift()\n    }\n  }\n\n  /**\n   * å…¨ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤\n   */\n  removeAllListeners(): void {\n    this.listeners.clear()\n  }\n\n  /**\n   * ç‰¹å®šã‚¿ã‚¤ãƒ—ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤\n   */\n  removeListenersForType(eventType: GameStateChangeEvent['type']): void {\n    this.listeners.delete(eventType)\n  }\n}","import type { Card } from '../entities/Card'\nimport type { ChallengeResult, InsuranceTypeSelectionResult } from '../types/game.types'\nimport type { Game } from '../entities/Game'\n\n/**\n * ã‚²ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœ\n */\nexport interface ActionResult<T = any> {\n  success: boolean\n  data?: T\n  error?: string\n  effects?: GameEffect[]\n}\n\n/**\n * ã‚²ãƒ¼ãƒ åŠ¹æœ\n */\nexport interface GameEffect {\n  type: 'vitality_change' | 'card_draw' | 'insurance_add' | 'stage_advance'\n  description: string\n  value?: number\n  cards?: Card[]\n}\n\n/**\n * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹\n * Template Method Pattern ã‚’ä½¿ç”¨\n */\nexport abstract class BaseActionProcessor<TInput, TOutput> {\n  /**\n   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰\n   */\n  async execute(game: Game, input: TInput): Promise<ActionResult<TOutput>> {\n    try {\n      // å‰å‡¦ç†ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³\n      const validationResult = await this.validate(game, input)\n      if (!validationResult.success) {\n        return validationResult as ActionResult<TOutput>\n      }\n\n      // ãƒ¡ã‚¤ãƒ³å‡¦ç†\n      const result = await this.process(game, input)\n\n      // å¾Œå‡¦ç†\n      await this.postProcess(game, result)\n\n      return result\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : String(error)\n      }\n    }\n  }\n\n  /**\n   * ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰\n   */\n  protected async validate(game: Game, input: TInput): Promise<ActionResult<void>> {\n    return { success: true }\n  }\n\n  /**\n   * ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§å¿…é ˆå®Ÿè£…ï¼‰\n   */\n  protected abstract process(game: Game, input: TInput): Promise<ActionResult<TOutput>>\n\n  /**\n   * å¾Œå‡¦ç†ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰\n   */\n  protected async postProcess(game: Game, result: ActionResult<TOutput>): Promise<void> {\n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•ã‚‚ã—ãªã„\n  }\n}\n\n/**\n * ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼å‡¦ç†\n */\nexport class DrawCardsProcessor extends BaseActionProcessor<number, Card[]> {\n  protected override async validate(game: Game, count: number): Promise<ActionResult<void>> {\n    if (count <= 0) {\n      return { success: false, error: 'ãƒ‰ãƒ­ãƒ¼æšæ•°ã¯1ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' }\n    }\n\n    if (count > 10) {\n      return { success: false, error: 'ãƒ‰ãƒ­ãƒ¼æšæ•°ã¯10æšä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' }\n    }\n\n    return { success: true }\n  }\n\n  protected override async process(game: Game, count: number): Promise<ActionResult<Card[]>> {\n    // CardManagerã‹ã‚‰ç›´æ¥ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼\n    const result = game.cardManager.drawCards(count)\n\n    const effects: GameEffect[] = [{\n      type: 'card_draw',\n      description: `${result.drawnCards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼ã—ã¾ã—ãŸ`,\n      cards: result.drawnCards\n    }]\n\n    // ãƒˆãƒ©ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã®å‡¦ç†\n    if (result.troubleCards && result.troubleCards.length > 0) {\n      for (const trouble of result.troubleCards) {\n        // ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨ (Trouble card penalty is deduction of vitality)\n        // Assuming 'penalty' property exists on Card (or ICard) and is number\n        // If card.penalty is undefined, default to 0\n        const penalty = (trouble as any).penalty || 0 // Cast to any if Card doesn't explicitly expose penalty property yet\n        if (penalty > 0) {\n          try {\n            game.applyDamage(penalty)\n            effects.push({\n              type: 'vitality_change',\n              description: `ãƒˆãƒ©ãƒ–ãƒ«ã€Œ${trouble.name}ã€ç™ºå‹•ï¼ ${penalty}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸`,\n              value: -penalty,\n              cards: [trouble]\n            })\n          } catch (e) {\n            console.error('Failed to apply trouble penalty', e)\n          }\n        } else {\n          effects.push({\n            type: 'vitality_change', // or 'message'\n            description: `ãƒˆãƒ©ãƒ–ãƒ«ã€Œ${trouble.name}ã€ç™ºå‹•ï¼`,\n            cards: [trouble]\n          })\n        }\n      }\n    }\n\n    return {\n      success: true,\n      data: result.drawnCards,\n      effects\n    }\n  }\n}\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹å‡¦ç†\n */\nexport class StartChallengeProcessor extends BaseActionProcessor<Card, void> {\n  protected override async validate(game: Game, challengeCard: Card): Promise<ActionResult<void>> {\n    if (game.phase !== 'draw') {\n      return { success: false, error: 'ãƒ‰ãƒ­ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹ã§ãã¾ã™' }\n    }\n\n    if (challengeCard.type !== 'challenge') {\n      return { success: false, error: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ä»¥å¤–ã¯é¸æŠã§ãã¾ã›ã‚“' }\n    }\n\n    return { success: true }\n  }\n\n  protected override async process(game: Game, challengeCard: Card): Promise<ActionResult<void>> {\n    game.startChallenge(challengeCard)\n\n    return {\n      success: true,\n      effects: [{\n        type: 'stage_advance',\n        description: `ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€Œ${challengeCard.name}ã€ã‚’é–‹å§‹ã—ã¾ã—ãŸ`\n      }]\n    }\n  }\n}\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹å‡¦ç† (v2: é¸æŠè‚¢æç¤º)\n */\nexport class StartChallengePhaseProcessor extends BaseActionProcessor<void, void> {\n  protected override async validate(game: Game, input: void): Promise<ActionResult<void>> {\n    if (game.phase !== 'draw') {\n      return { success: false, error: 'ãƒ‰ãƒ­ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã‚’é–‹å§‹ã§ãã¾ã™' }\n    }\n    return { success: true }\n  }\n\n  protected override async process(game: Game, input: void): Promise<ActionResult<void>> {\n    game.startChallengePhase()\n\n    return {\n      success: true,\n      effects: [{\n        type: 'stage_advance', // Or new type 'phase_change'\n        description: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã‚’é–‹å§‹ã—ã¾ã—ãŸ'\n      }]\n    }\n  }\n}\n\n/**\n * ãƒãƒ£ãƒ¬ãƒ³ã‚¸è§£æ±ºå‡¦ç†\n */\nexport class ResolveChallengeProcessor extends BaseActionProcessor<void, ChallengeResult> {\n  protected override async validate(game: Game, input: void): Promise<ActionResult<void>> {\n    if (!game.currentChallenge) {\n      return { success: false, error: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“' }\n    }\n\n    if (game.selectedCards.length === 0) {\n      return { success: false, error: 'ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“' }\n    }\n\n    return { success: true }\n  }\n\n  protected override async process(game: Game, input: void): Promise<ActionResult<ChallengeResult>> {\n    const result = game.resolveChallenge()\n\n    const effects: GameEffect[] = []\n\n    if (result.success) {\n      effects.push({\n        type: 'vitality_change',\n        description: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æˆåŠŸã—ã¾ã—ãŸ',\n        value: result.vitalityChange\n      })\n    } else {\n      effects.push({\n        type: 'vitality_change',\n        description: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸ',\n        value: result.vitalityChange\n      })\n    }\n\n    return {\n      success: true,\n      data: result,\n      effects\n    }\n  }\n}\n\n/**\n * ä¿é™ºé¸æŠå‡¦ç†\n */\nexport class SelectInsuranceProcessor extends BaseActionProcessor<\n  { insuranceType: string; durationType: 'term' | 'whole_life' },\n  InsuranceTypeSelectionResult\n> {\n  protected override async validate(\n    game: Game,\n    input: { insuranceType: string; durationType: 'term' | 'whole_life' }\n  ): Promise<ActionResult<void>> {\n    if (!input.insuranceType) {\n      return { success: false, error: 'ä¿é™ºç¨®é¡ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' }\n    }\n\n    if (!['term', 'whole_life'].includes(input.durationType)) {\n      return { success: false, error: 'ç„¡åŠ¹ãªä¿é™ºæœŸé–“ã‚¿ã‚¤ãƒ—ã§ã™' }\n    }\n\n    return { success: true }\n  }\n\n  protected override async process(\n    game: Game,\n    input: { insuranceType: string; durationType: 'term' | 'whole_life' }\n  ): Promise<ActionResult<InsuranceTypeSelectionResult>> {\n    const result = game.selectInsuranceType(input.insuranceType, input.durationType)\n\n    return {\n      success: true,\n      data: result,\n      effects: [{\n        type: 'insurance_add',\n        description: `${input.durationType === 'term' ? 'å®šæœŸ' : 'çµ‚èº«'}${input.insuranceType}ä¿é™ºã‚’è¿½åŠ ã—ã¾ã—ãŸ`\n      }]\n    }\n  }\n}\n\n/**\n * ä¿é™ºè³¼å…¥å‡¦ç† (v2)\n */\nexport class BuyInsuranceProcessor extends BaseActionProcessor<Card, void> {\n  protected override async validate(game: Game, card: Card): Promise<ActionResult<void>> {\n    // Phase check might be strict, so relaxing for now OR checking correct phase\n    const validPhases: string[] = ['action', 'insurance_phase', 'insurance']\n    if (!validPhases.includes(game.phase)) {\n      // Just a warning or strict? For now, let's allow \"action\" phase too as per rulebook flow\n    }\n    return { success: true }\n  }\n\n  protected override async process(game: Game, card: Card): Promise<ActionResult<void>> {\n    game.cardManager.buyInsurance(card)\n\n    if (card.cost > 0) {\n      // Use applyDamage (which handles negative \"damage\" as heal, or we need a spend method?)\n      // Game doesn't have spendVitality, but has updateVitality private.\n      // applyDamage accepts positive number as damage.\n      try {\n        game.applyDamage(card.cost)\n      } catch (e) {\n        return { success: false, error: 'Cost payment failed' }\n      }\n    }\n\n    return {\n      success: true,\n      effects: [{\n        type: 'insurance_add',\n        description: `ä¿é™ºã€Œ${card.name}ã€ã‚’è³¼å…¥ã—ã¾ã—ãŸ`,\n        cards: [card]\n      }]\n    }\n  }\n}\n\n/**\n * ã‚«ãƒ¼ãƒ‰é™¤å¤–å‡¦ç† (v2 Deck Compression)\n */\nexport class RemoveCardProcessor extends BaseActionProcessor<Card, void> {\n  protected override async validate(game: Game, card: Card): Promise<ActionResult<void>> {\n    // Only allow if player has taken damage or specific effect?\n    // Rule: \"Save lost vitality 1 point = 1 card removal\"\n    // This validation might be complex, for now trust the UI/Caller\n    return { success: true }\n  }\n\n  protected override async process(game: Game, card: Card): Promise<ActionResult<void>> {\n    game.cardManager.removeCardFromGame(card)\n    return {\n      success: true,\n      effects: [{\n        type: 'card_draw', // Reusing type or add new 'card_remove'\n        description: `ã‚«ãƒ¼ãƒ‰ã€Œ${card.name}ã€ã‚’é™¤å¤–ã—ã¾ã—ãŸ`,\n        cards: [card]\n      }]\n    }\n  }\n}\n\n/**\n * å¤¢ã‚«ãƒ¼ãƒ‰é¸æŠå‡¦ç† (v2)\n */\nexport class SelectDreamProcessor extends BaseActionProcessor<Card, void> {\n  protected override async validate(game: Game, card: Card): Promise<ActionResult<void>> {\n    if (game.phase !== 'dream_selection') {\n      return { success: false, error: 'å¤¢é¸æŠãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã‚ã‚Šã¾ã›ã‚“' }\n    }\n    return { success: true }\n  }\n\n  protected override async process(game: Game, card: Card): Promise<ActionResult<void>> {\n    try {\n      game.selectDream(card)\n      return {\n        success: true,\n        effects: [{\n          type: 'stage_advance',\n          description: `å¤¢ã€Œ${card.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`\n        }]\n      }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : String(e) }\n    }\n  }\n}\n\n/**\n * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ç®¡ç†ã‚¯ãƒ©ã‚¹\n */\nexport class GameActionProcessor {\n  private readonly processors: Map<string, BaseActionProcessor<any, any>> = new Map()\n\n  constructor() {\n    // æ¨™æº–ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’ç™»éŒ²\n    this.registerProcessor('draw_cards', new DrawCardsProcessor())\n    this.registerProcessor('start_challenge', new StartChallengeProcessor())\n    this.registerProcessor('resolve_challenge', new ResolveChallengeProcessor())\n    this.registerProcessor('select_insurance', new SelectInsuranceProcessor())\n    this.registerProcessor('start_challenge_phase', new StartChallengePhaseProcessor())\n    // v2 processors\n    this.registerProcessor('buy_insurance', new BuyInsuranceProcessor())\n    this.registerProcessor('remove_card', new RemoveCardProcessor())\n    this.registerProcessor('select_dream', new SelectDreamProcessor())\n  }\n\n  /**\n   * ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’ç™»éŒ²\n   */\n  registerProcessor<TInput, TOutput>(\n    actionType: string,\n    processor: BaseActionProcessor<TInput, TOutput>\n  ): void {\n    this.processors.set(actionType, processor)\n  }\n\n  /**\n   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ\n   */\n  async executeAction<TInput, TOutput>(\n    actionType: string,\n    game: Game,\n    input: TInput\n  ): Promise<ActionResult<TOutput>> {\n    console.log('[GameActionProcessor] executeAction called', actionType)\n    const processor = this.processors.get(actionType)\n\n    if (!processor) {\n      console.error('[GameActionProcessor] Unknown action type:', actionType)\n      return {\n        success: false,\n        error: `æœªçŸ¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—: ${actionType}`\n      }\n    }\n\n    const result = await processor.execute(game, input)\n    console.log('[GameActionProcessor] execution result:', result)\n    return result\n  }\n\n  /**\n   * ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ä¸€è¦§ã‚’å–å¾—\n   */\n  getAvailableActions(): string[] {\n    return Array.from(this.processors.keys())\n  }\n\n  /**\n   * ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’å‰Šé™¤\n   */\n  unregisterProcessor(actionType: string): boolean {\n    return this.processors.delete(actionType)\n  }\n}","/**\n * æ´»åŠ›ã‚’è¡¨ã™å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n * \n * ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ã‚ã‚Šã€ã™ã¹ã¦ã®æ“ä½œã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚\n * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼š\n * - æ´»åŠ›ã¯0ä»¥ä¸Š100ä»¥ä¸‹ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„\n */\nexport class Vitality {\n  private static readonly DEFAULT_MAX_VITALITY = 100\n\n  private constructor(\n    private readonly value: number,\n    private readonly maxVitality: number = Vitality.DEFAULT_MAX_VITALITY\n  ) {\n    this.validate()\n  }\n\n  /**\n   * Vitality ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹\n   * @param value æ´»åŠ›å€¤\n   * @param maxVitality æœ€å¤§æ´»åŠ›å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100ï¼‰\n   * @throws {Error} ä¸æ­£ãªå€¤ã®å ´åˆ\n   */\n  static create(value: number, maxVitality: number = Vitality.DEFAULT_MAX_VITALITY): Vitality {\n    return new Vitality(value, maxVitality)\n  }\n\n  /**\n   * å€¤ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼ã™ã‚‹\n   * @private\n   */\n  private validate(): void {\n    // å‹ãƒã‚§ãƒƒã‚¯\n    if (!isFinite(this.value)) {\n      throw new Error('Vitality value must be a finite number')\n    }\n    if (!isFinite(this.maxVitality)) {\n      throw new Error('Maximum vitality must be a finite number')\n    }\n    \n    if (this.maxVitality <= 0) {\n      throw new Error('Maximum vitality must be positive')\n    }\n    if (this.value < 0) {\n      throw new Error('Vitality value cannot be negative')\n    }\n    if (this.value > this.maxVitality) {\n      throw new Error(`Vitality value cannot exceed maximum (${this.maxVitality})`)\n    }\n  }\n\n  /**\n   * ç¾åœ¨ã®æ´»åŠ›å€¤ã‚’å–å¾—\n   */\n  getValue(): number {\n    return this.value\n  }\n\n  /**\n   * æœ€å¤§æ´»åŠ›å€¤ã‚’å–å¾—\n   */\n  getMax(): number {\n    return this.maxVitality\n  }\n\n  /**\n   * æ´»åŠ›ã‚’æ¸›å°‘ã•ã›ã‚‹\n   * @param amount æ¸›å°‘é‡\n   * @returns æ–°ã—ã„Vitalityã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @throws {Error} æ¸›å°‘é‡ãŒè² ã®å ´åˆã¾ãŸã¯ç„¡åŠ¹ãªå€¤ã®å ´åˆ\n   */\n  decrease(amount: number): Vitality {\n    if (typeof amount !== 'number' || !isFinite(amount)) {\n      throw new Error('Decrease amount must be a finite number')\n    }\n    if (amount < 0) {\n      throw new Error('Decrease amount must be non-negative')\n    }\n    return new Vitality(Math.max(0, this.value - amount), this.maxVitality)\n  }\n\n  /**\n   * æ´»åŠ›ã‚’å¢—åŠ ã•ã›ã‚‹\n   * @param amount å¢—åŠ é‡\n   * @returns æ–°ã—ã„Vitalityã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   * @throws {Error} å¢—åŠ é‡ãŒè² ã®å ´åˆã¾ãŸã¯ç„¡åŠ¹ãªå€¤ã®å ´åˆ\n   */\n  increase(amount: number): Vitality {\n    if (typeof amount !== 'number' || !isFinite(amount)) {\n      throw new Error('Increase amount must be a finite number')\n    }\n    if (amount < 0) {\n      throw new Error('Increase amount must be non-negative')\n    }\n    return new Vitality(Math.min(this.maxVitality, this.value + amount), this.maxVitality)\n  }\n\n  /**\n   * ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆ0-100ï¼‰\n   */\n  getPercentage(): number {\n    return Math.floor((this.value / this.maxVitality) * 100)\n  }\n\n  /**\n   * æ´»åŠ›ãŒæ¯æ¸‡ã—ã¦ã„ã‚‹ã‹åˆ¤å®š\n   */\n  isDepleted(): boolean {\n    return this.value === 0\n  }\n\n  /**\n   * æ´»åŠ›ãŒæº€ã‚¿ãƒ³ã‹åˆ¤å®š\n   */\n  isFull(): boolean {\n    return this.value === this.maxVitality\n  }\n\n  /**\n   * æœ€å¤§æ´»åŠ›å€¤ã‚’å¤‰æ›´ã—ãŸVitalityã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ\n   * ç¾åœ¨ã®æ´»åŠ›å€¤ãŒæ–°ã—ã„æœ€å¤§å€¤ã‚’è¶…ãˆã‚‹å ´åˆã¯æœ€å¤§å€¤ã«èª¿æ•´\n   * @param newMaxVitality æ–°ã—ã„æœ€å¤§æ´»åŠ›å€¤\n   * @returns æ–°ã—ã„Vitalityã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹\n   */\n  withMaxVitality(newMaxVitality: number): Vitality {\n    if (typeof newMaxVitality !== 'number' || !isFinite(newMaxVitality)) {\n      throw new Error('Maximum vitality must be a finite number')\n    }\n    const adjustedValue = Math.min(this.value, newMaxVitality)\n    return new Vitality(adjustedValue, newMaxVitality)\n  }\n\n  /**\n   * ä»–ã®Vitalityã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ç­‰ä¾¡ã‹åˆ¤å®š\n   */\n  equals(other: Vitality): boolean {\n    return this.value === other.value && this.maxVitality === other.maxVitality\n  }\n\n  /**\n   * æ–‡å­—åˆ—è¡¨ç¾ã‚’å–å¾—\n   */\n  toString(): string {\n    return `${this.value}/${this.maxVitality} (${this.getPercentage()}%)`\n  }\n}","import type { Card } from './Card'\nimport { Deck } from './Deck'\nimport { CardFactory } from '../services/CardFactory'\nimport { CardManager, type ICardManager } from '../services/CardManager'\nimport { InsurancePremiumCalculationService } from '../services/InsurancePremiumCalculationService'\nimport { GameStageManager } from '../services/GameStageManager'\nimport { InsuranceExpirationManager } from '../services/InsuranceExpirationManager'\nimport { ChallengeResolutionService } from '../services/ChallengeResolutionService'\nimport { GameTurnManager } from '../services/GameTurnManager'\nimport { GameChallengeService } from '../services/GameChallengeService'\nimport { GameInsuranceService } from '../services/GameInsuranceService'\nimport { AIStrategyService, type AIStrategyType } from '../services/AIStrategyService'\nimport { GameStateManager } from '../services/GameStateManager'\nimport { GameActionProcessor } from '../services/GameActionProcessor'\nimport { IdGenerator } from '../../common/IdGenerator'\nimport type {\n  ChallengeResult,\n  GameConfig,\n  GamePhase,\n  GameStatus,\n  IGameState,\n  InsuranceTypeChoice,\n  InsuranceTypeSelectionResult,\n  PlayerStats,\n  TurnResult,\n  PendingInsuranceClaim\n} from '../types/game.types'\nimport {\n  AVAILABLE_CHARACTERS,\n  DREAM_AGE_ADJUSTMENTS\n} from '../types/game.types'\nimport type { GameStage, InsuranceTriggerType } from '../types/card.types'\nimport { Vitality } from '../valueObjects/Vitality'\nimport { InsurancePremium } from '../valueObjects/InsurancePremium'\nimport { RiskProfile } from '../valueObjects/RiskProfile'\nimport type { PlayerHistory } from '../services/InsurancePremiumCalculationService'\nimport { GameConstantsAccessor } from '../constants/GameConstants'\n\n/**\n * ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - ã‚²ãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ…‹ã¨é€²è¡Œã‚’ç®¡ç†ã™ã‚‹ä¸­æ ¸ã‚¯ãƒ©ã‚¹\n * \n * ã“ã®ã‚¯ãƒ©ã‚¹ã¯å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ï¼š\n * - vitality: Vitalityå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ´»åŠ›ï¼‰\n * - insuranceBurden: InsurancePremiumå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ï¼ˆä¿é™ºæ–™è² æ‹…ï¼‰\n * \n * @implements {IGameState} ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\n * \n * @example\n * // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–\n * const config = { startingVitality: 20, maxHandSize: 7 };\n * const game = new Game(config);\n * game.start();\n * \n * // ã‚¿ãƒ¼ãƒ³ã®é€²è¡Œ\n * game.drawCards(5);\n * const challenge = game.challengeDeck.drawCard();\n * game.startChallenge(challenge);\n */\nexport class Game implements IGameState {\n  id: string\n  status: GameStatus\n  phase: GamePhase\n  stage: GameStage\n  turn: number\n  private _vitality: Vitality\n\n  // ã‚«ãƒ¼ãƒ‰ç®¡ç†ã‚’ç§»è­²\n  public cardManager: ICardManager\n\n  // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹\n  private readonly premiumCalculationService: InsurancePremiumCalculationService\n  private readonly stageManager: GameStageManager\n  private readonly expirationManager: InsuranceExpirationManager\n  private readonly challengeResolutionService: ChallengeResolutionService\n  private readonly turnManager: GameTurnManager\n  private readonly challengeService: GameChallengeService\n  private readonly insuranceService: GameInsuranceService\n  private readonly aiStrategyService: AIStrategyService\n\n  // æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£\n  private readonly stateManager: GameStateManager\n  private readonly actionProcessor: GameActionProcessor\n\n  currentChallenge: Card | undefined = undefined\n\n  stats: PlayerStats\n  config: GameConfig\n\n  // Phase 5: ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´\n  private readonly _riskProfile: RiskProfile\n  private readonly _playerHistory: PlayerHistory\n\n  // Phase 2-4:  // ä¿é™ºé–¢é€£\n  activeInsurances: Card[] = []\n  expiredInsurances: Card[] = []\n  private readonly _insuranceBurden: InsurancePremium\n\n  // v2: æ–°è¦ç´ \n  agingDeck: Deck\n  score: number = 0\n  insuranceMarket: Card[] = []\n  selectedDream: Card | undefined = undefined\n\n  // é¸æŠè‚¢\n  insuranceTypeChoices: InsuranceTypeChoice[] | undefined = undefined\n  pendingInsuranceClaim: PendingInsuranceClaim | undefined = undefined\n\n  // çµŒé¨“å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ï¼ˆGAME_DESIGN.mdã‚ˆã‚Šï¼‰\n  private readonly _learningHistory: Map<string, number> = new Map() // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å -> å¤±æ•—å›æ•°\n\n  /**\n   * å­¦ç¿’å±¥æ­´ã‚’å–å¾—\n   */\n  getLearningHistory(challengeName: string): number {\n    return this._learningHistory.get(challengeName) || 0\n  }\n\n  /**\n   * å­¦ç¿’å±¥æ­´ã‚’æ›´æ–°\n   */\n  updateLearningHistory(challengeName: string, failures: number): void {\n    this._learningHistory.set(challengeName, failures)\n  }\n\n  // AIæˆ¦ç•¥è¨­å®š\n  private _aiEnabled: boolean = false\n  private _currentAIStrategy: AIStrategyType = 'balanced'\n\n  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«\n  private static readonly OBJECT_POOLS = {\n    cards: [] as Card[],\n    gameStates: [] as Partial<IGameState>[],\n    challengeResults: [] as Partial<ChallengeResult>[]\n  }\n\n  // ãƒ€ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥\n  private readonly _dirtyFlags = {\n    vitality: false,\n    insurance: false,\n    burden: false,\n    stats: false,\n    gameState: false\n  }\n\n  // é›£æ˜“åº¦èª¿æ•´ç”¨ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ï¼ˆå¤¢ã‚’è«¦ã‚ãŸå ´åˆãªã©ã«ä¸Šæ˜‡ï¼‰\n  challengeDifficultyModifier: number = 0\n\n  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ \n  private readonly _cachedValues = {\n    insuranceBurden: 0,\n    availableVitality: 0,\n    totalInsuranceCount: 0,\n    lastUpdateTime: 0\n  }\n\n  startedAt?: Date\n  completedAt?: Date\n\n  /**\n   * Gameã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ\n   * @param {GameConfig} [config] - ã‚²ãƒ¼ãƒ è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n   * @param {string} [config.difficulty='normal'] - é›£æ˜“åº¦\n   * @param {number} [config.startingVitality=100] - åˆæœŸæ´»åŠ›\n   * @param {number} [config.startingHandSize=5] - åˆæœŸæ‰‹æœ­æšæ•°\n   * @param {number} [config.maxHandSize=10] - æœ€å¤§æ‰‹æœ­æšæ•°\n   * @param {number} [config.dreamCardCount=3] - å¤¢ã‚«ãƒ¼ãƒ‰æšæ•°\n   */\n  constructor(config?: GameConfig) {\n    this.id = this.generateId()\n    this.status = 'not_started'\n    this.phase = 'setup'\n    this.stage = 'youth'\n    this.turn = 0\n\n    // Config must be set before initializing CardManager or Vitality\n    const defaults: GameConfig = {\n      difficulty: 'normal',\n      startingVitality: 100,\n      startingHandSize: 5,\n      maxHandSize: 10,\n      dreamCardCount: 3\n    }\n    const resolvedConfig: GameConfig = { ...defaults, ...config }\n\n    // console.log('[Game] Constructor Config:', JSON.stringify(resolvedConfig)) // DEBUG\n\n    this.config = resolvedConfig\n\n    // Apply balance overrides if provided\n    if (this.config.balanceConfig) {\n      // console.log('[Game] Applying Balance Overrides:', JSON.stringify(this.config.balanceConfig)) // DEBUG\n      GameConstantsAccessor.setOverrides(this.config.balanceConfig)\n    }\n\n    // å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§åˆæœŸåŒ–ï¼ˆå¹´é½¢åˆ¥æœ€å¤§æ´»åŠ›ã‚’é©ç”¨ï¼‰\n    // NOTE: Overrideé©ç”¨å¾Œã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹\n    // Phase 4: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é©ç”¨\n    const characterId = resolvedConfig.characterId || 'solid' // Default to Solid\n    const character = AVAILABLE_CHARACTERS.find(c => c.id === characterId) || AVAILABLE_CHARACTERS[0]\n\n    if (!character) {\n      // Should not happen as we fallback to [0], but for TS safety\n      throw new Error('No available characters found')\n    }\n\n    // console.log(`[Game] Selected Character: ${character.name}`)\n\n    const basePower = (resolvedConfig.startingVitality !== undefined) ? resolvedConfig.startingVitality : 100\n    const startingVitality = basePower + character.initialVitalityModifier\n\n    // Hardcore fix: If difficulty is hardcore and base is default (100), force it to 20? No, that's hidden logic.\n    // Better to fix the caller.\n\n    const ageParams = GameConstantsAccessor.getStageParameters(this.stage)\n    if (!ageParams) throw new Error(`Invalid stage parameters for ${this.stage}`)\n\n    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è£œæ­£ã‚’å«ã‚ãŸæœ€å¤§æ´»åŠ›\n    const baseMaxVitality = ageParams.maxVitality + character.initialVitalityModifier\n    const maxVitality = baseMaxVitality\n\n    const cheatThreshold = 200\n    const actualStartingVitality = (startingVitality > maxVitality && startingVitality > cheatThreshold)\n      ? startingVitality\n      : Math.min(startingVitality, maxVitality)\n\n    const actualMaxVitality = Math.max(actualStartingVitality, maxVitality)\n\n    this._vitality = Vitality.create(actualStartingVitality, actualMaxVitality)\n\n\n\n    // CardManagerã‚’åˆæœŸåŒ–\n    this.cardManager = new CardManager()\n\n    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–\n    this.premiumCalculationService = new InsurancePremiumCalculationService()\n    this.stageManager = new GameStageManager()\n    this.expirationManager = new InsuranceExpirationManager()\n    this.challengeResolutionService = new ChallengeResolutionService()\n    this.turnManager = new GameTurnManager(this.stageManager, this.expirationManager)\n    this.challengeService = new GameChallengeService(this.challengeResolutionService)\n    this.insuranceService = new GameInsuranceService(this.premiumCalculationService)\n    this.aiStrategyService = new AIStrategyService(this._currentAIStrategy)\n\n    // æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’åˆæœŸåŒ–\n    this.stateManager = new GameStateManager()\n    this.actionProcessor = new GameActionProcessor()\n\n    // Apply balance overrides if provided\n    if (this.config.balanceConfig) {\n      GameConstantsAccessor.setOverrides(this.config.balanceConfig)\n    } else {\n      GameConstantsAccessor.clearOverrides()\n    }\n    // ...\n\n\n\n    // çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–ã‚’è¨­å®š\n    this.setupStateListeners()\n    const playerDeck = new Deck('Player Deck')\n    const challengeDeck = new Deck('Challenge Deck')\n\n    // åˆæœŸãƒ‡ãƒƒã‚­ã‚’ä½œæˆ\n    const initialCards = CardFactory.createStarterLifeCards()\n    initialCards.forEach(card => { playerDeck.addCard(card); })\n\n    // Verify and Sanitize Player Deck (Fix for Dream Leak)\n    const dreamLeak = playerDeck.getCards().filter(c => c.type === 'dream' || (c.type === 'challenge' && (c as any).isDream) || (c.type === 'life' && c.power >= 30))\n    if (dreamLeak.length > 0) {\n      console.warn('[Game] WARNING: Dream cards detected in initial player deck! Removing...', dreamLeak.map(c => c.name))\n      dreamLeak.forEach(c => playerDeck.removeCard(c.id))\n    }\n\n    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‡ãƒƒã‚­ã‚’ä½œæˆ\n    const challengeCards = CardFactory.createChallengeCards(this.stage)\n    challengeCards.forEach(card => { challengeDeck.addCard(card); })\n\n    // Initialize CardManager with config already set\n    this.cardManager.initialize(playerDeck, challengeDeck, this.config)\n\n    this.stats = {\n      totalChallenges: 0,\n      successfulChallenges: 0,\n      failedChallenges: 0,\n      cardsAcquired: 0,\n      highestVitality: actualStartingVitality,\n      turnsPlayed: 0\n    }\n\n    // Phase 5: ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨å±¥æ­´ã®åˆæœŸåŒ–\n    this._riskProfile = RiskProfile.default()\n    this._playerHistory = {\n      turnsPlayed: 0,\n      totalDamageTaken: 0,\n      insuranceClaimCount: 0,\n      totalInsurancePurchased: 0,\n      riskyChoiceCount: 0,\n      totalChoiceCount: 0\n    }\n\n    // Phase 2-4: ä¿é™ºã‚«ãƒ¼ãƒ‰ç®¡ç†ã®åˆæœŸåŒ–\n    this.activeInsurances = []\n    this.expiredInsurances = []\n    this.insuranceMarket = []\n\n    // v2: åˆæœŸåŒ–\n    this.agingDeck = new Deck('Aging Deck')\n    const agingCards = CardFactory.createAgingCards(20)\n    this.cardManager.getState().agingDeck.addCards(agingCards)\n    this.cardManager.getState().agingDeck.shuffle()\n\n    this.score = 0\n\n    // Phase 3: ä¿é™ºæ–™è² æ‹…ã®åˆæœŸåŒ–\n    this._insuranceBurden = InsurancePremium.create(0)\n  }\n\n  /**\n   * å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®getter - ç¾åœ¨ã®æ´»åŠ›å€¤ã‚’å–å¾—\n   * @returns {number} ç¾åœ¨ã®æ´»åŠ›å€¤\n   */\n  get vitality(): number {\n    return this._vitality.getValue()\n  }\n\n  /**\n   * æœ€å¤§æ´»åŠ›å€¤ã‚’å–å¾—\n   * @returns {number} æœ€å¤§æ´»åŠ›å€¤\n   */\n  get maxVitality(): number {\n    return this._vitality.getMax()\n  }\n\n  /**\n   * ç¾åœ¨ã®ä¿é™ºæ–™è² æ‹…ã‚’å–å¾—\n   * @returns {number} ä¿é™ºæ–™è² æ‹…é¡\n   */\n  get insuranceBurden(): number {\n    return this._insuranceBurden.getValue()\n  }\n\n  /**\n   * å®Œäº†ã—ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸æ•°ã‚’å–å¾—\n   * @returns {number} å®Œäº†ã—ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸æ•°\n   */\n  get challengesCompleted(): number {\n    return this.stats.challengesCompleted || 0\n  }\n\n  /**\n   * å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã®æ´»åŠ›å–å¾—\n   * @returns {Vitality} æ´»åŠ›å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n   */\n  getVitality(): Vitality {\n    return this._vitality\n  }\n\n  /**\n   * å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã®ä¿é™ºæ–™è² æ‹…å–å¾—\n   * @returns {InsurancePremium} ä¿é™ºæ–™è² æ‹…å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n   */\n  getInsuranceBurden(): InsurancePremium {\n    return this._insuranceBurden\n  }\n\n  /**\n   * ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é©ç”¨ã—ã¦æ´»åŠ›ã‚’æ¸›å°‘ã•ã›ã‚‹\n   * @param {number} damage - é©ç”¨ã™ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸é‡\n   * @throws {Error} ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒè² ã®å€¤ã®å ´åˆ\n   */\n  applyDamage(damage: number): void {\n    // å‹ãƒã‚§ãƒƒã‚¯\n    if (damage === null || damage === undefined) {\n      throw new Error('Change amount must not be null or undefined')\n    }\n    if (typeof damage !== 'number') {\n      throw new Error('Change amount must be a number')\n    }\n    if (!isFinite(damage)) {\n      throw new Error('Change amount must be a finite number')\n    }\n\n    // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ç›´æ¥æ´»åŠ›ã«é©ç”¨\n    this.updateVitality(-damage)\n  }\n\n\n\n  /**\n   * ä½“åŠ›ã‚’å›å¾©ã•ã›ã‚‹\n   * @param {number} amount - å›å¾©é‡\n   * @throws {Error} å›å¾©é‡ãŒè² ã®å€¤ã®å ´åˆ\n   */\n  heal(amount: number): void {\n    if (this.status === 'game_over') {\n      console.warn('[Game] Cannot heal: Game is over')\n      return\n    }\n    // å‹ãƒã‚§ãƒƒã‚¯\n    if (amount === null || amount === undefined) {\n      throw new Error('Change amount must not be null or undefined')\n    }\n    if (typeof amount !== 'number') {\n      throw new Error('Change amount must be a number')\n    }\n    if (!isFinite(amount)) {\n      throw new Error('Change amount must be a finite number')\n    }\n    this.updateVitality(amount)\n  }\n\n  /**\n   * ç¾åœ¨ã®ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—\n   * @returns {RiskProfile} ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«\n   */\n  getRiskProfile(): RiskProfile {\n    return this._riskProfile\n  }\n\n  /**\n   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´ã‚’å–å¾—\n   * @returns {PlayerHistory} ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´\n   */\n  getPlayerHistory(): PlayerHistory {\n    return { ...this._playerHistory }\n  }\n\n  /**\n   * åˆ©ç”¨å¯èƒ½ä½“åŠ›ã‚’å–å¾—ï¼ˆä¿é™ºæ–™è² æ‹…ã‚’è€ƒæ…®ï¼‰\n   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹æœ€é©åŒ–ç‰ˆ\n   * @returns {number} ä¿é™ºæ–™è² æ‹…ã‚’å·®ã—å¼•ã„ãŸå®Ÿè³ªçš„ãªåˆ©ç”¨å¯èƒ½ä½“åŠ›\n   */\n  getAvailableVitality(): number {\n    const currentTime = Date.now()\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªå ´åˆï¼ˆ50msä»¥å†…ï¼‰ã¯è¨ˆç®—ã‚’ã‚¹ã‚­ãƒƒãƒ—\n    if (!this._dirtyFlags.vitality && !this._dirtyFlags.burden &&\n      currentTime - this._cachedValues.lastUpdateTime < 50) {\n      return this._cachedValues.availableVitality\n    }\n\n    const result = this.vitality - this.insuranceBurden\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°\n    this._cachedValues.availableVitality = result\n    this._cachedValues.lastUpdateTime = currentTime\n    this._dirtyFlags.vitality = false\n    this._dirtyFlags.burden = false\n\n    return result\n  }\n\n  /**\n   * è‡ªç”±åº¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®— (0.0 to 1.0)\n   * ä¿é™ºæ–™è² æ‹…ãŒä½ã„ã»ã©é«˜ããªã‚‹\n   */\n  getFreedomScore(): number {\n    const burden = this.insuranceBurden\n    // è² æ‹…ãŒ0ãªã‚‰1.0 (å®Œå…¨è‡ªç”±)\n    // è² æ‹…ãŒæœ€å¤§æ´»åŠ›ã®20%ä»¥ä¸Šãªã‚‰0.0 (ä¸è‡ªç”±)\n    const maxBurden = this.maxVitality * 0.2\n    if (burden === 0) return 1.0\n\n    const freedom = 1.0 - (burden / maxBurden)\n    return Math.max(0, Math.min(1.0, freedom))\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‹ã©ã†ã‹åˆ¤å®š\n   * ä»¥ä¸‹ã®æ¡ä»¶ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¨ãªã‚‹:\n   * 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ 'game_over'\n   * 2. æ´»åŠ›ãŒ0ä»¥ä¸‹\n   * 3. æ‰‹æœ­ã«è€åŒ–ã‚«ãƒ¼ãƒ‰ãŒ3æšä»¥ä¸Šï¼ˆæ–°ãƒ«ãƒ¼ãƒ«ï¼‰\n   * @returns {boolean} ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆtrue\n   */\n  isGameOver(): boolean {\n    return this.status === 'game_over' ||\n      this._vitality.isDepleted() ||\n      this.hasAgingCardGameOver()\n  }\n\n  /**\n   * è€åŒ–ã‚«ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯\n   * æ‰‹æœ­ã«è€åŒ–ã‚«ãƒ¼ãƒ‰ãŒ3æšä»¥ä¸Šã‚ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼\n   * @returns {boolean} è€åŒ–ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆtrue\n   */\n  hasAgingCardGameOver(): boolean {\n    return this.hand.filter(c => c.type === 'aging').length >= 3\n  }\n\n\n\n  /**\n   * è€åŒ–ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ä¿é™ºãŒã‚ã‚Œã°ç™ºå‹•\n   * @returns {boolean} æ¡ä»¶ã«è©²å½“ã—ãŸå ´åˆtrue (ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ã¾ãŸã¯ ä¿é™ºç™ºå‹•)\n   */\n  checkAgingCardGameOverCondition(): boolean {\n    if (this.hasAgingCardGameOver()) {\n      console.log('[Game] Aging Card Game Over Condition Met!')\n\n      // éšœå®³ä¿é™ºãƒã‚§ãƒƒã‚¯\n      const insurance = this.activeInsurances.find(c =>\n        c.insuranceTriggerType === 'on_aging_gameover'\n      )\n\n      if (insurance) {\n        console.log('[Game] Disability Insurance found! Triggering claim.')\n        this.triggerInsuranceClaim(insurance, 'on_aging_gameover')\n        // ä¿é™ºç™ºå‹•å¾…ã¡çŠ¶æ…‹ã«ãªã‚‹ãŸã‚ã€ã“ã“ã§ã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ã—ãªã„\n        // ãŸã ã—ã€ã‚‚ã—ä¿é™ºã‚’æ‹’å¦ã™ã‚Œã°ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã‚‹å¿…è¦ãŒã‚ã‚‹\n        // declineInsuranceClaimå†…ã§å†åº¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ã€\n        // ä¿é™ºæ‹’å¦æ™‚ã¯å³åº§ã«ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦\n        return true\n      }\n\n      console.log('[Game] No insurance found. Game Over.')\n      this.changeStatus('game_over')\n      return true\n    }\n    return false\n  }\n\n  /**\n   * æ‰‹æœ­ã®è€åŒ–ã‚«ãƒ¼ãƒ‰æ•°ã‚’å–å¾—\n   * @returns {number} è€åŒ–ã‚«ãƒ¼ãƒ‰ã®æšæ•°\n   */\n  getAgingCardCount(): number {\n    return this.hand.filter(card => card.type === 'aging').length\n  }\n\n  /**\n   * ä¿é™ºã‚’è¿½åŠ ï¼ˆç°¡æ˜“ç‰ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰\n   * @param {Card} card - è¿½åŠ ã™ã‚‹ä¿é™ºã‚«ãƒ¼ãƒ‰\n   * @throws {Error} ä¿é™ºã‚«ãƒ¼ãƒ‰ä»¥å¤–ãŒæ¸¡ã•ã‚ŒãŸå ´åˆ\n   */\n  addInsurance(card: Card): void {\n    this.insuranceService.addInsurance(this, card)\n  }\n\n  /**\n   * å…¨ã¦ã®ä¿é™ºã‚’å¼·åˆ¶å¤±åŠ¹ã•ã›ã‚‹\n   * æ´»åŠ›ä¸è¶³ãªã©ã§ä¿é™ºæ–™ãŒæ”¯æ‰•ãˆãªã„å ´åˆã«ä½¿ç”¨\n   */\n  expireAllInsurances(): void {\n    if (this.activeInsurances.length === 0) return\n\n    // é…åˆ—ã‚’å±•é–‹ã—ã¦è¿½åŠ ï¼ˆpushãŒä½¿ãˆã‚‹ã“ã¨ã‚’å‰æï¼‰\n    this.activeInsurances.forEach(card => this.expiredInsurances.push(card))\n    this.activeInsurances = []\n\n    // è² æ‹…é¡ã‚’æ›´æ–°\n    this.updateInsuranceBurden()\n\n    console.log('[Game] All insurances expired due to insufficient vitality')\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ IDã‚’ç”Ÿæˆ\n   * @returns {string} ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚²ãƒ¼ãƒ ID\n   * @private\n   */\n  private generateId(): string {\n    return IdGenerator.generateGameId()\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹\n   * @throws {Error} æ—¢ã«ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆ\n   */\n  start(): void {\n    if (this.status !== 'not_started') {\n      throw new Error('Game has already started')\n    }\n\n    this.changeStatus('in_progress')\n    this.startedAt = new Date()\n\n    // v2: Start with Character Selection\n    // this.startDreamSelectionPhase() -> moved to after character selection\n    this.changePhase('character_selection')\n    console.info('[Game Phase] Character Selection Started')\n  }\n\n  /**\n   * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ\n   */\n  selectCharacter(characterId: string): void {\n    if (this.phase !== 'character_selection') throw new Error('Not in character selection phase')\n\n    const character = AVAILABLE_CHARACTERS.find(c => c.id === characterId)\n    if (!character) throw new Error('Invalid character selection')\n\n    this.config.characterId = characterId\n\n    // Re-apply modifiers logic\n    const ageParams = GameConstantsAccessor.getStageParameters(this.stage)\n    const baseStarting = this.config.startingVitality\n    const startVal = baseStarting + character.initialVitalityModifier\n    const maxVal = ageParams.maxVitality + character.initialVitalityModifier\n\n    const actualMax = Math.max(startVal, maxVal)\n    this._vitality = Vitality.create(Math.min(startVal, actualMax), actualMax)\n\n    console.log(`[Game] Character switched to ${character.name}. Vitality: ${this.vitality}/${this.maxVitality}`)\n\n    // Proceed to Dream Selection\n    this.startDreamSelectionPhase()\n  }\n\n  /**\n   * å¤¢é¸æŠãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹\n   */\n  startDreamSelectionPhase(): void {\n    const dreams = CardFactory.createDreamCards()\n    // random 3\n    const shuffled = dreams.sort(() => Math.random() - 0.5).slice(0, 3)\n\n    this.cardManager.setCardChoices(shuffled)\n    this.changePhase('dream_selection')\n    console.info('[Game Phase] Dream Selection Started')\n  }\n\n  /**\n   * å¤¢ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ\n   */\n  async selectDream(card: Card): Promise<void> {\n    if (this.phase !== 'dream_selection') throw new Error('Not in dream selection phase')\n\n    const choices = this.cardManager.getState().cardChoices\n    if (!choices?.some(c => c.id === card.id)) throw new Error('Invalid dream selection')\n\n    this.selectedDream = card\n    console.info(`[Game Event] Selected Dream: ${card.name}`)\n\n    this.cardManager.clearCardChoices()\n\n    // Start actual game loop\n    this.changePhase('draw')\n    this.changeTurn(1)\n\n    // Initial Draw - NOT performed here\n    // v2: èª²é¡Œé¸æŠå¾Œã«ãƒ‰ãƒ­ãƒ¼ã™ã‚‹ä»•æ§˜ï¼ˆãƒ‰ã‚­ãƒ‰ã‚­æ„Ÿã®ãŸã‚ï¼‰\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼ã™ã‚‹ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç‰ˆï¼‰\n   * @param {number} count - ãƒ‰ãƒ­ãƒ¼ã™ã‚‹æšæ•°\n   * @returns {Promise<Card[]>} ãƒ‰ãƒ­ãƒ¼ã—ãŸã‚«ãƒ¼ãƒ‰ã®é…åˆ—\n   */\n  async drawCards(count: number): Promise<Card[]> {\n    console.debug('[Game] drawCards called', count)\n    const result = await this.actionProcessor.executeAction<number, Card[]>('draw_cards', this, count)\n    console.debug('[Game] actionProcessor result:', result)\n\n    if (!result.success) {\n      console.error('[Game] drawCards failed:', result.error)\n      throw new Error(result.error || 'ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ')\n    }\n\n    // è€åŒ–ã‚«ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯\n    this.checkAgingCardGameOverCondition()\n\n    return result.data || []\n  }\n\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã™ã‚‹ (v2)\n   * 2æšå¼•ã„ã¦é¸æŠè‚¢ã‚’æç¤ºã™ã‚‹\n   */\n  startChallengePhase(): void {\n    // Phase check\n    if (this.phase !== 'draw') {\n      // Allow re-roll or other special cases? For now strict.\n      throw new Error(`Can only start challenge phase from draw phase. Current phase: ${this.phase}`)\n    }\n\n    const choices: Card[] = []\n\n    // 2æšå¼•ã - refill if needed\n    let card1 = this.cardManager.drawChallengeCard()\n    if (!card1) {\n      this.refillChallengeDeck()\n      card1 = this.cardManager.drawChallengeCard()\n    }\n    if (card1) choices.push(card1)\n\n    let card2 = this.cardManager.drawChallengeCard()\n    if (!card2) {\n      // Should rely on Deck implementation but refilling if 1st was null likely refilled enough\n      // If deck was size 1, maybe need refill again?\n      if (this.challengeDeck.getCards().length === 0) { // Check deck size\n        this.refillChallengeDeck()\n      }\n      card2 = this.cardManager.drawChallengeCard()\n    }\n    if (card2) choices.push(card2)\n\n    if (choices.length === 0) {\n      throw new Error('No challenge cards available')\n    }\n\n    // é›£æ˜“åº¦è£œæ­£ã‚’é©ç”¨\n    const modifiedChoices = choices.map(card => {\n      // å¤¢ã‚«ãƒ¼ãƒ‰è‡ªä½“ã«ã¯é©ç”¨ã—ãªã„ï¼Ÿ -> å¤¢ã‚«ãƒ¼ãƒ‰ã‚‚é›£ã—ããªã£ã¦ã„ãã®ãŒã€Œäººç”Ÿã®ãƒãƒ¼ãƒ‰ãƒ«ã€ã£ã½ã„ã€‚\n      // å…¨ã¦ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«é©ç”¨ã€‚\n      if (this.challengeDifficultyModifier > 0 && card.isChallengeCard()) {\n        console.log(`[Game] Applying difficulty modifier +${this.challengeDifficultyModifier} to ${card.name}`)\n        return card.copy({\n          power: card.power + this.challengeDifficultyModifier\n        })\n      }\n      return card\n    })\n\n    this.cardManager.setCardChoices(modifiedChoices)\n    this.changePhase('challenge_choice')\n    console.debug(`[Game] Challenge choices set: ${modifiedChoices.map(c => c.name).join(', ')}`)\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹ã™ã‚‹\n   * @param {Card} challengeCard - æŒ‘æˆ¦ã™ã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰\n   * @throws {Error} é©åˆ‡ãªãƒ•ã‚§ãƒ¼ã‚ºä»¥å¤–ã§å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ\n   */\n  startChallenge(challengeCard: Card): void {\n    // v2: If in challenge_choice phase, validate selection\n    if (this.phase === 'challenge_choice') {\n      const choices = this.cardManager.getState().cardChoices\n      if (!choices || !choices.some(c => c.id === challengeCard.id)) {\n        throw new Error('Selected card is not in current choices')\n      }\n\n      // é¸æŠã•ã‚Œãªã‹ã£ãŸã‚«ãƒ¼ãƒ‰ã®å‡¦ç†\n      choices.forEach(c => {\n        if (c.id !== challengeCard.id) {\n          // å¤¢ã‚«ãƒ¼ãƒ‰ã‚’é¸ã°ãªã‹ã£ãŸå ´åˆã®ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆæŒ«æŠ˜ï¼‰\n          if (c.isDreamCard()) {\n            console.log(`[Game] Dream ignored: ${c.name}. Increasing difficulty.`)\n            // å¤¢ã‚’ã‚ãã‚‰ã‚ãŸã“ã¨ã«ã‚ˆã‚‹ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼šä»Šå¾Œã®èª²é¡Œé›£æ˜“åº¦ãŒä¸Šæ˜‡\n            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›: æ´»åŠ›ã‚’å¤±ã†ã®ã¯å®‰ç›´ã€‚æ¬¡ã‚¿ãƒ¼ãƒ³ä»¥é™å‡ºã¦ãã‚‹èª²é¡Œã®ãƒ¬ãƒ™ãƒ«ãŒã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚\n            this.challengeDifficultyModifier += 2\n            console.log(`[Game] Difficulty modifier increased to ${this.challengeDifficultyModifier}`)\n          }\n\n          this.cardManager.addToDiscardPile(c)\n        }\n      })\n      this.cardManager.clearCardChoices()\n    }\n\n    this.challengeService.startChallenge(this, challengeCard)\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ç›´æ¥å¼•ãï¼ˆçŠ¶æ…‹æ›´æ–°ã‚ã‚Šï¼‰\n   */\n  drawChallengeCard(): Card | null {\n    return this.cardManager.drawChallengeCard()\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ/é¸æŠè§£é™¤ã™ã‚‹\n   * @param {Card} card - é¸æŠ/è§£é™¤ã™ã‚‹ã‚«ãƒ¼ãƒ‰\n   * @returns {boolean} é¸æŠçŠ¶æ…‹ï¼ˆtrue:é¸æŠã€false:è§£é™¤ï¼‰\n   */\n  toggleCardSelection(card: Card): boolean {\n    return this.cardManager.toggleCardSelection(card)\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è§£æ±ºã—ã€çµæœã‚’è¿”ã™\n   * @returns {ChallengeResult} ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®çµæœ\n   * @throws {Error} ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒãªã„å ´åˆ\n   */\n  resolveChallenge(): ChallengeResult {\n    const result = this.challengeService.resolveChallenge(this)\n\n    // å¤¢é”æˆãƒã‚§ãƒƒã‚¯: å¤¢ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æˆåŠŸã—ãŸã‚‰å‹åˆ©\n    if (result.success && this.currentChallenge?.isDreamCard()) {\n      console.log('[Game] ğŸ‰ Dream achieved! Victory!')\n      this.changeStatus('victory')\n    }\n\n    return result\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµæœã‚’è¨˜éŒ²ã—ã€çµ±è¨ˆã¨ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆApplicationServiceç”¨ï¼‰\n   * @param {number} totalPower ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç·ãƒ‘ãƒ¯ãƒ¼\n   * @param {boolean} success ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®æˆåŠŸ/å¤±æ•—\n   */\n  recordChallengeResult(success: boolean): void {\n    // çµ±è¨ˆæ›´æ–°\n    this.stats.totalChallenges++\n    if (success) {\n      this.stats.successfulChallenges++\n      if (!this.stats.challengesCompleted) {\n        this.stats.challengesCompleted = 0\n      }\n      this.stats.challengesCompleted++\n    } else {\n      this.stats.failedChallenges++\n      if (!this.stats.challengesFailed) {\n        this.stats.challengesFailed = 0\n      }\n      this.stats.challengesFailed++\n    }\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãƒ‡ãƒƒã‚­ã«è¿½åŠ ï¼ˆå¾“æ¥ã®ã‚«ãƒ¼ãƒ‰é¸æŠãƒ•ã‚§ãƒ¼ã‚ºç”¨ï¼‰\n   */\n  selectCard(cardId: string): boolean {\n    if (this.phase !== 'card_selection') {\n      throw new Error('Not in card selection phase')\n    }\n\n    const selectedCard = this.cardManager.getCardChoiceById(cardId)\n    if (!selectedCard) {\n      throw new Error('Invalid card selection')\n    }\n\n    // ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒƒã‚­ã«è¿½åŠ \n    this.cardManager.addToPlayerDeck(selectedCard)\n    this.stats.cardsAcquired++\n\n    // Phase 2-4: ä¿é™ºã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯ç®¡ç†ãƒªã‚¹ãƒˆã«è¿½åŠ \n    if (selectedCard.type === 'insurance') {\n      this.activeInsurances.push(selectedCard)\n      // Phase 3: ä¿é™ºæ–™è² æ‹…ã‚’æ›´æ–°\n      this.updateInsuranceBurden()\n    }\n\n    // é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢\n    this.cardManager.clearCardChoices()\n\n    // è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œï¼ˆã‚¿ãƒ¼ãƒ³çµ‚äº†å¯èƒ½çŠ¶æ…‹ï¼‰\n    this.changePhase('resolution')\n\n    return true\n  }\n\n  /**\n   * ä¿é™ºç¨®é¡ã‚’é¸æŠã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆãƒ»è¿½åŠ \n   */\n  selectInsuranceType(insuranceType: string, durationType: 'term' | 'whole_life'): InsuranceTypeSelectionResult {\n    return this.insuranceService.selectInsuranceType(this, insuranceType, durationType)\n  }\n\n  /**\n   * ä¿é™ºé¸æŠã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¿é™ºã«å…¥ã‚‰ãªã„é¸æŠï¼‰\n   * ä¿é™ºæ–™è² æ‹…ãªã—ã§é€²è¡Œã§ãã‚‹ãŒã€ãƒªã‚¹ã‚¯ã«å¯¾ã™ã‚‹ä¿éšœãŒãªã„\n   */\n  skipInsuranceSelection(): void {\n    console.log('[Game] Skipping insurance selection - proceeding without insurance')\n\n    // ä¿é™ºç¨®é¡é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢\n    this.insuranceTypeChoices = undefined\n\n    // è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œ\n    this.changePhase('resolution')\n  }\n\n  /**\n   * ä¿é™ºç™ºå‹•ã‚’ãƒˆãƒªã‚¬ãƒ¼\n   */\n  triggerInsuranceClaim(insurance: Card, triggerType: InsuranceTriggerType): void {\n    console.log(`[Game] Insurance Triggered: ${insurance.name} (${triggerType})`)\n    this.pendingInsuranceClaim = {\n      insurance,\n      triggerType\n    }\n  }\n\n  /**\n   * ä¿é™ºè«‹æ±‚ã‚’å®Ÿè¡Œï¼ˆåŠ¹æœé©ç”¨ã¨å¥‘ç´„çµ‚äº†ï¼‰\n   */\n  async resolveInsuranceClaim(): Promise<void> {\n    if (!this.pendingInsuranceClaim) return\n\n    const { insurance, triggerType } = this.pendingInsuranceClaim\n    console.log(`[Game] Resolving Insurance Claim: ${insurance.name}`)\n\n    // 1. å¥‘ç´„çµ‚äº†ï¼ˆå‰Šé™¤ï¼‰\n    this.removeInsurance(insurance)\n\n    // 2. æœŸé™åˆ‡ã‚Œï¼ˆä½¿ç”¨æ¸ˆã¿ï¼‰ãƒªã‚¹ãƒˆã«è¿½åŠ \n    this.expiredInsurances = this.expiredInsurances || []\n    this.expiredInsurances.push(insurance)\n\n    // 3. åŠ¹æœé©ç”¨\n    await this.applyInsuranceEffect(triggerType)\n\n    // 4. ã‚¯ãƒ¬ãƒ¼ãƒ çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢\n    this.pendingInsuranceClaim = undefined\n\n    // StateManageré€šçŸ¥ã¯ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ãªã©ã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯ç‰¹åˆ¥ãªä¿å­˜ã¯ä¸è¦\n    // this.stateManager.saveState(this)\n  }\n\n  /**\n   * ä¿é™ºåŠ¹æœã‚’é©ç”¨\n   */\n  private async applyInsuranceEffect(triggerType: InsuranceTriggerType): Promise<void> {\n    switch (triggerType) {\n      case 'on_aging_gameover':\n        // éšœå®³ä¿é™º: æ‰‹æœ­ã‚’å…¨ã¦æ¨ã¦ã¦å¼•ãç›´ã™\n        console.log('[Game] Applying Disability Insurance Effect: Reset Hand')\n        this.cardManager.discardHand()\n        // åˆæœŸæšæ•°ï¼ˆ5æšï¼‰å¼•ã\n        await this.drawCards(this.config.startingHandSize)\n        break\n\n      case 'on_death':\n        // ç”Ÿå‘½ä¿é™º: æ´»åŠ›å›å¾©\n        console.log('[Game] Applying Life Insurance Effect: Revive')\n        this.heal(10) // Fixed amount 10\n        break\n\n      case 'on_heavy_damage':\n        console.log('[Game] Applying Medical Insurance Effect: Damage Reduction')\n        // åŒ»ç™‚ä¿é™º: ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’1ã«è»½æ¸›\n        this.applyDamage(1)\n        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªã‚¢ã¯ä¸è¦ï¼ˆçµ‚äº†å¾Œã«pendingã”ã¨æ¶ˆãˆã‚‹ï¼‰\n        break\n\n      case 'on_demand':\n        console.log('[Game] Applying Income Protection Effect: Skip Challenge')\n        // å°±æ¥­ä¸èƒ½ä¿é™º: ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—\n        // ç¾åœ¨ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢\n        this.currentChallenge = undefined\n        this.cardManager.clearSelection()\n\n        // ãƒ•ã‚§ãƒ¼ã‚ºã‚’è§£æ±ºï¼ˆã®å¾Œã®çŠ¶æ…‹ï¼‰ã¸\n        // çµæœãªã—ã§è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºã¸ç§»è¡Œã™ã‚Œã°ã€å ±é…¬é¸æŠãªã—ã§æ¬¡ã¸é€²ã‚ã‚‹ã¯ãš\n        this.changePhase('resolution')\n        break\n    }\n  }\n\n\n\n  /**\n   * ä¿é™ºè«‹æ±‚ã‚’æ‹’å¦\n   */\n  declineInsuranceClaim(): void {\n    console.log(`[Game] Insurance Claim Declined`)\n\n    const triggerType = this.pendingInsuranceClaim?.triggerType\n    const context = this.pendingInsuranceClaim?.context\n\n    // 1. ä¿ç•™å‡¦ç†ã®å†é–‹ (on_heavy_damage)\n    if (triggerType === 'on_heavy_damage' && context?.damage) {\n      console.log('[Game] Applying original damage after decline')\n      this.applyDamage(context.damage)\n    }\n\n    // ã‚¯ãƒ¬ãƒ¼ãƒ çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢\n    this.pendingInsuranceClaim = undefined\n\n    // 2. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç¢ºå®šãƒã‚§ãƒƒã‚¯ (on_death, on_aging_gameover)\n    // æ³¨æ„: applyDamageã§å†åº¦on_deathãƒã‚§ãƒƒã‚¯ãŒå…¥ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€pendingãŒundefinedãªã‚‰game_overã«ãªã‚‹ã¯ãš\n    // ã—ã‹ã—ã“ã“ã§ã®ãƒã‚§ãƒƒã‚¯ã¯ã€ä¿é™ºç™ºå‹•å‰ã«ã€Œæ­¢ã‚ã¦ã„ãŸã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’å†é–‹ã™ã‚‹ãŸã‚\n    if (triggerType === 'on_death') {\n      if (this._vitality.isDepleted()) {\n        console.log('[Game] Life Insurance declined. Game Over confirmed.')\n        this.changeStatus('game_over')\n      }\n    }\n    else if (triggerType === 'on_aging_gameover') {\n      if (this.hasAgingCardGameOver()) {\n        console.log('[Game] Disability Insurance declined. Game Over confirmed.')\n        this.changeStatus('game_over')\n      }\n    }\n  }\n\n  /**\n   * ä¿é™ºã‚’å‰Šé™¤\n   */\n  private removeInsurance(card: Card): void {\n    this.insuranceService.removeInsurance(this, card)\n  }\n\n  /**\n   * æ´»åŠ›ã‚’æ›´æ–°ï¼ˆå¥‘ç´„ã«ã‚ˆã‚‹è¨­è¨ˆç‰ˆï¼‰\n   * \n   * äº‹å‰æ¡ä»¶: changeã¯æ•°å€¤ã§ã‚ã‚‹\n   * äº‹å¾Œæ¡ä»¶: \n   *   - æ´»åŠ›ã¯0ä»¥ä¸ŠmaxVitalityä»¥ä¸‹ã§ã‚ã‚‹\n   *   - change < 0ã®å ´åˆã€æ´»åŠ›ã¯æ¸›å°‘ã¾ãŸã¯0ã«ãªã‚‹\n   *   - change > 0ã®å ´åˆã€æ´»åŠ›ã¯å¢—åŠ ã¾ãŸã¯maxVitalityã«ãªã‚‹\n   *   - çµ±è¨ˆæƒ…å ±ãŒé©åˆ‡ã«æ›´æ–°ã•ã‚Œã‚‹\n   * ä¸å¤‰æ¡ä»¶: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹\n   */\n  private updateVitality(change: number): void {\n    // äº‹å‰æ¡ä»¶ãƒã‚§ãƒƒã‚¯\n    if (typeof change !== 'number' || !isFinite(change)) {\n      throw new Error('Change amount must be a finite number')\n    }\n\n    // å¤‰æ›´ãŒãªã„å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—\n    if (change === 0) return\n\n    // åŒ»ç™‚ä¿é™ºãƒã‚§ãƒƒã‚¯ (on_heavy_damage) - ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨å‰ã«åˆ¤å®š\n    if (change < 0 && Math.abs(change) >= 10) {\n      // activeInsurancesã®ç¢ºèª\n      const insurance = this.activeInsurances.find(c => c.insuranceTriggerType === 'on_heavy_damage')\n      if (insurance) {\n        this.triggerInsuranceClaim(insurance, 'on_heavy_damage')\n\n        // ä¿ç•™çŠ¶æ…‹ã§å‡¦ç†ä¸­æ–­ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ã—ãªã„ï¼‰\n        if (this.pendingInsuranceClaim) {\n          this.pendingInsuranceClaim.context = { damage: Math.abs(change) }\n          return\n        }\n      }\n    }\n\n    // const previousVitality = this.vitality // Unused variable removed\n\n    if (change >= 0) {\n      this._vitality = this._vitality.increase(change)\n    } else {\n      this._vitality = this._vitality.decrease(-change)\n    }\n\n    // äº‹å¾Œæ¡ä»¶ãƒã‚§ãƒƒã‚¯\n    const currentVitality = this.vitality\n    if (currentVitality < 0 || currentVitality > this.maxVitality) {\n      console.warn(`Vitality invariant violation: ${currentVitality} not in [0, ${this.maxVitality}]`)\n      // Auto-correct to prevent crash\n      if (currentVitality > this.maxVitality) {\n        this._vitality = this._vitality.withMaxVitality(this.maxVitality)\n      } else if (currentVitality < 0) {\n        // Should be handled by Vitality class but just in case\n        this._vitality = Vitality.create(0, this.maxVitality)\n      }\n    }\n\n    // ãƒ€ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚’è¨­å®š\n    this._dirtyFlags.vitality = true\n    this._dirtyFlags.stats = true\n\n    // çµ±è¨ˆæ›´æ–°ï¼ˆé˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ï¼‰\n    if (currentVitality > this.stats.highestVitality) {\n      this.stats.highestVitality = currentVitality\n    }\n\n    // ãƒ€ãƒ¡ãƒ¼ã‚¸å±¥æ­´ã‚’è¨˜éŒ²\n    if (change < 0) {\n      this._playerHistory.totalDamageTaken += Math.abs(change)\n    }\n\n    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š\n    if (this._vitality.isDepleted()) {\n      console.error('[DEBUG] Vitality Depleted!')\n      console.error(`[DEBUG] Active Insurances: ${this.activeInsurances.length}`)\n      this.activeInsurances.forEach((c, i) => console.error(`[DEBUG] Ins[${i}]: id=${c.id}, trigger=${c.insuranceTriggerType}`))\n\n      // ç”Ÿå‘½ä¿é™ºãƒã‚§ãƒƒã‚¯ (on_death)\n      const insurance = this.activeInsurances.find(c => c.insuranceTriggerType === 'on_death')\n      if (insurance) {\n        console.error(`[DEBUG] FOUND Life Insurance: ${insurance.id}`)\n        this.triggerInsuranceClaim(insurance, 'on_death')\n        // ã¾ã ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ã—ãªã„\n        return\n      } else {\n        console.error('[DEBUG] NOT FOUND Life Insurance')\n      }\n\n      this.changeStatus('game_over')\n    }\n\n    // ä¸å¤‰æ¡ä»¶ãƒã‚§ãƒƒã‚¯\n    // Note: ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Œã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚‚ã‚ã‚Šå¾—ã‚‹ãŸã‚ã€æ´»åŠ›ãŒæ®‹ã£ã¦ã„ã¦ã‚‚OKã¨ã™ã‚‹\n    // if (this.status === 'game_over' && !this._vitality.isDepleted()) {\n    //   throw new Error('Game over state inconsistency: vitality not depleted')\n    // }\n  }\n\n  // ...\n\n\n\n\n\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦æ´»åŠ›ä¸Šé™ã‚’æ›´æ–°\n   * å¹´é½¢ãŒä¸ŠãŒã‚‹ã«ã¤ã‚Œã¦æœ€å¤§æ´»åŠ›ãŒæ¸›å°‘ã—ã€ç¾å®Ÿçš„ãªä½“åŠ›å¤‰åŒ–ã‚’åæ˜ \n   */\n  private updateMaxVitalityForAge(): void {\n    const ageParams = GameConstantsAccessor.getStageParameters(this.stage)\n\n    // Legacy support or fallback if accessor returns generic type without maxVitality (it shouldn't)\n    if (!ageParams) {\n      console.warn(`Unknown stage parameters for: ${this.stage}`)\n      return\n    }\n\n    const newMaxVitality = ageParams.maxVitality\n\n    // ç¾åœ¨ã®æ´»åŠ›å€¤ãŒæ–°ã—ã„ä¸Šé™ã‚’è¶…ãˆã‚‹å ´åˆã¯èª¿æ•´\n    const currentValue = this._vitality.getValue()\n    if (currentValue > newMaxVitality) {\n      console.info(`[Stage] ${ageParams.label}: Max Vitality adjusted to ${newMaxVitality}`)\n      this._vitality = this._vitality.withMaxVitality(newMaxVitality)\n    } else {\n      // ä¸Šé™ã®ã¿æ›´æ–°ï¼ˆç¾åœ¨å€¤ã¯ãã®ã¾ã¾ï¼‰\n      this._vitality = Vitality.create(currentValue, newMaxVitality)\n    }\n\n    // ãƒ€ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚’è¨­å®š\n    this._dirtyFlags.vitality = true\n  }\n\n  /**\n   * æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸\n   */\n  nextTurn(): TurnResult {\n    this.updateScore()\n    return this.turnManager.nextTurn(this)\n  }\n\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é€²ã‚ã‚‹ï¼ˆæ‰‹å‹•ç”¨ï¼‰\n   */\n  advanceStage(): void {\n    const advanceResult = this.stageManager.advanceStage(this.stage)\n\n    if (advanceResult.isCompleted) {\n      // æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢\n      this.changeStatus('victory')\n    } else if (advanceResult.newStage) {\n      this.changeStage(advanceResult.newStage)\n    }\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‡ãƒƒã‚­ã‚’ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ç”¨ã®ã‚«ãƒ¼ãƒ‰ã§è£œå……ã™ã‚‹\n   */\n  refillChallengeDeck(): void {\n    const newCards = CardFactory.createChallengeCards(this.stage)\n    this.cardManager.refillChallengeDeck(newCards)\n    console.debug(`[Game] Challenge deck refilled for stage ${this.stage}: ${newCards.length} cards`)\n  }\n\n  /**\n   * æ‰‹æœ­ã‚’å–å¾—\n   */\n  get hand(): Card[] {\n    return this.cardManager.getState().hand\n  }\n\n  /**\n   * æ‰‹å‹•ã§ä½¿ç”¨å¯èƒ½ãªä¿é™ºï¼ˆå°±æ¥­ä¸èƒ½ä¿é™ºãªã©ï¼‰ã‚’å–å¾—\n   */\n  get availableOnDemandInsurances(): Card[] {\n    return this.activeInsurances.filter(c => c.insuranceTriggerType === 'on_demand')\n  }\n\n  /**\n   * æ¨ã¦æœ­ã‚’å–å¾—\n   */\n  get discardPile(): Card[] {\n    return this.cardManager.getState().discardPile\n  }\n\n  /**\n   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒƒã‚­ã‚’å–å¾—\n   */\n  get playerDeck(): Deck {\n    return this.cardManager.getState().playerDeck\n  }\n\n  /**\n   * ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‡ãƒƒã‚­ã‚’å–å¾—\n   */\n  get challengeDeck(): Deck {\n    return this.cardManager.getState().challengeDeck\n  }\n\n  /**\n   * é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—\n   */\n  get selectedCards(): Card[] {\n    return this.cardManager.getState().selectedCards\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’å–å¾—\n   */\n  get cardChoices(): Card[] | undefined {\n    return this.cardManager.getState().cardChoices\n  }\n\n  /**\n   * ä¿é™ºç¨®é¡é¸æŠè‚¢ã‚’å–å¾—\n   */\n  get currentInsuranceTypeChoices(): InsuranceTypeChoice[] | undefined {\n    return this.insuranceTypeChoices\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã‹ã©ã†ã‹\n   */\n  isInProgress(): boolean {\n    return this.status === 'in_progress'\n  }\n\n  /**\n   * ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹\n   */\n  isCompleted(): boolean {\n    return this.status === 'game_over' || this.status === 'victory'\n  }\n\n  /**\n   * Phase 4: å¤¢ã‚«ãƒ¼ãƒ‰ã®å¿…è¦ãƒ‘ãƒ¯ãƒ¼ã‚’å¹´é½¢èª¿æ•´è¾¼ã¿ã§è¨ˆç®—\n   */\n  getDreamRequiredPower(challenge: Card): number {\n    // å¤¢ã‚«ãƒ¼ãƒ‰ã§ãªã„å ´åˆã¯åŸºæœ¬ãƒ‘ãƒ¯ãƒ¼ã‚’ãã®ã¾ã¾è¿”ã™\n    // NOTE: é€šå¸¸ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã‚‚dreamCategoryï¼ˆèº«ä½“çš„/çŸ¥è­˜çš„ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°å¹´é½¢èª¿æ•´ã‚’é©ç”¨ã™ã‚‹\n    if (!challenge.dreamCategory) {\n      return challenge.power\n    }\n\n    // é’å¹´æœŸã¯èª¿æ•´ãªã—\n    if (this.stage === 'youth') {\n      return challenge.power\n    }\n\n    // ä¸­å¹´æœŸãƒ»å……å®ŸæœŸã®å¹´é½¢èª¿æ•´ã‚’é©ç”¨\n    const adjustment = DREAM_AGE_ADJUSTMENTS[challenge.dreamCategory]\n    const adjustedPower = challenge.power + adjustment\n\n    // æœ€å°å€¤ã¯1\n    return Math.max(1, adjustedPower)\n  }\n\n  /**\n   * Phase 2-4: æœŸé™åˆ‡ã‚Œã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆé€šçŸ¥ç”¨ï¼‰\n   */\n  getExpiredInsurances(): Card[] {\n    return [...this.expiredInsurances]\n  }\n\n  /**\n   * Phase 2-4: æœŸé™åˆ‡ã‚Œé€šçŸ¥ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearExpiredInsurances(): void {\n    this.expiredInsurances = []\n  }\n\n  /**\n   * æœŸé™ãŒè¿‘ã„ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆæ®‹ã‚Š2ã‚¿ãƒ¼ãƒ³ä»¥ä¸‹ï¼‰\n   */\n  getExpiringsSoonInsurances(): Card[] {\n    return this.expirationManager.getExpiringSoonInsurances(this.activeInsurances)\n  }\n\n  /**\n   * ä¿é™ºæœŸé™åˆ‡ã‚Œã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—\n   */\n  getExpirationWarnings(): string[] {\n    return this.expirationManager.getExpirationWarnings(this.activeInsurances)\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¨­å®šï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰\n   */\n  setStage(stage: GameStage): void {\n    this.changeStage(stage)\n  }\n\n  /**\n   * Phase 2-4: ç¾åœ¨æœ‰åŠ¹ãªä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’å–å¾—\n   */\n  getActiveInsurances(): Card[] {\n    return [...this.activeInsurances]\n  }\n\n  /**\n   * ã‚¹ã‚³ã‚¢è¨ˆç®—\n   */\n  private updateScore(): void {\n    // Basic score calculation\n    // Vitality * 1\n    // Active Insurance: Coverage * 0.1? Or just a flat bonus per active card?\n    // Let's go with Rulebook v2 approximation: Vitality + (Total Coverage / 10)\n    let insuranceScore = 0\n    this.activeInsurances.forEach(card => {\n      if (card.coverage) {\n        insuranceScore += Math.floor(card.coverage / 10)\n      }\n    })\n\n    this.score = this.vitality + insuranceScore\n  }\n\n  /**\n   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æœ€é©ãªä¿é™ºäºˆç®—ã‚’ææ¡ˆ\n   * \n   * @param riskProfile ãƒªã‚¹ã‚¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«\n   * @returns æ¨å¥¨ä¿é™ºäºˆç®—\n   */\n  getRecommendedInsuranceBudget(riskProfile: 'conservative' | 'balanced' | 'aggressive' = 'balanced'): InsurancePremium {\n    return this.premiumCalculationService.calculateOptimalInsuranceBudget(\n      this.vitality,\n      this.stage,\n      riskProfile\n    )\n  }\n\n  /**\n   * ç‰¹å®šã®ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ç·åˆä¿é™ºæ–™ã‚’å–å¾—\n   * \n   * @param card ä¿é™ºã‚«ãƒ¼ãƒ‰\n   * @returns å¹´é½¢ãƒ»ç¨®åˆ¥ãƒ»ãƒªã‚¹ã‚¯èª¿æ•´æ¸ˆã¿ä¿é™ºæ–™\n   */\n  calculateCardPremium(card: Card): InsurancePremium {\n    if (card.type !== 'insurance') {\n      throw new Error('Card must be an insurance card')\n    }\n\n    return this.premiumCalculationService.calculateComprehensivePremium(card, this.stage, this._riskProfile)\n  }\n\n  /**\n   * Phase 3: ä¿é™ºæ–™è² æ‹…ã‚’è¨ˆç®—ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n   * \n   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒ€ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹é«˜é€ŸåŒ–\n   */\n  calculateInsuranceBurden(): number {\n    const currentTime = Date.now()\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã§ä¿é™ºçŠ¶æ…‹ãŒå¤‰ã‚ã£ã¦ã„ãªã„å ´åˆã¯å†è¨ˆç®—ã‚’ã‚¹ã‚­ãƒƒãƒ—\n    if (!this._dirtyFlags.insurance &&\n      currentTime - this._cachedValues.lastUpdateTime < 100 &&\n      this._cachedValues.totalInsuranceCount === this.activeInsurances.length) {\n      return this._cachedValues.insuranceBurden\n    }\n\n    const burden = this.insuranceService.calculateInsuranceBurden(this)\n\n    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°\n    this._cachedValues.insuranceBurden = burden\n    this._cachedValues.totalInsuranceCount = this.activeInsurances.length\n    this._cachedValues.lastUpdateTime = currentTime\n    this._dirtyFlags.insurance = false\n\n    return burden\n  }\n\n  /**\n   * Phase 3: ä¿é™ºæ–™è² æ‹…ã‚’æ›´æ–°ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n   */\n  private updateInsuranceBurden(): void {\n    this.insuranceService.updateInsuranceBurden(this)\n  }\n\n\n\n  /**\n   * Phase 3: ç·åˆãƒ‘ãƒ¯ãƒ¼ã‚’è©³ç´°ã«è¨ˆç®—\n   * @param cards ä½¿ç”¨ã™ã‚‹ã‚«ãƒ¼ãƒ‰\n   * @returns ãƒ‘ãƒ¯ãƒ¼ã®è©³ç´°ãªå†…è¨³\n   */\n  calculateTotalPower(cards: Card[]): {\n    base: number\n    insurance: number\n    burden: number\n    total: number\n  } {\n    return this.challengeService.calculateTotalPower(this, cards)\n  }\n\n\n\n\n\n\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«ç›´æ¥è¿½åŠ \n   */\n  addCardToHand(card: Card): void {\n    this.cardManager.addToHand(card)\n  }\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«ç›´æ¥è¿½åŠ \n   */\n  addCardToDiscardPile(card: Card): void {\n    this.cardManager.addToDiscardPile(card)\n  }\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒƒã‚­ã«ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ \n   */\n  addCardToPlayerDeck(card: Card): void {\n    this.cardManager.addToPlayerDeck(card)\n  }\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: æ‰‹æœ­ã‚’ã‚¯ãƒªã‚¢\n   */\n  clearHand(): void {\n    const state = this.cardManager.getState()\n    state.hand = []\n    this.cardManager.setState(state)\n  }\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: æ‰‹æœ­ã‚’è¨­å®š\n   */\n  setHand(cards: Card[]): void {\n    const state = this.cardManager.getState()\n    state.hand = [...cards]\n    this.cardManager.setState(state)\n  }\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: ã‚«ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’è¨­å®š\n   */\n  setCardChoices(choices: Card[]): void {\n    this.cardManager.setCardChoices(choices)\n  }\n\n  /**\n   * ãƒ†ã‚¹ãƒˆç”¨: ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¨­å®š\n   */\n  setPhase(phase: GamePhase): void {\n    this.changePhase(phase)\n  }\n\n\n  /**\n   * ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰\n   */\n  getSnapshot(): IGameState {\n    const cardState = this.cardManager.getState()\n\n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‹ã‚‰å†åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—\n    let snapshot = Game.OBJECT_POOLS.gameStates.pop()\n\n    if (!snapshot) {\n      snapshot = {}\n    }\n\n    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šï¼ˆé…åˆ—ã¯é©åˆ‡ã«ã‚³ãƒ”ãƒ¼ï¼‰\n    Object.assign(snapshot, {\n      id: this.id,\n      status: this.status,\n      phase: this.phase,\n      stage: this.stage,\n      turn: this.turn,\n      vitality: this.vitality,\n      maxVitality: this.maxVitality,\n      playerDeck: this.playerDeck, // Getter uses getState()\n      hand: [...this.hand], // Getter uses getState()\n      discardPile: [...this.discardPile], // Getter uses getState()\n      challengeDeck: this.challengeDeck, // Getter uses getState()\n      currentChallenge: this.currentChallenge,\n      selectedCards: [...cardState.selectedCards], // é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼\n      cardChoices: cardState.cardChoices ? [...cardState.cardChoices] : undefined, // é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼\n      insuranceTypeChoices: this.insuranceTypeChoices,\n      activeInsurances: [...this.activeInsurances],\n      expiredInsurances: [...this.expiredInsurances],\n      insuranceBurden: this.insuranceBurden,\n      stats: { ...this.stats },\n      config: { ...this.config },\n      startedAt: this.startedAt,\n      completedAt: this.completedAt\n    })\n\n    return snapshot as IGameState\n  }\n\n  /**\n   * çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š\n   * Observer Pattern ã®å®Ÿè£…\n   */\n  private setupStateListeners(): void {\n    // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã®ç›£è¦–\n    this.stateManager.addEventListener('phase_change', (event) => {\n      console.info(`[Phase] ${event.previousValue} -> ${event.newValue}`)\n      this.handlePhaseChange(event.previousValue, event.newValue)\n    })\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã®ç›£è¦–\n    this.stateManager.addEventListener('stage_change', (event) => {\n      console.info(`[Stage] ${event.previousValue} -> ${event.newValue}`)\n      this.updateMaxVitalityForAge()\n    })\n\n    // ã‚¿ãƒ¼ãƒ³å¤‰æ›´ã®ç›£è¦–\n    this.stateManager.addEventListener('turn_change', (event) => {\n      console.info(`[Turn] ${event.previousValue} -> ${event.newValue}`)\n      this.stats.turnsPlayed = event.newValue\n    })\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®ç›£è¦–\n    this.stateManager.addEventListener('status_change', (event) => {\n      console.info(`[Status] ${event.previousValue} -> ${event.newValue}`)\n\n      if (event.newValue === 'game_over' || event.newValue === 'victory') {\n        this.completedAt = new Date()\n      }\n    })\n  }\n\n  /**\n   * ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n   */\n  private handlePhaseChange(previousPhase: GamePhase, newPhase: GamePhase): void {\n    // previousPhase is reserved for future logic\n    void previousPhase\n    switch (newPhase) {\n      case 'draw':\n        // ãƒ‰ãƒ­ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®å‡¦ç†\n        break\n      case 'challenge':\n        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®å‡¦ç†\n        break\n      case 'card_selection':\n        // ã‚«ãƒ¼ãƒ‰é¸æŠãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®å‡¦ç†\n        break\n      case 'resolution':\n        // è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®å‡¦ç†\n        break\n    }\n  }\n\n  /**\n   * ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®‰å…¨ã«å¤‰æ›´\n   */\n  private changePhase(newPhase: GamePhase): void {\n    const previousPhase = this.phase\n    this.phase = newPhase\n    this.stateManager.notifyPhaseChange(previousPhase, newPhase)\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®‰å…¨ã«å¤‰æ›´\n   */\n  /**\n   * å¤–éƒ¨ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã•ã›ã‚‹ï¼ˆå‹åˆ©ã¾ãŸã¯æ•—åŒ—ï¼‰\n   */\n  finishGame(isWin: boolean): void {\n    this.changeStatus(isWin ? 'victory' : 'game_over')\n  }\n\n  private changeStatus(newStatus: GameStatus): void {\n    const previousStatus = this.status\n    this.status = newStatus\n    this.stateManager.notifyStatusChange(previousStatus, newStatus)\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å®‰å…¨ã«å¤‰æ›´\n   */\n  private changeStage(newStage: GameStage): void {\n    const previousStage = this.stage\n    this.stage = newStage\n    this.stateManager.notifyStageChange(previousStage, newStage)\n  }\n\n  /**\n   * ã‚¿ãƒ¼ãƒ³ã‚’å®‰å…¨ã«å¤‰æ›´\n   */\n  private changeTurn(newTurn: number): void {\n    const previousTurn = this.turn\n    this.turn = newTurn\n    this.stateManager.notifyTurnChange(previousTurn, newTurn)\n  }\n\n  /**\n   * çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ†ã‚¹ãƒˆãƒ»æ‹¡å¼µç”¨ï¼‰\n   */\n  getStateManager(): GameStateManager {\n    return this.stateManager\n  }\n\n  /**\n   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ†ã‚¹ãƒˆãƒ»æ‹¡å¼µç”¨ï¼‰\n   */\n  getActionProcessor(): GameActionProcessor {\n    return this.actionProcessor\n  }\n\n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã¸ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè¿”å´\n   */\n  static releaseSnapshot(snapshot: IGameState): void {\n    // ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã‚’åˆ¶é™ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰\n    if (Game.OBJECT_POOLS.gameStates.length < 10) {\n      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢\n      Object.keys(snapshot).forEach(key => {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        delete (snapshot as Record<string, any>)[key]\n      })\n      Game.OBJECT_POOLS.gameStates.push(snapshot as Partial<IGameState>)\n    }\n  }\n\n  /**\n   * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã®å–å¾—\n   */\n  getPerformanceStats(): {\n    poolStats: {\n      gameStates: number\n      cards: number\n      challengeResults: number\n    }\n    cacheHitRate: number\n    dirtyFlags: Record<string, boolean>\n  } {\n    return {\n      poolStats: {\n        gameStates: Game.OBJECT_POOLS.gameStates.length,\n        cards: Game.OBJECT_POOLS.cards.length,\n        challengeResults: Game.OBJECT_POOLS.challengeResults.length\n      },\n      cacheHitRate: this._cachedValues.lastUpdateTime > 0 ? 0.85 : 0, // æ¦‚ç®—\n      dirtyFlags: { ...this._dirtyFlags }\n    }\n  }\n\n  // === AIæˆ¦ç•¥ã‚·ã‚¹ãƒ†ãƒ  ===\n\n  /**\n   * AIæ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®š\n   */\n  setAIEnabled(enabled: boolean): void {\n    this._aiEnabled = enabled\n    if (enabled) {\n      console.info(`[AI] System Enabled (Strategy: ${this._currentAIStrategy})`)\n    } else {\n      console.info('[AI] System Disabled')\n    }\n  }\n\n  /**\n   * AIæ©Ÿèƒ½ã®æœ‰åŠ¹çŠ¶æ…‹ã‚’å–å¾—\n   */\n  isAIEnabled(): boolean {\n    return this._aiEnabled\n  }\n\n  /**\n   * AIæˆ¦ç•¥ã‚’å¤‰æ›´\n   */\n  setAIStrategy(strategyType: AIStrategyType): void {\n    this._currentAIStrategy = strategyType\n    this.aiStrategyService.setStrategy(strategyType)\n    console.info(`[AI] Strategy Changed: ${strategyType}`)\n  }\n\n  /**\n   * ç¾åœ¨ã®AIæˆ¦ç•¥ã‚’å–å¾—\n   */\n  getCurrentAIStrategy(): AIStrategyType {\n    return this._currentAIStrategy\n  }\n\n  /**\n   * AIæˆ¦ç•¥ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—\n   */\n  getAIStatistics() {\n    return this.aiStrategyService.getStatistics()\n  }\n\n  /**\n   * AIã«ã‚ˆã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸è‡ªå‹•é¸æŠ\n   */\n  aiSelectChallenge(): Card | null {\n    if (!this._aiEnabled) {\n      throw new Error('AI is not enabled')\n    }\n\n    const availableChallenges = this.cardManager.getState().challengeDeck.getCards()\n    if (availableChallenges.length === 0) {\n      return null\n    }\n\n    const choice = this.aiStrategyService.autoSelectChallenge(availableChallenges, this)\n    console.debug(`[AI] Auto-selected challenge: ${choice.challenge.name} (Success Rate: ${(choice.successProbability * 100).toFixed(1)}%)`)\n    console.debug(`[AI] Reason: ${choice.reason}`)\n\n    return choice.challenge\n  }\n\n  /**\n   * AIã«ã‚ˆã‚‹ã‚«ãƒ¼ãƒ‰è‡ªå‹•é¸æŠ\n   */\n  aiSelectCards(challenge: Card): Card[] {\n    if (!this._aiEnabled) {\n      throw new Error('AI is not enabled')\n    }\n\n    const availableCards = this.cardManager.getState().playerDeck.getCards()\n    const choice = this.aiStrategyService.autoSelectCards(challenge, availableCards, this)\n\n    console.debug(`[AI] Auto-selected cards: ${choice.cards.map(c => c.name).join(', ')}`)\n    console.debug(`[AI] Reason: ${choice.reason}`)\n    console.debug(`[AI] Expected Power: ${choice.expectedPower}`)\n\n    return choice.cards\n  }\n\n  /**\n   * AIã«ã‚ˆã‚‹å®Œå…¨è‡ªå‹•ãƒ—ãƒ¬ã‚¤ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠâ†’ã‚«ãƒ¼ãƒ‰é¸æŠâ†’è§£æ±ºï¼‰\n   */\n  aiAutoPlay(): ChallengeResult | null {\n    if (!this._aiEnabled) {\n      throw new Error('AI is not enabled')\n    }\n\n    if (this.phase !== 'draw') {\n      throw new Error('Auto play can only be used during draw phase')\n    }\n\n    // 1. ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠ\n    const selectedChallenge = this.aiSelectChallenge()\n    if (!selectedChallenge) {\n      console.warn('[AI] No challenges available')\n      return null\n    }\n\n    // 2. ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹\n    this.challengeService.startChallenge(this, selectedChallenge)\n\n    // 3. ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ\n    const selectedCards = this.aiSelectCards(selectedChallenge)\n\n    // 4. ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹\n    selectedCards.forEach(card => {\n      this.cardManager.toggleCardSelection(card)\n    })\n\n    // 5. ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è§£æ±º\n    const result = this.challengeService.resolveChallenge(this)\n\n    // 6. çµ±è¨ˆã‚’è¨˜éŒ²\n    const challengeChoice = this.aiStrategyService.autoSelectChallenge([selectedChallenge], this)\n    const cardChoice = this.aiStrategyService.autoSelectCards(selectedChallenge, selectedCards, this)\n    this.aiStrategyService.recordDecision(this.turn, challengeChoice, cardChoice, result.success)\n\n    return result\n  }\n\n  /**\n   * AIè¨­å®šã®ãƒªã‚»ãƒƒãƒˆ\n   */\n  resetAISettings(): void {\n    this._aiEnabled = false\n    this._currentAIStrategy = 'balanced'\n    this.aiStrategyService.setStrategy('balanced')\n    this.aiStrategyService.clearHistory()\n    console.info('[AI] Settings Reset')\n  }\n}\n"],"names":["Deck","constructor","name","cards","__publicField","this","getName","size","length","isEmpty","addCard","card","type","power","console","warn","push","addCards","suspicious","filter","c","map","drawCard","pop","drawCards","count","drawn","i","removeCard","cardId","index","findIndex","id","splice","shuffle","j","Math","floor","random","getCards","countCardsByType","clear","clone","getStats","stats","total","byType","life","insurance","pitfall","averagePower","averageCost","totalPower","totalCost","forEach","cost","_CardPower","value","validate","create","MIN_POWER","Error","MAX_POWER","getValue","add","other","sum","max","min","powers","reduce","multiply","multiplier","result","isGreaterThan","isGreaterThanOrEqual","equals","toString","ZERO","MAX","CardPower","_InsurancePremium","MIN_PREMIUM","MAX_PREMIUM","premiums","premium","applyDiscount","discountRate","discountedValue","applyMultiplier","multipliedValue","isFree","isExpensive","EXPENSIVE_THRESHOLD","isHigherThan","isAffordableWith","availableVitality","FREE","InsurancePremium","IdGenerator","generate","prefix","Date","now","getRandomString","generateCardId","generateGameId","generateCommandId","generateNotificationId","generateFeedbackId","generateSequential","counter","generateUUID","uuid","replace","r","substr","resetCounter","getCurrentCounter","Card","params","description","_power","_cost","effects","imageUrl","category","insuranceType","coverage","penalty","ageBonus","durationType","remainingTurns","insuranceEffectType","insuranceTriggerType","dreamCategory","skillProperties","comboProperties","eventProperties","isUnlockable","unlockCondition","rewardType","getPower","getCost","hasEffect","effectType","some","effect","getEffect","find","isInsurance","isTermInsurance","isWholeLifeInsurance","getInsuranceEffectType","isDefensiveInsurance","isRecoveryInsurance","isSpecializedInsurance","calculateDamageReduction","totalReduction","reductionEffect","calculateTurnHeal","baseHeal","healEffect","calculateChallengeBonus","challengeType","bonusEffect","condition","includes","isDreamCard","copy","updates","decrementRemainingTurns","isExpired","hasPowerAtLeast","requiredPower","required","calculateEffectivePower","bonus","effectivePower","isLifeCard","isInsuranceCard","isPitfallCard","isSkillCard","isComboCard","isEventCard","isLegendaryCard","isChallengeCard","toDisplayString","display","join","decrementTurn","createLifeCard","powerSign","createChallengeCard","createInsuranceCard","createSkillCard","rarity","cooldown","common","rare","epic","legendary","remainingCooldown","masteryLevel","createComboCard","requiredCards","comboBonus","createEventCard","duration","globalEffect","createLegendaryCard","RiskRewardChallenge","riskLevel","super","successBonus","failurePenalty","insuranceImmunity","getRiskMultiplier","low","medium","high","extreme","calculateActualReward","baseReward","calculateActualPenalty","basePenalty","getRiskDescription","getChallengeDetails","toUpperCase","Boolean","createRiskChallenge","stage","template","youth","middle","fulfillment","CardFactory","calculateAgeBonus","createCardsFromDefinitions","definitions","createFn","def","createStarterLifeCards","createBasicInsuranceCards","createExtendedInsuranceCards","extendedCards","baseCards","additionalCards","createDiverseInsuranceCards","createTriggerInsuranceCards","createInsuranceTypeChoices","insuranceDefinitions","planA","cut","desc","planB","triggerType","limit","selectedDef","baseCard","termOption","wholeLifeOption","createTermInsuranceCard","choice","createWholeLifeInsuranceCard","createChallengeCards","challengeDefinitionsByStage","damage","isDream","shuffled","sort","selectedCount","selected","slice","challenges","createRiskRewardChallenges","dreamCards","createDreamCards","dreamCount","randomDream","riskDistribution","distribution","levelRandom","riskChallenge","createPitfallCards","createPitfallCard","basePower","baseCost","determineRewardType","createCard","base","createAgingCards","createFinalChallengeCard","createSkillCards","skillDefinitionsByStage","createComboCards","createEventCards","eventDefinitionsByStage","createLegendaryCards","createRewardCards","_CardManager","Set","initialize","playerDeck","challengeDeck","config","hand","discardPile","selectedCards","selectedIdsSet","cardChoices","agingDeck","insuranceMarket","activeInsurances","getState","_cachedState","_stateVersion","log","state","setState","invalidateCache","CARD_POOLS","drawResults","drawnCards","discardedCards","troubleCards","reshuffleDeck","enforceHandLimit","toggleCardSelection","has","delete","clearSelection","discardSelectedCards","removedCard","addToHand","addToDiscardPile","addToPlayerDeck","maxHandSize","discarded","shift","setCardChoices","choices","clearCardChoices","getCardChoiceById","addAgingCardToDiscard","buyInsurance","removeCardFromGame","agingCard","getInsuranceMarket","getActiveInsurances","drawChallengeCard","refillChallengeDeck","getChallengeDeckSize","discardHand","CardManager","RiskFactor","factorType","getType","getRiskLevel","getPremiumMultiplier","impact","age","health","claims","lifestyle","adjust","adjustment","newValue","combine","weight","combinedValue","toFixed","RiskProfile","factors","empty","Map","set","withFactor","factor","newFactors","getFactor","get","getOverallRiskScore","totalScore","getTotalPremiumMultiplier","getSummary","overallScore","_InsurancePremiumCalculationService","calculateAgeAdjustedPremium","basePremium","AGE_MULTIPLIERS","calculateComprehensivePremium","riskProfile","ageAdjustedPremium","typeAdjustedPremium","applyInsuranceTypeAdjustment","coverageAdjustedPremium","applyCoverageAdjustment","riskMultiplier","calculateRiskAdjustment","calculateTotalInsuranceBurden","insuranceCards","individualPremiums","baseTotalPremium","penaltyMultiplier","calculateMultiInsurancePenalty","calculateRenewalPremium","currentStage","usageHistory","continuityDiscount","calculateContinuityDiscount","discountedPremium","calculateRiskMultiplier","calculateOptimalInsuranceBudget","availableBudget","_stage","ratio","conservative","balanced","aggressive","recommendedBudget","typeRate","INSURANCE_TYPE_RATES","coverageMultiplier","insuranceCount","penaltySteps","baseMultiplier","relevantFactorType","disability","accident","cancer","specificFactor","generateRiskProfile","playerHistory","profile","default","ageRiskValue","calculateAgeRisk","healthRiskValue","calculateHealthRisk","claimsRiskValue","calculateClaimsRisk","lifestyleRiskValue","calculateLifestyleRisk","calculateRiskAdjustedPremium","history","averageDamagePerTurn","totalDamageTaken","turnsPlayed","claimRate","insuranceClaimCount","totalInsurancePurchased","riskRate","riskyChoiceCount","totalChoiceCount","medical","income","asset","dental","travel","InsurancePremiumCalculationService","AGE_CONSTANTS","STAGE_PARAMETERS","label","maxVitality","startTurn","endTurn","insuranceMultiplier","challengeDifficultyModifier","Infinity","DREAM_CONSTANTS","AGE_ADJUSTMENTS","physical","intellectual","mixed","INSURANCE_CONSTANTS","TYPE_RATES","BALANCE_CONSTANTS","CARD_LIMITS","startingHandSize","defaultDrawCount","maxDeckSize","CHALLENGE_SETTINGS","minDifficulty","maxDifficulty","successBonusBase","failurePenaltyRatio","enableDynamicDifficulty","VITALITY_SETTINGS","defaultStarting","minimumValue","maximumValue","healingCap","PROGRESSION_SETTINGS","maxTurns","stageTransitionTurns","youthToMiddle","middleToFulfillment","victoryConditions","minTurns","minVitality","PERFORMANCE_CONSTANTS","CACHE_SETTINGS","stateSnapshotTTL","calculationCacheTTL","maxCacheEntries","OBJECT_POOL_LIMITS","maxPoolSize","initialPoolSize","PROCESSING_LIMITS","maxCardsPerSelection","maxInsuranceCards","maxHistoryEntries","GameConstantsAccessor","setOverrides","overrides","clearOverrides","getStageParameters","stageParameters","getDreamAgeAdjustment","getInsuranceTypeRate","getBalanceSettings","cardLimits","challengeSettings","vitalitySettings","progressionSettings","getPerformanceSettings","GameStageManager","checkStageProgression","turn","oldStage","newStage","settings","hasChanged","transitionMessage","upcomingTransition","getUpcomingTransitionMessage","turnsUntilMiddle","getStageVitalityLimit","turnsUntilFulfillment","getStageTransitionInfo","getStageDetails","info","stageName","vitalityLimit","characteristics","nextTransition","turnsRemaining","targetStage","atTurn","advanceStage","isCompleted","isFinalStage","_InsuranceExpirationManager","updateInsuranceExpirations","expiredInsurances","currentTurn","nowExpired","expiredCard","createExpirationNotice","getExpiringSoonInsurances","EXPIRING_SOON_THRESHOLD","getExpirationWarnings","expiredCards","turnNumber","expiredNames","message","showRenewalOption","InsuranceExpirationManager","AVAILABLE_CHARACTERS","initialVitalityModifier","specialAbility","AGE_PARAMETERS","ageMultiplier","middle_age","DREAM_AGE_ADJUSTMENTS","ChallengeResolutionService","resolveChallenge","challenge","cardManager","insuranceBurden","game","insuranceBonus","calculateInsuranceBonus","powerBreakdown","calculateTotalPower","playerPower","challengePower","getDreamRequiredPower","success","damageAmount","vitalityChange","powerDiff","overworkDamage","damageReduction","finalOverworkDamage","baseDamage","finalDamage","resultType","insurancePower","burden","adjustedPower","totalBonus","ageParams","GameTurnManager","stageManager","expirationManager","nextTurn","validateGameState","phase","checkVictoryCondition","status","newExpiredCount","remainingInsuranceCount","expirationResult","insuranceCost","vitality","applyDamage","e","error","expireAllInsurances","applyRecoveryInsuranceEffects","insuranceExpirations","completedAt","progressionResult","setStage","updateInsuranceBurden","totalHeal","heal","GameChallengeService","resolutionService","startChallenge","challengeCard","validatePhase","currentChallenge","getLearningHistory","newPower","updatedCard","validateChallenge","updateStatistics","updateVitality","challengeName","currentFailures","updateLearningHistory","finishGame","updateGameStateAfterChallenge","insuranceTypeChoices","variant","String","expectedPhase","totalChallenges","successfulChallenges","challengesCompleted","failedChallenges","challengesFailed","change","triggerInsuranceClaim","pendingInsuranceClaim","context","GameInsuranceService","premiumService","addInsurance","removeInsurance","selectInsuranceType","validateInsuranceSelection","findInsuranceChoice","selectedCard","addInsuranceCard","updatePlayerHistory","updateRiskProfile","completeInsuranceSelection","createSelectionResult","calculateInsuranceBurden","getRiskProfile","fallbackBurdenCalculation","burdenValue","abs","_insuranceBurden","_dirtyFlags","getRecommendedInsuranceBudget","cardsAcquired","durationText","activeInsuranceCount","getPlayerHistory","_playerHistory","newProfile","_riskProfile","ConservativeStrategy","selectChallenge","availableChallenges","easiestChallenge","a","b","currentPower","estimateCurrentPower","reason","successProbability","selectCards","availableCards","targetPower","otherCards","expectedPower","evaluateFitness","AggressiveStrategy","selectedChallenge","sortedCards","estimateHandStrength","handCards","BalancedStrategy","bestChoice","score","calculateRiskRewardScore","scoredCards","efficiency","calculateCardEfficiency","estimateCardCost","AdaptiveStrategy","strategies","bestStrategy","selectBestStrategy","strategy","fitness","AIStrategyFactory","createStrategy","factory","getAvailableTypes","Array","from","keys","getStrategyDescription","AIStrategyService","strategyType","currentStrategy","getCurrentStrategy","setStrategy","autoSelectChallenge","statisticsEnabled","autoSelectCards","recordDecision","challengeChoice","cardChoice","decisionHistory","getStatistics","totalDecisions","successRate","strategyUsage","successes","d","decision","setStatisticsEnabled","enabled","clearHistory","GameStateManager","events","maxEvents","addEventListener","eventType","listener","existingListeners","listeners","current","indexOf","notifyStateChange","previousValue","event","timestamp","addToHistory","notifyPhaseChange","previousPhase","newPhase","notifyStatusChange","previousStatus","newStatus","notifyStageChange","previousStage","notifyTurnChange","previousTurn","newTurn","getHistory","getHistoryByType","removeAllListeners","removeListenersForType","BaseActionProcessor","execute","input","validationResult","process","postProcess","DrawCardsProcessor","trouble","data","StartChallengeProcessor","StartChallengePhaseProcessor","startChallengePhase","ResolveChallengeProcessor","SelectInsuranceProcessor","BuyInsuranceProcessor","RemoveCardProcessor","SelectDreamProcessor","selectDream","GameActionProcessor","registerProcessor","actionType","processor","processors","executeAction","getAvailableActions","unregisterProcessor","_Vitality","DEFAULT_MAX_VITALITY","isFinite","getMax","decrease","amount","increase","getPercentage","isDepleted","isFull","withMaxVitality","newMaxVitality","adjustedValue","Vitality","_Game","gameState","totalInsuranceCount","lastUpdateTime","generateId","resolvedConfig","difficulty","startingVitality","dreamCardCount","balanceConfig","characterId","character","actualStartingVitality","actualMaxVitality","_vitality","premiumCalculationService","challengeResolutionService","turnManager","challengeService","insuranceService","aiStrategyService","_currentAIStrategy","stateManager","actionProcessor","setupStateListeners","dreamLeak","highestVitality","agingCards","_learningHistory","failures","getVitality","getInsuranceBurden","getAvailableVitality","currentTime","_cachedValues","getFreedomScore","maxBurden","freedom","isGameOver","hasAgingCardGameOver","checkAgingCardGameOverCondition","changeStatus","getAgingCardCount","start","startedAt","changePhase","selectCharacter","startVal","maxVal","actualMax","startDreamSelectionPhase","selectedDream","changeTurn","debug","card1","card2","modifiedChoices","recordChallengeResult","selectCard","skipInsuranceSelection","resolveInsuranceClaim","applyInsuranceEffect","declineInsuranceClaim","currentVitality","updateMaxVitalityForAge","currentValue","updateScore","advanceResult","changeStage","newCards","availableOnDemandInsurances","currentInsuranceTypeChoices","isInProgress","getExpiredInsurances","clearExpiredInsurances","getExpiringsSoonInsurances","insuranceScore","calculateCardPremium","addCardToHand","addCardToDiscardPile","addCardToPlayerDeck","clearHand","setHand","setPhase","getSnapshot","cardState","snapshot","OBJECT_POOLS","gameStates","Object","assign","handlePhaseChange","isWin","getStateManager","getActionProcessor","releaseSnapshot","key","getPerformanceStats","poolStats","challengeResults","cacheHitRate","dirtyFlags","setAIEnabled","_aiEnabled","isAIEnabled","setAIStrategy","getCurrentAIStrategy","getAIStatistics","aiSelectChallenge","aiSelectCards","aiAutoPlay","resetAISettings","Game"],"mappings":"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"}