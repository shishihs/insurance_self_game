var V=Object.defineProperty,R=Object.defineProperties;var _=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var C=(h,e,t)=>e in h?V(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t,g=(h,e)=>{for(var t in e||(e={}))G.call(e,t)&&C(h,t,e[t]);if(D)for(var t of D(e))L.call(e,t)&&C(h,t,e[t]);return h},P=(h,e)=>R(h,_(e));var r=(h,e,t)=>C(h,typeof e!="symbol"?e+"":e,t);var y=(h,e,t)=>new Promise((i,s)=>{var n=l=>{try{o(t.next(l))}catch(c){s(c)}},a=l=>{try{o(t.throw(l))}catch(c){s(c)}},o=l=>l.done?i(l.value):Promise.resolve(l.value).then(n,a);o((t=t.apply(h,e)).next())});import{f as A}from"./vue-vendor-Dh8Oc06C.js";import{T as w}from"./game-logic-DYTtuDyT.js";import{P as S}from"./phaser-core-DawqAqIN.js";import{P as B,M as F,G as H}from"./game-scenes-gl4Q2JUG.js";class N{constructor(e){r(this,"animations",new Map);r(this,"animationFrame",null);r(this,"performanceConfig");r(this,"animationSpeed",A(1));r(this,"isPaused",A(!1));r(this,"activeAnimationCount",A(0));this.performanceConfig=g({maxConcurrentAnimations:10,enableGPUAcceleration:!0,reducedMotion:window.matchMedia("(prefers-reduced-motion: reduce)").matches,targetFPS:60},e),window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",t=>{this.performanceConfig.reducedMotion=t.matches}),this.startAnimationLoop()}animate(e,t,i={}){var a,o;const s=this.generateAnimationId();if(this.activeAnimationCount.value>=this.performanceConfig.maxConcurrentAnimations)return console.warn("Maximum concurrent animations reached"),(a=i.onComplete)==null||a.call(i),s;if(this.performanceConfig.reducedMotion)return this.applyReducedMotionAnimation(e,t,i),(o=i.onComplete)==null||o.call(i),s;const n={id:s,element:e,type:t,config:g({duration:300,delay:0,easing:"cubic-bezier(0.4, 0, 0.2, 1)",intensity:"normal"},i),startTime:performance.now()+(i.delay||0),isRunning:!0};return this.performanceConfig.enableGPUAcceleration&&(e.style.willChange="transform, opacity"),this.animations.set(s,n),this.activeAnimationCount.value++,this.applyAnimationClass(e,t,n.config),s}createParticles(e,t,i,s=10){if(this.performanceConfig.reducedMotion)return;const n=this.getOrCreateParticleContainer();for(let a=0;a<s;a++){const o=document.createElement("div");o.className=`particle particle-${i}`,o.style.position="fixed",o.style.left=`${e}px`,o.style.top=`${t}px`,o.style.pointerEvents="none",o.style.zIndex="9999",this.customizeParticle(o,i,a),n.appendChild(o),this.animateParticle(o,i,a,()=>{o.remove()})}}transitionScene(e,t,i="fade",s="left"){return new Promise(n=>{if(this.performanceConfig.reducedMotion){e&&(e.style.display="none"),t.style.display="block",n();return}const a=400,o="cubic-bezier(0.4, 0, 0.2, 1)",l=t.parentElement;if(!l){n();return}l.style.position="relative",l.style.overflow="hidden",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.display="block",this.applySceneTransition(e,t,i,s,a,o),setTimeout(()=>{e&&(e.style.display="none",e.style.position="",e.style.transform="",e.style.opacity=""),t.style.position="",t.style.transform="",t.style.opacity="",l.style.position="",l.style.overflow="",n()},a)})}playVictoryAnimation(e){if(this.performanceConfig.reducedMotion){const o=document.createElement("div");o.className="victory-message-simple",o.textContent="ÂãùÂà©ÔºÅ",e.appendChild(o);return}const t=document.createElement("div");t.className="victory-overlay",e.appendChild(t);const i=document.createElement("div");i.className="victory-message",i.innerHTML=`
      <h1 class="victory-title">Victory!</h1>
      <p class="victory-subtitle">Á¥†Êô¥„Çâ„Åó„ÅÑÊà¶Áï•„Åß„Åó„ÅüÔºÅ</p>
    `,e.appendChild(i);const s=e.getBoundingClientRect(),n=s.left+s.width/2,a=s.top+s.height/2;for(let o=0;o<3;o++)setTimeout(()=>{this.createParticles(n,a,"celebration",20)},o*200);this.animate(t,"fadeIn",{duration:300}),this.animate(i,"scaleIn",{duration:600,delay:300,intensity:"high"}),setTimeout(()=>{this.animate(i,"scaleOut",{duration:300,onComplete:()=>i.remove()}),this.animate(t,"fadeOut",{duration:300,onComplete:()=>t.remove()})},3e3)}playDefeatAnimation(e){if(this.performanceConfig.reducedMotion){const s=document.createElement("div");s.className="defeat-message-simple",s.textContent="ÊïóÂåó...",e.appendChild(s);return}const t=document.createElement("div");t.className="defeat-overlay",e.appendChild(t);const i=document.createElement("div");i.className="defeat-message",i.innerHTML=`
      <h1 class="defeat-title">Game Over</h1>
      <p class="defeat-subtitle">Ê¨°Âõû„ÅØ„Åç„Å£„Å®Âãù„Å¶„Åæ„ÅôÔºÅ</p>
    `,e.appendChild(i),this.animate(t,"fadeIn",{duration:600,intensity:"low"}),this.animate(i,"slideIn",{duration:800,delay:300,direction:"down"}),setTimeout(()=>{this.animate(i,"fadeOut",{duration:300,onComplete:()=>i.remove()}),this.animate(t,"fadeOut",{duration:300,onComplete:()=>t.remove()})},3e3)}playCardEffect(e,t){if(this.performanceConfig.reducedMotion)return;const i=e.getBoundingClientRect(),s=i.left+i.width/2,n=i.top+i.height/2;switch(t){case"play":this.animate(e,"pulse",{duration:300,intensity:"normal"}),this.createParticles(s,n,"sparkle",5);break;case"draw":this.animate(e,"slideIn",{duration:400,direction:"up"});break;case"discard":this.animate(e,"fadeOut",{duration:300}),this.createParticles(s,n,"error",3);break;case"power":this.animate(e,"glow",{duration:600,loop:!0}),this.createParticles(s,n,"sparkle",8);break}}setAnimationSpeed(e){this.animationSpeed.value=Math.max(.1,Math.min(2,e)),document.documentElement.style.setProperty("--animation-speed-multiplier",e.toString())}pauseAll(){this.isPaused.value=!0,this.animations.forEach(e=>{e.element&&(e.element.style.animationPlayState="paused")})}resumeAll(){this.isPaused.value=!1,this.animations.forEach(e=>{e.element&&(e.element.style.animationPlayState="running")})}stop(e){const t=this.animations.get(e);t&&(this.cleanupAnimation(t),this.animations.delete(e),this.activeAnimationCount.value--)}stopAll(){this.animations.forEach(e=>{this.cleanupAnimation(e)}),this.animations.clear(),this.activeAnimationCount.value=0}destroy(){this.stopAll(),this.animationFrame&&cancelAnimationFrame(this.animationFrame);const e=document.getElementById("particle-container");e&&e.remove()}generateAnimationId(){return`anim-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}startAnimationLoop(){const e=()=>{this.isPaused.value||this.updateAnimations(),this.animationFrame=requestAnimationFrame(e)};e()}updateAnimations(){const e=performance.now(),t=[];this.animations.forEach((i,s)=>{var o,l;if(!i.isRunning)return;const n=e-i.startTime,a=(i.config.duration||300)/this.animationSpeed.value;n>=a&&(t.push(s),(l=(o=i.config).onComplete)==null||l.call(o))}),t.forEach(i=>{const s=this.animations.get(i);s&&(this.cleanupAnimation(s),this.animations.delete(i),this.activeAnimationCount.value--)})}applyAnimationClass(e,t,i){const s=(i.duration||300)/this.animationSpeed.value,n=i.delay||0,a=i.easing||"cubic-bezier(0.4, 0, 0.2, 1)";e.classList.remove(...Array.from(e.classList).filter(l=>l.startsWith("anim-")));const o=`anim-${t}-${i.intensity||"normal"}`;e.classList.add(o),e.style.animationDuration=`${s}ms`,e.style.animationDelay=`${n}ms`,e.style.animationTimingFunction=a,e.style.animationFillMode="both",i.loop&&(e.style.animationIterationCount="infinite")}applyReducedMotionAnimation(e,t,i){switch(t){case"fadeIn":e.style.opacity="1";break;case"fadeOut":e.style.opacity="0";break;case"scaleIn":e.style.transform="scale(1)";break;case"scaleOut":e.style.transform="scale(0)";break}}cleanupAnimation(e){if(e.element){e.element.style.willChange="",e.element.style.animationDuration="",e.element.style.animationDelay="",e.element.style.animationTimingFunction="",e.element.style.animationFillMode="",e.element.style.animationIterationCount="";const t=Array.from(e.element.classList).filter(i=>i.startsWith("anim-"));e.element.classList.remove(...t)}}getOrCreateParticleContainer(){let e=document.getElementById("particle-container");return e||(e=document.createElement("div"),e.id="particle-container",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="9999",document.body.appendChild(e)),e}customizeParticle(e,t,i){const s=8+Math.random()*8,n=this.getParticleHue(t);switch(e.style.width=`${s}px`,e.style.height=`${s}px`,e.style.backgroundColor=`hsl(${n}, 70%, 60%)`,e.style.borderRadius="50%",e.style.opacity="1",t){case"celebration":e.style.backgroundColor=`hsl(${Math.random()*360}, 80%, 60%)`,e.style.boxShadow=`0 0 ${s}px hsla(${n}, 80%, 60%, 0.5)`;break;case"sparkle":e.style.borderRadius="0",e.style.transform=`rotate(${Math.random()*360}deg)`,e.innerHTML="‚ú¶",e.style.fontSize=`${s}px`,e.style.backgroundColor="transparent",e.style.color=`hsl(${n}, 80%, 70%)`;break;case"coins":e.innerHTML="üí∞",e.style.fontSize=`${s*2}px`,e.style.backgroundColor="transparent";break}}getParticleHue(e){switch(e){case"success":return 120;case"error":return 0;case"celebration":return 45;case"sparkle":return 260;case"coins":return 45;default:return 200}}animateParticle(e,t,i,s){const n=Math.PI*2*i/10+Math.random()*.5,a=100+Math.random()*100,o=1e3+Math.random()*500,l=performance.now(),c=()=>{const u=(performance.now()-l)/o;if(u>=1){s();return}const p=a*u,k=Math.cos(n)*p,O=Math.sin(n)*p-u*u*200;e.style.transform=`translate(${k}px, ${O}px) scale(${1-u*.5})`,e.style.opacity=`${1-u}`,requestAnimationFrame(c)};c()}applySceneTransition(e,t,i,s,n,a){const o={slide:{left:{from:"translateX(100%)",to:"translateX(-100%)"},right:{from:"translateX(-100%)",to:"translateX(100%)"},up:{from:"translateY(100%)",to:"translateY(-100%)"},down:{from:"translateY(-100%)",to:"translateY(100%)"}},zoom:{from:"scale(0.8)",to:"scale(1.2)"}};t.style.transition=`all ${n}ms ${a}`,e&&(e.style.transition=`all ${n}ms ${a}`),i==="fade"?t.style.opacity="0":i==="slide"?t.style.transform=o.slide[s].from:i==="zoom"&&(t.style.transform=o.zoom.from,t.style.opacity="0"),requestAnimationFrame(()=>{i==="fade"?(t.style.opacity="1",e&&(e.style.opacity="0")):i==="slide"?(t.style.transform="translateX(0) translateY(0)",e&&(e.style.transform=o.slide[s].to)):i==="zoom"&&(t.style.transform="scale(1)",t.style.opacity="1",e&&(e.style.transform=o.zoom.to,e.style.opacity="0"))})}}let x=null;function j(){return x||(x=new N),x}const z={type:S.AUTO,parent:"game-container",backgroundColor:"#f5f5f5",scale:{mode:S.Scale.RESIZE,autoCenter:S.Scale.CENTER_BOTH,width:window.innerWidth,height:window.innerHeight,min:{width:320,height:480},max:{width:1920,height:1080}},physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},render:{pixelArt:!1,antialias:!0,powerPreference:"high-performance",transparent:!1,preserveDrawingBuffer:!1,failIfMajorPerformanceCaveat:!1},input:{touch:{target:null,capture:!1},activePointers:2,smoothFactor:0},audio:{disableWebAudio:!1,noAudio:!1},fps:{target:60,min:30,smoothStep:!0},scene:[]},T={CARD_WIDTH:120,CARD_HEIGHT:180,CARD_HOVER_SCALE:1.1,CARD_SPACING:20,CARD_MOVE_DURATION:200,HAND_Y_POSITION:550,CHALLENGE_Y_POSITION:200,DECK_X_POSITION:100,DECK_Y_POSITION:550,DISCARD_X_POSITION:1180,DISCARD_Y_POSITION:550,INITIAL_DRAW:5,STAGE_TURNS:{youth:10,middle:15,fulfillment:20},VICTORY_VITALITY:30,DRAG_DROP:{DRAG_ALPHA:.8,DRAG_SCALE:1.15,DROP_ZONE_SCALE:1.2,BOUNCE_DURATION:400,VIBRATION_DURATION:150,GLOW_PULSE_DURATION:1e3},COLORS:{DROP_ZONE_VALID:5361510,DROP_ZONE_INVALID:16739179}};class Q extends Phaser.Events.EventEmitter{constructor(t,i={}){super();r(this,"currentConfig",null);r(this,"progress",null);r(this,"state","idle");r(this,"options");r(this,"scene");r(this,"highlightGraphics",null);r(this,"overlayGraphics",null);r(this,"tutorialUI",null);r(this,"stepChangeTimeout",null);r(this,"highlightTween",null);this.scene=t,this.options=g({autoSaveProgress:!0,debugMode:!1,stepChangeDelay:300,defaultHighlightOptions:{color:"#FFD700",opacity:.3,borderWidth:3,borderColor:"#FFA500",glowEffect:!0,animationType:"pulse",duration:1e3},defaultOverlayOptions:{backgroundColor:"#000000",opacity:.7,blurBackground:!1,allowClickThrough:!1}},i),this.setupEventListeners()}setupEventListeners(){this.scene.events.once("destroy",()=>{this.cleanup()}),this.scene.scale.on("resize",()=>{this.state==="running"&&this.updateUILayout()})}startTutorial(t){return y(this,null,function*(){if(this.state==="running"){this.log("Tutorial is already running");return}try{this.currentConfig=t,this.progress=this.loadProgress(t.id)||this.createInitialProgress(),this.state="running",this.log(`Starting tutorial: ${t.name}`),this.emitEvent("tutorial:started",{tutorialId:t.id,progress:this.progress}),this.createOverlay(),yield this.goToStep(this.progress.currentStepIndex)}catch(i){this.handleError("Failed to start tutorial",i)}})}nextStep(){return y(this,null,function*(){if(!(this.state!=="running"||!this.currentConfig||!this.progress||!this.getCurrentStep()))try{yield this.completeCurrentStep(),this.progress.currentStepIndex<this.currentConfig.steps.length-1?yield this.goToStep(this.progress.currentStepIndex+1):yield this.completeTutorial()}catch(i){this.handleError("Failed to go to next step",i)}})}previousStep(){return y(this,null,function*(){this.state!=="running"||!this.progress||this.progress.currentStepIndex>0&&(yield this.goToStep(this.progress.currentStepIndex-1))})}goToStep(t){return y(this,null,function*(){var i;if(!(!this.currentConfig||!this.progress||t<0||t>=this.currentConfig.steps.length))try{this.progress.currentStepIndex!==t&&(yield this.exitCurrentStep()),this.progress.currentStepIndex=t;const s=this.currentConfig.steps[t];if(this.log(`Going to step ${t}: ${s.title}`),(i=s.skipCondition)!=null&&i.call(s)){yield this.skipCurrentStep();return}yield this.enterStep(s),this.options.autoSaveProgress&&this.saveProgress()}catch(s){this.handleError(`Failed to go to step ${t}`,s)}})}skipTutorial(){return y(this,null,function*(){if(!(this.state!=="running"||!this.currentConfig))try{this.log("Skipping tutorial"),this.state="skipped",this.emitEvent("tutorial:skipped",{tutorialId:this.currentConfig.id,progress:this.progress}),yield this.cleanup()}catch(t){this.handleError("Failed to skip tutorial",t)}})}skipCurrentStep(){return y(this,null,function*(){if(this.state!=="running"||!this.currentConfig||!this.progress)return;const t=this.getCurrentStep();if(t)try{this.log(`Skipping step: ${t.title}`),this.progress.skippedSteps.push(t.id),this.emitEvent("tutorial:step:skipped",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex}),yield this.nextStep()}catch(i){this.handleError("Failed to skip current step",i)}})}highlightElement(t,i={}){try{this.clearHighlight();const s=this.scene.children.getByName(t);if(!s){this.log(`Element not found: ${t}`);return}const n=g(g({},this.options.defaultHighlightOptions),i);this.createHighlight(s,n)}catch(s){this.handleError("Failed to highlight element",s)}}clearHighlight(){this.highlightGraphics&&(this.highlightGraphics.destroy(),this.highlightGraphics=null),this.highlightTween&&(this.highlightTween.destroy(),this.highlightTween=null)}saveProgress(){if(!(!this.currentConfig||!this.progress))try{const t=`${w.PROGRESS}_${this.currentConfig.id}`;localStorage.setItem(t,JSON.stringify(this.progress)),this.log("Progress saved")}catch(t){this.handleError("Failed to save progress",t)}}loadProgress(t){try{const i=`${w.PROGRESS}_${t}`,s=localStorage.getItem(i);if(s){const n=JSON.parse(s);return this.log("Progress loaded"),n}}catch(i){this.handleError("Failed to load progress",i)}return null}clearProgress(t){try{const i=`${w.PROGRESS}_${t}`;localStorage.removeItem(i),this.log("Progress cleared")}catch(i){this.handleError("Failed to clear progress",i)}}isCompleted(t){try{return this.getCompletedTutorials().includes(t)}catch(i){return this.handleError("Failed to check completion status",i),!1}}getState(){return this.state}getCurrentStep(){return!this.currentConfig||!this.progress?null:this.currentConfig.steps[this.progress.currentStepIndex]||null}getProgress(){return this.progress}enterStep(t){return y(this,null,function*(){try{this.log(`Entering step: ${t.title}`),t.onEnter&&t.onEnter(),this.emitEvent("tutorial:step:enter",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex,totalSteps:this.currentConfig.steps.length}),this.updateTutorialUI(t),t.targetElement&&this.highlightElement(t.targetElement,t.highlightOptions),t.action==="auto"&&t.waitTime&&(this.stepChangeTimeout=setTimeout(()=>{this.nextStep()},t.waitTime)),t.action==="wait_for_game_action"&&t.gameAction&&this.startGameActionValidation(t)}catch(i){this.handleError("Failed to enter step",i)}})}exitCurrentStep(){return y(this,null,function*(){const t=this.getCurrentStep();if(t)try{this.log(`Exiting step: ${t.title}`),this.stepChangeTimeout&&(clearTimeout(this.stepChangeTimeout),this.stepChangeTimeout=null);const i=this.scene.data.get("_tutorialValidationInterval"),s=this.scene.data.get("_tutorialValidationTimeout");i&&(clearInterval(i),this.scene.data.remove("_tutorialValidationInterval")),s&&(clearTimeout(s),this.scene.data.remove("_tutorialValidationTimeout")),this.clearHighlight(),t.onExit&&t.onExit(),this.emitEvent("tutorial:step:exit",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex})}catch(i){this.handleError("Failed to exit current step",i)}})}completeCurrentStep(){return y(this,null,function*(){const t=this.getCurrentStep();if(!(!t||!this.progress))try{this.log(`Completing step: ${t.title}`),this.progress.completedSteps.includes(t.id)||this.progress.completedSteps.push(t.id),this.emitEvent("tutorial:step:completed",{tutorialId:this.currentConfig.id,stepId:t.id,stepIndex:this.progress.currentStepIndex})}catch(i){this.handleError("Failed to complete current step",i)}})}startGameActionValidation(t){if(!t.gameAction)return;const{type:i,validation:s,timeout:n=3e4}=t.gameAction;this.log(`Starting game action validation: ${i}`);const a=setInterval(()=>{try{const l=window.__gameState||this.scene.data.get("gameState");if(!l){this.logDebug("Game state not available yet");return}s(l)&&(this.log(`Game action validated: ${i}`),clearInterval(a),clearTimeout(o),this.scene.data.remove("_tutorialValidationInterval"),this.scene.data.remove("_tutorialValidationTimeout"),this.nextStep())}catch(l){this.handleError("Error during game action validation",l)}},250),o=setTimeout(()=>{clearInterval(a),this.log(`Game action validation timeout: ${i}`),this.scene.data.remove("_tutorialValidationInterval"),this.scene.data.remove("_tutorialValidationTimeout"),this.emit("tutorial:action:timeout",{step:t,actionType:i})},n);this.scene.data.set("_tutorialValidationInterval",a),this.scene.data.set("_tutorialValidationTimeout",o)}completeTutorial(){return y(this,null,function*(){if(!(!this.currentConfig||!this.progress))try{this.log("Completing tutorial"),this.progress.isCompleted=!0,this.progress.completedAt=new Date,this.state="completed",this.markAsCompleted(this.currentConfig.id),this.emitEvent("tutorial:completed",{tutorialId:this.currentConfig.id,progress:this.progress}),this.options.autoSaveProgress&&this.saveProgress(),yield this.cleanup()}catch(t){this.handleError("Failed to complete tutorial",t)}})}createOverlay(){if(!this.currentConfig)return;const t=g(g({},this.options.defaultOverlayOptions),this.currentConfig.overlayOptions);this.overlayGraphics=this.scene.add.graphics(),this.overlayGraphics.setDepth(1e3),this.overlayGraphics.fillStyle(Phaser.Display.Color.HexStringToColor(t.backgroundColor).color,t.opacity),this.overlayGraphics.fillRect(0,0,this.scene.cameras.main.width,this.scene.cameras.main.height),t.allowClickThrough||this.overlayGraphics.setInteractive(new Phaser.Geom.Rectangle(0,0,this.scene.cameras.main.width,this.scene.cameras.main.height),Phaser.Geom.Rectangle.Contains)}createHighlight(t,i){if(!t.getBounds)return;const s=t.getBounds();this.highlightGraphics=this.scene.add.graphics(),this.highlightGraphics.setDepth(1001),i.color&&(this.highlightGraphics.fillStyle(Phaser.Display.Color.HexStringToColor(i.color).color,i.opacity||.3),this.highlightGraphics.fillRect(s.x,s.y,s.width,s.height)),i.borderColor&&i.borderWidth&&(this.highlightGraphics.lineStyle(i.borderWidth,Phaser.Display.Color.HexStringToColor(i.borderColor).color),this.highlightGraphics.strokeRect(s.x,s.y,s.width,s.height)),i.animationType&&i.animationType!=="none"&&this.createHighlightAnimation(i)}createHighlightAnimation(t){if(!this.highlightGraphics)return;const i=t.duration||1e3;switch(t.animationType){case"pulse":this.highlightTween=this.scene.tweens.add({targets:this.highlightGraphics,alpha:{from:1,to:.3},duration:i/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});break;case"glow":this.highlightTween=this.scene.tweens.add({targets:this.highlightGraphics,scaleX:{from:1,to:1.1},scaleY:{from:1,to:1.1},alpha:{from:1,to:.7},duration:i/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});break}}updateTutorialUI(t){this.log(`UI Update: ${t.title} - ${t.description}`)}updateUILayout(){}createInitialProgress(){var t;return{currentStepIndex:0,completedSteps:[],skippedSteps:[],isCompleted:!1,startedAt:new Date,lastPlayedVersion:(t=this.currentConfig)==null?void 0:t.version}}getCompletedTutorials(){try{const t=localStorage.getItem(w.COMPLETED_TUTORIALS);return t?JSON.parse(t):[]}catch(t){return this.handleError("Failed to get completed tutorials",t),[]}}markAsCompleted(t){try{const i=this.getCompletedTutorials();i.includes(t)||(i.push(t),localStorage.setItem(w.COMPLETED_TUTORIALS,JSON.stringify(i)))}catch(i){this.handleError("Failed to mark as completed",i)}}emitEvent(t,i){this.emit(t,i),this.options.debugMode}handleError(t,i){var s;this.log(`Error: ${t} - ${i.message}`),this.state="error",this.emitEvent("tutorial:error",{tutorialId:((s=this.currentConfig)==null?void 0:s.id)||"unknown",error:i.message})}log(t){this.options.debugMode}cleanup(){return y(this,null,function*(){try{this.stepChangeTimeout&&(clearTimeout(this.stepChangeTimeout),this.stepChangeTimeout=null),this.clearHighlight(),this.overlayGraphics&&(this.overlayGraphics.destroy(),this.overlayGraphics=null),this.tutorialUI&&(this.tutorialUI.destroy(),this.tutorialUI=null),this.state="idle"}catch(t){this.handleError("Failed to cleanup",t)}})}destroy(){this.cleanup(),this.removeAllListeners()}}class J{constructor(e){r(this,"scene");r(this,"container");r(this,"overlayGraphics");r(this,"spotlightMask");r(this,"speechBubble",null);r(this,"progressBar",null);r(this,"controlButtons",null);r(this,"highlightElements",new Map);r(this,"arrows",[]);r(this,"pulseAnimations",[]);r(this,"OVERLAY_ALPHA",.7);r(this,"SPOTLIGHT_RADIUS",80);r(this,"SPEECH_BUBBLE_PADDING",20);r(this,"ANIMATION_DURATION",800);r(this,"BUTTON_HEIGHT",48);r(this,"BUTTON_WIDTH",120);this.scene=e,this.container=e.add.container(0,0),this.container.setDepth(2e3),this.overlayGraphics=e.add.graphics(),this.spotlightMask=e.add.graphics(),this.container.add([this.overlayGraphics,this.spotlightMask]),this.createBaseOverlay()}createBaseOverlay(){const e=this.scene.cameras.main;this.overlayGraphics.clear(),this.overlayGraphics.fillStyle(0,this.OVERLAY_ALPHA),this.overlayGraphics.fillRect(0,0,e.width,e.height),this.overlayGraphics.setInteractive(new Phaser.Geom.Rectangle(0,0,e.width,e.height),Phaser.Geom.Rectangle.Contains)}createSpotlight(e){if(!e.getBounds)return;const t=e.getBounds(),i=this.scene.cameras.main;this.spotlightMask.clear(),this.spotlightMask.fillStyle(0,this.OVERLAY_ALPHA),this.spotlightMask.fillRect(0,0,i.width,i.height);const s=t.centerX,n=t.centerY,a=Math.max(t.width,t.height)/2+this.SPOTLIGHT_RADIUS;this.spotlightMask.fillStyle(0,0),this.spotlightMask.fillCircle(s,n,a),this.overlayGraphics.setMask(new Phaser.Display.Masks.GeometryMask(this.scene,this.spotlightMask))}createSpeechBubble(e,t){this.speechBubble&&this.speechBubble.destroy();const i=this.scene.cameras.main,s=Math.min(400,i.width-40);this.speechBubble=this.scene.add.container(0,0);const n=this.scene.add.graphics();n.fillStyle(16777215,.95),n.lineStyle(2,3355443,1);const a=this.scene.add.text(0,0,e.title,{fontSize:"18px",fontFamily:"Arial, sans-serif",color:"#333333",fontStyle:"bold",wordWrap:{width:s-this.SPEECH_BUBBLE_PADDING*2}}),o=this.scene.add.text(0,0,e.description,{fontSize:"14px",fontFamily:"Arial, sans-serif",color:"#666666",wordWrap:{width:s-this.SPEECH_BUBBLE_PADDING*2}}),l=a.height,c=o.height,d=l+c+this.SPEECH_BUBBLE_PADDING*3,u=s,p=12;n.fillRoundedRect(-u/2,-d/2,u,d,p),n.strokeRoundedRect(-u/2,-d/2,u,d,p),a.setPosition(-u/2+this.SPEECH_BUBBLE_PADDING,-d/2+this.SPEECH_BUBBLE_PADDING),o.setPosition(-u/2+this.SPEECH_BUBBLE_PADDING,a.y+l+this.SPEECH_BUBBLE_PADDING/2),this.speechBubble.add([n,a,o]),this.positionSpeechBubble(e.position||"bottom",t),this.speechBubble.setAlpha(0),this.speechBubble.setScale(.8),this.scene.tweens.add({targets:this.speechBubble,alpha:1,scaleX:1,scaleY:1,duration:this.ANIMATION_DURATION/2,ease:"Back.easeOut"}),this.container.add(this.speechBubble)}positionSpeechBubble(e,t){if(!this.speechBubble)return;const i=this.scene.cameras.main,s=this.speechBubble.getBounds(),n=20;let a=i.centerX,o=i.centerY;if(t)switch(e){case"top":a=t.centerX,o=t.top-s.height/2-n;break;case"bottom":a=t.centerX,o=t.bottom+s.height/2+n;break;case"left":a=t.left-s.width/2-n,o=t.centerY;break;case"right":a=t.right+s.width/2+n,o=t.centerY;break;case"center":a=i.centerX,o=i.centerY;break}a=Phaser.Math.Clamp(a,s.width/2+n,i.width-s.width/2-n),o=Phaser.Math.Clamp(o,s.height/2+n,i.height-s.height/2-n),this.speechBubble.setPosition(a,o)}createProgressBar(e,t){this.progressBar&&this.progressBar.destroy();const i=this.scene.cameras.main;this.progressBar=this.scene.add.container(i.centerX,50);const s=300,n=8,a=e.currentStepIndex+1,o=this.scene.add.graphics();o.fillStyle(3355443,.3),o.fillRoundedRect(-s/2,-n/2,s,n,4);const l=a/t*s,c=this.scene.add.graphics();c.fillStyle(5025616,1),c.fillRoundedRect(-s/2,-n/2,l,n,4);const d=this.scene.add.text(0,-30,`„Çπ„ÉÜ„ÉÉ„Éó ${a} / ${t}`,{fontSize:"14px",fontFamily:"Arial, sans-serif",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5);this.progressBar.add([o,c,d]),this.container.add(this.progressBar)}createControlButtons(e,t,i,s,n){this.controlButtons&&this.controlButtons.destroy();const a=this.scene.cameras.main;this.controlButtons=this.scene.add.container(a.centerX,a.height-80);const o=[];let l=0;if(e&&s){const u=this.createButton("Êàª„Çã","#6c757d",s);o.push(u),l+=this.BUTTON_WIDTH+10}const c=this.createButton("Ê¨°„Å∏","#007bff",i);if(o.push(c),l+=this.BUTTON_WIDTH+10,t&&n){const u=this.createButton("„Çπ„Ç≠„ÉÉ„Éó","#dc3545",n);o.push(u),l+=this.BUTTON_WIDTH+10}let d=-l/2;o.forEach(u=>{u.setPosition(d+this.BUTTON_WIDTH/2,0),d+=this.BUTTON_WIDTH+10,this.controlButtons.add(u)}),this.container.add(this.controlButtons)}createButton(e,t,i){const s=this.scene.add.container(0,0),n=this.scene.add.graphics(),a=parseInt(t.substring(1),16);n.fillStyle(a,1),n.fillRoundedRect(-this.BUTTON_WIDTH/2,-this.BUTTON_HEIGHT/2,this.BUTTON_WIDTH,this.BUTTON_HEIGHT,8);const o=this.scene.add.graphics();o.fillStyle(a,.8),o.fillRoundedRect(-this.BUTTON_WIDTH/2,-this.BUTTON_HEIGHT/2,this.BUTTON_WIDTH,this.BUTTON_HEIGHT,8),o.setVisible(!1);const l=this.scene.add.text(0,0,e,{fontSize:"16px",fontFamily:"Arial, sans-serif",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);return s.add([n,o,l]),s.setSize(this.BUTTON_WIDTH,this.BUTTON_HEIGHT),s.setInteractive(),s.on("pointerover",()=>{n.setVisible(!1),o.setVisible(!0),this.scene.tweens.add({targets:s,scaleX:1.05,scaleY:1.05,duration:150,ease:"Power2"})}),s.on("pointerout",()=>{n.setVisible(!0),o.setVisible(!1),this.scene.tweens.add({targets:s,scaleX:1,scaleY:1,duration:150,ease:"Power2"})}),s.on("pointerdown",()=>{this.scene.tweens.add({targets:s,scaleX:.95,scaleY:.95,duration:100,yoyo:!0,ease:"Power2",onComplete:i})}),s}highlightElement(e,t={}){var l;const i=this.scene.children.getByName(e);if(!(i!=null&&i.getBounds))return;const s=i.getBounds(),n=this.scene.add.graphics();n.setDepth(1999);const o=g(g({},{color:"#FFD700",opacity:.4,borderWidth:3,borderColor:"#FFA500",glowEffect:!0,animationType:"pulse",duration:1e3}),t);if(o.color){const c=parseInt(o.color.substring(1),16);n.fillStyle(c,o.opacity||.4),n.fillRect(s.x,s.y,s.width,s.height)}if(o.borderColor&&o.borderWidth){const c=parseInt(o.borderColor.substring(1),16);n.lineStyle(o.borderWidth,c),n.strokeRect(s.x,s.y,s.width,s.height)}if(o.glowEffect){const c=this.scene.add.graphics();c.setDepth(1998);const d=parseInt(((l=o.borderColor)==null?void 0:l.substring(1))||"FFA500",16);c.lineStyle(8,d,.3),c.strokeRect(s.x-4,s.y-4,s.width+8,s.height+8),this.highlightElements.set(`${e}_glow`,c)}if(o.animationType!=="none"){const c=this.createHighlightAnimation(n,o);c&&this.pulseAnimations.push(c)}this.highlightElements.set(e,n)}createHighlightAnimation(e,t){const i=t.duration||1e3;switch(t.animationType){case"pulse":return this.scene.tweens.add({targets:e,alpha:{from:1,to:.3},duration:i/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});case"glow":return this.scene.tweens.add({targets:e,scaleX:{from:1,to:1.1},scaleY:{from:1,to:1.1},alpha:{from:1,to:.7},duration:i/2,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});case"border":return this.scene.tweens.add({targets:e,rotation:{from:0,to:Math.PI*2},duration:i,repeat:-1,ease:"Linear"});default:return null}}createArrow(e,t,i,s,n="#FFD700"){const a=Phaser.Math.Angle.Between(e,t,i,s),o=Phaser.Math.Distance.Between(e,t,i,s),l=e+Math.cos(a)*(o*.7),c=t+Math.sin(a)*(o*.7),d=this.scene.add.graphics();d.setDepth(2001);const u=parseInt(n.substring(1),16);d.fillStyle(u,1),d.beginPath(),d.moveTo(0,-10),d.lineTo(20,0),d.lineTo(0,10),d.closePath(),d.fillPath(),d.setPosition(l,c),d.setRotation(a),this.scene.tweens.add({targets:d,scaleX:{from:1,to:1.2},scaleY:{from:1,to:1.2},alpha:{from:1,to:.7},duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.arrows.push(d)}clearHighlights(){this.highlightElements.forEach(e=>e.destroy()),this.highlightElements.clear(),this.pulseAnimations.forEach(e=>e.destroy()),this.pulseAnimations=[],this.arrows.forEach(e=>e.destroy()),this.arrows=[]}onResize(){if(this.createBaseOverlay(),this.updateResponsiveLayout(),this.spotlightMask&&this.highlightElements.size>0){const e=this.highlightElements.values().next().value;if(e!=null&&e.getBounds){const t=e.getBounds(),i={getBounds:()=>t};this.createSpotlight(i)}}}enableKeyboardControls(e,t,i){var n,a,o,l,c,d,u;const s=(n=this.scene.input.keyboard)==null?void 0:n.createCursorKeys();if(s){(a=this.scene.input.keyboard)==null||a.on("keydown-SPACE",e),(o=this.scene.input.keyboard)==null||o.on("keydown-ENTER",e),t&&((l=this.scene.input.keyboard)==null||l.on("keydown-BACKSPACE",t),s.left.on("down",t)),i&&((c=this.scene.input.keyboard)==null||c.on("keydown-ESC",i)),s.right.on("down",e),(d=this.scene.input.keyboard)==null||d.on("keydown-TAB",p=>{p.preventDefault(),this.cycleButtonFocus()});for(let p=1;p<=9;p++)(u=this.scene.input.keyboard)==null||u.on(`keydown-${p}`,()=>{this.jumpToStep(p-1)})}}cycleButtonFocus(){if(this.controlButtons){const e=this.controlButtons.list;if(e.length>0){const t=e[0];this.scene.tweens.add({targets:t,scaleX:1.1,scaleY:1.1,duration:200,yoyo:!0,ease:"Power2"})}}}jumpToStep(e){}updateResponsiveLayout(){const e=this.scene.cameras.main,t=e.width<768;e.width<480?this.applyMobileLayout():t?this.applyTabletLayout():this.applyDesktopLayout()}applyMobileLayout(){const e=this.scene.cameras.main,t=56,i=Math.min(150,e.width/3-10);if(this.progressBar&&this.progressBar.setPosition(e.centerX,30),this.speechBubble){const s=e.width-20;this.repositionSpeechBubbleForMobile(s)}this.controlButtons&&(this.controlButtons.setPosition(e.centerX,e.height-40),this.adjustButtonSizesForMobile(i,t))}applyTabletLayout(){const e=this.scene.cameras.main,t=52,i=140;this.progressBar&&this.progressBar.setPosition(e.centerX,40),this.controlButtons&&(this.controlButtons.setPosition(e.centerX,e.height-60),this.adjustButtonSizes(i,t))}applyDesktopLayout(){const e=this.scene.cameras.main;this.progressBar&&this.progressBar.setPosition(e.centerX,50),this.controlButtons&&this.controlButtons.setPosition(e.centerX,e.height-80)}repositionSpeechBubbleForMobile(e){if(!this.speechBubble)return;const t=this.scene.cameras.main;this.speechBubble.setPosition(t.centerX,t.height*.3),this.speechBubble.list.filter(s=>s instanceof Phaser.GameObjects.Text).forEach(s=>{s.setWordWrapWidth(e-this.SPEECH_BUBBLE_PADDING*2)})}adjustButtonSizesForMobile(e,t){if(!this.controlButtons)return;this.controlButtons.list.forEach((s,n)=>{const a=s.list[0];a&&(a.clear(),a.fillStyle(31743,1),a.fillRoundedRect(-e/2,-t/2,e,t,8));const o=s.list.find(l=>l instanceof Phaser.GameObjects.Text);o&&o.setFontSize("18px"),s.setPosition((n-1)*(e+15),0)})}adjustButtonSizes(e,t){if(!this.controlButtons)return;this.controlButtons.list.forEach(s=>{const n=s.list[0];n&&(n.clear(),n.fillStyle(31743,1),n.fillRoundedRect(-e/2,-t/2,e,t,8))})}announceForScreenReader(e){const t=this.scene.add.text(-1e3,-1e3,e,{fontSize:"1px",color:"#000000"}),i=this.scene.game.canvas;i&&(i.setAttribute("aria-label",e),this.scene.time.delayedCall(1e3,()=>{t.destroy(),i.removeAttribute("aria-label")}))}enableHighContrastMode(){this.overlayGraphics.clear(),this.overlayGraphics.fillStyle(0,.9);const e=this.scene.cameras.main;this.overlayGraphics.fillRect(0,0,e.width,e.height),this.highlightElements.forEach(t=>{t.clear(),t.fillStyle(16776960,.7),t.lineStyle(4,16711680,1)})}enableReducedMotion(){this.pulseAnimations.forEach(e=>{e.stop()}),this.pulseAnimations=[],this.highlightElements.forEach(e=>{e.setAlpha(.6)})}setVisible(e){this.container.setVisible(e)}destroy(){var e;this.clearHighlights(),(e=this.scene.input.keyboard)==null||e.removeAllListeners(),this.container.destroy()}}function ee(h){}const te={id:"interactive_game_tutorial",name:"‰∫∫ÁîüÂÖÖÂÆü„Ç≤„Éº„É†ÂÖ•ÈñÄ",description:"ÂÆüÈöõ„Å´„Ç≤„Éº„É†„Çí„Éó„É¨„Ç§„Åó„Å™„Åå„ÇâÂü∫Êú¨ÁöÑ„Å™Êìç‰Ωú„ÇíÂ≠¶„Å≥„Åæ„Åô",version:"2.0.0",autoStart:!1,canSkip:!0,showProgress:!0,overlayOptions:{backgroundColor:"#000000",opacity:.6,blurBackground:!1,allowClickThrough:!0},steps:[{id:"welcome",title:"„Çà„ÅÜ„Åì„Åù„ÄÅ‰∫∫ÁîüÂÖÖÂÆü„Ç≤„Éº„É†„Å∏ÔºÅ",description:`„Åì„ÅÆ„Ç≤„Éº„É†„Åß„ÅØ„ÄÅ‰øùÈô∫„ÇíÊ¥ªÁî®„Åó„Å™„Åå„Çâ‰∫∫Áîü„ÅÆÊßò„ÄÖ„Å™ÊåëÊà¶„Çí‰πó„ÇäË∂ä„Åà„ÄÅÂ§¢„ÇíÂÆüÁèæ„Åô„Çã„Åì„Å®„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇ

ÂÆüÈöõ„Å´„Ç≤„Éº„É†„Çí„Éó„É¨„Ç§„Åó„Å™„Åå„Çâ„ÄÅÂü∫Êú¨ÁöÑ„Å™Êìç‰Ωú„ÇíÂ≠¶„Çì„Åß„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜÔºÅ`,position:"center",action:"click",highlightOptions:{animationType:"none"}},{id:"vitality_explanation",title:"Ê¥ªÂäõÔºà„Éê„Ç§„Çø„É™„ÉÜ„Ç£Ôºâ„Å´„Å§„ÅÑ„Å¶",description:`„Åì„ÅÆÁ∑ë„ÅÆ„Éê„Éº„Åå„ÅÇ„Å™„Åü„ÅÆÊ¥ªÂäõ„Åß„Åô„ÄÇ

Ê¥ªÂäõ„ÅØ‰∫∫Áîü„ÅÆÊåëÊà¶„Å´Á´ã„Å°Âêë„Åã„ÅÜ„Ç®„Éç„É´„ÇÆ„Éº„ÇíË°®„Åó„ÄÅ0„Å´„Å™„Çã„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Åß„Åô„ÄÇ

ÁèæÂú®„ÅÆÊ¥ªÂäõ: 20/35`,targetElement:"vitality-bar",position:"bottom",action:"click",highlightOptions:{color:"#00FF00",opacity:.4,borderWidth:3,borderColor:"#00AA00",glowEffect:!0,animationType:"pulse",duration:1e3}},{id:"hand_cards_explanation",title:"ÊâãÊú≠„Å´„Å§„ÅÑ„Å¶",description:`„Åì„Åì„Åå„ÅÇ„Å™„Åü„ÅÆÊâãÊú≠„Åß„Åô„ÄÇ

‰∫∫Áîü„Ç´„Éº„ÉâÔºàÈùíÔºâ„Å®‰øùÈô∫„Ç´„Éº„ÉâÔºàÁ∑ëÔºâ„Åå„ÅÇ„Çä„ÄÅ„Åì„Çå„Çâ„Çí‰Ωø„Å£„Å¶Êßò„ÄÖ„Å™ÊåëÊà¶„Å´Á´ã„Å°Âêë„Åã„ÅÑ„Åæ„Åô„ÄÇ`,targetElement:"hand-area",position:"top",action:"click",highlightOptions:{color:"#FFD700",opacity:.3,borderWidth:4,borderColor:"#FFA500",glowEffect:!0,animationType:"glow"}},{id:"draw_card_instruction",title:"ÊúÄÂàù„ÅÆ„Ç´„Éº„Éâ„ÇíÂºï„ÅÑ„Å¶„Åø„Åæ„Åó„Çá„ÅÜ",description:`„Äå„Ç´„Éº„Éâ„ÇíÂºï„Åè„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„Çí1ÊûöÂºï„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Ç´„Éº„Éâ„ÇíÂºï„Åè„Åì„Å®„Åß„ÄÅÊñ∞„Åü„Å™ÈÅ∏ÊäûËÇ¢„ÅåÂ¢ó„Åà„Åæ„Åô„ÄÇ`,targetElement:"draw-button",position:"left",action:"wait_for_game_action",gameAction:{type:"draw_card",validation:h=>{const e=h.hand,t=h.config;return e.length>t.startingHandSize}},highlightOptions:{color:"#4CAF50",opacity:.5,borderWidth:4,borderColor:"#2E7D32",glowEffect:!0,animationType:"pulse",duration:800}},{id:"draw_success",title:"„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ",description:`Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÂºï„Åç„Åæ„Åó„Åü„ÄÇ

ÊâãÊú≠„ÅåÂ¢ó„Åà„Çã„Å®„ÄÅ„Çà„ÇäÂ§ö„Åè„ÅÆÊà¶Áï•„ÇíÁ´ã„Å¶„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ`,position:"center",action:"auto",waitTime:3e3,highlightOptions:{animationType:"none"}},{id:"challenge_explanation",title:"„ÉÅ„É£„É¨„É≥„Ç∏„Ç´„Éº„Éâ„ÅåÁèæ„Çå„Åæ„Åó„Åü",description:`„Åì„Çå„Åå„Äå„ÉÅ„É£„É¨„É≥„Ç∏„Ç´„Éº„Éâ„Äç„Åß„Åô„ÄÇ

‰∫∫Áîü„Å´„ÅØÊßò„ÄÖ„Å™ÊåëÊà¶„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊâãÊú≠„ÅÆ„Ç´„Éº„Éâ„Çí‰Ωø„Å£„Å¶„ÄÅ„Åì„Çå„Çâ„ÅÆÊåëÊà¶„Çí‰πó„ÇäË∂ä„Åà„Åæ„Åó„Çá„ÅÜ„ÄÇ`,targetElement:"challenge-area",position:"bottom",action:"click",highlightOptions:{color:"#FF6B6B",opacity:.4,borderWidth:4,borderColor:"#FF4444",glowEffect:!0,animationType:"pulse"}},{id:"select_cards_instruction",title:"„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„ÉÅ„É£„É¨„É≥„Ç∏„Å´ÊåëÊà¶",description:`„ÉÅ„É£„É¨„É≥„Ç∏„Å´ÂøÖË¶Å„Å™„Éë„ÉØ„Éº‰ª•‰∏ä„Å´„Å™„Çã„Çà„ÅÜ„ÄÅÊâãÊú≠„Åã„Çâ„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë§áÊï∞„ÅÆ„Ç´„Éº„Éâ„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ

„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„Åæ„Åó„Çá„ÅÜÔºÅ`,targetElement:"hand-area",position:"top",action:"wait_for_game_action",gameAction:{type:"select_cards",validation:h=>h.selectedCards.length>0},highlightOptions:{color:"#FFD700",opacity:.4,borderWidth:3,borderColor:"#FFA500",animationType:"glow"}},{id:"resolve_challenge_instruction",title:"„ÉÅ„É£„É¨„É≥„Ç∏„Å´ÊåëÊà¶ÔºÅ",description:`„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Åü„Çâ„ÄÅ„Äå„ÉÅ„É£„É¨„É≥„Ç∏„Å´Êåë„ÇÄ„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ

ÈÅ∏Êäû„Åó„Åü„Ç´„Éº„Éâ„ÅÆÂêàË®à„Éë„ÉØ„Éº„Åå„ÉÅ„É£„É¨„É≥„Ç∏„Å´ÂøÖË¶Å„Å™„Éë„ÉØ„Éº‰ª•‰∏ä„Å™„ÇâÊàêÂäü„Åß„ÅôÔºÅ`,targetElement:"resolve-button",position:"left",action:"wait_for_game_action",gameAction:{type:"resolve_challenge",validation:h=>h.phase==="resolution"||h.phase==="card_selection"},highlightOptions:{color:"#2196F3",opacity:.5,borderWidth:4,borderColor:"#1976D2",glowEffect:!0,animationType:"pulse"}},{id:"insurance_selection",title:"‰øùÈô∫„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Çá„ÅÜ",description:`„ÉÅ„É£„É¨„É≥„Ç∏ÊàêÂäüÔºÅÂ†±ÈÖ¨„Å®„Åó„Å¶‰øùÈô∫„Ç´„Éº„Éâ„Çí1ÊûöÈÅ∏„Åπ„Åæ„Åô„ÄÇ

‰øùÈô∫„ÅØÂ∞ÜÊù•„ÅÆÊåëÊà¶„Å´ÂÇô„Åà„ÇãÈáçË¶Å„Å™Ë¶ÅÁ¥†„Åß„Åô„ÄÇ

3Êûö„ÅÆ‰∏≠„Åã„Çâ1Êûö„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ`,targetElement:"card-selection-ui",position:"center",action:"wait_for_game_action",gameAction:{type:"select_reward_card",validation:h=>h.phase==="resolution"},skipCondition:()=>{var e;const h=window.__gameState;return((e=h==null?void 0:h.lastChallengeResult)==null?void 0:e.success)===!1},highlightOptions:{color:"#4CAF50",opacity:.3,animationType:"glow"}},{id:"end_turn_instruction",title:"„Çø„Éº„É≥„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Çá„ÅÜ",description:`„ÉÅ„É£„É¨„É≥„Ç∏„ÅåÁµÇ„Çè„Å£„Åü„Çâ„ÄÅ„Äå„Çø„Éº„É≥ÁµÇ‰∫Ü„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ê¨°„ÅÆ„Çø„Éº„É≥„Å´ÈÄ≤„Åø„Åæ„Åô„ÄÇ

Êñ∞„Åó„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏„ÅåÁèæ„Çå„ÄÅ„Ç≤„Éº„É†„ÅåÈÄ≤Ë°å„Åó„Åæ„Åô„ÄÇ`,targetElement:"end-turn-button",position:"left",action:"wait_for_game_action",gameAction:{type:"end_turn",validation:h=>h.turn>1},highlightOptions:{color:"#9C27B0",opacity:.5,borderWidth:4,borderColor:"#7B1FA2",glowEffect:!0,animationType:"pulse"}},{id:"insurance_effects",title:"‰øùÈô∫„ÅÆÂäπÊûú„Å´„Å§„ÅÑ„Å¶",description:`‰øùÈô∫„Ç´„Éº„Éâ„ÅØ„ÉÅ„É£„É¨„É≥„Ç∏ÊôÇ„Å´„Éú„Éº„Éä„Çπ„Éë„ÉØ„Éº„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ

Âπ¥ÈΩ¢„Åå‰∏ä„Åå„Çã„Åª„Å©‰øùÈô∫„ÅÆÂäπÊûú„ÇÇÈ´ò„Åæ„Çä„Åæ„Åô„Åå„ÄÅ‰øùÈô∫„ÅåÂ§ö„Åô„Åé„Çã„Å®Ë≤†ÊãÖÔºà-„Éë„ÉØ„ÉºÔºâ„ÇÇÁô∫Áîü„Åó„Åæ„Åô„ÄÇ

„Éê„É©„É≥„Çπ„ÅåÈáçË¶Å„Åß„ÅôÔºÅ`,targetElement:"insurance-list",position:"left",action:"click",highlightOptions:{color:"#00BCD4",opacity:.4,borderWidth:3,borderColor:"#0097A7",animationType:"pulse"}},{id:"basic_strategy",title:"Âü∫Êú¨ÁöÑ„Å™Êà¶Áï•",description:`ÊàêÂäü„ÅÆ„Ç≥„ÉÑÔºö

1. Ê¥ªÂäõ„ÇíÁÆ°ÁêÜ„Åó„Å™„Åå„ÇâÊåëÊà¶„Åô„Çã
2. ‰øùÈô∫„ÇíÈÅ©Âàá„Å´ÈÅ∏Êäû„ÉªÊ¥ªÁî®„Åô„Çã
3. „Ç´„Éº„Éâ„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÂ∑•Â§´„Åô„Çã
4. Âπ¥ÈΩ¢„Å´Âøú„Åò„ÅüÊà¶Áï•„ÇíÁ´ã„Å¶„Çã`,position:"center",action:"click",highlightOptions:{animationType:"none"}},{id:"tutorial_complete",title:"„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÂÆå‰∫ÜÔºÅ",description:`„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅÂü∫Êú¨ÁöÑ„Å™Êìç‰Ωú„ÇíÁøíÂæó„Åó„Åæ„Åó„Åü„ÄÇ

„Åì„Çå„Åã„ÇâÊú¨Ê†ºÁöÑ„Å™„Ç≤„Éº„É†„ÅåÂßã„Åæ„Çä„Åæ„Åô„ÄÇ

3„Å§„ÅÆ„É©„Ç§„Éï„Çπ„ÉÜ„Éº„Ç∏„Çí‰πó„ÇäË∂ä„Åà„ÄÅÊúÄÂæå„Å´Â§¢„ÇíÂÆüÁèæ„Åó„Åæ„Åó„Çá„ÅÜÔºÅ

È†ëÂºµ„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`,position:"center",action:"click",highlightOptions:{color:"#4CAF50",opacity:.3,animationType:"glow",duration:2e3},onExit:()=>{localStorage.setItem("tutorial_completed","true")}}]};class U{constructor(e){r(this,"zones",new Map);r(this,"scene");r(this,"dragState",{isDragging:!1,validZones:[]});r(this,"lastFrameTime",0);r(this,"FRAME_INTERVAL",16);this.scene=e}addZone(e){this.zones.set(e.id,e)}removeZone(e){this.zones.delete(e)}startDrag(e,t,i){this.dragState={isDragging:!0,card:e,startPosition:g({},i),currentPosition:g({},i),validZones:this.getValidZones(e,t),hoveredZone:void 0},this.highlightValidZones()}updateDrag(e,t){if(!this.dragState.isDragging||!this.dragState.card)return;const i=Date.now();if(i-this.lastFrameTime<this.FRAME_INTERVAL)return;this.lastFrameTime=i,this.dragState.currentPosition=g({},e);const s=this.getZoneAtPosition(e.x,e.y);s!==this.dragState.hoveredZone&&this.updateHoverState(s,t)}endDrag(e,t){if(!this.dragState.isDragging||!this.dragState.card)return{success:!1,error:"No active drag operation"};const i=this.getZoneAtPosition(e.x,e.y);let s;if(i&&this.isValidDrop(this.dragState.card,i,t))try{i.onDrop(this.dragState.card,t),s={success:!0,zone:i}}catch(n){s={success:!1,error:`Drop action failed: ${n instanceof Error?n.message:"Unknown error"}`}}else s={success:!1,error:i?"Invalid drop target":"No drop zone found"};return this.clearHighlights(),this.dragState={isDragging:!1,validZones:[]},s}getZoneAtPosition(e,t){return Array.from(this.zones.values()).filter(s=>s.bounds.contains(e,t)).sort((s,n)=>n.priority-s.priority)[0]}getValidZones(e,t){return Array.from(this.zones.values()).filter(i=>{try{return i.isValid(e,t)}catch(s){return console.warn(`Validation error for zone ${i.id}:`,s),!1}})}isValidDrop(e,t,i){try{return this.dragState.validZones.includes(t)&&t.isValid(e,i)}catch(s){return console.warn(`Validation error for zone ${t.id}:`,s),!1}}highlightValidZones(){this.dragState.validZones.forEach(e=>{var i,s;const t=this.scene.add.graphics();t.fillStyle(((i=e.visualStyle)==null?void 0:i.validColor)||65280,.3),t.fillRectShape(e.bounds),t.lineStyle(2,((s=e.visualStyle)==null?void 0:s.validColor)||65280,.8),t.strokeRectShape(e.bounds),t.setName(`highlight-${e.id}`),this.scene.tweens.add({targets:t,alpha:.5,duration:1e3,yoyo:!0,repeat:-1,ease:"Power2"})})}updateHoverState(e,t){var i,s;if(this.dragState.hoveredZone){const n=this.scene.children.getByName(`hover-${this.dragState.hoveredZone.id}`);n&&n.destroy()}if(this.dragState.hoveredZone=e,e&&this.dragState.card){const a=this.isValidDrop(this.dragState.card,e,t)?((i=e.visualStyle)==null?void 0:i.hoverColor)||65416:((s=e.visualStyle)==null?void 0:s.invalidColor)||16711680,o=this.scene.add.graphics();o.fillStyle(a,.5),o.fillRectShape(e.bounds),o.lineStyle(3,a,1),o.strokeRectShape(e.bounds),o.setName(`hover-${e.id}`),o.setScale(.9),this.scene.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:200,ease:"Back.out"})}}clearHighlights(){this.zones.forEach(e=>{const t=this.scene.children.getByName(`highlight-${e.id}`),i=this.scene.children.getByName(`hover-${e.id}`);t&&this.scene.tweens.add({targets:t,alpha:0,duration:200,onComplete:()=>t.destroy()}),i&&i.destroy()})}getMagneticSnapTarget(e){if(!this.dragState.card)return null;for(const t of this.dragState.validZones){const i=t.magneticDistance||100,s=t.bounds.x+t.bounds.width/2,n=t.bounds.y+t.bounds.height/2,a=e.x-s,o=e.y-n;if(Math.sqrt(a*a+o*o)<=i)return{zone:t,snapPosition:{x:s,y:n}}}return null}getDragState(){return g({},this.dragState)}destroy(){this.clearHighlights(),this.zones.clear(),this.dragState={isDragging:!1,validZones:[]}}}class m{static cardTypeOnly(e){return t=>e.includes(t.type)}static phaseOnly(e){return(t,i)=>{var n;const s=((n=i.getCurrentPhase)==null?void 0:n.call(i))||"unknown";return e.includes(s)}}static minimumPower(e){return t=>t.power>=e}static maximumPower(e){return t=>t.power<=e}static costLimit(e){return t=>t.cost<=e}static vitalityCheck(e){return(t,i)=>i.vitality>=e}static notInChallenge(){return(e,t)=>!t.currentChallenge}static inChallenge(){return(e,t)=>!!t.currentChallenge}static handSpaceAvailable(){return(e,t)=>{if(!t.playerHand)return!1;const i=t.playerHand.size(),s=t.maxHandSize||7;return i<s}}static cardInHand(){return(e,t)=>{var i;return((i=t.playerHand)==null?void 0:i.contains(e.id))||!1}}static stageOnly(e){return(t,i)=>e.includes(i.stage)}static ageRange(e,t){return(i,s)=>{var a;const n=((a=s.getPlayerAge)==null?void 0:a.call(s))||20;return n>=e&&n<=t}}static custom(e){return e}static combine(...e){return(t,i)=>e.every(s=>s(t,i))}static either(...e){return(t,i)=>e.some(s=>s(t,i))}static not(e){return(t,i)=>!e(t,i)}static conditional(e,t,i){return(s,n)=>e(s,n)?t(s,n):i?i(s,n):!0}static always(){return()=>!0}static never(){return()=>!1}}class f{static startChallenge(){return(e,t)=>{t.currentChallenge||t.startChallenge(e)}}static discardCard(){return(e,t)=>{var i,s;if(!e||!t){console.warn("[DropZoneActions] discardCard: card or game is null");return}(i=t.playerHand)==null||i.removeCard(e.id),(s=t.discardPile)==null||s.addCard(e)}}static returnToDeck(e=!1){return(t,i)=>{var s,n,a;if(!t||!i){console.warn("[DropZoneActions] returnToDeck: card or game is null");return}(s=i.playerHand)==null||s.removeCard(t.id),(n=i.playerDeck)==null||n.addCard(t),e&&((a=i.playerDeck)==null||a.shuffle())}}static consumeVitality(e){return(t,i)=>{i.vitality=Math.max(0,i.vitality-e)}}static restoreVitality(e){return(t,i)=>{const s=i.maxVitality||20;i.vitality=Math.min(s,i.vitality+e)}}static playCard(){return(e,t)=>{var i,s;if(!e||!t){console.warn("[DropZoneActions] playCard: card or game is null");return}e.type==="life"&&e.power>0&&(t.vitality=Math.min(t.maxVitality||20,t.vitality+e.power)),(i=t.playerHand)==null||i.removeCard(e.id),(s=t.playedCards)==null||s.addCard(e)}}static triggerSpecialEffect(e){return(t,i)=>{t.type}}static log(e){return(t,i)=>{}}static sequence(...e){return(t,i)=>{e.forEach(s=>s(t,i))}}static conditional(e,t,i){return(s,n)=>{e(s,n)?t(s,n):i&&i(s,n)}}static custom(e){return e}static noop(){return()=>{}}static throwError(e){return()=>{throw new Error(e)}}}class I{static challengeZone(){return{validator:m.combine(m.cardTypeOnly(["life"]),m.notInChallenge(),m.cardInHand()),action:f.sequence(f.log("Starting challenge"),f.startChallenge())}}static discardZone(){return{validator:m.combine(m.cardInHand(),m.not(m.inChallenge())),action:f.sequence(f.log("Discarding card"),f.discardCard())}}static insurancePlayZone(){return{validator:m.combine(m.cardTypeOnly(["insurance"]),m.cardInHand(),m.vitalityCheck(1)),action:f.sequence(f.log("Playing insurance card"),f.playCard(),f.consumeVitality(1))}}static specialAbilityZone(e,t){return{validator:m.combine(m.cardTypeOnly([e]),m.vitalityCheck(t),m.cardInHand()),action:f.sequence(f.log(`Using special ability (cost: ${t})`),f.consumeVitality(t),f.triggerSpecialEffect("special-ability"),f.discardCard())}}}class ie{constructor(e,t){r(this,"dropZoneManager");r(this,"scene");r(this,"game");r(this,"deviceInfo");r(this,"dragConfig");r(this,"draggedCard");r(this,"dragStartPosition",{x:0,y:0});r(this,"isSnapping",!1);r(this,"lastUpdateTime",0);r(this,"UPDATE_THROTTLE",16);r(this,"particlePool",[]);r(this,"trailPool",[]);this.scene=e,this.game=t,this.dropZoneManager=new U(e),this.deviceInfo=this.detectDevice(),this.dragConfig=this.createDragConfig(),this.initializeDefaultZones()}detectDevice(){const e=this.scene.sys.game.device.os.android||this.scene.sys.game.device.os.iOS,t=e&&Math.min(window.innerWidth,window.innerHeight)>=768,i=this.scene.sys.game.device.input.touch,s=window.innerWidth>window.innerHeight?"landscape":"portrait";return{isMobile:e,isTablet:t,hasTouch:i,orientation:s}}createDragConfig(){return{snapDistance:this.deviceInfo.isMobile?120:100,touchOffset:this.deviceInfo.isMobile?{x:0,y:-60}:{x:0,y:0},animationDuration:this.deviceInfo.isMobile?400:300,throttleInterval:this.deviceInfo.isMobile?20:16}}initializeDefaultZones(){const e=I.challengeZone(),t={id:"challenge",type:"challenge",bounds:new Phaser.Geom.Rectangle(this.scene.cameras.main.centerX-T.CARD_WIDTH/2,T.CHALLENGE_Y_POSITION-T.CARD_HEIGHT/2,T.CARD_WIDTH,T.CARD_HEIGHT),isValid:e.validator,onDrop:(n,a)=>{this.handleChallengeDrop(n),e.action(n,a)},priority:10,magneticDistance:this.dragConfig.snapDistance,visualStyle:{validColor:1096065,invalidColor:15680580,hoverColor:366185}},i=I.discardZone(),s={id:"discard",type:"discard",bounds:new Phaser.Geom.Rectangle(T.DISCARD_X_POSITION-T.CARD_WIDTH/2,T.DISCARD_Y_POSITION-T.CARD_HEIGHT/2,T.CARD_WIDTH,T.CARD_HEIGHT),isValid:i.validator,onDrop:(n,a)=>{this.handleDiscardDrop(n),i.action(n,a)},priority:5,magneticDistance:this.dragConfig.snapDistance,visualStyle:{validColor:7041664,invalidColor:15680580,hoverColor:4937059}};this.dropZoneManager.addZone(t),this.dropZoneManager.addZone(s)}setupCardDragAndDrop(e){const t=e.getData("card");e.on("dragstart",i=>{this.startDrag(e,i,t)}),e.on("drag",(i,s,n)=>{this.updateDrag(e,i,s,n)}),e.on("dragend",i=>{this.endDrag(e,i,t)})}startDrag(e,t,i){if(!t||!e||!i){console.warn("[DropZoneIntegration] startDrag: invalid parameters");return}this.draggedCard=e,this.dragStartPosition={x:e.x,y:e.y};const s={x:t.x+this.dragConfig.touchOffset.x,y:t.y+this.dragConfig.touchOffset.y};this.dropZoneManager.startDrag(i,this.game,s),e.setDepth(1e3),e.setAlpha(.8),e.setScale(1.15),this.createDragTrail(e),this.deviceInfo.hasTouch&&navigator.vibrate&&navigator.vibrate(50)}updateDrag(e,t,i,s){if(!e||i===void 0||s===void 0){console.warn("[DropZoneIntegration] updateDrag: invalid parameters");return}const n=Date.now();if(n-this.lastUpdateTime<this.UPDATE_THROTTLE){e.x=i+this.dragConfig.touchOffset.x,e.y=s+this.dragConfig.touchOffset.y;return}this.lastUpdateTime=n;const a={x:i+this.dragConfig.touchOffset.x,y:s+this.dragConfig.touchOffset.y};if(e.x=a.x,e.y=a.y,this.dropZoneManager.updateDrag(a,this.game),!this.isSnapping){const o=this.dropZoneManager.getMagneticSnapTarget(a);o&&this.performMagneticSnap(e,o.snapPosition)}this.updateDragTrailOptimized(e)}endDrag(e,t,i){if(!e){console.warn("[DropZoneIntegration] endDrag: invalid cardContainer");return}const s={x:e.x,y:e.y},n=this.dropZoneManager.endDrag(s,this.game);n.success?this.handleSuccessfulDrop(e,n):this.handleFailedDrop(e,n),this.cleanupDrag(e),this.draggedCard=void 0}performMagneticSnap(e,t){this.isSnapping=!0,this.scene.tweens.add({targets:e,x:t.x,y:t.y,duration:200,ease:"Back.out",onComplete:()=>{this.isSnapping=!1,this.showSnapFeedback(e)}})}handleSuccessfulDrop(e,t){this.scene.tweens.add({targets:e,scaleX:1.2,scaleY:1.2,duration:150,ease:"Back.out",yoyo:!0,onComplete:()=>{this.createSuccessParticles(e.x,e.y),this.scene.tweens.add({targets:e,alpha:0,scale:.8,duration:this.dragConfig.animationDuration,ease:"Power2",onComplete:()=>{}})}}),this.deviceInfo.hasTouch&&navigator.vibrate&&navigator.vibrate([100,50,100])}handleFailedDrop(e,t){this.scene.tweens.add({targets:e,x:this.dragStartPosition.x,y:this.dragStartPosition.y,duration:this.dragConfig.animationDuration,ease:"Elastic.out"}),this.showFailureFeedback(e),t.error&&console.warn(`Drop failed: ${t.error}`),this.deviceInfo.hasTouch&&navigator.vibrate&&navigator.vibrate(200)}createDragTrail(e){const t=this.scene.add.graphics();t.fillStyle(6717162,.3),t.fillCircle(0,0,15),t.setDepth(999),t.setName("drag-trail"),e.add(t)}updateDragTrailOptimized(e){const t=e.getByName("drag-trail");if(t){const i=t.alpha-.05;i<.1?(this.returnTrailToPool(t),e.remove(t)):t.setAlpha(i)}}updateDragTrail(e){const t=e.getByName("drag-trail");t&&(t.setAlpha(t.alpha*.95),t.alpha<.1&&t.destroy())}showSnapFeedback(e){const t=this.scene.add.graphics();t.lineStyle(3,1096065,.8),t.strokeCircle(e.x,e.y,80),t.setDepth(1001),this.scene.tweens.add({targets:t,alpha:0,duration:500,ease:"Power2",onComplete:()=>t.destroy()})}showFailureFeedback(e){const t=e.x;this.scene.tweens.add({targets:e,x:t-10,duration:50,yoyo:!0,repeat:3,ease:"Power2"});const i=this.scene.add.graphics();i.lineStyle(4,15680580,.8),i.lineBetween(-20,-20,20,20),i.lineBetween(-20,20,20,-20),i.setPosition(e.x,e.y),i.setDepth(1001),this.scene.tweens.add({targets:i,alpha:0,scale:2,duration:1e3,ease:"Power2",onComplete:()=>i.destroy()})}createSuccessParticles(e,t){for(let i=0;i<8;i++){let s=this.particlePool.pop();s||(s=this.scene.add.graphics()),s.clear(),s.fillStyle(1096065,.8),s.fillCircle(0,0,4),s.setPosition(e,t),s.setDepth(1002),s.setAlpha(.8),s.setScale(1);const n=i/8*Math.PI*2,a=100;this.scene.tweens.add({targets:s,x:e+Math.cos(n)*a,y:t+Math.sin(n)*a,alpha:0,scale:2,duration:800,ease:"Power2",onComplete:()=>{this.returnParticleToPool(s)}})}}returnParticleToPool(e){this.particlePool.length<20?(e.setVisible(!1),this.particlePool.push(e)):e.destroy()}returnTrailToPool(e){this.trailPool.length<10?(e.setVisible(!1),e.setAlpha(1),this.trailPool.push(e)):e.destroy()}cleanupDrag(e){e.setDepth(0),e.setAlpha(1),e.setScale(1);const t=e.getByName("drag-trail");t&&t.destroy()}handleChallengeDrop(e){}handleDiscardDrop(e){}addCustomZone(e){this.dropZoneManager.addZone(e)}removeZone(e){this.dropZoneManager.removeZone(e)}getPerformanceStats(){return{poolStats:{particles:this.particlePool.length,trails:this.trailPool.length},updateFrequency:this.UPDATE_THROTTLE,throttleRate:this.lastUpdateTime>0?1e3/this.UPDATE_THROTTLE:0}}destroy(){this.particlePool.forEach(e=>e.destroy()),this.trailPool.forEach(e=>e.destroy()),this.particlePool.length=0,this.trailPool.length=0,this.dropZoneManager.destroy()}}class se{constructor(e){r(this,"scene");r(this,"enabled",!1);r(this,"focusableElements",[]);r(this,"currentFocusIndex",-1);r(this,"focusIndicator");r(this,"keyBindings",{TAB:"next",SHIFT_TAB:"previous",LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",SPACE:"select",ENTER:"confirm",ESC:"cancel",D:"draw",C:"challenge",E:"endTurn",ONE:"card1",TWO:"card2",THREE:"card3",FOUR:"card4",FIVE:"card5",SIX:"card6",SEVEN:"card7"});r(this,"callbacks",new Map);this.scene=e,this.setupKeyboardListeners(),this.createFocusIndicator()}enable(){this.enabled=!0,this.showAccessibilityHint()}disable(){this.enabled=!1,this.clearFocus()}registerFocusableElement(e,t){this.focusableElements.push(e),e.setData("focusIndex",this.focusableElements.length-1),t&&this.callbacks.set(`element_${this.focusableElements.length-1}`,t)}unregisterFocusableElement(e){const t=this.focusableElements.indexOf(e);t>-1&&(this.focusableElements.splice(t,1),this.callbacks.delete(`element_${t}`),this.currentFocusIndex>=t&&this.currentFocusIndex--)}registerActionCallback(e,t){this.callbacks.set(e,t)}setupKeyboardListeners(){const e=this.scene.input.keyboard;if(e){e.on("keydown-TAB",t=>{this.enabled&&(t.preventDefault(),t.shiftKey?this.focusPrevious():this.focusNext())}),e.on("keydown-LEFT",()=>this.handleArrowKey("left")),e.on("keydown-RIGHT",()=>this.handleArrowKey("right")),e.on("keydown-UP",()=>this.handleArrowKey("up")),e.on("keydown-DOWN",()=>this.handleArrowKey("down")),e.on("keydown-SPACE",t=>{this.enabled&&(t.preventDefault(),this.handleAction("select"))}),e.on("keydown-ENTER",()=>{this.enabled&&this.handleAction("confirm")}),e.on("keydown-ESC",()=>{this.enabled&&this.handleAction("cancel")}),e.on("keydown-D",()=>{this.enabled&&this.handleAction("draw")}),e.on("keydown-C",()=>{this.enabled&&this.handleAction("challenge")}),e.on("keydown-E",()=>{this.enabled&&this.handleAction("endTurn")});for(let t=1;t<=7;t++)e.on(`keydown-${["ONE","TWO","THREE","FOUR","FIVE","SIX","SEVEN"][t-1]}`,()=>{this.enabled&&this.handleAction(`card${t}`)})}}createFocusIndicator(){this.focusIndicator=this.scene.add.graphics(),this.focusIndicator.setDepth(1e4),this.focusIndicator.setVisible(!1)}focusNext(){this.focusableElements.length!==0&&(this.currentFocusIndex++,this.currentFocusIndex>=this.focusableElements.length&&(this.currentFocusIndex=0),this.updateFocusIndicator())}focusPrevious(){this.focusableElements.length!==0&&(this.currentFocusIndex--,this.currentFocusIndex<0&&(this.currentFocusIndex=this.focusableElements.length-1),this.updateFocusIndicator())}handleArrowKey(e){if(!this.enabled)return;const t=this.getCurrentFocusedElement();if(!t){this.currentFocusIndex=0,this.updateFocusIndicator();return}const i=this.findNearestElement(t,e);i!==-1&&(this.currentFocusIndex=i,this.updateFocusIndicator())}handleAction(e){const t=this.callbacks.get(e);if(t){t();return}if((e==="select"||e==="confirm")&&this.getCurrentFocusedElement()){const s=this.callbacks.get(`element_${this.currentFocusIndex}`);s&&s()}}updateFocusIndicator(){if(!this.focusIndicator)return;const e=this.getCurrentFocusedElement();if(!e){this.focusIndicator.setVisible(!1);return}const t=this.getElementBounds(e);t&&(this.focusIndicator.clear(),this.focusIndicator.lineStyle(3,16776960,1),this.focusIndicator.strokeRoundedRect(t.x-5,t.y-5,t.width+10,t.height+10,5),this.focusIndicator.setVisible(!0),this.scene.tweens.add({targets:this.focusIndicator,alpha:{from:1,to:.5},duration:500,yoyo:!0,repeat:-1}))}getCurrentFocusedElement(){return this.currentFocusIndex<0||this.currentFocusIndex>=this.focusableElements.length?null:this.focusableElements[this.currentFocusIndex]}getElementBounds(e){if("getBounds"in e){const t=e.getBounds();return{x:t.x,y:t.y,width:t.width,height:t.height}}if(e instanceof Phaser.GameObjects.Container){const t=e.getBounds();return{x:t.x,y:t.y,width:t.width,height:t.height}}return null}findNearestElement(e,t){const i=this.getElementBounds(e);if(!i)return-1;let s=-1,n=1/0;for(let a=0;a<this.focusableElements.length;a++){if(a===this.currentFocusIndex)continue;const o=this.focusableElements[a],l=this.getElementBounds(o);if(!l)continue;let c=!1,d=0;switch(t){case"left":c=l.x+l.width<i.x,d=i.x-(l.x+l.width);break;case"right":c=l.x>i.x+i.width,d=l.x-(i.x+i.width);break;case"up":c=l.y+l.height<i.y,d=i.y-(l.y+l.height);break;case"down":c=l.y>i.y+i.height,d=l.y-(i.y+i.height);break}c&&d<n&&(n=d,s=a)}return s}clearFocus(){this.currentFocusIndex=-1,this.focusIndicator&&this.focusIndicator.setVisible(!1)}showAccessibilityHint(){const e=this.scene.add.text(this.scene.cameras.main.width/2,50,"„Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú„ÅåÊúâÂäπ„Åß„Åô (Tab: ÁßªÂãï, Space/Enter: ÈÅ∏Êäû, Esc: „Ç≠„É£„É≥„Çª„É´)",{fontSize:"14px",color:"#ffffff",backgroundColor:"#000000",padding:{x:10,y:5}});e.setOrigin(.5),e.setDepth(10001),this.scene.time.delayedCall(3e3,()=>{this.scene.tweens.add({targets:e,alpha:0,duration:500,onComplete:()=>e.destroy()})})}destroy(){this.disable(),this.focusableElements=[],this.callbacks.clear(),this.focusIndicator&&this.focusIndicator.destroy()}}class X{constructor(){r(this,"audioContext");this.audioContext=new(window.AudioContext||window.webkitAudioContext)}playButtonClick(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(400,e+.05),i.gain.setValueAtTime(.3,e),i.gain.exponentialRampToValueAtTime(.01,e+.05),t.start(e),t.stop(e+.05)}playButtonHover(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(1200,e),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.1,e+.01),i.gain.exponentialRampToValueAtTime(.01,e+.03),t.start(e),t.stop(e+.03)}playCardDraw(){const e=this.audioContext.currentTime,t=.1*this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),s=i.getChannelData(0);for(let l=0;l<t;l++)s[l]=Math.random()*2-1;const n=this.audioContext.createBufferSource(),a=this.audioContext.createBiquadFilter(),o=this.audioContext.createGain();n.buffer=i,a.type="highpass",a.frequency.setValueAtTime(1e3,e),a.frequency.exponentialRampToValueAtTime(3e3,e+.1),n.connect(a),a.connect(o),o.connect(this.audioContext.destination),o.gain.setValueAtTime(.2,e),o.gain.exponentialRampToValueAtTime(.01,e+.1),n.start(e),n.stop(e+.1)}playCardSelect(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="square",t.frequency.setValueAtTime(600,e),t.frequency.exponentialRampToValueAtTime(800,e+.05),i.gain.setValueAtTime(.15,e),i.gain.exponentialRampToValueAtTime(.01,e+.05),t.start(e),t.stop(e+.05)}playChallengeSuccess(){const e=this.audioContext.currentTime;[523.25,659.25,783.99].forEach((i,s)=>{const n=this.audioContext.createOscillator(),a=this.audioContext.createGain();n.connect(a),a.connect(this.audioContext.destination),n.type="sine",n.frequency.setValueAtTime(i,e+s*.05),a.gain.setValueAtTime(0,e+s*.05),a.gain.linearRampToValueAtTime(.2,e+s*.05+.02),a.gain.exponentialRampToValueAtTime(.01,e+s*.05+.3),n.start(e+s*.05),n.stop(e+s*.05+.3)})}playChallengeFail(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sawtooth",t.frequency.setValueAtTime(300,e),t.frequency.exponentialRampToValueAtTime(100,e+.2),i.gain.setValueAtTime(.2,e),i.gain.exponentialRampToValueAtTime(.01,e+.2),t.start(e),t.stop(e+.2)}playVitalityGain(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(400,e),t.frequency.exponentialRampToValueAtTime(800,e+.15),i.gain.setValueAtTime(.15,e),i.gain.exponentialRampToValueAtTime(.01,e+.15),t.start(e),t.stop(e+.15)}playVitalityLoss(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(600,e),t.frequency.exponentialRampToValueAtTime(200,e+.15),i.gain.setValueAtTime(.15,e),i.gain.exponentialRampToValueAtTime(.01,e+.15),t.start(e),t.stop(e+.15)}playWarning(){const e=this.audioContext.currentTime;for(let t=0;t<2;t++){const i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.connect(s),s.connect(this.audioContext.destination),i.type="square",i.frequency.setValueAtTime(880,e+t*.15),s.gain.setValueAtTime(.1,e+t*.15),s.gain.exponentialRampToValueAtTime(.01,e+t*.15+.1),i.start(e+t*.15),i.stop(e+t*.15+.1)}}playNotification(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(523.25,e),t.frequency.setValueAtTime(659.25,e+.05),i.gain.setValueAtTime(.15,e),i.gain.setValueAtTime(.15,e+.05),i.gain.exponentialRampToValueAtTime(.01,e+.1),t.start(e),t.stop(e+.1)}playGameOver(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sawtooth",t.frequency.setValueAtTime(200,e),t.frequency.exponentialRampToValueAtTime(50,e+1),i.gain.setValueAtTime(.2,e),i.gain.exponentialRampToValueAtTime(.01,e+1),t.start(e),t.stop(e+1)}playVictory(){const e=this.audioContext.currentTime;[{freq:523.25,start:0},{freq:523.25,start:.1},{freq:523.25,start:.2},{freq:659.25,start:.3},{freq:783.99,start:.5},{freq:1046.5,start:.7}].forEach(({freq:i,start:s})=>{const n=this.audioContext.createOscillator(),a=this.audioContext.createGain();n.connect(a),a.connect(this.audioContext.destination),n.type="square",n.frequency.setValueAtTime(i,e+s),a.gain.setValueAtTime(0,e+s),a.gain.linearRampToValueAtTime(.15,e+s+.02),a.gain.setValueAtTime(.15,e+s+.08),a.gain.exponentialRampToValueAtTime(.01,e+s+.2),n.start(e+s),n.stop(e+s+.2)})}resume(){return y(this,null,function*(){this.audioContext.state==="suspended"&&(yield this.audioContext.resume())})}playInsuranceGet(){const e=this.audioContext.currentTime;[659.25,783.99,1046.5].forEach((i,s)=>{const n=this.audioContext.createOscillator(),a=this.audioContext.createGain();n.connect(a),a.connect(this.audioContext.destination),n.type="sine",n.frequency.setValueAtTime(i,e+s*.03),a.gain.setValueAtTime(0,e+s*.03),a.gain.linearRampToValueAtTime(.2,e+s*.03+.01),a.gain.exponentialRampToValueAtTime(.01,e+s*.03+.15),n.start(e+s*.03),n.stop(e+s*.03+.15)})}playInsuranceExpire(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="triangle",t.frequency.setValueAtTime(440,e),t.frequency.exponentialRampToValueAtTime(220,e+.3),i.gain.setValueAtTime(.2,e),i.gain.exponentialRampToValueAtTime(.01,e+.3),t.start(e),t.stop(e+.3)}playStageComplete(){const e=this.audioContext.currentTime;[{freq:523.25,start:0},{freq:659.25,start:.1},{freq:783.99,start:.2},{freq:1046.5,start:.3},{freq:1318.51,start:.4}].forEach(({freq:i,start:s})=>{const n=this.audioContext.createOscillator(),a=this.audioContext.createGain();n.connect(a),a.connect(this.audioContext.destination),n.type="square",n.frequency.setValueAtTime(i,e+s),a.gain.setValueAtTime(0,e+s),a.gain.linearRampToValueAtTime(.15,e+s+.02),a.gain.setValueAtTime(.15,e+s+.08),a.gain.exponentialRampToValueAtTime(.01,e+s+.3),n.start(e+s),n.stop(e+s+.3)})}playChallengeStart(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createOscillator(),s=this.audioContext.createGain();t.connect(s),i.connect(s),s.connect(this.audioContext.destination),t.type="sawtooth",i.type="sawtooth",t.frequency.setValueAtTime(261.63,e),i.frequency.setValueAtTime(277.18,e),s.gain.setValueAtTime(0,e),s.gain.linearRampToValueAtTime(.2,e+.05),s.gain.setValueAtTime(.2,e+.1),s.gain.exponentialRampToValueAtTime(.01,e+.2),t.start(e),i.start(e),t.stop(e+.2),i.stop(e+.2)}playCardShuffle(){const e=this.audioContext.currentTime;for(let t=0;t<5;t++){const i=.02*this.audioContext.sampleRate,s=this.audioContext.createBuffer(1,i,this.audioContext.sampleRate),n=s.getChannelData(0);for(let c=0;c<i;c++)n[c]=Math.random()*2-1;const a=this.audioContext.createBufferSource(),o=this.audioContext.createBiquadFilter(),l=this.audioContext.createGain();a.buffer=s,o.type="bandpass",o.frequency.setValueAtTime(2e3+t*500,e+t*.03),o.Q.value=10,a.connect(o),o.connect(l),l.connect(this.audioContext.destination),l.gain.setValueAtTime(.1,e+t*.03),l.gain.exponentialRampToValueAtTime(.01,e+t*.03+.02),a.start(e+t*.03),a.stop(e+t*.03+.02)}}playDialogOpen(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(400,e),t.frequency.exponentialRampToValueAtTime(800,e+.1),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.15,e+.02),i.gain.setValueAtTime(.15,e+.08),i.gain.exponentialRampToValueAtTime(.01,e+.1),t.start(e),t.stop(e+.1)}playDialogClose(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(400,e+.1),i.gain.setValueAtTime(.15,e),i.gain.exponentialRampToValueAtTime(.01,e+.1),t.start(e),t.stop(e+.1)}playError(){const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createOscillator(),s=this.audioContext.createGain();t.connect(s),i.connect(s),s.connect(this.audioContext.destination),t.type="square",i.type="square",t.frequency.setValueAtTime(220,e),i.frequency.setValueAtTime(233.08,e),s.gain.setValueAtTime(.2,e),s.gain.setValueAtTime(.2,e+.1),s.gain.setValueAtTime(0,e+.15),s.gain.setValueAtTime(.2,e+.2),s.gain.setValueAtTime(.2,e+.3),s.gain.exponentialRampToValueAtTime(.01,e+.35),t.start(e),i.start(e),t.stop(e+.35),i.stop(e+.35)}destroy(){this.audioContext.state!=="closed"&&this.audioContext.close()}}const b=class b{constructor(e){r(this,"scene");r(this,"enabled",!0);r(this,"volume",.5);r(this,"sounds",new Map);r(this,"webAudioGenerator");r(this,"soundEffects",{cardDraw:{key:"cardDraw",volume:.4},cardSelect:{key:"cardSelect",volume:.3},cardDeselect:{key:"cardDeselect",volume:.3},cardPlay:{key:"cardPlay",volume:.5},cardShuffle:{key:"cardShuffle",volume:.4},challengeStart:{key:"challengeStart",volume:.5},challengeSuccess:{key:"challengeSuccess",volume:.6},challengeFail:{key:"challengeFail",volume:.5},stageComplete:{key:"stageComplete",volume:.7},gameOver:{key:"gameOver",volume:.6},gameVictory:{key:"gameVictory",volume:.8},buttonClick:{key:"buttonClick",volume:.3},buttonHover:{key:"buttonHover",volume:.2},dialogOpen:{key:"dialogOpen",volume:.4},dialogClose:{key:"dialogClose",volume:.4},insuranceGet:{key:"insuranceGet",volume:.5},insuranceExpire:{key:"insuranceExpire",volume:.4},insuranceRenew:{key:"insuranceRenew",volume:.4},vitalityGain:{key:"vitalityGain",volume:.4},vitalityLoss:{key:"vitalityLoss",volume:.5},vitalityWarning:{key:"vitalityWarning",volume:.6},notification:{key:"notification",volume:.4},warning:{key:"warning",volume:.5},error:{key:"error",volume:.5}});this.scene=e,this.webAudioGenerator=new X,this.loadSettings(),this.loadSounds(),this.setupVolumeControl(),this.scene.input.once("pointerdown",()=>y(this,null,function*(){try{yield this.webAudioGenerator.resume(),console.log("AudioContext successfully resumed")}catch(t){console.warn("Failed to resume AudioContext:",t)}}))}loadSounds(){this.generateSyntheticSounds()}generateSyntheticSounds(){this.createSyntheticSound("cardDraw",800,.05,"whitenoise"),this.createSyntheticSound("cardSelect",600,.03,"square_up"),this.createSyntheticSound("cardDeselect",500,.03,"square_down"),this.createSyntheticSound("cardPlay",300,.1,"sine"),this.createSyntheticSound("challengeSuccess",523,.2,"chord_major"),this.createSyntheticSound("challengeFail",300,.2,"sawtooth_down"),this.createSyntheticSound("buttonClick",800,.02,"sine_down"),this.createSyntheticSound("buttonHover",900,.01),this.createSyntheticSound("notification",660,.1),this.createSyntheticSound("warning",440,.15)}createSyntheticSound(e,t,i,s="normal"){this.scene.sound.context}play(e){if(!(!this.enabled||!this.soundEffects[e]))try{switch(e){case"buttonClick":this.webAudioGenerator.playButtonClick();break;case"buttonHover":this.webAudioGenerator.playButtonHover();break;case"cardDraw":this.webAudioGenerator.playCardDraw();break;case"cardSelect":case"cardDeselect":this.webAudioGenerator.playCardSelect();break;case"challengeSuccess":this.webAudioGenerator.playChallengeSuccess();break;case"challengeFail":this.webAudioGenerator.playChallengeFail();break;case"vitalityGain":this.webAudioGenerator.playVitalityGain();break;case"vitalityLoss":this.webAudioGenerator.playVitalityLoss();break;case"warning":case"vitalityWarning":this.webAudioGenerator.playWarning();break;case"notification":case"insuranceGet":case"insuranceRenew":this.webAudioGenerator.playNotification();break;case"gameOver":this.webAudioGenerator.playGameOver();break;case"gameVictory":this.webAudioGenerator.playVictory();break;case"stageComplete":this.webAudioGenerator.playStageComplete();break;case"challengeStart":this.webAudioGenerator.playChallengeStart();break;case"cardShuffle":this.webAudioGenerator.playCardShuffle();break;case"insuranceExpire":this.webAudioGenerator.playInsuranceExpire();break;case"dialogOpen":this.webAudioGenerator.playDialogOpen();break;case"dialogClose":this.webAudioGenerator.playDialogClose();break;case"error":this.webAudioGenerator.playError();break;case"cardPlay":this.webAudioGenerator.playCardSelect();break;default:this.webAudioGenerator.playNotification()}}catch(i){console.warn("Sound playback error:",i)}}playSequence(e,t=100){e.forEach((i,s)=>{this.scene.time.delayedCall(s*t,()=>{this.play(i)})})}playWithVariation(e,t=3){this.play(e)}setVolume(e){this.volume=Phaser.Math.Clamp(e,0,1),this.updateAllSoundVolumes()}getVolume(){return this.volume}setEnabled(e){this.enabled=e,e||this.stopAll()}isEnabled(){return this.enabled}stopAll(){this.sounds.forEach(e=>{e.isPlaying&&e.stop()})}setupVolumeControl(){}saveSettings(){localStorage.setItem(b.STORAGE_KEYS.VOLUME,this.volume.toString()),localStorage.setItem(b.STORAGE_KEYS.ENABLED,this.enabled.toString())}loadSettings(){const e=localStorage.getItem(b.STORAGE_KEYS.VOLUME);e!==null&&(this.volume=parseFloat(e));const t=localStorage.getItem(b.STORAGE_KEYS.ENABLED);t!==null&&(this.enabled=t==="true")}updateAllSoundVolumes(){this.sounds.forEach(e=>{e.volume=this.volume})}destroy(){this.stopAll(),this.sounds.clear(),this.webAudioGenerator.destroy()}};r(b,"STORAGE_KEYS",{ENABLED:"sound_enabled",VOLUME:"sound_volume"});let M=b;class ne{constructor(){r(this,"eventListeners",new Map);r(this,"phaserListeners",new Map)}addEventListener(e,t,i,s,n){t.addEventListener(i,s,n),this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push({target:t,type:i,listener:s,options:n})}addPhaserListener(e,t,i,s,n){t.on(i,s,n),this.phaserListeners.has(e)||this.phaserListeners.set(e,[]),this.phaserListeners.get(e).push({emitter:t,event:i,fn:s,context:n})}removeAllListeners(e){const t=this.eventListeners.get(e);t&&(t.forEach(({target:s,type:n,listener:a,options:o})=>{try{s.removeEventListener(n,a,o)}catch(l){console.warn(`Failed to remove DOM listener: ${l}`)}}),this.eventListeners.delete(e));const i=this.phaserListeners.get(e);i&&(i.forEach(({emitter:s,event:n,fn:a,context:o})=>{try{s.off(n,a,o)}catch(l){console.warn(`Failed to remove Phaser listener: ${l}`)}}),this.phaserListeners.delete(e))}removeAll(){[...Array.from(this.eventListeners.keys()),...Array.from(this.phaserListeners.keys())].forEach(t=>{this.removeAllListeners(t)})}getMemoryReport(){let e=0,t=0;return this.eventListeners.forEach(i=>{e+=i.length}),this.phaserListeners.forEach(i=>{t+=i.length}),{domListenerCount:e,phaserListenerCount:t,ids:[...Array.from(this.eventListeners.keys()),...Array.from(this.phaserListeners.keys())]}}debugPrint(){const e=this.getMemoryReport();console.group("Event Cleanup Manager Report"),console.log(`DOM Listeners: ${e.domListenerCount}`),console.log(`Phaser Listeners: ${e.phaserListenerCount}`),console.log(`Active IDs: ${e.ids.join(", ")}`),console.groupEnd()}}class ae{constructor(e,t){r(this,"scene");r(this,"metrics");r(this,"thresholds");r(this,"optimizationLevel","medium");r(this,"monitoringInterval",null);r(this,"frameCounter",0);r(this,"lastFrameTime",0);r(this,"fpsHistory",[]);r(this,"isLowPowerMode",!1);this.scene=e,this.thresholds=g({minFPS:30,maxMemoryUsage:80,maxRenderTime:16.67,maxDrawCalls:100},t),this.metrics={fps:60,memory:{used:0,total:0,percentage:0},renderTime:0,updateTime:0,drawCalls:0},this.initialize()}initialize(){this.startMonitoring(),this.enableHardwareAcceleration(),this.monitorBatteryStatus(),this.setupVisibilityHandling()}enableHardwareAcceleration(){const e=this.scene.game.renderer;if(e instanceof Phaser.Renderer.WebGL.WebGLRenderer){const i=e.gl;this.optimizationLevel==="low"&&(i.disable(i.BLEND),i.disable(i.DITHER)),i.hint(i.GENERATE_MIPMAP_HINT,i.FASTEST),i.disable(i.DEPTH_TEST),i.disable(i.STENCIL_TEST)}const t=this.scene.game.canvas;t.style.willChange="transform",t.style.transform="translateZ(0)",t.style.backfaceVisibility="hidden",t.style.perspective="1000px"}startMonitoring(){this.stopMonitoring(),this.scene.events.on("preupdate",this.measureFPS,this),this.monitoringInterval=window.setInterval(()=>{this.updateMetrics(),this.checkPerformanceThresholds()},1e3)}stopMonitoring(){this.monitoringInterval!==null&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.scene.events.off("preupdate",this.measureFPS,this)}measureFPS(){const e=performance.now();if(this.lastFrameTime>0){const i=1e3/(e-this.lastFrameTime);this.fpsHistory.push(i),this.fpsHistory.length>60&&this.fpsHistory.shift()}this.lastFrameTime=e,this.frameCounter++}updateMetrics(){if(this.fpsHistory.length>0){const t=this.fpsHistory.reduce((i,s)=>i+s,0)/this.fpsHistory.length;this.metrics.fps=Math.round(t)}if("memory"in performance&&performance.memory){const t=performance.memory;this.metrics.memory={used:t.usedJSHeapSize,total:t.totalJSHeapSize,percentage:t.usedJSHeapSize/t.totalJSHeapSize*100}}const e=this.scene.game.renderer;e instanceof Phaser.Renderer.WebGL.WebGLRenderer&&(this.metrics.drawCalls=e.pipelines.pipelines.size)}checkPerformanceThresholds(){let e=!1;this.metrics.fps<this.thresholds.minFPS&&(e=!0),this.metrics.memory.percentage>this.thresholds.maxMemoryUsage&&(e=!0,this.performMemoryCleanup()),this.metrics.drawCalls>this.thresholds.maxDrawCalls&&(e=!0),e&&this.adjustOptimizationLevel()}adjustOptimizationLevel(){const e=this.metrics.fps;e<20?this.setOptimizationLevel("low"):e<40?this.setOptimizationLevel("medium"):this.setOptimizationLevel("high")}setOptimizationLevel(e){if(this.optimizationLevel!==e){switch(this.optimizationLevel=e,e){case"low":this.applyLowQualitySettings();break;case"medium":this.applyMediumQualitySettings();break;case"high":this.applyHighQualitySettings();break}this.scene.events.emit("optimizationLevelChanged",e)}}applyLowQualitySettings(){this.disableShadows(),this.reduceParticles(),this.reduceTextureQuality(),this.reduceAnimationFrameRate(),this.simplifyBackgroundEffects()}applyMediumQualitySettings(){this.enableLimitedShadows(),this.enableLimitedParticles(),this.setMediumTextureQuality(),this.setNormalAnimationFrameRate()}applyHighQualitySettings(){this.enableAllVisualEffects(),this.setHighTextureQuality(),this.setSmoothAnimations()}performMemoryCleanup(){const e=this.scene.textures,t=[];e.list.forEach((i,s)=>{["__DEFAULT","__MISSING","__WHITE"].includes(s)||this.isTextureInUse(s)||t.push(s)}),t.forEach(i=>{try{e.remove(i)}catch(s){}}),"gc"in window&&typeof window.gc=="function"&&window.gc()}isTextureInUse(e){var i;const t=this.scene.children.list;for(const s of t)if("texture"in s&&((i=s.texture)==null?void 0:i.key)===e)return!0;return!1}monitorBatteryStatus(){"getBattery"in navigator&&navigator.getBattery().then(e=>{const t=()=>{e.level<.2&&!e.charging?this.enableLowPowerMode():this.disableLowPowerMode()};e.addEventListener("levelchange",t),e.addEventListener("chargingchange",t),t()})}enableLowPowerMode(){this.isLowPowerMode||(this.isLowPowerMode=!0,this.setOptimizationLevel("low"),this.scene.game.loop.targetFps=30,"vibrate"in navigator&&(navigator.vibrate=()=>!1))}disableLowPowerMode(){this.isLowPowerMode&&(this.isLowPowerMode=!1,this.scene.game.loop.targetFps=60)}setupVisibilityHandling(){document.addEventListener("visibilitychange",()=>{document.hidden?this.scene.game.loop.sleep():this.scene.game.loop.wake()})}disableShadows(){}reduceParticles(){}reduceTextureQuality(){}reduceAnimationFrameRate(){}simplifyBackgroundEffects(){}enableLimitedShadows(){}enableLimitedParticles(){}setMediumTextureQuality(){}setNormalAnimationFrameRate(){}enableAllVisualEffects(){}setHighTextureQuality(){}setSmoothAnimations(){}getMetrics(){return g({},this.metrics)}getOptimizationLevel(){return this.optimizationLevel}destroy(){this.stopMonitoring(),this.scene.events.off("preupdate",this.measureFPS,this)}}class Y{constructor(e,t){r(this,"element");r(this,"touchPoints",new Map);r(this,"lastTap",null);r(this,"longPressTimer",null);r(this,"isDragging",!1);r(this,"dragStartPoint",null);r(this,"dragTotalDelta",{x:0,y:0});r(this,"listeners",new Map);r(this,"preventDefaultGestures",new Set);r(this,"lastVelocity",{x:0,y:0});r(this,"momentumTimer",null);r(this,"lastMoveTime",0);r(this,"moveHistory",[]);r(this,"config",{swipeThreshold:50,swipeVelocityThreshold:.3,doubleTapThreshold:300,doubleTapDistance:30,longPressThreshold:500,pinchThreshold:.1,dragThreshold:10,momentumThreshold:200,friction:.95,bounceThreshold:50});this.element=e,t&&(this.config=g(g({},this.config),t)),this.setupEventListeners()}setupEventListeners(){this.element.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.element.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.element.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1}),this.element.addEventListener("touchcancel",this.handleTouchCancel.bind(this),{passive:!1}),this.element.addEventListener("mousedown",this.handleMouseDown.bind(this),{passive:!1}),this.element.addEventListener("mousemove",this.handleMouseMove.bind(this),{passive:!1}),this.element.addEventListener("mouseup",this.handleMouseUp.bind(this),{passive:!1}),this.element.addEventListener("mouseleave",this.handleMouseLeave.bind(this),{passive:!1})}handleTouchStart(e){for(let t=0;t<e.changedTouches.length;t++){const i=e.changedTouches[t];this.touchPoints.set(i.identifier,{identifier:i.identifier,x:i.clientX,y:i.clientY,timestamp:Date.now()})}if(this.touchPoints.size===1){const t=e.changedTouches[0];this.startLongPressDetection(t.clientX,t.clientY),this.checkDoubleTap(t.clientX,t.clientY)}(this.shouldPreventDefault("drag")||this.shouldPreventDefault("pinch"))&&e.preventDefault()}handleTouchMove(e){this.cancelLongPress(),e.touches.length===2&&this.detectPinch(e),e.touches.length===1&&this.detectDrag(e.touches[0]);for(let t=0;t<e.changedTouches.length;t++){const i=e.changedTouches[t],s=this.touchPoints.get(i.identifier);s&&(s.x=i.clientX,s.y=i.clientY,s.timestamp=Date.now())}this.isDragging&&this.shouldPreventDefault("drag")&&e.preventDefault()}handleTouchEnd(e){this.cancelLongPress();for(let t=0;t<e.changedTouches.length;t++){const i=e.changedTouches[t],s=this.touchPoints.get(i.identifier);if(s){const n={x:i.clientX,y:i.clientY,timestamp:Date.now()};this.detectSwipe(s,n,e.target),this.touchPoints.delete(i.identifier)}}this.touchPoints.size===0&&this.isDragging&&this.endDrag(e.changedTouches[0])}handleTouchCancel(e){this.cancelLongPress(),this.touchPoints.clear(),this.isDragging&&(this.isDragging=!1,this.dragStartPoint=null,this.dragTotalDelta={x:0,y:0})}handleMouseDown(e){e.clientX,e.clientY,this.touchPoints.set(-1,{identifier:-1,x:e.clientX,y:e.clientY,timestamp:Date.now()}),this.startLongPressDetection(e.clientX,e.clientY),this.checkDoubleTap(e.clientX,e.clientY)}handleMouseMove(e){if(this.touchPoints.has(-1)){this.cancelLongPress(),this.detectDrag({clientX:e.clientX,clientY:e.clientY});const t=this.touchPoints.get(-1);t&&(t.x=e.clientX,t.y=e.clientY,t.timestamp=Date.now())}}handleMouseUp(e){this.cancelLongPress();const t=this.touchPoints.get(-1);if(t){const i={x:e.clientX,y:e.clientY,timestamp:Date.now()};this.detectSwipe(t,i,e.target),this.touchPoints.delete(-1)}this.isDragging&&this.endDrag({clientX:e.clientX,clientY:e.clientY})}handleMouseLeave(e){this.handleMouseUp(e)}startLongPressDetection(e,t){this.longPressTimer=window.setTimeout(()=>{this.emitGesture("longpress",null,{x:e,y:t,duration:this.config.longPressThreshold})},this.config.longPressThreshold)}cancelLongPress(){this.longPressTimer!==null&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}checkDoubleTap(e,t){const i=Date.now();if(this.lastTap){const s=i-this.lastTap.timestamp,n=Math.sqrt(Math.pow(e-this.lastTap.x,2)+Math.pow(t-this.lastTap.y,2));if(s<this.config.doubleTapThreshold&&n<this.config.doubleTapDistance){this.emitGesture("doubletap",null,{x:e,y:t}),this.lastTap=null;return}}this.lastTap={x:e,y:t,timestamp:i}}detectSwipe(e,t,i){const s=t.x-e.x,n=t.y-e.y,a=t.timestamp-e.timestamp,o=Math.sqrt(s*s+n*n),l=o/a;if(o<this.config.swipeThreshold||l<this.config.swipeVelocityThreshold)return;const c=Math.abs(s),d=Math.abs(n);let u;c>d?u=s>0?"right":"left":u=n>0?"down":"up";const p={direction:u,distance:o,velocity:l,startX:e.x,startY:e.y,endX:t.x,endY:t.y};this.emitGesture("swipe",i,p)}detectPinch(e){if(e.touches.length!==2)return;const t=e.touches[0],i=e.touches[1],s=Math.sqrt(Math.pow(t.clientX-i.clientX,2)+Math.pow(t.clientY-i.clientY,2)),n=this.touchPoints.get(t.identifier),a=this.touchPoints.get(i.identifier);if(n&&a){const o=Math.sqrt(Math.pow(n.x-a.x,2)+Math.pow(n.y-a.y,2)),l=s/o,c=l-1;if(Math.abs(c)>this.config.pinchThreshold){const d=(t.clientX+i.clientX)/2,u=(t.clientY+i.clientY)/2,p={scale:l,deltaScale:c,centerX:d,centerY:u};this.emitGesture("pinch",e.target,p)}}}detectDrag(e){const t=Date.now();if(this.isDragging||(this.dragStartPoint||(this.dragStartPoint={x:e.clientX,y:e.clientY},this.moveHistory=[{x:e.clientX,y:e.clientY,time:t}]),Math.sqrt(Math.pow(e.clientX-this.dragStartPoint.x,2)+Math.pow(e.clientY-this.dragStartPoint.y,2))>this.config.dragThreshold&&(this.isDragging=!0)),this.isDragging&&this.dragStartPoint){this.moveHistory.push({x:e.clientX,y:e.clientY,time:t}),this.moveHistory=this.moveHistory.filter(a=>t-a.time<100);const i=e.clientX-(this.dragStartPoint.x+this.dragTotalDelta.x),s=e.clientY-(this.dragStartPoint.y+this.dragTotalDelta.y);this.dragTotalDelta.x+=i,this.dragTotalDelta.y+=s;const n={deltaX:i,deltaY:s,totalX:this.dragTotalDelta.x,totalY:this.dragTotalDelta.y,startX:this.dragStartPoint.x,startY:this.dragStartPoint.y,currentX:e.clientX,currentY:e.clientY};this.emitGesture("drag",document.elementFromPoint(e.clientX,e.clientY),n),this.lastMoveTime=t}}endDrag(e){if(this.isDragging&&this.dragStartPoint){this.calculateVelocity();const t={deltaX:0,deltaY:0,totalX:this.dragTotalDelta.x,totalY:this.dragTotalDelta.y,startX:this.dragStartPoint.x,startY:this.dragStartPoint.y,currentX:e.clientX,currentY:e.clientY};this.emitGesture("dragend",document.elementFromPoint(e.clientX,e.clientY),t),this.startMomentumScroll()}this.isDragging=!1,this.dragStartPoint=null,this.dragTotalDelta={x:0,y:0},this.moveHistory=[]}calculateVelocity(){if(this.moveHistory.length<2){this.lastVelocity={x:0,y:0};return}const e=this.moveHistory[this.moveHistory.length-1],t=this.moveHistory[this.moveHistory.length-2],i=e.time-t.time;if(i===0){this.lastVelocity={x:0,y:0};return}this.lastVelocity={x:(e.x-t.x)/i,y:(e.y-t.y)/i}}startMomentumScroll(){if(Math.sqrt(this.lastVelocity.x*this.lastVelocity.x+this.lastVelocity.y*this.lastVelocity.y)<this.config.momentumThreshold/1e3)return;this.stopMomentumScroll();let t=this.lastVelocity.x,i=this.lastVelocity.y,s=Date.now();const n=()=>{const a=Date.now(),o=a-s;if(s=a,t*=this.config.friction,i*=this.config.friction,Math.sqrt(t*t+i*i)<.01){this.stopMomentumScroll();return}const c={velocityX:t,velocityY:i,duration:o};this.emitGesture("momentum",null,c),this.momentumTimer=requestAnimationFrame(n)};this.momentumTimer=requestAnimationFrame(n)}stopMomentumScroll(){this.momentumTimer!==null&&(cancelAnimationFrame(this.momentumTimer),this.momentumTimer=null)}emitGesture(e,t,i){const s={type:e,target:t,detail:i,timestamp:Date.now(),preventDefault:()=>this.preventDefaultGestures.add(e)},n=this.listeners.get(e);n&&n.forEach(a=>{(!a.element||a.element===t||a.element.contains(t))&&a.handler(s)})}shouldPreventDefault(e){return this.preventDefaultGestures.has(e)}on(e,t,i){const s={element:i||this.element,type:e,handler:t};this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s)}off(e,t){const i=this.listeners.get(e);i&&i.forEach(s=>{s.handler===t&&i.delete(s)})}setPreventDefault(e,t){t?this.preventDefaultGestures.add(e):this.preventDefaultGestures.delete(e)}updateConfig(e){this.config=g(g({},this.config),e)}destroy(){this.element.removeEventListener("touchstart",this.handleTouchStart.bind(this)),this.element.removeEventListener("touchmove",this.handleTouchMove.bind(this)),this.element.removeEventListener("touchend",this.handleTouchEnd.bind(this)),this.element.removeEventListener("touchcancel",this.handleTouchCancel.bind(this)),this.element.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.element.removeEventListener("mousemove",this.handleMouseMove.bind(this)),this.element.removeEventListener("mouseup",this.handleMouseUp.bind(this)),this.element.removeEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.cancelLongPress(),this.stopMomentumScroll(),this.touchPoints.clear(),this.listeners.clear(),this.preventDefaultGestures.clear(),this.moveHistory=[]}}const v=class v{constructor(){r(this,"game",null);r(this,"touchGestureManager",null);r(this,"isMobile",!1)}static getInstance(){return v.instance||(v.instance=new v),v.instance}initialize(e){if(!this.game)try{this.isMobile=this.checkMobileDevice();const t=g({},z);if(t.parent=e,this.isMobile&&(this.setupMobileViewport(),t.scale=P(g({},t.scale),{mode:S.Scale.RESIZE,width:window.innerWidth,height:window.innerHeight})),t.scene=[B,F,H],this.game=new S.Game(t),typeof e=="string"){const i=document.getElementById(e);i&&this.initializeTouchGestures(i)}else e instanceof HTMLElement&&this.initializeTouchGestures(e);this.setupResponsiveHandlers()}catch(t){throw console.error("‚ùå GameManager: „Ç≤„Éº„É†ÂàùÊúüÂåñ„Ç®„É©„Éº:",t),t}}destroy(){this.touchGestureManager&&(this.touchGestureManager.destroy(),this.touchGestureManager=null),this.removeResponsiveHandlers(),this.game&&(this.game.destroy(!0,!1),this.game=null)}isInitialized(){return this.game!==null}getCurrentScene(){if(!this.game)return null;const e=this.game.scene.getScenes(!0);return e.length>0?e[0].scene.key:null}switchScene(e,t){if(!this.game)return;const i=this.game.scene.getScenes(!0)[0];i&&i.scene.start(e,t)}reset(){this.game&&(this.game.scene.getScenes(!0).forEach(e=>{e.scene.stop()}),this.game.scene.start("PreloadScene"))}clearCache(){if(!this.game)return;const e=this.game.textures,t=[];e.list.forEach((i,s)=>{s!=="__DEFAULT"&&s!=="__MISSING"&&s!=="__WHITE"&&t.push(s)}),t.forEach(i=>{try{e.remove(i)}catch(s){}}),this.game.sound&&this.game.sound.removeAll(),typeof window!="undefined"&&window.gc&&window.gc()}checkMobileDevice(){const e=navigator.userAgent||navigator.vendor||window.opera,t="ontouchstart"in window||navigator.maxTouchPoints>0,s=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),n=window.innerWidth<=768;return t||s||n}setupMobileViewport(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.setAttribute("name","viewport"),document.head.appendChild(e)),e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"),document.body.style.touchAction="none",document.body.style.overscrollBehavior="none",document.body.style.webkitOverflowScrolling="touch",document.body.style.position="fixed",document.body.style.width="100%",document.body.style.height="100%",document.body.style.overflow="hidden"}initializeTouchGestures(e){this.touchGestureManager=new Y(e,{swipeThreshold:50,swipeVelocityThreshold:.3,doubleTapThreshold:300,longPressThreshold:500,pinchThreshold:.1,dragThreshold:10}),this.setupGlobalGestures()}setupGlobalGestures(){this.touchGestureManager&&(this.touchGestureManager.on("pinch",e=>{e.detail.scale>1.2?this.handleZoomIn():e.detail.scale<.8&&this.handleZoomOut()}),this.touchGestureManager.on("doubletap",()=>{this.toggleFullscreen()}),this.touchGestureManager.setPreventDefault("drag",!0),this.touchGestureManager.setPreventDefault("swipe",!0))}setupResponsiveHandlers(){this.handleOrientationChange=this.handleOrientationChange.bind(this),window.addEventListener("orientationchange",this.handleOrientationChange),this.handleResize=this.handleResize.bind(this),window.addEventListener("resize",this.handleResize),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this.handleVisibilityChange)}removeResponsiveHandlers(){window.removeEventListener("orientationchange",this.handleOrientationChange),window.removeEventListener("resize",this.handleResize),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}handleOrientationChange(){setTimeout(()=>{if(this.handleResize(),this.game){const e=this.game.scene.getScenes(!0)[0];e!=null&&e.events&&e.events.emit("orientationchange",window.orientation)}},300)}handleResize(){this.game&&(this.game.scale.resize(window.innerWidth,window.innerHeight),this.updateSafeArea())}handleVisibilityChange(){this.game&&(document.hidden?(this.game.sound.pauseAll(),this.game.loop.sleep()):(this.game.sound.resumeAll(),this.game.loop.wake()))}updateSafeArea(){const e={top:parseInt(getComputedStyle(document.documentElement).getPropertyValue("env(safe-area-inset-top)")||"0"),right:parseInt(getComputedStyle(document.documentElement).getPropertyValue("env(safe-area-inset-right)")||"0"),bottom:parseInt(getComputedStyle(document.documentElement).getPropertyValue("env(safe-area-inset-bottom)")||"0"),left:parseInt(getComputedStyle(document.documentElement).getPropertyValue("env(safe-area-inset-left)")||"0")};this.game&&this.game.registry&&this.game.registry.set("safeAreaInsets",e)}handleZoomIn(){if(this.game){const e=this.game.scale.zoom;this.game.scale.setZoom(Math.min(e*1.1,2))}}handleZoomOut(){if(this.game){const e=this.game.scale.zoom;this.game.scale.setZoom(Math.max(e*.9,.5))}}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(e=>{console.warn("„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„É™„ÇØ„Ç®„Çπ„Éà„Å´Â§±Êïó:",e)})}getTouchGestureManager(){return this.touchGestureManager}getIsMobile(){return this.isMobile}};r(v,"instance",null);let E=v;const oe=Object.freeze(Object.defineProperty({__proto__:null,GameManager:E},Symbol.toStringTag,{value:"Module"}));export{ie as D,ne as E,T as G,te as I,se as K,ae as M,M as S,Q as T,J as a,oe as b,j as g,ee as s};
//# sourceMappingURL=game-engine-BEWVGSCW.js.map
