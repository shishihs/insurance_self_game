var e=Object.defineProperty,t=(t,a,r)=>((t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r)(t,"symbol"!=typeof a?a+"":a,r);class a{constructor(e,a=[]){t(this,"cards"),t(this,"name"),this.name=e,this.cards=[...a]}getName(){return this.name}size(){return this.cards.length}isEmpty(){return 0===this.cards.length}addCard(e){this.cards.push(e)}addCards(e){this.cards.push(...e)}drawCard(){return this.cards.pop()||null}drawCards(e){const t=[];for(let a=0;a<e&&!this.isEmpty();a++){const e=this.drawCard();e&&t.push(e)}return t}removeCard(e){const t=this.cards.findIndex(t=>t.id===e);return-1!==t&&(this.cards.splice(t,1),!0)}shuffle(){for(let e=this.cards.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}getCards(){return[...this.cards]}countCardsByType(e){return this.cards.filter(t=>t.type===e).length}clear(){this.cards=[]}clone(){return new a(this.name,this.cards.map(e=>e.clone()))}getStats(){const e={total:this.cards.length,byType:{life:0,insurance:0,pitfall:0},averagePower:0,averageCost:0};let t=0,a=0;return this.cards.forEach(r=>{e.byType[r.type]++,t+=r.power,a+=r.cost}),e.averagePower=e.total>0?t/e.total:0,e.averageCost=e.total>0?a/e.total:0,e}}const r=class e{constructor(e){this.value=e,this.validate()}static create(t){return new e(t)}validate(){if(this.value<e.MIN_POWER)throw new Error(`CardPower must be at least ${e.MIN_POWER}`);if(this.value>e.MAX_POWER)throw new Error("Card power cannot exceed maximum")}getValue(){return this.value}add(t){const a=this.value+t.value;return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}static sum(t){const a=t.reduce((e,t)=>e+t.value,0);return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}multiply(t){if(t<0)throw new Error("Multiplier cannot be negative");const a=Math.floor(this.value*t);return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}isGreaterThan(e){return this.value>e.value}isGreaterThanOrEqual(e){return this.value>=e.value}equals(e){return this.value===e.value}toString(){return`Power: ${this.value}`}static get ZERO(){return new e(0)}static get MAX(){return new e(e.MAX_POWER)}};t(r,"MIN_POWER",-99),t(r,"MAX_POWER",999);let s=r;const i=class e{constructor(e){this.value=e,this.validate()}static create(t){return new e(Math.floor(t))}validate(){if(this.value<e.MIN_PREMIUM)throw new Error("InsurancePremium must be non-negative");if(this.value>e.MAX_PREMIUM)throw new Error("InsurancePremium cannot exceed maximum")}getValue(){return this.value}static sum(t){const a=t.reduce((e,t)=>e+t.value,0);return new e(Math.min(a,e.MAX_PREMIUM))}applyDiscount(t){if(t<0)throw new Error("Discount rate cannot be negative");if(t>1)throw new Error("Discount rate cannot exceed 100%");const a=Math.floor(this.value*(1-t));return new e(a)}applyMultiplier(t){if(t<0)throw new Error("Multiplier cannot be negative");const a=Math.floor(this.value*t);return new e(Math.min(a,e.MAX_PREMIUM))}isFree(){return 0===this.value}isExpensive(){return this.value>=e.EXPENSIVE_THRESHOLD}isHigherThan(e){return this.value>e.value}isAffordableWith(e){return e>=this.value}equals(e){return this.value===e.value}toString(){return this.isFree()?"ä¿é™ºæ–™: ç„¡æ–™":`ä¿é™ºæ–™: ${this.value}`}static get FREE(){return new e(0)}};t(i,"MIN_PREMIUM",0),t(i,"MAX_PREMIUM",99),t(i,"EXPENSIVE_THRESHOLD",20);let n=i;class c{static generate(e="id"){return`${e}_${Date.now()}_${this.getRandomString()}`}static generateCardId(){return this.generate("card")}static generateGameId(){return this.generate("game")}static generateCommandId(){return this.generate("cmd")}static generateNotificationId(){return this.generate("notification")}static generateFeedbackId(){return this.generate("feedback")}static generateSequential(e="seq"){return`${e}_${++this.counter}`}static generateUUID(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});return e?`${e}_${t}`:t}static getRandomString(e=9){return Math.random().toString(36).substr(2,e)}static resetCounter(){this.counter=0}static getCurrentCounter(){return this.counter}}t(c,"counter",0);class o{constructor(e){t(this,"id"),t(this,"name"),t(this,"description"),t(this,"type"),t(this,"_power"),t(this,"_cost"),t(this,"effects"),t(this,"imageUrl"),t(this,"category"),t(this,"insuranceType"),t(this,"coverage"),t(this,"penalty"),t(this,"ageBonus"),t(this,"durationType"),t(this,"remainingTurns"),t(this,"insuranceEffectType"),t(this,"dreamCategory"),t(this,"skillProperties"),t(this,"comboProperties"),t(this,"eventProperties"),t(this,"isUnlockable"),t(this,"unlockCondition"),t(this,"rewardType"),this.id=e.id,this.name=e.name,this.description=e.description,this.type=e.type,this._power=s.create(e.power),this._cost=n.create(e.cost),this.effects=e.effects,this.imageUrl=e.imageUrl,this.category=e.category,this.insuranceType=e.insuranceType,this.coverage=e.coverage,this.penalty=e.penalty,"ageBonus"in e&&(this.ageBonus=e.ageBonus),"durationType"in e&&(this.durationType=e.durationType),"remainingTurns"in e&&(this.remainingTurns=e.remainingTurns),"insuranceEffectType"in e&&(this.insuranceEffectType=e.insuranceEffectType),"dreamCategory"in e&&(this.dreamCategory=e.dreamCategory),"skillProperties"in e&&(this.skillProperties=e.skillProperties),"comboProperties"in e&&(this.comboProperties=e.comboProperties),"eventProperties"in e&&(this.eventProperties=e.eventProperties),"isUnlockable"in e&&(this.isUnlockable=e.isUnlockable),"unlockCondition"in e&&(this.unlockCondition=e.unlockCondition),"rewardType"in e&&(this.rewardType=e.rewardType)}get power(){return this._power.getValue()}get cost(){return this._cost.getValue()}getPower(){return this._power}getCost(){return this._cost}hasEffect(e){return this.effects.some(t=>t.type===e)}getEffect(e){return this.effects.find(t=>t.type===e)}isInsurance(){return"insurance"===this.type}isTermInsurance(){return this.isInsurance()&&"term"===this.durationType}isWholeLifeInsurance(){return this.isInsurance()&&"whole_life"===this.durationType}getInsuranceEffectType(){if(this.isInsurance())return this.insuranceEffectType||"offensive"}isDefensiveInsurance(){return this.isInsurance()&&"defensive"===this.getInsuranceEffectType()}isRecoveryInsurance(){return this.isInsurance()&&"recovery"===this.getInsuranceEffectType()}isSpecializedInsurance(){return this.isInsurance()&&"specialized"===this.getInsuranceEffectType()}calculateDamageReduction(){if(!this.isInsurance())return 0;if(!this.isDefensiveInsurance()&&!this.hasEffect("damage_reduction"))return 0;let e=0;this.isDefensiveInsurance()&&(e+=.5*(this.coverage||0));const t=this.getEffect("damage_reduction");return t&&(e+=.5*t.value),Math.min(e,2)}calculateTurnHeal(){if(!this.isRecoveryInsurance())return 0;const e=Math.floor((this.coverage||0)/20),t=this.getEffect("turn_heal");return e+(t?t.value:0)}calculateChallengeBonus(e){if(!this.isSpecializedInsurance())return 0;const t=this.getEffect("challenge_bonus");return t?.condition&&t.condition.includes(e)?t.value:0}isDreamCard(){return"dream"===this.type}copy(e){return new o({...this,power:this.power,cost:this.cost,effects:[...this.effects],...e})}clone(){return this.copy()}decrementRemainingTurns(){return this.isTermInsurance()&&this.remainingTurns?this.copy({remainingTurns:Math.max(0,this.remainingTurns-1)}):this}isExpired(){return!!this.isTermInsurance()&&0===this.remainingTurns}hasPowerAtLeast(e){const t=s.create(e);return this._power.isGreaterThanOrEqual(t)}isAffordableWith(e){return this._cost.isAffordableWith(e)}calculateEffectivePower(e){let t=this.power;return this.isInsurance()&&this.ageBonus&&(t+=this.ageBonus),void 0!==e&&(t+=e),this.isInsurance()&&"offensive"!==this.getInsuranceEffectType()?0:Math.max(0,t)}isLifeCard(){return"life"===this.type}isInsuranceCard(){return this.isInsurance()}isPitfallCard(){return"pitfall"===this.type}isSkillCard(){return"skill"===this.type}isComboCard(){return"combo"===this.type}isEventCard(){return"event"===this.type}isLegendaryCard(){return"legendary"===this.type}isChallengeCard(){return"challenge"===this.type}toDisplayString(){let e=`${this.name} - Power: ${this.power}, Cost: ${this.cost}`;return this.effects.length>0&&(e+=` - Effects: ${this.effects.map(e=>e.description).join(", ")}`),e}decrementTurn(){void 0!==this.remainingTurns&&this.remainingTurns>0&&this.remainingTurns--}static createLifeCard(e,t){const a=t>0?"+":"";return new o({id:c.generate("life"),name:e,description:`ãƒ‘ãƒ¯ãƒ¼: ${a}${t}`,type:"life",power:t,cost:0,effects:[]})}static createChallengeCard(e,t){return new o({id:c.generate("challenge"),name:e,description:`å¿…è¦ãƒ‘ãƒ¯ãƒ¼: ${t}`,type:"challenge",power:t,cost:0,effects:[]})}static createInsuranceCard(e,t,a=1,...r){return new o({id:c.generate("insurance"),name:e,description:`ä¿é™ºã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${t}`,type:"insurance",power:t,cost:a,effects:r})}static createSkillCard(e,t,a,r){return new o({id:c.generate("skill"),name:e,description:`${{common:"ã‚³ãƒ¢ãƒ³",rare:"ãƒ¬ã‚¢",epic:"ã‚¨ãƒ”ãƒƒã‚¯",legendary:"ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼"}[t]}ã‚¹ã‚­ãƒ« - ãƒ‘ãƒ¯ãƒ¼: +${a}`,type:"skill",power:a,cost:0,effects:[],skillProperties:{rarity:t,cooldown:r,remainingCooldown:0,masteryLevel:1}})}static createComboCard(e,t,a,r){return new o({id:c.generate("combo"),name:e,description:`ã‚³ãƒ³ãƒœã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${t} (ã‚³ãƒ³ãƒœæ™‚: +${r})`,type:"combo",power:t,cost:0,effects:[],comboProperties:{requiredCards:a,comboBonus:r}})}static createEventCard(e,t,a,r=!1){return new o({id:c.generate("event"),name:e,description:`ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ - ${a}ã‚¿ãƒ¼ãƒ³ç¶™ç¶š`,type:"event",power:t,cost:0,effects:[],eventProperties:{duration:a,globalEffect:r}})}static createLegendaryCard(e,t,a){return new o({id:c.generate("legendary"),name:e,description:`ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ - ãƒ‘ãƒ¯ãƒ¼: +${t}`,type:"legendary",power:t,cost:0,effects:[],isUnlockable:!0,unlockCondition:a})}}class l extends o{constructor(e){const a=[];"extreme"===e.riskLevel&&a.push({type:"special_action",value:0,description:"ä¿é™ºåŠ¹æœç„¡åŠ¹åŒ–",condition:"ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ä¿é™ºã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¯ãƒ¼ãŒç„¡åŠ¹"}),super({id:c.generateCardId(),type:"challenge",name:e.name,description:e.description,power:e.power,cost:0,effects:a,dreamCategory:e.dreamCategory}),t(this,"riskLevel"),t(this,"successBonus"),t(this,"failurePenalty"),t(this,"insuranceImmunity"),this.riskLevel=e.riskLevel,this.successBonus=e.successBonus,this.failurePenalty=e.failurePenalty,this.insuranceImmunity=e.insuranceImmunity||"extreme"===e.riskLevel}getRiskMultiplier(){return{low:1.2,medium:1.5,high:2,extreme:3}[this.riskLevel]}calculateActualReward(e){return Math.floor(e*this.getRiskMultiplier())+this.successBonus}calculateActualPenalty(e){return Math.floor(e*this.getRiskMultiplier())+this.failurePenalty}getRiskDescription(){return{low:"ä½ãƒªã‚¹ã‚¯: å°‘ã—å±é™ºã ãŒã€å¤±æ•—ã—ã¦ã‚‚ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯è»½ã„",medium:"ä¸­ãƒªã‚¹ã‚¯: æˆåŠŸã¨å¤±æ•—ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã‚‹",high:"é«˜ãƒªã‚¹ã‚¯: å¤±æ•—æ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¤§ãã„ãŒã€å ±é…¬ã‚‚é­…åŠ›çš„",extreme:"æ¥µé™ãƒªã‚¹ã‚¯: ä¿é™ºã‚‚åŠ¹ã‹ãªã„å±é™ºãªæŒ‘æˆ¦ã€‚æˆåŠŸã™ã‚Œã°å¤§ããªå ±é…¬"}[this.riskLevel]}getChallengeDetails(){return[`å¿…è¦ãƒ‘ãƒ¯ãƒ¼: ${this.power}`,`ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: ${this.riskLevel.toUpperCase()}`,`æˆåŠŸãƒœãƒ¼ãƒŠã‚¹: +${this.successBonus} æ´»åŠ›`,`å¤±æ•—ãƒšãƒŠãƒ«ãƒ†ã‚£: -${this.failurePenalty} æ´»åŠ›`,this.insuranceImmunity?"âš ï¸ ä¿é™ºç„¡åŠ¹":""].filter(Boolean).join("\n")}static createRiskChallenge(e,t){const a={youth:{low:{name:"æ–°ã—ã„ã‚¹ãƒãƒ¼ãƒ„ã¸ã®æŒ‘æˆ¦",description:"æœªçµŒé¨“ã®åˆ†é‡ã«æŒ‘æˆ¦ã™ã‚‹å‹‡æ°—",power:5,successBonus:2,failurePenalty:1},medium:{name:"èµ·æ¥­ã¸ã®ç¬¬ä¸€æ­©",description:"å®‰å®šã‚’æ¨ã¦ã¦å¤¢ã‚’è¿½ã†æ±ºæ–­",power:7,successBonus:5,failurePenalty:3},high:{name:"æµ·å¤–ç•™å­¦",description:"æœªçŸ¥ã®ä¸–ç•Œã¸ã®å¤§ããªé£›èº",power:9,successBonus:8,failurePenalty:5},extreme:{name:"äººç”Ÿã‚’è³­ã‘ãŸå¤§å‹è² ",description:"å…¨ã¦ã‚’æŠ•ã’æ‰“ã£ã¦æŒ‘ã‚€æœ€å¤§ã®æŒ‘æˆ¦",power:12,successBonus:15,failurePenalty:10}},middle:{low:{name:"å‰¯æ¥­ã®é–‹å§‹",description:"æ–°ãŸãªåå…¥æºã¸ã®æŒ‘æˆ¦",power:6,successBonus:3,failurePenalty:2},medium:{name:"ç‹¬ç«‹é–‹æ¥­",description:"ä¼šç¤¾ã‚’è¾ã‚ã¦ç‹¬ç«‹ã™ã‚‹æ±ºæ–­",power:9,successBonus:7,failurePenalty:5},high:{name:"å¤§å‹æŠ•è³‡",description:"å°†æ¥ã‚’è¦‹æ®ãˆãŸå¤§èƒ†ãªæŠ•è³‡",power:11,successBonus:10,failurePenalty:7},extreme:{name:"äººç”Ÿã®å¤§è»¢æ›",description:"å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é“ã¸",power:15,successBonus:20,failurePenalty:15}},fulfillment:{low:{name:"æ–°ã—ã„è¶£å‘³ã¸ã®æŒ‘æˆ¦",description:"å¹´é½¢ã«é–¢ä¿‚ãªãæ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹",power:7,successBonus:4,failurePenalty:2},medium:{name:"ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•",description:"ç¤¾ä¼šè²¢çŒ®ã¸ã®æ–°ãŸãªä¸€æ­©",power:10,successBonus:8,failurePenalty:4},high:{name:"éºç”£ã®æ´»ç”¨",description:"æ¬¡ä¸–ä»£ã¸ã®å¤§ããªæŠ•è³‡",power:13,successBonus:12,failurePenalty:8},extreme:{name:"äººç”Ÿæœ€å¾Œã®å¤§å†’é™º",description:"æ®‹ã•ã‚ŒãŸæ™‚é–“ã§ã®ç©¶æ¥µã®æŒ‘æˆ¦",power:18,successBonus:25,failurePenalty:20}}}[e][t];return new l({...a,riskLevel:t,dreamCategory:"extreme"===t?"mixed":"physical"})}}class u{static calculateAgeBonus(e){switch(e){case"middle":return.5;case"fulfillment":return 1;default:return 0}}static createCardsFromDefinitions(e,t){return e.map(e=>t(e))}static createStarterLifeCards(){return this.createCardsFromDefinitions([{name:"æœã®ã‚¸ãƒ§ã‚®ãƒ³ã‚°",description:"å¥åº·çš„ãªä¸€æ—¥ã®å§‹ã¾ã‚Š",category:"health",power:2,cost:1},{name:"æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„é£Ÿäº‹",description:"ä½“èª¿ç®¡ç†ã®åŸºæœ¬",category:"health",power:3,cost:2},{name:"æ–°ã—ã„ã‚¹ã‚­ãƒ«ã®ç¿’å¾—",description:"æˆé•·ã¸ã®æŠ•è³‡",category:"career",power:3,cost:2},{name:"ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯",description:"ä»²é–“ã¨ã®å”åŠ›",category:"career",power:2,cost:1},{name:"å®¶æ—ã¨ã®å›£ã‚‰ã‚“",description:"å¿ƒã®å……é›»",category:"family",power:2,cost:1},{name:"è¶£å‘³ã®æ™‚é–“",description:"ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒ ",category:"hobby",power:2,cost:1},{name:"è¨ˆç”»çš„ãªè²¯è“„",description:"å°†æ¥ã¸ã®å‚™ãˆ",category:"finance",power:3,cost:2}],e=>this.createLifeCard(e))}static createBasicInsuranceCards(e="youth"){const t=this.calculateAgeBonus(e);return this.createCardsFromDefinitions([{name:"åŒ»ç™‚ä¿é™º",description:"ç—…æ°—ã‚„ã‚±ã‚¬ã«å‚™ãˆã‚‹æ°¸ç¶šä¿éšœ",insuranceType:"medical",power:4,cost:3,coverage:100},{name:"ç”Ÿå‘½ä¿é™º",description:"å®¶æ—ã‚’å®ˆã‚‹æ°¸ç¶šä¿éšœ",insuranceType:"life",power:5,cost:4,coverage:200},{name:"åå…¥ä¿éšœä¿é™º",description:"åƒã‘ãªããªã£ãŸæ™‚ã®æ°¸ç¶šä¿éšœ",insuranceType:"income",power:4,cost:3,coverage:150}],e=>this.createInsuranceCard({...e,ageBonus:t}))}static createExtendedInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e),r=this.createCardsFromDefinitions([{name:"åŒ»ç™‚ä¿é™º",insuranceType:"medical",power:5,cost:4,coverage:100},{name:"ç”Ÿå‘½ä¿é™º",insuranceType:"life",power:6,cost:5,coverage:200},{name:"åå…¥ä¿éšœä¿é™º",insuranceType:"income",power:5,cost:4,coverage:150}],e=>this.createInsuranceCard({name:e.name,description:`${e.name}ã®æ°¸ç¶šä¿éšœ`,insuranceType:e.insuranceType,power:e.power,cost:e.cost,coverage:e.coverage,ageBonus:a}));t.push(...r);const s=this.createCardsFromDefinitions([{name:"å‚·å®³ä¿é™º",insuranceType:"medical",power:4,cost:3,coverage:80},{name:"å°±æ¥­ä¸èƒ½ä¿é™º",insuranceType:"income",power:7,cost:6,coverage:250},{name:"ä»‹è­·ä¿é™º",insuranceType:"medical",power:6,cost:5,coverage:180},{name:"ãŒã‚“ä¿é™º",insuranceType:"medical",power:5,cost:4,coverage:120},{name:"å€‹äººå¹´é‡‘ä¿é™º",insuranceType:"income",power:4,cost:4,coverage:100},{name:"å­¦è³‡ä¿é™º",insuranceType:"life",power:4,cost:3,coverage:90}],e=>this.createInsuranceCard({name:e.name,description:`${e.name}ã®æ°¸ç¶šä¿éšœ`,insuranceType:e.insuranceType,power:e.power,cost:e.cost,coverage:e.coverage,ageBonus:a}));return t.push(...s),t}static createDiverseInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e);return t.push(new o({id:c.generateCardId(),type:"insurance",name:"æ”»æ’ƒç‰¹åŒ–ç”Ÿå‘½ä¿é™º",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ™‚ã«å¤§ããªãƒ‘ãƒ¯ãƒ¼ã‚’æä¾›",power:8,cost:5,insuranceType:"life",insuranceEffectType:"offensive",coverage:150,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"é˜²å¾¡ç‰¹åŒ–åŒ»ç™‚ä¿é™º",description:"ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹é˜²å¾¡çš„ä¿éšœ",power:0,cost:4,insuranceType:"medical",insuranceEffectType:"defensive",coverage:100,effects:[{type:"damage_reduction",value:3,description:"ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’3ãƒã‚¤ãƒ³ãƒˆè»½æ¸›"}],ageBonus:0,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"å›å¾©ç‰¹åŒ–å¥åº·ä¿é™º",description:"æ¯ã‚¿ãƒ¼ãƒ³æ´»åŠ›ã‚’å›å¾©",power:0,cost:3,insuranceType:"health",insuranceEffectType:"recovery",coverage:80,effects:[{type:"turn_heal",value:2,description:"æ¯ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«2ç‚¹å›å¾©"}],ageBonus:0,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ä»•äº‹ç‰¹åŒ–åå…¥ä¿éšœä¿é™º",description:"ä»•äº‹é–¢é€£ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«ç‰¹åŒ–",power:3,cost:4,insuranceType:"income",insuranceEffectType:"specialized",coverage:120,effects:[{type:"challenge_bonus",value:5,description:"ã€Œå°±è·ã€ã€Œæ˜é€²ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ™‚+5ãƒ‘ãƒ¯ãƒ¼",condition:"å°±è·,æ˜é€²,è»¢è·,ä»•äº‹"}],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ç·åˆä¿é™º",description:"è¤‡æ•°ã®åŠ¹æœã‚’æŒã¤é«˜ã‚³ã‚¹ãƒˆä¿éšœ",power:3,cost:7,insuranceType:"life",insuranceEffectType:"comprehensive",coverage:200,effects:[{type:"power_boost",value:3,description:"ãƒ‘ãƒ¯ãƒ¼+3"},{type:"damage_reduction",value:2,description:"ãƒ€ãƒ¡ãƒ¼ã‚¸-2"},{type:"turn_heal",value:1,description:"æ¯ã‚¿ãƒ¼ãƒ³+1å›å¾©"}],ageBonus:a,durationType:"whole_life"})),t}static createInsuranceTypeChoices(e="youth"){const t=[],a=this.calculateAgeBonus(e),r=[{type:"medical",name:"åŒ»ç™‚ä¿é™º",description:"ç—…æ°—ã‚„ã‚±ã‚¬ã«å‚™ãˆã‚‹ä¿éšœ",power:5,baseCost:4,coverage:100,effectType:"offensive"},{type:"life",name:"ç”Ÿå‘½ä¿é™º",description:"å®¶æ—ã‚’å®ˆã‚‹ä¿éšœ",power:6,baseCost:5,coverage:200,effectType:"offensive"},{type:"income",name:"åå…¥ä¿éšœä¿é™º",description:"åƒã‘ãªããªã£ãŸæ™‚ã®ä¿éšœ",power:5,baseCost:4,coverage:150,effectType:"offensive"},{type:"health",name:"é˜²å¾¡å‹å¥åº·ä¿é™º",description:"ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹é˜²å¾¡çš„ä¿éšœ",power:0,baseCost:3,coverage:80,effectType:"defensive"},{type:"disability",name:"å›å¾©å‹éšœå®³ä¿é™º",description:"å®šæœŸçš„ã«æ´»åŠ›ã‚’å›å¾©",power:0,baseCost:3,coverage:60,effectType:"recovery"}];for(let s=0;s<3&&r.length>0;s++){const e=Math.floor(Math.random()*r.length),s=r.splice(e,1)[0],i=10,n=Math.ceil(.7*s.baseCost),c=s.baseCost,o={insuranceType:s.type,name:s.name,description:s.description,baseCard:{name:s.name,description:s.description,type:"insurance",power:s.power,cost:s.baseCost,insuranceType:s.type,coverage:s.coverage,insuranceEffectType:s.effectType,effects:[{type:"shield",value:s.coverage,description:`${s.coverage}ãƒã‚¤ãƒ³ãƒˆã®ä¿éšœ`}],ageBonus:a},termOption:{cost:n,duration:i,description:`${i}ã‚¿ãƒ¼ãƒ³é™å®šã®ä¿éšœï¼ˆä½ã‚³ã‚¹ãƒˆï¼‰`},wholeLifeOption:{cost:c,description:"ç”Ÿæ¶¯ã«ã‚ãŸã‚‹æ°¸ç¶šä¿éšœï¼ˆé«˜ã‚³ã‚¹ãƒˆï¼‰"}};t.push(o)}return t}static createTermInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:`å®šæœŸ${e.name}`,description:`${e.baseCard.description}ï¼ˆ${e.termOption.duration}ã‚¿ãƒ¼ãƒ³é™å®šï¼‰`,power:e.baseCard.power,cost:e.termOption.cost,insuranceType:e.insuranceType,coverage:e.baseCard.coverage,effects:e.baseCard.effects,ageBonus:e.baseCard.ageBonus,insuranceEffectType:e.baseCard.insuranceEffectType,durationType:"term",remainingTurns:e.termOption.duration})}static createWholeLifeInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:`çµ‚èº«${e.name}`,description:`${e.baseCard.description}ï¼ˆæ°¸ç¶šä¿éšœï¼‰`,power:e.baseCard.power,cost:e.wholeLifeOption.cost,insuranceType:e.insuranceType,coverage:e.baseCard.coverage,effects:e.baseCard.effects,ageBonus:e.baseCard.ageBonus,insuranceEffectType:e.baseCard.insuranceEffectType,durationType:"whole_life"})}static createChallengeCards(e){const t={youth:[{name:"ã‚¢ãƒ«ãƒã‚¤ãƒˆæ¢ã—",description:"åˆã‚ã¦ã®åå…¥ã‚’å¾—ã‚‹",power:3,dreamCategory:"physical"},{name:"ä¸€äººæš®ã‚‰ã—",description:"ç‹¬ç«‹ã¸ã®ç¬¬ä¸€æ­©",power:4,dreamCategory:"physical"},{name:"è³‡æ ¼è©¦é¨“",description:"ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã®ãƒãƒ£ãƒ³ã‚¹",power:5,dreamCategory:"intellectual"},{name:"å°±è·æ´»å‹•",description:"æ–°ãŸãªã‚­ãƒ£ãƒªã‚¢ã®å§‹ã¾ã‚Š",power:6,dreamCategory:"physical"},{name:"æ‹äººã¨ã®åˆ¥ã‚Œ",description:"åˆã‚ã¦ã®å¤§ããªå¤±æ„",power:5,dreamCategory:"mixed"},{name:"è»¢è·æ´»å‹•",description:"ã‚­ãƒ£ãƒªã‚¢ã®åˆ†å²ç‚¹",power:6,dreamCategory:"intellectual"}],middle:[{name:"çµå©šè³‡é‡‘",description:"æ–°ã—ã„å®¶æ—ã®ã‚¹ã‚¿ãƒ¼ãƒˆ",power:5,dreamCategory:"mixed"},{name:"å­è‚²ã¦",description:"å®¶æ—ã®æˆé•·",power:6,dreamCategory:"physical"},{name:"ä¸¡è¦ªã®å¥åº·",description:"å®¶æ—ã®æ”¯ãˆåˆã„",power:6,dreamCategory:"mixed"},{name:"ä½å®…è³¼å…¥",description:"å¤§ããªæ±ºæ–­",power:7,dreamCategory:"physical"},{name:"è¦ªã®ä»‹è­·",description:"å®¶æ—ã®è²¬ä»»",power:8,dreamCategory:"mixed"},{name:"æ•™è‚²è³‡é‡‘",description:"å­ä¾›ã®å°†æ¥ã¸ã®æŠ•è³‡",power:7,dreamCategory:"intellectual"}],fulfillment:[{name:"å¥åº·ç®¡ç†",description:"å¥ã‚„ã‹ãªè€å¾Œã®ãŸã‚ã«",power:7,dreamCategory:"mixed"},{name:"è¶£å‘³ã®å……å®Ÿ",description:"äººç”Ÿã®æ–°ãŸãªæ¥½ã—ã¿",power:7,dreamCategory:"intellectual"},{name:"ç¤¾ä¼šè²¢çŒ®",description:"çµŒé¨“ã‚’æ´»ã‹ã—ãŸæ´»å‹•",power:8,dreamCategory:"mixed"},{name:"å®šå¹´é€€è·",description:"æ–°ã—ã„äººç”Ÿã®ã‚¹ã‚¿ãƒ¼ãƒˆ",power:9,dreamCategory:"intellectual"},{name:"éºç”£ç›¸ç¶š",description:"å®¶æ—ã¸ã®æœ€å¾Œã®è´ˆã‚Šç‰©",power:10,dreamCategory:"intellectual"},{name:"å¥åº·ä¸Šã®å¤§ããªè©¦ç·´",description:"äººç”Ÿæœ€å¤§ã®æŒ‘æˆ¦",power:11,dreamCategory:"physical"}]},a=[...t[e]||t.fulfillment].sort(()=>Math.random()-.5),r=3+Math.floor(2*Math.random()),s=a.slice(0,r);return[...this.createCardsFromDefinitions(s,e=>this.createChallengeCard(e)),...this.createRiskRewardChallenges(e)]}static createRiskRewardChallenges(e){const t=[],a={youth:{low:.5,medium:.3,high:.15,extreme:.05},middle:{low:.3,medium:.4,high:.2,extreme:.1},fulfillment:{low:.2,medium:.3,high:.3,extreme:.2}},r=a[e]||a.youth;if(Math.random()<.2){let a;const s=Math.random();a=s<r.low?"low":s<r.low+r.medium?"medium":s<r.low+r.medium+r.high?"high":"extreme";const i=l.createRiskChallenge(e,a);t.push(i)}return t}static createPitfallCards(){return this.createCardsFromDefinitions([{name:"æ€¥ãªå…¥é™¢",description:"äºˆæœŸã›ã¬åŒ»ç™‚è²»",power:0,penalty:3},{name:"å¤±æ¥­",description:"åå…¥ã®é€”çµ¶",power:0,penalty:4},{name:"äº‹æ•…",description:"äºˆæœŸã›ã¬ãƒˆãƒ©ãƒ–ãƒ«",power:0,penalty:2}],e=>this.createPitfallCard(e))}createLifeCard(e){return u.createLifeCard({name:`ãƒ†ã‚¹ãƒˆ${e.category}ã‚«ãƒ¼ãƒ‰`,description:`${e.category}ã®ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰`,category:e.category,power:e.basePower,cost:e.baseCost})}static createLifeCard(e){return new o({id:c.generateCardId(),type:"life",name:e.name,description:e.description,power:e.power,cost:e.cost,category:e.category,effects:[]})}static createInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:e.name,description:e.description,power:e.power,cost:e.cost,insuranceType:e.insuranceType,coverage:e.coverage,effects:[{type:"shield",value:e.coverage,description:`${e.coverage}ãƒã‚¤ãƒ³ãƒˆã®ä¿éšœ`}],ageBonus:e.ageBonus||0})}static createChallengeCard(e){const t=this.determineRewardType(e.power,e.dreamCategory);return new o({id:c.generateCardId(),type:e.dreamCategory?"dream":"challenge",name:e.name,description:e.description,power:e.power,cost:0,effects:[],dreamCategory:e.dreamCategory,rewardType:t})}static determineRewardType(e,t){return t?"vitality":e<=3||e<=6?"insurance":"card"}static createPitfallCard(e){return new o({id:c.generateCardId(),type:"pitfall",name:e.name,description:e.description,power:e.power,cost:0,penalty:e.penalty,effects:[]})}static createSkillCards(e="youth"){const t={youth:[{name:"é›†ä¸­åŠ›",description:"é›†ä¸­ã—ã¦å–ã‚Šçµ„ã‚€èƒ½åŠ›",rarity:"common",power:3,cooldown:0},{name:"ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³",description:"äººã¨ã®é–¢ã‚ã‚Šã‚’æ·±ã‚ã‚‹",rarity:"common",power:4,cooldown:1},{name:"ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—",description:"ãƒãƒ¼ãƒ ã‚’ç‡ã„ã‚‹åŠ›",rarity:"rare",power:6,cooldown:2},{name:"å‰µé€ æ€§",description:"æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿã¿å‡ºã™",rarity:"epic",power:8,cooldown:3}],middle:[{name:"æˆ¦ç•¥çš„æ€è€ƒ",description:"é•·æœŸçš„ãªè¦–ç‚¹ã§è€ƒãˆã‚‹",rarity:"rare",power:7,cooldown:2},{name:"ãƒ¡ãƒ³ã‚¿ãƒªãƒ³ã‚°",description:"å¾Œè¼©ã‚’æŒ‡å°ã™ã‚‹èƒ½åŠ›",rarity:"rare",power:6,cooldown:1},{name:"å±æ©Ÿç®¡ç†",description:"ãƒªã‚¹ã‚¯ã‚’äºˆæ¸¬ã—å¯¾å‡¦ã™ã‚‹",rarity:"epic",power:9,cooldown:3},{name:"ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³",description:"é©æ–°çš„ãªå¤‰åŒ–ã‚’èµ·ã“ã™",rarity:"legendary",power:12,cooldown:4}],fulfillment:[{name:"äººç”Ÿã®çŸ¥æµ",description:"çµŒé¨“ã‹ã‚‰å¾—ãŸæ·±ã„æ´å¯Ÿ",rarity:"epic",power:10,cooldown:2},{name:"ãƒ¬ã‚¬ã‚·ãƒ¼æ§‹ç¯‰",description:"æ¬¡ä¸–ä»£ã¸ã®ä¾¡å€¤ã‚ã‚‹éºç”£",rarity:"legendary",power:15,cooldown:5},{name:"ç²¾ç¥çš„å¹³å’Œ",description:"å†…ãªã‚‹èª¿å’Œã¨å®‰å®š",rarity:"legendary",power:13,cooldown:3}]},a=t[e]||t.youth;return this.createCardsFromDefinitions(a,e=>o.createSkillCard(e.name,e.rarity,e.power,e.cooldown))}static createComboCards(){return this.createCardsFromDefinitions([{name:"ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹",power:2,requiredCards:["career","family"],comboBonus:4,description:"ã‚­ãƒ£ãƒªã‚¢ã¨å®¶æ—ã®èª¿å’Œ"},{name:"å¥åº·çš„ãªæˆåŠŸ",power:3,requiredCards:["health","finance"],comboBonus:5,description:"å¥åº·ã¨çµŒæ¸ˆçš„å®‰å®šã®ä¸¡ç«‹"},{name:"å……å®Ÿã—ãŸäººç”Ÿ",power:4,requiredCards:["hobby","family","career"],comboBonus:8,description:"è¶£å‘³ãƒ»å®¶æ—ãƒ»ã‚­ãƒ£ãƒªã‚¢ã®ä¸‰ä½ä¸€ä½“"}],e=>o.createComboCard(e.name,e.power,e.requiredCards,e.comboBonus))}static createEventCards(e="youth"){const t={youth:[{name:"æ–°å¹´ã®æŠ±è² ",description:"æ–°ã—ã„å¹´ã¸ã®æ±ºæ„",power:5,duration:3,globalEffect:!1},{name:"å°±è·ãƒ–ãƒ¼ãƒ ",description:"é›‡ç”¨æ©Ÿä¼šã®å¢—åŠ ",power:4,duration:2,globalEffect:!0},{name:"å¥åº·ãƒ–ãƒ¼ãƒ ",description:"å¥åº·ã¸ã®æ„è­˜å‘ä¸Š",power:3,duration:4,globalEffect:!0}],middle:[{name:"çµŒæ¸ˆæˆé•·æœŸ",description:"ç¤¾ä¼šå…¨ä½“ã®æ´»æ³",power:6,duration:3,globalEffect:!0},{name:"å®¶æ—ã®çµ†",description:"å®¶æ—é–¢ä¿‚ã®æ·±åŒ–",power:7,duration:2,globalEffect:!1},{name:"æŠ€è¡“é©æ–°",description:"ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®é€²æ­©",power:8,duration:4,globalEffect:!0}],fulfillment:[{name:"äººç”Ÿã®ç·æ±ºç®—",description:"çµŒé¨“ã®çµ±åˆã¨æˆç†Ÿ",power:10,duration:2,globalEffect:!1},{name:"ä¸–ä»£äº¤ä»£",description:"æ¬¡ä¸–ä»£ã¸ã®ç¶™æ‰¿",power:9,duration:3,globalEffect:!0}]},a=t[e]||t.youth;return this.createCardsFromDefinitions(a,e=>o.createEventCard(e.name,e.power,e.duration,e.globalEffect))}static createLegendaryCards(){return this.createCardsFromDefinitions([{name:"äººç”Ÿã®é”äºº",power:20,unlockCondition:"å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã§50å›ä»¥ä¸ŠæˆåŠŸ",description:"äººç”ŸçµŒé¨“ã®é›†å¤§æˆ"},{name:"é‹å‘½ã‚’å¤‰ãˆã‚‹æ±ºæ–­",power:25,unlockCondition:"é€£ç¶š10å›ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸ",description:"äººç”Ÿã‚’åŠ‡çš„ã«å¤‰ãˆã‚‹ç¬é–“"},{name:"å®Œç’§ãªèª¿å’Œ",power:30,unlockCondition:"å…¨ã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’50æšä»¥ä¸Šç²å¾—",description:"ã™ã¹ã¦ã®å´é¢ãŒå®Œç’§ã«ãƒãƒ©ãƒ³ã‚¹ã—ãŸçŠ¶æ…‹"}],e=>o.createLegendaryCard(e.name,e.power,e.unlockCondition))}}const h=Object.freeze({__proto__:null,CardFactory:u}),d=class e{constructor(){t(this,"hand",[]),t(this,"discardPile",[]),t(this,"playerDeck",new a("Player Deck")),t(this,"challengeDeck",new a("Challenge Deck")),t(this,"selectedCards",[]),t(this,"cardChoices"),t(this,"config"),t(this,"_cachedState"),t(this,"_stateVersion",0)}initialize(e,t,a){this.playerDeck=e,this.challengeDeck=t,this.hand=[],this.discardPile=[],this.selectedCards=[],this.cardChoices=void 0,this.config=a}getState(){if(this._cachedState&&this._stateVersion>0)return this._cachedState;const e={hand:[...this.hand],discardPile:[...this.discardPile],playerDeck:this.playerDeck.clone(),challengeDeck:this.challengeDeck.clone(),selectedCards:[...this.selectedCards],cardChoices:this.cardChoices?[...this.cardChoices]:void 0};return this._cachedState=e,this._stateVersion++,e}setState(e){this.hand=[...e.hand],this.discardPile=[...e.discardPile],this.playerDeck=e.playerDeck.clone(),this.challengeDeck=e.challengeDeck.clone(),this.selectedCards=[...e.selectedCards],this.cardChoices=e.cardChoices?[...e.cardChoices]:void 0,this.invalidateCache()}invalidateCache(){this._cachedState=void 0,this._stateVersion=0}drawCards(t){if(!this.config)throw new Error("CardManager not initialized");let a=e.CARD_POOLS.drawResults.pop();a?(a.drawnCards.length=0,a.discardedCards.length=0):a={drawnCards:[],discardedCards:[]};for(let e=0;e<t;e++){this.playerDeck.isEmpty()&&this.discardPile.length>0&&this.reshuffleDeck();const e=this.playerDeck.drawCard();e&&(a.drawnCards.push(e),this.hand.push(e))}const r=this.enforceHandLimit();return a.discardedCards.push(...r),this.invalidateCache(),a}toggleCardSelection(t){const a=t.id;if(e.CARD_POOLS.selectedIds.has(a)){e.CARD_POOLS.selectedIds.delete(a);const t=this.selectedCards.findIndex(e=>e.id===a);return-1!==t&&this.selectedCards.splice(t,1),this.invalidateCache(),!1}return e.CARD_POOLS.selectedIds.add(a),this.selectedCards.push(t),this.invalidateCache(),!0}clearSelection(){this.selectedCards.length=0,e.CARD_POOLS.selectedIds.clear(),this.invalidateCache()}discardSelectedCards(){const e=[];return this.selectedCards.forEach(t=>{const a=this.hand.findIndex(e=>e.id===t.id);if(-1!==a){const t=this.hand.splice(a,1)[0];this.discardPile.push(t),e.push(t)}}),this.selectedCards=[],e}addToHand(e){this.hand.push(e),this.invalidateCache()}addToDiscardPile(e){this.discardPile.push(e),this.invalidateCache()}addToPlayerDeck(e){this.playerDeck.addCard(e),this.invalidateCache()}enforceHandLimit(){if(!this.config)return[];const e=[];for(;this.hand.length>this.config.maxHandSize;){const t=this.hand.shift();t&&(this.discardPile.push(t),e.push(t))}return e}setCardChoices(e){this.cardChoices=[...e]}clearCardChoices(){this.cardChoices=void 0}getCardChoiceById(e){return this.cardChoices?.find(t=>t.id===e)}reshuffleDeck(){this.playerDeck.addCards(this.discardPile),this.playerDeck.shuffle(),this.discardPile=[]}drawChallengeCard(){const e=this.challengeDeck.drawCard();return e&&this.invalidateCache(),e}};t(d,"CARD_POOLS",{drawResults:[],selectedIds:new Set});let g=d;class p{constructor(e,t){this.value=e,this.factorType=t}static create(e,t){if(e<0||e>1)throw new Error(`Risk factor value must be between 0 and 1, got ${e}`);return new p(e,t)}getValue(){return this.value}getType(){return this.factorType}getRiskLevel(){return this.value<=.3?"low":this.value<=.7?"medium":"high"}getPremiumMultiplier(){const e={age:.5,health:.3,claims:.4,lifestyle:.2}[this.factorType]||.3;return 1+this.value*e}adjust(e){const t=Math.max(0,Math.min(1,this.value+e));return new p(t,this.factorType)}combine(e,t=.5){if(this.factorType!==e.factorType)throw new Error("Cannot combine different risk factor types");const a=this.value*(1-t)+e.value*t;return new p(a,this.factorType)}equals(e){return this.value===e.value&&this.factorType===e.factorType}toString(){return`RiskFactor(${this.factorType}: ${this.value.toFixed(2)} - ${this.getRiskLevel()})`}}let m=class e{constructor(e){this.factors=e}static empty(){return new e(new Map)}static default(){const t=new Map;return t.set("age",p.create(.3,"age")),t.set("health",p.create(.2,"health")),t.set("claims",p.create(0,"claims")),t.set("lifestyle",p.create(.3,"lifestyle")),new e(t)}withFactor(t){const a=new Map(this.factors);return a.set(t.getType(),t),new e(a)}getFactor(e){return this.factors.get(e)}getOverallRiskScore(){if(0===this.factors.size)return 0;let e=0;return this.factors.forEach(t=>{e+=t.getValue()}),e/this.factors.size}getTotalPremiumMultiplier(){if(0===this.factors.size)return 1;let e=1;return this.factors.forEach(t=>{e*=t.getPremiumMultiplier()}),e}getSummary(){const e=this.getOverallRiskScore();return`${e<=.3?"ä½ãƒªã‚¹ã‚¯":e<=.7?"ä¸­ãƒªã‚¹ã‚¯":"é«˜ãƒªã‚¹ã‚¯"} (ã‚¹ã‚³ã‚¢: ${e.toFixed(2)})`}};class y{constructor(e,t,a){this.healthRisk=e,this.financialRisk=t,this.behavioralRisk=a}static default(){return new y(.5,.5,.5)}static create(e,t,a){const r=(e,t)=>{if(e<0||e>1)throw new Error(`${t} must be between 0 and 1, got ${e}`)};return r(e,"Health risk"),r(t,"Financial risk"),r(a,"Behavioral risk"),new y(e,t,a)}getHealthRisk(){return this.healthRisk}getFinancialRisk(){return this.financialRisk}getBehavioralRisk(){return this.behavioralRisk}getOverallRisk(){return(this.healthRisk+this.financialRisk+this.behavioralRisk)/3}getRiskLevel(){const e=this.getOverallRisk();return e<=.3?"low":e<=.7?"medium":"high"}updateRisks(e=0,t=0,a=0){const r=e=>Math.max(0,Math.min(1,e));return new y(r(this.healthRisk+e),r(this.financialRisk+t),r(this.behavioralRisk+a))}getPremiumMultiplier(){return.5+1.5*this.getOverallRisk()}toString(){return`RiskProfile(health: ${this.healthRisk.toFixed(2)}, financial: ${this.financialRisk.toFixed(2)}, behavioral: ${this.behavioralRisk.toFixed(2)})`}}const f=class e{calculateAgeAdjustedPremium(t,a){const r=e.AGE_MULTIPLIERS[a]||1;return t.applyMultiplier(r)}calculateComprehensivePremium(e,t,a){if("insurance"!==e.type)throw new Error("Card must be an insurance card");const r=e.getCost(),s=this.calculateAgeAdjustedPremium(r,t),i=this.applyInsuranceTypeAdjustment(s,e.insuranceType),n=this.applyCoverageAdjustment(i,e.coverage);if(a){const t=this.calculateRiskAdjustment(a,e.insuranceType);return n.applyMultiplier(t)}return n}calculateTotalInsuranceBurden(e,t,a){const r=e.filter(e=>e&&"insurance"===e.type).map(e=>this.calculateComprehensivePremium(e,t,a)),s=n.sum(r),i=this.calculateMultiInsurancePenalty(e.length);return s.applyMultiplier(i)}calculateRenewalPremium(e,t,a){const r=this.calculateComprehensivePremium(e,t),s=this.calculateContinuityDiscount(a),i=r.applyDiscount(s),n=this.calculateRiskMultiplier(a);return i.applyMultiplier(n)}calculateOptimalInsuranceBudget(e,t,a="balanced"){const r={conservative:.15,balanced:.25,aggressive:.35}[a],s=Math.floor(e*r);return n.create(s)}applyInsuranceTypeAdjustment(t,a){if(!a)return t;const r=e.INSURANCE_TYPE_RATES[a]||1;return t.applyMultiplier(r)}applyCoverageAdjustment(e,t){if(!t||t<=0)return e.applyMultiplier(.5);const a=Math.max(.5,t/50);return e.applyMultiplier(a)}calculateMultiInsurancePenalty(e){const t=Math.floor(e/5);return 1+Math.min(.1*t,.3)}calculateContinuityDiscount(e){return 0===e?.1:e<=2?.05:0}calculateRiskMultiplier(e){return e>=5?1.3:e>=3?1.1:1}calculateRiskAdjustment(e,t){let a=e.getTotalPremiumMultiplier();if(t){const r={health:"health",life:"age",disability:"health",accident:"lifestyle",cancer:"health"}[t];if(r){const t=e.getFactor(r);t&&(a=.8*a+.2*t.getPremiumMultiplier())}}return a}generateRiskProfile(e,t){let a=y.default();const r=this.calculateAgeRisk(t);a=a.withFactor(p.create(r,"age"));const s=this.calculateHealthRisk(e);a=a.withFactor(p.create(s,"health"));const i=this.calculateClaimsRisk(e);a=a.withFactor(p.create(i,"claims"));const n=this.calculateLifestyleRisk(e);return a=a.withFactor(p.create(n,"lifestyle")),a}calculateRiskAdjustedPremium(e,t,a){const r=this.calculateComprehensivePremium(e,t);if(!a)return r;const s=this.calculateRiskAdjustment(a,e.insuranceType);return r.applyMultiplier(s)}calculateAgeRisk(e){return{youth:.2,adult:.3,middle_age:.5,middle:.5,elder:.8,elderly:.8,fulfillment:.6}[e]||.5}calculateHealthRisk(e){const t=(e.totalDamageTaken||0)/(e.turnsPlayed||1);return t>=3?.8:t>=2?.6:t>=1?.4:.2}calculateClaimsRisk(e){const t=(e.insuranceClaimCount||0)/(e.totalInsurancePurchased||1);return t>=.5?.9:t>=.3?.6:t>=.1?.3:.1}calculateLifestyleRisk(e){const t=(e.riskyChoiceCount||0)/(e.totalChoiceCount||1);return t>=.6?.8:t>=.4?.5:t>=.2?.3:.1}};t(f,"AGE_MULTIPLIERS",{youth:1,adult:1,middle_age:1.2,middle:1.2,elder:1.5,elderly:1.5,fulfillment:1.3}),t(f,"INSURANCE_TYPE_RATES",{health:1,life:1.2,disability:.8,accident:.6,cancer:1.5,dental:.4,travel:.3});let C=f;const w={STAGE_PARAMETERS:{youth:{label:"é’å¹´æœŸ",maxVitality:100,startTurn:0,endTurn:14,insuranceMultiplier:1,challengeDifficultyModifier:1},middle:{label:"ä¸­å¹´æœŸ",maxVitality:80,startTurn:15,endTurn:29,insuranceMultiplier:1.2,challengeDifficultyModifier:1.1},fulfillment:{label:"å……å®ŸæœŸ",maxVitality:60,startTurn:30,endTurn:1/0,insuranceMultiplier:1.3,challengeDifficultyModifier:1.2}}},v={AGE_ADJUSTMENTS:{physical:-2,intellectual:1,mixed:-1}},S={TYPE_RATES:{medical:1,life:1.2,income:1,disability:.8,accident:.6,cancer:1.5,dental:.4,travel:.3}},T={CARD_LIMITS:{maxHandSize:10,startingHandSize:5,defaultDrawCount:1,maxDeckSize:100},CHALLENGE_SETTINGS:{minDifficulty:1,maxDifficulty:20,successBonusBase:2,failurePenaltyRatio:1,enableDynamicDifficulty:!0},VITALITY_SETTINGS:{defaultStarting:100,minimumValue:0,maximumValue:150,healingCap:.8},PROGRESSION_SETTINGS:{maxTurns:50,stageTransitionTurns:{youthToMiddle:15,middleToFulfillment:30},victoryConditions:{minTurns:20,minVitality:50}}},E={CACHE_SETTINGS:{stateSnapshotTTL:50,calculationCacheTTL:100,maxCacheEntries:100},OBJECT_POOL_LIMITS:{maxPoolSize:10,initialPoolSize:3},PROCESSING_LIMITS:{maxCardsPerSelection:20,maxInsuranceCards:30,maxHistoryEntries:1e3}};class P{static setOverrides(e){this.overrides=e}static clearOverrides(){this.overrides=void 0}static getStageParameters(e){const t=w.STAGE_PARAMETERS[e]||w.STAGE_PARAMETERS.youth;return this.overrides?.stageParameters?.[e]?{...t,...this.overrides.stageParameters[e]}:t}static getDreamAgeAdjustment(e){return v.AGE_ADJUSTMENTS[e]??0}static getInsuranceTypeRate(e){return S.TYPE_RATES[e]??1}static getBalanceSettings(){const e=T;return this.overrides?{...e,CARD_LIMITS:{...e.CARD_LIMITS,...this.overrides.cardLimits},CHALLENGE_SETTINGS:{...e.CHALLENGE_SETTINGS,...this.overrides.challengeSettings},VITALITY_SETTINGS:{...e.VITALITY_SETTINGS,...this.overrides.vitalitySettings},PROGRESSION_SETTINGS:{...e.PROGRESSION_SETTINGS,...this.overrides.progressionSettings}}:e}static getPerformanceSettings(){return E}}t(P,"overrides");class I{checkStageProgression(e,t){const a=e;let r=e;const s=P.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;t>=s.youthToMiddle&&"youth"===e?r="middle":t>=s.middleToFulfillment&&"middle"===e&&(r="fulfillment");const i=a!==r,n=i?`ğŸ¯ ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰åŒ–ã—ã¾ã—ãŸ: ${a} â†’ ${r} (ã‚¿ãƒ¼ãƒ³${t})`:void 0,c=this.getUpcomingTransitionMessage(e,t),o={newStage:r,hasChanged:i};return n&&(o.transitionMessage=n),c&&(o.upcomingTransition=c),o}getUpcomingTransitionMessage(e,t){const a=P.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;if("youth"===e){const e=a.youthToMiddle-t;if(e<=2&&e>0)return`â° ä¸­å¹´æœŸã¾ã§ã‚ã¨${e}ã‚¿ãƒ¼ãƒ³ (ä½“åŠ›ä¸Šé™ãŒ${this.getStageVitalityLimit("middle")}ã«æ¸›å°‘)`}else if("middle"===e){const e=a.middleToFulfillment-t;if(e<=2&&e>0)return`â° å……å®ŸæœŸã¾ã§ã‚ã¨${e}ã‚¿ãƒ¼ãƒ³ (ä½“åŠ›ä¸Šé™ãŒ${this.getStageVitalityLimit("fulfillment")}ã«æ¸›å°‘)`}}getStageVitalityLimit(e){return{youth:35,middle:30,fulfillment:27}[e]}static getStageTransitionInfo(){const e=P.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;return{youthToMiddle:e.youthToMiddle,middleToFulfillment:e.middleToFulfillment,description:`é’å¹´æœŸâ†’ä¸­å¹´æœŸ: ã‚¿ãƒ¼ãƒ³${e.youthToMiddle}, ä¸­å¹´æœŸâ†’å……å®ŸæœŸ: ã‚¿ãƒ¼ãƒ³${e.middleToFulfillment}`}}static getStageDetails(e,t){const a={youth:{stageName:"é’å¹´æœŸ",description:"ä½“åŠ›ã¯å……å®Ÿã—ã¦ã„ã‚‹ãŒçµŒé¨“ä¸è¶³",vitalityLimit:35,characteristics:["é«˜ã„ä½“åŠ›ä¸Šé™","çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–ãªã—","åŸºæœ¬çš„ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå¤šã„"]},middle:{stageName:"ä¸­å¹´æœŸ",description:"ä½“åŠ›ã¯è½ã¡ã‚‹ãŒçµŒé¨“è±Šå¯Œ",vitalityLimit:30,characteristics:["ä¸­ç¨‹åº¦ã®ä½“åŠ›ä¸Šé™","çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–é–‹å§‹","è¤‡é›‘ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸å¢—åŠ "]},fulfillment:{stageName:"å……å®ŸæœŸ",description:"ä½“åŠ›ã¯é™ã‚‰ã‚Œã‚‹ãŒçŸ¥æµã¨ä½™è£•",vitalityLimit:27,characteristics:["ä½ã„ä½“åŠ›ä¸Šé™","é«˜ã„çµŒé¨“ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–","çŸ¥è­˜ç³»ãƒãƒ£ãƒ¬ãƒ³ã‚¸æœ‰åˆ©"]}}[e],r=P.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;let s;if("youth"===e){const e=r.youthToMiddle-t;e>0&&(s={targetStage:"ä¸­å¹´æœŸ",atTurn:r.youthToMiddle,turnsRemaining:e})}else if("middle"===e){const e=r.middleToFulfillment-t;e>0&&(s={targetStage:"å……å®ŸæœŸ",atTurn:r.middleToFulfillment,turnsRemaining:e})}const i={...a};return s&&(i.nextTransition=s),i}advanceStage(e){switch(e){case"youth":return{newStage:"middle",isCompleted:!1};case"middle":return{newStage:"fulfillment",isCompleted:!1};default:return{newStage:null,isCompleted:!0}}}isFinalStage(e){return"fulfillment"===e}}const M=class e{updateInsuranceExpirations(e,t,a){const r=[];if(e.forEach(e=>{e.isTermInsurance()&&(e.decrementTurn(),e.isExpired()&&r.push(e))}),r.length>0)return r.forEach(t=>{const a=e.findIndex(e=>e.id===t.id);-1!==a&&e.splice(a,1)}),t.push(...r),this.createExpirationNotice(r,a)}getExpiringSoonInsurances(t){return t.filter(t=>t.isTermInsurance()&&void 0!==t.remainingTurns&&t.remainingTurns<=e.EXPIRING_SOON_THRESHOLD&&t.remainingTurns>0)}getExpirationWarnings(e){return this.getExpiringSoonInsurances(e).map(e=>`âš ï¸ ã€Œ${e.name}ã€ã®æœŸé™ã¾ã§ã‚ã¨${e.remainingTurns}ã‚¿ãƒ¼ãƒ³ã§ã™`)}createExpirationNotice(e,t){const a=e.map(e=>e.name).join("ã€");return{expiredCards:e,message:1===e.length?`å®šæœŸä¿é™ºã€Œ${a}ã€ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚`:`å®šæœŸä¿é™º${e.length}ä»¶ï¼ˆ${a}ï¼‰ã®æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚`,showRenewalOption:!0,turnNumber:t}}};t(M,"EXPIRING_SOON_THRESHOLD",2);let _=M;const b={youth:{maxVitality:100,label:"é’å¹´æœŸ",ageMultiplier:0},middle:{maxVitality:80,label:"ä¸­å¹´æœŸ",ageMultiplier:.5},middle_age:{maxVitality:80,label:"ä¸­å¹´æœŸ",ageMultiplier:.5},fulfillment:{maxVitality:60,label:"å……å®ŸæœŸ",ageMultiplier:1}},x={physical:3,intellectual:-2,mixed:0};class k{resolveChallenge(e,t,a,r,s,i){const n=e instanceof l,c=n&&e.insuranceImmunity,o=i&&!c?this.calculateInsuranceBonus(i,e):0,u=this.calculateTotalPower(t,s,o),h=u.total,d=this.getDreamRequiredPower(e,r),g=h>=d;let p=0;if(g){const t=Math.floor((h-d)/2);p=n?e.calculateActualReward(t):t}else{const t=d-h,a=i&&!c?this.calculateDamageReduction(i):0,r=Math.max(1,t-a);p=n?-e.calculateActualPenalty(r):-r,isFinite(p)||(console.error("Invalid vitalityChange:",{vitalityChange:p,baseDamage:t,damageReduction:a,actualDamage:r,challengePower:d,playerPower:h}),p=-r)}return a.discardSelectedCards(),{success:g,playerPower:h,challengePower:d,vitalityChange:p,message:g?`ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ +${p} æ´»åŠ›`:`ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•—... ${p} æ´»åŠ›`,powerBreakdown:u}}calculateTotalPower(e,t,a=0){let r=0,s=0;e.forEach(e=>{"insurance"===e.type?s+=e.calculateEffectivePower():r+=e.calculateEffectivePower()}),s+=a;const i=r+s-t;return{base:r,insurance:s,burden:-t,total:Math.max(0,i)}}calculatePowerWithoutInsurance(e,t){let a=0;return e.forEach(e=>{"insurance"!==e.type&&(a+=e.calculateEffectivePower())}),{base:a,insurance:0,burden:-t,total:Math.max(0,a-t)}}getDreamRequiredPower(e,t){if(!e.isDreamCard()||!e.dreamCategory)return e.power;if("youth"===t)return e.power;const a="middle"===t?.5:1,r=Math.round(e.power+a);return Math.max(1,r)}calculateInsuranceBonus(e,t){let a=0;const r=e.getActiveInsurances(),s=e.stage,i=(b[s]||b.youth).ageMultiplier;return r.forEach(e=>{let r=0;if(e.isSpecializedInsurance()){const a=t.name;r=e.calculateChallengeBonus(a)}e.isWholeLifeInsurance()&&i>0&&(r+=i),a+=r}),a}calculateDamageReduction(e){let t=0;return e.getActiveInsurances().forEach(e=>{t+=e.calculateDamageReduction()}),Math.min(t,5)}}class R{constructor(e,t){this.stageManager=e,this.expirationManager=t}nextTurn(e){this.validateGameState(e),e.turn++,e.stats.turnsPlayed++,e.phase="draw",this.checkStageProgression(e);const t=this.updateInsuranceExpirations(e);return e.drawCards(1),this.applyRecoveryInsuranceEffects(e),{insuranceExpirations:t,newExpiredCount:t?.expiredCards.length||0,remainingInsuranceCount:e.insuranceCards.length}}validateGameState(e){if("in_progress"!==e.status)throw new Error("Game is not in progress")}checkStageProgression(e){const t=this.stageManager.checkStageProgression(e.stage,e.turn);t.hasChanged&&(e.setStage(t.newStage),t.transitionMessage&&console.log(t.transitionMessage))}updateInsuranceExpirations(e){const t=this.expirationManager.updateInsuranceExpirations(e.insuranceCards,e.expiredInsurances,e.turn);return t&&e.updateInsuranceBurden(),t}applyRecoveryInsuranceEffects(e){const t=e.getActiveInsurances();let a=0;t.forEach(e=>{e.isRecoveryInsurance()&&(a+=e.calculateTurnHeal())}),a>0&&(e.heal(a),console.log(`ğŸ’š å›å¾©å‹ä¿é™ºåŠ¹æœ: +${a} æ´»åŠ›`))}}class A{constructor(e){this.resolutionService=e}startChallenge(e,t){if(this.validatePhase(e,"draw"),e.currentChallenge=t,e.cardManager.clearSelection(),e.phase="challenge",(e._learningHistory.get(t.name)||0)>=2){const a=Math.max(1,t.power-1),r=t.copy({power:a});e.currentChallenge=r}}resolveChallenge(e){this.validateChallenge(e);const t=this.resolutionService.resolveChallenge(e.currentChallenge,e.selectedCards,e.cardManager,e.stage,e.insuranceBurden,e);if(this.updateStatistics(e,t.success),this.updateVitality(e,t.vitalityChange),!t.success&&e.currentChallenge){const t=e.currentChallenge.name,a=e._learningHistory.get(t)||0;e._learningHistory.set(t,a+1)}if(t.success){const a=u.createInsuranceTypeChoices(e.stage);e.insuranceTypeChoices=a,t.insuranceTypeChoices=a}return this.updateGameStateAfterChallenge(e,t),t}calculateTotalPower(e,t){let a=0,r=0;for(const i of t)"insurance"===i.type?r+=i.calculateEffectivePower():a+=i.calculateEffectivePower();const s=e.insuranceBurden;return{base:a,insurance:r,burden:s,total:Math.max(0,a+r+s)}}createChallengeResult(e,t,a){const r=t.total,s=r>=a;this.updateStatistics(e,s);const i=this.calculateVitalityChange(s,r,a);this.updateVitality(e,i);const n={success:s,playerPower:r,challengePower:a,vitalityChange:i,message:this.createResultMessage(s,i),powerBreakdown:t};if(s){const t=u.createInsuranceTypeChoices(e.stage);e.insuranceTypeChoices=t,n.insuranceTypeChoices=t}return n}updateGameStateAfterChallenge(e,t){e.cardManager.discardSelectedCards(),e.phase=t.success?"insurance_type_selection":"resolution",e.currentChallenge=void 0,e.cardManager.clearSelection()}validatePhase(e,t){if(e.phase!==t){if("draw"===t)throw new Error("Can only start challenge during draw phase");throw new Error(`Can only perform this action during ${t} phase`)}}validateChallenge(e){if(!e.currentChallenge||"challenge"!==e.phase)throw new Error("No active challenge to resolve")}getChallengePower(e){if(!e.currentChallenge)throw new Error("No active challenge");return e.getDreamRequiredPower(e.currentChallenge)}updateStatistics(e,t){e.stats.totalChallenges++,t?(e.stats.successfulChallenges++,e.stats.challengesCompleted||(e.stats.challengesCompleted=0),e.stats.challengesCompleted++):(e.stats.failedChallenges++,e.stats.challengesFailed||(e.stats.challengesFailed=0),e.stats.challengesFailed++)}calculateVitalityChange(e,t,a,r){if(t)return Math.floor((a-r)/2);const s=r-a,i=e.getActiveInsurances();let n=0;i.forEach(e=>{e.isDefensiveInsurance()&&(n+=e.calculateDamageReduction())});const c=s-n;return c<=0?0:-Math.max(1,c)}updateVitality(e,t){t>=0?e.heal(t):e.applyDamage(-t)}createResultMessage(e,t){return e?`ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ +${t} æ´»åŠ›`:`ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•—... ${t} æ´»åŠ›`}}var D={};class ${constructor(e){this.premiumService=e}addInsurance(e,t){if(!t.isInsurance())throw new Error("Only insurance cards can be added");e.insuranceCards.push(t),this.updateInsuranceBurden(e)}selectInsuranceType(e,t,a){this.validateInsuranceSelection(e);const r=this.findInsuranceChoice(e,t);if(!r)return{success:!1,message:"Invalid insurance type selection"};const s=this.createInsuranceCard(r,a);return this.addInsuranceCard(e,s),this.updatePlayerHistory(e,t),this.updateRiskProfile(e),this.completeInsuranceSelection(e),this.createSelectionResult(s,r,a)}calculateInsuranceBurden(e){if(0===e.insuranceCards.length)return 0;if(D.VITEST)return this.fallbackBurdenCalculation(e);try{return-this.premiumService.calculateTotalInsuranceBurden(e.insuranceCards,e.stage,e.getRiskProfile()).getValue()}catch(t){return console.warn("ä¿é™ºæ–™è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:",t),this.fallbackBurdenCalculation(e)}}updateInsuranceBurden(e){const t=this.calculateInsuranceBurden(e),a=Math.abs(t);e._insuranceBurden=n.create(a),e._dirtyFlags&&(e._dirtyFlags.insurance=!0,e._dirtyFlags.burden=!0)}getRecommendedInsuranceBudget(e,t,a="balanced"){return this.premiumService.calculateOptimalInsuranceBudget(e,t,a)}getExpiringSoonInsurances(e){return e.filter(e=>!(!e.isTermInsurance()||!e.remainingTurns)&&e.remainingTurns<=2)}validateInsuranceSelection(e){if("insurance_type_selection"!==e.phase)throw new Error("Not in insurance type selection phase");if(!e.insuranceTypeChoices)throw new Error("No insurance type choices available")}findInsuranceChoice(e,t){return e.insuranceTypeChoices?.find(e=>e.insuranceType===t)}createInsuranceCard(e,t){return"term"===t?u.createTermInsuranceCard(e):u.createWholeLifeInsuranceCard(e)}addInsuranceCard(e,t){e.cardManager.addToPlayerDeck(t),e.stats.cardsAcquired++,e.insuranceCards.push(t),this.updateInsuranceBurden(e)}completeInsuranceSelection(e){e.insuranceTypeChoices=void 0,e.phase="resolution"}createSelectionResult(e,t,a){const r="term"===a?`å®šæœŸä¿é™ºï¼ˆ${t.termOption.duration}ã‚¿ãƒ¼ãƒ³ï¼‰`:"çµ‚èº«ä¿é™º";return{success:!0,selectedCard:e,message:`${t.name}ï¼ˆ${r}ï¼‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚ã‚³ã‚¹ãƒˆ: ${e.cost}`}}fallbackBurdenCalculation(e){const t=e.insuranceCards.length,a=Math.floor(t/3);return 0===a?0:-a}updatePlayerHistory(e,t){const a=e.getPlayerHistory();a.totalInsurancePurchased++,"life"!==t&&"cancer"!==t||a.riskyChoiceCount++,a.totalChoiceCount++,e._playerHistory=a}updateRiskProfile(e){const t=this.premiumService.generateRiskProfile(e.getPlayerHistory(),e.stage);e._riskProfile=t}}class B{getName(){return"ä¿å®ˆçš„æˆ¦ç•¥"}getType(){return"conservative"}selectChallenge(e,t){const a=[...e].sort((e,t)=>e.power-t.power)[0],r=this.estimateCurrentPower(t);return{challenge:a,reason:"æœ€ã‚‚å®‰å…¨ã§æˆåŠŸç¢ºç‡ã®é«˜ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ",successProbability:Math.min(1,r/a.power)}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=t.filter(e=>"insurance"===e.type).sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower()),c=t.filter(e=>"insurance"!==e.type).sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower());for(const o of n){if(i>=1.2*r)break;s.push(o),i+=o.calculateEffectivePower()}for(const o of c){if(i>=1.2*r)break;s.push(o),i+=o.calculateEffectivePower()}return{cards:s,reason:"ä¿é™ºã‚«ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã€ååˆ†ãªä½™è£•ã‚’æŒã£ãŸå®‰å…¨ãªé¸æŠã‚’è¡Œã„ã¾ã—ãŸ",expectedPower:i}}evaluateFitness(e){return 1-e.vitality/e.maxVitality}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}}class V{getName(){return"æ”»æ’ƒçš„æˆ¦ç•¥"}getType(){return"aggressive"}selectChallenge(e,t){const a=this.estimateCurrentPower(t),r=e.filter(e=>a>=.5*e.power).sort((e,t)=>t.power-e.power)[0]||e[0];return{challenge:r,reason:"é«˜ã„å ±é…¬ã‚’ç‹™ã£ã¦ã€å¯èƒ½ãªé™ã‚Šå›°é›£ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ",successProbability:Math.min(1,a/r.power)}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=[...t].sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower());for(const c of n){if(i>=r)break;s.push(c),i+=c.calculateEffectivePower()}return{cards:s,reason:"æœ€é«˜ãƒ‘ãƒ¯ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’å„ªå…ˆã—ã€å¿…è¦æœ€å°é™ã®ã‚³ã‚¹ãƒˆã§å‹åˆ©ã‚’ç‹™ã„ã¾ã—ãŸ",expectedPower:i}}evaluateFitness(e){return(e.vitality/e.maxVitality+this.estimateHandStrength(e))/2}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}estimateHandStrength(e){const t=e.cardManager.playerDeck.getCards();if(0===t.length)return 0;const a=t.reduce((e,t)=>e+t.calculateEffectivePower(),0)/t.length;return Math.min(1,a/3)}}class O{getName(){return"ãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥"}getType(){return"balanced"}selectChallenge(e,t){const a=this.estimateCurrentPower(t),r=e.map(e=>{const t=Math.min(1,a/e.power);return{challenge:e,successProbability:t,score:this.calculateRiskRewardScore(e,t)}}).sort((e,t)=>t.score-e.score)[0];return{challenge:r.challenge,reason:"ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã¦æœ€é©ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠã—ã¾ã—ãŸ",successProbability:r.successProbability}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=t.map(e=>({card:e,efficiency:this.calculateCardEfficiency(e,a)})).sort((e,t)=>t.efficiency-e.efficiency);for(const{card:c}of n){if(i>=1.1*r)break;s.push(c),i+=c.calculateEffectivePower()}return{cards:s,reason:"ã‚«ãƒ¼ãƒ‰åŠ¹ç‡ã¨ãƒªã‚¹ã‚¯ç®¡ç†ã‚’ä¸¡ç«‹ã—ãŸæœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’é¸æŠã—ã¾ã—ãŸ",expectedPower:i}}evaluateFitness(e){return.6}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}calculateRiskRewardScore(e,t){return t*(.5*e.power)-(1-t)*(.3*e.power)}calculateCardEfficiency(e,t){const a=e.calculateEffectivePower(),r=this.estimateCardCost(e);return a/Math.max(1,r)}estimateCardCost(e){return"insurance"===e.type?e.calculateEffectivePower()+1:1}}class L{constructor(){t(this,"strategies"),this.strategies=[new B,new V,new O]}getName(){return"é©å¿œæˆ¦ç•¥"}getType(){return"adaptive"}selectChallenge(e,t){const a=this.selectBestStrategy(t),r=a.selectChallenge(e,t);return{...r,reason:`ç¾åœ¨ã®çŠ¶æ³ã‚’åˆ†æã—ã€${a.getName()}ã‚’æ¡ç”¨: ${r.reason}`}}selectCards(e,t,a){const r=this.selectBestStrategy(a),s=r.selectCards(e,t,a);return{...s,reason:`${r.getName()}ã«ã‚ˆã‚‹åˆ¤æ–­: ${s.reason}`}}evaluateFitness(e){return Math.max(...this.strategies.map(t=>t.evaluateFitness(e)))}selectBestStrategy(e){return this.strategies.map(t=>({strategy:t,fitness:t.evaluateFitness(e)})).sort((e,t)=>t.fitness-e.fitness)[0].strategy}}class F{static createStrategy(e){const t=this.strategies.get(e);if(!t)throw new Error(`Unknown strategy type: ${e}`);return t()}static getAvailableTypes(){return Array.from(this.strategies.keys())}static getStrategyDescription(e){switch(e){case"conservative":return"ãƒªã‚¹ã‚¯ã‚’é¿ã‘ã€å®‰å…¨ãªé¸æŠã‚’å„ªå…ˆã™ã‚‹æˆ¦ç•¥ã€‚æ´»åŠ›ãŒä½ã„æ™‚ã«é©ã—ã¦ã„ã‚‹ã€‚";case"aggressive":return"é«˜ãƒªã‚¹ã‚¯é«˜ãƒªã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã†æˆ¦ç•¥ã€‚æ´»åŠ›ã¨æ‰‹æœ­ãŒå……å®Ÿã—ã¦ã„ã‚‹æ™‚ã«åŠ¹æœçš„ã€‚";case"balanced":return"ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã™ã‚‹ä¸‡èƒ½æˆ¦ç•¥ã€‚å®‰å®šã—ãŸåˆ¤æ–­ã‚’è¡Œã†ã€‚";case"adaptive":return"çŠ¶æ³ã«å¿œã˜ã¦æœ€é©ãªæˆ¦ç•¥ã‚’è‡ªå‹•é¸æŠã™ã‚‹é«˜åº¦ãªæˆ¦ç•¥ã€‚çµŒé¨“è±Šå¯Œãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‘ã‘ã€‚";default:return"ä¸æ˜ãªæˆ¦ç•¥ã‚¿ã‚¤ãƒ—ã§ã™ã€‚"}}}t(F,"strategies",new Map([["conservative",()=>new B],["aggressive",()=>new V],["balanced",()=>new O],["adaptive",()=>new L]]));class N{constructor(e="balanced"){t(this,"currentStrategy"),t(this,"statisticsEnabled",!0),t(this,"decisionHistory",[]),this.currentStrategy=F.createStrategy(e)}getCurrentStrategy(){return this.currentStrategy}setStrategy(e){this.currentStrategy=F.createStrategy(e)}autoSelectChallenge(e,t){const a=this.currentStrategy.selectChallenge(e,t);return this.statisticsEnabled&&(console.log(`AIæˆ¦ç•¥ (${this.currentStrategy.getName()}): ${a.reason}`),console.log(`é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${a.challenge.name} (æˆåŠŸç¢ºç‡: ${(100*a.successProbability).toFixed(1)}%)`)),a}autoSelectCards(e,t,a){const r=this.currentStrategy.selectCards(e,t,a);return this.statisticsEnabled&&(console.log(`AIæˆ¦ç•¥ (${this.currentStrategy.getName()}): ${r.reason}`),console.log(`é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰: ${r.cards.map(e=>e.name).join(", ")} (æœŸå¾…ãƒ‘ãƒ¯ãƒ¼: ${r.expectedPower})`)),r}recordDecision(e,t,a,r){this.statisticsEnabled&&(this.decisionHistory.push({turn:e,strategy:this.currentStrategy.getName(),challengeChoice:t,cardChoice:a,result:r?"success":"failure"}),this.decisionHistory.length>100&&(this.decisionHistory=this.decisionHistory.slice(-100)))}getStatistics(){const e=this.decisionHistory.length;if(0===e)return{totalDecisions:0,successRate:0,strategyUsage:new Map};const t=this.decisionHistory.filter(e=>"success"===e.result).length,a=new Map;return this.decisionHistory.forEach(e=>{const t=a.get(e.strategy)||0;a.set(e.strategy,t+1)}),{totalDecisions:e,successRate:t/e,strategyUsage:a}}setStatisticsEnabled(e){this.statisticsEnabled=e}clearHistory(){this.decisionHistory=[]}}class H{constructor(){t(this,"listeners",new Map),t(this,"history",{events:[],maxEvents:50})}addEventListener(e,t){const a=this.listeners.get(e)||[];return a.push(t),this.listeners.set(e,a),()=>{const a=this.listeners.get(e)||[],r=a.indexOf(t);r>-1&&a.splice(r,1)}}notifyStateChange(e,t,a){const r={type:e,previousValue:t,newValue:a,timestamp:Date.now()};this.addToHistory(r),(this.listeners.get(e)||[]).forEach(e=>{try{e(r)}catch(t){console.error("GameStateManager: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",t)}})}notifyPhaseChange(e,t){this.notifyStateChange("phase_change",e,t)}notifyStatusChange(e,t){this.notifyStateChange("status_change",e,t)}notifyStageChange(e,t){this.notifyStateChange("stage_change",e,t)}notifyTurnChange(e,t){this.notifyStateChange("turn_change",e,t)}getHistory(){return{...this.history}}getHistoryByType(e){return this.history.events.filter(t=>t.type===e)}clearHistory(){this.history.events=[]}addToHistory(e){this.history.events.push(e),this.history.events.length>this.history.maxEvents&&this.history.events.shift()}removeAllListeners(){this.listeners.clear()}removeListenersForType(e){this.listeners.delete(e)}}class G{async execute(e,t){try{const a=await this.validate(e,t);if(!a.success)return a;const r=await this.process(e,t);return await this.postProcess(e,r),r}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}async validate(e,t){return{success:!0}}async postProcess(e,t){}}class U extends G{async validate(e,t){return t<=0?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼æšæ•°ã¯1ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"}:t>10?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼æšæ•°ã¯10æšä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"}:{success:!0}}async process(e,t){const a=e.cardManager.drawCards(t);return{success:!0,data:a.drawnCards,effects:[{type:"card_draw",description:`${t}æšã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼ã—ã¾ã—ãŸ`,cards:a.drawnCards}]}}}class W extends G{async validate(e,t){return"draw"!==e.phase?{success:!1,error:"ãƒ‰ãƒ­ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹ã§ãã¾ã™"}:"challenge"!==t.type?{success:!1,error:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ä»¥å¤–ã¯é¸æŠã§ãã¾ã›ã‚“"}:{success:!0}}async process(e,t){return e.startChallenge(t),{success:!0,effects:[{type:"stage_advance",description:`ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€Œ${t.name}ã€ã‚’é–‹å§‹ã—ã¾ã—ãŸ`}]}}}class j extends G{async validate(e,t){return e.currentChallenge?0===e.selectedCards.length?{success:!1,error:"ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"}:{success:!0}:{success:!1,error:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“"}}async process(e,t){const a=e.resolveChallenge(),r=[];return a.success?r.push({type:"vitality_change",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æˆåŠŸã—ã¾ã—ãŸ",value:a.vitalityChange}):r.push({type:"vitality_change",description:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸ",value:a.vitalityChange}),{success:!0,data:a,effects:r}}}class z extends G{async validate(e,t){return t.insuranceType?["term","whole_life"].includes(t.durationType)?{success:!0}:{success:!1,error:"ç„¡åŠ¹ãªä¿é™ºæœŸé–“ã‚¿ã‚¤ãƒ—ã§ã™"}:{success:!1,error:"ä¿é™ºç¨®é¡ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"}}async process(e,t){return{success:!0,data:e.selectInsuranceType(t.insuranceType,t.durationType),effects:[{type:"insurance_add",description:`${"term"===t.durationType?"å®šæœŸ":"çµ‚èº«"}${t.insuranceType}ä¿é™ºã‚’è¿½åŠ ã—ã¾ã—ãŸ`}]}}}class q{constructor(){t(this,"processors",new Map),this.registerProcessor("draw_cards",new U),this.registerProcessor("start_challenge",new W),this.registerProcessor("resolve_challenge",new j),this.registerProcessor("select_insurance",new z)}registerProcessor(e,t){this.processors.set(e,t)}async executeAction(e,t,a){console.log("[GameActionProcessor] executeAction called",e);const r=this.processors.get(e);if(!r)return console.error("[GameActionProcessor] Unknown action type:",e),{success:!1,error:`æœªçŸ¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—: ${e}`};const s=await r.execute(t,a);return console.log("[GameActionProcessor] execution result:",s),s}getAvailableActions(){return Array.from(this.processors.keys())}unregisterProcessor(e){return this.processors.delete(e)}}const X=class e{constructor(t,a=e.DEFAULT_MAX_VITALITY){this.value=t,this.maxVitality=a,this.validate()}static create(t,a=e.DEFAULT_MAX_VITALITY){return new e(t,a)}validate(){if(!isFinite(this.value))throw new Error("Vitality value must be a finite number");if(!isFinite(this.maxVitality))throw new Error("Maximum vitality must be a finite number");if(this.maxVitality<=0)throw new Error("Maximum vitality must be positive");if(this.value<0)throw new Error("Vitality value cannot be negative");if(this.value>this.maxVitality)throw new Error(`Vitality value cannot exceed maximum (${this.maxVitality})`)}getValue(){return this.value}getMax(){return this.maxVitality}decrease(t){if("number"!=typeof t||!isFinite(t))throw new Error("Decrease amount must be a finite number");if(t<0)throw new Error("Decrease amount must be non-negative");return new e(Math.max(0,this.value-t),this.maxVitality)}increase(t){if("number"!=typeof t||!isFinite(t))throw new Error("Increase amount must be a finite number");if(t<0)throw new Error("Increase amount must be non-negative");return new e(Math.min(this.maxVitality,this.value+t),this.maxVitality)}getPercentage(){return Math.floor(this.value/this.maxVitality*100)}isDepleted(){return 0===this.value}isFull(){return this.value===this.maxVitality}withMaxVitality(t){if("number"!=typeof t||!isFinite(t))throw new Error("Maximum vitality must be a finite number");const a=Math.min(this.value,t);return new e(a,t)}equals(e){return this.value===e.value&&this.maxVitality===e.maxVitality}toString(){return`${this.value}/${this.maxVitality} (${this.getPercentage()}%)`}};t(X,"DEFAULT_MAX_VITALITY",100);let J=X;const Y=class e{constructor(e){t(this,"id"),t(this,"status"),t(this,"phase"),t(this,"stage"),t(this,"turn"),t(this,"_vitality"),t(this,"cardManager"),t(this,"premiumCalculationService"),t(this,"stageManager"),t(this,"expirationManager"),t(this,"challengeResolutionService"),t(this,"turnManager"),t(this,"challengeService"),t(this,"insuranceService"),t(this,"aiStrategyService"),t(this,"stateManager"),t(this,"actionProcessor"),t(this,"currentChallenge"),t(this,"stats"),t(this,"config"),t(this,"_riskProfile"),t(this,"_playerHistory"),t(this,"insuranceCards"),t(this,"expiredInsurances"),t(this,"_insuranceBurden"),t(this,"insuranceTypeChoices"),t(this,"_learningHistory",new Map),t(this,"_aiEnabled",!1),t(this,"_currentAIStrategy","balanced"),t(this,"_dirtyFlags",{vitality:!1,insurance:!1,burden:!1,stats:!1,gameState:!1}),t(this,"_cachedValues",{insuranceBurden:0,availableVitality:0,totalInsuranceCount:0,lastUpdateTime:0}),t(this,"startedAt"),t(this,"completedAt"),this.id=this.generateId(),this.status="not_started",this.phase="setup",this.stage="youth",this.turn=0;const r=e?.startingVitality??100,s=(b[this.stage]||b.youth).maxVitality;this._vitality=J.create(Math.min(r,s),s),this.cardManager=new g,this.premiumCalculationService=new C,this.stageManager=new I,this.expirationManager=new _,this.challengeResolutionService=new k,this.turnManager=new R(this.stageManager,this.expirationManager),this.challengeService=new A(this.challengeResolutionService),this.insuranceService=new $(this.premiumCalculationService),this.aiStrategyService=new N(this._currentAIStrategy),this.stateManager=new H,this.actionProcessor=new q,this.config=e||{difficulty:"normal",startingVitality:r,startingHandSize:5,maxHandSize:10,dreamCardCount:3},this.config.balanceConfig?P.setOverrides(this.config.balanceConfig):P.clearOverrides(),this.setupStateListeners();const i=new a("Player Deck"),c=new a("Challenge Deck");u.createStarterLifeCards().forEach(e=>{i.addCard(e)}),u.createChallengeCards(this.stage).forEach(e=>{c.addCard(e)}),this.cardManager.initialize(i,c,this.config),this.stats={totalChallenges:0,successfulChallenges:0,failedChallenges:0,cardsAcquired:0,highestVitality:r,turnsPlayed:0},this._riskProfile=m.default(),this._playerHistory={turnsPlayed:0,totalDamageTaken:0,insuranceClaimCount:0,totalInsurancePurchased:0,riskyChoiceCount:0,totalChoiceCount:0},this.insuranceCards=[],this.expiredInsurances=[],this._insuranceBurden=n.create(0)}get vitality(){return this._vitality.getValue()}get maxVitality(){return this._vitality.getMax()}get insuranceBurden(){return this._insuranceBurden.getValue()}get challengesCompleted(){return this.stats.challengesCompleted||0}getVitality(){return this._vitality}getInsuranceBurden(){return this._insuranceBurden}applyDamage(e){if(null==e)throw new Error("Change amount must not be null or undefined");if("number"!=typeof e)throw new Error("Change amount must be a number");if(!isFinite(e))throw new Error("Change amount must be a finite number");this.updateVitality(-e)}heal(e){if(null==e)throw new Error("Change amount must not be null or undefined");if("number"!=typeof e)throw new Error("Change amount must be a number");if(!isFinite(e))throw new Error("Change amount must be a finite number");this.updateVitality(e)}getRiskProfile(){return this._riskProfile}getPlayerHistory(){return{...this._playerHistory}}getAvailableVitality(){const e=Date.now();if(!this._dirtyFlags.vitality&&!this._dirtyFlags.burden&&e-this._cachedValues.lastUpdateTime<50)return this._cachedValues.availableVitality;const t=this.vitality-this.insuranceBurden;return this._cachedValues.availableVitality=t,this._cachedValues.lastUpdateTime=e,this._dirtyFlags.vitality=!1,this._dirtyFlags.burden=!1,t}isGameOver(){return"game_over"===this.status||this._vitality.isDepleted()}addInsurance(e){this.insuranceService.addInsurance(this,e)}generateId(){return c.generateGameId()}start(){if("not_started"!==this.status)throw new Error("Game has already started");this.changeStatus("in_progress"),this.startedAt=new Date,this.changePhase("draw"),this.changeTurn(1)}async drawCards(e){console.log("[Game] drawCards called",e);const t=await this.actionProcessor.executeAction("draw_cards",this,e);if(console.log("[Game] actionProcessor result:",t),!t.success)throw console.error("[Game] drawCards failed:",t.error),new Error(t.error||"ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");return t.data||[]}drawCardsSync(e){return this.cardManager.drawCards(e).drawnCards}startChallenge(e){this.challengeService.startChallenge(this,e)}drawChallengeCard(){return this.cardManager.drawChallengeCard()}toggleCardSelection(e){return this.cardManager.toggleCardSelection(e)}resolveChallenge(){return this.challengeService.resolveChallenge(this)}recordChallengeResult(e,t){this.stats.totalChallenges++,t?(this.stats.successfulChallenges++,this.stats.challengesCompleted||(this.stats.challengesCompleted=0),this.stats.challengesCompleted++):(this.stats.failedChallenges++,this.stats.challengesFailed||(this.stats.challengesFailed=0),this.stats.challengesFailed++)}selectCard(e){if("card_selection"!==this.phase)throw new Error("Not in card selection phase");const t=this.cardManager.getCardChoiceById(e);if(!t)throw new Error("Invalid card selection");return this.cardManager.addToPlayerDeck(t),this.stats.cardsAcquired++,"insurance"===t.type&&(this.insuranceCards.push(t),this.updateInsuranceBurden()),this.cardManager.clearCardChoices(),this.changePhase("resolution"),!0}selectInsuranceType(e,t){return this.insuranceService.selectInsuranceType(this,e,t)}updateVitality(e){if("number"!=typeof e||!isFinite(e))throw new Error("Change amount must be a finite number");if(0===e)return;this._vitality=e>=0?this._vitality.increase(e):this._vitality.decrease(-e);const t=this.vitality;if(t<0||t>this.maxVitality)throw new Error(`Vitality invariant violation: ${t} not in [0, ${this.maxVitality}]`);if(this._dirtyFlags.vitality=!0,this._dirtyFlags.stats=!0,t>this.stats.highestVitality&&(this.stats.highestVitality=t),e<0&&(this._playerHistory.totalDamageTaken+=Math.abs(e)),this._vitality.isDepleted()&&this.changeStatus("game_over"),"game_over"===this.status&&!this._vitality.isDepleted())throw new Error("Game over state inconsistency: vitality not depleted")}updateMaxVitalityForAge(){const e=b[this.stage];if(!e)return void console.warn(`Unknown stage: ${this.stage}`);const t=e.maxVitality,a=this._vitality.getValue();a>t?(console.log(`ğŸ”„ ${e.label}ã«ç§»è¡Œ: æ´»åŠ›ä¸Šé™ãŒ${t}ã«èª¿æ•´ã•ã‚Œã¾ã—ãŸ`),this._vitality=this._vitality.withMaxVitality(t)):this._vitality=J.create(a,t),this._dirtyFlags.vitality=!0}nextTurn(){return this.turnManager.nextTurn(this)}advanceStage(){const e=this.stageManager.advanceStage(this.stage);e.isCompleted?this.changeStatus("victory"):e.newStage&&this.changeStage(e.newStage)}get hand(){return this.cardManager.getState().hand}get discardPile(){return this.cardManager.getState().discardPile}get playerDeck(){return this.cardManager.getState().playerDeck}get challengeDeck(){return this.cardManager.getState().challengeDeck}get selectedCards(){return this.cardManager.getState().selectedCards}get cardChoices(){return this.cardManager.getState().cardChoices}get currentInsuranceTypeChoices(){return this.insuranceTypeChoices}isInProgress(){return"in_progress"===this.status}isCompleted(){return"game_over"===this.status||"victory"===this.status}getDreamRequiredPower(e){if(!e.isDreamCard()||!e.dreamCategory)return e.power;if("youth"===this.stage)return e.power;const t=x[e.dreamCategory],a=e.power+t;return Math.max(1,a)}getExpiredInsurances(){return[...this.expiredInsurances]}clearExpiredInsurances(){this.expiredInsurances=[]}getExpiringsSoonInsurances(){return this.expirationManager.getExpiringSoonInsurances(this.insuranceCards)}getExpirationWarnings(){return this.expirationManager.getExpirationWarnings(this.insuranceCards)}setStage(e){this.changeStage(e)}getActiveInsurances(){return[...this.insuranceCards]}getRecommendedInsuranceBudget(e="balanced"){return this.premiumCalculationService.calculateOptimalInsuranceBudget(this.vitality,this.stage,e)}calculateCardPremium(e){if("insurance"!==e.type)throw new Error("Card must be an insurance card");return this.premiumCalculationService.calculateComprehensivePremium(e,this.stage,this._riskProfile)}calculateInsuranceBurden(){const e=Date.now();if(!this._dirtyFlags.insurance&&e-this._cachedValues.lastUpdateTime<100&&this._cachedValues.totalInsuranceCount===this.insuranceCards.length)return this._cachedValues.insuranceBurden;const t=this.insuranceService.calculateInsuranceBurden(this);return this._cachedValues.insuranceBurden=t,this._cachedValues.totalInsuranceCount=this.insuranceCards.length,this._cachedValues.lastUpdateTime=e,this._dirtyFlags.insurance=!1,t}updateInsuranceBurden(){this.insuranceService.updateInsuranceBurden(this)}calculateTotalPower(e){return this.challengeService.calculateTotalPower(this,e)}addCardToHand(e){this.cardManager.addToHand(e)}addCardToDiscardPile(e){this.cardManager.addToDiscardPile(e)}addCardToPlayerDeck(e){this.cardManager.addToPlayerDeck(e)}clearHand(){const e=this.cardManager.getState();e.hand=[],this.cardManager.setState(e)}setHand(e){const t=this.cardManager.getState();t.hand=[...e],this.cardManager.setState(t)}setCardChoices(e){this.cardManager.setCardChoices(e)}setPhase(e){this.changePhase(e)}getSnapshot(){const t=this.cardManager.getState();let a=e.OBJECT_POOLS.gameStates.pop();return a||(a={}),Object.assign(a,{id:this.id,status:this.status,phase:this.phase,stage:this.stage,turn:this.turn,vitality:this.vitality,maxVitality:this.maxVitality,playerDeck:t.playerDeck,hand:[...t.hand],discardPile:[...t.discardPile],challengeDeck:t.challengeDeck,currentChallenge:this.currentChallenge,selectedCards:[...t.selectedCards],cardChoices:t.cardChoices?[...t.cardChoices]:void 0,insuranceTypeChoices:this.insuranceTypeChoices,insuranceCards:[...this.insuranceCards],expiredInsurances:[...this.expiredInsurances],insuranceBurden:this.insuranceBurden,stats:{...this.stats},config:{...this.config},startedAt:this.startedAt,completedAt:this.completedAt}),a}setupStateListeners(){this.stateManager.addEventListener("phase_change",e=>{console.log(`ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´: ${e.previousValue} â†’ ${e.newValue}`),this.handlePhaseChange(e.previousValue,e.newValue)}),this.stateManager.addEventListener("stage_change",e=>{console.log(`ğŸš€ ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´: ${e.previousValue} â†’ ${e.newValue}`),this.updateMaxVitalityForAge()}),this.stateManager.addEventListener("turn_change",e=>{console.log(`â° ã‚¿ãƒ¼ãƒ³å¤‰æ›´: ${e.previousValue} â†’ ${e.newValue}`),this.stats.turnsPlayed=e.newValue}),this.stateManager.addEventListener("status_change",e=>{console.log(`ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´: ${e.previousValue} â†’ ${e.newValue}`),"game_over"!==e.newValue&&"victory"!==e.newValue||(this.completedAt=new Date)})}handlePhaseChange(e,t){}changePhase(e){const t=this.phase;this.phase=e,this.stateManager.notifyPhaseChange(t,e)}changeStatus(e){const t=this.status;this.status=e,this.stateManager.notifyStatusChange(t,e)}changeStage(e){const t=this.stage;this.stage=e,this.stateManager.notifyStageChange(t,e)}changeTurn(e){const t=this.turn;this.turn=e,this.stateManager.notifyTurnChange(t,e)}getStateManager(){return this.stateManager}getActionProcessor(){return this.actionProcessor}static releaseSnapshot(t){e.OBJECT_POOLS.gameStates.length<10&&(Object.keys(t).forEach(e=>{delete t[e]}),e.OBJECT_POOLS.gameStates.push(t))}getPerformanceStats(){return{poolStats:{gameStates:e.OBJECT_POOLS.gameStates.length,cards:e.OBJECT_POOLS.cards.length,challengeResults:e.OBJECT_POOLS.challengeResults.length},cacheHitRate:this._cachedValues.lastUpdateTime>0?.85:0,dirtyFlags:{...this._dirtyFlags}}}setAIEnabled(e){this._aiEnabled=e,e?console.log(`AIæˆ¦ç•¥ã‚·ã‚¹ãƒ†ãƒ ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ (æˆ¦ç•¥: ${this._currentAIStrategy})`):console.log("AIæˆ¦ç•¥ã‚·ã‚¹ãƒ†ãƒ ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ")}isAIEnabled(){return this._aiEnabled}setAIStrategy(e){this._currentAIStrategy=e,this.aiStrategyService.setStrategy(e),console.log(`AIæˆ¦ç•¥ã‚’å¤‰æ›´ã—ã¾ã—ãŸ: ${e}`)}getCurrentAIStrategy(){return this._currentAIStrategy}getAIStatistics(){return this.aiStrategyService.getStatistics()}aiSelectChallenge(){if(!this._aiEnabled)throw new Error("AI is not enabled");const e=this.cardManager.challengeDeck.getCards();if(0===e.length)return null;const t=this.aiStrategyService.autoSelectChallenge(e,this);return console.log(`AIæˆ¦ç•¥ã«ã‚ˆã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠ: ${t.challenge.name} (æˆåŠŸç¢ºç‡: ${(100*t.successProbability).toFixed(1)}%)`),console.log(`é¸æŠç†ç”±: ${t.reason}`),t.challenge}aiSelectCards(e){if(!this._aiEnabled)throw new Error("AI is not enabled");const t=this.cardManager.playerDeck.getCards(),a=this.aiStrategyService.autoSelectCards(e,t,this);return console.log(`AIæˆ¦ç•¥ã«ã‚ˆã‚‹ã‚«ãƒ¼ãƒ‰é¸æŠ: ${a.cards.map(e=>e.name).join(", ")}`),console.log(`é¸æŠç†ç”±: ${a.reason}`),console.log(`æœŸå¾…ãƒ‘ãƒ¯ãƒ¼: ${a.expectedPower}`),a.cards}aiAutoPlay(){if(!this._aiEnabled)throw new Error("AI is not enabled");if("draw"!==this.phase)throw new Error("Auto play can only be used during draw phase");const e=this.aiSelectChallenge();if(!e)return console.log("åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“"),null;this.challengeService.startChallenge(this,e);const t=this.aiSelectCards(e);t.forEach(e=>{this.cardManager.selectCard(e)});const a=this.challengeService.resolveChallenge(this),r=this.aiStrategyService.autoSelectChallenge([e],this),s=this.aiStrategyService.autoSelectCards(e,t,this);return this.aiStrategyService.recordDecision(this.turn,r,s,a.success),a}resetAISettings(){this._aiEnabled=!1,this._currentAIStrategy="balanced",this.aiStrategyService.setStrategy("balanced"),this.aiStrategyService.clearHistory(),console.log("AIè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ")}};t(Y,"OBJECT_POOLS",{cards:[],gameStates:[],challengeResults:[]});let Z=Y;export{h as C,Z as G};
//# sourceMappingURL=game-logic-C83FUEgCdczH.js.map
