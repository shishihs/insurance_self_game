var e=Object.defineProperty,t=(t,a,r)=>((t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r)(t,"symbol"!=typeof a?a+"":a,r);class a{constructor(e,a=[]){t(this,"cards"),t(this,"name"),this.name=e,this.cards=[...a]}getName(){return this.name}size(){return this.cards.length}isEmpty(){return 0===this.cards.length}addCard(e){"Player Deck"===this.name&&("dream"===e.type||e.power>=25)&&console.warn(`[Deck: ${this.name}] üö® SUSPICIOUS ADDITION DETECTED üö®: ${e.name} (Type: ${e.type}, Power: ${e.power})`),this.cards.push(e)}addCards(e){if("Player Deck"===this.name){const t=e.filter(e=>"dream"===e.type||e.power>=25);t.length>0&&console.warn(`[Deck: ${this.name}] üö® SUSPICIOUS BATCH ADDITION üö®:`,t.map(e=>`${e.name} (${e.type})`))}this.cards.push(...e)}drawCard(){return this.cards.pop()||null}drawCards(e){const t=[];for(let a=0;a<e&&!this.isEmpty();a++){const e=this.drawCard();e&&t.push(e)}return t}removeCard(e){const t=this.cards.findIndex(t=>t.id===e);return-1!==t&&(this.cards.splice(t,1),!0)}shuffle(){for(let e=this.cards.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}getCards(){return[...this.cards]}countCardsByType(e){return this.cards.filter(t=>t.type===e).length}clear(){this.cards=[]}clone(){return new a(this.name,this.cards.map(e=>e.clone()))}getStats(){const e={total:this.cards.length,byType:{life:0,insurance:0,pitfall:0},averagePower:0,averageCost:0};let t=0,a=0;return this.cards.forEach(r=>{e.byType[r.type]++,t+=r.power,a+=r.cost}),e.averagePower=e.total>0?t/e.total:0,e.averageCost=e.total>0?a/e.total:0,e}}const r=class e{constructor(e){this.value=e,this.validate()}static create(t){return new e(t)}validate(){if(this.value<e.MIN_POWER)throw new Error(`CardPower must be at least ${e.MIN_POWER}`);if(this.value>e.MAX_POWER)throw new Error("Card power cannot exceed maximum")}getValue(){return this.value}add(t){const a=this.value+t.value;return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}static sum(t){const a=t.reduce((e,t)=>e+t.value,0);return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}multiply(t){if(t<0)throw new Error("Multiplier cannot be negative");const a=Math.floor(this.value*t);return new e(Math.max(e.MIN_POWER,Math.min(a,e.MAX_POWER)))}isGreaterThan(e){return this.value>e.value}isGreaterThanOrEqual(e){return this.value>=e.value}equals(e){return this.value===e.value}toString(){return`Power: ${this.value}`}static get ZERO(){return new e(0)}static get MAX(){return new e(e.MAX_POWER)}};t(r,"MIN_POWER",-99),t(r,"MAX_POWER",999);let s=r;const i=class e{constructor(e){this.value=e,this.validate()}static create(t){return new e(Math.floor(t))}validate(){if(this.value<e.MIN_PREMIUM)throw new Error("InsurancePremium must be non-negative");if(this.value>e.MAX_PREMIUM)throw new Error("InsurancePremium cannot exceed maximum")}getValue(){return this.value}static sum(t){const a=t.reduce((e,t)=>e+t.value,0);return new e(Math.min(a,e.MAX_PREMIUM))}applyDiscount(t){if(t<0)throw new Error("Discount rate cannot be negative");if(t>1)throw new Error("Discount rate cannot exceed 100%");const a=Math.floor(this.value*(1-t));return new e(a)}applyMultiplier(t){if(t<0)throw new Error("Multiplier cannot be negative");const a=Math.floor(this.value*t);return new e(Math.min(a,e.MAX_PREMIUM))}isFree(){return 0===this.value}isExpensive(){return this.value>=e.EXPENSIVE_THRESHOLD}isHigherThan(e){return this.value>e.value}isAffordableWith(e){return e>=this.value}equals(e){return this.value===e.value}toString(){return this.isFree()?"‰øùÈô∫Êñô: ÁÑ°Êñô":`‰øùÈô∫Êñô: ${this.value}`}static get FREE(){return new e(0)}};t(i,"MIN_PREMIUM",0),t(i,"MAX_PREMIUM",99),t(i,"EXPENSIVE_THRESHOLD",20);let n=i;class c{static generate(e="id"){return`${e}_${Date.now()}_${this.getRandomString()}`}static generateCardId(){return this.generate("card")}static generateGameId(){return this.generate("game")}static generateCommandId(){return this.generate("cmd")}static generateNotificationId(){return this.generate("notification")}static generateFeedbackId(){return this.generate("feedback")}static generateSequential(e="seq"){return`${e}_${++this.counter}`}static generateUUID(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});return e?`${e}_${t}`:t}static getRandomString(e=9){return Math.random().toString(36).substr(2,e)}static resetCounter(){this.counter=0}static getCurrentCounter(){return this.counter}}t(c,"counter",0);class o{constructor(e){t(this,"id"),t(this,"name"),t(this,"description"),t(this,"type"),t(this,"_power"),t(this,"_cost"),t(this,"effects"),t(this,"imageUrl"),t(this,"category"),t(this,"insuranceType"),t(this,"coverage"),t(this,"penalty"),t(this,"ageBonus"),t(this,"durationType"),t(this,"remainingTurns"),t(this,"insuranceEffectType"),t(this,"insuranceTriggerType"),t(this,"dreamCategory"),t(this,"skillProperties"),t(this,"comboProperties"),t(this,"eventProperties"),t(this,"isUnlockable"),t(this,"unlockCondition"),t(this,"rewardType"),this.id=e.id,this.name=e.name,this.description=e.description,this.type=e.type,this._power=s.create(e.power),this._cost=n.create(e.cost),this.effects=e.effects,this.imageUrl=e.imageUrl,this.category=e.category,this.insuranceType=e.insuranceType,this.coverage=e.coverage,this.penalty=e.penalty,"ageBonus"in e&&(this.ageBonus=e.ageBonus),"durationType"in e&&(this.durationType=e.durationType),"remainingTurns"in e&&(this.remainingTurns=e.remainingTurns),"insuranceEffectType"in e&&(this.insuranceEffectType=e.insuranceEffectType),"insuranceTriggerType"in e&&(this.insuranceTriggerType=e.insuranceTriggerType),"dreamCategory"in e&&(this.dreamCategory=e.dreamCategory),"skillProperties"in e&&(this.skillProperties=e.skillProperties),"comboProperties"in e&&(this.comboProperties=e.comboProperties),"eventProperties"in e&&(this.eventProperties=e.eventProperties),"isUnlockable"in e&&(this.isUnlockable=e.isUnlockable),"unlockCondition"in e&&(this.unlockCondition=e.unlockCondition),"rewardType"in e&&(this.rewardType=e.rewardType)}get power(){return this._power.getValue()}get cost(){return this._cost.getValue()}getPower(){return this._power}getCost(){return this._cost}hasEffect(e){return this.effects.some(t=>t.type===e)}getEffect(e){return this.effects.find(t=>t.type===e)}isInsurance(){return"insurance"===this.type}isTermInsurance(){return this.isInsurance()&&"term"===this.durationType}isWholeLifeInsurance(){return this.isInsurance()&&"whole_life"===this.durationType}getInsuranceEffectType(){if(this.isInsurance())return this.insuranceEffectType||"offensive"}isDefensiveInsurance(){return this.isInsurance()&&"defensive"===this.getInsuranceEffectType()}isRecoveryInsurance(){return this.isInsurance()&&"recovery"===this.getInsuranceEffectType()}isSpecializedInsurance(){return this.isInsurance()&&"specialized"===this.getInsuranceEffectType()}calculateDamageReduction(){if(!this.isInsurance())return 0;if(!this.isDefensiveInsurance()&&!this.hasEffect("damage_reduction"))return 0;let e=0;this.isDefensiveInsurance()&&(e+=.5*(this.coverage||0));const t=this.getEffect("damage_reduction");return t&&(e+=.5*t.value),Math.min(e,50)}calculateTurnHeal(){if(!this.isRecoveryInsurance())return 0;const e=Math.floor((this.coverage||0)/20),t=this.getEffect("turn_heal");return e+(t?t.value:0)}calculateChallengeBonus(e){if(!this.isSpecializedInsurance())return 0;const t=this.getEffect("challenge_bonus");return t?.condition&&t.condition.includes(e)?t.value:0}isDreamCard(){return"dream"===this.type}copy(e){return new o({...this,power:this.power,cost:this.cost,effects:[...this.effects],...e})}clone(){return this.copy()}decrementRemainingTurns(){return this.isTermInsurance()&&this.remainingTurns?this.copy({remainingTurns:Math.max(0,this.remainingTurns-1)}):this}isExpired(){return!!this.isTermInsurance()&&0===this.remainingTurns}hasPowerAtLeast(e){const t=s.create(e);return this._power.isGreaterThanOrEqual(t)}isAffordableWith(e){return this._cost.isAffordableWith(e)}calculateEffectivePower(e){let t=this.power;return this.isInsurance()&&this.ageBonus&&(t+=this.ageBonus),void 0!==e&&(t+=e),this.isInsurance()&&"offensive"!==this.getInsuranceEffectType()?0:Math.max(0,t)}isLifeCard(){return"life"===this.type}isInsuranceCard(){return this.isInsurance()}isPitfallCard(){return"pitfall"===this.type}isSkillCard(){return"skill"===this.type}isComboCard(){return"combo"===this.type}isEventCard(){return"event"===this.type}isLegendaryCard(){return"legendary"===this.type}isChallengeCard(){return"challenge"===this.type}toDisplayString(){let e=`${this.name} - Power: ${this.power}, Cost: ${this.cost}`;return this.effects.length>0&&(e+=` - Effects: ${this.effects.map(e=>e.description).join(", ")}`),e}decrementTurn(){void 0!==this.remainingTurns&&this.remainingTurns>0&&this.remainingTurns--}static createLifeCard(e,t){const a=t>0?"+":"";return new o({id:c.generate("life"),name:e,description:`„Éë„ÉØ„Éº: ${a}${t}`,type:"life",power:t,cost:0,effects:[]})}static createChallengeCard(e,t){return new o({id:c.generate("challenge"),name:e,description:`ÂøÖË¶Å„Éë„ÉØ„Éº: ${t}`,type:"challenge",power:t,cost:0,effects:[]})}static createInsuranceCard(e,t,a=1,...r){return new o({id:c.generate("insurance"),name:e,description:`‰øùÈô∫„Ç´„Éº„Éâ - „Éë„ÉØ„Éº: +${t}`,type:"insurance",power:t,cost:a,effects:r})}static createSkillCard(e,t,a,r){return new o({id:c.generate("skill"),name:e,description:`${{common:"„Ç≥„É¢„É≥",rare:"„É¨„Ç¢",epic:"„Ç®„Éî„ÉÉ„ÇØ",legendary:"„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº"}[t]}„Çπ„Ç≠„É´ - „Éë„ÉØ„Éº: +${a}`,type:"skill",power:a,cost:0,effects:[],skillProperties:{rarity:t,cooldown:r,remainingCooldown:0,masteryLevel:1}})}static createComboCard(e,t,a,r){return new o({id:c.generate("combo"),name:e,description:`„Ç≥„É≥„Éú„Ç´„Éº„Éâ - „Éë„ÉØ„Éº: +${t} („Ç≥„É≥„ÉúÊôÇ: +${r})`,type:"combo",power:t,cost:0,effects:[],comboProperties:{requiredCards:a,comboBonus:r}})}static createEventCard(e,t,a,r=!1){return new o({id:c.generate("event"),name:e,description:`„Ç§„Éô„É≥„Éà„Ç´„Éº„Éâ - ${a}„Çø„Éº„É≥Á∂ôÁ∂ö`,type:"event",power:t,cost:0,effects:[],eventProperties:{duration:a,globalEffect:r}})}static createLegendaryCard(e,t,a){return new o({id:c.generate("legendary"),name:e,description:`„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº„Ç´„Éº„Éâ - „Éë„ÉØ„Éº: +${t}`,type:"legendary",power:t,cost:0,effects:[],isUnlockable:!0,unlockCondition:a})}}class l extends o{constructor(e){const a=[];"extreme"===e.riskLevel&&a.push({type:"special_action",value:0,description:"‰øùÈô∫ÂäπÊûúÁÑ°ÂäπÂåñ",condition:"„Åì„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Åß„ÅØ‰øùÈô∫„Ç´„Éº„Éâ„ÅÆ„Éë„ÉØ„Éº„ÅåÁÑ°Âäπ"}),super({id:c.generateCardId(),type:"challenge",name:e.name,description:e.description,power:e.power,cost:0,effects:a,dreamCategory:e.dreamCategory}),t(this,"riskLevel"),t(this,"successBonus"),t(this,"failurePenalty"),t(this,"insuranceImmunity"),this.riskLevel=e.riskLevel,this.successBonus=e.successBonus,this.failurePenalty=e.failurePenalty,this.insuranceImmunity=e.insuranceImmunity||"extreme"===e.riskLevel}getRiskMultiplier(){return{low:1.2,medium:1.5,high:2,extreme:3}[this.riskLevel]}calculateActualReward(e){return Math.floor(e*this.getRiskMultiplier())+this.successBonus}calculateActualPenalty(e){return Math.floor(e*this.getRiskMultiplier())+this.failurePenalty}getRiskDescription(){return{low:"‰Ωé„É™„Çπ„ÇØ: Â∞ë„ÅóÂç±Èô∫„Å†„Åå„ÄÅÂ§±Êïó„Åó„Å¶„ÇÇ„ÉÄ„É°„Éº„Ç∏„ÅØËªΩ„ÅÑ",medium:"‰∏≠„É™„Çπ„ÇØ: ÊàêÂäü„Å®Â§±Êïó„ÅÆ„Éê„É©„É≥„Çπ„ÅåÂèñ„Çå„Å¶„ÅÑ„Çã",high:"È´ò„É™„Çπ„ÇØ: Â§±ÊïóÊôÇ„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÅåÂ§ß„Åç„ÅÑ„Åå„ÄÅÂ†±ÈÖ¨„ÇÇÈ≠ÖÂäõÁöÑ",extreme:"Ê•µÈôê„É™„Çπ„ÇØ: ‰øùÈô∫„ÇÇÂäπ„Åã„Å™„ÅÑÂç±Èô∫„Å™ÊåëÊà¶„ÄÇÊàêÂäü„Åô„Çå„Å∞Â§ß„Åç„Å™Â†±ÈÖ¨"}[this.riskLevel]}getChallengeDetails(){return[`ÂøÖË¶Å„Éë„ÉØ„Éº: ${this.power}`,`„É™„Çπ„ÇØ„É¨„Éô„É´: ${this.riskLevel.toUpperCase()}`,`ÊàêÂäü„Éú„Éº„Éä„Çπ: +${this.successBonus} Ê¥ªÂäõ`,`Â§±Êïó„Éö„Éä„É´„ÉÜ„Ç£: -${this.failurePenalty} Ê¥ªÂäõ`,this.insuranceImmunity?"‚ö†Ô∏è ‰øùÈô∫ÁÑ°Âäπ":""].filter(Boolean).join("\n")}static createRiskChallenge(e,t){const a={youth:{low:{name:"Êñ∞„Åó„ÅÑ„Çπ„Éù„Éº„ÉÑ„Å∏„ÅÆÊåëÊà¶",description:"Êú™ÁµåÈ®ì„ÅÆÂàÜÈáé„Å´ÊåëÊà¶„Åô„ÇãÂãáÊ∞ó",power:5,successBonus:2,failurePenalty:1},medium:{name:"Ëµ∑Ê•≠„Å∏„ÅÆÁ¨¨‰∏ÄÊ≠©",description:"ÂÆâÂÆö„ÇíÊç®„Å¶„Å¶Â§¢„ÇíËøΩ„ÅÜÊ±∫Êñ≠",power:7,successBonus:5,failurePenalty:3},high:{name:"Êµ∑Â§ñÁïôÂ≠¶",description:"Êú™Áü•„ÅÆ‰∏ñÁïå„Å∏„ÅÆÂ§ß„Åç„Å™È£õË∫ç",power:9,successBonus:8,failurePenalty:5},extreme:{name:"‰∫∫Áîü„ÇíË≥≠„Åë„ÅüÂ§ßÂãùË≤†",description:"ÂÖ®„Å¶„ÇíÊäï„ÅíÊâì„Å£„Å¶Êåë„ÇÄÊúÄÂ§ß„ÅÆÊåëÊà¶",power:12,successBonus:15,failurePenalty:10}},middle:{low:{name:"ÂâØÊ•≠„ÅÆÈñãÂßã",description:"Êñ∞„Åü„Å™ÂèéÂÖ•Ê∫ê„Å∏„ÅÆÊåëÊà¶",power:6,successBonus:3,failurePenalty:2},medium:{name:"Áã¨Á´ãÈñãÊ•≠",description:"‰ºöÁ§æ„ÇíËæû„ÇÅ„Å¶Áã¨Á´ã„Åô„ÇãÊ±∫Êñ≠",power:9,successBonus:7,failurePenalty:5},high:{name:"Â§ßÂûãÊäïË≥á",description:"Â∞ÜÊù•„ÇíË¶ãÊçÆ„Åà„ÅüÂ§ßËÉÜ„Å™ÊäïË≥á",power:11,successBonus:10,failurePenalty:7},extreme:{name:"‰∫∫Áîü„ÅÆÂ§ßËª¢Êèõ",description:"ÂÖ®„Å¶„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Êñ∞„Åó„ÅÑÈÅì„Å∏",power:15,successBonus:20,failurePenalty:15}},fulfillment:{low:{name:"Êñ∞„Åó„ÅÑË∂£Âë≥„Å∏„ÅÆÊåëÊà¶",description:"Âπ¥ÈΩ¢„Å´Èñ¢‰øÇ„Å™„ÅèÊñ∞„Åó„ÅÑ„Åì„Å®„ÇíÂßã„ÇÅ„Çã",power:7,successBonus:4,failurePenalty:2},medium:{name:"„Éú„É©„É≥„ÉÜ„Ç£„Ç¢Ê¥ªÂãï",description:"Á§æ‰ºöË≤¢ÁåÆ„Å∏„ÅÆÊñ∞„Åü„Å™‰∏ÄÊ≠©",power:10,successBonus:8,failurePenalty:4},high:{name:"ÈÅ∫Áî£„ÅÆÊ¥ªÁî®",description:"Ê¨°‰∏ñ‰ª£„Å∏„ÅÆÂ§ß„Åç„Å™ÊäïË≥á",power:13,successBonus:12,failurePenalty:8},extreme:{name:"‰∫∫ÁîüÊúÄÂæå„ÅÆÂ§ßÂÜíÈô∫",description:"ÊÆã„Åï„Çå„ÅüÊôÇÈñì„Åß„ÅÆÁ©∂Ê•µ„ÅÆÊåëÊà¶",power:18,successBonus:25,failurePenalty:20}}}[e][t];return new l({...a,riskLevel:t,dreamCategory:"extreme"===t?"mixed":"physical"})}}class u{static calculateAgeBonus(e){switch(e){case"middle":return.5;case"fulfillment":return 1;default:return 0}}static createCardsFromDefinitions(e,t){return e.map(e=>t(e))}static createStarterLifeCards(){return this.createCardsFromDefinitions([{name:"Êúù„ÅÆ„Ç∏„Éß„ÇÆ„É≥„Ç∞",description:"ÂÅ•Â∫∑ÁöÑ„Å™‰∏ÄÊó•„ÅÆÂßã„Åæ„Çä",category:"health",power:3,cost:1},{name:"Ê†ÑÈ§ä„Éê„É©„É≥„Çπ„ÅÆËâØ„ÅÑÈ£ü‰∫ã",description:"‰ΩìË™øÁÆ°ÁêÜ„ÅÆÂü∫Êú¨",category:"health",power:5,cost:2},{name:"Êñ∞„Åó„ÅÑ„Çπ„Ç≠„É´„ÅÆÁøíÂæó",description:"ÊàêÈï∑„Å∏„ÅÆÊäïË≥á",category:"career",power:5,cost:2},{name:"„ÉÅ„Éº„É†„ÉØ„Éº„ÇØ",description:"‰ª≤Èñì„Å®„ÅÆÂçîÂäõ",category:"career",power:3,cost:1},{name:"ÂÆ∂Êóè„Å®„ÅÆÂõ£„Çâ„Çì",description:"ÂøÉ„ÅÆÂÖÖÈõª",category:"family",power:3,cost:1},{name:"Ë∂£Âë≥„ÅÆÊôÇÈñì",description:"„É™„Éï„É¨„ÉÉ„Ç∑„É•„Çø„Ç§„É†",category:"hobby",power:3,cost:1},{name:"Ë®àÁîªÁöÑ„Å™Ë≤ØËìÑ",description:"Â∞ÜÊù•„Å∏„ÅÆÂÇô„Åà",category:"finance",power:5,cost:2}],e=>this.createLifeCard(e))}static createBasicInsuranceCards(e="youth"){const t=this.calculateAgeBonus(e);return this.createCardsFromDefinitions([{name:"ÂåªÁôÇ‰øùÈô∫",description:"ÁóÖÊ∞ó„ÇÑ„Ç±„Ç¨„Å´ÂÇô„Åà„ÇãÊ∞∏Á∂ö‰øùÈöú",insuranceType:"medical",power:4,cost:3,coverage:100},{name:"ÁîüÂëΩ‰øùÈô∫",description:"ÂÆ∂Êóè„ÇíÂÆà„ÇãÊ∞∏Á∂ö‰øùÈöú",insuranceType:"life",power:5,cost:4,coverage:200},{name:"ÂèéÂÖ•‰øùÈöú‰øùÈô∫",description:"ÂÉç„Åë„Å™„Åè„Å™„Å£„ÅüÊôÇ„ÅÆÊ∞∏Á∂ö‰øùÈöú",insuranceType:"income",power:4,cost:3,coverage:150}],e=>this.createInsuranceCard({...e,ageBonus:t}))}static createExtendedInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e),r=this.createCardsFromDefinitions([{name:"ÂåªÁôÇ‰øùÈô∫",insuranceType:"medical",power:5,cost:4,coverage:100},{name:"ÁîüÂëΩ‰øùÈô∫",insuranceType:"life",power:6,cost:5,coverage:200},{name:"ÂèéÂÖ•‰øùÈöú‰øùÈô∫",insuranceType:"income",power:5,cost:4,coverage:150}],e=>this.createInsuranceCard({name:e.name,description:`${e.name}„ÅÆÊ∞∏Á∂ö‰øùÈöú`,insuranceType:e.insuranceType,power:e.power,cost:e.cost,coverage:e.coverage,ageBonus:a}));t.push(...r);const s=this.createCardsFromDefinitions([{name:"ÂÇ∑ÂÆ≥‰øùÈô∫",insuranceType:"medical",power:4,cost:3,coverage:80},{name:"Â∞±Ê•≠‰∏çËÉΩ‰øùÈô∫",insuranceType:"income",power:7,cost:6,coverage:250},{name:"‰ªãË≠∑‰øùÈô∫",insuranceType:"medical",power:6,cost:5,coverage:180},{name:"„Åå„Çì‰øùÈô∫",insuranceType:"medical",power:5,cost:4,coverage:120},{name:"ÂÄã‰∫∫Âπ¥Èáë‰øùÈô∫",insuranceType:"income",power:4,cost:4,coverage:100},{name:"Â≠¶Ë≥á‰øùÈô∫",insuranceType:"life",power:4,cost:3,coverage:90}],e=>this.createInsuranceCard({name:e.name,description:`${e.name}„ÅÆÊ∞∏Á∂ö‰øùÈöú`,insuranceType:e.insuranceType,power:e.power,cost:e.cost,coverage:e.coverage,ageBonus:a}));return t.push(...s),t}static createDiverseInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e);return t.push(new o({id:c.generateCardId(),type:"insurance",name:"ÊîªÊíÉÁâπÂåñÁîüÂëΩ‰øùÈô∫",description:"„ÉÅ„É£„É¨„É≥„Ç∏ÊôÇ„Å´Â§ß„Åç„Å™„Éë„ÉØ„Éº„ÇíÊèê‰æõ",power:8,cost:5,insuranceType:"life",insuranceEffectType:"offensive",coverage:150,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"Èò≤Âæ°ÁâπÂåñÂåªÁôÇ‰øùÈô∫",description:"„ÉÄ„É°„Éº„Ç∏„ÇíËªΩÊ∏õ„Åô„ÇãÈò≤Âæ°ÁöÑ‰øùÈöú",power:0,cost:4,insuranceType:"medical",insuranceEffectType:"defensive",coverage:100,effects:[{type:"damage_reduction",value:3,description:"„ÉÄ„É°„Éº„Ç∏„Çí3„Éù„Ç§„É≥„ÉàËªΩÊ∏õ"}],ageBonus:0,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ÂõûÂæ©ÁâπÂåñÂÅ•Â∫∑‰øùÈô∫",description:"ÊØé„Çø„Éº„É≥Ê¥ªÂäõ„ÇíÂõûÂæ©",power:0,cost:3,insuranceType:"health",insuranceEffectType:"recovery",coverage:80,effects:[{type:"turn_heal",value:2,description:"ÊØé„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇ„Å´2ÁÇπÂõûÂæ©"}],ageBonus:0,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"‰ªï‰∫ãÁâπÂåñÂèéÂÖ•‰øùÈöú‰øùÈô∫",description:"‰ªï‰∫ãÈñ¢ÈÄ£„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Å´ÁâπÂåñ",power:3,cost:4,insuranceType:"income",insuranceEffectType:"specialized",coverage:120,effects:[{type:"challenge_bonus",value:5,description:"„ÄåÂ∞±ËÅ∑„Äç„ÄåÊòéÈÄ≤„Äç„ÉÅ„É£„É¨„É≥„Ç∏ÊôÇ+5„Éë„ÉØ„Éº",condition:"Â∞±ËÅ∑,ÊòéÈÄ≤,Ëª¢ËÅ∑,‰ªï‰∫ã"}],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"„Ç™„Éº„É´„Ç§„É≥„ÉØ„É≥Á∑èÂêà‰øùÈô∫",description:"Ë§áÊï∞„ÅÆÂäπÊûú„ÇíÊåÅ„Å§È´ò„Ç≥„Çπ„Éà‰øùÈöú",power:3,cost:7,insuranceType:"life",insuranceEffectType:"comprehensive",coverage:200,effects:[{type:"power_boost",value:3,description:"„Éë„ÉØ„Éº+3"},{type:"damage_reduction",value:2,description:"„ÉÄ„É°„Éº„Ç∏-2"},{type:"turn_heal",value:1,description:"ÊØé„Çø„Éº„É≥+1ÂõûÂæ©"}],ageBonus:a,durationType:"whole_life"})),t}static createTriggerInsuranceCards(e="youth"){const t=[],a=this.calculateAgeBonus(e);return t.push(new o({id:c.generateCardId(),type:"insurance",name:"ÁîüÂëΩ‰øùÈô∫",description:"Ê¥ªÂäõ„Åå0„Å´„Å™„ÇãÁû¨Èñì„ÄÅÊ¥ªÂäõ10„ÅßÂæ©Ê¥ª„ÄÇË´ãÊ±ÇÂæå„ÅØÂ•ëÁ¥ÑÁµÇ‰∫Ü„ÄÇ",power:0,cost:2,insuranceType:"life",insuranceEffectType:"trigger",insuranceTriggerType:"on_death",coverage:10,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ÂåªÁôÇ‰øùÈô∫",description:"10„ÉÄ„É°„Éº„Ç∏‰ª•‰∏äÂèó„Åë„ÇãÊôÇ„ÄÅ1„ÉÄ„É°„Éº„Ç∏„Å´ËªΩÊ∏õ„ÄÇË´ãÊ±ÇÂæå„ÅØÂ•ëÁ¥ÑÁµÇ‰∫Ü„ÄÇ",power:0,cost:3,insuranceType:"medical",insuranceEffectType:"trigger",insuranceTriggerType:"on_heavy_damage",coverage:10,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"ÈöúÂÆ≥‰øùÈô∫",description:"ËÄÅÂåñ„Ç´„Éº„Éâ„Åå3ÊûöÊèÉ„Å£„ÅüÊôÇ„ÄÅÊâãÊú≠„ÇíÂÖ®„Å¶Âºï„ÅçÁõ¥„Åó„ÄÇË´ãÊ±ÇÂæå„ÅØÂ•ëÁ¥ÑÁµÇ‰∫Ü„ÄÇ",power:0,cost:2,insuranceType:"disability",insuranceEffectType:"trigger",insuranceTriggerType:"on_aging_gameover",coverage:0,effects:[],ageBonus:a,durationType:"whole_life"})),t.push(new o({id:c.generateCardId(),type:"insurance",name:"Â∞±Ê•≠‰∏çËÉΩ‰øùÈô∫",description:"„ÅÑ„Å§„Åß„ÇÇÁô∫ÂãïÂèØËÉΩ„ÄÇÁèæÂú®„ÅÆË™≤È°å„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºà„ÉÄ„É°„Éº„Ç∏„Å™„ÅóÔºâ„ÄÇË´ãÊ±ÇÂæå„ÅØÂ•ëÁ¥ÑÁµÇ‰∫Ü„ÄÇ",power:0,cost:3,insuranceType:"income",insuranceEffectType:"trigger",insuranceTriggerType:"on_demand",coverage:0,effects:[],ageBonus:a,durationType:"whole_life"})),t}static createInsuranceTypeChoices(e="youth"){const t=this.calculateAgeBonus(e),a=[{type:"medical",name:"„Åò„Å∂„Çì„Å∏„ÅÆ‰øùÈô∫",description:"Â§±ÊïóÊôÇ„ÅÆ„É™„Çπ„ÇØ„ÇíËªΩÊ∏õ„Åô„ÇãÂåªÁôÇ‰øùÈô∫",power:0,planA:{cost:1,duration:10,cut:3,desc:"ÂÆöÈ°çÊîØÊâï„Éó„É©„É≥ÔºàÂ§±Êïó„ÉÄ„É°„Éº„Ç∏-3„Éª„Ç≥„Çπ„Éà1Ôºâ"},planB:{cost:2,cut:8,desc:"ÂÖÖÂÆü‰øùÈöú„Éó„É©„É≥ÔºàÂ§±Êïó„ÉÄ„É°„Éº„Ç∏-8„Éª„Ç≥„Çπ„Éà2Ôºâ"},effectType:"defensive",triggerType:"on_heavy_damage"},{type:"cancer",name:"„Åå„Çì‰øùÈô∫",description:"‰∫àÊúü„Åõ„Å¨Â§ßÁóÖÔºàÂ§ß„ÉÄ„É°„Éº„Ç∏Ôºâ„Å´ÂÇô„Åà„Çã",power:0,planA:{cost:1,duration:5,limit:1,desc:"Ë®∫Êñ≠Áµ¶‰ªòÈáë„Éó„É©„É≥Ôºà20‰ª•‰∏ä„ÅÆÊêçÂÆ≥„Çí1ÂõûÁÑ°ÂäπÂåñ„Éª„Ç≥„Çπ„Éà1Ôºâ"},planB:{cost:3,limit:-1,desc:"ÈÄöÈô¢Ê≤ªÁôÇ„Éó„É©„É≥Ôºà20‰ª•‰∏ä„ÅÆÊêçÂÆ≥„Çí‰ΩïÂ∫¶„Åß„ÇÇÁÑ°ÂäπÂåñ„Éª„Ç≥„Çπ„Éà3Ôºâ"},effectType:"defensive",triggerType:"on_heavy_damage"},{type:"income",name:"„ÅØ„Åü„Çâ„Åè‰∫∫„Å∏„ÅÆ‰øùÈô∫",description:"ÊâãÊú≠‰∫ãÊïÖÔºàÂ∞±Ê•≠‰∏çËÉΩÔºâÊôÇ„ÅÆ„É™„Çª„ÉÉ„Éà‰øùÈöú",power:0,planA:{cost:1,duration:10,cooldown:2,desc:"Ê®ôÊ∫ñÊúàÈ°ç„Éó„É©„É≥Ôºà2„Çø„Éº„É≥„Å´1Âõû„Éû„É™„Ç¨„É≥ÂèØËÉΩ„Éª„Ç≥„Çπ„Éà1Ôºâ"},planB:{cost:2,cooldown:1,desc:"„ÅÇ„Çì„Åó„ÇìÊâãÂΩì„Éó„É©„É≥ÔºàÊØé„Çø„Éº„É≥„Éû„É™„Ç¨„É≥ÂèØËÉΩ„Éª„Ç≥„Çπ„Éà2Ôºâ"},effectType:"specialized",triggerType:"on_demand"}],r=a[Math.floor(Math.random()*a.length)];return[{insuranceType:r.type,name:r.name,description:r.description,baseCard:{name:r.name,description:r.description,type:"insurance",power:r.power,cost:1,insuranceType:r.type,coverage:0,insuranceEffectType:r.effectType,insuranceTriggerType:r.triggerType,effects:[],ageBonus:t},termOption:{cost:r.planA.cost,duration:r.planA.duration,description:r.planA.desc},wholeLifeOption:{cost:r.planB.cost,description:r.planB.desc}}]}static createTermInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:`ÂÆöÊúü${e.name}`,description:`${e.baseCard.description}Ôºà${e.termOption.duration}„Çø„Éº„É≥ÈôêÂÆöÔºâ`,power:e.baseCard.power,cost:e.termOption.cost,insuranceType:e.insuranceType,coverage:e.baseCard.coverage,effects:e.baseCard.effects,ageBonus:e.baseCard.ageBonus,insuranceEffectType:e.baseCard.insuranceEffectType,insuranceTriggerType:e.baseCard.insuranceTriggerType,durationType:"term",remainingTurns:e.termOption.duration})}static createWholeLifeInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:`ÁµÇË∫´${e.name}`,description:`${e.baseCard.description}ÔºàÊ∞∏Á∂ö‰øùÈöúÔºâ`,power:e.baseCard.power,cost:e.wholeLifeOption.cost,insuranceType:e.insuranceType,coverage:e.baseCard.coverage,effects:e.baseCard.effects,ageBonus:e.baseCard.ageBonus,insuranceEffectType:e.baseCard.insuranceEffectType,insuranceTriggerType:e.baseCard.insuranceTriggerType,durationType:"whole_life"})}static createChallengeCards(e){const t={youth:[{name:"„Ç¢„É´„Éê„Ç§„ÉàÊé¢„Åó",description:"Âàù„ÇÅ„Å¶„ÅÆÂèéÂÖ•„ÇíÂæó„Çã",power:10,damage:10,dreamCategory:"physical"},{name:"‰∏Ä‰∫∫ÊöÆ„Çâ„Åó",description:"Áã¨Á´ã„Å∏„ÅÆÁ¨¨‰∏ÄÊ≠©",power:12,damage:12,dreamCategory:"physical"},{name:"Ë≥áÊ†ºË©¶È®ì",description:"„Çπ„Ç≠„É´„Ç¢„ÉÉ„Éó„ÅÆ„ÉÅ„É£„É≥„Çπ",power:14,damage:14,dreamCategory:"intellectual"},{name:"Â∞±ËÅ∑Ê¥ªÂãï",description:"Êñ∞„Åü„Å™„Ç≠„É£„É™„Ç¢„ÅÆÂßã„Åæ„Çä",power:16,damage:16,dreamCategory:"physical"},{name:"ÊÅã‰∫∫„Å®„ÅÆÂà•„Çå",description:"Âàù„ÇÅ„Å¶„ÅÆÂ§ß„Åç„Å™Â§±ÊÑè",power:13,damage:13,dreamCategory:"mixed"},{name:"Ëª¢ËÅ∑Ê¥ªÂãï",description:"„Ç≠„É£„É™„Ç¢„ÅÆÂàÜÂ≤êÁÇπ",power:15,damage:15,dreamCategory:"intellectual"}],middle:[{name:"ÁµêÂ©öË≥áÈáë",description:"Êñ∞„Åó„ÅÑÂÆ∂Êóè„ÅÆ„Çπ„Çø„Éº„Éà",power:22,damage:8,dreamCategory:"mixed"},{name:"Â≠êËÇ≤„Å¶",description:"ÂÆ∂Êóè„ÅÆÊàêÈï∑",power:24,damage:8,dreamCategory:"physical"},{name:"‰∏°Ë¶™„ÅÆÂÅ•Â∫∑",description:"ÂÆ∂Êóè„ÅÆÊîØ„ÅàÂêà„ÅÑ",power:22,damage:7,dreamCategory:"mixed"},{name:"‰ΩèÂÆÖË≥ºÂÖ•",description:"Â§ß„Åç„Å™Ê±∫Êñ≠",power:28,damage:10,dreamCategory:"physical"},{name:"Ë¶™„ÅÆ‰ªãË≠∑",description:"ÂÆ∂Êóè„ÅÆË≤¨‰ªª",power:32,damage:12,dreamCategory:"mixed"},{name:"ÊïôËÇ≤Ë≥áÈáë",description:"Â≠ê‰æõ„ÅÆÂ∞ÜÊù•„Å∏„ÅÆÊäïË≥á",power:26,damage:9,dreamCategory:"intellectual"}],fulfillment:[{name:"Ê¨°‰∏ñ‰ª£„ÅÆËÇ≤Êàê",description:"Ëã•ËÄÖ„Åü„Å°„Å´Áü•Ë≠ò„Å®ÁµåÈ®ì„Çí‰ºù„Åà„Çã",power:25,damage:8,dreamCategory:"intellectual"},{name:"Âú∞ÂüüÁ§æ‰ºö„ÅÆÂ§âÈù©",description:"‰Ωè„Åø„Çà„ÅÑÁ§æ‰ºö„Çí‰Ωú„Çã„Åü„ÇÅ„ÅÆÊ¥ªÂãï",power:28,damage:10,dreamCategory:"mixed"},{name:"ÁîüÊ∂Ø„ÅÆÁ†îÁ©∂Áô∫Ë°®",description:"Èï∑Âπ¥„ÅÆÊé¢Á©∂„ÅÆÊàêÊûú„Çí‰∏ñ„Å´Âá∫„Åô",power:30,damage:10,dreamCategory:"intellectual"},{name:"‰∏ñÁïåÂπ≥Âíå„Å∏„ÅÆË≤¢ÁåÆ",description:"ÂõΩÂ¢É„ÇíË∂ä„Åà„ÅüÊÖàÂñÑÊ¥ªÂãï",power:35,damage:12,dreamCategory:"mixed"},{name:"ÂÆáÂÆôÊóÖË°å",description:"‰∫∫È°û„ÅÆÂ§¢„ÄÅÊòü„ÄÖ„ÅÆÊµ∑„Å∏",power:45,damage:15,dreamCategory:"physical",isDream:!0},{name:"‰ºùË™¨„ÅÆÁ∂ôÊâø",description:"Ëá™Ë∫´„ÅÆÁîü„ÅçÊßò„Çí‰ºùË™¨„Å®„Åó„Å¶ÊÆã„Åô",power:50,damage:20,dreamCategory:"mixed",isDream:!0}]},a=[...t[e]||t.fulfillment].sort(()=>Math.random()-.5),r=3+Math.floor(2*Math.random()),s=a.slice(0,r),i=[...this.createCardsFromDefinitions(s,e=>this.createChallengeCard({...e,penalty:e.damage,isDream:e.isDream||!1})),...this.createRiskRewardChallenges(e)],n=this.createDreamCards(),c=Math.floor(2*Math.random())+1;for(let o=0;o<c;o++){const e=n[Math.floor(Math.random()*n.length)];e&&i.push(e)}return i}static createDreamCards(){return this.createCardsFromDefinitions([{name:"‰∏ñÁïå‰∏ÄÂë®ÊóÖË°å",description:"Êú™Áü•„ÅÆ‰∏ñÁïå„Çí‰ΩìÈ®ì„Åô„ÇãÂ§ßÂÜíÈô∫",power:80,damage:40,dreamCategory:"physical"},{name:"Êú¨„ÅÆÂá∫Áâà",description:"Ëá™ÂàÜ„ÅÆÁü•Ë≠ò„Çí‰∏ñ„Å´ÊÆã„ÅôÊåëÊà¶",power:80,damage:40,dreamCategory:"intellectual"},{name:"Âπ∏„Åõ„Å™ÂÆ∂Â∫≠",description:"ÊÑõ„Å´Ê∫Ä„Å°„ÅüÁîüÊ¥ª„ÇíÁØâ„Åè",power:75,damage:35,dreamCategory:"mixed"},{name:"Ëµ∑Ê•≠„Åó„Å¶ÊàêÂäü",description:"Ëá™ÂàÜ„ÅÆ„Éì„Ç∏„Éç„Çπ„ÅßÊàêÂäü„ÇíÊé¥„ÇÄ",power:85,damage:50,dreamCategory:"mixed"},{name:"Èö†Â±ÖÁîüÊ¥ª",description:"Èùô„Åã„ÅßÁ©è„ÇÑ„Åã„Å™‰ΩôÁîü„ÇíÈÄÅ„Çã",power:70,damage:30,dreamCategory:"physical"}],e=>this.createChallengeCard({...e,penalty:e.damage,isDream:!0}))}static createRiskRewardChallenges(e){const t=[],a={youth:{low:.5,medium:.3,high:.15,extreme:.05},middle:{low:.3,medium:.4,high:.2,extreme:.1},fulfillment:{low:.2,medium:.3,high:.3,extreme:.2}},r=a[e]||a.youth;if(Math.random()<.2){let a;const s=Math.random();a=s<r.low?"low":s<r.low+r.medium?"medium":s<r.low+r.medium+r.high?"high":"extreme";const i=l.createRiskChallenge(e,a);t.push(i)}return t}static createPitfallCards(){return this.createCardsFromDefinitions([{name:"ÊÄ•„Å™ÂÖ•Èô¢",description:"‰∫àÊúü„Åõ„Å¨ÂåªÁôÇË≤ª",power:0,penalty:3},{name:"Â§±Ê•≠",description:"ÂèéÂÖ•„ÅÆÈÄîÁµ∂",power:0,penalty:4},{name:"‰∫ãÊïÖ",description:"‰∫àÊúü„Åõ„Å¨„Éà„É©„Éñ„É´",power:0,penalty:2}],e=>this.createPitfallCard(e))}createLifeCard(e){return u.createLifeCard({name:`„ÉÜ„Çπ„Éà${e.category}„Ç´„Éº„Éâ`,description:`${e.category}„ÅÆ„ÉÜ„Çπ„Éà„Ç´„Éº„Éâ`,category:e.category,power:e.basePower,cost:e.baseCost})}static createLifeCard(e){if(e.power<0)throw new Error("Life card power cannot be negative");return new o({id:c.generateCardId(),type:"life",name:e.name,description:e.description,power:e.power,cost:e.cost,category:e.category,effects:[]})}static createInsuranceCard(e){return new o({id:c.generateCardId(),type:"insurance",name:e.name,description:e.description,power:e.power,cost:e.cost,insuranceType:e.insuranceType,coverage:e.coverage,effects:[{type:"shield",value:e.coverage,description:`${e.coverage}„Éù„Ç§„É≥„Éà„ÅÆ‰øùÈöú`}],ageBonus:e.ageBonus||0})}static createChallengeCard(e){const t=e.isDream?"dream":"challenge",a=this.determineRewardType(e.power,t);return new o({id:c.generateCardId(),type:t,name:e.name,description:e.description,power:e.power,cost:0,penalty:e.penalty,effects:[],dreamCategory:e.dreamCategory,rewardType:a})}static determineRewardType(e,t){return"dream"===t?"vitality":e<=3||e<=6?"insurance":"card"}static createPitfallCard(e){return new o({id:c.generateCardId(),type:"trouble",name:e.name,description:e.description,power:e.power,cost:0,penalty:e.penalty,effects:[]})}static createCard(e){const{base:t,effects:a}=e;return new o({id:t.id||c.generateCardId(),type:t.type,name:t.name,description:t.description,power:0,cost:0,effects:a||[]})}static createAgingCards(e){const t=[];for(let a=0;a<e;a++)t.push(new o({id:c.generateCardId(),type:"aging",name:"ËÄÅÂåñ",description:"Âπ¥ÈΩ¢„Å´„Çà„ÇãË°∞„Åà„ÄÇ‰ΩøÁî®‰∏çÂèØ„ÄÇ",power:0,cost:0,effects:[{type:"aging_penalty",value:0,description:"ÊâãÊú≠„Å´„ÅÇ„Çã„Å®Ê¥ªÂäõ„ÅåÊ∏õÂ∞ë„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã"}]}));return t}static createFinalChallengeCard(){return new o({id:c.generateCardId(),type:"final_challenge",name:"‰∫∫Áîü„ÅÆÁ∑èÊ±∫ÁÆó",description:"„Åì„Çå„Åæ„Åß„ÅÆ‰∫∫Áîü„ÅÆ„Åô„Åπ„Å¶„ÇíË≥≠„Åë„ÅüÊúÄÂæå„ÅÆÊåëÊà¶",power:0,cost:0,effects:[]})}static createSkillCards(e="youth"){const t={youth:[{name:"ÈõÜ‰∏≠Âäõ",description:"ÈõÜ‰∏≠„Åó„Å¶Âèñ„ÇäÁµÑ„ÇÄËÉΩÂäõ",rarity:"common",power:3,cooldown:0},{name:"„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥",description:"‰∫∫„Å®„ÅÆÈñ¢„Çè„Çä„ÇíÊ∑±„ÇÅ„Çã",rarity:"common",power:4,cooldown:1},{name:"„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó",description:"„ÉÅ„Éº„É†„ÇíÁéá„ÅÑ„ÇãÂäõ",rarity:"rare",power:6,cooldown:2},{name:"ÂâµÈÄ†ÊÄß",description:"Êñ∞„Åó„ÅÑ„Ç¢„Ç§„Éá„Ç¢„ÇíÁîü„ÅøÂá∫„Åô",rarity:"epic",power:8,cooldown:3}],middle:[{name:"Êà¶Áï•ÁöÑÊÄùËÄÉ",description:"Èï∑ÊúüÁöÑ„Å™Ë¶ñÁÇπ„ÅßËÄÉ„Åà„Çã",rarity:"rare",power:7,cooldown:2},{name:"„É°„É≥„Çø„É™„É≥„Ç∞",description:"ÂæåËº©„ÇíÊåáÂ∞é„Åô„ÇãËÉΩÂäõ",rarity:"rare",power:6,cooldown:1},{name:"Âç±Ê©üÁÆ°ÁêÜ",description:"„É™„Çπ„ÇØ„Çí‰∫àÊ∏¨„ÅóÂØæÂá¶„Åô„Çã",rarity:"epic",power:9,cooldown:3},{name:"„Ç§„Éé„Éô„Éº„Ç∑„Éß„É≥",description:"Èù©Êñ∞ÁöÑ„Å™Â§âÂåñ„ÇíËµ∑„Åì„Åô",rarity:"legendary",power:12,cooldown:4}],fulfillment:[{name:"‰∫∫Áîü„ÅÆÁü•ÊÅµ",description:"ÁµåÈ®ì„Åã„ÇâÂæó„ÅüÊ∑±„ÅÑÊ¥ûÂØü",rarity:"epic",power:10,cooldown:2},{name:"„É¨„Ç¨„Ç∑„ÉºÊßãÁØâ",description:"Ê¨°‰∏ñ‰ª£„Å∏„ÅÆ‰æ°ÂÄ§„ÅÇ„ÇãÈÅ∫Áî£",rarity:"legendary",power:15,cooldown:5},{name:"Á≤æÁ•ûÁöÑÂπ≥Âíå",description:"ÂÜÖ„Å™„ÇãË™øÂíå„Å®ÂÆâÂÆö",rarity:"legendary",power:13,cooldown:3}]},a=t[e]||t.youth;return this.createCardsFromDefinitions(a,e=>o.createSkillCard(e.name,e.rarity,e.power,e.cooldown))}static createComboCards(){return this.createCardsFromDefinitions([{name:"„ÉØ„Éº„ÇØ„É©„Ç§„Éï„Éê„É©„É≥„Çπ",power:2,requiredCards:["career","family"],comboBonus:4,description:"„Ç≠„É£„É™„Ç¢„Å®ÂÆ∂Êóè„ÅÆË™øÂíå"},{name:"ÂÅ•Â∫∑ÁöÑ„Å™ÊàêÂäü",power:3,requiredCards:["health","finance"],comboBonus:5,description:"ÂÅ•Â∫∑„Å®ÁµåÊ∏àÁöÑÂÆâÂÆö„ÅÆ‰∏°Á´ã"},{name:"ÂÖÖÂÆü„Åó„Åü‰∫∫Áîü",power:4,requiredCards:["hobby","family","career"],comboBonus:8,description:"Ë∂£Âë≥„ÉªÂÆ∂Êóè„Éª„Ç≠„É£„É™„Ç¢„ÅÆ‰∏â‰Ωç‰∏Ä‰Ωì"}],e=>o.createComboCard(e.name,e.power,e.requiredCards,e.comboBonus))}static createEventCards(e="youth"){const t={youth:[{name:"Êñ∞Âπ¥„ÅÆÊä±Ë≤†",description:"Êñ∞„Åó„ÅÑÂπ¥„Å∏„ÅÆÊ±∫ÊÑè",power:5,duration:3,globalEffect:!1},{name:"Â∞±ËÅ∑„Éñ„Éº„É†",description:"ÈõáÁî®Ê©ü‰ºö„ÅÆÂ¢óÂä†",power:4,duration:2,globalEffect:!0},{name:"ÂÅ•Â∫∑„Éñ„Éº„É†",description:"ÂÅ•Â∫∑„Å∏„ÅÆÊÑèË≠òÂêë‰∏ä",power:3,duration:4,globalEffect:!0}],middle:[{name:"ÁµåÊ∏àÊàêÈï∑Êúü",description:"Á§æ‰ºöÂÖ®‰Ωì„ÅÆÊ¥ªÊ≥Å",power:6,duration:3,globalEffect:!0},{name:"ÂÆ∂Êóè„ÅÆÁµÜ",description:"ÂÆ∂ÊóèÈñ¢‰øÇ„ÅÆÊ∑±Âåñ",power:7,duration:2,globalEffect:!1},{name:"ÊäÄË°ìÈù©Êñ∞",description:"„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÅÆÈÄ≤Ê≠©",power:8,duration:4,globalEffect:!0}],fulfillment:[{name:"‰∫∫Áîü„ÅÆÁ∑èÊ±∫ÁÆó",description:"ÁµåÈ®ì„ÅÆÁµ±Âêà„Å®ÊàêÁÜü",power:10,duration:2,globalEffect:!1},{name:"‰∏ñ‰ª£‰∫§‰ª£",description:"Ê¨°‰∏ñ‰ª£„Å∏„ÅÆÁ∂ôÊâø",power:9,duration:3,globalEffect:!0}]},a=t[e]||t.youth;return this.createCardsFromDefinitions(a,e=>o.createEventCard(e.name,e.power,e.duration,e.globalEffect))}static createLegendaryCards(){return this.createCardsFromDefinitions([{name:"‰∫∫Áîü„ÅÆÈÅî‰∫∫",power:20,unlockCondition:"ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„Åß50Âõû‰ª•‰∏äÊàêÂäü",description:"‰∫∫ÁîüÁµåÈ®ì„ÅÆÈõÜÂ§ßÊàê"},{name:"ÈÅãÂëΩ„ÇíÂ§â„Åà„ÇãÊ±∫Êñ≠",power:25,unlockCondition:"ÈÄ£Á∂ö10Âõû„ÉÅ„É£„É¨„É≥„Ç∏ÊàêÂäü",description:"‰∫∫Áîü„ÇíÂäáÁöÑ„Å´Â§â„Åà„ÇãÁû¨Èñì"},{name:"ÂÆåÁíß„Å™Ë™øÂíå",power:30,unlockCondition:"ÂÖ®„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Ç´„Éº„Éâ„Çí50Êûö‰ª•‰∏äÁç≤Âæó",description:"„Åô„Åπ„Å¶„ÅÆÂÅ¥Èù¢„ÅåÂÆåÁíß„Å´„Éê„É©„É≥„Çπ„Åó„ÅüÁä∂ÊÖã"}],e=>o.createLegendaryCard(e.name,e.power,e.unlockCondition))}static createRewardCards(e,t){return[...this.createSkillCards(e)].sort(()=>Math.random()-.5).slice(0,t)}}const h=class e{constructor(){t(this,"hand",[]),t(this,"discardPile",[]),t(this,"playerDeck",new a("Player Deck")),t(this,"challengeDeck",new a("Challenge Deck")),t(this,"selectedCards",[]),t(this,"cardChoices"),t(this,"config"),t(this,"agingDeck",new a("Aging Deck")),t(this,"insuranceMarket",[]),t(this,"activeInsurances",[]),t(this,"selectedIdsSet",new Set),t(this,"_cachedState"),t(this,"_stateVersion",0)}initialize(e,t,r){this.playerDeck=e,this.challengeDeck=t,this.hand=[],this.discardPile=[],this.selectedCards=[],this.selectedIdsSet.clear(),this.cardChoices=void 0,this.config=r,this.agingDeck=new a("Aging Deck"),this.insuranceMarket=[],this.activeInsurances=[]}getState(){if(this._cachedState&&this._stateVersion>0)return this._cachedState;console.log("[CardManager] getState rebuilding cache. Hand size:",this.hand.length);const e={hand:[...this.hand],discardPile:[...this.discardPile],playerDeck:this.playerDeck.clone(),challengeDeck:this.challengeDeck.clone(),selectedCards:[...this.selectedCards],cardChoices:this.cardChoices?[...this.cardChoices]:void 0,agingDeck:this.agingDeck.clone(),insuranceMarket:[...this.insuranceMarket],activeInsurances:[...this.activeInsurances]};return this._cachedState=e,this._stateVersion++,e}setState(e){this.hand=[...e.hand],this.discardPile=[...e.discardPile],this.playerDeck=e.playerDeck.clone(),this.challengeDeck=e.challengeDeck.clone(),this.selectedCards=[...e.selectedCards],this.cardChoices=e.cardChoices?[...e.cardChoices]:void 0,this.agingDeck=e.agingDeck.clone(),this.insuranceMarket=[...e.insuranceMarket],this.activeInsurances=[...e.activeInsurances],this.invalidateCache(),this.selectedIdsSet.clear(),this.selectedCards.forEach(e=>this.selectedIdsSet.add(e.id))}invalidateCache(){this._cachedState=void 0,this._stateVersion=0}drawCards(t){if(!this.config)throw new Error("CardManager not initialized");let a=e.CARD_POOLS.drawResults.pop();a?(a.drawnCards.length=0,a.discardedCards.length=0,a.troubleCards.length=0):a={drawnCards:[],discardedCards:[],troubleCards:[]};for(let e=0;e<t;e++){this.playerDeck.isEmpty()&&this.discardPile.length>0&&this.reshuffleDeck();const e=this.playerDeck.drawCard();e?"trouble"===e.type?(a.troubleCards.push(e),this.discardPile.push(e),console.log("[CardManager] Drawn Trouble card:",e.name)):(a.drawnCards.push(e),this.hand.push(e),console.log("[CardManager] Added card to hand. Hand size:",this.hand.length,"Card:",e.name)):console.warn("[CardManager] Failed to draw card (deck empty?)")}const r=this.enforceHandLimit();return a.discardedCards.push(...r),console.log("[CardManager] drawCards finished. Final hand size:",this.hand.length),this.invalidateCache(),a}toggleCardSelection(e){const t=e.id;if(this.selectedIdsSet.has(t)){this.selectedIdsSet.delete(t);const e=this.selectedCards.findIndex(e=>e.id===t);return-1!==e&&this.selectedCards.splice(e,1),this.invalidateCache(),!1}return this.selectedIdsSet.add(t),this.selectedCards.push(e),this.invalidateCache(),!0}clearSelection(){this.selectedCards.length=0,this.selectedIdsSet.clear(),this.invalidateCache()}discardSelectedCards(){const e=[];return this.selectedCards.forEach(t=>{const a=this.hand.findIndex(e=>e.id===t.id);if(-1!==a){const t=this.hand.splice(a,1)[0];t&&(this.discardPile.push(t),e.push(t))}}),this.selectedCards=[],e}addToHand(e){this.hand.push(e),this.invalidateCache()}addToDiscardPile(e){this.discardPile.push(e),this.invalidateCache()}addToPlayerDeck(e){this.playerDeck.addCard(e),this.invalidateCache()}enforceHandLimit(){if(!this.config)return[];const e=[];for(;this.hand.length>this.config.maxHandSize;){const t=this.hand.shift();t&&(this.discardPile.push(t),e.push(t))}return e}setCardChoices(e){this.cardChoices=[...e],this.invalidateCache()}clearCardChoices(){this.cardChoices=void 0,this.invalidateCache()}getCardChoiceById(e){return this.cardChoices?.find(t=>t.id===e)}reshuffleDeck(){this.playerDeck.addCards(this.discardPile),this.playerDeck.shuffle(),this.discardPile=[],this.addAgingCardToDiscard()}buyInsurance(e){const t=this.insuranceMarket.findIndex(t=>t.id===e.id);-1!==t&&(this.insuranceMarket.splice(t,1),this.activeInsurances.push(e),this.invalidateCache())}removeCardFromGame(e){let t=this.hand.findIndex(t=>t.id===e.id);return-1!==t?(this.hand.splice(t,1),void this.invalidateCache()):(t=this.discardPile.findIndex(t=>t.id===e.id),-1!==t?(this.discardPile.splice(t,1),void this.invalidateCache()):void(this.playerDeck.removeCard(e.id)&&this.invalidateCache()))}addAgingCardToDiscard(){const e=this.agingDeck.drawCard();e?(this.discardPile.push(e),console.log("[CardManager] Aging card added to discard pile due to reshuffle")):console.warn("[CardManager] No aging cards left! (Game Over Condition usually)")}getInsuranceMarket(){return this.insuranceMarket}getActiveInsurances(){return this.activeInsurances}drawChallengeCard(){const e=this.challengeDeck.drawCard();return e&&this.invalidateCache(),e}refillChallengeDeck(e){this.challengeDeck.clear(),this.challengeDeck.addCards(e),this.challengeDeck.shuffle(),this.invalidateCache()}getChallengeDeckSize(){return this.challengeDeck.getCards().length}discardHand(){const e=[...this.hand];return this.discardPile.push(...e),this.hand=[],this.invalidateCache(),e}};t(h,"CARD_POOLS",{drawResults:[]});let d=h;class g{constructor(e,t){this.value=e,this.factorType=t}static create(e,t){if(e<0||e>1)throw new Error(`Risk factor value must be between 0 and 1, got ${e}`);return new g(e,t)}getValue(){return this.value}getType(){return this.factorType}getRiskLevel(){return this.value<=.3?"low":this.value<=.7?"medium":"high"}getPremiumMultiplier(){const e={age:.5,health:.3,claims:.4,lifestyle:.2}[this.factorType]||.3;return 1+this.value*e}adjust(e){const t=Math.max(0,Math.min(1,this.value+e));return new g(t,this.factorType)}combine(e,t=.5){if(this.factorType!==e.factorType)throw new Error("Cannot combine different risk factor types");const a=this.value*(1-t)+e.value*t;return new g(a,this.factorType)}equals(e){return this.value===e.value&&this.factorType===e.factorType}toString(){return`RiskFactor(${this.factorType}: ${this.value.toFixed(2)} - ${this.getRiskLevel()})`}}class p{constructor(e){this.factors=e}static empty(){return new p(new Map)}static default(){const e=new Map;return e.set("age",g.create(.3,"age")),e.set("health",g.create(.2,"health")),e.set("claims",g.create(0,"claims")),e.set("lifestyle",g.create(.3,"lifestyle")),new p(e)}withFactor(e){const t=new Map(this.factors);return t.set(e.getType(),e),new p(t)}getFactor(e){return this.factors.get(e)}getOverallRiskScore(){if(0===this.factors.size)return 0;let e=0;return this.factors.forEach(t=>{e+=t.getValue()}),e/this.factors.size}getTotalPremiumMultiplier(){if(0===this.factors.size)return 1;let e=1;return this.factors.forEach(t=>{e*=t.getPremiumMultiplier()}),e}getSummary(){const e=this.getOverallRiskScore();return`${e<=.3?"‰Ωé„É™„Çπ„ÇØ":e<=.7?"‰∏≠„É™„Çπ„ÇØ":"È´ò„É™„Çπ„ÇØ"} („Çπ„Ç≥„Ç¢: ${e.toFixed(2)})`}}const m=class e{calculateAgeAdjustedPremium(t,a){const r=e.AGE_MULTIPLIERS[a]||1;return t.applyMultiplier(r)}calculateComprehensivePremium(e,t,a){if("insurance"!==e.type)throw new Error("Card must be an insurance card");const r=e.getCost(),s=this.calculateAgeAdjustedPremium(r,t),i=this.applyInsuranceTypeAdjustment(s,e.insuranceType),n=this.applyCoverageAdjustment(i,e.coverage);if(a){const t=this.calculateRiskAdjustment(a,e.insuranceType);return n.applyMultiplier(t)}return n}calculateTotalInsuranceBurden(e,t,a){const r=e.filter(e=>e&&"insurance"===e.type).map(e=>this.calculateComprehensivePremium(e,t,a)),s=n.sum(r),i=this.calculateMultiInsurancePenalty(e.length);return s.applyMultiplier(i)}calculateRenewalPremium(e,t,a){const r=this.calculateComprehensivePremium(e,t),s=this.calculateContinuityDiscount(a),i=r.applyDiscount(s),n=this.calculateRiskMultiplier(a);return i.applyMultiplier(n)}calculateOptimalInsuranceBudget(e,t,a="balanced"){const r={conservative:.15,balanced:.25,aggressive:.35}[a],s=Math.floor(e*r);return n.create(s)}applyInsuranceTypeAdjustment(t,a){if(!a)return t;const r=e.INSURANCE_TYPE_RATES[a]||1;return t.applyMultiplier(r)}applyCoverageAdjustment(e,t){if(!t||t<=0)return e.applyMultiplier(.5);const a=.5+t/400;return e.applyMultiplier(a)}calculateMultiInsurancePenalty(e){const t=Math.floor(e/5);return 1+Math.min(.1*t,.3)}calculateContinuityDiscount(e){return 0===e?.1:e<=2?.05:0}calculateRiskMultiplier(e){return e>=5?1.3:e>=3?1.1:1}calculateRiskAdjustment(e,t){let a=e.getTotalPremiumMultiplier();if(t){const r={health:"health",life:"age",disability:"health",accident:"lifestyle",cancer:"health"}[t];if(r){const t=e.getFactor(r);t&&(a=.8*a+.2*t.getPremiumMultiplier())}}return a}generateRiskProfile(e,t){let a=p.default();const r=this.calculateAgeRisk(t);a=a.withFactor(g.create(r,"age"));const s=this.calculateHealthRisk(e);a=a.withFactor(g.create(s,"health"));const i=this.calculateClaimsRisk(e);a=a.withFactor(g.create(i,"claims"));const n=this.calculateLifestyleRisk(e);return a=a.withFactor(g.create(n,"lifestyle")),a}calculateRiskAdjustedPremium(e,t,a){const r=this.calculateComprehensivePremium(e,t);if(!a)return r;const s=this.calculateRiskAdjustment(a,e.insuranceType);return r.applyMultiplier(s)}calculateAgeRisk(e){return{youth:.2,middle:.5,fulfillment:.6}[e]||.5}calculateHealthRisk(e){const t=(e.totalDamageTaken||0)/(e.turnsPlayed||1);return t>=3?.8:t>=2?.6:t>=1?.4:.2}calculateClaimsRisk(e){const t=(e.insuranceClaimCount||0)/(e.totalInsurancePurchased||1);return t>=.5?.9:t>=.3?.6:t>=.1?.3:.1}calculateLifestyleRisk(e){const t=(e.riskyChoiceCount||0)/(e.totalChoiceCount||1);return t>=.6?.8:t>=.4?.5:t>=.2?.3:.1}};t(m,"AGE_MULTIPLIERS",{youth:1,middle:1.2,fulfillment:1.3}),t(m,"INSURANCE_TYPE_RATES",{health:1,medical:1,life:1.2,income:1,asset:.5,disability:.8,accident:.6,cancer:1.5,dental:.4,travel:.3});let y=m;const f={STAGE_PARAMETERS:{youth:{label:"ÈùíÂπ¥Êúü",maxVitality:60,startTurn:0,endTurn:6,insuranceMultiplier:1,challengeDifficultyModifier:1},middle:{label:"‰∏≠Âπ¥Êúü",maxVitality:60,startTurn:7,endTurn:13,insuranceMultiplier:1.2,challengeDifficultyModifier:1.5},fulfillment:{label:"ÂÖÖÂÆüÊúü",maxVitality:50,startTurn:14,endTurn:1/0,insuranceMultiplier:1.5,challengeDifficultyModifier:2}}},C={AGE_ADJUSTMENTS:{physical:-2,intellectual:1,mixed:-1}},w={TYPE_RATES:{medical:1,life:1.2,income:1,asset:.5,disability:.8,accident:.6,cancer:1.5,dental:.4,travel:.3}},v={CARD_LIMITS:{maxHandSize:10,startingHandSize:5,defaultDrawCount:1,maxDeckSize:100},CHALLENGE_SETTINGS:{minDifficulty:1,maxDifficulty:20,successBonusBase:8,failurePenaltyRatio:1.5,enableDynamicDifficulty:!0},VITALITY_SETTINGS:{defaultStarting:40,minimumValue:0,maximumValue:150,healingCap:.85},PROGRESSION_SETTINGS:{maxTurns:20,stageTransitionTurns:{youthToMiddle:7,middleToFulfillment:14},victoryConditions:{minTurns:15,minVitality:50}}},T={CACHE_SETTINGS:{stateSnapshotTTL:50,calculationCacheTTL:100,maxCacheEntries:100},OBJECT_POOL_LIMITS:{maxPoolSize:10,initialPoolSize:3},PROCESSING_LIMITS:{maxCardsPerSelection:20,maxInsuranceCards:30,maxHistoryEntries:1e3}};class I{static setOverrides(e){this.overrides=e}static clearOverrides(){this.overrides=void 0}static getStageParameters(e){const t=f.STAGE_PARAMETERS[e]||f.STAGE_PARAMETERS.youth;return this.overrides?.stageParameters?.[e]?{...t,...this.overrides.stageParameters[e]}:t}static getDreamAgeAdjustment(e){return C.AGE_ADJUSTMENTS[e]??0}static getInsuranceTypeRate(e){return w.TYPE_RATES[e]??1}static getBalanceSettings(){const e=v;return this.overrides?{...e,CARD_LIMITS:{...e.CARD_LIMITS,...this.overrides.cardLimits},CHALLENGE_SETTINGS:{...e.CHALLENGE_SETTINGS,...this.overrides.challengeSettings},VITALITY_SETTINGS:{...e.VITALITY_SETTINGS,...this.overrides.vitalitySettings},PROGRESSION_SETTINGS:{...e.PROGRESSION_SETTINGS,...this.overrides.progressionSettings}}:e}static getPerformanceSettings(){return T}}t(I,"overrides");class S{checkStageProgression(e,t){const a=e;let r=e;const s=I.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;t>=s.youthToMiddle&&"youth"===e?r="middle":t>=s.middleToFulfillment&&"middle"===e&&(r="fulfillment");const i=a!==r,n=i?`üéØ „Çπ„ÉÜ„Éº„Ç∏„ÅåÂ§âÂåñ„Åó„Åæ„Åó„Åü: ${a} ‚Üí ${r} („Çø„Éº„É≥${t})`:void 0,c=this.getUpcomingTransitionMessage(e,t),o={newStage:r,hasChanged:i};return n&&(o.transitionMessage=n),c&&(o.upcomingTransition=c),o}getUpcomingTransitionMessage(e,t){const a=I.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;if("youth"===e){const e=a.youthToMiddle-t;if(e<=2&&e>0)return`‚è∞ ‰∏≠Âπ¥Êúü„Åæ„Åß„ÅÇ„Å®${e}„Çø„Éº„É≥ (‰ΩìÂäõ‰∏äÈôê„Åå${this.getStageVitalityLimit("middle")}„Å´Ê∏õÂ∞ë)`}else if("middle"===e){const e=a.middleToFulfillment-t;if(e<=2&&e>0)return`‚è∞ ÂÖÖÂÆüÊúü„Åæ„Åß„ÅÇ„Å®${e}„Çø„Éº„É≥ (‰ΩìÂäõ‰∏äÈôê„Åå${this.getStageVitalityLimit("fulfillment")}„Å´Ê∏õÂ∞ë)`}}getStageVitalityLimit(e){const t=I.getStageParameters(e);return t?t.maxVitality:60}static getStageTransitionInfo(){const e=I.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;return{youthToMiddle:e.youthToMiddle,middleToFulfillment:e.middleToFulfillment,description:`ÈùíÂπ¥Êúü‚Üí‰∏≠Âπ¥Êúü: „Çø„Éº„É≥${e.youthToMiddle}, ‰∏≠Âπ¥Êúü‚ÜíÂÖÖÂÆüÊúü: „Çø„Éº„É≥${e.middleToFulfillment}`}}static getStageDetails(e,t){const a={youth:{stageName:"ÈùíÂπ¥Êúü",description:"‰ΩìÂäõ„ÅØÂÖÖÂÆü„Åó„Å¶„ÅÑ„Çã„ÅåÁµåÈ®ì‰∏çË∂≥",vitalityLimit:35,characteristics:["È´ò„ÅÑ‰ΩìÂäõ‰∏äÈôê","ÁµåÈ®ì„Å´„Çà„ÇãÂäπÁéáÂåñ„Å™„Åó","Âü∫Êú¨ÁöÑ„Å™„ÉÅ„É£„É¨„É≥„Ç∏„ÅåÂ§ö„ÅÑ"]},middle:{stageName:"‰∏≠Âπ¥Êúü",description:"‰ΩìÂäõ„ÅØËêΩ„Å°„Çã„ÅåÁµåÈ®ìË±äÂØå",vitalityLimit:30,characteristics:["‰∏≠Á®ãÂ∫¶„ÅÆ‰ΩìÂäõ‰∏äÈôê","ÁµåÈ®ì„Å´„Çà„ÇãÂäπÁéáÂåñÈñãÂßã","Ë§áÈõë„Å™„ÉÅ„É£„É¨„É≥„Ç∏Â¢óÂä†"]},fulfillment:{stageName:"ÂÖÖÂÆüÊúü",description:"‰ΩìÂäõ„ÅØÈôê„Çâ„Çå„Çã„ÅåÁü•ÊÅµ„Å®‰ΩôË£ï",vitalityLimit:27,characteristics:["‰Ωé„ÅÑ‰ΩìÂäõ‰∏äÈôê","È´ò„ÅÑÁµåÈ®ì„Å´„Çà„ÇãÂäπÁéáÂåñ","Áü•Ë≠òÁ≥ª„ÉÅ„É£„É¨„É≥„Ç∏ÊúâÂà©"]}}[e],r=I.getBalanceSettings().PROGRESSION_SETTINGS.stageTransitionTurns;let s;if("youth"===e){const e=r.youthToMiddle-t;e>0&&(s={targetStage:"‰∏≠Âπ¥Êúü",atTurn:r.youthToMiddle,turnsRemaining:e})}else if("middle"===e){const e=r.middleToFulfillment-t;e>0&&(s={targetStage:"ÂÖÖÂÆüÊúü",atTurn:r.middleToFulfillment,turnsRemaining:e})}const i={...a};return s&&(i.nextTransition=s),i}advanceStage(e){switch(e){case"youth":return{newStage:"middle",isCompleted:!1};case"middle":return{newStage:"fulfillment",isCompleted:!1};default:return{newStage:null,isCompleted:!0}}}isFinalStage(e){return"fulfillment"===e}}const E=class e{updateInsuranceExpirations(e,t,a){const r=[];if(e.forEach(e=>{e.isTermInsurance()&&(e.decrementTurn(),e.isExpired()&&r.push(e))}),r.length>0)return r.forEach(t=>{const a=e.findIndex(e=>e.id===t.id);-1!==a&&e.splice(a,1)}),t.push(...r),this.createExpirationNotice(r,a)}getExpiringSoonInsurances(t){return t.filter(t=>t.isTermInsurance()&&void 0!==t.remainingTurns&&t.remainingTurns<=e.EXPIRING_SOON_THRESHOLD&&t.remainingTurns>0)}getExpirationWarnings(e){return this.getExpiringSoonInsurances(e).map(e=>`‚ö†Ô∏è „Äå${e.name}„Äç„ÅÆÊúüÈôê„Åæ„Åß„ÅÇ„Å®${e.remainingTurns}„Çø„Éº„É≥„Åß„Åô`)}createExpirationNotice(e,t){const a=e.map(e=>e.name).join("„ÄÅ");return{expiredCards:e,message:1===e.length?`ÂÆöÊúü‰øùÈô∫„Äå${a}„Äç„ÅÆÊúüÈôê„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇ`:`ÂÆöÊúü‰øùÈô∫${e.length}‰ª∂Ôºà${a}Ôºâ„ÅÆÊúüÈôê„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇ`,showRenewalOption:!0,turnNumber:t}}};t(E,"EXPIRING_SOON_THRESHOLD",2);let M=E;const _=[{id:"solid",name:"Â†ÖÂÆüÂÆ∂",description:"ÂÆà„ÇäÈáçË¶ñ„ÄÇÂàùÊúüÊ¥ªÂäõ„ÅåÈ´ò„Åè„ÄÅ‰øùÈô∫„ÅÆÂäπÊûú„ÅåÈ´ò„ÅÑ„ÄÇ",initialVitalityModifier:20,specialAbility:"insurance_bonus"},{id:"adventurer",name:"ÂÜíÈô∫ÂÆ∂",description:"„É™„Çπ„ÇØÂøóÂêë„ÄÇÂàùÊúüÊ¥ªÂäõ„ÅØ‰Ωé„ÅÑ„Åå„ÄÅ„ÉÅ„É£„É≥„Çπ„Å´Âº∑„ÅÑ„ÄÇ",initialVitalityModifier:-5,specialAbility:"risk_taker"},{id:"minimalist",name:"„Éü„Éã„Éû„É™„Çπ„Éà",description:"ÂäπÁéáÈáçË¶ñ„ÄÇ„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„ÅüÁîüÊ¥ª„Çπ„Çø„Ç§„É´„ÄÇ",initialVitalityModifier:10,specialAbility:"efficiency"}],P={youth:{maxVitality:25,label:"ÈùíÂπ¥Êúü",ageMultiplier:0},middle:{maxVitality:20,label:"‰∏≠Âπ¥Êúü",ageMultiplier:.5},middle_age:{maxVitality:20,label:"‰∏≠Âπ¥Êúü",ageMultiplier:.5},fulfillment:{maxVitality:15,label:"ÂÖÖÂÆüÊúü",ageMultiplier:1}},b={physical:3,intellectual:-2,mixed:0};class x{resolveChallenge(e,t,a,r,s,i){const n=e instanceof l&&e.insuranceImmunity,c=i&&!n?this.calculateInsuranceBonus(i,e):0,o=this.calculateTotalPower(t,s,c),u=o.total,h=this.getDreamRequiredPower(e,r),d=u>=h;let g,p=0,m="";if(d){const e=u-h,t=I.getBalanceSettings().CHALLENGE_SETTINGS.successBonusBase,a=Math.floor(e/2),r=i&&!n?this.calculateDamageReduction(i):0,s=Math.max(0,a-r);p=t-s,m=`üéâ „ÉÅ„É£„É¨„É≥„Ç∏ÊàêÂäüÔºÅ (+${t})`,s>0?m+=` „Åó„Åã„ÅóÈ†ëÂºµ„Çä„Åô„Åé„Å¶Áñ≤„Çå„Åü... (-${s})`:a>0&&0===s&&(m+=" (‰øùÈô∫„ÅåÈÅéÂä¥„ÇíÈò≤„ÅÑ„Å†ÔºÅ)")}else{const e=h,t=i&&!n?this.calculateDamageReduction(i):0,a=Math.max(1,e-t);p=-a,g=a,m=`üí• Â§±Êïó... ${a} „ÅÆ„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Åü`}a.discardSelectedCards();const y={challenge:e,success:d,resultType:d?"success":"damage_taken",playerPower:u,challengePower:h,vitalityChange:p,message:m,powerBreakdown:o};return d||void 0===g||(y.damageAmount=g),y}calculateTotalPower(e,t,a=0){let r=0,s=0;e.forEach(e=>{"insurance"===e.type?s+=e.calculateEffectivePower():r+=e.calculateEffectivePower()}),s+=a;const i=r+s-t;return{base:r,insurance:s,burden:-t,total:Math.max(0,i)}}getDreamRequiredPower(e,t){if(!e.dreamCategory)return e.power;if("youth"===t)return e.power;const a=b[e.dreamCategory]||0,r=e.power+a;return Math.max(1,r)}calculateInsuranceBonus(e,t){let a=0;const r=e.getActiveInsurances(),s=e.stage,i=P[s]||P.youth,n=i?.ageMultiplier??0;return r.forEach(e=>{let r=0;if(e.isSpecializedInsurance()){const a=t.name;r=e.calculateChallengeBonus(a)}e.isWholeLifeInsurance()&&n>0&&(r+=n),a+=r}),a}calculateDamageReduction(e){let t=0;return e.getActiveInsurances().forEach(e=>{t+=e.calculateDamageReduction()}),Math.min(t,100)}}class D{constructor(e,t){this.stageManager=e,this.expirationManager=t}nextTurn(e){if(this.validateGameState(e),e.cardManager.discardHand(),e.turn++,e.stats.turnsPlayed++,e.phase="draw",this.checkStageProgression(e),this.checkVictoryCondition(e),"victory"===e.status)return{newExpiredCount:0,remainingInsuranceCount:e.getActiveInsurances().length};const t=this.updateInsuranceExpirations(e),a=e.insuranceBurden;if(a>0)if(e.vitality>a)try{e.applyDamage(a),console.log(`üí∏ ‰øùÈô∫ÊñôÊîØÊâï„ÅÑ: -${a} Ê¥ªÂäõ`)}catch(r){console.error("‰øùÈô∫ÊñôÊîØÊâï„ÅÑ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",r)}else console.warn(`‚ö†Ô∏è ‰øùÈô∫Êñô(${a})„ÇíÊîØÊâï„ÅÜÊ¥ªÂäõ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÖ®„Å¶„ÅÆ‰øùÈô∫„ÅåÂ§±Âäπ„Åó„Åæ„Åô„ÄÇ`),e.expireAllInsurances();return"game_over"===e.status?{newExpiredCount:t?.expiredCards.length||0,remainingInsuranceCount:e.getActiveInsurances().length}:(this.applyRecoveryInsuranceEffects(e),{...t?{insuranceExpirations:t}:{},newExpiredCount:t?.expiredCards.length||0,remainingInsuranceCount:e.getActiveInsurances().length})}checkVictoryCondition(e){e.turn>=100&&"victory"!==e.status&&(e.status="game_over",e.completedAt=new Date,console.log("üíî „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº: 100„Çø„Éº„É≥ÁµåÈÅé„Åó„Å¶„ÇÇÂ§¢„ÇíÈÅîÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"))}validateGameState(e){if("in_progress"!==e.status)throw new Error("Game is not in progress")}checkStageProgression(e){const t=this.stageManager.checkStageProgression(e.stage,e.turn);t.hasChanged&&(e.setStage(t.newStage),t.transitionMessage&&console.log(t.transitionMessage))}updateInsuranceExpirations(e){const t=this.expirationManager.updateInsuranceExpirations(e.activeInsurances,e.expiredInsurances,e.turn);return t&&e.updateInsuranceBurden(),t}applyRecoveryInsuranceEffects(e){const t=e.getActiveInsurances();let a=0;t.forEach(e=>{e.isRecoveryInsurance()&&(a+=e.calculateTurnHeal())}),a>0&&(e.heal(a),console.log(`üíö ÂõûÂæ©Âûã‰øùÈô∫ÂäπÊûú: +${a} Ê¥ªÂäõ`))}}class k{constructor(e){this.resolutionService=e}startChallenge(e,t){if(this.validatePhase(e,"draw"),e.currentChallenge=t,e.cardManager.clearSelection(),e.phase="challenge",e.getLearningHistory(t.name)>=2){const a=Math.max(1,t.power-1),r=t.copy({power:a});e.currentChallenge=r}}resolveChallenge(e){try{this.validateChallenge(e);const t=this.resolutionService.resolveChallenge(e.currentChallenge,e.selectedCards,e.cardManager,e.stage,e.insuranceBurden,e);if(this.updateStatistics(e,t.success),this.updateVitality(e,t.vitalityChange),!t.success&&e.currentChallenge){const t=e.currentChallenge.name,a=e.getLearningHistory(t);e.updateLearningHistory(t,a+1),e.currentChallenge.isDreamCard()&&(console.log(`[Game] Defeated by dream: ${t}. Increasing difficulty.`),e.challengeDifficultyModifier+=2,console.log(`[Game] Difficulty modifier increased to ${e.challengeDifficultyModifier}`))}if(t.success){if("dream"===e.currentChallenge?.type||e.currentChallenge.isDream)return console.log("[GameChallengeService] Dream fulfilled! Victory!"),e.finishGame(!0),this.updateGameStateAfterChallenge(e,t),t;const a=u.createInsuranceTypeChoices(e.stage);e.insuranceTypeChoices=a,console.log("[GameChallengeService] Generated insurance choices:",e.insuranceTypeChoices?.length),e.insuranceTypeChoices&&0!==e.insuranceTypeChoices.length||console.warn("[GameChallengeService] WARNING: No insurance choices generated!"),t.insuranceTypeChoices=a}return this.updateGameStateAfterChallenge(e,t),t}catch(t){return console.error("[GameChallengeService] Fatal error resolving challenge:",t),{challenge:e.currentChallenge||u.createCard({base:{name:"Error",type:"life",description:"System Error"},variant:"default"}),success:!1,playerPower:0,challengePower:0,vitalityChange:0,message:`„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${t instanceof Error?t.message:String(t)}`,resultType:"error"}}}calculateTotalPower(e,t){let a=0,r=0;for(const i of t)"insurance"===i.type?r+=i.calculateEffectivePower():a+=i.calculateEffectivePower();const s=e.insuranceBurden;return{base:a,insurance:r,burden:s,total:Math.max(0,a+r+s)}}validatePhase(e,t){if(("challenge_choice"!==e.phase||"draw"!==t)&&e.phase!==t){if("draw"===t)throw new Error(`Can only start challenge during draw or challenge_choice phase (Current: ${e.phase})`);throw new Error(`Can only perform this action during ${t} phase (Current: ${e.phase})`)}}validateChallenge(e){if(!e.currentChallenge||"challenge"!==e.phase)throw new Error("No active challenge to resolve")}updateStatistics(e,t){e.stats.totalChallenges++,t?(e.stats.successfulChallenges++,e.stats.challengesCompleted||(e.stats.challengesCompleted=0),e.stats.challengesCompleted++):(e.stats.failedChallenges++,e.stats.challengesFailed||(e.stats.challengesFailed=0),e.stats.challengesFailed++)}updateVitality(e,t){if(t>=0)e.heal(t);else{const a=-t;if(a>=10){const t=e.activeInsurances.find(e=>"on_heavy_damage"===e.insuranceTriggerType);if(t&&(e.triggerInsuranceClaim(t,"on_heavy_damage"),e.pendingInsuranceClaim))return void(e.pendingInsuranceClaim.context={damage:a})}e.applyDamage(a)}}updateGameStateAfterChallenge(e,t){e.cardManager.discardSelectedCards(),e.phase=t.success?"insurance_type_selection":"resolution",e.currentChallenge=void 0,e.cardManager.clearSelection()}}class A{constructor(e){this.premiumService=e}addInsurance(e,t){if(!t.isInsurance())throw new Error("Only insurance cards can be added");e.activeInsurances.push(t),this.updateInsuranceBurden(e)}removeInsurance(e,t){const a=e.activeInsurances.findIndex(e=>e.id===t.id);-1!==a&&e.activeInsurances.splice(a,1),e.cardManager.removeCardFromGame(t),this.updateInsuranceBurden(e)}selectInsuranceType(e,t,a){this.validateInsuranceSelection(e);const r=this.findInsuranceChoice(e,t);if(!r)return{success:!1,message:"Invalid insurance type selection"};const s=this.createInsuranceCard(r,a);return this.addInsuranceCard(e,s),this.updatePlayerHistory(e,t),this.updateRiskProfile(e),this.completeInsuranceSelection(e),this.createSelectionResult(s,r,a)}calculateInsuranceBurden(e){if(0===e.activeInsurances.length)return 0;try{return-this.premiumService.calculateTotalInsuranceBurden(e.activeInsurances,e.stage,e.getRiskProfile()).getValue()}catch(t){return console.warn("‰øùÈô∫ÊñôË®àÁÆó„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:",t),this.fallbackBurdenCalculation(e)}}updateInsuranceBurden(e){const t=this.calculateInsuranceBurden(e),a=Math.abs(t);e._insuranceBurden=n.create(a),e._dirtyFlags&&(e._dirtyFlags.insurance=!0,e._dirtyFlags.burden=!0)}getRecommendedInsuranceBudget(e,t,a="balanced"){return this.premiumService.calculateOptimalInsuranceBudget(e,t,a)}getExpiringSoonInsurances(e){return e.filter(e=>!(!e.isTermInsurance()||!e.remainingTurns)&&e.remainingTurns<=2)}validateInsuranceSelection(e){if("insurance_type_selection"!==e.phase)throw new Error("Not in insurance type selection phase");if(!e.insuranceTypeChoices)throw new Error("No insurance type choices available")}findInsuranceChoice(e,t){return e.insuranceTypeChoices?.find(e=>e.insuranceType===t)}createInsuranceCard(e,t){return"term"===t?u.createTermInsuranceCard(e):u.createWholeLifeInsuranceCard(e)}addInsuranceCard(e,t){e.cardManager.addToPlayerDeck(t),e.stats.cardsAcquired++,e.activeInsurances.push(t),this.updateInsuranceBurden(e)}completeInsuranceSelection(e){e.insuranceTypeChoices=void 0,e.phase="resolution"}createSelectionResult(e,t,a){const r="term"===a?`ÂÆöÊúü‰øùÈô∫Ôºà${t.termOption.duration}„Çø„Éº„É≥Ôºâ`:"ÁµÇË∫´‰øùÈô∫";return{success:!0,selectedCard:e,message:`${t.name}Ôºà${r}Ôºâ„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„Çπ„Éà: ${e.cost}`}}fallbackBurdenCalculation(e){const t=e.activeInsurances.length,a=Math.floor(t/3);return 0===a?0:-a}updatePlayerHistory(e,t){const a=e.getPlayerHistory();a.totalInsurancePurchased++,"life"!==t&&"cancer"!==t||a.riskyChoiceCount++,a.totalChoiceCount++,e._playerHistory=a}updateRiskProfile(e){const t=this.premiumService.generateRiskProfile(e.getPlayerHistory(),e.stage);e._riskProfile=t}}class R{getName(){return"‰øùÂÆàÁöÑÊà¶Áï•"}getType(){return"conservative"}selectChallenge(e,t){const a=[...e].sort((e,t)=>e.power-t.power)[0],r=this.estimateCurrentPower(t);return{challenge:a,reason:"ÊúÄ„ÇÇÂÆâÂÖ®„ÅßÊàêÂäüÁ¢∫Áéá„ÅÆÈ´ò„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü",successProbability:Math.min(1,r/a.power)}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=t.filter(e=>"insurance"===e.type).sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower()),c=t.filter(e=>"insurance"!==e.type).sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower());for(const o of n){if(i>=1.2*r)break;s.push(o),i+=o.calculateEffectivePower()}for(const o of c){if(i>=1.2*r)break;s.push(o),i+=o.calculateEffectivePower()}return{cards:s,reason:"‰øùÈô∫„Ç´„Éº„Éâ„ÇíÈáçË¶ñ„Åó„ÄÅÂçÅÂàÜ„Å™‰ΩôË£ï„ÇíÊåÅ„Å£„ÅüÂÆâÂÖ®„Å™ÈÅ∏Êäû„ÇíË°å„ÅÑ„Åæ„Åó„Åü",expectedPower:i}}evaluateFitness(e){return 1-e.vitality/e.maxVitality}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}}class ${getName(){return"ÊîªÊíÉÁöÑÊà¶Áï•"}getType(){return"aggressive"}selectChallenge(e,t){const a=this.estimateCurrentPower(t),r=e.filter(e=>a>=.5*e.power).sort((e,t)=>t.power-e.power)[0]||e[0];return{challenge:r,reason:"È´ò„ÅÑÂ†±ÈÖ¨„ÇíÁãô„Å£„Å¶„ÄÅÂèØËÉΩ„Å™Èôê„ÇäÂõ∞Èõ£„Å™„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü",successProbability:Math.min(1,a/r.power)}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=[...t].sort((e,t)=>t.calculateEffectivePower()-e.calculateEffectivePower());for(const c of n){if(i>=r)break;s.push(c),i+=c.calculateEffectivePower()}return{cards:s,reason:"ÊúÄÈ´ò„Éë„ÉØ„Éº„ÅÆ„Ç´„Éº„Éâ„ÇíÂÑ™ÂÖà„Åó„ÄÅÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Ç≥„Çπ„Éà„ÅßÂãùÂà©„ÇíÁãô„ÅÑ„Åæ„Åó„Åü",expectedPower:i}}evaluateFitness(e){return(e.vitality/e.maxVitality+this.estimateHandStrength(e))/2}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}estimateHandStrength(e){const t=e.cardManager.playerDeck.getCards();if(0===t.length)return 0;const a=t.reduce((e,t)=>e+t.calculateEffectivePower(),0)/t.length;return Math.min(1,a/3)}}class B{getName(){return"„Éê„É©„É≥„ÇπÊà¶Áï•"}getType(){return"balanced"}selectChallenge(e,t){const a=this.estimateCurrentPower(t),r=e.map(e=>{const t=Math.min(1,a/e.power);return{challenge:e,successProbability:t,score:this.calculateRiskRewardScore(e,t)}}).sort((e,t)=>t.score-e.score)[0];return{challenge:r.challenge,reason:"„É™„Çπ„ÇØ„Å®„É™„Çø„Éº„É≥„ÅÆ„Éê„É©„É≥„Çπ„ÇíËÄÉÊÖÆ„Åó„Å¶ÊúÄÈÅ©„Å™„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü",successProbability:r.successProbability}}selectCards(e,t,a){const r=e.power,s=[];let i=0;const n=t.map(e=>({card:e,efficiency:this.calculateCardEfficiency(e,a)})).sort((e,t)=>t.efficiency-e.efficiency);for(const{card:c}of n){if(i>=1.1*r)break;s.push(c),i+=c.calculateEffectivePower()}return{cards:s,reason:"„Ç´„Éº„ÉâÂäπÁéá„Å®„É™„Çπ„ÇØÁÆ°ÁêÜ„Çí‰∏°Á´ã„Åó„ÅüÊúÄÈÅ©„Å™ÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü",expectedPower:i}}evaluateFitness(e){return.6}estimateCurrentPower(e){return e.cardManager.playerDeck.getCards().reduce((e,t)=>e+t.calculateEffectivePower(),0)}calculateRiskRewardScore(e,t){return t*(.5*e.power)-(1-t)*(.3*e.power)}calculateCardEfficiency(e,t){const a=e.calculateEffectivePower(),r=this.estimateCardCost(e);return a/Math.max(1,r)}estimateCardCost(e){return"insurance"===e.type?e.calculateEffectivePower()+1:1}}class V{constructor(){t(this,"strategies"),this.strategies=[new R,new $,new B]}getName(){return"ÈÅ©ÂøúÊà¶Áï•"}getType(){return"adaptive"}selectChallenge(e,t){const a=this.selectBestStrategy(t),r=a.selectChallenge(e,t);return{...r,reason:`ÁèæÂú®„ÅÆÁä∂Ê≥Å„ÇíÂàÜÊûê„Åó„ÄÅ${a.getName()}„ÇíÊé°Áî®: ${r.reason}`}}selectCards(e,t,a){const r=this.selectBestStrategy(a),s=r.selectCards(e,t,a);return{...s,reason:`${r.getName()}„Å´„Çà„ÇãÂà§Êñ≠: ${s.reason}`}}evaluateFitness(e){return Math.max(...this.strategies.map(t=>t.evaluateFitness(e)))}selectBestStrategy(e){return this.strategies.map(t=>({strategy:t,fitness:t.evaluateFitness(e)})).sort((e,t)=>t.fitness-e.fitness)[0].strategy}}class G{static createStrategy(e){const t=this.strategies.get(e);if(!t)throw new Error(`Unknown strategy type: ${e}`);return t()}static getAvailableTypes(){return Array.from(this.strategies.keys())}static getStrategyDescription(e){switch(e){case"conservative":return"„É™„Çπ„ÇØ„ÇíÈÅø„Åë„ÄÅÂÆâÂÖ®„Å™ÈÅ∏Êäû„ÇíÂÑ™ÂÖà„Åô„ÇãÊà¶Áï•„ÄÇÊ¥ªÂäõ„Åå‰Ωé„ÅÑÊôÇ„Å´ÈÅ©„Åó„Å¶„ÅÑ„Çã„ÄÇ";case"aggressive":return"È´ò„É™„Çπ„ÇØÈ´ò„É™„Çø„Éº„É≥„ÇíÁãô„ÅÜÊà¶Áï•„ÄÇÊ¥ªÂäõ„Å®ÊâãÊú≠„ÅåÂÖÖÂÆü„Åó„Å¶„ÅÑ„ÇãÊôÇ„Å´ÂäπÊûúÁöÑ„ÄÇ";case"balanced":return"„É™„Çπ„ÇØ„Å®„É™„Çø„Éº„É≥„ÅÆ„Éê„É©„É≥„Çπ„ÇíÈáçË¶ñ„Åô„Çã‰∏áËÉΩÊà¶Áï•„ÄÇÂÆâÂÆö„Åó„ÅüÂà§Êñ≠„ÇíË°å„ÅÜ„ÄÇ";case"adaptive":return"Áä∂Ê≥Å„Å´Âøú„Åò„Å¶ÊúÄÈÅ©„Å™Êà¶Áï•„ÇíËá™ÂãïÈÅ∏Êäû„Åô„ÇãÈ´òÂ∫¶„Å™Êà¶Áï•„ÄÇÁµåÈ®ìË±äÂØå„Å™„Éó„É¨„Ç§„É§„ÉºÂêë„Åë„ÄÇ";default:return"‰∏çÊòé„Å™Êà¶Áï•„Çø„Ç§„Éó„Åß„Åô„ÄÇ"}}}t(G,"strategies",new Map([["conservative",()=>new R],["aggressive",()=>new $],["balanced",()=>new B],["adaptive",()=>new V]]));class O{constructor(e="balanced"){t(this,"currentStrategy"),t(this,"statisticsEnabled",!0),t(this,"decisionHistory",[]),this.currentStrategy=G.createStrategy(e)}getCurrentStrategy(){return this.currentStrategy}setStrategy(e){this.currentStrategy=G.createStrategy(e)}autoSelectChallenge(e,t){const a=this.currentStrategy.selectChallenge(e,t);return this.statisticsEnabled&&(console.log(`AIÊà¶Áï• (${this.currentStrategy.getName()}): ${a.reason}`),console.log(`ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„É¨„É≥„Ç∏: ${a.challenge.name} (ÊàêÂäüÁ¢∫Áéá: ${(100*a.successProbability).toFixed(1)}%)`)),a}autoSelectCards(e,t,a){const r=this.currentStrategy.selectCards(e,t,a);return this.statisticsEnabled&&(console.log(`AIÊà¶Áï• (${this.currentStrategy.getName()}): ${r.reason}`),console.log(`ÈÅ∏Êäû„Åï„Çå„Åü„Ç´„Éº„Éâ: ${r.cards.map(e=>e.name).join(", ")} (ÊúüÂæÖ„Éë„ÉØ„Éº: ${r.expectedPower})`)),r}recordDecision(e,t,a,r){this.statisticsEnabled&&(this.decisionHistory.push({turn:e,strategy:this.currentStrategy.getName(),challengeChoice:t,cardChoice:a,result:r?"success":"failure"}),this.decisionHistory.length>100&&(this.decisionHistory=this.decisionHistory.slice(-100)))}getStatistics(){const e=this.decisionHistory.length;if(0===e)return{totalDecisions:0,successRate:0,strategyUsage:new Map};const t=this.decisionHistory.filter(e=>"success"===e.result).length,a=new Map;return this.decisionHistory.forEach(e=>{const t=a.get(e.strategy)||0;a.set(e.strategy,t+1)}),{totalDecisions:e,successRate:t/e,strategyUsage:a}}setStatisticsEnabled(e){this.statisticsEnabled=e}clearHistory(){this.decisionHistory=[]}}class L{constructor(){t(this,"listeners",new Map),t(this,"history",{events:[],maxEvents:50})}addEventListener(e,t){const a=this.listeners.get(e)||[];return a.push(t),this.listeners.set(e,a),()=>{const a=this.listeners.get(e)||[],r=a.indexOf(t);r>-1&&a.splice(r,1)}}notifyStateChange(e,t,a){const r={type:e,previousValue:t,newValue:a,timestamp:Date.now()};this.addToHistory(r),(this.listeners.get(e)||[]).forEach(e=>{try{e(r)}catch(t){console.error("GameStateManager: „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",t)}})}notifyPhaseChange(e,t){this.notifyStateChange("phase_change",e,t)}notifyStatusChange(e,t){this.notifyStateChange("status_change",e,t)}notifyStageChange(e,t){this.notifyStateChange("stage_change",e,t)}notifyTurnChange(e,t){this.notifyStateChange("turn_change",e,t)}getHistory(){return{...this.history}}getHistoryByType(e){return this.history.events.filter(t=>t.type===e)}clearHistory(){this.history.events=[]}addToHistory(e){this.history.events.push(e),this.history.events.length>this.history.maxEvents&&this.history.events.shift()}removeAllListeners(){this.listeners.clear()}removeListenersForType(e){this.listeners.delete(e)}}class F{async execute(e,t){try{const a=await this.validate(e,t);if(!a.success)return a;const r=await this.process(e,t);return await this.postProcess(e,r),r}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}async validate(e,t){return{success:!0}}async postProcess(e,t){}}class N extends F{async validate(e,t){return t<=0?{success:!1,error:"„Éâ„É≠„ÉºÊûöÊï∞„ÅØ1‰ª•‰∏ä„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô"}:t>10?{success:!1,error:"„Éâ„É≠„ÉºÊûöÊï∞„ÅØ10Êûö‰ª•‰∏ã„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô"}:{success:!0}}async process(e,t){const a=e.cardManager.drawCards(t),r=[{type:"card_draw",description:`${a.drawnCards.length}Êûö„ÅÆ„Ç´„Éº„Éâ„Çí„Éâ„É≠„Éº„Åó„Åæ„Åó„Åü`,cards:a.drawnCards}];if(a.troubleCards&&a.troubleCards.length>0)for(const i of a.troubleCards){const t=i.penalty||0;if(t>0)try{e.applyDamage(t),r.push({type:"vitality_change",description:`„Éà„É©„Éñ„É´„Äå${i.name}„ÄçÁô∫ÂãïÔºÅ ${t}„ÅÆ„ÉÄ„É°„Éº„Ç∏`,value:-t,cards:[i]})}catch(s){console.error("Failed to apply trouble penalty",s)}else r.push({type:"vitality_change",description:`„Éà„É©„Éñ„É´„Äå${i.name}„ÄçÁô∫ÂãïÔºÅ`,cards:[i]})}return{success:!0,data:a.drawnCards,effects:r}}}class H extends F{async validate(e,t){return"draw"!==e.phase?{success:!1,error:"„Éâ„É≠„Éº„Éï„Çß„Éº„Ç∫„Åß„ÅÆ„Åø„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô"}:"challenge"!==t.type?{success:!1,error:"„ÉÅ„É£„É¨„É≥„Ç∏„Ç´„Éº„Éâ‰ª•Â§ñ„ÅØÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„Çì"}:{success:!0}}async process(e,t){return e.startChallenge(t),{success:!0,effects:[{type:"stage_advance",description:`„ÉÅ„É£„É¨„É≥„Ç∏„Äå${t.name}„Äç„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü`}]}}}class U extends F{async validate(e,t){return"draw"!==e.phase?{success:!1,error:"„Éâ„É≠„Éº„Éï„Çß„Éº„Ç∫„Åß„ÅÆ„Åø„ÉÅ„É£„É¨„É≥„Ç∏ÈÅ∏Êäû„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô"}:{success:!0}}async process(e,t){return e.startChallengePhase(),{success:!0,effects:[{type:"stage_advance",description:"„ÉÅ„É£„É¨„É≥„Ç∏ÈÅ∏Êäû„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü"}]}}}class z extends F{async validate(e,t){return e.currentChallenge?0===e.selectedCards.length?{success:!1,error:"„Ç´„Éº„Éâ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"}:{success:!0}:{success:!1,error:"„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÉÅ„É£„É¨„É≥„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"}}async process(e,t){const a=e.resolveChallenge(),r=[];return a.success?r.push({type:"vitality_change",description:"„ÉÅ„É£„É¨„É≥„Ç∏„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü",value:a.vitalityChange}):r.push({type:"vitality_change",description:"„ÉÅ„É£„É¨„É≥„Ç∏„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",value:a.vitalityChange}),{success:!0,data:a,effects:r}}}class W extends F{async validate(e,t){return t.insuranceType?["term","whole_life"].includes(t.durationType)?{success:!0}:{success:!1,error:"ÁÑ°Âäπ„Å™‰øùÈô∫ÊúüÈñì„Çø„Ç§„Éó„Åß„Åô"}:{success:!1,error:"‰øùÈô∫Á®ÆÈ°û„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"}}async process(e,t){return{success:!0,data:e.selectInsuranceType(t.insuranceType,t.durationType),effects:[{type:"insurance_add",description:`${"term"===t.durationType?"ÂÆöÊúü":"ÁµÇË∫´"}${t.insuranceType}‰øùÈô∫„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`}]}}}class j extends F{async validate(e,t){return{success:!0}}async process(e,t){if(e.cardManager.buyInsurance(t),t.cost>0)try{e.applyDamage(t.cost)}catch(a){return{success:!1,error:"Cost payment failed"}}return{success:!0,effects:[{type:"insurance_add",description:`‰øùÈô∫„Äå${t.name}„Äç„ÇíË≥ºÂÖ•„Åó„Åæ„Åó„Åü`,cards:[t]}]}}}class q extends F{async validate(e,t){return{success:!0}}async process(e,t){return e.cardManager.removeCardFromGame(t),{success:!0,effects:[{type:"card_draw",description:`„Ç´„Éº„Éâ„Äå${t.name}„Äç„ÇíÈô§Â§ñ„Åó„Åæ„Åó„Åü`,cards:[t]}]}}}class X extends F{async validate(e,t){return"dream_selection"!==e.phase?{success:!1,error:"Â§¢ÈÅ∏Êäû„Éï„Çß„Éº„Ç∫„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì"}:{success:!0}}async process(e,t){try{return e.selectDream(t),{success:!0,effects:[{type:"stage_advance",description:`Â§¢„Äå${t.name}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`}]}}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}}class J{constructor(){t(this,"processors",new Map),this.registerProcessor("draw_cards",new N),this.registerProcessor("start_challenge",new H),this.registerProcessor("resolve_challenge",new z),this.registerProcessor("select_insurance",new W),this.registerProcessor("start_challenge_phase",new U),this.registerProcessor("buy_insurance",new j),this.registerProcessor("remove_card",new q),this.registerProcessor("select_dream",new X)}registerProcessor(e,t){this.processors.set(e,t)}async executeAction(e,t,a){console.log("[GameActionProcessor] executeAction called",e);const r=this.processors.get(e);if(!r)return console.error("[GameActionProcessor] Unknown action type:",e),{success:!1,error:`Êú™Áü•„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éó: ${e}`};const s=await r.execute(t,a);return console.log("[GameActionProcessor] execution result:",s),s}getAvailableActions(){return Array.from(this.processors.keys())}unregisterProcessor(e){return this.processors.delete(e)}}const Y=class e{constructor(t,a=e.DEFAULT_MAX_VITALITY){this.value=t,this.maxVitality=a,this.validate()}static create(t,a=e.DEFAULT_MAX_VITALITY){return new e(t,a)}validate(){if(!isFinite(this.value))throw new Error("Vitality value must be a finite number");if(!isFinite(this.maxVitality))throw new Error("Maximum vitality must be a finite number");if(this.maxVitality<=0)throw new Error("Maximum vitality must be positive");if(this.value<0)throw new Error("Vitality value cannot be negative");if(this.value>this.maxVitality)throw new Error(`Vitality value cannot exceed maximum (${this.maxVitality})`)}getValue(){return this.value}getMax(){return this.maxVitality}decrease(t){if("number"!=typeof t||!isFinite(t))throw new Error("Decrease amount must be a finite number");if(t<0)throw new Error("Decrease amount must be non-negative");return new e(Math.max(0,this.value-t),this.maxVitality)}increase(t){if("number"!=typeof t||!isFinite(t))throw new Error("Increase amount must be a finite number");if(t<0)throw new Error("Increase amount must be non-negative");return new e(Math.min(this.maxVitality,this.value+t),this.maxVitality)}getPercentage(){return Math.floor(this.value/this.maxVitality*100)}isDepleted(){return 0===this.value}isFull(){return this.value===this.maxVitality}withMaxVitality(t){if("number"!=typeof t||!isFinite(t))throw new Error("Maximum vitality must be a finite number");const a=Math.min(this.value,t);return new e(a,t)}equals(e){return this.value===e.value&&this.maxVitality===e.maxVitality}toString(){return`${this.value}/${this.maxVitality} (${this.getPercentage()}%)`}};t(Y,"DEFAULT_MAX_VITALITY",100);let Z=Y;const K=class e{constructor(e){t(this,"id"),t(this,"status"),t(this,"phase"),t(this,"stage"),t(this,"turn"),t(this,"_vitality"),t(this,"cardManager"),t(this,"premiumCalculationService"),t(this,"stageManager"),t(this,"expirationManager"),t(this,"challengeResolutionService"),t(this,"turnManager"),t(this,"challengeService"),t(this,"insuranceService"),t(this,"aiStrategyService"),t(this,"stateManager"),t(this,"actionProcessor"),t(this,"currentChallenge"),t(this,"stats"),t(this,"config"),t(this,"_riskProfile"),t(this,"_playerHistory"),t(this,"activeInsurances",[]),t(this,"expiredInsurances",[]),t(this,"_insuranceBurden"),t(this,"agingDeck"),t(this,"score",0),t(this,"insuranceMarket",[]),t(this,"selectedDream"),t(this,"insuranceTypeChoices"),t(this,"pendingInsuranceClaim"),t(this,"_learningHistory",new Map),t(this,"_aiEnabled",!1),t(this,"_currentAIStrategy","balanced"),t(this,"_dirtyFlags",{vitality:!1,insurance:!1,burden:!1,stats:!1,gameState:!1}),t(this,"challengeDifficultyModifier",0),t(this,"_cachedValues",{insuranceBurden:0,availableVitality:0,totalInsuranceCount:0,lastUpdateTime:0}),t(this,"startedAt"),t(this,"completedAt"),this.id=this.generateId(),this.status="not_started",this.phase="setup",this.stage="youth",this.turn=0;const r={difficulty:"normal",startingVitality:100,startingHandSize:5,maxHandSize:10,dreamCardCount:3,...e};this.config=r,this.config.balanceConfig&&I.setOverrides(this.config.balanceConfig);const s=r.characterId||"solid",i=_.find(e=>e.id===s)||_[0];if(!i)throw new Error("No available characters found");const c=(void 0!==r.startingVitality?r.startingVitality:100)+i.initialVitalityModifier,o=I.getStageParameters(this.stage);if(!o)throw new Error(`Invalid stage parameters for ${this.stage}`);const l=o.maxVitality+i.initialVitalityModifier,h=c>l&&c>200?c:Math.min(c,l),g=Math.max(h,l);this._vitality=Z.create(h,g),this.cardManager=new d,this.premiumCalculationService=new y,this.stageManager=new S,this.expirationManager=new M,this.challengeResolutionService=new x,this.turnManager=new D(this.stageManager,this.expirationManager),this.challengeService=new k(this.challengeResolutionService),this.insuranceService=new A(this.premiumCalculationService),this.aiStrategyService=new O(this._currentAIStrategy),this.stateManager=new L,this.actionProcessor=new J,this.config.balanceConfig?I.setOverrides(this.config.balanceConfig):I.clearOverrides(),this.setupStateListeners();const m=new a("Player Deck"),f=new a("Challenge Deck");u.createStarterLifeCards().forEach(e=>{m.addCard(e)});const C=m.getCards().filter(e=>"dream"===e.type||"challenge"===e.type&&e.isDream||"life"===e.type&&e.power>=30);C.length>0&&(console.warn("[Game] WARNING: Dream cards detected in initial player deck! Removing...",C.map(e=>e.name)),C.forEach(e=>m.removeCard(e.id))),u.createChallengeCards(this.stage).forEach(e=>{f.addCard(e)}),this.cardManager.initialize(m,f,this.config),this.stats={totalChallenges:0,successfulChallenges:0,failedChallenges:0,cardsAcquired:0,highestVitality:h,turnsPlayed:0},this._riskProfile=p.default(),this._playerHistory={turnsPlayed:0,totalDamageTaken:0,insuranceClaimCount:0,totalInsurancePurchased:0,riskyChoiceCount:0,totalChoiceCount:0},this.activeInsurances=[],this.expiredInsurances=[],this.insuranceMarket=[],this.agingDeck=new a("Aging Deck");const w=u.createAgingCards(20);this.cardManager.getState().agingDeck.addCards(w),this.cardManager.getState().agingDeck.shuffle(),this.score=0,this._insuranceBurden=n.create(0)}getLearningHistory(e){return this._learningHistory.get(e)||0}updateLearningHistory(e,t){this._learningHistory.set(e,t)}get vitality(){return this._vitality.getValue()}get maxVitality(){return this._vitality.getMax()}get insuranceBurden(){return this._insuranceBurden.getValue()}get challengesCompleted(){return this.stats.challengesCompleted||0}getVitality(){return this._vitality}getInsuranceBurden(){return this._insuranceBurden}applyDamage(e){if(null==e)throw new Error("Change amount must not be null or undefined");if("number"!=typeof e)throw new Error("Change amount must be a number");if(!isFinite(e))throw new Error("Change amount must be a finite number");this.updateVitality(-e)}heal(e){if("game_over"!==this.status){if(null==e)throw new Error("Change amount must not be null or undefined");if("number"!=typeof e)throw new Error("Change amount must be a number");if(!isFinite(e))throw new Error("Change amount must be a finite number");this.updateVitality(e)}else console.warn("[Game] Cannot heal: Game is over")}getRiskProfile(){return this._riskProfile}getPlayerHistory(){return{...this._playerHistory}}getAvailableVitality(){const e=Date.now();if(!this._dirtyFlags.vitality&&!this._dirtyFlags.burden&&e-this._cachedValues.lastUpdateTime<50)return this._cachedValues.availableVitality;const t=this.vitality-this.insuranceBurden;return this._cachedValues.availableVitality=t,this._cachedValues.lastUpdateTime=e,this._dirtyFlags.vitality=!1,this._dirtyFlags.burden=!1,t}getFreedomScore(){const e=this.insuranceBurden,t=.2*this.maxVitality;if(0===e)return 1;const a=1-e/t;return Math.max(0,Math.min(1,a))}isGameOver(){return"game_over"===this.status||this._vitality.isDepleted()||this.hasAgingCardGameOver()}hasAgingCardGameOver(){return this.hand.filter(e=>"aging"===e.type).length>=3}checkAgingCardGameOverCondition(){if(this.hasAgingCardGameOver()){console.log("[Game] Aging Card Game Over Condition Met!");const e=this.activeInsurances.find(e=>"on_aging_gameover"===e.insuranceTriggerType);return e?(console.log("[Game] Disability Insurance found! Triggering claim."),this.triggerInsuranceClaim(e,"on_aging_gameover"),!0):(console.log("[Game] No insurance found. Game Over."),this.changeStatus("game_over"),!0)}return!1}getAgingCardCount(){return this.hand.filter(e=>"aging"===e.type).length}addInsurance(e){this.insuranceService.addInsurance(this,e)}expireAllInsurances(){0!==this.activeInsurances.length&&(this.activeInsurances.forEach(e=>this.expiredInsurances.push(e)),this.activeInsurances=[],this.updateInsuranceBurden(),console.log("[Game] All insurances expired due to insufficient vitality"))}generateId(){return c.generateGameId()}start(){if("not_started"!==this.status)throw new Error("Game has already started");this.changeStatus("in_progress"),this.startedAt=new Date,this.changePhase("character_selection"),console.info("[Game Phase] Character Selection Started")}selectCharacter(e){if("character_selection"!==this.phase)throw new Error("Not in character selection phase");const t=_.find(t=>t.id===e);if(!t)throw new Error("Invalid character selection");this.config.characterId=e;const a=I.getStageParameters(this.stage),r=this.config.startingVitality+t.initialVitalityModifier,s=a.maxVitality+t.initialVitalityModifier,i=Math.max(r,s);this._vitality=Z.create(Math.min(r,i),i),console.log(`[Game] Character switched to ${t.name}. Vitality: ${this.vitality}/${this.maxVitality}`),this.startDreamSelectionPhase()}startDreamSelectionPhase(){const e=u.createDreamCards().sort(()=>Math.random()-.5).slice(0,3);this.cardManager.setCardChoices(e),this.changePhase("dream_selection"),console.info("[Game Phase] Dream Selection Started")}async selectDream(e){if("dream_selection"!==this.phase)throw new Error("Not in dream selection phase");const t=this.cardManager.getState().cardChoices;if(!t?.some(t=>t.id===e.id))throw new Error("Invalid dream selection");this.selectedDream=e,console.info(`[Game Event] Selected Dream: ${e.name}`),this.cardManager.clearCardChoices(),this.changePhase("draw"),this.changeTurn(1)}async drawCards(e){console.debug("[Game] drawCards called",e);const t=await this.actionProcessor.executeAction("draw_cards",this,e);if(console.debug("[Game] actionProcessor result:",t),!t.success)throw console.error("[Game] drawCards failed:",t.error),new Error(t.error||"„Ç´„Éº„Éâ„Éâ„É≠„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");return this.checkAgingCardGameOverCondition(),t.data||[]}startChallengePhase(){if("draw"!==this.phase)throw new Error(`Can only start challenge phase from draw phase. Current phase: ${this.phase}`);const e=[];let t=this.cardManager.drawChallengeCard();t||(this.refillChallengeDeck(),t=this.cardManager.drawChallengeCard()),t&&e.push(t);let a=this.cardManager.drawChallengeCard();if(a||(0===this.challengeDeck.getCards().length&&this.refillChallengeDeck(),a=this.cardManager.drawChallengeCard()),a&&e.push(a),0===e.length)throw new Error("No challenge cards available");const r=e.map(e=>this.challengeDifficultyModifier>0&&e.isChallengeCard()?(console.log(`[Game] Applying difficulty modifier +${this.challengeDifficultyModifier} to ${e.name}`),e.copy({power:e.power+this.challengeDifficultyModifier})):e);this.cardManager.setCardChoices(r),this.changePhase("challenge_choice"),console.debug(`[Game] Challenge choices set: ${r.map(e=>e.name).join(", ")}`)}startChallenge(e){if("challenge_choice"===this.phase){const t=this.cardManager.getState().cardChoices;if(!t||!t.some(t=>t.id===e.id))throw new Error("Selected card is not in current choices");t.forEach(t=>{t.id!==e.id&&(t.isDreamCard()&&(console.log(`[Game] Dream ignored: ${t.name}. Increasing difficulty.`),this.challengeDifficultyModifier+=2,console.log(`[Game] Difficulty modifier increased to ${this.challengeDifficultyModifier}`)),this.cardManager.addToDiscardPile(t))}),this.cardManager.clearCardChoices()}this.challengeService.startChallenge(this,e)}drawChallengeCard(){return this.cardManager.drawChallengeCard()}toggleCardSelection(e){return this.cardManager.toggleCardSelection(e)}resolveChallenge(){const e=this.challengeService.resolveChallenge(this);return e.success&&this.currentChallenge?.isDreamCard()&&(console.log("[Game] üéâ Dream achieved! Victory!"),this.changeStatus("victory")),e}recordChallengeResult(e){this.stats.totalChallenges++,e?(this.stats.successfulChallenges++,this.stats.challengesCompleted||(this.stats.challengesCompleted=0),this.stats.challengesCompleted++):(this.stats.failedChallenges++,this.stats.challengesFailed||(this.stats.challengesFailed=0),this.stats.challengesFailed++)}selectCard(e){if("card_selection"!==this.phase)throw new Error("Not in card selection phase");const t=this.cardManager.getCardChoiceById(e);if(!t)throw new Error("Invalid card selection");return this.cardManager.addToPlayerDeck(t),this.stats.cardsAcquired++,"insurance"===t.type&&(this.activeInsurances.push(t),this.updateInsuranceBurden()),this.cardManager.clearCardChoices(),this.changePhase("resolution"),!0}selectInsuranceType(e,t){return this.insuranceService.selectInsuranceType(this,e,t)}skipInsuranceSelection(){console.log("[Game] Skipping insurance selection - proceeding without insurance"),this.insuranceTypeChoices=void 0,this.changePhase("resolution")}triggerInsuranceClaim(e,t){console.log(`[Game] Insurance Triggered: ${e.name} (${t})`),this.pendingInsuranceClaim={insurance:e,triggerType:t}}async resolveInsuranceClaim(){if(!this.pendingInsuranceClaim)return;const{insurance:e,triggerType:t}=this.pendingInsuranceClaim;console.log(`[Game] Resolving Insurance Claim: ${e.name}`),this.removeInsurance(e),this.expiredInsurances=this.expiredInsurances||[],this.expiredInsurances.push(e),await this.applyInsuranceEffect(t),this.pendingInsuranceClaim=void 0}async applyInsuranceEffect(e){switch(e){case"on_aging_gameover":console.log("[Game] Applying Disability Insurance Effect: Reset Hand"),this.cardManager.discardHand(),await this.drawCards(this.config.startingHandSize);break;case"on_death":console.log("[Game] Applying Life Insurance Effect: Revive"),this.heal(10);break;case"on_heavy_damage":console.log("[Game] Applying Medical Insurance Effect: Damage Reduction"),this.applyDamage(1);break;case"on_demand":console.log("[Game] Applying Income Protection Effect: Skip Challenge"),this.currentChallenge=void 0,this.cardManager.clearSelection(),this.changePhase("resolution")}}declineInsuranceClaim(){console.log("[Game] Insurance Claim Declined");const e=this.pendingInsuranceClaim?.triggerType,t=this.pendingInsuranceClaim?.context;"on_heavy_damage"===e&&t?.damage&&(console.log("[Game] Applying original damage after decline"),this.applyDamage(t.damage)),this.pendingInsuranceClaim=void 0,"on_death"===e?this._vitality.isDepleted()&&(console.log("[Game] Life Insurance declined. Game Over confirmed."),this.changeStatus("game_over")):"on_aging_gameover"===e&&this.hasAgingCardGameOver()&&(console.log("[Game] Disability Insurance declined. Game Over confirmed."),this.changeStatus("game_over"))}removeInsurance(e){this.insuranceService.removeInsurance(this,e)}updateVitality(e){if("number"!=typeof e||!isFinite(e))throw new Error("Change amount must be a finite number");if(0===e)return;if(e<0&&Math.abs(e)>=10){const t=this.activeInsurances.find(e=>"on_heavy_damage"===e.insuranceTriggerType);if(t&&(this.triggerInsuranceClaim(t,"on_heavy_damage"),this.pendingInsuranceClaim))return void(this.pendingInsuranceClaim.context={damage:Math.abs(e)})}this._vitality=e>=0?this._vitality.increase(e):this._vitality.decrease(-e);const t=this.vitality;if((t<0||t>this.maxVitality)&&(console.warn(`Vitality invariant violation: ${t} not in [0, ${this.maxVitality}]`),t>this.maxVitality?this._vitality=this._vitality.withMaxVitality(this.maxVitality):t<0&&(this._vitality=Z.create(0,this.maxVitality))),this._dirtyFlags.vitality=!0,this._dirtyFlags.stats=!0,t>this.stats.highestVitality&&(this.stats.highestVitality=t),e<0&&(this._playerHistory.totalDamageTaken+=Math.abs(e)),this._vitality.isDepleted()){console.error("[DEBUG] Vitality Depleted!"),console.error(`[DEBUG] Active Insurances: ${this.activeInsurances.length}`),this.activeInsurances.forEach((e,t)=>console.error(`[DEBUG] Ins[${t}]: id=${e.id}, trigger=${e.insuranceTriggerType}`));const e=this.activeInsurances.find(e=>"on_death"===e.insuranceTriggerType);if(e)return console.error(`[DEBUG] FOUND Life Insurance: ${e.id}`),void this.triggerInsuranceClaim(e,"on_death");console.error("[DEBUG] NOT FOUND Life Insurance"),this.changeStatus("game_over")}}updateMaxVitalityForAge(){const e=I.getStageParameters(this.stage);if(!e)return void console.warn(`Unknown stage parameters for: ${this.stage}`);const t=e.maxVitality,a=this._vitality.getValue();a>t?(console.info(`[Stage] ${e.label}: Max Vitality adjusted to ${t}`),this._vitality=this._vitality.withMaxVitality(t)):this._vitality=Z.create(a,t),this._dirtyFlags.vitality=!0}nextTurn(){return this.updateScore(),this.turnManager.nextTurn(this)}advanceStage(){const e=this.stageManager.advanceStage(this.stage);e.isCompleted?this.changeStatus("victory"):e.newStage&&this.changeStage(e.newStage)}refillChallengeDeck(){const e=u.createChallengeCards(this.stage);this.cardManager.refillChallengeDeck(e),console.debug(`[Game] Challenge deck refilled for stage ${this.stage}: ${e.length} cards`)}get hand(){return this.cardManager.getState().hand}get availableOnDemandInsurances(){return this.activeInsurances.filter(e=>"on_demand"===e.insuranceTriggerType)}get discardPile(){return this.cardManager.getState().discardPile}get playerDeck(){return this.cardManager.getState().playerDeck}get challengeDeck(){return this.cardManager.getState().challengeDeck}get selectedCards(){return this.cardManager.getState().selectedCards}get cardChoices(){return this.cardManager.getState().cardChoices}get currentInsuranceTypeChoices(){return this.insuranceTypeChoices}isInProgress(){return"in_progress"===this.status}isCompleted(){return"game_over"===this.status||"victory"===this.status}getDreamRequiredPower(e){if(!e.dreamCategory)return e.power;if("youth"===this.stage)return e.power;const t=b[e.dreamCategory],a=e.power+t;return Math.max(1,a)}getExpiredInsurances(){return[...this.expiredInsurances]}clearExpiredInsurances(){this.expiredInsurances=[]}getExpiringsSoonInsurances(){return this.expirationManager.getExpiringSoonInsurances(this.activeInsurances)}getExpirationWarnings(){return this.expirationManager.getExpirationWarnings(this.activeInsurances)}setStage(e){this.changeStage(e)}getActiveInsurances(){return[...this.activeInsurances]}updateScore(){let e=0;this.activeInsurances.forEach(t=>{t.coverage&&(e+=Math.floor(t.coverage/10))}),this.score=this.vitality+e}getRecommendedInsuranceBudget(e="balanced"){return this.premiumCalculationService.calculateOptimalInsuranceBudget(this.vitality,this.stage,e)}calculateCardPremium(e){if("insurance"!==e.type)throw new Error("Card must be an insurance card");return this.premiumCalculationService.calculateComprehensivePremium(e,this.stage,this._riskProfile)}calculateInsuranceBurden(){const e=Date.now();if(!this._dirtyFlags.insurance&&e-this._cachedValues.lastUpdateTime<100&&this._cachedValues.totalInsuranceCount===this.activeInsurances.length)return this._cachedValues.insuranceBurden;const t=this.insuranceService.calculateInsuranceBurden(this);return this._cachedValues.insuranceBurden=t,this._cachedValues.totalInsuranceCount=this.activeInsurances.length,this._cachedValues.lastUpdateTime=e,this._dirtyFlags.insurance=!1,t}updateInsuranceBurden(){this.insuranceService.updateInsuranceBurden(this)}calculateTotalPower(e){return this.challengeService.calculateTotalPower(this,e)}addCardToHand(e){this.cardManager.addToHand(e)}addCardToDiscardPile(e){this.cardManager.addToDiscardPile(e)}addCardToPlayerDeck(e){this.cardManager.addToPlayerDeck(e)}clearHand(){const e=this.cardManager.getState();e.hand=[],this.cardManager.setState(e)}setHand(e){const t=this.cardManager.getState();t.hand=[...e],this.cardManager.setState(t)}setCardChoices(e){this.cardManager.setCardChoices(e)}setPhase(e){this.changePhase(e)}getSnapshot(){const t=this.cardManager.getState();let a=e.OBJECT_POOLS.gameStates.pop();return a||(a={}),Object.assign(a,{id:this.id,status:this.status,phase:this.phase,stage:this.stage,turn:this.turn,vitality:this.vitality,maxVitality:this.maxVitality,playerDeck:this.playerDeck,hand:[...this.hand],discardPile:[...this.discardPile],challengeDeck:this.challengeDeck,currentChallenge:this.currentChallenge,selectedCards:[...t.selectedCards],cardChoices:t.cardChoices?[...t.cardChoices]:void 0,insuranceTypeChoices:this.insuranceTypeChoices,activeInsurances:[...this.activeInsurances],expiredInsurances:[...this.expiredInsurances],insuranceBurden:this.insuranceBurden,stats:{...this.stats},config:{...this.config},startedAt:this.startedAt,completedAt:this.completedAt}),a}setupStateListeners(){this.stateManager.addEventListener("phase_change",e=>{console.info(`[Phase] ${e.previousValue} -> ${e.newValue}`),this.handlePhaseChange(e.previousValue,e.newValue)}),this.stateManager.addEventListener("stage_change",e=>{console.info(`[Stage] ${e.previousValue} -> ${e.newValue}`),this.updateMaxVitalityForAge()}),this.stateManager.addEventListener("turn_change",e=>{console.info(`[Turn] ${e.previousValue} -> ${e.newValue}`),this.stats.turnsPlayed=e.newValue}),this.stateManager.addEventListener("status_change",e=>{console.info(`[Status] ${e.previousValue} -> ${e.newValue}`),"game_over"!==e.newValue&&"victory"!==e.newValue||(this.completedAt=new Date)})}handlePhaseChange(e,t){}changePhase(e){const t=this.phase;this.phase=e,this.stateManager.notifyPhaseChange(t,e)}finishGame(e){this.changeStatus(e?"victory":"game_over")}changeStatus(e){const t=this.status;this.status=e,this.stateManager.notifyStatusChange(t,e)}changeStage(e){const t=this.stage;this.stage=e,this.stateManager.notifyStageChange(t,e)}changeTurn(e){const t=this.turn;this.turn=e,this.stateManager.notifyTurnChange(t,e)}getStateManager(){return this.stateManager}getActionProcessor(){return this.actionProcessor}static releaseSnapshot(t){e.OBJECT_POOLS.gameStates.length<10&&(Object.keys(t).forEach(e=>{delete t[e]}),e.OBJECT_POOLS.gameStates.push(t))}getPerformanceStats(){return{poolStats:{gameStates:e.OBJECT_POOLS.gameStates.length,cards:e.OBJECT_POOLS.cards.length,challengeResults:e.OBJECT_POOLS.challengeResults.length},cacheHitRate:this._cachedValues.lastUpdateTime>0?.85:0,dirtyFlags:{...this._dirtyFlags}}}setAIEnabled(e){this._aiEnabled=e,e?console.info(`[AI] System Enabled (Strategy: ${this._currentAIStrategy})`):console.info("[AI] System Disabled")}isAIEnabled(){return this._aiEnabled}setAIStrategy(e){this._currentAIStrategy=e,this.aiStrategyService.setStrategy(e),console.info(`[AI] Strategy Changed: ${e}`)}getCurrentAIStrategy(){return this._currentAIStrategy}getAIStatistics(){return this.aiStrategyService.getStatistics()}aiSelectChallenge(){if(!this._aiEnabled)throw new Error("AI is not enabled");const e=this.cardManager.getState().challengeDeck.getCards();if(0===e.length)return null;const t=this.aiStrategyService.autoSelectChallenge(e,this);return console.debug(`[AI] Auto-selected challenge: ${t.challenge.name} (Success Rate: ${(100*t.successProbability).toFixed(1)}%)`),console.debug(`[AI] Reason: ${t.reason}`),t.challenge}aiSelectCards(e){if(!this._aiEnabled)throw new Error("AI is not enabled");const t=this.cardManager.getState().playerDeck.getCards(),a=this.aiStrategyService.autoSelectCards(e,t,this);return console.debug(`[AI] Auto-selected cards: ${a.cards.map(e=>e.name).join(", ")}`),console.debug(`[AI] Reason: ${a.reason}`),console.debug(`[AI] Expected Power: ${a.expectedPower}`),a.cards}aiAutoPlay(){if(!this._aiEnabled)throw new Error("AI is not enabled");if("draw"!==this.phase)throw new Error("Auto play can only be used during draw phase");const e=this.aiSelectChallenge();if(!e)return console.warn("[AI] No challenges available"),null;this.challengeService.startChallenge(this,e);const t=this.aiSelectCards(e);t.forEach(e=>{this.cardManager.toggleCardSelection(e)});const a=this.challengeService.resolveChallenge(this),r=this.aiStrategyService.autoSelectChallenge([e],this),s=this.aiStrategyService.autoSelectCards(e,t,this);return this.aiStrategyService.recordDecision(this.turn,r,s,a.success),a}resetAISettings(){this._aiEnabled=!1,this._currentAIStrategy="balanced",this.aiStrategyService.setStrategy("balanced"),this.aiStrategyService.clearHistory(),console.info("[AI] Settings Reset")}};t(K,"OBJECT_POOLS",{cards:[],gameStates:[],challengeResults:[]});let Q=K;export{_ as A,Q as G,Z as V};
//# sourceMappingURL=game-logic-CwgPnIiMkXiN.js.map
