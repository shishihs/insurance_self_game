var B=Object.defineProperty;var O=(g,c,t)=>c in g?B(g,c,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[c]=t;var f=(g,c,t)=>O(g,typeof c!="symbol"?c+"":c,t);import{p as N}from"./phaser-core-DawqAqIN.js";import{G as d,E as v,g as A,D as E,K as k,T as R,a as M,I as z,S as _,M as U}from"./game-engine-BEWVGSCW.js";import{G as J,C as D,A as G}from"./game-logic-DYTtuDyT.js";class b extends N.Scene{constructor(){super(...arguments);f(this,"centerX");f(this,"centerY");f(this,"gameWidth");f(this,"gameHeight")}create(){this.gameWidth=this.cameras.main.width,this.gameHeight=this.cameras.main.height,this.centerX=this.gameWidth/2,this.centerY=this.gameHeight/2,this.initialize()}update(t,e){}fadeIn(t=500){this.cameras.main.fadeIn(t,0,0,0)}fadeOut(t=500,e){this.cameras.main.fadeOut(t,0,0,0),e&&this.cameras.main.once("camerafadeoutcomplete",e)}getTextStyle(t=24){return{fontFamily:"Noto Sans JP",fontSize:`${t}px`,color:"#333333"}}createButton(t,e,a,s,n){const i=this.add.text(t,e,a,n||this.getTextStyle()).setOrigin(.5).setInteractive({useHandCursor:!0}).setPadding(20,10).setBackgroundColor("#4C6EF5").setColor("#ffffff");return i.on("pointerover",()=>{i.setBackgroundColor("#364FC7"),i.setScale(1.05)}),i.on("pointerout",()=>{i.setBackgroundColor("#4C6EF5"),i.setScale(1)}),i.on("pointerdown",()=>{i.setScale(.95)}),i.on("pointerup",()=>{i.setScale(1.05),s()}),i}createContainerButton(t,e,a,s,n){const i=this.add.container(t,e),o=this.add.graphics();o.fillStyle(5009141,1),o.fillRoundedRect(-80,-20,160,40,8);const r=this.add.text(0,0,a,n||this.getTextStyle()).setOrigin(.5);return i.add([o,r]),i.setSize(160,40),i.setInteractive({useHandCursor:!0}),i.on("pointerover",()=>{o.clear(),o.fillStyle(3559367,1),o.fillRoundedRect(-80,-20,160,40,8),i.setScale(1.05)}),i.on("pointerout",()=>{o.clear(),o.fillStyle(5009141,1),o.fillRoundedRect(-80,-20,160,40,8),i.setScale(1)}),i.on("pointerdown",()=>{i.setScale(.95)}),i.on("pointerup",()=>{i.setScale(1.05),s()}),i}createCardContainer(t,e,a){const s=this.add.container(e,a),n=d.CARD_WIDTH,i=d.CARD_HEIGHT,o=this.add.graphics(),r=t.cardType==="insurance";if(r){o.fillStyle(8490232,.3),o.fillRoundedRect(-n/2-4,-i/2-4,n+8,i+8,14);const h=this.add.graphics();h.fillStyle(6514417,1),h.fillRoundedRect(-n/2,-i/2,n,i,12);const u=this.add.graphics();u.fillStyle(16777215,.15),u.fillRoundedRect(-n/2,-i/2,n,i/2,12);const C=this.add.graphics();C.lineStyle(1,16777215,.1);for(let I=0;I<5;I++)C.beginPath(),C.arc(-n/2+20+I*30,-i/2+20,15,0,Math.PI*2),C.strokePath();s.add([o,h,u,C])}else o.fillStyle(16777215,.95),o.fillRoundedRect(-n/2,-i/2,n,i,12),o.lineStyle(2,15067115,1),o.strokeRoundedRect(-n/2,-i/2,n,i,12),s.add(o);let l="🎯",p=6583435;switch(t.cardType){case"insurance":l="🛡️",p=6514417;break;case"lifeEvent":l=t.power>0?"✨":"⚡",p=t.power>0?1096065:16096779;break;case"chance":l="🎲",p=9133302;break;case"special":l="⭐",p=16096779;break}const m=this.add.graphics();m.fillStyle(p,r?.3:.15),m.fillCircle(-n/2+25,-i/2+25,20);const y=this.add.text(-n/2+25,-i/2+25,l,{fontFamily:"Arial",fontSize:"20px"}).setOrigin(.5),w=this.add.text(0,-i/2+30,t.name,{fontFamily:"Noto Sans JP",fontSize:"16px",fontStyle:"bold",color:r?"#FFFFFF":"#1F2937",align:"center",wordWrap:{width:n-20}}).setOrigin(.5,0),S=this.add.text(0,-10,t.description,{fontFamily:"Noto Sans JP",fontSize:"12px",color:r?"#E0E7FF":"#6B7280",align:"center",wordWrap:{width:n-30},lineSpacing:4}).setOrigin(.5);if(!r&&t.power!==0){const h=this.add.graphics(),u=t.power>0?1096065:15680580;h.fillStyle(u,1),h.fillCircle(n/2-25,i/2-25,18);const C=this.add.text(n/2-25,i/2-25,`${t.power>0?"+":""}${t.power}`,{fontFamily:"Arial",fontSize:"14px",fontStyle:"bold",color:"#FFFFFF"}).setOrigin(.5);s.add([h,C])}if(r){const h=t.insuranceType==="whole_life"?"終身保険":"定期保険",u=this.add.graphics();u.fillStyle(16777215,.2),u.fillRoundedRect(-50,i/2-35,100,20,10);const C=this.add.text(0,i/2-25,h,{fontFamily:"Noto Sans JP",fontSize:"11px",fontStyle:"bold",color:"#FFFFFF"}).setOrigin(.5);s.add([u,C])}return s.add([m,y,w,S]),s.setSize(n,i),s.setInteractive({useHandCursor:!0}),s.setData("card",t),s.setData("originalX",e),s.setData("originalY",a),s.on("pointerover",()=>{if(this.tweens.add({targets:s,scaleX:1.05,scaleY:1.05,duration:200,ease:"Power2"}),r){const h=this.add.graphics();h.lineStyle(4,8490232,.6),h.strokeRoundedRect(-n/2-2,-i/2-2,n+4,i+4,12),s.add(h),s.setData("glowEffect",h),this.tweens.add({targets:h,alpha:.3,duration:500,yoyo:!0,repeat:-1})}}),s.on("pointerout",()=>{this.tweens.add({targets:s,scaleX:1,scaleY:1,duration:200,ease:"Power2"});const h=s.getData("glowEffect");h&&(h.destroy(),s.setData("glowEffect",null))}),s}}class Y extends b{constructor(){super({key:"PreloadScene"})}preload(){const c=this.add.graphics(),t=this.add.graphics();t.fillStyle(2236962,.8),t.fillRect(240,270,320,50);const e=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-50,"Loading...",{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"}).setOrigin(.5),a=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-5,"0%",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"}).setOrigin(.5);this.load.on("progress",s=>{a.setText(`${Math.round(s*100)}%`),c.clear(),c.fillStyle(16777215,1),c.fillRect(250,280,300*s,30)}),this.load.on("complete",()=>{c.destroy(),t.destroy(),e.destroy(),a.destroy()}),this.loadAssets()}loadAssets(){this.createCardBack(),this.createCardFaces(),this.createUIAssets()}createCardBack(){const c=this.add.graphics();c.fillStyle(2899536,1),c.fillRoundedRect(0,0,120,180,8),c.lineStyle(2,3426654);for(let t=10;t<110;t+=20)for(let e=10;e<170;e+=20)c.strokeCircle(t,e,8);c.generateTexture("card-back",120,180),c.destroy()}createCardFaces(){this.createCardFace("life-card-template",5009141),this.createCardFace("insurance-card-template",5361510),this.createCardFace("pitfall-card-template",16739179)}createCardFace(c,t){const e=this.add.graphics();e.fillStyle(t,1),e.fillRoundedRect(0,0,120,180,8),e.fillStyle(16777215,1),e.fillRoundedRect(5,5,110,170,6),e.fillStyle(t,1),e.fillRect(5,5,110,30),e.generateTexture(c,120,180),e.destroy()}createUIAssets(){const c=this.add.graphics();c.fillStyle(5009141,1),c.fillRoundedRect(0,0,200,50,25),c.generateTexture("button-bg",200,50),c.destroy();const t=this.add.graphics();t.lineStyle(4,16766011,1),t.strokeRoundedRect(0,0,130,190,8),t.generateTexture("card-highlight",130,190),t.destroy()}initialize(){this.scene.start("MainMenuScene")}}class W extends b{constructor(){super({key:"MainMenuScene"})}initialize(){this.fadeIn(),this.add.text(this.centerX,100,"人生充実ゲーム",{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#333333",fontStyle:"bold"}).setOrigin(.5),this.add.text(this.centerX,160,"Life Fulfillment - 生命保険を「人生の味方」として描く",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#666666"}).setOrigin(.5),this.createMenuButtons(),this.add.text(10,this.gameHeight-30,"v0.0.1 - Phase 1 Development",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#999999"})}createMenuButtons(){this.createButton(this.centerX,300,"ゲームを始める",()=>this.startGame(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"}),this.createButton(this.centerX,380,"チュートリアル",()=>this.startTutorial(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"}),this.createButton(this.centerX,460,"設定",()=>this.openSettings(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"}),this.createButton(this.centerX,540,"クレジット",()=>this.showCredits(),{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff"})}startGame(){this.fadeOut(500,()=>{this.scene.start("GameScene")})}startTutorial(){this.fadeOut(500,()=>{this.scene.start("GameScene",{startTutorial:!0})})}openSettings(){this.showNotification("設定機能は開発中です","info")}showCredits(){const c=this.add.graphics();c.fillStyle(0,.8),c.fillRect(0,0,this.gameWidth,this.gameHeight);const t=this.add.container(this.centerX,this.centerY),e=this.add.text(0,-100,`人生充実ゲーム

開発: Claude Code & You

Phase 1 - プロトタイプ開発中

ご期待ください！`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5),a=this.createButton(0,100,"閉じる",()=>{t.destroy(),c.destroy()},{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"});t.add([e,a]),t.setAlpha(0),this.tweens.add({targets:t,alpha:1,duration:300})}}const x={setupPerformanceOptimizations(){this.frameSkipCounter=0,this.frameSkipThreshold=2,this.objectPools={effects:[],texts:[],graphics:[]},this.cameras.main.setRoundPixels(!0),this.game.renderer.setMaxTextures(16)},throttledUIUpdate(g){this.frameSkipCounter++,!(this.frameSkipCounter<this.frameSkipThreshold)&&(this.frameSkipCounter=0,this.dirtyFlags.vitality&&this.updateThrottleTimers.vitality<=0&&(this.updateVitalityBar(),this.updateThrottleTimers.vitality=100,this.dirtyFlags.vitality=!1),this.dirtyFlags.insurance&&this.updateThrottleTimers.insurance<=0&&(this.updateInsuranceList(),this.updateThrottleTimers.insurance=200,this.dirtyFlags.insurance=!1),this.dirtyFlags.burden&&this.updateThrottleTimers.burden<=0&&(this.updateBurdenIndicator(),this.updateThrottleTimers.burden=150,this.dirtyFlags.burden=!1),Object.keys(this.updateThrottleTimers).forEach(c=>{this.updateThrottleTimers[c]>0&&(this.updateThrottleTimers[c]-=g)}))},getFromPool(g){const c=this.objectPools[g];return c&&c.length>0?c.pop():null},returnToPool(g,c){const t=this.objectPools[g];t&&t.length<50?(c.setVisible(!1),c.setActive(!1),t.push(c)):c.destroy()},createOptimizedEffect(g,c,t){let e=this.getFromPool("effects");switch(e?(e.clear(),e.setVisible(!0),e.setActive(!0)):e=this.add.graphics(),e.setPosition(g,c),e.setAlpha(1),e.setScale(1),t){case"success":e.fillStyle(4906624,.6),e.fillCircle(0,0,20);break;case"failure":e.lineStyle(4,15680580,.8),e.beginPath(),e.moveTo(-15,-15),e.lineTo(15,15),e.moveTo(15,-15),e.lineTo(-15,15),e.strokePath();break}this.tweens.add({targets:e,alpha:0,scale:t==="success"?3:1,duration:500,ease:"Power2.out",onComplete:()=>{this.returnToPool("effects",e)}})},batchUpdateHandCards(){const g=[];this.handCards.forEach((c,t)=>{const e=this.centerX-(this.handCards.length-1)*60/2+t*60,a=this.cameras.main.height-120;g.push({card:c,x:e,y:a})}),g.length>0&&this.tweens.add({targets:g.map(c=>c.card),duration:300,ease:"Power2.out",onUpdate:c=>{const t=c.progress;g.forEach((e,a)=>{const s=c.targets[a];s&&(s.x=Phaser.Math.Linear(s.x,e.x,t),s.y=Phaser.Math.Linear(s.y,e.y,t))})}})},preloadOptimizedAssets(){this.load.atlas("game-atlas","assets/game-atlas.png","assets/game-atlas.json")},setupCameraCulling(){this.cameras.main.setBackgroundColor(1710618),this.cameras.main.useBounds=!0,this.children.list.forEach(g=>{g.setScrollFactor&&g.setScrollFactor(1)})},cleanupUnusedResources(){const g=this.textures.getTextureKeys(),c=new Set;this.children.list.forEach(t=>{var e;(e=t.texture)!=null&&e.key&&c.add(t.texture.key)}),g.forEach(t=>{if(!c.has(t)&&!["__DEFAULT","__MISSING","__WHITE"].includes(t))try{this.textures.remove(t)}catch(e){}})},minimizeDrawCalls(){const g=new Map;this.children.list.forEach(t=>{var e;if((e=t.texture)!=null&&e.key){const a=t.texture.key;g.has(a)||g.set(a,[]),g.get(a).push(t)}});let c=0;g.forEach(t=>{t.forEach(e=>{e.setDepth(c)}),c++})}};class Z extends b{constructor(){super({key:"GameScene"});f(this,"gameInstance");f(this,"handCards",[]);f(this,"selectedCards",new Set);f(this,"cardSelectionUI");f(this,"insuranceTypeSelectionUI");f(this,"selectedInsuranceType");f(this,"vitalityBarContainer");f(this,"vitalityBar");f(this,"vitalityBarMaxWidth",300);f(this,"insuranceListContainer");f(this,"burdenIndicatorContainer");f(this,"insuranceRenewalDialogUI");f(this,"dirtyFlags",{vitality:!1,insurance:!1,burden:!1,hand:!1,actionButtons:!1,challenge:!1,stage:!1,deck:!1});f(this,"updateThrottleTimers",{vitality:0,insurance:0,burden:0});f(this,"frameSkipCounter",0);f(this,"frameSkipThreshold",2);f(this,"objectPools",{effects:[],texts:[],graphics:[]});f(this,"dropZoneIntegration");f(this,"keyboardController");f(this,"soundManager");f(this,"eventCleanupManager",new v);f(this,"tutorialManager");f(this,"tutorialOverlay");f(this,"isTutorialMode",!1);f(this,"tutorialStepElements",new Map);f(this,"shouldStartTutorial",!1);f(this,"animationManager");this.animationManager=A()}init(t){this.shouldStartTutorial=t.startTutorial||!1}initialize(){x.setupPerformanceOptimizations.call(this),x.setupCameraCulling.call(this),this.events.once("shutdown",this.cleanup,this),this.events.once("destroy",this.cleanup,this),this.initializeGame(),this.createUI(),this.createCardAreas(),this.initializeTutorial(),this.startGame(),this.initializeKeyboardControls(),this.initializeSoundManager(),this.initializePerformanceManager(),this.shouldStartTutorial&&this.time.delayedCall(500,()=>{this.autoStartTutorial()})}initializeGame(){this.gameInstance=new J({difficulty:"normal",startingVitality:20,startingHandSize:5,maxHandSize:7,dreamCardCount:2});const t=D.createStarterLifeCards();this.gameInstance.playerDeck.addCards(t),this.gameInstance.playerDeck.shuffle();const e=D.createChallengeCards(this.gameInstance.stage);this.gameInstance.challengeDeck.addCards(e),this.gameInstance.challengeDeck.shuffle()}createUI(){this.add.rectangle(0,0,this.gameWidth,this.gameHeight,2042167).setOrigin(0,0),this.add.rectangle(0,0,this.gameWidth,80,4988309).setOrigin(0,0).setAlpha(.9);const e=this.add.text(20,40,this.getStageDisplayText(),{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#F9FAFB",fontStyle:"bold"});e.setOrigin(0,.5),e.setName("stage-text"),this.createLifeStageIndicator(),this.createVitalityBar();const a=this.getStageDisplayText(),s=this.add.text(this.centerX,40,`活力: ${this.gameInstance.vitality} / ${this.gameInstance.maxVitality} (${a})`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#F9FAFB",fontStyle:"bold"});s.setOrigin(.5),s.setShadow(2,2,"#000000",.5,!0,!0),s.setName("vitality-text");const n=this.add.text(this.gameWidth-20,40,`ターン: ${this.gameInstance.turn}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#E5E7EB"});n.setOrigin(1,.5),n.setName("turn-text"),this.createActionButtons(),this.createBurdenIndicator(),this.createInsuranceListDisplay()}createBurdenIndicator(){this.burdenIndicatorContainer=this.add.container(this.gameWidth-200,120),this.burdenIndicatorContainer.setName("burden-indicator");const t=this.add.rectangle(0,0,180,50,1120295,.8);t.setStrokeStyle(1,8490232,.5);const e=this.add.text(-80,0,"保険料負担:",{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#E5E7EB"}).setOrigin(0,.5),a=this.gameInstance.insuranceBurden,s=this.add.text(40,0,a===0?"負担なし":`${a}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:a===0?"#10B981":"#EF4444",fontStyle:"bold"}).setOrigin(.5);s.setShadow(1,1,"#000000",.3,!0,!0),s.setName("burden-value"),this.burdenIndicatorContainer.add([t,e,s])}createInsuranceListDisplay(){this.insuranceListContainer=this.add.container(this.gameWidth-150,250),this.insuranceListContainer.setName("insurance-list");const t=this.add.text(0,0,"有効な保険",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#F9FAFB",fontStyle:"bold"}).setOrigin(.5);t.setShadow(1,1,"#000000",.3,!0,!0),this.insuranceListContainer.add(t),this.updateInsuranceList()}createLifeStageIndicator(){const t=this.add.container(20,70);t.setName("life-stage-indicator");const e=["youth","middle","fulfillment"],a=["青年期","中年期","充実期"],s=[1096065,16096779,10980346],n=e.indexOf(this.gameInstance.stage);e.forEach((i,o)=>{const r=o<=n,l=o===n,p=this.add.circle(o*50,0,l?8:6,r?s[o]:4937059,r?1:.5),m=this.add.text(o*50,15,a[o],{fontFamily:"Noto Sans JP",fontSize:"10px",color:r?"#F9FAFB":"#6B7280",fontStyle:l?"bold":"normal"}).setOrigin(.5),y=o===0?35:o===1?30:27,w=this.add.text(o*50,25,`最大${y}`,{fontFamily:"Noto Sans JP",fontSize:"8px",color:r?"#9CA3AF":"#4B5563"}).setOrigin(.5);if(t.add([p,m,w]),l&&this.tweens.add({targets:p,scale:1.2,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),o<e.length-1){const S=this.add.rectangle(o*50+25,0,20,2,r&&o<n?s[o]:4937059,r&&o<n?1:.3);t.add(S)}})}updateLifeStageIndicator(){const t=this.children.getByName("life-stage-indicator");t&&(t.destroy(),this.createLifeStageIndicator())}createVitalityBar(){this.vitalityBarContainer=this.add.container(this.centerX,65),this.vitalityBarContainer.setName("vitality-bar-container");const t=this.add.rectangle(0,0,this.vitalityBarMaxWidth+4,24,1120295);t.setStrokeStyle(2,8490232),t.setAlpha(.8);const e=this.gameInstance.vitality/this.gameInstance.maxVitality,a=Math.max(0,this.vitalityBarMaxWidth*e);this.vitalityBar=this.add.rectangle(-this.vitalityBarMaxWidth/2,0,a,20,this.getVitalityBarColor(e)),this.vitalityBar.setOrigin(0,.5);const s=this.add.rectangle(-this.vitalityBarMaxWidth/2+this.vitalityBarMaxWidth,0,2,24,8490232);s.setOrigin(.5),this.vitalityBarContainer.add([t,this.vitalityBar,s])}getVitalityBarColor(t){return t>.6?1096065:t>.3?16096779:15680580}createCardAreas(){const t=this.add.container(d.DECK_X_POSITION,d.DECK_Y_POSITION),e=this.add.image(0,0,"card-back"),a=this.add.text(0,70,`${this.gameInstance.playerDeck.size()}`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#333333"});a.setOrigin(.5),a.setName("deck-count"),t.add([e,a]),t.setName("deck-area");const s=this.add.container(d.DISCARD_X_POSITION,d.DISCARD_Y_POSITION),n=this.add.rectangle(0,0,d.CARD_WIDTH,d.CARD_HEIGHT,13421772,.3);n.setStrokeStyle(2,10066329);const i=this.add.text(0,70,"捨て札",{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#666666"}).setOrigin(.5);s.add([n,i]),s.setName("discard-area");const o=this.add.container(this.centerX,d.CHALLENGE_Y_POSITION),r=this.add.rectangle(0,0,d.CARD_WIDTH,d.CARD_HEIGHT,16766011,.3);r.setStrokeStyle(2,16429061);const l=this.add.text(0,-100,"チャレンジ",{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#333333"}).setOrigin(.5);o.add([r,l]),o.setName("challenge-area"),this.initializeDropZones(),this.initializeNewDropZoneSystem()}initializeDropZones(){this.children.getByName("challenge-area"),this.children.getByName("discard-area")}initializeNewDropZoneSystem(){this.dropZoneIntegration=new E(this,this.gameInstance),this.data.events.on("cardSelected",t=>{this.toggleCardSelection(t)})}showDropZoneHighlights(t){this.dropZoneHighlights.forEach((e,a)=>{const s=this.isValidDropZone(a,t),n=s?d.COLORS.DROP_ZONE_VALID:d.COLORS.DROP_ZONE_INVALID,i=s?.3:.15;e.clear();const o=(d.CARD_WIDTH+40)/2;e.fillStyle(n,i),e.fillCircle(0,0,o),e.lineStyle(3,n,.8),e.strokeCircle(0,0,o),this.tweens.add({targets:e,alpha:i*1.5,scaleX:1.1,scaleY:1.1,duration:d.DRAG_DROP.GLOW_PULSE_DURATION/2,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}),this.tweens.add({targets:e,alpha:i,duration:200,ease:"Power2"})})}hideDropZoneHighlights(){this.dropZoneHighlights.forEach(t=>{this.tweens.killTweensOf(t),this.tweens.add({targets:t,alpha:0,scaleX:1,scaleY:1,duration:200,ease:"Power2",onComplete:()=>{t.clear()}})})}isValidDropZone(t,e){if(!e)return!0;switch(t){case"challenge":return this.gameInstance.currentChallenge!==null&&!this.gameInstance.currentChallenge.isCardPlaced;case"discard":return!0;default:return!1}}createActionButtons(){const t=this.add.container(this.gameWidth-150,150);t.setName("action-buttons");const e=this.createContainerButton(0,0,"カードを引く",()=>this.drawCards(1),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});e.setName("draw-button");const a=this.createContainerButton(0,60,"チャレンジ",()=>this.startChallenge(),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});a.setName("challenge-button");const s=this.createContainerButton(0,120,"ターン終了",()=>this.endTurn(),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});s.setName("end-turn-button"),t.add([e,a,s]),this.updateActionButtons()}initializeKeyboardControls(){this.keyboardController=new k(this),this.keyboardController.registerActionCallback("draw",()=>{this.gameInstance.phase==="draw"&&this.gameInstance.isInProgress()&&this.drawCards(1)}),this.keyboardController.registerActionCallback("challenge",()=>{this.gameInstance.phase==="draw"&&!this.gameInstance.currentChallenge&&this.gameInstance.isInProgress()&&this.startChallenge()}),this.keyboardController.registerActionCallback("endTurn",()=>{const t=this.gameInstance.phase;(t==="draw"||t==="resolution")&&this.gameInstance.isInProgress()&&this.endTurn()});for(let t=1;t<=7;t++)this.keyboardController.registerActionCallback(`card${t}`,()=>{if(t<=this.handCards.length){const e=this.handCards[t-1];e.getData("card")&&this.toggleCardSelection(e)}});this.keyboardController.registerActionCallback("cancel",()=>{this.clearCardSelection()}),this.time.delayedCall(100,()=>{this.registerFocusableElements()}),this.keyboardController.enable()}registerFocusableElements(){if(!this.keyboardController)return;const t=this.children.getByName("action-buttons");if(t){const e=t.getByName("draw-button"),a=t.getByName("challenge-button"),s=t.getByName("end-turn-button");e&&this.keyboardController.registerFocusableElement(e,()=>{this.gameInstance.phase==="draw"&&this.gameInstance.isInProgress()&&this.drawCards(1)}),a&&this.keyboardController.registerFocusableElement(a,()=>{this.gameInstance.phase==="draw"&&!this.gameInstance.currentChallenge&&this.gameInstance.isInProgress()&&this.startChallenge()}),s&&this.keyboardController.registerFocusableElement(s,()=>{const n=this.gameInstance.phase;(n==="draw"||n==="resolution")&&this.gameInstance.isInProgress()&&this.endTurn()})}this.registerHandCardsFocus()}registerHandCardsFocus(){this.keyboardController&&(this.handCards.forEach(t=>{this.keyboardController.unregisterFocusableElement(t)}),this.handCards.forEach(t=>{this.keyboardController.registerFocusableElement(t,()=>{t.getData("card")&&this.toggleCardSelection(t)})}))}startGame(){this.gameInstance.start(),this.drawCards(d.INITIAL_DRAW),this.time.delayedCall(100,()=>{this.updateActionButtons()}),this.updateGameStateForTutorial()}drawCards(t){this.gameInstance.drawCards(t).forEach((a,s)=>{this.time.delayedCall(s*100,()=>{var n;this.createHandCard(a),(n=this.soundManager)==null||n.play("cardDraw")})}),this.time.delayedCall(t*100+100,()=>{this.arrangeHand(),this.updateGameStateForTutorial()})}createHandCard(t){const e=this.add.container(d.DECK_X_POSITION,d.DECK_Y_POSITION),a=this.add.graphics(),s=this.getCardColor(t.type);a.fillGradientStyle(s.top,s.top,s.bottom,s.bottom,1),a.fillRoundedRect(-60,-80,120,160,12);const n=this.add.rectangle(0,0,116,156,16777215,.1);n.setStrokeStyle(1,16777215,.3);const i=new Phaser.Geom.Rectangle(-60,-80,120,160);e.setInteractive(i,Phaser.Geom.Rectangle.Contains),e.on("pointerdown",()=>{this.gameInstance.currentChallenge&&!e.getData("isDragging")&&this.toggleCardSelection(e)});const o=this.add.text(0,-60,t.name,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#F9FAFB",fontStyle:"bold",wordWrap:{width:100}}).setOrigin(.5);o.setShadow(1,1,"#000000",.5,!0,!0);const r=this.add.circle(-40,60,20,1120295,.8),l=this.add.text(-40,60,`${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#10B981",fontStyle:"bold"}).setOrigin(.5),p=this.add.circle(40,60,18,1120295,.8),m=this.add.text(40,60,`${t.cost}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#F59E0B",fontStyle:"bold"}).setOrigin(.5);let y=null;if(t.type==="insurance"&&t.ageBonus!==void 0&&t.ageBonus>0){const h=this.gameInstance.stage;let u=0;if(h==="middle"?u=.5:h==="fulfillment"&&(u=1),u>0){const C=this.add.circle(0,-60,12,6514417,.9),I=this.add.text(0,-60,`+${u}`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#FFFFFF",fontStyle:"bold"}).setOrigin(.5);y=this.add.container(0,0,[C,I]),y.setAlpha(.8),this.tweens.add({targets:y,alpha:1,scale:1.1,duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}let w=t.power;if(t.type==="insurance"&&t.ageBonus!==void 0){const h=this.gameInstance.stage;let u=1;h==="middle"?u=1.5:h==="fulfillment"&&(u=2),w=Math.floor(t.power*u)}if(w!==t.power){l.setText(`${w}`),l.setColor("#A78BFA");const h=this.add.text(-40,45,`(${t.power})`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#9CA3AF",fontStyle:"normal"}).setOrigin(.5),u=[a,n,o,r,l,h,p,m];y&&u.push(y),e.add(u)}else{const h=[a,n,o,r,l,p,m];y&&h.push(y),e.add(h)}e.setData("card",t),e.setData("selected",!1);const S=this.add.rectangle(0,0,130,170,8490232,0);S.setAlpha(0),e.add(S),e.sendToBack(S),e.setData("glow",S),this.setupCardInteraction(e),this.dropZoneIntegration&&this.dropZoneIntegration.setupCardDragAndDrop(e),this.handCards.push(e)}getCardTemplate(t){switch(t){case"life":return"life-card-template";case"insurance":return"insurance-card-template";case"pitfall":return"pitfall-card-template";default:return"life-card-template"}}getCardColor(t){switch(t){case"life":return{top:6717162,bottom:7752610};case"insurance":return{top:1096065,bottom:366185};case"pitfall":return{top:15680580,bottom:14427686};case"dream":return{top:16569165,bottom:16096779};default:return{top:7041664,bottom:4937059}}}setupCardInteraction(t){t.setData("originalX",t.x),t.setData("originalY",t.y),t.setData("isDragging",!1);const e=t.getData("glow");this.input.setDraggable(t),t.on("pointerover",()=>{!t.getData("selected")&&!t.getData("isDragging")&&(this.tweens.add({targets:t,scaleX:d.CARD_HOVER_SCALE,scaleY:d.CARD_HOVER_SCALE,duration:200,ease:"Power2"}),e&&this.tweens.add({targets:e,alpha:.3,duration:200,ease:"Power2"}))}),t.on("pointerout",()=>{!t.getData("selected")&&!t.getData("isDragging")&&(this.tweens.add({targets:t,scaleX:1,scaleY:1,duration:200,ease:"Power2"}),e&&this.tweens.add({targets:e,alpha:0,duration:200,ease:"Power2"}))}),t.on("pointerdown",a=>{a.rightButtonDown()||(t.setData("dragStartTime",this.time.now),t.setDepth(1e3))}),t.on("pointerup",()=>{const a=t.getData("dragStartTime");!t.getData("isDragging")&&a&&this.time.now-a<200&&this.toggleCardSelection(t),t.setData("isDragging",!1)}),t.on("dragstart",()=>{t.setData("isDragging",!0),this.isDragInProgress=!0,t.setScale(d.DRAG_DROP.DRAG_SCALE),t.setAlpha(d.DRAG_DROP.DRAG_ALPHA),t.getData("selected")&&this.toggleCardSelection(t)}),t.on("drag",(a,s,n)=>{const o=this.scale.orientation===Phaser.Scale.LANDSCAPE||this.scale.orientation===Phaser.Scale.PORTRAIT?-60:0;t.x=s,t.y=n+o}),t.on("dragend",()=>{t.setScale(1),t.setAlpha(1);const a=this.getDropZone(t.x,t.y);a&&this.isValidDropZone(a,t)?this.handleValidDrop(a,t):this.handleInvalidDrop(t),t.setDepth(0)})}toggleCardSelection(t){var s,n;if(!this.gameInstance.currentChallenge)return;const e=t.getData("card");if(t.getData("selected")){this.gameInstance.toggleCardSelection(e),this.selectedCards.delete(e.id),t.setData("selected",!1),t.setScale(1),(s=this.soundManager)==null||s.play("cardDeselect");const i=t.getByName("highlight");i&&i.destroy(),this.tweens.add({targets:t,scale:1,duration:200,ease:"Back.easeOut"})}else{this.gameInstance.toggleCardSelection(e),this.selectedCards.add(e.id),t.setData("selected",!0),(n=this.soundManager)==null||n.play("cardSelect"),this.tweens.add({targets:t,scale:1.1,duration:200,ease:"Back.easeOut"});const i=this.add.graphics();i.lineStyle(4,65280,1),i.strokeRoundedRect(-62,-82,124,164,12),i.setName("highlight"),t.addAt(i,0),this.tweens.add({targets:i,alpha:.5,duration:500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}this.gameInstance.currentChallenge&&this.updatePowerDisplay()}arrangeHand(){const e=(this.handCards.length-1)*(d.CARD_WIDTH+d.CARD_SPACING),a=this.centerX-e/2;this.handCards.forEach((s,n)=>{const i=a+n*(d.CARD_WIDTH+d.CARD_SPACING);s.setData("originalX",i),s.setData("originalY",d.HAND_Y_POSITION),this.tweens.add({targets:s,x:i,y:d.HAND_Y_POSITION,duration:d.CARD_MOVE_DURATION,ease:"Power2"})}),this.registerHandCardsFocus()}startChallenge(){var e;if(this.gameInstance.currentChallenge)return;const t=this.gameInstance.challengeDeck.drawCard();t&&(this.gameInstance.startChallenge(t),(e=this.soundManager)==null||e.play("challengeStart"),this.displayChallengeCard(t),this.updateChallengeUI(),this.updateActionButtons(),this.enableHandCardSelection())}enableHandCardSelection(){this.handCards.forEach(t=>{t.setData("challengeActive",!0),this.dropZoneIntegration?(this.input.setDraggable(t,!0),t.off("dragstart"),t.off("drag"),t.off("dragend"),this.dropZoneIntegration.setupCardDragAndDrop(t)):(this.input.setDraggable(t,!0),t.on("dragstart",a=>{t.setData("isDragging",!0),t.setDepth(1e3)}),t.on("drag",(a,s,n)=>{t.x=s,t.y=n}),t.on("dragend",a=>{t.setData("isDragging",!1),t.setDepth(10);const s=t.getData("originalX")||t.x,n=t.getData("originalY")||t.y;this.tweens.add({targets:t,x:s,y:n,duration:300,ease:"Back.easeOut"})}));const e=t.getData("glow");e&&e.setVisible(!0)})}endTurn(){if(this.gameInstance.isInProgress()&&(this.gameInstance.phase==="resolution"||this.gameInstance.phase==="draw")){const t=this.add.rectangle(this.centerX,this.centerY,this.gameWidth,this.gameHeight,0,0);t.setDepth(1999),this.tweens.add({targets:t,alpha:.5,duration:200,ease:"Power2",onComplete:()=>{this.checkStageProgress(),this.gameInstance.nextTurn(),this.dirtyFlags.vitality=!0,this.dirtyFlags.stage=!0,this.dirtyFlags.actionButtons=!0,this.updateUI(),this.updateGameStateForTutorial(),this.tweens.add({targets:t,alpha:0,duration:200,ease:"Power2",onComplete:()=>{t.destroy(),this.checkGameEnd()}})}})}}updateInsuranceList(){if(!this.insuranceListContainer)return;this.insuranceListContainer.list.filter((a,s)=>s>0).forEach(a=>a.destroy());const e=this.gameInstance.getActiveInsurances();if(e.length===0){const a=this.add.text(0,30,"なし",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#999999"}).setOrigin(.5);this.insuranceListContainer.add(a);return}if(e.forEach((a,s)=>{const n=30+s*35,i=this.add.container(0,n),o=a.durationType==="term"&&a.remainingTurns!==void 0&&a.remainingTurns<=2,r=o&&a.remainingTurns===2,l=o&&a.remainingTurns===1;let p=a.durationType==="whole_life"?16766720:12632256,m=p;r?(p=16753920,m=16753920):l&&(p=16729156,m=16729156);const y=this.add.rectangle(0,0,240,30,p,.2);if(y.setStrokeStyle(2,m),o){const I=l?300:500;this.tweens.add({targets:y,alpha:.3,duration:I,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),y.setFillStyle(p,.3)}let w=a.durationType==="whole_life"?16766720:12632256,S=a.durationType==="whole_life"?"#000000":"#ffffff";r?(w=16753920,S="#000000"):l&&(w=16729156,S="#ffffff");const h=this.add.rectangle(-100,0,40,20,w);h.setStrokeStyle(1,16777215);const u=this.add.text(-100,0,a.durationType==="whole_life"?"終身":"定期",{fontFamily:"Noto Sans JP",fontSize:"10px",color:S,fontStyle:"bold"}).setOrigin(.5),C=this.add.text(-50,0,a.name.length>8?`${a.name.substring(0,8)}...`:a.name,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#ffffff"}).setOrigin(0,.5);if(a.durationType==="whole_life"){const I=this.gameInstance.stage;let T=0;if(I==="middle"?T=.5:I==="fulfillment"&&(T=1),T>0){const F=this.add.text(50,0,`+${T}`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#4ade80",fontStyle:"bold"}).setOrigin(.5);i.add(F)}}if(a.durationType==="term"&&a.remainingTurns!==void 0){let I="#ffffff";a.remainingTurns===2?I="#FFA500":a.remainingTurns===1&&(I="#FF4444");const T=this.add.text(100,0,`残り${a.remainingTurns}T`,{fontFamily:"Noto Sans JP",fontSize:"12px",color:I,fontStyle:a.remainingTurns<=2?"bold":"normal"}).setOrigin(1,.5);if(a.remainingTurns<=2){const F=a.remainingTurns===1?"#FF4444":"#FFA500",P=this.add.text(115,0,a.remainingTurns===1?"🚨":"⚠",{fontFamily:"Noto Sans JP",fontSize:"14px",color:F}).setOrigin(.5);i.add(P)}i.add(T)}if(i.add([y,h,u,C]),this.insuranceListContainer.add(i),(s+1)%3===0&&s<e.length-1){const I=this.add.rectangle(0,n+20,200,2,16729156,.5);this.insuranceListContainer.add(I)}}),e.length>=3){const a=this.add.text(0,30+e.length*35+10,`⚠ ${Math.floor(e.length/3)}ポイント負担中`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ff4444",fontStyle:"bold"}).setOrigin(.5);this.insuranceListContainer.add(a)}}updateBurdenIndicator(){if(!this.burdenIndicatorContainer)return;const t=this.burdenIndicatorContainer.getByName("burden-value");if(!t)return;const e=this.gameInstance.insuranceBurden,a=parseInt(t.text==="負担なし"?"0":t.text);t.setText(e===0?"負担なし":`${e}`),t.setColor(e===0?"#00ff00":"#ff4444"),e<a&&this.tweens.add({targets:this.burdenIndicatorContainer,scaleX:1.2,scaleY:1.2,duration:200,yoyo:!0,ease:"Power2",onComplete:()=>{var n;const s=(n=this.burdenIndicatorContainer)==null?void 0:n.list[0];s&&(s.setFillStyle(16711680,.8),this.time.delayedCall(300,()=>{s.setFillStyle(0,.7)}))}})}updateUI(){this.dirtyFlags.vitality&&(this.updateVitalityDisplay(),this.dirtyFlags.vitality=!1),this.dirtyFlags.stage&&(this.updateStageDisplay(),this.dirtyFlags.stage=!1),this.dirtyFlags.deck&&(this.updateDeckDisplay(),this.dirtyFlags.deck=!1),this.dirtyFlags.insurance&&(this.updateInsuranceList(),this.dirtyFlags.insurance=!1),this.dirtyFlags.burden&&(this.updateBurdenIndicator(),this.dirtyFlags.burden=!1),this.dirtyFlags.hand&&(this.arrangeHand(),this.dirtyFlags.hand=!1),this.dirtyFlags.actionButtons&&(this.updateActionButtons(),this.dirtyFlags.actionButtons=!1),this.dirtyFlags.challenge&&(this.updateChallengeUI(),this.dirtyFlags.challenge=!1)}updateVitalityDisplay(){const t=this.time.now;if(t-this.updateThrottleTimers.vitality<100)return;this.updateThrottleTimers.vitality=t;const e=this.children.getByName("vitality-text");if(e){const a=this.getStageDisplayText();e.setText(`活力: ${this.gameInstance.vitality} / ${this.gameInstance.maxVitality} (${a})`)}this.updateVitalityBar()}updateStageDisplay(){const t=this.children.getByName("turn-text");t&&t.setText(`ターン: ${this.gameInstance.turn}`);const e=this.children.getByName("stage-text");e&&e.setText(this.getStageDisplayText())}updateDeckDisplay(){const t=this.children.getByName("deck-count");t&&t.setText(`${this.gameInstance.playerDeck.size()}`)}updateVitalityBar(){if(!this.vitalityBar||!this.vitalityBarContainer)return;const t=this.vitalityBar.getData("currentVitality")||this.gameInstance.vitality,e=this.gameInstance.vitality,a=e/this.gameInstance.maxVitality,s=Math.max(0,this.vitalityBarMaxWidth*a),n=this.getVitalityBarColor(a),i={value:t};if(this.tweens.add({targets:i,value:e,duration:800,ease:"Cubic.out",onUpdate:()=>{const o=this.children.getByName("vitality-text");if(o){const r=this.getStageDisplayText();o.setText(`活力: ${Math.floor(i.value)} / ${this.gameInstance.maxVitality} (${r})`)}}}),this.tweens.add({targets:this.vitalityBar,width:s,duration:800,ease:"Cubic.out",onUpdate:()=>{var l;const o=this.vitalityBar.width/this.vitalityBarMaxWidth,r=this.getVitalityBarColor(o);(l=this.vitalityBar)==null||l.setFillStyle(r)},onComplete:()=>{var o;(o=this.vitalityBar)==null||o.setFillStyle(n)}}),e<t&&this.tweens.add({targets:this.vitalityBarContainer,scaleX:1.05,scaleY:1.05,duration:150,ease:"Power2",yoyo:!0,repeat:1}),e>t){const o=this.add.rectangle(0,0,this.vitalityBarMaxWidth+20,30,1096065,.5);o.setAlpha(0),this.vitalityBarContainer.add(o),this.tweens.add({targets:o,alpha:.6,duration:200,ease:"Power2",yoyo:!0,repeat:1,onComplete:()=>o.destroy()})}this.vitalityBar.setData("currentVitality",e)}updatePowerDisplay(){const t=this.children.getByName("power-display");if(!t)return;const e=this.handCards.filter(r=>this.selectedCards.has(r.getData("card").id)).map(r=>r.getData("card")),a=this.gameInstance.calculateTotalPower(e);t.list.filter(r=>r instanceof Phaser.GameObjects.Text&&r.name!=="power-text"&&r.name!=="count-text").forEach(r=>r.destroy());const n=t.getByName("power-text"),i=t.getByName("count-text");n&&(n.setText(`合計パワー: ${a.total}`),n.setColor(a.total>0?"#00ff00":"#ff4444")),i&&i.setText(`選択カード: ${this.selectedCards.size}枚`);let o=40;if(a.base>0){const r=this.add.text(0,o,`基本: +${a.base}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffffff"}).setOrigin(.5);t.add(r),o+=20}if(a.insurance>0){const r=this.add.text(0,o,`保険: +${a.insurance}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#4ade80"}).setOrigin(.5);t.add(r),o+=20}if(a.burden<0){const r=this.add.text(0,o,`負担: ${a.burden}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ff4444",fontStyle:"bold"}).setOrigin(.5);t.add(r)}}getDropZone(t,e){const a=this.centerX,s=d.CHALLENGE_Y_POSITION;return Phaser.Math.Distance.Between(t,e,a,s)<100?"challenge":null}handleValidDrop(t,e){const a=this.dropZones.get(t);if(a)switch(this.tweens.add({targets:e,x:a.x,y:a.y,scaleX:d.DRAG_DROP.DROP_ZONE_SCALE,scaleY:d.DRAG_DROP.DROP_ZONE_SCALE,duration:d.DRAG_DROP.BOUNCE_DURATION/2,ease:"Back.out",onComplete:()=>{this.tweens.add({targets:e,scaleX:1,scaleY:1,duration:d.DRAG_DROP.BOUNCE_DURATION/2,ease:"Elastic.out"})}}),this.showDropSuccessEffect(a.x,a.y),t){case"challenge":this.handleCardDropToChallenge(e);break;case"discard":this.handleCardDropToDiscard(e);break;default:console.warn(`Unknown drop zone: ${t}`)}}handleInvalidDrop(t){const e=t.getData("originalX"),a=t.getData("originalY");this.tweens.add({targets:t,x:t.x+10,duration:d.DRAG_DROP.VIBRATION_DURATION/6,ease:"Power2",yoyo:!0,repeat:5,onComplete:()=>{this.tweens.add({targets:t,x:e,y:a,duration:d.CARD_MOVE_DURATION,ease:"Back.out"})}}),this.showDropFailureEffect(t.x,t.y)}showDropSuccessEffect(t,e){const a=this.add.graphics();a.setPosition(t,e),a.setDepth(1100),a.fillStyle(d.COLORS.DROP_ZONE_VALID,.8),a.fillCircle(0,0,20),this.tweens.add({targets:a,scaleX:3,scaleY:3,alpha:0,duration:500,ease:"Power2.out",onComplete:()=>{a.destroy()}});for(let s=0;s<6;s++){const n=this.add.graphics();n.setPosition(t,e),n.setDepth(1100),n.fillStyle(d.COLORS.DROP_ZONE_VALID,.6),n.fillCircle(0,0,5);const i=s/6*Math.PI*2,o=50;this.tweens.add({targets:n,x:t+Math.cos(i)*o,y:e+Math.sin(i)*o,alpha:0,duration:600,ease:"Power2.out",onComplete:()=>{n.destroy()}})}}showDropFailureEffect(t,e){const a=this.add.graphics();a.setPosition(t,e),a.setDepth(1100),a.lineStyle(4,d.COLORS.DROP_ZONE_INVALID,.8),a.beginPath(),a.moveTo(-15,-15),a.lineTo(15,15),a.moveTo(15,-15),a.lineTo(-15,15),a.strokePath(),this.tweens.add({targets:a,x:t+5,duration:100,ease:"Power2",yoyo:!0,repeat:3}),this.tweens.add({targets:a,alpha:0,duration:800,ease:"Power2.out",onComplete:()=>{a.destroy()}})}handleCardDropToDiscard(t){const e=t.getData("card");this.gameInstance.discardCard(e.id);const a=this.handCards.indexOf(t);a>-1&&(this.handCards.splice(a,1),t.destroy()),this.arrangeHand(),this.dirtyFlags.vitality=!0,this.dirtyFlags.insurance=!0,this.dirtyFlags.burden=!0,this.updateUI()}handleCardDropToChallenge(t){const e=t.getData("card");if(this.gameInstance.currentChallenge){this.tweens.add({targets:t,x:t.getData("originalX"),y:t.getData("originalY"),duration:d.CARD_MOVE_DURATION,ease:"Power2"});return}this.tweens.add({targets:t,x:this.centerX,y:d.CHALLENGE_Y_POSITION,duration:d.CARD_MOVE_DURATION,ease:"Power2",onComplete:()=>{const a=this.handCards.indexOf(t);a!==-1&&this.handCards.splice(a,1),this.gameInstance.startChallenge(e),this.arrangeHand(),this.showChallengeUI(e)}})}showChallengeUI(t){const e=this.add.container(this.centerX,d.CHALLENGE_Y_POSITION-150),a=this.add.rectangle(0,0,300,60,0,.8),s=this.add.text(0,0,`チャレンジ: ${t.name}
パワー: ${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",align:"center"}).setOrigin(.5);e.add([a,s]),e.setName("challenge-info"),e.setAlpha(0),this.tweens.add({targets:e,alpha:1,duration:300})}displayChallengeCard(t){const e=this.add.container(this.centerX,d.CHALLENGE_Y_POSITION),a=this.add.image(0,0,this.getCardTemplate("life"));a.setTint(16766011);const s=this.add.text(0,-60,t.name,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#333333",fontStyle:"bold",wordWrap:{width:100}}).setOrigin(.5),n=this.add.text(0,20,`${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"36px",color:"#FF0000",fontStyle:"bold"}).setOrigin(.5),i=this.add.text(0,60,t.description,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#666666",wordWrap:{width:100}}).setOrigin(.5);e.add([a,s,n,i]),e.setName("challenge-card"),e.setScale(0),this.tweens.add({targets:e,scale:1.2,duration:500,ease:"Back.easeOut"})}updateChallengeUI(){const t=this.children.getByName("resolve-challenge-button");t&&t.destroy();const e=this.add.container(this.gameWidth-150,300);e.setName("power-display");const a=this.add.rectangle(0,0,200,140,0,.8),s=this.calculateSelectedPower(),n=this.add.text(0,-50,`選択パワー: ${s}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00FF00"});n.setOrigin(.5),n.setName("power-text");const i=this.add.text(0,-20,`選択カード: ${this.selectedCards.size}枚`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffffff"});i.setOrigin(.5),i.setName("count-text"),e.add([a,n,i]),this.updatePowerDisplay(),this.createButton(this.gameWidth-150,400,"チャレンジに挑む",()=>this.resolveChallenge(),{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"}).setName("resolve-challenge-button")}calculateSelectedPower(){let t=0;return this.handCards.forEach(e=>{const a=e.getData("card");this.selectedCards.has(a.id)&&(t+=a.power)}),t}resolveChallenge(){var s,n;if(!this.gameInstance.currentChallenge)return;const t=this.gameInstance.resolveChallenge(),e=window.__gameState||{};e.lastChallengeResult=t,this.updateGameStateForTutorial(),t.success?(s=this.soundManager)==null||s.play("challengeSuccess"):(n=this.soundManager)==null||n.play("challengeFail"),this.showChallengeResult(t),t.success&&t.cardChoices?this.time.delayedCall(2e3,()=>{this.showInsuranceTypeSelection()}):this.time.delayedCall(2e3,()=>{this.cleanupChallengeUI(),this.updateActionButtons()}),this.handCards=this.handCards.filter(i=>{const o=i.getData("card");return this.selectedCards.has(o.id)?(i.destroy(),!1):!0}),this.selectedCards.clear();const a=this.children.getByName("challenge-card");a&&this.tweens.add({targets:a,scale:0,duration:300,onComplete:()=>a.destroy()}),this.clearHandSelection(),this.dirtyFlags.vitality=!0,this.dirtyFlags.insurance=!0,this.dirtyFlags.burden=!0,this.dirtyFlags.hand=!0,this.dirtyFlags.actionButtons=!0,this.updateUI()}showChallengeResult(t){const e=this.add.container(this.centerX,this.centerY),a=this.add.rectangle(0,0,500,300,0,.9),s=this.add.text(0,-100,t.success?"チャレンジ成功！":"チャレンジ失敗...",{fontFamily:"Noto Sans JP",fontSize:"28px",color:t.success?"#00FF00":"#FF0000",fontStyle:"bold"}).setOrigin(.5);let n=`チャレンジパワー: ${t.challengePower}

`;t.powerBreakdown?(n+=`あなたのパワー内訳:
`,t.powerBreakdown.base>0&&(n+=`  基本パワー: +${t.powerBreakdown.base}
`),t.powerBreakdown.insurance>0&&(n+=`  保険ボーナス: +${t.powerBreakdown.insurance}
`),t.powerBreakdown.burden<0&&(n+=`  保険料負担: ${t.powerBreakdown.burden}
`),n+=`  合計: ${t.powerBreakdown.total}

`):n+=`あなたのパワー: ${t.playerPower}

`,n+=`活力変化: ${t.vitalityChange>0?"+":""}${t.vitalityChange}`;const i=this.add.text(0,-20,n,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff",align:"center",lineSpacing:5}).setOrigin(.5);if(!t.success&&t.powerBreakdown&&t.powerBreakdown.burden<0&&t.powerBreakdown.base+t.powerBreakdown.insurance>=t.challengePower){const l=this.add.text(0,90,"⚠ 保険料負担により敗北しました",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ff9999",fontStyle:"bold"}).setOrigin(.5);e.add(l)}const o=this.createButton(0,120,"閉じる",()=>{this.tweens.add({targets:e,scale:0,duration:300,onComplete:()=>e.destroy()})},{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff"});e.add([a,s,i,o]),e.setScale(0),this.tweens.add({targets:e,scale:1,duration:500,ease:"Back.easeOut"})}getStageDisplayText(){const t=this.gameInstance.stage,e=G[t].label,a=this.getTurnsInCurrentStage(),s=d.STAGE_TURNS[t];return`${e} (${a}/${s})`}getTurnsInCurrentStage(){const t=this.gameInstance.turn;return this.gameInstance.stage==="youth"?t:this.gameInstance.stage==="middle"?t-d.STAGE_TURNS.youth:t-d.STAGE_TURNS.youth-d.STAGE_TURNS.middle}checkStageProgress(){const t=this.gameInstance.turn,e=this.gameInstance.stage;if(e==="youth"&&t>=d.STAGE_TURNS.youth){const a=this.gameInstance.maxVitality;this.gameInstance.advanceStage(),this.showStageTransition("中年期",a,this.gameInstance.maxVitality),this.updateChallengeDeck()}else if(e==="middle"&&t>=d.STAGE_TURNS.youth+d.STAGE_TURNS.middle){const a=this.gameInstance.maxVitality;this.gameInstance.advanceStage(),this.showStageTransition("充実期",a,this.gameInstance.maxVitality),this.updateChallengeDeck()}}updateChallengeDeck(){this.gameInstance.challengeDeck.clear();const t=D.createChallengeCards(this.gameInstance.stage);this.gameInstance.challengeDeck.addCards(t),this.gameInstance.challengeDeck.shuffle()}showStageTransition(t,e,a){const s=this.add.container(this.centerX,this.centerY);s.setDepth(2e3);const n=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.8),i=this.add.text(0,-80,`${t}へ突入！`,{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),o=i.canvas;o&&o.parentElement&&this.animationManager.animate(o.parentElement,"scaleIn",{duration:600,intensity:"high"});const r=this.add.text(0,-20,`体力が衰えました (最大値: ${e} → ${a})`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ff9999"}).setOrigin(.5),l=this.getInsuranceReviewRecommendation(t),p=this.add.text(0,40,l,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00ff00",align:"center"}).setOrigin(.5),m=this.createButton(0,100,"保険を見直す",()=>{this.showInsuranceReviewDialog(),s.destroy()},{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"}),y=this.createButton(0,150,"あとで見直す",()=>{this.tweens.add({targets:s,alpha:0,duration:500,onComplete:()=>s.destroy()})},{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#cccccc"});s.add([n,i,r,p,m,y]),s.setAlpha(0),this.tweens.add({targets:s,alpha:1,duration:500}),i.setScale(0),this.tweens.add({targets:i,scale:1,duration:800,delay:200,ease:"Back.easeOut"}),r.setAlpha(0),this.tweens.add({targets:r,alpha:1,duration:600,delay:500});for(let S=0;S<20;S++){const h=this.add.circle(Phaser.Math.Between(-200,200),Phaser.Math.Between(-150,150),Phaser.Math.Between(2,6),16766720,.8);s.add(h),this.tweens.add({targets:h,alpha:0,scale:1.5,duration:2e3,delay:Phaser.Math.Between(0,1e3),ease:"Power2"})}const w=this.children.getByName("stage-text");w&&w.setText(this.getStageDisplayText()),this.updateLifeStageIndicator(),this.animateMaxVitalityChange()}getInsuranceReviewRecommendation(t){return t==="中年期"?`📌 保険見直しの機会
定期保険から終身保険への変更を検討しましょう`:t==="充実期"?`📌 総合的な保険見直し
終身保険の価値が大幅に上昇します！`:""}showInsuranceReviewDialog(){this.showNotification("保険見直し機能は開発中です","info")}checkExpiringInsurances(){}showExpiringInsuranceWarning(t){const e=this.add.container(this.centerX,300);e.setDepth(2e3);const a=this.add.rectangle(0,0,400,120,16729156,.95);a.setStrokeStyle(3,16777215);const s=this.add.text(-170,0,"⚠",{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),n=this.add.text(20,-20,`${t.name}が
あと${t.remainingTurns}ターンで期限切れです！`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),i=this.add.text(20,20,"更新または終身保険への切り替えを検討しましょう",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffcccc"}).setOrigin(.5);e.add([a,s,n,i]),e.setScale(0),e.setAlpha(0),this.tweens.add({targets:e,scale:1.1,alpha:1,duration:300,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:e,scale:1,duration:800,yoyo:!0,repeat:2,ease:"Sine.easeInOut"}),this.time.delayedCall(5e3,()=>{this.tweens.add({targets:e,scale:.8,alpha:0,duration:500,ease:"Power2",onComplete:()=>e.destroy()})})}})}showInsuranceExpirationWarning(t){const e=t.remainingTurns,a=t.cardName;let s=16753920,n="⚠",i="";e===1?(s=16729156,n="🚨",i="緊急！"):e===2&&(s=16753920,n="⚠",i="警告：");const o=this.add.container(this.centerX,350);o.setDepth(2e3);const r=this.add.rectangle(0,0,450,130,s,.95);r.setStrokeStyle(3,16777215);const l=this.add.text(-190,0,n,{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),p=this.add.text(20,-25,`${i} ${a}が
残り${e}ターンで期限切れです`,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",fontStyle:"bold",align:"center"}).setOrigin(.5),m=this.add.text(20,25,"更新手続きまたは終身保険への切り替えをご検討ください",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffcccc"}).setOrigin(.5);o.add([r,l,p,m]),o.setScale(0),o.setAlpha(0);const y=e===1?200:300;this.tweens.add({targets:o,scale:1.1,alpha:1,duration:y,ease:"Back.easeOut",onComplete:()=>{const w=e===1?4:2;this.tweens.add({targets:o,scale:1,duration:e===1?400:600,yoyo:!0,repeat:w,ease:"Sine.easeInOut"});const S=e===1?7e3:5e3;this.time.delayedCall(S,()=>{this.tweens.add({targets:o,scale:.8,alpha:0,duration:500,ease:"Power2",onComplete:()=>o.destroy()})})}})}animateMaxVitalityChange(){if(!this.vitalityBarContainer)return;const t=this.vitalityBarContainer.list[2];t&&this.tweens.add({targets:t,alpha:.3,duration:300,yoyo:!0,repeat:3,ease:"Power2"}),this.tweens.add({targets:this.vitalityBarContainer,y:this.vitalityBarContainer.y-5,duration:100,yoyo:!0,repeat:2,ease:"Power2"}),this.dirtyFlags.vitality=!0,this.dirtyFlags.insurance=!0,this.dirtyFlags.burden=!0,this.updateUI()}checkGameEnd(){this.gameInstance.isCompleted()?this.gameInstance.status==="victory"?this.showGameEnd(!0):this.gameInstance.status==="game_over"&&this.showGameEnd(!1):this.gameInstance.stage==="fulfillment"&&this.gameInstance.vitality>=d.VICTORY_VITALITY&&(this.gameInstance.status="victory",this.showGameEnd(!0))}showInsuranceTypeSelection(){this.insuranceTypeSelectionUI&&this.insuranceTypeSelectionUI.destroy(),this.insuranceTypeSelectionUI=this.add.container(this.centerX,this.centerY),this.insuranceTypeSelectionUI.setDepth(2e3);const t=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.8);t.setOrigin(.5);const e=this.add.text(0,-200,"保険種別を選択してください",{fontFamily:"Noto Sans JP",fontSize:"36px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),a=this.getInsuranceRecommendation(),s=this.add.text(0,-140,a,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00ff00"}).setOrigin(.5);this.insuranceTypeSelectionUI.add([t,e,s]),this.createInsuranceTypeButton(-180,0,"終身保険",`一生涯の保障
高コスト・高効果`,16766720,"whole_life"),this.createInsuranceTypeButton(180,0,"定期保険",`10ターンの保障
低コスト・標準効果`,12632256,"term");const n=this.insuranceTypeSelectionUI.list.filter(i=>i instanceof Phaser.GameObjects.Container&&i!==t);n.forEach(i=>{i instanceof Phaser.GameObjects.Container&&(i.setScale(0),i.setAlpha(0))}),this.insuranceTypeSelectionUI.setAlpha(0),this.tweens.add({targets:this.insuranceTypeSelectionUI,alpha:1,duration:500,ease:"Power2",onComplete:()=>{n.forEach((i,o)=>{i instanceof Phaser.GameObjects.Container&&this.time.delayedCall(o*200,()=>{this.tweens.add({targets:i,scale:1,alpha:1,duration:500,ease:"Back.easeOut"})})})}})}createInsuranceTypeButton(t,e,a,s,n,i){if(!this.insuranceTypeSelectionUI)return;const o=this.add.container(t,e),r=this.add.rectangle(0,0,300,400,2899536);if(r.setStrokeStyle(4,n),r.setInteractive(),i==="whole_life"){const u=this.add.rectangle(0,0,310,410,n,.2);u.setAlpha(.5),o.addAt(u,0),this.tweens.add({targets:u,alpha:.2,scale:1.05,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}const l=this.add.rectangle(0,-150,280,60,n),p=this.add.text(0,-150,a,{fontFamily:"Noto Sans JP",fontSize:"28px",color:"#000000",fontStyle:"bold"}).setOrigin(.5),m=this.add.text(0,-50,s,{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5);(i==="whole_life"?["永続的な保障","パワー +2","コスト +2"]:["期間限定保障","標準パワー","標準コスト"]).forEach((u,C)=>{const I=this.add.text(0,50+C*30,`• ${u}`,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#cccccc"}).setOrigin(.5);o.add(I)});const w=this.add.rectangle(0,280,280,80,0,.5);w.setStrokeStyle(1,6710886);const S=this.add.text(0,280,this.getDetailedInsuranceRecommendation(i),{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#aaaaaa",align:"center",lineSpacing:5,wordWrap:{width:260}}).setOrigin(.5);o.add([w,S]);const h=this.createButton(0,160,"選択する",()=>this.onInsuranceTypeSelected(i),{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"});r.on("pointerover",()=>{o.setScale(1.05),r.setFillStyle(3426654),this.tweens.add({targets:o,y:e-10,duration:200,ease:"Power2"})}),r.on("pointerout",()=>{o.setScale(1),r.setFillStyle(2899536),this.tweens.add({targets:o,y:e,duration:200,ease:"Power2"})}),r.on("pointerdown",()=>{this.onInsuranceTypeSelected(i)}),o.add([r,l,p,m,h]),this.insuranceTypeSelectionUI.add(o)}getInsuranceRecommendation(){switch(this.gameInstance.stage){case"youth":return"💡 青年期は定期保険がおすすめ - コストを抑えて活力に投資";case"middle":return"💡 中年期は終身保険も検討 - 将来への備えを強化";case"fulfillment":return"💡 充実期は終身保険が有利 - 年齢ボーナスで効果最大化";default:return"保険種別を選んでください"}}getDetailedInsuranceRecommendation(t){const e=this.gameInstance.stage;if(t==="whole_life")switch(e){case"youth":return`終身保険は高コストですが、結婚や学資など
人生の基盤となる保障には適しています。
長期的な視点で選択しましょう。`;case"middle":return`中年期の終身保険は+0.5ボーナス付き。
残りの人生を考えると、今が終身保険への
切り替えを検討する良いタイミングです。`;case"fulfillment":return`充実期の終身保険は+1.0ボーナス！
年齢による価値上昇を最大限活用できます。
安定した老後の基盤作りに最適です。`;default:return"永続的な保障を提供します。"}else switch(e){case"youth":return`定期保険は低コストで効率的な選択です。
若い時期は変化も多いため、柔軟に
見直せる定期保険が有利です。`;case"middle":return`定期保険は期限があるため要注意。
10ターン後の更新時にはコストが上がります。
長期的な保障は終身への切り替えも検討を。`;case"fulfillment":return`充実期では終身保険のボーナスが大きいため、
定期保険の相対的価値は下がります。
一時的な保障のみに使用を推奨します。`;default:return"10ターンの期間限定保障です。"}}getAgeAdjustmentDisplay(t){if(!t.challengeCategory)return null;const e=this.gameInstance.stage;let a=0,s=16777215,n="";if(t.challengeCategory==="physical"?e==="middle"?(a=3,s=16751001,n="↑"):e==="fulfillment"&&(a=6,s=16729156,n="↑↑"):t.challengeCategory==="knowledge"&&(e==="middle"?(a=-2,s=10092441,n="↓"):e==="fulfillment"&&(a=-4,s=4521796,n="↓↓")),a===0)return null;const i=this.add.container(60,20),o=this.add.rectangle(0,0,40,25,s,.3);o.setStrokeStyle(1,s);const r=this.add.text(0,0,`${n}${Math.abs(a)}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:`#${s.toString(16).padStart(6,"0")}`,fontStyle:"bold"}).setOrigin(.5);return i.add([o,r]),i}addDifficultyTooltip(t,e){const a=t.list[0];if(!a)return;let s="";const n=this.gameInstance.stage;if(e.challengeCategory==="physical"?(s=`体力系チャレンジ
`,n==="middle"?s+=`中年期: 必要パワー+3
体力の衰えにより難易度上昇`:n==="fulfillment"?s+=`充実期: 必要パワー+6
大幅な体力低下により高難度`:s+=`青年期: 標準難易度
体力が充実している時期`):e.challengeCategory==="knowledge"?(s=`知識系チャレンジ
`,n==="middle"?s+=`中年期: 必要パワー-2
経験の蓄積により容易化`:n==="fulfillment"?s+=`充実期: 必要パワー-4
豊富な知識で大幅に容易化`:s+=`青年期: 標準難易度
経験はまだ浅い時期`):e.challengeCategory==="balanced"&&(s=`複合系チャレンジ
年齢による難易度変化なし
体力と知識のバランスが重要`),!s)return;const i=this.add.container(0,-120);i.setVisible(!1),i.setDepth(1e3);const o=this.add.rectangle(0,0,250,80,0,.9);o.setStrokeStyle(2,16777215);const r=this.add.text(0,0,s,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#ffffff",align:"center",lineSpacing:5}).setOrigin(.5);i.add([o,r]),t.add(i),a.setInteractive(),a.on("pointerover",()=>{i.setVisible(!0),this.tweens.add({targets:i,alpha:1,duration:200})}),a.on("pointerout",()=>{this.tweens.add({targets:i,alpha:0,duration:200,onComplete:()=>i.setVisible(!1)})})}onInsuranceTypeSelected(t){if(!this.insuranceTypeSelectionUI)return;this.selectedInsuranceType=t;const e=t==="whole_life"?"終身保険":"定期保険",a=this.add.text(0,250,`${e}を選択しました`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5);a.setAlpha(0),this.insuranceTypeSelectionUI.add(a),this.tweens.add({targets:a,alpha:1,scale:1.2,duration:300,yoyo:!0,ease:"Power2"}),this.time.delayedCall(1e3,()=>{this.hideInsuranceTypeSelection(()=>{const s=this.generateInsuranceCards(t);this.showCardSelection(s)})})}hideInsuranceTypeSelection(t){this.insuranceTypeSelectionUI&&this.tweens.add({targets:this.insuranceTypeSelectionUI,alpha:0,scale:.8,duration:500,ease:"Power2",onComplete:()=>{var e;(e=this.insuranceTypeSelectionUI)==null||e.destroy(),this.insuranceTypeSelectionUI=void 0,t&&t()}})}generateInsuranceCards(t){return[...D.createExtendedInsuranceCards(this.gameInstance.stage).filter(n=>n.durationType===t)].sort(()=>Math.random()-.5).slice(0,3)}showCardSelection(t){this.cardSelectionUI&&this.cardSelectionUI.destroy(),this.cardSelectionUI=this.add.container(this.centerX,this.centerY),this.cardSelectionUI.setDepth(2e3);const e=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.8);e.setOrigin(.5);const a=this.add.text(0,-200,"保険カードを選択してください",{fontFamily:"Noto Sans JP",fontSize:"32px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),s=this.add.text(0,-150,"1枚選んでデッキに追加されます",{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#cccccc"}).setOrigin(.5);this.cardSelectionUI.add([e,a,s]),t.forEach((n,i)=>{this.createSelectableCard(n,i)}),this.cardSelectionUI.setAlpha(0),this.tweens.add({targets:this.cardSelectionUI,alpha:1,duration:500,ease:"Power2"}),this.updateActionButtons()}createSelectableCard(t,e){if(!this.cardSelectionUI)return;const a=220,n=-2*a/2+e*a,i=this.add.container(n,0);i.setScale(1.2);const o=this.add.image(0,0,this.getCardTemplate(t.type));o.setInteractive();const r=this.add.text(0,-80,t.name,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff",fontStyle:"bold",wordWrap:{width:120}}).setOrigin(.5),l=this.add.text(0,-40,t.description,{fontFamily:"Noto Sans JP",fontSize:"12px",color:"#cccccc",wordWrap:{width:120},align:"center"}).setOrigin(.5),p=this.add.text(-40,50,`${t.power}`,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#333333",fontStyle:"bold"}).setOrigin(.5);let m;t.coverage&&(m=this.add.text(40,50,`保障:${t.coverage}`,{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#0066cc",fontStyle:"bold"}).setOrigin(.5));let y;if(t.durationType){const h=t.durationType==="whole_life"?"終身":"10ターン";y=this.add.text(0,80,h,{fontFamily:"Noto Sans JP",fontSize:"16px",color:t.durationType==="whole_life"?"#FFD700":"#C0C0C0",fontStyle:"bold"}).setOrigin(.5)}if(t.durationType==="whole_life"){const h=this.add.rectangle(0,0,d.CARD_WIDTH+10,d.CARD_HEIGHT+10,16766720,.3);h.setAlpha(.6),i.addAt(h,0),this.tweens.add({targets:h,alpha:.2,scale:1.1,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}else t.durationType==="term"&&o.setStrokeStyle(3,12632256);const w=this.createButton(0,120,"選択",()=>this.onCardSelected(t),{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});o.on("pointerover",()=>{i.setScale(1.3),this.tweens.add({targets:i,y:-20,duration:200,ease:"Power2"})}),o.on("pointerout",()=>{i.setScale(1.2),this.tweens.add({targets:i,y:0,duration:200,ease:"Power2"})}),o.on("pointerdown",()=>{this.onCardSelected(t)});const S=[o,r,l,p,w];m&&S.push(m),y&&S.push(y),i.add(S),this.cardSelectionUI.add(i)}onCardSelected(t){var i;if(!this.cardSelectionUI)return;const s=this.gameInstance.getActiveInsurances().length+1;s%3===0&&this.showInsuranceBurdenWarning(s);const n=this.cardSelectionUI.list.find(o=>o instanceof Phaser.GameObjects.Container&&o.list.some(r=>{var l;return r instanceof Phaser.GameObjects.Image&&((l=r.input)==null?void 0:l.enabled)}));n&&this.tweens.add({targets:n,scaleX:1.1,scaleY:1.1,duration:150,yoyo:!0,ease:"Power2"}),this.gameInstance.selectCard(t.id),(i=this.soundManager)==null||i.play("insuranceGet"),this.showCardAcquisitionAnimation(t,()=>{this.hideCardSelection()})}showInsuranceBurdenWarning(t){const e=Math.floor(t/3),a=this.add.container(this.centerX,200);a.setDepth(3500);const s=this.add.rectangle(0,0,450,150,16729156,.95);s.setStrokeStyle(3,16777215);const n=this.add.text(-180,0,"🚨",{fontFamily:"Noto Sans JP",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),i=this.add.text(20,-30,"保険料負担が発生します！",{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),o=this.add.text(20,10,`保険${t}枚目で負担が${e}ポイントに増加します`,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffcccc"}).setOrigin(.5),r=this.add.text(20,40,"本当に必要な保険か、もう一度考えましょう",{fontFamily:"Noto Sans JP",fontSize:"14px",color:"#ffffff"}).setOrigin(.5);a.add([s,n,i,o,r]),a.setScale(0),a.setAlpha(0),this.tweens.add({targets:a,scale:1.2,alpha:1,duration:300,ease:"Back.easeOut",onComplete:()=>{this.tweens.add({targets:a,angle:-5,duration:100,yoyo:!0,repeat:3,ease:"Sine.easeInOut",onComplete:()=>{this.time.delayedCall(3e3,()=>{this.tweens.add({targets:a,scale:.8,alpha:0,duration:500,ease:"Power2",onComplete:()=>a.destroy()})})}})}});const l=this.add.rectangle(this.centerX,this.centerY,this.gameWidth,this.gameHeight,16711680,.3);l.setDepth(3e3),this.tweens.add({targets:l,alpha:0,duration:200,onComplete:()=>l.destroy()})}showCardAcquisitionAnimation(t,e){const a=this.add.container(this.centerX,this.centerY);a.setDepth(3e3);const s=this.add.image(0,0,this.getCardTemplate(t.type));s.setScale(2);const n=this.add.text(0,-100,t.name,{fontFamily:"Noto Sans JP",fontSize:"24px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),i=this.add.text(0,120,"デッキに追加されました！",{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5);a.add([s,n,i]),this.tweens.add({targets:a,scale:1.1,duration:300,yoyo:!0,repeat:1,ease:"Power2",onComplete:()=>{this.tweens.add({targets:a,alpha:0,scale:.5,duration:800,ease:"Power2",onComplete:()=>{a.destroy(),e()}})}})}hideCardSelection(){this.cardSelectionUI&&this.tweens.add({targets:this.cardSelectionUI,alpha:0,scale:.8,duration:500,ease:"Power2",onComplete:()=>{var t;(t=this.cardSelectionUI)==null||t.destroy(),this.cardSelectionUI=void 0,this.cleanupChallengeUI(),this.dirtyFlags.vitality=!0,this.dirtyFlags.actionButtons=!0,this.updateUI()}})}updateGameStateForTutorial(){const t={hand:this.gameInstance.hand,selectedCards:[...this.gameInstance.selectedCards],phase:this.gameInstance.phase,turn:this.gameInstance.turn,vitality:this.gameInstance.vitality,maxVitality:this.gameInstance.maxVitality,insuranceCards:this.gameInstance.insuranceCards,config:this.gameInstance.config,lastChallengeResult:null};window.__gameState=t,this.data.set("gameState",t)}updateActionButtons(){const t=this.children.getByName("action-buttons");if(!t)return;const e=t.getByName("draw-button"),a=t.getByName("challenge-button"),s=t.getByName("end-turn-button"),n=this.gameInstance.phase,i=this.gameInstance.isInProgress();e&&this.setButtonEnabled(e,i&&n==="draw"),a&&this.setButtonEnabled(a,i&&n==="draw"&&!this.gameInstance.currentChallenge),s&&this.setButtonEnabled(s,i&&(n==="draw"||n==="resolution"))}createContainerButton(t,e,a,s,n){const i=this.add.container(t,e),o=this.add.rectangle(0,0,150,40,3447003);o.setInteractive({useHandCursor:!0});const r=this.add.text(0,0,a,n||{fontFamily:"Noto Sans JP",fontSize:"18px",color:"#ffffff"});return r.setOrigin(.5),i.add([o,r]),o.on("pointerdown",()=>{var l;(l=this.soundManager)==null||l.play("buttonClick"),s()}),o.on("pointerover",()=>{var l;o.setFillStyle(2719929),i.setScale(1.05),(l=this.soundManager)==null||l.play("buttonHover")}),o.on("pointerout",()=>{o.setFillStyle(3447003),i.setScale(1)}),i}setButtonEnabled(t,e){if(!(t!=null&&t.list)||t.list.length<2){console.warn("Invalid button structure");return}const a=t.list[0],s=t.list[1];if(!a||!s){console.warn("Button components not found");return}e?(a.setFillStyle(3447003),s.setColor("#ffffff"),a.setInteractive()):(a.setFillStyle(9807270),s.setColor("#cccccc"),a.disableInteractive())}cleanupChallengeUI(){const t=this.children.getByName("power-display");t&&t.destroy();const e=this.children.getByName("resolve-challenge-button");e&&e.destroy();const a=this.children.getByName("challenge-info");a&&a.destroy(),this.clearHandSelection()}clearHandSelection(){this.handCards.forEach(t=>{if(t.getData("selected")){t.setData("selected",!1),t.setScale(1);const e=t.getByName("highlight");e&&e.destroy()}}),this.selectedCards.clear()}showGameEnd(t){const e=document.getElementById("game-container");e&&(t?this.animationManager.playVictoryAnimation(e):this.animationManager.playDefeatAnimation(e)),this.time.delayedCall(1e3,()=>{const a=this.add.container(this.centerX,this.centerY),s=this.add.rectangle(0,0,this.gameWidth,this.gameHeight,0,.9),n=this.add.text(0,-100,t?"人生充実！":"ゲームオーバー",{fontFamily:"Noto Sans JP",fontSize:"48px",color:t?"#FFD43B":"#FF6B6B",fontStyle:"bold"}).setOrigin(.5),i=this.gameInstance.stats,o=this.add.text(0,0,`最終活力: ${this.gameInstance.vitality}
総ターン数: ${i.turnsPlayed}
チャレンジ成功数: ${i.successfulChallenges}/${i.totalChallenges}
最高活力: ${i.highestVitality}`,{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5),r=this.createButton(-100,100,"もう一度",()=>{this.scene.restart()},{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"}),l=this.createButton(100,100,"メニューへ",()=>{this.scene.start("MainMenuScene")},{fontFamily:"Noto Sans JP",fontSize:"20px",color:"#ffffff"});a.add([s,n,o,r,l]),a.setDepth(1e3),a.setAlpha(0),this.tweens.add({targets:a,alpha:1,duration:1e3})})}showNotification(t,e="info"){const a=this.add.container(this.centerX,200);a.setDepth(2500);const s={info:3447003,warning:15965202,success:3066993},n=this.add.rectangle(0,0,400,60,s[e],.9);n.setStrokeStyle(2,16777215);const i=this.add.text(0,0,t,{fontFamily:"Noto Sans JP",fontSize:"16px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);a.add([n,i]),a.setScale(0),a.setAlpha(0),this.tweens.add({targets:a,scale:1,alpha:1,duration:300,ease:"Back.easeOut",onComplete:()=>{this.time.delayedCall(3e3,()=>{this.tweens.add({targets:a,scale:.8,alpha:0,duration:300,ease:"Power2",onComplete:()=>a.destroy()})})}})}showInsuranceRenewalDialog(t){console.warn("showInsuranceRenewalDialog: 保険更新システムが削除されました")}createRenewalButton(t,e,a,s,n,i,o){if(!this.insuranceRenewalDialogUI)return;const r=this.add.container(t,e),l=this.add.rectangle(0,0,250,100,n);l.setStrokeStyle(3,o?16777215:6710886),o&&l.setInteractive();const p=this.add.text(0,-15,a,{fontFamily:"Noto Sans JP",fontSize:"20px",color:o?"#ffffff":"#666666",fontStyle:"bold"}).setOrigin(.5),m=this.add.text(0,15,s,{fontFamily:"Noto Sans JP",fontSize:"14px",color:o?"#ffffff":"#666666"}).setOrigin(.5);o&&(l.on("pointerover",()=>{r.setScale(1.05),l.setFillStyle(Phaser.Display.Color.ValueToColor(n).brighten(20).color)}),l.on("pointerout",()=>{r.setScale(1),l.setFillStyle(n)}),l.on("pointerdown",()=>{r.setScale(.95),this.time.delayedCall(100,()=>{r.setScale(1),i()})})),r.add([l,p,m]),this.insuranceRenewalDialogUI.add(r)}onRenewalSelected(t,e){this.insuranceRenewalDialogUI&&this.tweens.add({targets:this.insuranceRenewalDialogUI,alpha:0,scale:.8,duration:300,ease:"Power2",onComplete:()=>{var a;(a=this.insuranceRenewalDialogUI)==null||a.destroy(),this.insuranceRenewalDialogUI=void 0}});try{let a;e?a=this.gameInstance.renewInsurance(t.cardId):a=this.gameInstance.expireInsurance(t.cardId);const s=a.action==="renewed"?"success":"warning";this.showNotification(a.message,s),this.time.delayedCall(500,()=>{this.updateInsuranceDisplay(),this.updateVitalityDisplay(),this.checkForAdditionalRenewals()})}catch(a){console.error("Insurance renewal error:",a),this.showNotification("保険処理でエラーが発生しました","error")}}getAgeIncreaseReason(){switch(this.gameInstance.stage){case"youth":return"青年期のため基本コストで更新可能";case"middle":return"中年期のため更新コストが増加 (+2)";case"fulfillment":return"充実期のため更新コストが大幅増加 (+4)";default:return"年齢に応じてコストが調整されます"}}checkForAdditionalRenewals(){}initializeTutorial(){try{this.tutorialManager=new R(this,{debugMode:!1,autoSaveProgress:!0,stepChangeDelay:500,defaultHighlightOptions:{color:"#FFD700",opacity:.4,borderWidth:3,borderColor:"#FFA500",glowEffect:!0,animationType:"pulse",duration:1200}}),this.tutorialOverlay=new M(this),this.tutorialOverlay.setVisible(!1),this.registerTutorialElements(),this.setupTutorialEventListeners()}catch(t){console.error("Tutorial initialization failed:",t)}}registerTutorialElements(){this.handCards.length>0&&this.tutorialStepElements.set("hand-area",this.handCards[0].parentContainer||this.handCards[0]),this.vitalityBarContainer&&this.tutorialStepElements.set("vitality-bar",this.vitalityBarContainer),this.insuranceListContainer&&this.tutorialStepElements.set("insurance-list",this.insuranceListContainer),this.burdenIndicatorContainer&&this.tutorialStepElements.set("burden-indicator",this.burdenIndicatorContainer)}setupTutorialEventListeners(){this.tutorialManager&&(this.tutorialManager.on("tutorial:started",t=>{var e;this.isTutorialMode=!0,(e=this.tutorialOverlay)==null||e.setVisible(!0)}),this.tutorialManager.on("tutorial:step:enter",t=>{this.handleTutorialStepEnter(t)}),this.tutorialManager.on("tutorial:step:exit",()=>{var t;(t=this.tutorialOverlay)==null||t.clearHighlights()}),this.tutorialManager.on("tutorial:completed",()=>{this.endTutorialMode()}),this.tutorialManager.on("tutorial:skipped",()=>{this.endTutorialMode()}),this.tutorialManager.on("tutorial:error",t=>{console.error("Tutorial error:",t.error),this.endTutorialMode()}),this.scale.on("resize",()=>{var t;(t=this.tutorialOverlay)==null||t.onResize()}))}handleTutorialStepEnter(t){var r;if(!this.tutorialOverlay||!this.tutorialManager)return;const e=this.tutorialManager.getCurrentStep();if(!e)return;const a=this.tutorialManager.getProgress();if(!a)return;const s=this.tutorialManager.getCurrentStep()&&((r=this.tutorialManager.currentConfig)==null?void 0:r.steps.length)||0;this.tutorialOverlay.createProgressBar(a,s);let n;if(e.targetElement){const l=this.tutorialStepElements.get(e.targetElement)||this.children.getByName(e.targetElement);l!=null&&l.getBounds&&(n=l.getBounds(),this.tutorialOverlay.createSpotlight(l),this.tutorialOverlay.highlightElement(e.targetElement,e.highlightOptions))}this.tutorialOverlay.createSpeechBubble(e,n);const i=a.currentStepIndex>0;this.tutorialOverlay.createControlButtons(i,!0,()=>{var l;return(l=this.tutorialManager)==null?void 0:l.nextStep()},i?()=>{var l;return(l=this.tutorialManager)==null?void 0:l.previousStep()}:void 0,()=>{var l;return(l=this.tutorialManager)==null?void 0:l.skipTutorial()}),this.tutorialOverlay.enableKeyboardControls(()=>{var l;return(l=this.tutorialManager)==null?void 0:l.nextStep()},i?()=>{var l;return(l=this.tutorialManager)==null?void 0:l.previousStep()}:void 0,()=>{var l;return(l=this.tutorialManager)==null?void 0:l.skipTutorial()}),e.action==="wait"&&e.waitTime&&this.time.delayedCall(e.waitTime,()=>{var l;(l=this.tutorialManager)==null||l.nextStep()})}endTutorialMode(){this.isTutorialMode=!1,this.tutorialOverlay&&(this.tutorialOverlay.setVisible(!1),this.tutorialOverlay.clearHighlights()),this.enableAllGameUI()}autoStartTutorial(){this.startTutorial(z).then(()=>{}).catch(t=>{console.error("Failed to start tutorial:",t)})}startTutorial(t){return this.tutorialManager?this.tutorialManager.isCompleted(t.id)?Promise.resolve():(this.applyTutorialModeRestrictions(),this.tutorialManager.startTutorial(t)):Promise.reject(new Error("Tutorial manager not initialized"))}applyTutorialModeRestrictions(){this.isDragInProgress=!1,this.disableNonTutorialUI()}disableNonTutorialUI(){}enableAllGameUI(){}registerTutorialElement(t,e){this.tutorialStepElements.set(t,e)}isTutorialActive(){return this.isTutorialMode}getCurrentTutorialStep(){var t;return((t=this.tutorialManager)==null?void 0:t.getCurrentStep())||null}stopTutorial(){this.tutorialManager&&this.tutorialManager.skipTutorial()}destroy(){this.dropZoneIntegration&&(this.dropZoneIntegration.destroy(),this.dropZoneIntegration=void 0),this.keyboardController&&(this.keyboardController.destroy(),this.keyboardController=void 0),this.data.events.off("cardSelected"),super.destroy()}updateGameState(t){this.gameInstance=t,this.updateVitalityDisplay(t.vitality,t.getMaxVitality()),this.updateProgressDisplay(t.stage,t.turn)}displayHandCards(t){this.clearHandDisplay(),t.forEach((e,a)=>{this.createHandCard(e,a)})}displayCurrentChallenge(t){this.updateChallengeDisplay(t)}updateInsuranceDisplay(t){this.updateInsuranceList(t)}updateInsuranceBurdenDisplay(t){this.updateBurdenIndicator(t)}updateProgressDisplay(t,e){this.stageText&&this.stageText.setText(`${t} - ターン ${e}`)}showCardSelectionUI(t,e,a,s,n){this.createCardSelectionInterface(t,e,a,s,n)}showChallengeActionUI(t,e){this.createChallengeActionInterface(t,e)}showInsuranceSelectionUI(t,e,a){this.createInsuranceSelectionInterface(t,e,a)}showConfirmationUI(t,e,a){this.createConfirmationDialog(t,e,a)}displayChallengeResult(t){this.showChallengeResultScreen(t)}showMessage(t,e="info"){const a=e==="success"?"#4CAF50":e==="warning"?"#FF9800":"#2196F3";this.createTemporaryMessage(t,a)}showError(t){this.createTemporaryMessage(t,"#F44336")}showGameOverScreen(t){this.createGameOverScreen(t)}showVictoryScreen(t){this.createVictoryScreen(t)}showStageClearScreen(t,e){this.createStageClearScreen(t,e)}clearDisplay(){this.clearAllUI()}createCardSelectionInterface(t,e,a,s,n){n(t.slice(0,Math.min(a,t.length)))}createChallengeActionInterface(t,e){e("start")}createInsuranceSelectionInterface(t,e,a){t.length>0&&a(t[0])}createConfirmationDialog(t,e,a){a(e)}showChallengeResultScreen(t){console.log("Challenge result:",t)}createTemporaryMessage(t,e){const a=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-100,t,{fontSize:"24px",color:e,stroke:"#000000",strokeThickness:2});a.setOrigin(.5),a.setDepth(1e3),this.time.delayedCall(3e3,()=>{a.destroy()})}createGameOverScreen(t){console.log("Game Over:",t)}createVictoryScreen(t){console.log("Victory:",t)}createStageClearScreen(t,e){console.log("Stage Clear:",t,e)}clearAllUI(){this.clearHandDisplay(),this.clearSelectionUI()}clearHandDisplay(){this.keyboardController&&this.handCards.forEach(t=>{this.keyboardController.unregisterFocusableElement(t)}),this.handCards.forEach(t=>t.destroy()),this.handCards=[]}clearSelectionUI(){this.cardSelectionUI&&(this.cardSelectionUI.destroy(),this.cardSelectionUI=void 0),this.insuranceTypeSelectionUI&&(this.insuranceTypeSelectionUI.destroy(),this.insuranceTypeSelectionUI=void 0)}initializeSoundManager(){var t;this.soundManager=new _(this),(t=this.input.keyboard)==null||t.on("keydown-M",()=>{if(this.soundManager){const e=!this.soundManager.isEnabled();this.soundManager.setEnabled(e),this.soundManager.saveSettings(),this.showMessage(e?"サウンド ON":"サウンド OFF","info")}})}initializePerformanceManager(){this.registry.get("isMobile")&&(this.performanceManager=new U(this,{minFPS:30,maxMemoryUsage:75,maxRenderTime:33.33,maxDrawCalls:80}),this.events.on("optimizationLevelChanged",e=>{this.handleOptimizationLevelChange(e)}))}handleOptimizationLevelChange(t){switch(t){case"low":this.frameSkipThreshold=3,this.tweens.timeScale=.8;break;case"medium":this.frameSkipThreshold=2,this.tweens.timeScale=1;break;case"high":this.frameSkipThreshold=1,this.tweens.timeScale=1;break}}createButton(t,e,a,s,n){const i=super.createButton(t,e,a,s,n);return i.removeAllListeners(),i.on("pointerover",()=>{var o;i.setBackgroundColor("#364FC7"),i.setScale(1.05),(o=this.soundManager)==null||o.play("buttonHover")}),i.on("pointerout",()=>{i.setBackgroundColor("#4C6EF5"),i.setScale(1)}),i.on("pointerdown",()=>{var o;i.setScale(.95),(o=this.soundManager)==null||o.play("buttonClick")}),i.on("pointerup",()=>{i.setScale(1.05),s()}),i}update(t,e){x.throttledUIUpdate.call(this,e),t%1e4<e&&x.cleanupUnusedResources.call(this),t%5e3<e&&x.minimizeDrawCalls.call(this)}showOptimizedDropEffect(t,e,a){x.createOptimizedEffect.call(this,t,e,a?"success":"failure")}arrangeHandOptimized(){x.batchUpdateHandCards.call(this)}cleanup(){this.eventCleanupManager.removeAll(),this.tweens.killAll(),this.time.removeAllEvents(),this.soundManager&&this.soundManager.stopAll(),this.performanceManager&&this.performanceManager.destroy(),this.dropZoneIntegration&&this.dropZoneIntegration.destroy(),this.keyboardController&&this.keyboardController.destroy(),this.tutorialManager&&this.tutorialManager.destroy(),[this.cardSelectionUI,this.insuranceTypeSelectionUI,this.vitalityBarContainer,this.insuranceListContainer,this.burdenIndicatorContainer,this.insuranceRenewalDialogUI,this.tutorialOverlay].forEach(e=>{e&&e.destroy()}),this.handCards.forEach(e=>{e.destroy()}),this.handCards=[],this.objectPools&&Object.values(this.objectPools).forEach(e=>{e.forEach(a=>{a!=null&&a.destroy&&a.destroy()})})}}export{Z as G,W as M,Y as P};
//# sourceMappingURL=game-scenes-gl4Q2JUG.js.map
